<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ResolvTask</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            background-color: #f0f2f5; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        .login-container { 
            background-color: #ffffff; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 420px; 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .login-container .logo { 
            max-width: 180px; 
            margin-bottom: 20px; 
        }
        .form-control { 
            border-radius: 8px; 
            padding: 12px 15px; 
            border: 1px solid #ced4da; 
        }
        .btn-login { 
            background-color: #0d6efd; 
            border-color: #0d6efd; 
            color: white; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: 600; 
        }
        .btn-login:hover {
            background-color: #0b5ed7;
        }
        .btn-login:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .signup-link { 
            display: block; 
            margin-top: 20px; 
            color: #0d6efd; 
            text-decoration: none; 
        }
        .signup-link:hover {
            text-decoration: underline;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1080;
        }
        .spinner-border-sm { 
            margin-right: 5px; 
        }
    </style>
</head>
<body>
    <div class="login-container">
        <img src="https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png" alt="ResolvAI Logo" class="logo" onerror="this.onerror=null;this.src='https://placehold.co/180x40/0d6efd/ffffff?text=ResolvTask';">
        <br>
        <h1><i class="fas fa-users me-3"></i>Task</h1>
        <p class="text-muted mb-4">FaÃ§a login para continuar.</p>
        
        <form id="loginForm">
            <div class="mb-3 text-start">
                <label for="email" class="form-label">E-mail:</label>
                <input type="email" class="form-control" id="email" required placeholder="seuemail@exemplo.com" autocomplete="email">
            </div>
            <div class="mb-3 text-start">
                <label for="password" class="form-label">Senha:</label>
                <input type="password" class="form-control" id="password" required placeholder="Sua senha" autocomplete="current-password">
            </div>
            <button type="submit" class="btn btn-login w-100 mt-3" id="loginButton">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                <span id="buttonText">Login</span>
            </button>
        </form>
        
        <a href="cadastro.html" class="signup-link">NÃ£o tem uma conta? Cadastre-se</a>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="modal fade" id="activationPendingModal" tabindex="-1" aria-labelledby="activationPendingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activationPendingModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        Aviso de AtivaÃ§Ã£o
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Aguardando ativaÃ§Ã£o do cadastro.</p>
                    <p class="mb-0">Por favor, entre em contato com o administrador.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const SafeStorage = (() => {
            let memoryStorage = {};
            let isLocalStorageAvailable = false;

            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                isLocalStorageAvailable = true;
            } catch (e) {
                isLocalStorageAvailable = false;
                console.warn('âš ï¸ localStorage nÃ£o disponÃ­vel, usando armazenamento em memÃ³ria');
            }

            return {
                getItem: (key) => {
                    if (isLocalStorageAvailable) {
                        return localStorage.getItem(key);
                    }
                    return memoryStorage[key] || null;
                },
                setItem: (key, value) => {
                    if (isLocalStorageAvailable) {
                        localStorage.setItem(key, value);
                    } else {
                        memoryStorage[key] = value;
                    }
                },
                removeItem: (key) => {
                    if (isLocalStorageAvailable) {
                        localStorage.removeItem(key);
                    } else {
                        delete memoryStorage[key];
                    }
                },
                clear: () => {
                    if (isLocalStorageAvailable) {
                        localStorage.clear();
                    } else {
                        memoryStorage = {};
                    }
                }
            };
        })();
        
        const WEBHOOK_AUTHENTICATE_URL = 'https://n8n.resolv.ai/webhook/autenticar';
        const DASHBOARD_URL = 'index.html';
        
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const buttonText = document.getElementById('buttonText');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const spinner = loginButton.querySelector('.spinner-border');

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = type === 'success' ? 'bg-success' : 
                           type === 'danger' ? 'bg-danger' : 
                           type === 'warning' ? 'bg-warning' : 'bg-info';
            
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'danger' ? 'exclamation-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${icon} me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function setLoadingState(isLoading) {
            loginButton.disabled = isLoading;
            if (isLoading) {
                spinner.classList.remove('d-none');
                buttonText.textContent = 'Entrando...';
            } else {
                spinner.classList.add('d-none');
                buttonText.textContent = 'Login';
            }
        }

        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showToast('Por favor, preencha e-mail e senha.', 'warning');
                return;
            }

            if (!email.includes('@')) {
                showToast('Por favor, insira um e-mail vÃ¡lido.', 'warning');
                return;
            }

            setLoadingState(true);

            try {
                console.log('ðŸ” Enviando requisiÃ§Ã£o de autenticaÃ§Ã£o...');
                
                const response = await fetch(WEBHOOK_AUTHENTICATE_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: email, 
                        senha: password 
                    })
                });

                const responseText = await response.text();
                console.log('ðŸ“¥ Resposta recebida (status ' + response.status + ')');

                if (!response.ok) {
                    throw new Error(responseText || 'Erro ao conectar com o servidor.');
                }

                if (!responseText || responseText.trim() === '') {
                    throw new Error('Resposta vazia do servidor.');
                }

                let authData = null;

                try {
                    const jsonResult = JSON.parse(responseText);
                    console.log('ðŸ“‹ JSON parseado:', jsonResult);
                    
                    if (Array.isArray(jsonResult) && jsonResult.length > 0) {
                        authData = jsonResult[0];
                    } else if (jsonResult.Status || jsonResult.status) {
                        authData = jsonResult;
                    }
                } catch (jsonError) {
                    console.warn('âš ï¸ Resposta nÃ£o Ã© JSON vÃ¡lido, tentando parse como texto');
                    
                    const pairs = responseText.split(/,\s*(?=[A-Za-z_]+\s*:)/);
                    authData = {};
                    pairs.forEach(pair => {
                        const delimiterIndex = pair.indexOf(':');
                        if (delimiterIndex > -1) {
                            const key = pair.substring(0, delimiterIndex).trim();
                            let value = pair.substring(delimiterIndex + 1).trim();
                            value = value.replace(/^["']|["']$/g, '');
                            authData[key] = value;
                        }
                    });
                }

                console.log('âœ… Dados de autenticaÃ§Ã£o processados:', authData);

                const status = (authData.Status || authData.status || '').toString().toLowerCase();
                const sessionToken = authData.session_token || authData.token || authData.Token;
                
                if (status === 'true') {
                    if (sessionToken) {
                        SafeStorage.setItem('session_token', sessionToken);
                        console.log('âœ… Token de sessÃ£o armazenado com seguranÃ§a');
                    } else {
                        console.warn('âš ï¸ Backend nÃ£o retornou session_token. Criando token temporÃ¡rio.');
                        const tempToken = btoa(email + ':' + Date.now() + ':' + Math.random());
                        SafeStorage.setItem('session_token', tempToken);
                        SafeStorage.setItem('userEmail', email);
                        if (authData.Nome || authData.nome) {
                            SafeStorage.setItem('userName', authData.Nome || authData.nome);
                        }
                        if (authData.Tipo || authData.tipo) {
                            SafeStorage.setItem('userType', authData.Tipo || authData.tipo);
                        }
                    }
                    
                    showToast('Login bem-sucedido! Redirecionando...', 'success');
                    
                    setTimeout(() => { 
                        window.location.href = DASHBOARD_URL;
                    }, 1500);

                } else if (status === 'inactive') {
                    setLoadingState(false);
                    const activationModal = new bootstrap.Modal(document.getElementById('activationPendingModal'));
                    activationModal.show();
                    
                } else if (status === 'false') {
                    setLoadingState(false);
                    showToast('E-mail ou senha incorretos.', 'danger');
                    passwordInput.value = '';
                    passwordInput.focus();
                    
                } else {
                    setLoadingState(false);
                    showToast('Status de autenticaÃ§Ã£o desconhecido: ' + status, 'warning');
                }
                
            } catch (error) {
                console.error('âŒ Erro durante o login:', error);
                setLoadingState(false);
                showToast(
                    error.message || 'Erro ao conectar com o servidor. Tente novamente.', 
                    'danger'
                );
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸ“„ PÃ¡gina de login carregada');
            console.log('ðŸ”— URL de autenticaÃ§Ã£o:', WEBHOOK_AUTHENTICATE_URL);
            
            SafeStorage.removeItem('session_token');
            SafeStorage.removeItem('userEmail');
            SafeStorage.removeItem('userName');
            SafeStorage.removeItem('userType');
            SafeStorage.removeItem('authToken');
            SafeStorage.removeItem('userSession');
            console.log('ðŸ§¹ SessÃ£o anterior limpa');
            
            emailInput.focus();
        });
    </script>
</body>
</html>
