<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResolvLab3d - Sistema de Gerenciamento de Dados</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
            overflow-x: hidden;
        }
        
        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f2f5;
        }
        
        .login-container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 420px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .login-container .logo {
            max-width: 180px;
            margin-bottom: 20px;
        }
        
        .login-container h1 {
            color: #0d6efd;
            margin-bottom: 10px;
        }
        
        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid #ced4da;
        }
        
        .btn-login {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
        }
        
        /* ===== DASHBOARD ===== */
        .app-container {
            display: none;
        }
        
        .app-container.authenticated {
            display: block;
        }
        
        /* Sidebar */
        .sidebar {
            height: 100vh;
            width: 280px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);
            position: fixed;
            left: 0;
            top: 0;
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
        }
        
        .sidebar-header .logo {
            max-width: 150px;
            height: auto;
            margin-bottom: 10px;
        }
        
        .sidebar-header h1 {
            color: var(--dark-color);
            font-size: 1.5rem;
            font-weight: 500;
        }
        
        .sidebar-header .text-light {
            color: var(--dark-color) !important;
            font-weight: 500;
        }
        
        .sidebar-menu {
            padding: 20px 0;
            flex-grow: 1;
        }
        
        .menu-item {
            display: block;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        
        .menu-item:hover,
        .menu-item.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }

        .menu-item i {
            width: 20px;
            margin-right: 15px;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        /* Top Navigation */
        .top-nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Content Area */
        .content-area {
            padding: 25px;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card {
            color: white;
            text-align: center;
            padding: 25px;
            position: relative;
        }

        .stat-card.primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #157347 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
            color: #212529;
        }
        
        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #b02a37 100%);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .stat-icon {
            font-size: 3rem;
            opacity: 0.3;
            position: absolute;
            right: 20px;
            top: 20px;
        }
        
        /* Data Grid */
        .data-grid-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        
        .table-responsive {
            /* max-height: 600px; */ /* Removido para a tabela principal não ter scroll interno */
            overflow-y: auto;
        }
        
        /* Estilos específicos para a tabela principal de dados */
        #dataTable {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }
        
        #dataTable thead th {
            background-color: #0d6efd !important;
            color: white !important;
            padding: 12px 15px !important;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #0b5ed7;
            white-space: nowrap;
        }
        
        #dataTable tbody td {
            padding: 12px 15px !important;
            vertical-align: middle;
            border-bottom: 1px solid #dee2e6;
            word-wrap: break-word;
        }
        
        #dataTable tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Larguras específicas para cada coluna (4 colunas: Nome Fluxo, Cliente, Empresa, Ações) */
        #dataTable th:nth-child(1),
        #dataTable td:nth-child(1) {
            width: 25%;
        }
        
        #dataTable th:nth-child(2),
        #dataTable td:nth-child(2) {
            width: 20%;
        }
        
        #dataTable th:nth-child(3),
        #dataTable td:nth-child(3) {
            width: 40%;
        }
        
        #dataTable th:nth-child(4),
        #dataTable td:nth-child(4) {
            width: 15%;
            text-align: center;
        }
        
        /* Modal */
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);
            color: white;
        }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            flex-direction: column;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilo Planilha (Excel) - Usado no Modal de Preencher */
        .spreadsheet-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .modal-fullscreen .spreadsheet-container {
            max-height: 65vh; 
        }
        .spreadsheet-container table {
            margin-bottom: 0; 
        }
        .spreadsheet-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .spreadsheet-container .form-control-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.875rem;
            border-radius: 4px;
        }
        .spreadsheet-container th {
            min-width: 150px;
        }
        .spreadsheet-container td {
            padding: 0.25rem;
        }
        .spreadsheet-container th:last-child,
        .spreadsheet-container td:last-child {
            width: 50px;
            min-width: 50px;
            text-align: center;
        }
        
        /* ATUALIZADO: Estilo para o Tooltip de Digitação (caixa preta, texto branco, quebra de linha) */
        .typing-tooltip {
            display: none;
            position: absolute;
            background-color: #000; /* Cor preta explícita */
            color: #FFF; /* Texto branco */
            padding: 10px; /* Mais espaço */
            border-radius: 6px;
            font-size: 1rem; /* Um pouco maior para "enxergar maior" */
            z-index: 1070; /* Mais alto que o modal (1055) */
            max-width: 400px; /* Mais largo que o campo */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            pointer-events: none; /* Para não bloquear o mouse */
            
            /* Chave para quebras de linha e texto longo */
            white-space: pre-wrap; 
            overflow-wrap: break-word; /* Garante quebra de palavras longas */
        }

        /* Estilos para Edição Inline */
        .inline-edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
        }

        /* NOVO: Estilo para forçar botões na mesma linha */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            align-items: center;
        }
        
        .action-buttons .btn {
            padding: 5px 10px;
            font-size: 0.875rem;
            margin: 2px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1050;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .content-area {
                padding: 15px;
            }
        }
        
        /* Notification area */
        .notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
        
        .alert {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .spinner-border-sm {
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <!-- ========== LOGIN SCREEN ========== -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <img src="https://www.resolv.ai/logo.png" alt="ResolvAI Logo" class="logo">
            <h1><i class="fas fa-flask me-3"></i>Lab3d</h1>
            <p class="text-muted mb-4">Faça login para continuar.</p>
            <form id="loginForm">
                <div class="mb-3 text-start">
                    <label for="email" class="form-label">E-mail:</label>
                    <input type="email" class="form-control" id="email" required placeholder="seuemail@exemplo.com">
                </div>
                <div class="mb-3 text-start">
                    <label for="password" class="form-label">Senha:</label>
                    <input type="password" class="form-control" id="password" required placeholder="Sua senha">
                </div>
                <button type="submit" class="btn btn-login mt-3" id="loginButton">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Login
                </button>
            </form>
            <a href="https://n8n.dev.resolvrisk.com.br/webhook/res/cadastro" class="signup-link" style="display: block; margin-top: 20px; color: #0d6efd; text-decoration: none;">Não tem uma conta? Cadastre-se</a>
            <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
        </div>
    </div>

    <!-- ========== DASHBOARD ========== -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://www.resolv.ai/logo.png" alt="ResolvAI Logo" class="logo">
                <h1><i class="fas fa-flask me-2"></i>Lab3D</h1>
                <small class="text-light">Sistema Integrado de Gestão</small>
            </div>
            <div class="sidebar-menu" id="sidebarMenu">
                <button class="menu-item active" onclick="showDashboardView()" data-menu="lab3d">
                    <i class="fas fa-flask"></i>Lab3d
                </button>
                <button class="menu-item" onclick="window.location.href='WEBHOOK_EQUIPE'" data-menu="team">
                    <i class="fas fa-users"></i>Equipe
                </button>
                <button class="menu-item" onclick="window.location.href='WEBHOOK_CONFIGURACOES'" data-menu="settings">
                    <i class="fas fa-cog"></i>Configurações
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <nav class="top-nav">
                <div class="d-flex align-items-center">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h5 class="mb-0 ms-3" id="pageTitle">ResolvLab3d - Gestão de Dados</h5>
                </div>
                <div class="user-info">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle fs-4 text-primary me-2"></i>
                        <span class="fw-bold" id="userNameDisplay">Usuário</span>
                    </div>
                    <button class="btn btn-outline-danger btn-sm ms-2" id="logoutButton" title="Sair">
                        <i class="fas fa-sign-out-alt me-1"></i>Sair
                    </button>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard View -->
                <div id="dashboardView">
                    <!-- Stats Cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-lg-4 col-md-6">
                            <div class="card stat-card primary">
                                <div class="position-relative">
                                    <div class="stat-number" id="totalFluxos">0</div>
                                    <div class="stat-label">Total de Fluxos</div>
                                    <i class="fas fa-stream stat-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="card stat-card success">
                                <div class="position-relative">
                                    <div class="stat-number" id="totalFase1">0</div>
                                    <div class="stat-label">Registros Fase</div>
                                    <i class="fas fa-database stat-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="card stat-card warning">
                                <div class="position-relative">
                                    <div class="stat-number" id="totalDW">0</div>
                                    <div class="stat-label">Registros DW</div>
                                    <i class="fas fa-chart-bar stat-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Bar -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Dados do Lab3d</h5>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <button class="btn btn-success" id="btnNovoFluxo">
                                        <i class="fas fa-plus me-2"></i>Criar Novo Fluxo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Criar Novo Fluxo -->
    <div class="modal fade" id="modalNovoFluxo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Criar Novo Fluxo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoFluxo">
                        <div class="mb-3">
                            <label for="nomeFluxo" class="form-label">Nome do Fluxo</label>
                            <input type="text" class="form-control" id="nomeFluxo" required>
                        </div>
                        <div class="mb-3">
                            <label for="selectCliente" class="form-label">Cliente</label>
                            <select class="form-select" id="selectCliente" required>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="selectEmpresa" class="form-label">Empresa Prestadora</label>
                            <select class="form-select" id="selectEmpresa" required>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSalvarFluxo">
                        <i class="fas fa-save me-2"></i>Salvar Fluxo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal "Visualizar Fluxo" (Detalhes do Fluxo) -->
    <div class="modal fade" id="modalVisualizarFluxo" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVisualizarFluxoTitle"><i class="fas fa-eye me-2"></i>Visualizar Fluxo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalVisualizarFluxoBody">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="mt-2">Carregando detalhes do fluxo...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal "Confirmar Exclusão" -->
    <div class="modal fade" id="modalConfirmarExclusao" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--danger-color);">
                    <h5 class="modal-title"><i class="fas fa-triangle-exclamation me-2"></i>Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Você tem certeza que deseja excluir este fluxo?</p>
                    <p class="text-danger"><strong>Atenção:</strong> Todos os registros de "Fase" e "Tabela DW" associados a este fluxo também serão excluídos. Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">
                        <i class="fas fa-trash-alt me-2"></i>Excluir Permanentemente
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal: Diagrama (Oculto - A lógica agora está no "Visualizar Fluxo") -->
    <div class="modal fade" id="modalDiagrama" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-diagram-project me-2"></i>Diagrama do Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="diagramaContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="mt-2">Carregando diagrama...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Preencher Dados do Fluxo -->
    <div class="modal fade" id="modalPreencherDados" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-database me-2"></i>Preencher Dados do Fluxo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- NOVO: Tooltip de digitação. Fica posicionado aqui -->
                    <div id="typingTooltip" class="typing-tooltip"></div>
                    
                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs mb-3" id="tabelasTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="fase-tab" data-bs-toggle="tab" data-bs-target="#fase-content" type="button" role="tab">
                                <i class="fas fa-layer-group me-2"></i>Fase
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="dw-tab" data-bs-toggle="tab" data-bs-target="#dw-content" type="button" role="tab">
                                <i class="fas fa-database me-2"></i>Tabela DW
                            </button>
                        </li>
                    </ul>

                    <!-- Tabs Content -->
                    <div class="tab-content" id="tabelasTabContent">
                        
                        <!-- Tab Fase com layout de planilha -->
                        <div class="tab-pane fade show active" id="fase-content" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Campos da Tabela "Fase"</h5>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openAdicionarCampoDinamico('fase')">
                                    <i class="fas fa-plus me-1"></i> Adicionar Nova Coluna
                                </button>
                            </div>
                            <!-- Layout de Planilha (Excel) -->
                            <div class="spreadsheet-container table-responsive">
                                <table class="table table-bordered table-striped table-sm" id="tableFase">
                                    <thead class="table-light">
                                        <tr id="tableFaseHead">
                                            <!-- Cabeçalhos das colunas serão injetados aqui -->
                                        </tr>
                                    </thead>
                                    <tbody id="tableFaseBody">
                                        <!-- Linhas (inputs) serão injetadas aqui -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-success" id="btnAdicionarLinhaFase">
                                    <i class="fas fa-plus me-1"></i> Adicionar Linha
                                </button>
                            </div>
                        </div>

                        <!-- Tab Tabela DW com layout de planilha -->
                        <div class="tab-pane fade" id="dw-content" role="tabpanel">
                             <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Campos da Tabela "DW"</h5>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openAdicionarCampoDinamico('dw')">
                                    <i class="fas fa-plus me-1"></i> Adicionar Nova Coluna
                                </button>
                            </div>
                            <!-- Layout de Planilha (Excel) -->
                            <div class="spreadsheet-container table-responsive">
                                <table class="table table-bordered table-striped table-sm" id="tableDW">
                                    <thead class="table-light">
                                        <tr id="tableDWHead">
                                            <!-- Cabeçalhos das colunas serão injetados aqui -->
                                        </tr>
                                    </thead>
                                    <tbody id="tableDWBody">
                                        <!-- Linhas (inputs) serão injetadas aqui -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-success" id="btnAdicionarLinhaDW">
                                    <i class="fas fa-plus me-1"></i> Adicionar Linha
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="btnSalvarFase">
                        <i class="fas fa-save me-2"></i>Salvar Fase
                    </button>
                    <button type="button" class="btn btn-success" id="btnSalvarTabelaDW">
                        <i class="fas fa-save me-2"></i>Salvar Tabela DW
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Linha (Oculto - Lógica antiga mantida, mas botão principal escondido) -->
    <div class="modal fade" id="modalEditarLinha" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarLinhaTitle">
                        <i class="fas fa-edit me-2"></i>Adicionar Nova Linha
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Dados Principais</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openAdicionarCampoDinamico('linha')">
                            <i class="fas fa-plus me-1"></i> Adicionar Campo
                        </button>
                    </div>

                    <!-- Formulário para campos padrão e dinâmicos (será construído) -->
                    <form id="formEditarLinha" class="row g-3">
                        <div class="col-12 loading-form"><div class="spinner"></div></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSalvarLinha">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Coluna (Campo Dinâmico) -->
    <div class="modal fade" id="modalAdicionarCampoDinamico" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Adicionar Nova Coluna</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formAdicionarCampoDinamico">
                        <div class="mb-3">
                            <label for="nomeNovoCampo" class="form-label">Nome da Nova Coluna</label>
                            <input type="text" class="form-control" id="nomeNovoCampo" placeholder="Ex: email_responsavel" required>
                            <small class="form-text text-muted">Use apenas letras minúsculas, números e underscore (_).</small>
                        </div>
                        <div class="mb-3" id="divSelectTabelaCampo" style="display: none;">
                            <label for="selectTabelaCampo" class="form-label">Adicionar em qual tabela?</label>
                            <select class="form-select" id="selectTabelaCampo">
                                <option value="fase">Fase</option>
                                <option value="tabela_dw">Tabela DW</option>
                                <option value="fluxo">Fluxo</option> <!-- Adicionado Fluxo -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSalvarNovoCampo">
                        <i class="fas fa-check me-2"></i>Adicionar Coluna
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Area -->
    <div class="notification-area" id="notificationArea"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Application JavaScript -->
    <script>
// ===================================
// CONFIGURAÇÃO E VARIÁVEIS GLOBAIS
// ===================================

// URLs dos Webhooks n8n (para login)
const WEBHOOK_AUTHENTICATE_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/autenticar';
const WEBHOOK_CLIENTES_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consulta_clientes';
const WEBHOOK_EMPRESAS_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consulta_empresa';

// Configuração PostgreSQL/Supabase
const SUPABASE_URL = 'https://laqihgfqymniexceactd.supabase.co';
// !!! ATENÇÃO: SUBSTITUA O PLACEHOLDER PELA SUA SUPABASE ANON KEY REAL !!!
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhcWloZ2ZxeW1uaWV4Y2VhY3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjQ0MTQsImV4cCI6MjA3NzM0MDQxNH0.7fwZMFSbEpNCFFIgTOi_lphVvnBc85EK9ofobsVGUrk'; 

let supabaseClient = null;
let currentUser = null;
let currentTable = 'fluxo'; // ATUALIZADO: Tabela principal agora é 'fluxo'
let currentData = [];
let fluxosList = [];
let currentFluxoId = null; 
let currentClienteId = null; 
let currentEmpresaId = null; 
let currentDynamicFieldContext = null; 
let modalAdicionarCampo = null; 
let modalConfirmarExclusao = null; // NOVO: Referência do modal de exclusão
let allTableColumns = { fase: [], tabela_dw: [], fluxo: [] }; // Cache para colunas

// ===================================
// INICIALIZAÇÃO
// ===================================

document.addEventListener('DOMContentLoaded', async () => {
    await initSupabase();
    checkUserSession();
    setupEventListeners();
    modalAdicionarCampo = new bootstrap.Modal(document.getElementById('modalAdicionarCampoDinamico'));
    // NOVO: Inicializa o modal de exclusão
    modalConfirmarExclusao = new bootstrap.Modal(document.getElementById('modalConfirmarExclusao'));
});

// ===================================
// SUPABASE
// ===================================

async function initSupabase() {
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes('PLACEHOLDER')) {
        console.error('Supabase URL ou ANON KEY não configuradas!');
        showNotification('Supabase URL ou ANON KEY não configuradas. Por favor, edite o script HTML e insira suas credenciais.', 'danger');
        return;
    }
    try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase initialized successfully.');
    } catch (error) {
        console.error('Error initializing Supabase:', error);
        showNotification('Erro ao inicializar Supabase: ' + error.message, 'danger');
    }
}

// ===================================
// AUTENTICAÇÃO
// ===================================

function checkUserSession() {
    const authToken = localStorage.getItem('authToken');
    const userSession = localStorage.getItem('userSession');
    
    if (authToken && userSession) {
        currentUser = JSON.parse(userSession);
        showDashboard();
    } else {
        showLogin();
    }
}

function showLogin() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appContainer').classList.remove('authenticated');
}

function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').classList.add('authenticated');
    document.getElementById('userNameDisplay').textContent = currentUser.nome || currentUser.email;
    showDashboardView();
}

function showDashboardView() {
    document.getElementById('dashboardView').style.display = 'block';
    loadData();
    loadStats();
}

// ===================================
// EVENT LISTENERS
// ===================================

function setupEventListeners() {
    // Login
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    
    // Logout
    document.getElementById('logoutButton').addEventListener('click', handleLogout);
    
    // Sidebar toggle
    document.getElementById('sidebarToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('show');
    });
    
    // Buttons
    document.getElementById('btnNovoFluxo').addEventListener('click', openNovoFluxoModal);
    // document.getElementById('btnAdicionarLinha').addEventListener('click', openAdicionarLinhaModal); // Botão agora está oculto
    document.getElementById('btnSalvarFluxo').addEventListener('click', salvarNovoFluxo);
    // document.getElementById('btnSalvarLinha').addEventListener('click', salvarLinha); // Lógica antiga mantida
    document.getElementById('btnSalvarFase').addEventListener('click', salvarDadosFase);
    document.getElementById('btnSalvarTabelaDW').addEventListener('click', salvarDadosTabelaDW);
    
    document.getElementById('btnSalvarNovoCampo').addEventListener('click', salvarNovoCampoDinamico);
    
    // NOVO: Listener para o botão de confirmação de exclusão
    document.getElementById('btnConfirmarExclusao').addEventListener('click', deleteFluxo);

    // ATUALIZADO: Listeners para os botões de adicionar linha da planilha
    document.getElementById('btnAdicionarLinhaFase').addEventListener('click', () => addNewExcelRow('fase'));
    document.getElementById('btnAdicionarLinhaDW').addEventListener('click', () => addNewExcelRow('tabela_dw'));

    // Filters - REMOVIDO
    // document.getElementById('filterForm').addEventListener('submit', handleFilter);
    // document.getElementById('btnLimparFiltros').addEventListener('click', limparFiltros);
    
    // O listener de 'filterTabela' foi removido, pois a tabela principal é fixa
    // document.getElementById('filterTabela').addEventListener('change', (e) => { ... });
}

// ===================================
// LOGIN (Sem alterações)
// ===================================

async function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const loginButton = document.getElementById('loginButton');
    const spinner = loginButton.querySelector('.spinner-border');
    const errorDiv = document.getElementById('loginError');

    if (!email || !password) {
        showNotification('Por favor, preencha e-mail e senha.', 'warning');
        return;
    }

    loginButton.disabled = true;
    spinner.classList.remove('d-none');
    errorDiv.style.display = 'none';

    try {
        const response = await fetch(WEBHOOK_AUTHENTICATE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, senha: password })
        });

        const responseText = await response.text();

        if (!response.ok) {
            throw new Error(responseText || 'Credenciais inválidas ou erro no servidor.');
        }

        let userDataString = null;

        try {
            const result = JSON.parse(responseText);
            if (Array.isArray(result) && result.length > 0 && result[0].data) {
                userDataString = result[0].data;
            }
        } catch (jsonError) {
            console.log("A resposta não é JSON. Tratando como texto simples:", responseText);
        }
        
        if (userDataString === null && responseText.includes('Status:')) {
            userDataString = responseText;
        }

        if (userDataString) {
            const parsedData = parseUserData(userDataString);

            if (parsedData.Status === 'True') {
                saveUserSession(email, parsedData);
                showNotification('Login bem-sucedido! Redirecionando...', 'success');
                
                setTimeout(() => { 
                    showDashboard();
                }, 1500);

            } else if (parsedData.Status === 'inactive') {
                showNotification('Aguardando ativação do cadastro. Por favor, entre em contato com o administrador.', 'warning');
            } else {
                showNotification('E-mail ou senha incorretos.', 'danger');
            }
        } else {
            console.error("Formato de resposta do servidor inválido:", responseText);
            throw new Error("Formato de resposta do servidor inválido.");
        }
        
    } catch (error) {
        console.error('Erro durante o login:', error);
        errorDiv.textContent = error.message || 'Ocorreu um erro ao tentar fazer login.';
        errorDiv.style.display = 'block';
    } finally {
        loginButton.disabled = false;
        spinner.classList.add('d-none');
    }
}

function parseUserData(dataString) {
    const userData = {};
    const pairs = dataString.split(/,\s*/);
    pairs.forEach(pair => {
        const delimiterIndex = pair.indexOf(':');
        if (delimiterIndex > -1) {
            const key = pair.substring(0, delimiterIndex).trim();
            const value = pair.substring(delimiterIndex + 1).trim();
            userData[key] = value;
        }
    });
    return userData;
}

function saveUserSession(email, userData) {
    const sessionToken = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const sessionData = {
        email: email,
        nome: userData.Nome || email.split('@')[0],
        tipo: userData.Tipo || 'colaborador',
        loginTime: new Date().toISOString(),
        token: sessionToken
    };
    
    localStorage.clear();
    localStorage.setItem('authToken', sessionToken);
    localStorage.setItem('userSession', JSON.stringify(sessionData));
    localStorage.setItem('loggedInUserEmail', email);
    localStorage.setItem('loggedInUserName', sessionData.nome);
    localStorage.setItem('loggedInUserTipo', sessionData.tipo);
    
    currentUser = sessionData;
}

function handleLogout(e) {
    e.preventDefault();
    localStorage.clear();
    currentUser = null;
    showLogin();
}

// ===================================
// NOTIFICAÇÕES (Sem alterações)
// ===================================

function showNotification(message, type = 'success') {
    const notificationArea = document.getElementById('notificationArea');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
    notificationArea.appendChild(alertDiv);
    
    setTimeout(() => {
        const alertInstance = bootstrap.Alert.getOrCreateInstance(alertDiv);
        if (alertInstance) { 
            alertInstance.close(); 
        }
    }, 5000);
}

// ===================================
// CARREGAR DADOS
// ===================================

async function loadData() {
    // REMOVIDO: Elementos de filtro e tabela foram excluídos
    // const loading = document.getElementById('dataLoading');
    // const dataGrid = document.getElementById('dataGrid');
    // const emptyState = document.getElementById('emptyState');
    
    try {
        if (!supabaseClient) {
            console.warn('Supabase não inicializado.');
            currentData = generateSampleFluxoData();
        } else {
            // ATUALIZADO: Query principal agora busca fluxos com JOIN
            const { data, error } = await supabaseClient
                .from('fluxo')
                .select('*, cliente(nome_cliente), empresa(nome_empresa_prestadora)')
                .order('id_fluxo', { ascending: false });
            
            if (error) throw error;
            
            currentData = data || [];
        }
        
        // Cache das colunas apenas para fase e tabela_dw (que usam colunas dinâmicas)
        await fetchAndCacheTableColumns('fase');
        await fetchAndCacheTableColumns('tabela_dw');
        
        await loadFluxos();
    } catch (error) {
        console.error('Error loading data:', error);
        showNotification('Erro ao carregar dados: ' + error.message, 'danger');
    }
}

async function loadStats() {
    try {
        if (!supabaseClient) {
            console.warn('Supabase not init for stats. Using 0s.');
            document.getElementById('totalFluxos').textContent = 0;
            document.getElementById('totalFase1').textContent = 0;
            document.getElementById('totalDW').textContent = 0;
            return;
        }

        const [fluxosCountResp, faseCountResp, dwCountResp] = await Promise.all([
            supabaseClient.from('fluxo').select('id_fluxo', { count: 'exact', head: true }),
            supabaseClient.from('fase').select('id_fase', { count: 'exact', head: true }),
            supabaseClient.from('tabela_dw').select('id_dw', { count: 'exact', head: true })
        ]);

        if (fluxosCountResp.error) console.error('Erro stats fluxos:', fluxosCountResp.error.message);
        if (faseCountResp.error) console.error('Erro stats fase:', faseCountResp.error.message);
        if (dwCountResp.error) console.error('Erro stats dw:', dwCountResp.error.message);

        const totalFluxos = fluxosCountResp.count || 0;
        const totalFase1 = faseCountResp.count || 0;
        const totalDW = dwCountResp.count || 0;

        document.getElementById('totalFluxos').textContent = totalFluxos;
        document.getElementById('totalFase1').textContent = totalFase1;
        document.getElementById('totalDW').textContent = totalDW;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// ATUALIZADO: Função de dados de exemplo para fluxo
function generateSampleFluxoData() {
    return [];
}

// ===================================
// RENDERIZAR TABELA (ATUALIZADO PARA FLUXO)
// ===================================

// REMOVIDO: Tabela de fluxos foi excluída da interface
function renderFluxoTable(data) {
    // Função removida - elementos não existem mais
    return;
}

// ===================================
// AÇÕES DA TABELA FLUXO (NOVAS FUNÇÕES)
// ===================================

/**
 * NOVO: Abre o modal de visualização com detalhes do fluxo (fase e dw).
 */
async function visualizarFluxo(id_fluxo, nome_fluxo) {
    const modal = new bootstrap.Modal(document.getElementById('modalVisualizarFluxo'));
    const modalTitle = document.getElementById('modalVisualizarFluxoTitle');
    const modalBody = document.getElementById('modalVisualizarFluxoBody');

    modalTitle.textContent = `Visualizar Fluxo: ${nome_fluxo} (ID: ${id_fluxo})`;
    modalBody.innerHTML = '<div class="loading"><div class="spinner"></div><p class="mt-2">Carregando detalhes...</p></div>';
    modal.show();

    try {
        if (!supabaseClient) {
            throw new Error("Supabase não conectado.");
        }

        const [faseData, dwData] = await Promise.all([
            supabaseClient.from('fase').select('*').eq('id_fluxo', id_fluxo),
            supabaseClient.from('tabela_dw').select('*').eq('id_fluxo', id_fluxo)
        ]);

        if (faseData.error) throw faseData.error;
        if (dwData.error) throw dwData.error;

        modalBody.innerHTML = `
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Registros de Fase (${faseData.data.length})</h5>
                </div>
                <div class="card-body">
                    ${renderDiagramTable(faseData.data)}
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Registros de Tabela DW (${dwData.data.length})</h5>
                </div>
                <div class="card-body">
                    ${renderDiagramTable(dwData.data)}
                </div>
            </div>
        `;

    } catch (error) {
        console.error('Error loading fluxo details:', error);
        modalBody.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhes: ${error.message}</div>`;
    }
}

/**
 * NOVO: Ativa o modo de edição inline para uma linha de fluxo.
 */
function toggleFluxoEdit(buttonEl, id_fluxo) {
    const tr = document.getElementById(`fluxo-row-${id_fluxo}`);
    if (!tr) return;

    // Salvar valores originais
    const nomeCell = tr.querySelector('td[data-field="nome_fluxo"]');
    // const statusCell = tr.querySelector('td[data-field="status"]'); // REMOVIDO
    
    tr.dataset.originalNome = nomeCell.textContent;
    // tr.dataset.originalStatus = statusCell.textContent; // REMOVIDO

    // Criar inputs
    nomeCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${tr.dataset.originalNome}">`;
    
    /* REMOVIDO
    // Criar select para status
    const statusOptions = ['Pendente', 'Em Andamento', 'Concluído', 'Erro'];
    let statusSelect = `<select class="form-select form-select-sm">`;
    statusOptions.forEach(opt => {
        statusSelect += `<option value="${opt}" ${opt === tr.dataset.originalStatus ? 'selected' : ''}>${opt}</option>`;
    });
    statusSelect += `</select>`;
    statusCell.innerHTML = statusSelect;
    */

    // Ocultar/Mostrar botões
    const actionsCell = buttonEl.closest('.action-buttons');
    actionsCell.querySelector('.btn-visualizar').style.display = 'none';
    actionsCell.querySelector('.btn-editar').style.display = 'none';
    actionsCell.querySelector('.btn-excluir').style.display = 'none';
    actionsCell.querySelector('.btn-salvar').style.display = 'inline-block';
    actionsCell.querySelector('.btn-cancelar').style.display = 'inline-block';
}

/**
 * NOVO: Cancela a edição inline.
 */
function cancelFluxoEdit(buttonEl, id_fluxo) {
    const tr = document.getElementById(`fluxo-row-${id_fluxo}`);
    if (!tr || !tr.dataset.originalNome) return;

    // Restaurar valores originais
    tr.querySelector('td[data-field="nome_fluxo"]').textContent = tr.dataset.originalNome;
    // tr.querySelector('td[data-field="status"]').textContent = tr.dataset.originalStatus; // REMOVIDO

    // Limpar dados salvos
    delete tr.dataset.originalNome;
    // delete tr.dataset.originalStatus; // REMOVIDO

    // Ocultar/Mostrar botões
    const actionsCell = buttonEl.closest('.action-buttons');
    actionsCell.querySelector('.btn-visualizar').style.display = 'inline-block';
    actionsCell.querySelector('.btn-editar').style.display = 'inline-block';
    actionsCell.querySelector('.btn-excluir').style.display = 'inline-block';
    actionsCell.querySelector('.btn-salvar').style.display = 'none';
    actionsCell.querySelector('.btn-cancelar').style.display = 'none';
}

/**
 * NOVO: Salva a edição inline no Supabase.
 */
async function saveFluxoEdit(buttonEl, id_fluxo) {
    const tr = document.getElementById(`fluxo-row-${id_fluxo}`);
    if (!tr) return;

    const nomeInput = tr.querySelector('td[data-field="nome_fluxo"] input');
    // const statusSelect = tr.querySelector('td[data-field="status"] select'); // REMOVIDO

    const novoNome = nomeInput.value;
    // const novoStatus = statusSelect.value; // REMOVIDO

    if (!novoNome) {
        showNotification('O nome do fluxo não pode ficar em branco.', 'warning');
        return;
    }

    const saveButton = buttonEl;
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

    try {
        if (!supabaseClient) throw new Error("Supabase não conectado.");

        const { error } = await supabaseClient
            .from('fluxo')
            .update({ nome_fluxo: novoNome }) // ATUALIZADO: remove novoStatus
            .eq('id_fluxo', id_fluxo);

        if (error) throw error;

        // Atualização bem-sucedida. Sair do modo de edição.
        tr.querySelector('td[data-field="nome_fluxo"]').textContent = novoNome;
        // tr.querySelector('td[data-field="status"]').textContent = novoStatus; // REMOVIDO
        
        showNotification('Fluxo atualizado com sucesso!', 'success');
        cancelFluxoEdit(buttonEl, id_fluxo); // Usa a lógica de "cancelar" para limpar a UI

    } catch (error) {
        console.error('Error saving fluxo:', error);
        showNotification('Erro ao salvar: ' + error.message, 'danger');
    } finally {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save"></i>';
    }
}

/**
 * NOVO: Abre o modal de confirmação de exclusão.
 */
function confirmarExclusao(id_fluxo) {
    const btnConfirmar = document.getElementById('btnConfirmarExclusao');
    btnConfirmar.dataset.idFluxo = id_fluxo; // Armazena o ID no botão
    modalConfirmarExclusao.show();
}

/**
 * NOVO: Executa a exclusão após confirmação.
 */
async function deleteFluxo() {
    const btnConfirmar = document.getElementById('btnConfirmarExclusao');
    const id_fluxo = btnConfirmar.dataset.idFluxo;

    if (!id_fluxo) return;

    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Excluindo...';

    try {
        if (!supabaseClient) throw new Error("Supabase não conectado.");

        // ATENÇÃO: Isso exige que o 'ON DELETE CASCADE' esteja configurado
        // no Supabase nas tabelas 'fase' e 'tabela_dw' para a FK 'id_fluxo'.
        // Se não estiver, temos que excluir 'fase' e 'tabela_dw' manualmente primeiro.
        
        // Assumindo que o CASCADE não está habilitado, vamos deletar manualmente:
        
        // 1. Deletar da tabela_dw
        const { error: dwError } = await supabaseClient.from('tabela_dw').delete().eq('id_fluxo', id_fluxo);
        if (dwError) throw new Error(`Erro ao excluir de Tabela DW: ${dwError.message}`);
        
        // 2. Deletar da fase
        const { error: faseError } = await supabaseClient.from('fase').delete().eq('id_fluxo', id_fluxo);
        if (faseError) throw new Error(`Erro ao excluir de Fase: ${faseError.message}`);
        
        // 3. Deletar o fluxo
        const { error: fluxoError } = await supabaseClient.from('fluxo').delete().eq('id_fluxo', id_fluxo);
        if (fluxoError) throw new Error(`Erro ao excluir Fluxo: ${fluxoError.message}`);

        showNotification('Fluxo e todos os dados associados foram excluídos!', 'success');
        modalConfirmarExclusao.hide();
        
        // Remover a linha da tabela na UI
        document.getElementById(`fluxo-row-${id_fluxo}`).remove();
        loadStats(); // Atualizar estatísticas

    } catch (error) {
        console.error('Error deleting fluxo:', error);
        showNotification('Erro ao excluir: ' + error.message, 'danger');
    } finally {
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Excluir Permanentemente';
        delete btnConfirmar.dataset.idFluxo;
    }
}


// ===================================
// FLUXOS (Criação)
// ===================================

async function loadFluxos() {
    try {
        if (!supabaseClient) {
            console.warn('Supabase not set, cannot load fluxos.');
            return;
        }
        const { data, error } = await supabaseClient
            .from('fluxo')
            .select('id_fluxo, nome_fluxo, id_cliente, id_empresa'); 
        
        if (error) throw error;
        
        fluxosList = data || []; 
        
        const filterFluxo = document.getElementById('filterFluxo');
        filterFluxo.innerHTML = '<option value="">Todos</option>';
        fluxosList.forEach(fluxo => {
            const option = document.createElement('option');
            option.value = fluxo.id_fluxo;
            option.textContent = fluxo.nome_fluxo;
            filterFluxo.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading fluxos:', error);
    }
}

async function openNovoFluxoModal() {
    const modal = new bootstrap.Modal(document.getElementById('modalNovoFluxo'));
    
    const selectCliente = document.getElementById('selectCliente');
    const selectEmpresa = document.getElementById('selectEmpresa');
    
    selectCliente.innerHTML = '<option value="">Carregando...</option>';
    selectEmpresa.innerHTML = '<option value="">Carregando...</option>';
    
    modal.show();
    
    try {
        // Carregar clientes do n8n (Webhook)
        const clientesResponse = await fetch(WEBHOOK_CLIENTES_URL);
        const clientesData = await clientesResponse.json();
        
        selectCliente.innerHTML = '<option value="">Selecione...</option>';
        clientesData.forEach(cliente => {
            selectCliente.innerHTML += `<option value="${cliente.id}">${cliente.nome}</option>`;
        });
        
        // Carregar empresas do n8n (Webhook)
        const empresasResponse = await fetch(WEBHOOK_EMPRESAS_URL);
        const empresasData = await empresasResponse.json();
        
        selectEmpresa.innerHTML = '<option value="">Selecione...</option>';
        empresasData.forEach(empresa => {
            selectEmpresa.innerHTML += `<option value="${empresa.id}">${empresa.razao_social}</option>`;
        });
    } catch (error) {
        console.error('Error loading dropdown data:', error);
        showNotification('Erro ao carregar clientes e empresas', 'danger');
    }
}


async function salvarNovoFluxo() {
    // 1. Pegar todos os dados do formulário (IDs e Nomes de Texto)
    const nomeFluxo = document.getElementById('nomeFluxo').value;
    
    const selectClienteEl = document.getElementById('selectCliente');
    const idCliente = selectClienteEl.value;
    const nomeCliente = selectClienteEl.options[selectClienteEl.selectedIndex] ? selectClienteEl.options[selectClienteEl.selectedIndex].text : '';

    const selectEmpresaEl = document.getElementById('selectEmpresa');
    const idEmpresa = selectEmpresaEl.value;
    const nomeEmpresa = selectEmpresaEl.options[selectEmpresaEl.selectedIndex] ? selectEmpresaEl.options[selectEmpresaEl.selectedIndex].text : '';

    // 2. Validação
    if (!nomeFluxo || !idCliente || !idEmpresa) {
        showNotification('Por favor, preencha todos os campos', 'warning');
        return;
    }
    
    if (!supabaseClient) {
        showNotification('Supabase não está configurado. Por favor, configure a ANON KEY.', 'danger');
        return;
    }

    const saveButton = document.getElementById('btnSalvarFluxo');
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';

    try {
        // 3. UPSERT CLIENTE
        const { error: clienteError } = await supabaseClient
            .from('cliente')
            .upsert(
                { id_cliente: parseInt(idCliente), nome_cliente: nomeCliente },
                { onConflict: 'id_cliente' } 
            );
        
        if (clienteError) {
            console.error("Erro no Upsert do Cliente:", clienteError);
            throw new Error(`Falha ao sincronizar cliente: ${clienteError.message}`);
        }

        // 4. UPSERT EMPRESA
        const { error: empresaError } = await supabaseClient
            .from('empresa')
            .upsert(
                { id_empresa: parseInt(idEmpresa), nome_empresa_prestadora: nomeEmpresa },
                { onConflict: 'id_empresa' } 
            );

        if (empresaError) {
            console.error("Erro no Upsert da Empresa:", empresaError);
            throw new Error(`Falha ao sincronizar empresa: ${empresaError.message}`);
        }

        // 5. INSERIR FLUXO
        const { data, error } = await supabaseClient
            .from('fluxo')
            .insert([
                {
                    nome_fluxo: nomeFluxo,
                    id_cliente: parseInt(idCliente),
                    id_empresa: parseInt(idEmpresa),
                    status: 'Pendente'
                }
            ])
            .select();
        
        if (error) {
             console.error("Erro ao inserir Fluxo:", error);
            throw new Error(`Falha ao criar fluxo: ${error.message}`);
        }
        
        // 6. Sucesso
        if (data && data.length > 0) {
            currentFluxoId = data[0].id_fluxo;
            currentClienteId = parseInt(idCliente);
            currentEmpresaId = parseInt(idEmpresa);
            
            showNotification('Fluxo criado e dados sincronizados com sucesso!', 'success');
            
            bootstrap.Modal.getInstance(document.getElementById('modalNovoFluxo')).hide();
            document.getElementById('formNovoFluxo').reset();
            
            const modalPreencher = new bootstrap.Modal(document.getElementById('modalPreencherDados'));
            
            // Limpa e mostra loading nas planilhas
            document.getElementById('tableFaseHead').innerHTML = '';
            document.getElementById('tableFaseBody').innerHTML = '<tr><td><div class="spinner"></div></td></tr>';
            document.getElementById('tableDWHead').innerHTML = '';
            document.getElementById('tableDWBody').innerHTML = '<tr><td><div class="spinner"></div></td></tr>';
            modalPreencher.show();

            // ATUALIZADO: Constrói as planilhas (Excel)
            await buildExcelGrid('fase');
            await buildExcelGrid('tabela_dw');
            
            loadData(); // Recarrega a tabela principal (fluxos)
            loadStats();
        }
    } catch (error) {
        console.error('Error creating fluxo:', error);
        showNotification('Erro ao criar fluxo: ' + error.message, 'danger');
    } finally {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Fluxo';
    }
}

// ===================================
// SALVAR DADOS NAS TABELAS (PLANILHA) (Sem alterações)
// ===================================

async function salvarDadosFase() {
    if (!currentFluxoId) {
        showNotification('Erro: ID do fluxo não encontrado. Crie um fluxo primeiro.', 'danger');
        return;
    }
    if (!supabaseClient) {
        showNotification('Supabase não está configurado.', 'danger');
        return;
    }
    
    const tableBody = document.getElementById('tableFaseBody');
    const rows = tableBody.querySelectorAll('tr');
    const rowsToInsert = [];
    const saveButton = document.getElementById('btnSalvarFase');

    if (rows.length === 0) {
        showNotification('Nenhuma linha para salvar.', 'warning');
        return;
    }

    let hasData = false;
    for (const tr of rows) {
        const rowData = {
            id_fluxo: currentFluxoId,
            id_cliente: currentClienteId,
            id_empresa: currentEmpresaId
        };
        
        const inputs = tr.querySelectorAll('input[data-column-name]');
        let rowHasValues = false; 

        inputs.forEach(input => {
            const colName = input.dataset.columnName;
            const value = input.value.trim();
            if (value) {
                rowData[colName] = value;
                // Considera a linha válida se qualquer campo estiver preenchido (ou customer_id se quiser ser mais estrito)
                rowHasValues = true; 
            }
        });

        if (rowHasValues) {
            rowsToInsert.push(rowData);
            hasData = true;
        }
    }

    if (!hasData) {
        showNotification('Nenhum dado válido para salvar. Preencha pelo menos um campo por linha.', 'warning');
        return;
    }
    
    saveButton.disabled = true;

    try {
        const { data, error } = await supabaseClient.from('fase').insert(rowsToInsert).select();
        if (error) throw error;
        
        showNotification(`Dados da Fase salvos com sucesso (${rowsToInsert.length} linhas)!`, 'success');
        // Limpa a tabela e adiciona uma nova linha em branco
        tableBody.innerHTML = '';
        addNewExcelRow('fase');
        // loadData(); // Não precisa recarregar a tabela principal (fluxo)
        loadStats(); // Apenas atualiza as estatísticas
    } catch (error) {
        console.error('Error saving fase data:', error);
        showNotification('Erro ao salvar dados da Fase: ' + error.message, 'danger');
    } finally {
        saveButton.disabled = false;
    }
}

async function salvarDadosTabelaDW() {
    if (!currentFluxoId) {
        showNotification('Erro: ID do fluxo não encontrado. Crie um fluxo primeiro.', 'danger');
        return;
    }
    if (!supabaseClient) {
        showNotification('Supabase não está configurado.', 'danger');
        return;
    }

    const tableBody = document.getElementById('tableDWBody');
    const rows = tableBody.querySelectorAll('tr');
    const rowsToInsert = [];
    const saveButton = document.getElementById('btnSalvarTabelaDW');

    if (rows.length === 0) {
        showNotification('Nenhuma linha para salvar.', 'warning');
        return;
    }

    let hasData = false;
    for (const tr of rows) {
        const rowData = {
            id_fluxo: currentFluxoId,
            id_cliente: currentClienteId,
            id_empresa: currentEmpresaId
        };
        
        const inputs = tr.querySelectorAll('input[data-column-name]');
        let rowHasValues = false;

        inputs.forEach(input => {
            const colName = input.dataset.columnName;
            const value = input.value.trim();
            if (value) {
                if (colName === 'registros' && parseInt(value)) {
                     rowData[colName] = parseInt(value);
                } else {
                     rowData[colName] = value;
                }
                rowHasValues = true;
            }
        });

        if (rowHasValues) {
            rowsToInsert.push(rowData);
            hasData = true;
        }
    }
    
    if (!hasData) {
        showNotification('Nenhum dado válido para salvar. Preencha pelo menos um campo por linha.', 'warning');
        return;
    }
    
    saveButton.disabled = true;

    try {
        const { data, error } = await supabaseClient.from('tabela_dw').insert(rowsToInsert).select();
        if (error) throw error;

        showNotification(`Dados da Tabela DW salvos com sucesso (${rowsToInsert.length} linhas)!`, 'success');
        tableBody.innerHTML = '';
        addNewExcelRow('tabela_dw');
        // loadData(); // Não precisa recarregar a tabela principal (fluxo)
        loadStats(); // Apenas atualiza as estatísticas
    } catch (error) {
        console.error('Error saving tabela_dw data:', error);
        showNotification('Erro ao salvar dados da Tabela DW: ' + error.message, 'danger');
    } finally {
        saveButton.disabled = false;
    }
}


// ===================================
// CAMPOS DINÂMICOS (COLUNAS REAIS) (Sem grandes alterações)
// ===================================

/**
 * Busca colunas da tabela no Supabase e armazena em cache
 * @param {string} tableName - O nome da tabela ('fase' ou 'tabela_dw').
 */
async function fetchAndCacheTableColumns(tableName) {
    if (!supabaseClient) return; 
    try {
        const { data: columnNames, error } = await supabaseClient
            .rpc('get_table_columns', {
                p_table_name: tableName
            });
        if (error) throw error;
        
        allTableColumns[tableName] = columnNames || []; 
    } catch (error) {
         console.error(`Erro ao buscar colunas para ${tableName}:`, error);
         allTableColumns[tableName] = []; 
    }
}

/**
 * Constrói o formulário de LINHA ÚNICA dinamicamente (para "Adicionar Nova Linha").
 * @param {string} tableName - O nome da tabela ('fase' ou 'tabela_dw').
 * @param {string} containerId - O ID do elemento <form> onde os campos serão inseridos.
 */
async function buildDynamicForm(tableName, containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container de formulário não encontrado: ${containerId}`);
        return;
    }
    
    container.innerHTML = ''; // Limpa o container

    if (allTableColumns[tableName].length === 0) {
        await fetchAndCacheTableColumns(tableName);
    }
    
    const columnNames = allTableColumns[tableName];
    
    if (!columnNames || columnNames.length === 0) {
        console.warn(`Nenhuma coluna encontrada para a tabela: ${tableName}`);
        container.innerHTML = '<p class="text-danger">Nenhuma coluna de formulário encontrada. Adicione uma usando o botão +.</p>';
        return;
    }

    // Constrói o HTML do formulário
    columnNames.forEach(colName => {
        const friendlyName = formatColumnName(colName);
        const div = document.createElement('div');
        
        // Layout: Textareas ocupam 12 colunas, inputs 6.
        if (colName.includes('atividade') || colName.includes('origem') || colName.includes('guarda') || colName.includes('transformacao') || colName.includes('consumo') || colName.includes('objetos') || colName.includes('funcao') || colName.includes('requisitos')) {
            div.className = 'col-md-12';
            div.innerHTML = `
                <label for="form_edit_${colName}" class="form-label">${friendlyName}</label>
                <textarea class="form-control" id="form_edit_${colName}" name="${colName}" rows="2"></textarea>
            `;
        } else {
            div.className = 'col-md-6';
            div.innerHTML = `
                <label for="form_edit_${colName}" class="form-label">${friendlyName}</label>
                <input type="${colName === 'registros' ? 'number' : 'text'}" class="form-control" id="form_edit_${colName}" name="${colName}" ${colName === 'customer_id' ? 'required' : ''}>
            `;
        }
        container.appendChild(div);
    });
}

/**
 * Constrói o cabeçalho da planilha dinâmica (Excel-style).
 * @param {string} tableName - O nome da tabela ('fase' ou 'tabela_dw').
 */
async function buildExcelGrid(tableName) {
    const tableHeadId = (tableName === 'fase') ? 'tableFaseHead' : 'tableDWHead';
    const tableBodyId = (tableName === 'fase') ? 'tableFaseBody' : 'tableDWBody';
    
    const tableHead = document.getElementById(tableHeadId);
    const tableBody = document.getElementById(tableBodyId);

    if (!tableHead || !tableBody) {
        console.error(`Elementos da tabela não encontrados para: ${tableName}`);
        return;
    }

    // Pega as colunas do cache. Se o cache estiver vazio, busca novamente.
    if (allTableColumns[tableName].length === 0) {
        await fetchAndCacheTableColumns(tableName);
    }
    
    const columnNames = allTableColumns[tableName];
    
    tableHead.innerHTML = ''; // Limpa o cabeçalho
    tableBody.innerHTML = ''; // Limpa o corpo
    
    if (!columnNames || columnNames.length === 0) {
        console.warn(`Nenhuma coluna encontrada para a tabela: ${tableName}`);
        tableBody.innerHTML = '<tr><td class="text-danger">Nenhuma coluna de formulário encontrada. Adicione uma usando o botão "+ Adicionar Nova Coluna".</td></tr>';
        return;
    }

    // Constrói o Cabeçalho (thead)
    columnNames.forEach(colName => {
        const th = document.createElement('th');
        th.textContent = formatColumnName(colName);
        tableHead.appendChild(th);
    });
    const thAction = document.createElement('th');
    thAction.textContent = 'Ação';
    tableHead.appendChild(thAction);

    // Adiciona a primeira linha em branco
    addNewExcelRow(tableName);
}

/**
 * Adiciona uma nova linha em branco (estilo Excel) à tabela especificada.
 * @param {string} tableName - O nome da tabela ('fase' ou 'tabela_dw').
 */
function addNewExcelRow(tableName) {
    const tableBodyId = (tableName === 'fase') ? 'tableFaseBody' : 'tableDWBody';
    const tableBody = document.getElementById(tableBodyId);
    const columnNames = allTableColumns[tableName];

    if (!columnNames || columnNames.length === 0) {
        if(tableBody.innerHTML.includes('Nenhuma coluna')) return;
        showNotification(`Não é possível adicionar linha: Colunas para '${tableName}' não carregadas.`, 'warning');
        return;
    }

    const tr = document.createElement('tr');
    
    // Adiciona célula de input para cada coluna
    columnNames.forEach(colName => {
        const td = document.createElement('td');
        // ATUALIZAÇÃO: Adicionados os eventos onfocus, oninput, onblur
        td.innerHTML = `<input type="text" 
                                class="form-control form-control-sm" 
                                data-column-name="${colName}" 
                                name="${colName}"
                                onfocus="showTypingTooltip(this)"
                                oninput="updateTypingTooltip(this)"
                                onblur="hideTypingTooltip()">`;
        tr.appendChild(td);
    });

    // Adiciona célula de Ação (remover)
    const tdAction = document.createElement('td');
    tdAction.innerHTML = `<button type="button" class="btn btn-danger btn-sm" onclick="removeExcelRow(this)" title="Remover Linha">
                            <i class="fas fa-trash-alt"></i>
                          </button>`;
    tr.appendChild(tdAction);

    tableBody.appendChild(tr);
}

/**
 * Remove uma linha da planilha (Excel-style).
 * @param {HTMLElement} buttonElement - O botão 'remover' que foi clicado.
 */
function removeExcelRow(buttonElement) {
    const tr = buttonElement.closest('tr');
    if (tr) {
        tr.remove();
    }
}

/**
 * ATUALIZADO: Funções de ajuda para o tooltip de digitação
 */
function showTypingTooltip(inputElement) {
    const tooltip = document.getElementById('typingTooltip');
    const rect = inputElement.getBoundingClientRect();
    
    tooltip.textContent = inputElement.value;
    tooltip.style.left = rect.left + 'px';
    tooltip.style.top = (rect.bottom + 5) + 'px'; // 5px abaixo do campo
    tooltip.style.display = 'block';
}
function updateTypingTooltip(inputElement) {
    const tooltip = document.getElementById('typingTooltip');
    if (tooltip.style.display === 'block') {
        tooltip.textContent = inputElement.value;
    }
}
function hideTypingTooltip() {
    const tooltip = document.getElementById('typingTooltip');
    tooltip.style.display = 'none';
}


/**
 * Abre o modal para adicionar um novo campo dinâmico (nova coluna).
 * @param {string} context - Onde o campo será adicionado ('fase', 'dw', ou 'linha').
 */
function openAdicionarCampoDinamico(context) {
    currentDynamicFieldContext = context; 
    document.getElementById('formAdicionarCampoDinamico').reset(); 

    const divSelectTabela = document.getElementById('divSelectTabelaCampo');
    const selectTabela = document.getElementById('selectTabelaCampo');

    if (context === 'linha') {
        divSelectTabela.style.display = 'block';
        selectTabela.value = currentTable; // currentTable (agora 'fluxo') será o padrão
    } else {
        divSelectTabela.style.display = 'none';
    }
    
    modalAdicionarCampo.show(); 
}

/**
 * Chama o RPC para criar a coluna e reconstrói o formulário/planilha.
 */
async function salvarNovoCampoDinamico() {
    const nomeCampoInput = document.getElementById('nomeNovoCampo');
    const friendlyName = nomeCampoInput.value.trim();
    
    if (!friendlyName) {
        showNotification('Por favor, insira um nome para o campo.', 'warning');
        return;
    }

    const sanitizedName = friendlyName.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, '_');
     if (!/^[a-z_][a-z0-9_]*$/.test(sanitizedName)) {
         showNotification('Nome de campo inválido. Use apenas letras minúsculas, números e underscores, começando com uma letra ou underscore.', 'danger');
         return;
    }

    let tabela;

    if (currentDynamicFieldContext === 'fase') {
        tabela = 'fase';
    } else if (currentDynamicFieldContext === 'dw') {
        tabela = 'tabela_dw';
    } else if (currentDynamicFieldContext === 'linha') {
        tabela = document.getElementById('selectTabelaCampo').value;
    } else {
        console.error('Contexto desconhecido:', currentDynamicFieldContext);
        return;
    }

    try {
        if (!supabaseClient) { showNotification('Supabase não conectado.', 'danger'); return; }

        // 1. Chama o RPC para adicionar a coluna
        const { data, error } = await supabaseClient
            .rpc('adicionar_coluna_dinamica', {
                nome_tabela: tabela,
                nome_coluna: sanitizedName
            });

        if (error) throw error;
        
        modalAdicionarCampo.hide(); 
        nomeCampoInput.value = ''; 
        showNotification(data, 'success'); 

        // 2. Limpa o cache de colunas
        allTableColumns[tabela] = [];

        // 3. Reconstrói a UI correta
        if (currentDynamicFieldContext === 'fase' || currentDynamicFieldContext === 'dw') {
            await buildExcelGrid(tabela); // Reconstrói a planilha
        } else if (currentDynamicFieldContext === 'linha') {
            // Se a tabela principal (fluxo) foi editada, recarrega
            if (tabela === 'fluxo') {
                await loadData();
            } else {
                // Se foi o form de 'Adicionar Linha' (agora oculto), reconstrói ele
                await buildDynamicForm(tabela, 'formEditarLinha');
            }
        }

    } catch (error) {
        console.error('Erro ao adicionar coluna:', error);
        showNotification('Erro ao adicionar coluna: ' + error.message, 'danger');
    }
}

// ===================================
// ADICIONAR LINHA (FORMULÁRIO ÚNICO) - Lógica antiga mantida
// ===================================

async function openAdicionarLinhaModal() {
    const modal = new bootstrap.Modal(document.getElementById('modalEditarLinha'));
    document.getElementById('modalEditarLinhaTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Adicionar Nova Linha';
    
    const form = document.getElementById('formEditarLinha');
    form.innerHTML = '<div class="col-12 loading-form"><div class="spinner"></div></div>'; 
    
    modal.show(); 

    // Constrói o formulário dinâmico de ENTRADA ÚNICA
    // currentTable será 'fluxo' por padrão
    await buildDynamicForm(currentTable, 'formEditarLinha');
}


async function salvarLinha() {
    const rowData = {};

    // 1. Coletar dados (TODOS os campos do formulário 'formEditarLinha')
    const form = document.getElementById('formEditarLinha');
    const formData = new FormData(form);
    for (let [key, value] of formData.entries()) {
        if (value.trim()) {
            rowData[key] = value.trim();
        }
    }
    
    // 2. Adicionar Chaves Estrangeiras (Se for 'fase' ou 'dw')
    if (currentTable === 'fase' || currentTable === 'tabela_dw') {
        const selectedFluxoId = document.getElementById('filterFluxo').value;
        
        if (!selectedFluxoId) {
            showNotification('Por favor, selecione um Fluxo no filtro antes de adicionar uma linha.', 'warning');
            return;
        }
        
        const fluxoDetails = fluxosList.find(f => f.id_fluxo == selectedFluxoId);
        
        if (fluxoDetails) {
            rowData['id_fluxo'] = fluxoDetails.id_fluxo;
            rowData['id_cliente'] = fluxoDetails.id_cliente;
            rowData['id_empresa'] = fluxoDetails.id_empresa;
        } else {
            showNotification('Erro: Detalhes do fluxo selecionado não encontrados.', 'danger');
            return;
        }
        
        if (!rowData.customer_id) {
             showNotification('O campo "Customer Id" é obrigatório.', 'warning');
             return;
        }
    }
    
    // 3. Salva no Supabase
    try {
        if (!supabaseClient) {
             showNotification('Supabase não configurado.', 'danger');
             return;
        }
        
        const { data, error } = await supabaseClient
            .from(currentTable) // Salva na tabela que o form foi construído (deve ser 'fluxo' agora)
            .insert([rowData])
            .select();
            
        if (error) throw error;
        
        showNotification('Linha adicionada com sucesso!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('modalEditarLinha')).hide();
        loadData(); 
        loadStats(); 
    } catch (error) {
        console.error('Error saving row:', error);
        showNotification('Erro ao salvar linha: ' + error.message, 'danger');
    }
}


// ===================================
// DIAGRAMA (Lógica antiga, agora usado pelo 'Visualizar')
// ===================================

async function openDiagramaModal(customerId) {
    const modal = new bootstrap.Modal(document.getElementById('modalDiagrama'));
    const content = document.getElementById('diagramaContent');
    
    content.innerHTML = '<div class="loading"><div class="spinner"></div><p class="mt-2">Carregando diagrama...</p></div>';
    modal.show();
    
    try {
        let fase1Data = [];
        let dwData = [];
        
        if (!supabaseClient) {
            // Demo data
            fase1Data = []; // Simplificado
            dwData = [];
        } else {
            const [fase1, dw] = await Promise.all([
                supabaseClient.from('fase').select('*').eq('customer_id', customerId),
                supabaseClient.from('tabela_dw').select('*').eq('customer_id', customerId)
            ]);
            
            fase1Data = fase1.data || [];
            dwData = dw.data || [];
        }
        
        content.innerHTML = `
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <h5 style="color: #0d6efd; margin-bottom: 15px;"><i class="fas fa-info-circle me-2"></i>Informações</h5>
                <p><strong>Customer ID:</strong> ${customerId}</p>
            </div>
            
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <h5 style="color: #0d6efd; margin-bottom: 15px;"><i class="fas fa-database me-2"></i>Dados - Fase (${fase1Data.length} registros)</h5>
                ${renderDiagramTable(fase1Data)}
            </div>
            
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                <h5 style="color: #0d6efd; margin-bottom: 15px;"><i class="fas fa-database me-2"></i>Dados - DW (${dwData.length} registros)</h5>
                ${renderDiagramTable(dwData)}
            </div>
        `;
    } catch (error) {
        console.error('Error loading diagram:', error);
        content.innerHTML = `<div class="alert alert-danger">Erro ao carregar diagrama: ${error.message}</div>`;
    }
}


function renderDiagramTable(data) {
    if (data.length === 0) {
        return '<p class="text-muted">Nenhum dado encontrado</p>';
    }
    
    const columns = Object.keys(data[0]);
    
    let html = '<div class="table-responsive" style="max-height: 300px;"><table class="table table-sm table-bordered table-striped">';
    html += '<thead class="table-light" style="position: sticky; top: 0; z-index: 1;"><tr>';
    columns.forEach(col => {
        if (col === 'campos_dinamicos' || col === 'campos_customizados') return;
        html += `<th>${formatColumnName(col)}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    data.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
            if (col === 'campos_dinamicos' || col === 'campos_customizados') return;
            let value = row[col];
            if (typeof value === 'object' && value !== null) {
                value = JSON.stringify(value);
            }
            html += `<td>${value || '-'}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    return html;
}

// ===================================
// FILTROS - REMOVIDO
// ===================================

// Funções removidas - elementos de filtro excluídos da interface
// async function handleFilter(e) { ... }
// function limparFiltros() { ... }

function formatColumnName(name) {
    return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// Make functions globally available
window.openDiagramaModal = openDiagramaModal;
window.visualizarFluxo = visualizarFluxo; // NOVO
window.toggleFluxoEdit = toggleFluxoEdit; // NOVO
window.cancelFluxoEdit = cancelFluxoEdit; // NOVO
window.saveFluxoEdit = saveFluxoEdit; // NOVO
window.confirmarExclusao = confirmarExclusao; // NOVO
window.deleteFluxo = deleteFluxo; // NOVO
window.showDashboardView = showDashboardView;
window.openAdicionarCampoDinamico = openAdicionarCampoDinamico; 
window.removeExcelRow = removeExcelRow; 
// ATUALIZADO: Expondo as novas funções de tooltip
window.showTypingTooltip = showTypingTooltip;
window.updateTypingTooltip = updateTypingTooltip;
window.hideTypingTooltip = hideTypingTooltip;

    </script>

</body>
</html>




