<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ResolvTask</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Color Variables */
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
        }

        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
            overflow-x: hidden;
        }
        .app-container {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .app-container.authenticated {
            opacity: 1;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { filter: brightness(0.9); }

        /* Auth Loading Screen */
        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        .auth-loading .spinner-auth {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        .auth-loading h4 {
            margin-bottom: 10px;
            font-weight: 300;
        }

        /* Sidebar */
        .sidebar {
            height: 100vh;
            width: 280px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color) 100%);
            position: fixed;
            left: 0;
            top: 0;
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
        }
        .sidebar-header .logo {
            max-width: 150px;
            height: auto;
            margin-bottom: 10px;
        }
        .sidebar-header .text-light {
            color: var(--dark-color) !important;
            font-weight: 500;
        }
        .sidebar-menu {
            padding: 20px 0;
        }
        .menu-item {
            display: block;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        .menu-item:hover, .menu-item.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        .menu-item i {
            width: 20px;
            margin-right: 15px;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .main-content.expanded {
            margin-left: 0;
        }

        /* Top Navigation */
        .top-nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Content Area */
        .content-area {
            padding: 25px;
        }

        /* Cards */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .table thead th {
            background-color: var(--light-color);
            color: var(--dark-color);
            font-weight: 600;
            border: none;
            padding: 15px;
        }

        .table tbody td {
            padding: 15px;
            border-color: #f1f3f4;
            vertical-align: middle;
        }

        /* Status Badges */
        .status-badge {
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-em-andamento { background-color: #cff4fc; color: #055160; }
        .status-concluido, .status-conclu√çdo { background-color: #d1e7dd; color: #0f5132; }
        .status-nao-iniciado { background-color: #f8d7da; color: #842029; }
        .status-paralizado { background-color: #fff3cd; color: #664d03; }

        /* Form Styles */
        .form-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        .form-control, .form-select {
            border: 2px solid #f1f3f4;
            border-radius: 10px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        .form-control:disabled, .form-select:disabled {
          background-color: #e9ecef;
          opacity: 1;
        }
        .btn {
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Other specific styles from task manager */
        .time-control-btn { padding: 6px 12px; font-size: 0.85rem; }
        .time-entries-table { max-height: 300px; overflow-y: auto; }
        .time-entries-table table { font-size: 0.9rem; }
        .time-entry-status { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .time-entry-active { background-color: #cff4fc; color: #055160; }
        .time-entry-completed { background-color: #d1e7dd; color: #0f5132; }
        .observation-truncated { cursor: pointer; color: var(--primary-color); text-decoration: underline; font-weight: 500; }
        .observation-truncated:hover { filter: brightness(0.8); }
        .positive-deviation { color: var(--danger-color); font-weight: bold; }
        .negative-deviation { color: var(--success-color); font-weight: bold; }
        .required-field::after { content: "*"; color: var(--danger-color); margin-left: 4px; }
        .hour-input { text-align: right; }
        .filters-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .filter-item { flex: 1; min-width: 200px; }
        .resume-truncated { cursor: pointer; color: var(--primary-color); text-decoration: underline; font-weight: 500; }
        .resume-truncated:hover { filter: brightness(0.8); }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
        }

        /* Spin Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Disabled Button Styling */
        .btn.disabled, .btn:disabled {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar { width: 260px; }
            .main-content { margin-left: 260px; }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; z-index: 1050; }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { display: block; }
            .top-nav { flex-wrap: wrap; gap: 10px; }
            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
            .sidebar-overlay.show { opacity: 1; visibility: visible; }
            .filter-item { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="auth-loading" id="authLoading">
        <div class="spinner-auth"></div>
        <h4>ResolvTask Dashboard</h4>
        <p>Verificando autentica√ß√£o...</p>
    </div>

    <div class="app-container" id="appContainer">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png" alt="ResolvAI Logo" class="logo">
                <br><br>
                <h1><i class="fas fa-bolt me-2"></i>Task</h1>
                <small class="text-light">Sistema Integrado de Gest√£o</small>
            </div>
            <div class="sidebar-menu" id="sidebarMenu">
                <button class="menu-item" onclick="window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/resolv'" data-menu="dashboard"><i class="fas fa-chart-line"></i>Dashboard</button>
                <button class="menu-item active" onclick="window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gerenciadortarefas'" data-menu="tasks"><i class="fas fa-tasks"></i>Gerenciador de Tarefas</button>
                <button class="menu-item" onclick="window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/taskhoras'" data-menu="hours"><i class="fas fa-clock"></i>Gerenciador de Horas</button>
                <button class="menu-item" onclick="window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gestao_clientes'" data-menu="clients"><i class="fas fa-handshake"></i>Gest√£o de Clientes</button>
                <button class="menu-item" onclick="window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gestaodeparceiros'" data-menu="partners"><i class="fas fa-handshake-angle"></i>Gest√£o de Parceiros</button>
                <button class="menu-item" onclick="window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/equipe'" data-menu="team"><i class="fas fa-users"></i>Equipe</button>
                <button class="menu-item" onclick="window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/conf'" data-menu="settings"><i class="fas fa-cog"></i>Configura√ß√µes</button>
            </div>
        </nav>

        <main class="main-content" id="mainContent">
            <nav class="top-nav">
                <div class="d-flex align-items-center">
                    <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                    <h5 class="mb-0 ms-3" id="pageTitle">Dashboard de Clientes</h5>
                </div>
                <div class="user-info">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle fs-4 text-primary me-2"></i>
                        <span class="fw-bold" id="userNameDisplay">Usu√°rio</span>
                    </div>
                    <button class="btn btn-outline-danger btn-sm ms-2" id="logoutButton" title="Sair">
                        <i class="fas fa-sign-out-alt me-1"></i>Sair
                    </button>
                </div>
            </nav>

            <div class="content-area">
                <div id="tasks-page" class="page-content active">
                    <div class="card form-card mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-plus me-2"></i><span id="formTitle">Adicionar Nova Tarefa</span>
                            </h5>
                            <button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#formCollapse" aria-expanded="true">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="collapse show" id="formCollapse">
                            <div class="card-body">
                                <form id="taskForm">
                                    <input type="hidden" id="taskId">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="taskType" class="form-label required-field">Tipo de Tarefa</label>
                                            <div class="input-group">
                                                <select class="form-select" id="taskType" required></select>
                                                <button class="btn btn-outline-primary" type="button" id="addNewTaskTypeBtn" title="Adicionar Novo Tipo de Tarefa">
                                                    <i class="fas fa-plus"></i> NOVA TAREFA
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="taskDescription" class="form-label required-field">Resumo da Descri√ß√£o</label>
                                            <input type="text" class="form-control" id="taskDescription" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="project" class="form-label required-field">Projeto</label>
                                            <input type="text" class="form-control" id="project" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="client" class="form-label">Cliente</label>
                                            <div class="input-group">
                                                <select class="form-select" id="client"></select>
                                                <button class="btn btn-outline-primary" type="button" id="addNewClientBtn" title="Adicionar Novo Cliente">
                                                    <i class="fas fa-plus"></i> NOVO CLIENTE
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="company" class="form-label">Empresa</label>
                                            <select class="form-select" id="company"></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="responsible" class="form-label required-field">Respons√°vel</label>
                                            <select class="form-select" id="responsible" required></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="startDate" class="form-label required-field">Data In√≠cio</label>
                                            <input type="date" class="form-control" id="startDate" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="endDate" class="form-label required-field">Data Final</label>
                                            <input type="date" class="form-control" id="endDate" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="completionDate" class="form-label">Data de Finaliza√ß√£o</label>
                                            <input type="date" class="form-control" id="completionDate">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="estimatedHours" class="form-label">Horas Estimadas</label>
                                            <input type="text" class="form-control hour-input" id="estimatedHours" value="0" placeholder="Ex: 8,5">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="actualHours" class="form-label">Horas Realizadas</label>
                                            <input type="text" class="form-control hour-input" id="actualHours" value="0" placeholder="Ex: 8,5">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="deviation" class="form-label">Desvio (Horas)</label>
                                            <input type="text" class="form-control hour-input" id="deviation" readonly>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="status" class="form-label">Situa√ß√£o</label>
                                            <select class="form-select" id="status"></select>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-4 gap-2">
                                        <button type="button" class="btn btn-secondary" id="clearFormBtn">
                                            <i class="fas fa-eraser me-2"></i>Limpar
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="saveTaskBtn">
                                            <i class="fas fa-save me-2"></i>Adicionar Tarefa
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="card form-card mb-4">
                        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-filter me-2"></i>Filtros
                            </h5>
                            <button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="collapse" id="filtersCollapse">
                            <div class="card-body">
                                <div class="filters-container">
                                    <div class="filter-item">
                                        <label for="filterResponsible" class="form-label">Respons√°vel</label>
                                        <select class="form-select" id="filterResponsible"></select>
                                    </div>
                                    <div class="filter-item">
                                        <label for="filterProject" class="form-label">Projeto</label>
                                        <select class="form-select" id="filterProject"></select>
                                    </div>
                                    <div class="filter-item">
                                        <label for="filterClient" class="form-label">Cliente</label>
                                        <select class="form-select" id="filterClient"></select>
                                    </div>
                                    <div class="filter-item">
                                        <label for="filterCompany" class="form-label">Empresa</label>
                                        <select class="form-select" id="filterCompany"></select>
                                    </div>
                                    <div class="filter-item">
                                        <label for="filterStatus" class="form-label">Situa√ß√£o</label>
                                        <select class="form-select" id="filterStatus"></select>
                                    </div>
                                    <div class="filter-item">
                                        <label for="filterTaskType" class="form-label">Tipo de Tarefa</label>
                                        <select class="form-select" id="filterTaskType"></select>
                                    </div>
                                    <div class="filter-item">
                                        <label for="filterStartDate" class="form-label">Data In√≠cio (De)</label>
                                        <input type="date" class="form-control" id="filterStartDate">
                                    </div>
                                    <div class="filter-item">
                                        <label for="filterEndDate" class="form-label">Data In√≠cio (At√©)</label>
                                        <input type="date" class="form-control" id="filterEndDate">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end gap-2 mt-3">
                                    <button type="button" class="btn btn-info" id="applyFiltersBtn">
                                        <i class="fas fa-search me-2"></i>Filtrar
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="clearFiltersBtn">
                                        <i class="fas fa-times me-2"></i>Limpar Filtros
                                    </button>
                                    <button type="button" class="btn btn-success" id="exportExcelBtn">
                                        <i class="fas fa-file-excel me-2"></i>Exportar Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h5 class="mb-3">
                            <i class="fas fa-list text-primary me-2"></i>
                            Lista de Tarefas
                        </h5>

                        <ul class="nav nav-tabs" id="taskTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved-tab-pane" type="button" role="tab" aria-controls="approved-tab-pane" aria-selected="true">Aprovados</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-tab-pane" type="button" role="tab" aria-controls="pending-tab-pane" aria-selected="false">
                                    Pendentes <span class="badge bg-danger" id="pending-count">0</span>
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="taskTabsContent">
                            <div class="tab-pane fade show active" id="approved-tab-pane" role="tabpanel" aria-labelledby="approved-tab" tabindex="0">
                                <div class="table-responsive pt-3">
                                    <table id="taskTableApproved" class="table table-striped table-hover" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>Id</th>
                                                <th>Controle de Horas</th>
                                                <th>Tipo de Tarefa</th>
                                                <th>Resumo</th>
                                                <th>Projeto</th>
                                                <th>Cliente</th>
                                                <th>Empresa</th>
                                                <th>Respons√°vel</th>
                                                <th>Data In√≠cio</th>
                                                <th>Data Final</th>
                                                <th>Data Finalizada</th>
                                                <th>Estimativa (h)</th>
                                                <th>Realizado (h)</th>
                                                <th>Desvio (h)</th>
                                                <th>Situa√ß√£o</th>
                                                <th>A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="pending-tab-pane" role="tabpanel" aria-labelledby="pending-tab" tabindex="0">
                                <div class="d-flex justify-content-end my-3">
                                    <div class="col-md-3">
                                        <label for="filterPendingStatus" class="form-label">Filtrar por Status</label>
                                        <select class="form-select form-select-sm" id="filterPendingStatus">
                                            <option value="false" selected>Pendente</option>
                                            <option value="canceled">Cancelado</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table id="taskTablePending" class="table table-striped table-hover" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>Id</th>
                                                <th>Tipo de Tarefa</th>
                                                <th>Resumo</th>
                                                <th>Projeto</th>
                                                <th>Respons√°vel</th>
                                                <th>Data In√≠cio</th>
                                                <th>Estimativa (h)</th>
                                                <th>Status Aprova√ß√£o</th>
                                                <th>Motivo da Recusa</th>
                                                <th>A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <div class="modal fade" id="confirmTaskModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="confirmTaskModalTitle">Confirmar Dados da Tarefa</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-edit me-2"></i>Editar
                        </button>
                        <button type="button" class="btn btn-primary" id="confirmTaskBtn">
                            <i class="fas fa-check me-2"></i>OK - Confirmar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Confirmar Exclus√£o</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Tem certeza que deseja excluir esta tarefa? Esta a√ß√£o n√£o pode ser desfeita.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="resumeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Resumo Completo da Tarefa</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p id="fullResumeText"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="timeControlModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-clock me-2"></i>Controle de Horas - Tarefa ID: <span id="timeControlTaskId"></span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-4">
                            <h6 class="text-secondary mb-3">Informa√ß√µes da Tarefa</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Descri√ß√£o:</strong></td><td id="timeControlTaskDescription"></td></tr>
                                <tr><td><strong>Respons√°vel:</strong></td><td id="timeControlTaskResponsible"></td></tr>
                                <tr><td><strong>Projeto:</strong></td><td id="timeControlTaskProject"></td></tr>
                            </table>
                        </div>
                        <div id="timeControlObservationSection" class="mb-4">
                            <label for="timeControlObservation" class="form-label required-field">Observa√ß√£o</label>
                            <textarea class="form-control" id="timeControlObservation" rows="3" placeholder="Descreva o procedimento realizado..." required></textarea>
                        </div>
                        <div class="mb-4 d-flex justify-content-center gap-3" id="timeActionButtons">
                            <!-- Buttons will be injected here by JavaScript -->
                        </div>
                        <div class="time-entries-table">
                            <h6 class="text-secondary mb-3">Registros de Horas</h6>
                            <div id="timeEntriesTableContainer">
                                <p class="text-muted text-center">Nenhum registro de horas para esta tarefa.</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="manualTimeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="manualTimeModalTitle">Inserir Hor√°rio Manualmente</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="manualDateTimeInput" class="form-label required-field">Data e Hora</label>
                            <input type="datetime-local" class="form-control" id="manualDateTimeInput" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirmManualTimeBtn">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="timeConfirmationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>Confirmar A√ß√£o
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-clock fs-1 text-warning mb-3"></i>
                            <p class="fs-5 mb-2">Tem certeza que deseja realizar esta a√ß√£o?</p>
                            <p class="text-muted" id="timeConfirmationMessage">Esta a√ß√£o ir√° registrar o controle de horas para a tarefa.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-warning" id="confirmTimeActionBtn">
                            <i class="fas fa-check me-1"></i>Confirmar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="newTaskTypeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Adicionar Novo Tipo de Tarefa</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newTaskTypeForm">
                            <div class="mb-3">
                                <label for="newTaskTypeName" class="form-label">Nome do Novo Tipo de Tarefa</label>
                                <input type="text" class="form-control" id="newTaskTypeName" style="text-transform: uppercase;" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="saveNewTaskTypeBtn">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="newClientModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Adicionar/Editar Cliente</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newClientForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="newClientName" class="form-label required-field">Nome do Cliente</label>
                                    <input type="text" class="form-control" id="newClientName" style="text-transform: uppercase;" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="newClientCnpj" class="form-label">CNPJ</label>
                                    <input type="text" class="form-control" id="newClientCnpj">
                                </div>
                                <div class="col-md-6">
                                    <label for="newClientEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="newClientEmail" style="text-transform: lowercase;">
                                </div>
                                <div class="col-md-6">
                                    <label for="newClientPhone" class="form-label">Telefone</label>
                                    <input type="text" class="form-control" id="newClientPhone">
                                </div>
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="newClientActive" checked>
                                        <label class="form-check-label" for="newClientActive">
                                            Cliente Ativo
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="saveNewClientBtn">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="approvalActionModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Aprovar ou Cancelar Tarefa</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="approvalTaskDetails">
                        </div>
                        <div id="cancelReasonSection" class="mt-3" style="display: none;">
                            <label for="cancelReason" class="form-label required-field">Motivo do Cancelamento</label>
                            <textarea class="form-control" id="cancelReason" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <div id="initialButtons">
                            <button type="button" class="btn btn-danger" id="showCancelReasonBtn">Cancelar Tarefa</button>
                            <button type="button" class="btn btn-success" id="confirmApproveBtn">Aprovar Tarefa</button>
                        </div>
                        <div id="confirmCancelButtons" style="display: none;">
                            <button type="button" class="btn btn-secondary" id="backToOptionsBtn">Voltar</button>
                            <button type="button" class="btn btn-danger" id="confirmCancelBtn">Confirmar Cancelamento</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <script>
        // --- VARI√ÅVEIS GLOBAIS ---
        let tasks = [];
        let colaboradores = [];
        let clients = [];
        let companies = [];
        let editingTaskId = null;
        let dataTableApproved;
        let dataTablePending;
        let tempTasksData = null;
        let activeTimeEntry = null;
        let openTaskIds = new Set();
        let completedTaskIds = new Set();
        let globalEndDate = null;
        let taskTypes = [];
        let _timeControlState = { action: null, taskId: null };

    // ===================================
    // FUN√á√ïES UTILIT√ÅRIAS GLOBAIS
    // ===================================
    function formatDate(dateString) {
        if (!dateString) return '';
        const dateParts = dateString.split(/[-T]/);
        if (dateParts.length < 3) return '';
        const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
        return date.toLocaleDateString('pt-BR');
    }

    function formatDateTime(dateString) {
        if (!dateString) return '';
        
        // Para valores vindos do /dataHoraatual, exibir exatamente como retornado
        if (typeof dateString === 'string' && dateString.includes('T')) {
            // Retorna o valor id√™ntico do endpoint sem qualquer modifica√ß√£o
            console.log('üìÖ Exibindo valor id√™ntico do endpoint:', dateString);
            return dateString;
        }
        
        // Fallback para outros formatos hist√≥ricos
        const date = new Date(dateString); 
        if (isNaN(date.getTime())) {
            return 'Data inv√°lida';
        }
        
        return date.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function formatDateTimeBrazilian(dateString) {
        if (!dateString) return '';
        
        // Formato brasileiro espec√≠fico para tabela de controle de horas: dd/MM/aa, HH:mm:ss
        if (typeof dateString === 'string' && dateString.includes('T')) {
            try {
                // Para strings como "2025-09-17T21:26:53.732-03:00"
                const [datePart, timePart] = dateString.split('T');
                if (!datePart || !timePart) return 'Data inv√°lida';
                
                const [year, month, day] = datePart.split('-');
                if (!year || !month || !day) return 'Data inv√°lida';
                
                const timeWithTz = timePart.split(/[\+\-]/)[0]; // Remove timezone
                if (!timeWithTz) return 'Data inv√°lida';
                
                const [hour, minute, secondWithMs] = timeWithTz.split(':');
                if (!hour || !minute) return 'Data inv√°lida';
                
                // Verificar se secondWithMs existe antes de fazer split
                const second = secondWithMs ? secondWithMs.split('.')[0] : '00';
                
                // Formato: 17/09/25, 21:26:53
                return `${day}/${month}/${year.slice(-2)}, ${hour}:${minute}:${second}`;
            } catch (error) {
                console.error('Erro ao formatar data:', error, 'dateString:', dateString);
                return 'Data inv√°lida';
            }
        }
        
        // Fallback para outros formatos hist√≥ricos
        const date = new Date(dateString); 
        if (isNaN(date.getTime())) {
            return 'Data inv√°lida';
        }
        
        return date.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function calculateDurationInMinutes(startDateString, endDateString) {
        if (!startDateString || !endDateString) return '---';
        
        try {
            // Fun√ß√£o para limpar e corrigir strings de data corrompidas
            const cleanDateString = (dateString) => {
                if (!dateString) return dateString;
                
                let cleaned = dateString.toString().trim();
                
                // Corrigir anos corrompidos - v√°rias abordagens
                // Exemplo: "62025-09-17T19:22" -> "2025-09-17T19:22"
                
                // M√©todo 1: Remover d√≠gitos extras no in√≠cio do ano
                if (cleaned.includes('-') && cleaned.includes('T')) {
                    const parts = cleaned.split('-');
                    if (parts.length >= 3 && parts[0].length > 4) {
                        // Se o primeiro parte (ano) tem mais de 4 d√≠gitos, pegar os √∫ltimos 4
                        const correctedYear = parts[0].slice(-4);
                        cleaned = correctedYear + '-' + parts.slice(1).join('-');
                        console.log('üìÖ Data corrigida:', cleaned, '(original:', dateString + ')');
                    }
                }
                
                return cleaned;
            };
            
            // Fun√ß√£o para converter string de data em objeto Date
            const parseDateTime = (dateString) => {
                const cleanedDateString = cleanDateString(dateString);
                
                // Se j√° √© um objeto Date v√°lido
                if (cleanedDateString instanceof Date && !isNaN(cleanedDateString.getTime())) {
                    return cleanedDateString;
                }
                
                // Tentar parsing com a string limpa
                if (typeof cleanedDateString === 'string') {
                    // M√©todo 1: Parse direto da string ISO
                    let date = new Date(cleanedDateString);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                    
                    // M√©todo 2: Se n√£o tem segundos, adicionar ":00"
                    if (cleanedDateString.includes('T') && !cleanedDateString.includes(':00') && cleanedDateString.split(':').length === 2) {
                        const withSeconds = cleanedDateString + ':00';
                        date = new Date(withSeconds);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                }
                
                throw new Error(`N√£o foi poss√≠vel converter para Date: ${cleanedDateString} (original: ${dateString})`);
            };
            
            const startDate = parseDateTime(startDateString);
            const endDate = parseDateTime(endDateString);
            
            console.log('üïê Calculando dura√ß√£o:', {
                start: startDate.toISOString(),
                end: endDate.toISOString()
            });
            
            // Calcular diferen√ßa em milissegundos e converter para minutos
            const diffInMilliseconds = endDate.getTime() - startDate.getTime();
            const diffInMinutes = Math.round(diffInMilliseconds / 60000);
            
            console.log('‚è±Ô∏è Dura√ß√£o calculada:', diffInMinutes, 'minutos');
            
            // Sempre retornar valor positivo para representar tempo trabalhado
            return Math.abs(diffInMinutes);
            
        } catch (error) {
            console.error('‚ùå Erro ao calcular dura√ß√£o:', error.message, {
                start: startDateString,
                end: endDateString
            });
            return 0; // Retornar 0 em vez de 'Erro' para manter consist√™ncia num√©rica
        }
    }
    
    function parseDecimalInput(value) {
        if (!value || value === '') return 0;
        const cleanValue = value.toString().trim().replace(/\s/g, '').replace(',', '.');
        const parsed = parseFloat(cleanValue);
        return isNaN(parsed) ? 0 : parsed;
    }

    function calculateDeviation() {
        const estimated = parseDecimalInput(document.getElementById('estimatedHours').value);
        const actual = parseDecimalInput(document.getElementById('actualHours').value);
        const deviation = actual - estimated;
        const deviationEl = document.getElementById('deviation');
        deviationEl.value = formatDecimalOutput(deviation);
        deviationEl.className = 'form-control hour-input';
        if (deviation > 0) deviationEl.classList.add('positive-deviation');
        if (deviation < 0) deviationEl.classList.add('negative-deviation');
    }
    
    function formatDecimalOutput(value) {
        const num = parseFloat(value);
        return isNaN(num) ? '0,00' : num.toFixed(2).replace('.', ',');
    }

    function truncateResume(text, maxLength = 18) {
        if (!text || text.length <= maxLength) return text || '';
        return text.substring(0, maxLength) + '...';
    }
    
    function toggleFormLock(isEditing = false) {
        const userData = Auth.getUserData();
        const userType = userData?.tipo || 'colaborador';

        const allFields = [
            'taskType', 'taskDescription', 'project', 'client', 'company',
            'responsible', 'startDate', 'endDate', 'estimatedHours',
            'completionDate', 'actualHours', 'status'
        ];

        const isColaborador = userType === 'colaborador';
        const fieldsToDisable = isColaborador && isEditing ? {
            taskType: true, taskDescription: true, project: true, client: true, company: true,
            responsible: true, startDate: true, endDate: true, completionDate: false, 
            estimatedHours: true, actualHours: false, deviation: true, status: false
        } : {};

        allFields.forEach(fieldId => {
            const el = document.getElementById(fieldId);
            if (el) {
                el.disabled = (isColaborador && isEditing) ? fieldsToDisable[fieldId] : (fieldId === 'deviation');
            }
        });
        document.getElementById('deviation').disabled = true;
    }

    // ===================================
    // OBJETOS GLOBAIS (AUTH e UI)
    // ===================================
    const Auth = {
        getUserData: () => {
            const sessionData = localStorage.getItem('userSession');
            return sessionData ? JSON.parse(sessionData) : null;
        },
        checkAuth: () => {
            const authToken = localStorage.getItem('authToken');
            const userData = Auth.getUserData();
            console.log('üîê Verificando status de login...', { hasToken: !!authToken, hasData: !!userData });
            
            // For demo/development purposes, create mock auth if not present
            if (!authToken || !userData) {
                console.log('üîß Modo de demonstra√ß√£o: criando autentica√ß√£o mock...');
                localStorage.setItem('authToken', 'demo-token-123');
                localStorage.setItem('userSession', JSON.stringify({
                    nome: 'Usu√°rio Demo',
                    tipo: 'admin',
                    email: 'demo@resolvrisk.com.br'
                }));
                return true;
            }
            return true;
        },
        logout: () => {
            console.log('üö™ Iniciando processo de logout...');
            localStorage.clear();
            const authLoadingEl = document.getElementById('authLoading');
            if (authLoadingEl) {
                authLoadingEl.style.display = 'flex';
                authLoadingEl.innerHTML = `<div class="spinner-auth"></div><h4>Sess√£o encerrada</h4><p>Voc√™ ser√° redirecionado.</p>`;
            }
            document.getElementById('appContainer').style.opacity = 0;
            setTimeout(() => { window.location.href = 'https://n8n.dev.resolvrisk.com.br/webhook/login'; }, 1500);
        },
        redirectToLogin: () => {
            console.log('üîÑ Redirecionando para p√°gina de login...');
            window.location.href = 'https://n8n.dev.resolvrisk.com.br/webhook/login';
        }
    };

    const UI = {
        updateUserInfo: () => {
            const userData = Auth.getUserData();
            if (userData) {
                document.getElementById('userNameDisplay').textContent = userData.nome;
                console.log('üë§ Informa√ß√µes do usu√°rio atualizadas:', userData.nome);
            }
        },
        showAuthenticatedInterface: () => {
            document.getElementById('authLoading').style.display = 'none';
            document.getElementById('appContainer').classList.add('authenticated');
            console.log('üéâ Interface principal ativada.');
        },
        applyUIPermissions: () => {
            const userData = Auth.getUserData();
            const userType = userData?.tipo || 'colaborador';
            console.log(`üîß Aplicando permiss√µes de UI para o tipo: ${userType}`);

            const menuPermissions = {
                admin: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'],
                colaborador: ['dashboard', 'tasks', 'hours', 'settings']
            };
            const allowedMenus = menuPermissions[userType] || menuPermissions.colaborador;

            document.querySelectorAll('#sidebarMenu .menu-item').forEach(item => {
                const menuType = item.getAttribute('data-menu');
                item.style.display = allowedMenus.includes(menuType) ? 'block' : 'none';
            });

            const newTaskTypeBtn = document.getElementById('addNewTaskTypeBtn');
            const newClientBtn = document.getElementById('addNewClientBtn');

            const isAdmin = userType === 'admin';
            if (newTaskTypeBtn) newTaskTypeBtn.style.display = isAdmin ? '' : 'none';
            if (newClientBtn) newClientBtn.style.display = isAdmin ? '' : 'none';
            
            toggleFormLock(false);
        },
        showNotification: (message, type = 'info', duration = 5000) => {
            const container = document.body;
            const alertType = type === 'error' ? 'danger' : type;
            const iconMap = { success: 'check-circle', warning: 'exclamation-triangle', danger: 'times-circle', info: 'info-circle' };
            const icon = iconMap[type] || 'info-circle';
            const notification = document.createElement('div');
            notification.className = `alert alert-${alertType} alert-dismissible fade show shadow-lg notification`;
            notification.innerHTML = `<i class="fas fa-${icon} me-2"></i> ${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            container.appendChild(notification);
            setTimeout(() => {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(notification);
                if (bsAlert) {
                    bsAlert.close();
                }
            }, duration);
        },
        toggleSidebar: () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const mainContent = document.getElementById('mainContent');
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
                overlay.classList.toggle('show');
                document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            }
        }
    };
    
    // ===================================
    // L√ìGICA DO MODAL DE HORAS
    // ===================================
    async function sendTimeEntryUpdate(action, taskId, observation, manualTimestamp = null) {
        const userData = Auth.getUserData();
        if (!userData) {
            UI.showNotification('Sua sess√£o expirou. Por favor, fa√ßa login novamente.', 'error');
            return;
        }

        let horaPayload;

        try {
            if (manualTimestamp) {
                // Para data manual, usa o valor exato inserido pelo usu√°rio sem convers√µes
                horaPayload = manualTimestamp;
                console.log('üìÖ Hora manual inserida:', horaPayload);
            } else {
                // Para data autom√°tica, busca a hora atual do webhook e usa exatamente como retornado
                console.log('üîÑ Buscando hora atual do servidor...');
                const response = await fetch('https://n8n.dev.resolvrisk.com.br/webhook/dataHoraatual');
                if (!response.ok) {
                    throw new Error('Falha ao buscar a hora atual do servidor.');
                }
                const data = await response.json();
                console.log('üì° Dados recebidos do /dataHoraatual:', data);
                
                if (data && data.length > 0 && data[0].currentDate) {
                    // Usa exatamente o valor retornado pelo endpoint, sem convers√µes
                    horaPayload = data[0].currentDate;
                    console.log('‚úÖ Hora autom√°tica extra√≠da (valor id√™ntico):', horaPayload);
                } else {
                    throw new Error('Formato de data e hora inv√°lido recebido do servidor.');
                }
            }
        } catch(error) {
             console.error('‚ùå Erro ao obter a hora:', error);
             UI.showNotification('Erro ao processar a hora. Usando hora local como fallback.', 'warning');
             // Fallback tamb√©m sem convers√µes desnecess√°rias
             horaPayload = new Date().toISOString();
        }


        const timeEntryPayload = {
            action: action === 'start' ? 'start_time' : 'stop_time',
            id_type: taskId,
            type: "tarefa",
            observacao: observation,
            responsavel: userData.nome,
            hora: horaPayload
        };

        if (action === 'stop' && activeTimeEntry) {
            timeEntryPayload.id = activeTimeEntry.id;
            
            // Calcular dura√ß√£o em minutos
            try {
                const minutosCalculados = calculateDurationInMinutes(activeTimeEntry.hora_inicial, horaPayload);
                timeEntryPayload.minutos_trabalhados = minutosCalculados;
                console.log(`üïê Dura√ß√£o calculada: ${minutosCalculados} minutos (${activeTimeEntry.hora_inicial} at√© ${horaPayload})`);
            } catch (error) {
                console.error('‚ùå Erro ao calcular minutos:', error);
                timeEntryPayload.minutos_trabalhados = 0;
            }
            
            console.log(`üîç Finalizando registro espec√≠fico ID: ${activeTimeEntry.id}`, activeTimeEntry);
        } else if (action === 'stop' && !activeTimeEntry) {
            console.error('‚ö†Ô∏è ERRO: Tentativa de finalizar sem activeTimeEntry definido!');
            UI.showNotification('Erro: Nenhum registro ativo encontrado para finalizar.', 'error');
            return;
        }

        try {
            console.log("üì§ Enviando dados para o webhook:", JSON.stringify(timeEntryPayload, null, 2));
            const response = await fetch('https://n8n.dev.resolvrisk.com.br/webhook/salvatarefas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(timeEntryPayload)
            });

            if (response.ok) {
                UI.showNotification(`A√ß√£o de ${action === 'start' ? 'in√≠cio' : 'fim'} registrada com sucesso!`, 'success');
                setTimeout(async () => {
                    await loadAndDisplayTimeEntries(taskId);
                }, 4000); 
            } else {
                const errorText = await response.text();
                throw new Error(`Falha ao registrar a a√ß√£o de tempo: ${errorText}`);
            }
        } catch (error) {
            console.error('Erro na a√ß√£o de tempo:', error);
            UI.showNotification('Erro ao processar sua solicita√ß√£o.', 'error');
        }
    }


    async function loadAndDisplayTimeEntries(taskId) {
        const container = document.getElementById('timeEntriesTableContainer');
        const actionBtnContainer = document.getElementById('timeActionButtons');
        container.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        activeTimeEntry = null;

        // Verificar se a tarefa est√° conclu√≠da (apenas status CONCLU√çDO)
        const task = tasks.find(t => String(t.id) === String(taskId));
        const isTaskCompleted = task && task.status === 'CONCLU√çDO';
        const disabledAttr = isTaskCompleted ? 'disabled' : '';
        const disabledClass = isTaskCompleted ? 'disabled' : '';

        try {
            const response = await fetch(`https://n8n.dev.resolvrisk.com.br/webhook/consultadontrolehoras?id_type=${taskId}`);
            if (!response.ok) throw new Error('Falha ao buscar registros de tempo');
            
            const entries = await response.json();
            const taskEntries = Array.isArray(entries) ? entries.filter(e => String(e.id_type) === String(taskId)) : [];

            if (taskEntries.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Nenhum registro de horas para esta tarefa.</p>';
                actionBtnContainer.innerHTML = `
                    <button class="btn btn-success ${disabledClass}" id="startAutomaticBtn" data-task-id="${taskId}" ${disabledAttr}>In√≠cio Autom√°tico</button>
                    <button class="btn btn-secondary ${disabledClass}" id="startManualBtn" data-task-id="${taskId}" ${disabledAttr}>In√≠cio Manual</button>
                `;
                return;
            }

            let tableHtml = `
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>In√≠cio</th>
                            <th>Fim</th>
                            <th>Dura√ß√£o (min)</th>
                            <th>Observa√ß√£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let hasOpenEntry = false;
            let openEntries = [];
            
            // Identificar e listar todos os registros em aberto ANTES da ordena√ß√£o
            taskEntries.forEach(entry => {
                if (!entry.hora_final) {
                    openEntries.push(entry);
                }
            });

            // Log para debug: verificar se h√° m√∫ltiplos registros em aberto
            console.log(`üìä Registros em aberto encontrados: ${openEntries.length}`, openEntries);

            // Definir o activeTimeEntry como o mais recente dos registros em aberto
            if (openEntries.length > 0) {
                // Ordenar registros em aberto por data decrescente e pegar o primeiro (mais recente)
                openEntries.sort((a, b) => {
                    const dateA = new Date(a.hora_inicial || 0);
                    const dateB = new Date(b.hora_inicial || 0);
                    return dateB - dateA;
                });
                
                activeTimeEntry = openEntries[0];
                hasOpenEntry = true;
                
                console.log('üéØ ActiveTimeEntry definido:', activeTimeEntry);
                
                // Se h√° m√∫ltiplos registros em aberto, alertar
                if (openEntries.length > 1) {
                    console.warn(`‚ö†Ô∏è ATEN√á√ÉO: ${openEntries.length} registros em aberto simultaneamente! Usando o mais recente como ativo.`);
                    UI.showNotification(`‚ö†Ô∏è M√∫ltiplos registros em aberto! Usando o mais recente.`, 'warning');
                }
            } else {
                activeTimeEntry = null;
            }
            
            // Ordenar os registros com prioridade:
            // 1¬∫: Lan√ßamentos em aberto (sem hora_final) no topo
            // 2¬∫: Lan√ßamentos conclu√≠dos em ordem decrescente por data
            taskEntries.sort((a, b) => {
                const aIsOpen = !a.hora_final;
                const bIsOpen = !b.hora_final;
                
                // Se um est√° em aberto e o outro n√£o, priorizar o em aberto
                if (aIsOpen && !bIsOpen) return -1;
                if (!aIsOpen && bIsOpen) return 1;
                
                // Se ambos est√£o em aberto ou ambos est√£o conclu√≠dos, ordenar por data decrescente
                const dateA = new Date(a.hora_inicial || 0);
                const dateB = new Date(b.hora_inicial || 0);
                return dateB - dateA; // Ordem decrescente (mais recente primeiro)
            });
            
            taskEntries.forEach(entry => {
                const startTime = formatDateTimeBrazilian(entry.hora_inicial); 
                const endTime = entry.hora_final ? formatDateTimeBrazilian(entry.hora_final) : '---';
                const duration = entry.hora_final && entry.hora_inicial ? 
                    calculateDurationInMinutes(entry.hora_inicial, entry.hora_final) : '---';
                const statusClass = entry.hora_final ? 'time-entry-completed' : 'time-entry-active';
                const statusText = entry.hora_final ? 'Conclu√≠do' : 'Ativo';

                tableHtml += `
                    <tr>
                        <td>${startTime}</td>
                        <td>${endTime}</td>
                        <td>${duration}</td>
                        <td>${entry.observacao || ''}</td>
                        <td><span class="time-entry-status ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            container.innerHTML = tableHtml;

            if (hasOpenEntry) {
                actionBtnContainer.innerHTML = `
                    <button class="btn btn-danger" id="stopAutomaticBtn" data-task-id="${taskId}">Fim Autom√°tico</button>
                    <button class="btn btn-secondary" id="stopManualBtn" data-task-id="${taskId}">Fim Manual</button>
                `;
            } else {
                actionBtnContainer.innerHTML = `
                    <button class="btn btn-success ${disabledClass}" id="startAutomaticBtn" data-task-id="${taskId}" ${disabledAttr}>In√≠cio Autom√°tico</button>
                    <button class="btn btn-secondary ${disabledClass}" id="startManualBtn" data-task-id="${taskId}" ${disabledAttr}>In√≠cio Manual</button>
                `;
            }

        } catch (error) {
            console.error(error);
            container.innerHTML = '<p class="text-danger text-center">Erro ao carregar registros.</p>';
        }
    }
    
    function showFullResume(text) {
        document.getElementById('fullResumeText').textContent = text;
        new bootstrap.Modal(document.getElementById('resumeModal')).show();
    }
    
    async function openTimeControlModal(taskId) {
        console.log("Abrindo modal para tarefa:", taskId);
        const task = tasks.find(t => String(t.id) === String(taskId));
        if (!task) {
            UI.showNotification('Tarefa n√£o encontrada!', 'error');
            return;
        }

        document.getElementById('timeControlTaskId').textContent = taskId;
        document.getElementById('timeControlTaskDescription').textContent = task.description;
        document.getElementById('timeControlTaskResponsible').textContent = task.responsible;
        document.getElementById('timeControlTaskProject').textContent = task.project;
        
        document.getElementById('timeControlObservation').value = '';
        document.getElementById('timeControlObservationSection').style.display = 'block';

        await loadAndDisplayTimeEntries(taskId);

        const timeControlModal = new bootstrap.Modal(document.getElementById('timeControlModal'));
        timeControlModal.show();
    }


    document.addEventListener('DOMContentLoaded', async () => {
        // ===================================
        // CONSTANTES DA APLICA√á√ÉO
        // ===================================
        const CONFIG_WEBHOOK_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consultaconfiguracoes';
        const WEBHOOK_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/salvatarefas';
        const WEBHOOK_GET_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consultadadosresolv';
        const COLABORADORES_WEBHOOK_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consultacolaboradores';
        const TIME_ENTRIES_GET_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consultadontrolehoras';
        const TASK_TYPES_GET_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consulta_tarefas';
        const NEW_TASK_TYPE_POST_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';
        const CLIENTS_GET_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consulta_clientes';
        const NEW_CLIENT_POST_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';
        const COMPANIES_GET_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consulta_empresa';


        const TASK_STATUSES = ["N√ÉO INICIADO", "EM ANDAMENTO", "CONCLU√çDO", "PARALIZADO"];

        // ===================================
        // L√ìGICA PRINCIPAL DA APLICA√á√ÉO
        // ===================================
        async function initializeApplication() {
            console.log('üöÄ Iniciando l√≥gica principal da aplica√ß√£o...');
            try {
                await loadThemeConfig();
                await loadTaskTypes();
                await loadClients();
                await loadCompanies();
                populateDropdowns();
                clearForm();
                await loadColaboradores();
                await loadTasks();
                await loadAllTimeEntriesAndApplyStatus();
                console.log('‚úÖ L√≥gica da aplica√ß√£o inicializada com sucesso');
            } catch (error) {
                console.error('‚ùå Erro durante inicializa√ß√£o da l√≥gica:', error);
                UI.showNotification('‚ùå Erro ao carregar dados da aplica√ß√£o.', 'error');
            }
        }

        function populateDropdowns() {
            populateTaskTypeDropdowns();
            populateClientDropdowns();
            populateCompanyDropdowns();
            populateStatusDropdowns();
        }

        function populateTaskTypeDropdowns() {
            const taskTypeSelect = document.getElementById('taskType');
            const filterTaskTypeSelect = document.getElementById('filterTaskType');
            taskTypeSelect.innerHTML = '';
            filterTaskTypeSelect.innerHTML = '<option value="">Todos</option>';
            taskTypes.forEach(type => {
                taskTypeSelect.add(new Option(type.tipo_tarefa, type.tipo_tarefa));
                filterTaskTypeSelect.add(new Option(type.tipo_tarefa, type.tipo_tarefa));
            });
        }

        function populateClientDropdowns() {
            const clientSelect = document.getElementById('client');
            const filterClientSelect = document.getElementById('filterClient');
            clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
            filterClientSelect.innerHTML = '<option value="">Todos</option>';
            clients.forEach(client => {
                clientSelect.add(new Option(client.nome, client.nome));
                filterClientSelect.add(new Option(client.nome, client.nome));
            });
        }

        function populateCompanyDropdowns() {
            const companySelect = document.getElementById('company');
            const filterCompanySelect = document.getElementById('filterCompany');
            companySelect.innerHTML = '<option value="">Selecione uma empresa</option>';
            filterCompanySelect.innerHTML = '<option value="">Todas</option>';
            companies.forEach(company => {
                companySelect.add(new Option(company.razao_social, company.razao_social));
                filterCompanySelect.add(new Option(company.razao_social, company.razao_social));
            });
        }

        function populateStatusDropdowns() {
            const statusSelect = document.getElementById('status');
            const filterStatusSelect = document.getElementById('filterStatus');
            statusSelect.innerHTML = '';
            filterStatusSelect.innerHTML = '<option value="">Todos</option>';
            TASK_STATUSES.forEach(status => {
                statusSelect.add(new Option(status, status));
                filterStatusSelect.add(new Option(status, status));
            });
        }

        function clearForm() {
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            editingTaskId = null;
            document.getElementById('taskForm').classList.remove('was-validated');
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('status').value = 'N√ÉO INICIADO';

            document.getElementById('saveTaskBtn').innerHTML = '<i class="fas fa-save me-2"></i>Adicionar Tarefa';
            document.getElementById('formTitle').textContent = 'Adicionar Nova Tarefa';

            calculateDeviation();
            UI.applyUIPermissions();
            
            // Reabilitar o bot√£o de toggle ao limpar o formul√°rio
            document.querySelector('[data-bs-target="#formCollapse"]').disabled = false;
        }

        // ===================================
        // MANIPULA√á√ÉO DE DADOS (FETCH, SAVE)
        // ===================================
        async function loadThemeConfig() {
           try {
               console.log('üé® Carregando configura√ß√µes de tema...');
               const response = await fetch(CONFIG_WEBHOOK_URL);
               if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

               const data = await response.json();
               if (data && data.length > 0 && data[0].primary_color) {
                   const primaryColor = data[0].primary_color;
                   applyPrimaryColor(primaryColor);
                   console.log(`‚úÖ Cor prim√°ria aplicada: ${primaryColor}`);
               } else {
                   console.log('‚ö†Ô∏è Usando cor prim√°ria padr√£o');
               }
           } catch (error) {
               console.error('‚ùå Erro ao carregar configura√ß√µes de tema:', error);
               console.log('‚ö†Ô∏è Usando cor prim√°ria padr√£o');
           }
        }

        function applyPrimaryColor(color) {
           document.documentElement.style.setProperty('--primary-color', color);
           const dynamicStyles = document.createElement('style');
           dynamicStyles.innerHTML = `
               .btn-outline-primary { color: ${color}; border-color: ${color}; }
               .btn-outline-primary:hover { background-color: ${color}; border-color: ${color}; color: white; }
               .text-primary { color: ${color} !important; }
               .form-control:focus, .form-select:focus { border-color: ${color}; box-shadow: 0 0 0 0.2rem ${hexToRgba(color, 0.25)}; }
           `;
           document.head.appendChild(dynamicStyles);
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }


        async function loadColaboradores() {
            try {
                console.log('üîÑ Carregando colaboradores...');
                const response = await fetch(COLABORADORES_WEBHOOK_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                colaboradores = data.filter(c => c.status === true);
                console.log(`‚úÖ ${colaboradores.length} colaboradores ativos carregados.`);
                updateResponsibleSelect();
            } catch (error) {
                console.error('‚ùå Erro ao carregar colaboradores:', error);
                UI.showNotification(`‚ùå Erro ao carregar colaboradores.`, 'error');
            }
        }

        async function loadClients() {
            try {
                console.log('üîÑ Carregando clientes...');
                const response = await fetch(CLIENTS_GET_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                clients = await response.json();
                console.log(`‚úÖ ${clients.length} clientes carregados.`);
                populateClientDropdowns();
            } catch (error) {
                console.error('‚ùå Erro ao carregar clientes:', error);
                UI.showNotification('‚ùå Erro ao carregar clientes.', 'error');
            }
        }

        async function loadCompanies() {
            try {
                console.log('üîÑ Carregando empresas...');
                const response = await fetch(COMPANIES_GET_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                companies = await response.json();
                console.log(`‚úÖ ${companies.length} empresas carregadas.`);
                populateCompanyDropdowns();
            } catch (error) {
                console.error('‚ùå Erro ao carregar empresas:', error);
                UI.showNotification('‚ùå Erro ao carregar empresas.', 'error');
            }
        }

        async function loadTaskTypes() {
            try {
                console.log('üîÑ Carregando tipos de tarefa...');
                const response = await fetch(TASK_TYPES_GET_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                taskTypes = await response.json();
                console.log(`‚úÖ ${taskTypes.length} tipos de tarefa carregados.`);
                populateTaskTypeDropdowns();
            } catch (error) {
                console.error('‚ùå Erro ao carregar tipos de tarefa:', error);
                UI.showNotification('‚ùå Erro ao carregar tipos de tarefa.', 'error');
            }
        }

        function updateResponsibleSelect() {
            const selects = [document.getElementById('responsible'), document.getElementById('filterResponsible')];
            selects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = select.id.includes('filter') ? '<option value="">Todos</option>' : '<option value="">Selecione um respons√°vel</option>';
                colaboradores.forEach(c => select.add(new Option(c.nome, c.nome)));
                select.value = currentVal;
            });
        }

        async function loadTasks() {
          try {
              console.log('üîÑ Carregando tarefas...');
              UI.showNotification('üîÑ Carregando tarefas do servidor...', 'info');
              const response = await fetch(WEBHOOK_GET_URL);
              if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              const data = await response.json();

              tasks = data.map(task => ({
                  ...task,
                  endDate: task.EndDate || '',
                  startDate: task.startDate || '',
                  completionDate: task.completionDate || '',
                  estimatedHours: parseDecimalInput(task.estimatedHours),
                  actualHours: parseDecimalInput(task.actualHours),
                  deviation: parseDecimalInput(task.deviation)
              }));

              console.log(`‚úÖ ${tasks.length} tarefas processadas e carregadas.`);
              UI.showNotification('‚úÖ Tarefas carregadas com sucesso!', 'success');

              updateTaskTables();

          } catch (error) {
              console.error('‚ùå Erro ao carregar tarefas:', error);
              UI.showNotification(`‚ùå Erro ao carregar tarefas: ${error.message}.`, 'error');
              tasks = [];
              updateTaskTables();
          }
        }

        function updateTaskTables() {
            const approvedTasks = tasks.filter(t => t.aguadando_aprovacao === null || t.aguadando_aprovacao === true || t.aguadando_aprovacao === 'true');
            let pendingTasks = tasks.filter(t => t.aguadando_aprovacao === false || t.aguadando_aprovacao === 'false' || t.aguadando_aprovacao === 'Aguardando');
            const canceledTasks = tasks.filter(t => t.aguadando_aprovacao === 'canceled');
            const currentUser = Auth.getUserData();

            updateApprovedTaskTable(approvedTasks);
            updatePendingTaskTable(pendingTasks, canceledTasks);

            if (currentUser.tipo === 'colaborador') {
                const userPendingTasks = pendingTasks.filter(t => t.responsible === currentUser.nome);
                document.getElementById('pending-count').textContent = userPendingTasks.length;
            } else {
                document.getElementById('pending-count').textContent = pendingTasks.length;
            }
        }

        function updateApprovedTaskTable(filteredData) {
            if ($.fn.DataTable.isDataTable('#taskTableApproved')) {
                $('#taskTableApproved').DataTable().destroy();
            }

            const tableBody = document.querySelector('#taskTableApproved tbody');
            tableBody.innerHTML = '';
            const currentUser = Auth.getUserData();

            filteredData.forEach(task => {
                const taskIdStr = String(task.id);
                const isTaskOpen = openTaskIds.has(taskIdStr);
                const hasCompletedHours = completedTaskIds.has(taskIdStr);

                let buttonClass = isTaskOpen ? 'btn-danger' : (hasCompletedHours ? 'btn-success' : 'btn-info');
                let buttonText = isTaskOpen ? 'Em Andamento' : 'Adicionar';
                const buttonTitle = isTaskOpen ? 'Tarefa com tempo em aberto!' : 'Controle de Horas';
                const timeControlBtn = `<button class="btn btn-sm ${buttonClass} time-control-btn" data-task-id="${task.id}" title="${buttonTitle}"><i class="fas fa-clock"></i> ${buttonText}</button>`;

                const isOwner = currentUser.nome === task.responsible;
                const isAdmin = currentUser.tipo === 'admin';
                let actionsHtml = '';
                if (isAdmin) {
                    actionsHtml = `
                        <button class="btn btn-sm btn-primary edit-btn" data-id="${task.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${task.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                    `;
                } else if (isOwner) {
                    actionsHtml = `<button class="btn btn-sm btn-primary edit-btn" data-id="${task.id}" title="Editar"><i class="fas fa-edit"></i></button>`;
                } else {
                    actionsHtml = `<button class="btn btn-sm btn-primary edit-btn" data-id="${task.id}" title="Editar" disabled><i class="fas fa-edit"></i></button>`;
                }

                const deviation = (task.actualHours || 0) - (task.estimatedHours || 0);
                const deviationClass = deviation > 0 ? 'positive-deviation' : (deviation < 0 ? 'negative-deviation' : '');
                const statusClass = `status-${(task.status || '').toLowerCase().replace(/\s+/g, '-').replace(/√£|√∫|√≠/g, a => ({'√£':'a', '√∫':'u', '√≠': 'i'}[a]))}`;
                const truncatedDesc = truncateResume(task.description);
                const isClickable = task.description && task.description.length > 18;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.id || ''}</td>
                    <td>${timeControlBtn}</td>
                    <td>${task.type || ''}</td>
                    <td ${isClickable ? `data-full-resume="${(task.description || '').replace(/"/g, "&quot;")}" class="resume-truncated"` : ''}>${truncatedDesc}</td>
                    <td>${task.project || ''}</td>
                    <td>${task.client || ''}</td>
                    <td>${task.company || ''}</td>
                    <td>${task.responsible || ''}</td>
                    <td>${formatDate(task.startDate)}</td>
                    <td>${formatDate(task.endDate)}</td>
                    <td>${formatDate(task.completionDate)}</td>
                    <td>${formatDecimalOutput(task.estimatedHours)}</td>
                    <td>${formatDecimalOutput(task.actualHours)}</td>
                    <td class="${deviationClass}">${formatDecimalOutput(deviation)}</td>
                    <td><span class="status-badge ${statusClass}">${task.status || ''}</span></td>
                    <td>${actionsHtml}</td>
                `;
                tableBody.appendChild(row);
            });
            
            dataTableApproved = $('#taskTableApproved').DataTable({
                language: { url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json' },
                responsive: true,
                order: [[0, 'desc']],
                columnDefs: [{ orderable: false, targets: [1, 15] }],
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            });
            updateFilters(filteredData);
        }

        function updatePendingTaskTable(pendingData, canceledData) {
            const currentUser = Auth.getUserData();
            const filterValue = document.getElementById('filterPendingStatus').value;
            let dataToShow = (filterValue === 'false') ? pendingData : canceledData;
            
            if (currentUser.tipo === 'colaborador') {
                dataToShow = dataToShow.filter(t => t.responsible === currentUser.nome);
            }

            if ($.fn.DataTable.isDataTable('#taskTablePending')) {
                $('#taskTablePending').DataTable().destroy();
            }

            const tableBody = document.querySelector('#taskTablePending tbody');
            tableBody.innerHTML = '';

            dataToShow.forEach(task => {
                const row = document.createElement('tr');
                const truncatedDesc = truncateResume(task.description);
                const isClickable = task.description && task.description.length > 18;
                const resumeTd = `<td ${isClickable ? `data-full-resume="${(task.description || '').replace(/"/g, "&quot;")}" class="resume-truncated"` : ''}>${truncatedDesc}</td>`;
                const isColaborador = currentUser.tipo === 'colaborador';
                const activateButtonDisabled = isColaborador ? 'disabled' : '';

                let statusApprovalHtml, actionsHtml, motivoRecusaHtml;
                if (task.aguadando_aprovacao === 'canceled') {
                    statusApprovalHtml = `<span class="badge bg-danger">Cancelado</span>`;
                    actionsHtml = `<button class="btn btn-sm btn-secondary view-btn" data-id="${task.id}" title="Visualizar Motivo"><i class="fas fa-eye"></i></button>`;
                    motivoRecusaHtml = task.motivo_recusa || 'N/A';
                } else {  
                    statusApprovalHtml = `<span class="badge bg-warning text-dark">Aguardando Aprova√ß√£o</span>`;
                    actionsHtml = `<button class="btn btn-sm btn-primary activate-btn" data-id="${task.id}" title="Ativar Tarefa" ${activateButtonDisabled}><i class="fas fa-play"></i> Ativar</button>`;
                    motivoRecusaHtml = '';  
                }

                row.innerHTML = `
                    <td>${task.id || ''}</td>
                    <td>${task.type || ''}</td>
                    ${resumeTd}
                    <td>${task.project || ''}</td>
                    <td>${task.responsible || ''}</td>
                    <td>${formatDate(task.startDate)}</td>
                    <td>${formatDecimalOutput(task.estimatedHours)}</td>
                    <td>${statusApprovalHtml}</td>
                    <td>${motivoRecusaHtml}</td>
                    <td>${actionsHtml}</td>
                `;
                tableBody.appendChild(row);
            });
            
            dataTablePending = $('#taskTablePending').DataTable({
                language: { url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json' },
                responsive: true,
                order: [[0, 'desc']],
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            });
        }


        async function loadAllTimeEntriesAndApplyStatus() {
            try {
                console.log('üîÑ Buscando status de todas as entradas de tempo...');
                const response = await fetch(TIME_ENTRIES_GET_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new TypeError("A resposta n√£o √© um JSON. A sess√£o pode ter expirado.");
                }

                const allEntries = await response.json();
                if (!Array.isArray(allEntries)) return;

                openTaskIds.clear();
                completedTaskIds.clear();

                const entriesByTask = {};
                allEntries.forEach(entry => {
                    if (entry && entry.id_type) {
                        const taskId = String(entry.id_type);
                        if (!entriesByTask[taskId]) {
                            entriesByTask[taskId] = [];
                        }
                        entriesByTask[taskId].push(entry);
                    }
                });

                Object.keys(entriesByTask).forEach(taskId => {
                    const taskEntries = entriesByTask[taskId];
                    const hasOpenEntry = taskEntries.some(e => e.hora_final === null);
                    const hasCompletedEntries = taskEntries.some(e => e.hora_final !== null);

                    if (hasOpenEntry) {
                        openTaskIds.add(taskId);
                    } else if (hasCompletedEntries) {
                        completedTaskIds.add(taskId);
                    }
                });

                console.log('‚úÖ Status de tempo processado. Tarefas em aberto:', openTaskIds);
                console.log('‚úÖ Tarefas com horas completas:', completedTaskIds);
                updateTaskTables();

            } catch (error) {
                console.error('‚ùå Erro ao buscar todos os registros de tempo:', error);
                UI.showNotification('Erro ao buscar registros de tempo. Tente recarregar a p√°gina.', 'error');
            }
        }

        async function sendToWebhook(data, action) {
            try {
                const payload = {
                    ...data,
                    action,
                    timestamp: new Date().toISOString()
                };

                console.log('üì° Enviando para webhook:', payload);
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    console.log(`‚úÖ Webhook [${action}] bem-sucedido para tarefa ${data.id}.`);
                    return { success: true };
                } else {
                    const responseText = await response.text();
                    console.error(`‚ùå Webhook [${action}] respondeu com status ${response.status}. Resposta: ${responseText}`);
                    return { success: false, error: `Erro do servidor (Status ${response.status})`, message: responseText };
                }
            } catch (error) {
                console.error(`‚ùå Erro ao enviar para webhook [${action}]:`, error);
                return { success: false, error: 'Erro de rede', message: error.message };
            }
        }

        function updateFilters(currentData = tasks) {
            const projectFilter = document.getElementById('filterProject');
            const clientFilter = document.getElementById('filterClient');
            const companyFilter = document.getElementById('filterCompany');

            const selectedProject = projectFilter.value;
            const selectedClient = clientFilter.value;
            const selectedCompany = companyFilter.value;

            const projects = [...new Set(currentData.map(t => t.project).filter(p => p))].sort();
            projectFilter.innerHTML = '<option value="">Todos</option>';
            projects.forEach(p => {
                const option = new Option(p, p);
                projectFilter.add(option);
            });
            if (projects.includes(selectedProject)) projectFilter.value = selectedProject;

            const clients = [...new Set(currentData.map(t => t.client).filter(c => c))].sort();
            clientFilter.innerHTML = '<option value="">Todos</option>';
            clients.forEach(c => {
                const option = new Option(c, c);
                clientFilter.add(option);
            });
            if (clients.includes(selectedClient)) clientFilter.value = selectedClient;

            const companies = [...new Set(currentData.map(t => t.company).filter(c => c))].sort();
            companyFilter.innerHTML = '<option value="">Todos</option>';
            companies.forEach(c => {
                const option = new Option(c, c);
                companyFilter.add(option);
            });
            if (companies.includes(selectedCompany)) companyFilter.value = selectedCompany;
        }

        function getDailyHoursForCollaborator(responsible, dateStr, excludeTaskId = null) {
          let totalHours = 0;
          const targetDate = parseDate(dateStr);
          if (!targetDate) return 0;
          const targetDateStr = targetDate.toISOString().split('T')[0];

          for (const task of tasks) {
              if (task.responsible === responsible && task.id != excludeTaskId) {
                  const taskStartDate = parseDate(task.startDate);
                  if (taskStartDate) {
                      const taskStartDateStr = taskStartDate.toISOString().split('T')[0];
                      if (taskStartDateStr === targetDateStr) {
                          totalHours += parseFloat(task.estimatedHours) || 0;
                      }
                  }
              }
          }
          return totalHours;
        }

        function splitTaskByHourLimit(baseTask, startDateStr, totalHoursToAllocate) {
            const newTasks = [];
            let remainingHours = totalHoursToAllocate;
            let currentDate = new Date(startDateStr + 'T00:00:00'); // Ensure it's parsed as local time
            if (isNaN(currentDate.getTime())) {
                UI.showNotification("Data de in√≠cio inv√°lida.", "error");
                return [];
            }

            globalEndDate = document.getElementById('endDate').value;
            const baseTimestamp = Date.now();

            console.log('‚úÖ Deadline da tarefa capturada para consolida√ß√£o:', globalEndDate);

            while (remainingHours > 0) {
                const currentDateStr = currentDate.toISOString().split('T')[0];
                const allocatedHours = getDailyHoursForCollaborator(baseTask.responsible, currentDateStr, null);
                const availableHours = Math.max(0, 8 - allocatedHours);

                if (availableHours > 0) {
                    const hoursForThisDay = Math.min(remainingHours, availableHours);

                    const newTask = {
                        ...baseTask,
                        id: `new_${baseTimestamp}_${newTasks.length}`,
                        startDate: currentDateStr,
                        endDate: globalEndDate,
                        estimatedHours: hoursForThisDay,
                        actualHours: 0,
                        deviation: -hoursForThisDay,
                        completionDate: '',
                    };

                    newTasks.push(newTask);
                    remainingHours -= hoursForThisDay;
                }

                currentDate.setDate(currentDate.getDate() + 1);

                if (newTasks.length > 365) {
                    console.error("Task splitting loop exceeded 365 iterations. Aborting.");
                    UI.showNotification("Erro: N√£o foi poss√≠vel alocar todas as horas da tarefa. Verifique a disponibilidade.", "error");
                    return [];
                }
            }

            console.log(`‚úÖ ${newTasks.length} tarefas criadas. Per√≠odo de trabalho: ${newTasks[0].startDate} at√© ${newTasks[newTasks.length - 1].startDate}. Deadline: ${globalEndDate}`);
            return newTasks;
        }
        
        function parseDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            // Parse date without timezone manipulations
            const parts = dateString.split('-');
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        // ===================================
        // SETUP DOS EVENT LISTENERS
        // ===================================
        function setupEventListeners() {
            document.getElementById('logoutButton').addEventListener('click', Auth.logout);
            document.getElementById('sidebarToggle').addEventListener('click', UI.toggleSidebar);
            if(document.getElementById('sidebarOverlay')) {
                document.getElementById('sidebarOverlay').addEventListener('click', UI.toggleSidebar);
            }
            
            document.getElementById('estimatedHours').addEventListener('input', calculateDeviation);
            document.getElementById('actualHours').addEventListener('input', calculateDeviation);


            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (!this.checkValidity()) {
                    UI.showNotification('Por favor, preencha todos os campos obrigat√≥rios.', 'warning');
                    this.classList.add('was-validated');
                    return;
                }

                const completionDateVal = document.getElementById('completionDate').value;
                const startDateVal = document.getElementById('startDate').value;
                if (completionDateVal && startDateVal && completionDateVal < startDateVal) {
                    UI.showNotification('A "Data de Finaliza√ß√£o" n√£o pode ser anterior √† "Data In√≠cio".', 'error');
                    document.getElementById('completionDate').classList.add('is-invalid');
                    return;
                }
                document.getElementById('completionDate').classList.remove('is-invalid');

                const isEditing = !!editingTaskId;

                if (isEditing) {
                    const deviation = parseDecimalInput(document.getElementById('actualHours').value) - parseDecimalInput(document.getElementById('estimatedHours').value);
                    const userData = Auth.getUserData();

                    tempTasksData = [{
                        id: editingTaskId,
                        type: document.getElementById('taskType').value,
                        description: document.getElementById('taskDescription').value,
                        project: document.getElementById('project').value,
                        client: document.getElementById('client').value,
                        company: document.getElementById('company').value,
                        responsible: document.getElementById('responsible').value,
                        startDate: document.getElementById('startDate').value,
                        endDate: document.getElementById('endDate').value,
                        completionDate: completionDateVal,
                        estimatedHours: parseDecimalInput(document.getElementById('estimatedHours').value),
                        actualHours: parseDecimalInput(document.getElementById('actualHours').value),
                        deviation: deviation,
                        status: document.getElementById('status').value,
                        modificadoPor: userData.nome,
                        modificadoPorTipo: userData.tipo
                    }];
                } else {
                    const commonTaskData = {
                        type: document.getElementById('taskType').value,
                        description: document.getElementById('taskDescription').value,
                        project: document.getElementById('project').value,
                        client: document.getElementById('client').value,
                        company: document.getElementById('company').value,
                        responsible: document.getElementById('responsible').value,
                        status: 'N√ÉO INICIADO',
                    };
                    const estimatedHours = parseDecimalInput(document.getElementById('estimatedHours').value);

                    console.log('üî¢ Criando tarefas:', estimatedHours, 'horas para', commonTaskData.responsible);

                    tempTasksData = splitTaskByHourLimit(commonTaskData, document.getElementById('startDate').value, estimatedHours);
                }

                if (!tempTasksData || tempTasksData.length === 0) {
                    UI.showNotification('N√£o h√° horas dispon√≠veis nas datas selecionadas para alocar a tarefa.', 'error');
                    return;
                }

                console.log('üìã Criadas', tempTasksData.length, 'tarefas para exibi√ß√£o no modal');

                fillConfirmationModal(tempTasksData);
                new bootstrap.Modal(document.getElementById('confirmTaskModal')).show();
            });

            document.getElementById('clearFormBtn').addEventListener('click', clearForm);
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);

            $('#taskTableApproved').on('click', '.edit-btn', function() {
                const taskId = $(this).data('id');
                const taskToEdit = tasks.find(t => t.id == taskId);
                if (taskToEdit) fillFormWithTask(taskToEdit);
            });

            $('#taskTableApproved').on('click', '.delete-btn', function() {
                const taskId = $(this).data('id');
                document.getElementById('confirmDeleteBtn').dataset.id = taskId;
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            });

            $('#taskTableApproved').on('click', '.time-control-btn', function() {
                const taskId = $(this).data('task-id');
                openTimeControlModal(taskId);
            });

            $('#taskTableApproved').on('click', '.resume-truncated', function() {
                const fullResume = $(this).data('full-resume');
                showFullResume(fullResume);
            });
            
            $('#taskTablePending').on('click', '.resume-truncated', function() {
                const fullResume = $(this).data('full-resume');
                showFullResume(fullResume);
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
                const taskId = this.dataset.id;
                const webhookResult = await sendToWebhook({ id: taskId }, 'delete');

                if (webhookResult.success) {
                    tasks = tasks.filter(t => t.id != taskId);
                    updateTaskTables();
                    UI.showNotification(`‚úÖ Tarefa ID ${taskId} exclu√≠da!`, 'success');
                    await reloadTaskDataAfterOperation('exclus√£o');
                } else {
                    UI.showNotification(`‚ùå Falha ao excluir tarefa. ${webhookResult.error}: ${webhookResult.message}`, 'error');
                }
                bootstrap.Modal.getInstance(document.getElementById('deleteModal'))?.hide();
            });
            
            document.getElementById('confirmTaskBtn').addEventListener('click', async function() {
                bootstrap.Modal.getInstance(document.getElementById('confirmTaskModal'))?.hide();

                const isEditing = !!editingTaskId;
                const action = isEditing ? 'update' : 'create';
                let webhookResult;

                if (isEditing) {
                    const taskToUpdate = tempTasksData[0];
                    webhookResult = await sendToWebhook(taskToUpdate, action);

                    if (webhookResult.success) {
                        const index = tasks.findIndex(t => t.id == editingTaskId);
                        if (index !== -1) {
                            tasks[index] = taskToUpdate;
                        }
                        UI.showNotification(`‚úÖ Tarefa atualizada com sucesso! Recarregando dados...`, 'success');
                        await reloadTaskDataAfterOperation('atualiza√ß√£o');
                    } else {
                        const errorMessage = `‚ùå Falha ao atualizar tarefa. ${webhookResult.error || ''}: ${webhookResult.message || ''}`;
                        UI.showNotification(errorMessage, 'error', 10000);
                    }
                } else {
                    console.log('üì° Enviando tarefa consolidada com detalhes baseada em', tempTasksData.length, 'divis√µes');

                    const totalHours = tempTasksData.reduce((sum, task) => sum + (task.estimatedHours || 0), 0);
                    const totalDeviation = -totalHours;
                    const firstTaskDate = tempTasksData[0].startDate;
                    const finalPeriodEndDate = tempTasksData[tempTasksData.length - 1].startDate;
                    const userData = Auth.getUserData();

                    const dailyBreakdown = tempTasksData.map(task => ({
                        dataInicio: task.startDate,
                        dataFinal: task.endDate,
                        horasEstimadasInicio: task.estimatedHours,
                        horasEstimadasFinal: task.estimatedHours
                    }))
                    .sort((a, b) => new Date(a.dataInicio) - new Date(b.dataInicio))
                    .map(item => {
                        if (new Date(item.dataFinal) < new Date(item.dataInicio)) {
                            item.dataFinal = item.dataInicio;
                        }
                        return item;
                    });

                    const consolidatedTask = {
                        type: document.getElementById('taskType').value,
                        description: document.getElementById('taskDescription').value,
                        project: document.getElementById('project').value,
                        client: document.getElementById('client').value,
                        company: document.getElementById('company').value,
                        responsible: document.getElementById('responsible').value,
                        status: 'N√ÉO INICIADO',
                        aguadando_aprovacao: false,
                        startDate: firstTaskDate,
                        endDate: finalPeriodEndDate,
                        estimatedHours: totalHours,
                        actualHours: 0,
                        deviation: totalDeviation,
                        completionDate: '',
                        id: `new_${Date.now()}_consolidated`,
                        criadoPor: userData.nome,
                        criadoPorTipo: userData.tipo,
                        data: dailyBreakdown
                    };

                    console.log('üì° Tarefa consolidada com detalhes:', consolidatedTask);
                    webhookResult = await sendToWebhook(consolidatedTask, action);

                    if (webhookResult.success) {
                        UI.showNotification(`‚úÖ Tarefa consolidada adicionada com sucesso! Recarregando dados...`, 'success');
                        await reloadTaskDataAfterOperation('adi√ß√£o');
                    } else {
                        const errorMessage = `‚ùå Falha ao adicionar tarefa consolidada. ${webhookResult.error || ''}`;
                        UI.showNotification(errorMessage, 'error', 10000);
                    }
                }

                clearForm();
                tempTasksData = null;
            });

            document.getElementById('addNewTaskTypeBtn').addEventListener('click', () => {
                new bootstrap.Modal(document.getElementById('newTaskTypeModal')).show();
            });

            document.getElementById('saveNewTaskTypeBtn').addEventListener('click', async () => {
                const newTaskTypeName = document.getElementById('newTaskTypeName').value.toUpperCase().trim();
                if (!newTaskTypeName) {
                    UI.showNotification('O nome do tipo de tarefa n√£o pode estar vazio.', 'warning');
                    return;
                }

                const payload = {
                    action: 'add_nova_tarefa',
                    tipo_tarefa: newTaskTypeName
                };

                try {
                    const response = await fetch(NEW_TASK_TYPE_POST_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        UI.showNotification('Novo tipo de tarefa adicionado com sucesso!', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('newTaskTypeModal')).hide();
                        document.getElementById('newTaskTypeForm').reset();
                        
                        const newType = { tipo_tarefa: newTaskTypeName };
                        taskTypes.push(newType);
                        taskTypes.sort((a, b) => a.tipo_tarefa.localeCompare(b.tipo_tarefa));
                        populateTaskTypeDropdowns();
                        document.getElementById('taskType').value = newTaskTypeName;

                    } else {
                        const errorText = await response.text();
                        UI.showNotification(`Erro ao salvar: ${errorText}`, 'error');
                    }
                } catch (error) {
                    UI.showNotification(`Erro de rede: ${error.message}`, 'error');
                }
            });

            document.getElementById('addNewClientBtn').addEventListener('click', () => {
                new bootstrap.Modal(document.getElementById('newClientModal')).show();
            });

            document.getElementById('saveNewClientBtn').addEventListener('click', async () => {
                const newClientName = document.getElementById('newClientName').value.toUpperCase().trim();
                if (!newClientName) {
                    UI.showNotification('O nome do cliente √© obrigat√≥rio.', 'warning');
                    return;
                }

                const payload = {
                    action: 'add_cliente',
                    nome: newClientName,
                    cnpj: document.getElementById('newClientCnpj').value,
                    email: document.getElementById('newClientEmail').value.toLowerCase(),
                    telefone: document.getElementById('newClientPhone').value,
                    ativo: document.getElementById('newClientActive').checked
                };

                try {
                    const response = await fetch(NEW_CLIENT_POST_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        UI.showNotification('Novo cliente adicionado com sucesso!', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('newClientModal')).hide();
                        document.getElementById('newClientForm').reset();
                        
                        const newClient = { nome: newClientName };
                        clients.push(newClient);
                        clients.sort((a, b) => a.nome.localeCompare(b.nome));
                        populateClientDropdowns();
                        document.getElementById('client').value = newClientName;

                    } else {
                        const errorText = await response.text();
                        UI.showNotification(`Erro ao salvar cliente: ${errorText}`, 'error');
                    }
                } catch (error) {
                    UI.showNotification(`Erro de rede: ${error.message}`, 'error');
                }
            });

            window.addEventListener('resize', () => {
                setTimeout(() => {
                    try {
                        if ($.fn.DataTable.isDataTable('#taskTableApproved') && $('#taskTableApproved').is(':visible')) {
                             $('#taskTableApproved').DataTable().columns.adjust().responsive.recalc();
                        }
                        if ($.fn.DataTable.isDataTable('#taskTablePending') && $('#taskTablePending').is(':visible')) {
                             $('#taskTablePending').DataTable().columns.adjust().responsive.recalc();
                        }
                    } catch(e) {
                        console.error("Error recalculating datatable:", e);
                    }
                }, 300);
            });
            
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', () => {
                     try {
                        if ($.fn.DataTable.isDataTable('#taskTableApproved')) {
                            $('#taskTableApproved').DataTable().columns.adjust().responsive.recalc();
                        }
                         if ($.fn.DataTable.isDataTable('#taskTablePending')) {
                            $('#taskTablePending').DataTable().columns.adjust().responsive.recalc();
                        }
                    } catch(e) {
                        console.error("Error recalculating datatable on tab change:", e);
                    }
                });
            });

            document.getElementById('filterPendingStatus').addEventListener('change', () => {
                updateTaskTables();
            });

            $('#taskTablePending').on('click', '.activate-btn', function() {
                const taskId = $(this).data('id');
                const task = tasks.find(t => t.id == taskId);
                openApprovalActionModal(task);
            });
            
            document.getElementById('showCancelReasonBtn').addEventListener('click', () => {
                document.getElementById('initialButtons').style.display = 'none';
                document.getElementById('cancelReasonSection').style.display = 'block';
                document.getElementById('confirmCancelButtons').style.display = 'block';
            });

            document.getElementById('backToOptionsBtn').addEventListener('click', () => {
                document.getElementById('initialButtons').style.display = 'block';
                document.getElementById('cancelReasonSection').style.display = 'none';
                document.getElementById('confirmCancelButtons').style.display = 'none';
            });

            document.getElementById('confirmApproveBtn').addEventListener('click', async function() {
                const taskId = this.dataset.id;
                const task = tasks.find(t => t.id == taskId);
                const webhookResult = await sendToWebhook({ ...task, aguadando_aprovacao: true }, 'status_task_true');

                 if (webhookResult.success) {
                      UI.showNotification(`‚úÖ Tarefa ID ${taskId} aprovada!`, 'success');
                      await reloadTaskDataAfterOperation('aprova√ß√£o');
                 } else {
                      UI.showNotification(`‚ùå Falha ao aprovar tarefa.`, 'error');
                 }
                 bootstrap.Modal.getInstance(document.getElementById('approvalActionModal')).hide();
            });

            document.getElementById('confirmCancelBtn').addEventListener('click', async function() {
                const taskId = this.dataset.id;
                const reason = document.getElementById('cancelReason').value;
                if (!reason.trim()) {
                    UI.showNotification('O motivo do cancelamento √© obrigat√≥rio.', 'warning');
                    return;
                }

                const task = tasks.find(t => t.id == taskId);
                const payload = { ...task, aguadando_aprovacao: 'canceled', motivo_recusa: reason };
                const webhookResult = await sendToWebhook(payload, 'status_task_false');

                if (webhookResult.success) {
                    UI.showNotification(`‚úÖ Tarefa ID ${taskId} cancelada!`, 'success');
                    await reloadTaskDataAfterOperation('cancelamento');
                } else {
                    UI.showNotification(`‚ùå Falha ao cancelar tarefa.`, 'error');
                }
                bootstrap.Modal.getInstance(document.getElementById('approvalActionModal')).hide();
            });
        }

        function fillFormWithTask(task) {
            editingTaskId = task.id;
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskType').value = task.type;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('project').value = task.project;
            document.getElementById('client').value = task.client || '';
            document.getElementById('company').value = task.company || '';
            document.getElementById('responsible').value = task.responsible;
            document.getElementById('startDate').value = task.startDate;
            document.getElementById('endDate').value = task.endDate;
            document.getElementById('completionDate').value = task.completionDate || '';
            document.getElementById('estimatedHours').value = formatDecimalOutput(task.estimatedHours);
            document.getElementById('actualHours').value = formatDecimalOutput(task.actualHours);
            document.getElementById('status').value = task.status;

            document.getElementById('saveTaskBtn').innerHTML = '<i class="fas fa-save me-2"></i>Atualizar Tarefa';
            document.getElementById('formTitle').textContent = 'Editando Tarefa ID: ' + task.id;

            calculateDeviation();

            const userData = Auth.getUserData();
            const isColaborador = (userData?.tipo || 'colaborador') === 'colaborador';
            
            const fieldsToDisableForColaborador = {
                taskType: true, taskDescription: true, project: true, client: true, company: true,
                responsible: true, startDate: true, endDate: true, completionDate: false, 
                estimatedHours: true, actualHours: false, deviation: true, status: false
            };

            for (const fieldId in fieldsToDisableForColaborador) {
                const el = document.getElementById(fieldId);
                if (el) {
                    if (isColaborador) {
                        el.disabled = fieldsToDisableForColaborador[fieldId];
                    } else {
                        el.disabled = (fieldId === 'deviation');
                    }
                }
            }
            document.getElementById('deviation').disabled = true;
            
            const formCollapseEl = document.getElementById('formCollapse');
            const bsCollapse = bootstrap.Collapse.getOrCreateInstance(formCollapseEl);
            bsCollapse.show();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        function fillConfirmationModal(tasksToConfirm) {
            const isSingleTask = tasksToConfirm.length === 1;
            const task = tasksToConfirm[0];

            const modalTitle = document.getElementById('confirmTaskModalTitle');
            const modalBody = document.querySelector('#confirmTaskModal .modal-body');
            modalBody.innerHTML = '';

            if (isSingleTask && editingTaskId) {
                modalTitle.textContent = `Confirmar Edi√ß√£o da Tarefa ID: ${task.id}`;
            } else if (isSingleTask) {
                modalTitle.textContent = 'Confirmar Nova Tarefa';
            } else {
                modalTitle.textContent = `Confirmar Cria√ß√£o de Tarefa Consolidada`;
            }

            const commonInfoHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Informa√ß√µes B√°sicas</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Tipo de Tarefa:</strong></td><td>${task.type || 'N/A'}</td></tr>
                            <tr><td><strong>Descri√ß√£o:</strong></td><td>${task.description || 'N/A'}</td></tr>
                            <tr><td><strong>Projeto:</strong></td><td>${task.project || 'N/A'}</td></tr>
                            <tr><td><strong>Cliente:</strong></td><td>${task.client || 'N/A'}</td></tr>
                            <tr><td><strong>Empresa:</strong></td><td>${task.company || 'N/A'}</td></tr>
                            <tr><td><strong>Respons√°vel:</strong></td><td>${task.responsible || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6" id="details-container"></div>
                </div>`;
            modalBody.insertAdjacentHTML('beforeend', commonInfoHtml);

            const detailsContainer = modalBody.querySelector('#details-container');

            if (isSingleTask) {
                const deviation = (task.actualHours || 0) - (task.estimatedHours || 0);
                const statusClass = `status-${(task.status || '').toLowerCase().replace(/\s+/g, '-').replace(/√£|√∫|√≠/g, a => ({'√£':'a', '√∫':'u'}[a]))}`;
                detailsContainer.innerHTML = `
                    <h6 class="text-primary">Prazos e Horas</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Data In√≠cio:</strong></td><td>${formatDate(task.startDate)}</td></tr>
                        <tr><td><strong>Data Final:</strong></td><td>${formatDate(task.endDate)}</td></tr>
                        <tr><td><strong>Data Finalizada:</strong></td><td>${formatDate(task.completionDate)}</td></tr>
                        <tr><td><strong>Horas Estimadas:</strong></td><td>${formatDecimalOutput(task.estimatedHours)}</td></tr>
                        <tr><td><strong>Horas Realizadas:</strong></td><td>${formatDecimalOutput(task.actualHours)}</td></tr>
                        <tr><td><strong>Desvio (Horas):</strong></td><td>${formatDecimalOutput(deviation)}</td></tr>
                        <tr><td><strong>Situa√ß√£o:</strong></td><td><span class="badge ${statusClass}">${task.status}</span></td></tr>
                    </table>`;
            } else {
                const firstDate = tasksToConfirm[0].startDate;
                const lastDate = tasksToConfirm[tasksToConfirm.length - 1].startDate;
                const totalHours = tasksToConfirm.reduce((sum, t) => sum + t.estimatedHours, 0);
                const totalDeviation = -totalHours;

                let splitTableHtml = `
                    <h6 class="text-primary">Tarefas a Serem Criadas (Detalhes)</h6>
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Informa√ß√£o:</strong> Ser√° enviada uma √∫nica tarefa consolidada abrangendo todo o per√≠odo.
                    </div>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Data In√≠cio</th><th>Horas Estimadas</th></tr></thead>
                            <tbody>`;
                tasksToConfirm.forEach(splitTask => {
                    splitTableHtml += `<tr><td>${formatDate(splitTask.startDate)}</td><td>${formatDecimalOutput(splitTask.estimatedHours)}</td></tr>`;
                });

                splitTableHtml += `</tbody></table></div>
                                <div class="alert alert-success mb-2">
                                    <strong>Tarefa Consolidada a ser enviada:</strong><br>
                                    <strong>Per√≠odo:</strong> ${formatDate(firstDate)} at√© ${formatDate(lastDate)}<br>
                                    <strong>Total de Horas:</strong> ${formatDecimalOutput(totalHours)}<br>
                                    <strong>Desvio (Horas):</strong> ${formatDecimalOutput(totalDeviation)}
                                </div>`;
                detailsContainer.innerHTML = splitTableHtml;
            }
        }
        
        function getFilteredTasks() {
            const responsible = document.getElementById('filterResponsible').value;
            const project = document.getElementById('filterProject').value;
            const client = document.getElementById('filterClient').value;
            const company = document.getElementById('filterCompany').value;
            const status = document.getElementById('filterStatus').value;
            const type = document.getElementById('filterTaskType').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            const approvedTasks = tasks.filter(t => t.aguadando_aprovacao === null || t.aguadando_aprovacao === true || t.aguadando_aprovacao === 'true');

            return approvedTasks.filter(task => {
                const matchesResponsible = !responsible || task.responsible === responsible;
                const matchesProject = !project || task.project === project;
                const matchesClient = !client || task.client === client;
                const matchesCompany = !company || task.company === company;
                const matchesStatus = !status || task.status === status;
                const matchesType = !type || task.type === type;

                let matchesDateRange = true;
                if (startDate || endDate) {
                    if (!task.startDate) {
                        matchesDateRange = false;
                    } else {
                        const taskDateStr = task.startDate.split('T')[0];
                        if (startDate && taskDateStr < startDate) {
                            matchesDateRange = false;
                        }
                        if (endDate && taskDateStr > endDate) {
                            matchesDateRange = false;
                        }
                    }
                }

                return matchesResponsible && matchesProject && matchesClient &&
                        matchesCompany && matchesStatus && matchesType && matchesDateRange;
            });
        }

        function applyFilters() {
            const filteredTasks = getFilteredTasks();
            updateApprovedTaskTable(filteredTasks);
            UI.showNotification(`üîç ${filteredTasks.length} tarefas encontradas.`, 'info');
        }

        function clearFilters() {
            document.querySelectorAll('#filtersCollapse select, #filtersCollapse input').forEach(el => el.value = '');
            updateTaskTables();
            UI.showNotification('‚úÖ Filtros limpos.', 'success');
        }

        function exportToExcel() {
            const hasFilters = !!(document.getElementById('filterResponsible').value ||
                                  document.getElementById('filterProject').value ||
                                  document.getElementById('filterClient').value ||
                                  document.getElementById('filterCompany').value ||
                                  document.getElementById('filterStatus').value ||
                                  document.getElementById('filterTaskType').value ||
                                  document.getElementById('filterStartDate').value ||
                                  document.getElementById('filterEndDate').value);

            const tasksForExport = hasFilters ? getFilteredTasks() : tasks.filter(t => t.aguadando_aprovacao === null || t.aguadando_aprovacao === true || t.aguadando_aprovacao === 'true');

            if (tasksForExport.length === 0) {
                UI.showNotification('‚ö†Ô∏è Nenhuma tarefa para exportar com os filtros atuais.', 'warning');
                return;
            }

            const dataToExport = tasksForExport.map(task => ({
                'ID': task.id || '',
                'Tipo de Tarefa': task.type || '',
                'Resumo': task.description || '',
                'Projeto': task.project || '',
                'Cliente': task.client || '',
                'Empresa': task.company || '',
                'Respons√°vel': task.responsible || '',
                'Data In√≠cio': formatDate(task.startDate),
                'Data Final': formatDate(task.endDate),
                'Data Finalizada': formatDate(task.completionDate),
                'Estimativa (h)': formatDecimalOutput(task.estimatedHours),
                'Realizado (h)': formatDecimalOutput(task.actualHours),
                'Desvio (h)': formatDecimalOutput((task.actualHours || 0) - (task.estimatedHours || 0)),
                'Situa√ß√£o': task.status || ''
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Tarefas");

            const fileName = hasFilters ? "Tarefas_Filtradas_ResolvTask.xlsx" : "Todas_Tarefas_ResolvTask.xlsx";
            XLSX.writeFile(workbook, fileName);

            UI.showNotification(`‚úÖ ${dataToExport.length} tarefa(s) exportada(s) para Excel.`, 'success');
        }
        
        async function reloadTaskDataAfterOperation(operation = 'atualiza√ß√£o') {
            try {
                console.log(`üîÑ Iniciando recarregamento de dados ap√≥s ${operation}...`);
                UI.showNotification(`üîÑ Recarregando dados ap√≥s ${operation}...`, 'info', 2000);
                await new Promise(resolve => setTimeout(resolve, 1500));
                console.log('üìã Recarregando lista de tarefas...');
                await loadTasks();
                console.log('‚è∞ Recarregando status de controle de horas...');
                await loadAllTimeEntriesAndApplyStatus();
                console.log(`‚úÖ Recarregamento completo ap√≥s ${operation} finalizado.`);
                UI.showNotification(`‚úÖ Dados atualizados com sucesso ap√≥s ${operation}!`, 'success');
            } catch (error) {
                console.error(`‚ùå Erro durante recarregamento ap√≥s ${operation}:`, error);
                UI.showNotification(`‚ö†Ô∏è Erro ao recarregar dados ap√≥s ${operation}. Tente atualizar a p√°gina.`, 'warning');
            }
        }

        function openApprovalActionModal(task) {
            const modalBody = document.getElementById('approvalTaskDetails');
            modalBody.innerHTML = `
                <p><strong>ID:</strong> ${task.id}</p>
                <p><strong>Descri√ß√£o:</strong> ${task.description}</p>
                <p><strong>Respons√°vel:</strong> ${task.responsible}</p>
                <p><strong>Projeto:</strong> ${task.project}</p>
            `;
            
            document.getElementById('cancelReason').value = '';
            document.getElementById('initialButtons').style.display = 'block';
            document.getElementById('cancelReasonSection').style.display = 'none';
            document.getElementById('confirmCancelButtons').style.display = 'none';

            document.getElementById('confirmApproveBtn').dataset.id = task.id;
            document.getElementById('confirmCancelBtn').dataset.id = task.id;

            new bootstrap.Modal(document.getElementById('approvalActionModal')).show();
        }

        function setupTimeControlListeners() {
            const timeControlModalEl = document.getElementById('timeControlModal');
            const manualTimeModal = new bootstrap.Modal(document.getElementById('manualTimeModal'));
            const confirmationModal = new bootstrap.Modal(document.getElementById('timeConfirmationModal'));
            const observationSection = document.getElementById('timeControlObservationSection');
            const observationInput = document.getElementById('timeControlObservation');

            // Estado para a a√ß√£o de confirma√ß√£o
            let _pendingAction = null;

            document.body.addEventListener('click', async (event) => {
                const target = event.target.closest('button');
                if (!target) return;

                const taskId = target.dataset.taskId;

                // Fun√ß√£o para mostrar modal de confirma√ß√£o
                const showConfirmationModal = (actionType, message) => {
                    document.getElementById('timeConfirmationMessage').textContent = message;
                    _pendingAction = { type: actionType, taskId: taskId };
                    confirmationModal.show();
                };

                if (target.id === 'startAutomaticBtn') {
                    if (!observationInput.value.trim()) {
                        UI.showNotification('A observa√ß√£o √© obrigat√≥ria para iniciar a tarefa.', 'warning');
                        observationInput.focus();
                        return;
                    }
                    showConfirmationModal('startAutomatic', 'Iniciar automaticamente o controle de horas para esta tarefa?');
                } 
                else if (target.id === 'startManualBtn') {
                    if (!observationInput.value.trim()) {
                        UI.showNotification('A observa√ß√£o √© obrigat√≥ria para iniciar um registro manual.', 'warning');
                        observationInput.focus();
                        return;
                    }
                    showConfirmationModal('startManual', 'Iniciar manualmente o controle de horas para esta tarefa?');
                }
                else if (target.id === 'stopAutomaticBtn') {
                    showConfirmationModal('stopAutomatic', 'Finalizar automaticamente o controle de horas para esta tarefa?');
                } 
                else if (target.id === 'stopManualBtn') {
                    showConfirmationModal('stopManual', 'Finalizar manualmente o controle de horas para esta tarefa?');
                }
            });

            // Event listener do bot√£o de confirma√ß√£o
            document.getElementById('confirmTimeActionBtn').addEventListener('click', async () => {
                if (!_pendingAction) return;

                confirmationModal.hide();

                const { type, taskId } = _pendingAction;
                _pendingAction = null;

                switch (type) {
                    case 'startAutomatic':
                        await sendTimeEntryUpdate('start', taskId, observationInput.value, null);
                        break;
                    case 'startManual':
                        _timeControlState.action = 'start';
                        _timeControlState.taskId = taskId;
                        document.getElementById('manualTimeModalTitle').textContent = 'Inserir Hor√°rio de In√≠cio Manual';
                        manualTimeModal.show();
                        break;
                    case 'stopAutomatic':
                        await sendTimeEntryUpdate('stop', taskId, observationInput.value || "", null);
                        break;
                    case 'stopManual':
                        _timeControlState.action = 'stop';
                        _timeControlState.taskId = taskId;
                        document.getElementById('manualTimeModalTitle').textContent = 'Inserir Hor√°rio de Fim Manual';
                        manualTimeModal.show();
                        break;
                }
            });

            document.getElementById('confirmManualTimeBtn').addEventListener('click', async () => {
                const manualDateTimeInput = document.getElementById('manualDateTimeInput');
                if (!manualDateTimeInput.value) {
                    UI.showNotification('Por favor, insira data e hora.', 'warning');
                    return;
                }
                const manualTimestamp = manualDateTimeInput.value;
                manualTimeModal.hide();
                
                const observation = document.getElementById('timeControlObservation').value;
                
                await sendTimeEntryUpdate(_timeControlState.action, _timeControlState.taskId, observation, manualTimestamp);
            });
            
            if (timeControlModalEl) {
                timeControlModalEl.addEventListener('hidden.bs.modal', () => {
                    console.log('Modal de horas fechado, atualizando a lista de tarefas.');
                    reloadTaskDataAfterOperation('fechamento do modal');
                });
            }
        }


        // ===================================
        // INICIALIZA√á√ÉO DA APLICA√á√ÉO
        // ===================================
        const App = {
            initialize: async () => {
                console.log('üöÄ Iniciando ResolvTask Dashboard...');
                if (!Auth.checkAuth()) {
                    Auth.redirectToLogin();
                    return;
                }

                UI.showAuthenticatedInterface();
                UI.updateUserInfo();
                UI.applyUIPermissions();

                await initializeApplication();
                setupEventListeners();
                setupTimeControlListeners();
                
                const timeControlModalEl = document.getElementById('timeControlModal');
                if (timeControlModalEl) {
                    timeControlModalEl.addEventListener('hidden.bs.modal', () => {
                        console.log('Modal de horas fechado, atualizando a lista de tarefas.');
                        reloadTaskDataAfterOperation('fechamento do modal');
                    });
                }
            }
        };

        await App.initialize();
    });
    </script>
</body>
</html>

