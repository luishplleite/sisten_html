{
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Script para processar dados de horas, empresas e colaboradores\nconst processedData = {\n    // Visão Geral das Horas\n    totalHorasEstimadas: 0,\n    totalHorasReais: 0,\n    desvioTotalHoras: 0,\n    totalAtividadesConcluidas: 0,\n    totalAtividadesEmAndamento: 0,\n    totalAtividadesNaoIniciadas: 0,\n\n    // Detalhes das Horas Lançadas\n    detalhesHoras: [],\n\n    // Visão Geral de Empresas\n    totalEmpresas: 0,\n    empresasCadastradas: [],\n\n    // Visão Geral de Colaboradores\n    totalColaboradores: 0,\n    colaboradoresAtivos: 0,\n    colaboradoresPorTipo: {},\n    detalhesColaboradores: [],\n\n    // Horas por Responsável e Tipo\n    horasPorResponsavel: {},\n    horasPorTipoAtividade: {},\n    horasPorProjeto: {},\n    horasPorCliente: {},\n    custoTotalPorResponsavel: {}, // Novo campo para custo total por responsável\n    custoTotalPorTipoAtividade: {}, // Novo campo para custo total por tipo de atividade\n    custoTotalPorProjeto: {}, // Novo campo para custo total por projeto\n    custoTotalPorCliente: {}, // Novo campo para custo total por cliente\n\n    // Dados brutos (opcional, para depuração)\n    rawDadosHoras: [],\n    rawDadosEmpresas: [],\n    rawDadosColaboradores: []\n};\n\nconsole.log('Total de inputs recebidos:', $input.all().length);\n\n// Mapas para armazenar dados por ID para fácil acesso\nconst dadosHorasMap = new Map();\nconst dadosEmpresasMap = new Map();\nconst dadosColaboradoresMap = new Map();\n\n// --- PRIMEIRA PASSAGEM: Coletar e organizar todos os dados brutos e preencher os mapas ---\n// Isso garante que todos os colaboradores e empresas estejam disponíveis antes de processar as horas\nfor (const item of $input.all()) {\n    const data = item.json.data; // Acessa diretamente o objeto 'data'\n\n    if (data.dados_horas && Array.isArray(data.dados_horas)) {\n        // Adiciona dados de horas ao mapa de horas e à lista bruta\n        for (const hora of data.dados_horas) {\n            dadosHorasMap.set(hora.id, hora);\n            processedData.rawDadosHoras.push(hora);\n        }\n    }\n\n    if (data.dados_empresas && Array.isArray(data.dados_empresas)) {\n        // Adiciona dados de empresas ao mapa de empresas e à lista bruta\n        for (const empresa of data.dados_empresas) {\n            dadosEmpresasMap.set(empresa.id, empresa);\n            processedData.rawDadosEmpresas.push(empresa);\n            processedData.totalEmpresas++;\n            processedData.empresasCadastradas.push({\n                id: empresa.id,\n                razao_social: empresa.razao_social,\n                cnpj: empresa.cnpj\n            });\n        }\n    }\n\n    if (data.dados_colaboradores && Array.isArray(data.dados_colaboradores)) {\n        // Adiciona dados de colaboradores ao mapa de colaboradores e à lista bruta\n        for (const colaborador of data.dados_colaboradores) {\n            dadosColaboradoresMap.set(colaborador.id, colaborador);\n            processedData.rawDadosColaboradores.push(colaborador);\n            processedData.totalColaboradores++;\n            if (colaborador.status) {\n                processedData.colaboradoresAtivos++;\n            }\n            // Conta colaboradores por tipo\n            processedData.colaboradoresPorTipo[colaborador.tipo] = (processedData.colaboradoresPorTipo[colaborador.tipo] || 0) + 1;\n            \n            // Adiciona detalhes completos do colaborador\n            processedData.detalhesColaboradores.push({\n                id: colaborador.id,\n                nome: colaborador.nome,\n                email: colaborador.email,\n                tipo: colaborador.tipo,\n                status: colaborador.status,\n                valor_hora_resolv_ai: colaborador.valor_hora_resolv_ai,\n                valor_hora_resolv: colaborador.valor_hora_resolv,\n                valor_hora_amigu: colaborador.valor_hora_amigu\n            });\n        }\n    }\n}\n\n// --- SEGUNDA PASSAGEM: Processar os dados de horas, agora que todos os colaboradores estão carregados ---\nfor (const horas of dadosHorasMap.values()) { // Itera sobre os valores do mapa de horas\n    let estimatedHours = parseFloat(horas.estimatedhours || 0);\n    let actualHours = parseFloat(horas.actualhours || 0);\n    \n    // Processa horas quebradas se existirem e adiciona às horas reais\n    if (horas.hora_quebrada_1) {\n        const parts = horas.hora_quebrada_1.split(',');\n        if (parts.length === 2) {\n            actualHours += parseFloat(parts[1] || 0);\n        }\n    }\n    if (horas.hora_quebrada_2) {\n        const parts = horas.hora_quebrada_2.split(',');\n        if (parts.length === 2) {\n            actualHours += parseFloat(parts[1] || 0);\n        }\n    }\n\n    // Recalcula o desvio após adicionar as horas quebradas\n    const deviation = actualHours - estimatedHours;\n\n    // Atualiza totais globais de horas\n    processedData.totalHorasEstimadas += estimatedHours;\n    processedData.totalHorasReais += actualHours;\n    processedData.desvioTotalHoras += deviation; // Soma o desvio de cada atividade para o desvio total\n\n    // Contagem de status de atividades\n    if (horas.status === 'CONCLUÍDO') {\n        processedData.totalAtividadesConcluidas++;\n    } else if (horas.status === 'EM ANDAMENTO') {\n        processedData.totalAtividadesEmAndamento++;\n    } else if (horas.status === 'NÃO INICIADO') {\n        processedData.totalAtividadesNaoIniciadas++;\n    }\n\n    // Encontra informações do colaborador responsável\n    const colaboradorInfo = Array.from(dadosColaboradoresMap.values()).find(colab => colab.nome === horas.responsible);\n    let valorHoraResponsavel = 0;\n    let custoTotal = 0;\n\n    if (colaboradorInfo) {\n        // Determina o valor da hora do responsável com base na empresa contratante\n        switch (horas.company) {\n            case 'Resolv Ai':\n                valorHoraResponsavel = colaboradorInfo.valor_hora_resolv_ai || 0;\n                break;\n            case 'Resolv':\n                valorHoraResponsavel = colaboradorInfo.valor_hora_resolv || 0;\n                break;\n            case 'Instituto Amigu':\n                valorHoraResponsavel = colaboradorInfo.valor_hora_amigu || 0;\n                break;\n            default:\n                // Fallback para valor_hora_resolv_ai se a empresa não for reconhecida ou o valor específico for nulo\n                valorHoraResponsavel = colaboradorInfo.valor_hora_resolv_ai || 0;\n        }\n        // Calcula o custo total da atividade\n        custoTotal = actualHours * valorHoraResponsavel;\n    }\n\n    // Adiciona detalhes da hora processada\n    processedData.detalhesHoras.push({\n        id: horas.id,\n        tipo: horas.type,\n        descricao: horas.description,\n        status: horas.status,\n        projeto: horas.project,\n        cliente: horas.client,\n        empresaContratante: horas.company,\n        responsavel: horas.responsible,\n        emailResponsavel: colaboradorInfo ? colaboradorInfo.email : 'N/A',\n        dataConclusao: horas.completiondate,\n        dataInicio: horas.startdate,\n        dataFim: horas.enddate,\n        horasEstimadas: estimatedHours,\n        horasReais: actualHours,\n        desvio: deviation,\n        timestamp: horas.timestamp,\n        lancadoPor: horas.lacado_por,\n        valorHoraResponsavel: valorHoraResponsavel, // Novo campo: valor da hora do responsável\n        custoTotal: custoTotal // Novo campo: custo total da atividade\n    });\n\n    // Atualiza horas e custos agregados por responsável\n    processedData.horasPorResponsavel[horas.responsible] = (processedData.horasPorResponsavel[horas.responsible] || { estimada: 0, real: 0 });\n    processedData.horasPorResponsavel[horas.responsible].estimada += estimatedHours;\n    processedData.horasPorResponsavel[horas.responsible].real += actualHours;\n    processedData.custoTotalPorResponsavel[horas.responsible] = (processedData.custoTotalPorResponsavel[horas.responsible] || 0) + custoTotal;\n\n    // Atualiza horas e custos agregados por tipo de atividade\n    processedData.horasPorTipoAtividade[horas.type] = (processedData.horasPorTipoAtividade[horas.type] || { estimada: 0, real: 0 });\n    processedData.horasPorTipoAtividade[horas.type].estimada += estimatedHours;\n    processedData.horasPorTipoAtividade[horas.type].real += actualHours;\n    processedData.custoTotalPorTipoAtividade[horas.type] = (processedData.custoTotalPorTipoAtividade[horas.type] || 0) + custoTotal;\n\n    // Atualiza horas e custos agregados por projeto\n    if (horas.project) {\n        processedData.horasPorProjeto[horas.project] = (processedData.horasPorProjeto[horas.project] || { estimada: 0, real: 0 });\n        processedData.horasPorProjeto[horas.project].estimada += estimatedHours;\n        processedData.horasPorProjeto[horas.project].real += actualHours;\n        processedData.custoTotalPorProjeto[horas.project] = (processedData.custoTotalPorProjeto[horas.project] || 0) + custoTotal;\n    }\n\n    // Atualiza horas e custos agregados por cliente\n    if (horas.client) {\n        processedData.horasPorCliente[horas.client] = (processedData.horasPorCliente[horas.client] || { estimada: 0, real: 0 });\n        processedData.horasPorCliente[horas.client].estimada += estimatedHours;\n        processedData.horasPorCliente[horas.client].real += actualHours;\n        processedData.custoTotalPorCliente[horas.client] = (processedData.custoTotalPorCliente[horas.client] || 0) + custoTotal;\n    }\n}\n\nconsole.log('=== RESULTADO FINAL DO PROCESSAMENTO ===');\nconsole.log(JSON.stringify(processedData, null, 2));\n\nreturn [{ json: processedData }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -416,
        5296
      ],
      "id": "e8124ad9-b58d-407c-899f-0b3172760cfc",
      "name": "Processar Dados"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.3,
      "position": [
        272,
        5296
      ],
      "id": "2ce28163-97dd-4380-a2ab-4dea0339e665",
      "name": "Resposta"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2032,
        4992
      ],
      "id": "b728ac53-d37c-4ecd-844b-9f1e28dd3cca",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2080,
        5296
      ],
      "id": "ec1ebe53-9d62-4f3e-8347-cbd386f8901d",
      "name": "Aggregate1"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2080,
        5632
      ],
      "id": "658bc6cb-3d54-4533-ad08-6624e26b6cb4",
      "name": "Aggregate2"
    },
    {
      "parameters": {
        "path": "/gestaodeparceiros",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3136,
        5296
      ],
      "id": "8c6aa875-f3de-4c41-8f72-e4efd48d5f31",
      "name": "Html Index",
      "webhookId": "4f57d0de-019b-4eea-a5e9-de498f752712"
    },
    {
      "parameters": {
        "numberInputs": 5
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -1056,
        4160
      ],
      "id": "1e13474d-e483-437a-942d-efd17353ddd4",
      "name": "Merge Dados2"
    },
    {
      "parameters": {
        "jsCode": "// Script corrigido para processar dados de Gestão de Clientes\nconst processedData = {\n  // Visão Geral\n  totalClientes: 0,\n  clientesAtivos: 0,\n  totalHorasContratadas: 0,\n  totalBancoDeHoras: 0,\n\n  // Detalhes dos Clientes e Serviços\n  clientesServicosDetalhado: [],\n\n  // Acompanhamento Mensal\n  acompanhamentoMensal: [],\n\n  // Informações para gráficos\n  horasPorServicoData: {\n    labels: [],\n    datasets: [{\n      data: [],\n      backgroundColor: ['#2296FA', '#FFD700', '#28a745', '#e74c3c', '#ffc107', '#6c757d', '#17a2b8', '#dc3545', '#fd7e14', '#6f42c1']\n    }]\n  },\n  statusClientesData: {\n    labels: [],\n    datasets: [{\n      data: [],\n      backgroundColor: ['#28a745', '#e74c3c', '#6c757d'] // Ativo, Inativo, Outros\n    }]\n  },\n  // Novos campos para armazenar os inputs brutos solicitados\n  rawServicosContratados: [],\n  rawHorasLancadas: [],\n  rawCadastroServico: [] // Novo array para armazenar os dados brutos de cadastro_servico\n};\n\nconsole.log('Total de inputs recebidos:', $input.all().length);\n\n// Coletar dados dos inputs\nconst clientesMap = new Map();\nconst servicosMap = new Map();\nconst horasLancadas = [];\nconst acompanhamentoMensal = [];\n\n// Processar cada item do input\nfor (const item of $input.all()) {\n  const data = item.json;\n\n  // Processar clientes\n  if (data['data.clientes']) {\n    const cliente = data['data.clientes'];\n    clientesMap.set(cliente.id, {\n      id: cliente.id,\n      nome: cliente.nome,\n      cnpj: cliente.cnpj,\n      email: cliente.email,\n      telefone: cliente.telefone,\n      ativo: cliente.ativo,\n      created_at: cliente.created_at\n    });\n  }\n\n  // Processar serviços contratados (caminho original)\n  if (data['data.sevicos_contratados']) {\n    const servico = data['data.sevicos_contratados'];\n    servicosMap.set(servico.id, {\n      id: servico.id,\n      cliente_id: servico.cliente_id,\n      nome_servico: servico.nome_servico,\n      horas_contratadas_mes: servico.horas_contratadas_mes,\n      meses_acumulacao: servico.meses_acumulacao,\n      valor_hora: servico.valor_hora,\n      created_at: servico.created_at\n    });\n    // Adiciona o objeto de serviço bruto ao array de rawServicosContratados\n    processedData.rawServicosContratados.push(servico);\n  }\n\n  // Processar horas lançadas\n  if (data['data.horas_lancadas']) {\n    const horas = data['data.horas_lancadas'];\n    horasLancadas.push({\n      id: horas.id,\n      servico_id: horas.servico_id,\n      horas_utilizadas: horas.horas_utilizadas,\n      data_atividade: horas.data_atividade,\n      descricao: horas.descricao,\n      created_at: horas.created_at\n    });\n    // Adiciona o objeto de horas lançadas bruto ao array de rawHorasLancadas\n    processedData.rawHorasLancadas.push(horas);\n  }\n\n  // Processar acompanhamento mensal OU serviços contratados que foram erroneamente categorizados\n  if (data['data.acompanhamento_mensal']) {\n    const acompOrServico = data['data.acompanhamento_mensal'];\n\n    // 1. É um registro de 'acompanhamento_mensal' real?\n    // Baseado na presença de campos como 'ano', 'mes' e 'total_horas_utilizadas'\n    if (acompOrServico.ano !== undefined && acompOrServico.mes !== undefined && acompOrServico.total_horas_utilizadas !== undefined) {\n      acompanhamentoMensal.push({\n        id: acompOrServico.id,\n        servico_id: acompOrServico.servico_id,\n        ano: acompOrServico.ano,\n        mes: acompOrServico.mes,\n        total_horas_utilizadas: acompOrServico.total_horas_utilizadas,\n        saldo_banco_horas_final: acompOrServico.saldo_banco_horas_final\n      });\n    }\n    // 2. É um registro de 'servicos_contratados' que foi colocado em 'acompanhamento_mensal'?\n    //    Verifica se tem 'nome_servico' e NÃO tem os campos de 'acompanhamento_mensal' que o distinguem.\n    else if (acompOrServico.nome_servico !== undefined &&\n             acompOrServico.ano === undefined && // Garante que não é um acompanhamento mensal\n             acompOrServico.mes === undefined && // Garante que não é um acompanhamento mensal\n             acompOrServico.total_horas_utilizadas === undefined) { // Garante que não é um acompanhamento mensal\n      // Adiciona ao mapa de serviços para ser processado corretamente\n      // Preenche campos ausentes com valores padrão para evitar erros\n      servicosMap.set(acompOrServico.id, {\n        id: acompOrServico.id,\n        cliente_id: acompOrServico.cliente_id || null, // Pode estar ausente\n        nome_servico: acompOrServico.nome_servico,\n        horas_contratadas_mes: acompOrServico.horas_contratadas_mes || 0, // Pode estar ausente\n        meses_acumulacao: acompOrServico.meses_acumulacao || 0, // Pode estar ausente\n        valor_hora: acompOrServico.valor_hora || 0, // Pode estar ausente\n        created_at: acompOrServico.created_at || new Date().toISOString()\n      });\n      // Adiciona o objeto de serviço bruto ao array de rawServicosContratados\n      processedData.rawServicosContratados.push(acompOrServico); // Adiciona o objeto bruto como ele é\n    } else {\n        // Loga um aviso se o objeto não se encaixar em nenhuma das categorias esperadas\n        console.warn('Objeto em data.acompanhamento_mensal não reconhecido ou com estrutura inesperada:', acompOrServico);\n    }\n  }\n\n  // NOVO: Processar dados de 'data.cadastro_servico'\n  if (data['data.cadastro_servico']) {\n    const cadastroServico = data['data.cadastro_servico'];\n    // Adiciona o objeto de cadastro de serviço bruto ao array de rawCadastroServico\n    processedData.rawCadastroServico.push(cadastroServico);\n    // Nota: Esses serviços de cadastro não são adicionados diretamente ao servicosMap\n    // porque não contêm informações de cliente_id ou horas_contratadas_mes,\n    // que são essenciais para os cálculos de clientesServicosDetalhado.\n    // Eles são considerados um \"catálogo\" de serviços.\n  }\n}\n\nconsole.log('Dados coletados:');\nconsole.log('Clientes:', clientesMap.size);\nconsole.log('Serviços:', servicosMap.size);\nconsole.log('Horas Lançadas:', horasLancadas.length);\nconsole.log('Acompanhamento Mensal:', acompanhamentoMensal.length);\nconsole.log('Cadastro de Serviços (Brutos):', processedData.rawCadastroServico.length); // Novo log\n\n// === Processamento dos Dados ===\n\n// Calcular totais e métricas\nprocessedData.totalClientes = clientesMap.size;\nprocessedData.clientesAtivos = Array.from(clientesMap.values()).filter(cliente => cliente.ativo).length;\n\n// Calcular total de horas contratadas e banco de horas\nlet totalHorasContratadas = 0;\nlet totalBancoHoras = 0;\nconst horasPorServico = {};\nconst statusCount = { 'Ativo': 0, 'Inativo': 0 };\n\n// Processar cada serviço e seu cliente\nfor (const [servicoId, servico] of servicosMap) {\n  const cliente = clientesMap.get(servico.cliente_id);\n  if (!cliente) {\n    console.warn(`Cliente com ID ${servico.cliente_id} não encontrado para o serviço ${servico.nome_servico}.`);\n    continue;\n  }\n\n  // Calcular horas totais do banco (horas mensais * meses de acumulação + horas mensais atuais)\n  const horasBanco = (servico.horas_contratadas_mes * servico.meses_acumulacao) + servico.horas_contratadas_mes;\n\n  // Calcular horas utilizadas para este serviço\n  const horasUtilizadasServico = horasLancadas\n    .filter(h => h.servico_id === servicoId)\n    .reduce((total, h) => total + h.horas_utilizadas, 0);\n\n  // Obter saldo atual do banco de horas (último acompanhamento mensal)\n  const ultimoAcompanhamento = acompanhamentoMensal\n    .filter(a => a.servico_id === servicoId)\n    .sort((a, b) => (b.ano * 12 + b.mes) - (a.ano * 12 + a.mes))[0];\n\n  const saldoBancoHoras = ultimoAcompanhamento ? ultimoAcompanhamento.saldo_banco_horas_final : horasBanco - horasUtilizadasServico;\n\n  // Adicionar aos detalhes\n  processedData.clientesServicosDetalhado.push({\n    clienteId: cliente.id,\n    servicoId: servico.id,\n    nomeCliente: cliente.nome,\n    cnpj: cliente.cnpj,\n    status: cliente.ativo ? 'Ativo' : 'Inativo',\n    servico: servico.nome_servico,\n    horasContratadas: servico.horas_contratadas_mes,\n    horasUtilizadas: horasUtilizadasServico,\n    bancoDeHoras: saldoBancoHoras,\n    valorHora: servico.valor_hora,\n    mesesAcumulacao: servico.meses_acumulacao\n  });\n\n  // Somar totais\n  totalHorasContratadas += servico.horas_contratadas_mes;\n  totalBancoHoras += saldoBancoHoras;\n\n  // Horas por serviço para gráfico\n  horasPorServico[servico.nome_servico] = (horasPorServico[servico.nome_servico] || 0) + servico.horas_contratadas_mes;\n\n  // Status do cliente\n  const status = cliente.ativo ? 'Ativo' : 'Inativo';\n  statusCount[status] = (statusCount[status] || 0) + 1; // Garante que a contagem inicia em 0\n}\n\nprocessedData.totalHorasContratadas = totalHorasContratadas;\nprocessedData.totalBancoDeHoras = totalBancoHoras;\n\n// Preencher dados dos gráficos\nprocessedData.horasPorServicoData.labels = Object.keys(horasPorServico);\nprocessedData.horasPorServicoData.datasets[0].data = Object.values(horasPorServico);\n\nprocessedData.statusClientesData.labels = Object.keys(statusCount).filter(key => statusCount[key] > 0);\nprocessedData.statusClientesData.datasets[0].data = processedData.statusClientesData.labels.map(label => statusCount[label]);\n\n// Processar acompanhamento mensal detalhado\nprocessedData.acompanhamentoMensal = acompanhamentoMensal.map(item => {\n  const servico = servicosMap.get(item.servico_id);\n  const cliente = servico ? clientesMap.get(servico.cliente_id) : null;\n\n  return {\n    acompanhamentoId: item.id,\n    clienteId: cliente ? cliente.id : null,\n    servicoId: item.servico_id,\n    cliente: cliente ? cliente.nome : 'Desconhecido',\n    servico: servico ? servico.nome_servico : 'Desconhecido',\n    ano: item.ano,\n    mes: item.mes,\n    horasUtilizadas: item.total_horas_utilizadas,\n    saldoBancoHoras: item.saldo_banco_horas_final\n  };\n});\n\n// Log final para debug\nconsole.log('=== RESULTADO FINAL - GESTÃO DE CLIENTES ===');\nconsole.log('Total de Clientes:', processedData.totalClientes);\nconsole.log('Clientes Ativos:', processedData.clientesAtivos);\nconsole.log('Total de Horas Contratadas:', processedData.totalHorasContratadas);\nconsole.log('Total de Banco de Horas:', processedData.totalBancoDeHoras);\nconsole.log('Detalhes Clientes/Serviços:', processedData.clientesServicosDetalhado.length);\nconsole.log('Acompanhamento Mensal:', processedData.acompanhamentoMensal.length);\nconsole.log('Gráficos:');\nconsole.log('- Horas por Serviço labels:', processedData.horasPorServicoData.labels);\nconsole.log('- Status de Clientes labels:', processedData.statusClientesData.labels);\nconsole.log('Dados Brutos de Serviços Contratados:', processedData.rawServicosContratados.length);\nconsole.log('Dados Brutos de Horas Lançadas:', processedData.rawHorasLancadas.length);\nconsole.log('Dados Brutos de Cadastro de Serviços:', processedData.rawCadastroServico.length); // Novo log\n\n\nreturn [{ json: processedData }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        4192
      ],
      "id": "8ccc7c3b-ef17-4d9e-9da9-bb4507a09a02",
      "name": "Processar Dados2"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.3,
      "position": [
        64,
        4192
      ],
      "id": "8e863304-15ab-458b-bf95-5bdd7889296b",
      "name": "Resposta2"
    },
    {
      "parameters": {
        "path": "/gestao_clientes",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3216,
        4176
      ],
      "id": "a4784024-ef9a-4a38-b96e-f8f7737cb092",
      "name": "Gestao_clientes",
      "webhookId": "4f57d0de-019b-4eea-a5e9-de498f752712"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "clientes",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2544,
        3840
      ],
      "id": "752fa812-b584-44c8-8502-45cec02161a2",
      "name": "gest_Consulta_Cliente",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "servicos_contratados",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2544,
        4016
      ],
      "id": "e584be61-03f8-445d-bf97-554fcb129c99",
      "name": "Consulta Sev_Contratados",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "notes": "convite"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "horas_lancadas",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2544,
        4192
      ],
      "id": "4a905a1b-dc7a-4651-9d34-ee36979e8aaa",
      "name": "Consulta Horas_Lançadas",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "operation": "getAll",
        "tableId": "acompanhamento_mensal",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2544,
        4384
      ],
      "id": "86681e08-fb5f-4492-8ee3-8562f977d47e",
      "name": "Consultas Mês_a_Mês",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "servicos",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2560,
        4576
      ],
      "id": "f6ffb176-8e8f-4a54-8183-60ed8b9877de",
      "name": "Consulta_Serviços",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2112,
        3840
      ],
      "id": "d7ffd4e5-04e9-4341-9c81-d8cde180e3f4",
      "name": "Agrupa Dados Consulta_Clientes"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2112,
        4016
      ],
      "id": "7b800ba1-04d9-4fc7-b18b-65ca409399a3",
      "name": "Agrupa dados Serv_Contratados"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2112,
        4192
      ],
      "id": "efae37c8-f52a-44ee-b266-758b2c7a7c68",
      "name": "Agrupa dados Horas Lançadas"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2112,
        4384
      ],
      "id": "84909ad1-70aa-4f3b-b9e7-633260f18506",
      "name": "Agrupa dados Mês_a_Mês"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2112,
        4576
      ],
      "id": "328c4136-845e-49b5-ad82-5ed172ffa27b",
      "name": "Agrupa dados Serviços"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "624d1773-dac0-46a0-96d6-3a15fecf74e2",
              "name": "data.clientes",
              "value": "={{ $json.data }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1696,
        3840
      ],
      "id": "55db0c21-ce6f-478d-a441-71fee347e069",
      "name": "Trata dodos Consulta_Clientes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "624d1773-dac0-46a0-96d6-3a15fecf74e2",
              "name": "data.sevicos_contratados",
              "value": "={{ $json.data }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1696,
        4016
      ],
      "id": "11174139-d0bd-4562-887d-678c8e9ed38d",
      "name": "Trata dados Serv_Contratados"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "624d1773-dac0-46a0-96d6-3a15fecf74e2",
              "name": "data.horas_lancadas",
              "value": "={{ $json.data }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1696,
        4192
      ],
      "id": "fc89192f-f2cc-4215-a583-2aa82c5448a2",
      "name": "Tarta dados Horas Lançadas"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "624d1773-dac0-46a0-96d6-3a15fecf74e2",
              "name": "data.acompanhamento_mensal",
              "value": "={{ $json.data }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1696,
        4384
      ],
      "id": "14585f77-174a-4dd7-89d6-486e82b785ce",
      "name": "Trata dados Mẽs_a_Mes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "624d1773-dac0-46a0-96d6-3a15fecf74e2",
              "name": "data.cadastro_servico",
              "value": "={{ $json.data }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1696,
        4576
      ],
      "id": "d937b766-8230-4d71-b254-59800a37758b",
      "name": "Trata dados Serviços"
    },
    {
      "parameters": {
        "fieldToSplitOut": "data.clientes,, data.sevicos_contratados,, data.horas_lancadas,, data.acompanhamento_mensal, data.cadastro_servico",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -784,
        4192
      ],
      "id": "32e53238-1a83-4f42-a0e2-d9559bc02e1a",
      "name": "Split Envios  Gestão Clientes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "624d1773-dac0-46a0-96d6-3a15fecf74e2",
              "name": "data.dados_horas",
              "value": "={{ $json.data }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1616,
        4992
      ],
      "id": "93901ad5-4ca3-4833-a49e-1d1d85d8447b",
      "name": "dados_horas"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "624d1773-dac0-46a0-96d6-3a15fecf74e2",
              "name": "data.dados_empresas",
              "value": "={{ $json.data }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1664,
        5296
      ],
      "id": "da71c1d4-15ab-4fcb-b829-22f1f95b9f2b",
      "name": "Dados Empresa"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "624d1773-dac0-46a0-96d6-3a15fecf74e2",
              "name": "data.dados_colaboradores",
              "value": "={{ $json.data }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1664,
        5632
      ],
      "id": "efdabe35-8d92-44ef-b63b-b4129c24a750",
      "name": "Dados Colaboradores"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -1136,
        5296
      ],
      "id": "87c04ca0-7556-40c0-8dc1-b9bd3b724aff",
      "name": "Merge Dados"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -896,
        5296
      ],
      "id": "b8e4ac22-240d-454e-bbe3-6da3c0ed3ebd",
      "name": "Aggregate6"
    },
    {
      "parameters": {
        "fieldToSplitOut": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -672,
        5296
      ],
      "id": "a4f20f0e-9916-4b3a-b5d5-9f726bfaf55f",
      "name": "Split Out"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Login - ResolvTask</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <style>\n        body { \n            display: flex; \n            align-items: center; \n            justify-content: center; \n            min-height: 100vh; \n            background-color: #f0f2f5; \n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; \n        }\n        .login-container { \n            background-color: #ffffff; \n            padding: 40px; \n            border-radius: 12px; \n            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); \n            width: 100%; \n            max-width: 420px; \n            text-align: center; \n            margin-bottom: 20px; \n        }\n        .login-container .logo { \n            max-width: 180px; \n            margin-bottom: 20px; \n        }\n        .form-control { \n            border-radius: 8px; \n            padding: 12px 15px; \n            border: 1px solid #ced4da; \n        }\n        .btn-login { \n            background-color: #0d6efd; \n            border-color: #0d6efd; \n            color: white; \n            padding: 12px; \n            border-radius: 8px; \n            font-weight: 600; \n        }\n        .signup-link { \n            display: block; \n            margin-top: 20px; \n            color: #0d6efd; \n            text-decoration: none; \n        }\n        .notification-area { \n            position: fixed; \n            top: 20px; \n            right: 20px; \n            z-index: 1050; \n            min-width: 300px; \n        }\n        .alert { \n            border-radius: 8px; \n            box-shadow: 0 4px 15px rgba(0,0,0,0.1); \n        }\n        .spinner-border-sm { \n            margin-right: 5px; \n        }\n    </style>\n</head>\n<body>\n    <div class=\"login-container\">\n        <img src=\"https://www.resolv.ai/logo.png\" alt=\"ResolvAI Logo\" class=\"logo\" onerror=\"this.onerror=null;this.src='https://placehold.co/180x40/ffffff/cccccc?text=Logo';\">\n        <br>\n        <h1><i class=\"fas fa-users me-3\"></i>Task</h1>\n        <p class=\"text-muted mb-4\">Faça login para continuar.</p>\n        <form id=\"loginForm\">\n            <div class=\"mb-3 text-start\">\n                <label for=\"email\" class=\"form-label\">E-mail:</label>\n                <input type=\"email\" class=\"form-control\" id=\"email\" required placeholder=\"seuemail@exemplo.com\">\n            </div>\n            <div class=\"mb-3 text-start\">\n                <label for=\"password\" class=\"form-label\">Senha:</label>\n                <input type=\"password\" class=\"form-control\" id=\"password\" required placeholder=\"Sua senha\">\n            </div>\n            <button type=\"submit\" class=\"btn btn-login w-100 mt-3\" id=\"loginButton\">\n                <span class=\"spinner-border spinner-border-sm d-none\" role=\"status\" aria-hidden=\"true\"></span>\n                Login\n            </button>\n        </form>\n        <a href=\"{{ $json.dominio.cadastro }}\" class=\"signup-link\">Não tem uma conta? Cadastre-se</a>\n    </div>\n\n    <div class=\"notification-area\" id=\"notificationArea\"></div>\n\n    <div class=\"modal fade\" id=\"activationPendingModal\" tabindex=\"-1\" aria-labelledby=\"activationPendingModalLabel\" aria-hidden=\"true\">\n        <div class=\"modal-dialog modal-dialog-centered\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"activationPendingModalLabel\">Aviso de Ativação</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    Aguardando ativação do cadastro. Por favor, entre em contato com o administrador.\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Fechar</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n    <script>\n        // =================================================================\n        // SAFE STORAGE FALLBACK FOR SANDBOXED IFRAMES\n        // =================================================================\n        const SafeStorage = (() => {\n            let memoryStorage = {};\n            let isLocalStorageAvailable = false;\n\n            try {\n                const test = '__storage_test__';\n                localStorage.setItem(test, test);\n                localStorage.removeItem(test);\n                isLocalStorageAvailable = true;\n            } catch (e) {\n                // localStorage não disponível - usando armazenamento em memória (modo sandbox)\n                isLocalStorageAvailable = false;\n            }\n\n            return {\n                getItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        return localStorage.getItem(key);\n                    }\n                    return memoryStorage[key] || null;\n                },\n                setItem: (key, value) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.setItem(key, value);\n                    } else {\n                        memoryStorage[key] = value;\n                    }\n                },\n                removeItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.removeItem(key);\n                    } else {\n                        delete memoryStorage[key];\n                    }\n                },\n                clear: () => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.clear();\n                    } else {\n                        memoryStorage = {};\n                    }\n                }\n            };\n        })();\n\n        // --- VERIFICAÇÃO DE SESSÃO EXISTENTE ---\n        document.addEventListener('DOMContentLoaded', () => {\n            const authToken = SafeStorage.getItem('authToken');\n            const userSession = SafeStorage.getItem('userSession');\n\n            if (authToken && userSession) {\n                // Se já está logado, redireciona para o dashboard\n                window.location.href = '{{ $json.dominio.resolv }}';\n                return;\n            }\n        });\n\n        // --- AUTENTICAÇÃO ---\n        const WEBHOOK_AUTHENTICATE_URL = '{{ $json.dominio.autenticar }}';\n        const REDIRECT_URL_ON_SUCCESS = '{{ $json.dominio.resolv }}';\n\n        const loginForm = document.getElementById('loginForm');\n        const loginButton = document.getElementById('loginButton');\n        const emailInput = document.getElementById('email');\n        const passwordInput = document.getElementById('password');\n        const spinner = loginButton.querySelector('.spinner-border');\n\n        function showNotification(message, type = 'success') {\n            const notificationArea = document.getElementById('notificationArea');\n            const alertDiv = document.createElement('div');\n            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;\n            alertDiv.role = 'alert';\n            alertDiv.innerHTML = `${message}<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>`;\n            notificationArea.appendChild(alertDiv);\n\n            setTimeout(() => {\n                const alertInstance = bootstrap.Alert.getOrCreateInstance(alertDiv);\n                if (alertInstance) { \n                    alertInstance.close(); \n                }\n            }, 5000);\n        }\n\n        function generateSessionToken() {\n            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n        }\n\n        function parseUserData(dataString) {\n            const userData = {};\n            const pairs = dataString.split(/,\\s*/);\n            pairs.forEach(pair => {\n                const delimiterIndex = pair.indexOf(':');\n                if (delimiterIndex > -1) {\n                    const key = pair.substring(0, delimiterIndex).trim();\n                    const value = pair.substring(delimiterIndex + 1).trim();\n                    userData[key] = value;\n                }\n            });\n            return userData;\n        }\n\n        function saveUserSession(email, userData) {\n            const sessionToken = generateSessionToken();\n            const sessionData = {\n                email: email,\n                nome: userData.Nome || email.split('@')[0],\n                tipo: userData.Tipo || 'colaborador',\n                loginTime: new Date().toISOString(),\n                token: sessionToken\n            };\n\n            SafeStorage.clear();\n            SafeStorage.setItem('authToken', sessionToken);\n            SafeStorage.setItem('userSession', JSON.stringify(sessionData));\n            SafeStorage.setItem('loggedInUserEmail', email);\n            SafeStorage.setItem('loggedInUserName', sessionData.nome);\n            SafeStorage.setItem('loggedInUserTipo', sessionData.tipo);\n            \n            return sessionData;\n        }\n\n        loginForm.addEventListener('submit', async function(event) {\n            event.preventDefault();\n\n            const email = emailInput.value.trim();\n            const password = passwordInput.value.trim();\n\n            if (!email || !password) {\n                showNotification('Por favor, preencha e-mail e senha.', 'warning');\n                return;\n            }\n\n            loginButton.disabled = true;\n            spinner.classList.remove('d-none');\n\n            try {\n                const response = await fetch(WEBHOOK_AUTHENTICATE_URL, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify({ email: email, senha: password })\n                });\n\n                const responseText = await response.text();\n\n                if (!response.ok) {\n                    throw new Error(responseText || 'Credenciais inválidas ou erro no servidor.');\n                }\n\n                let userDataString = null;\n\n                // Tenta interpretar como JSON. Se for bem-sucedido e tiver a estrutura esperada, usa.\n                try {\n                    const result = JSON.parse(responseText);\n                    if (Array.isArray(result) && result.length > 0 && result[0].data) {\n                        userDataString = result[0].data;\n                    }\n                } catch (jsonError) {\n                    // Se não for JSON, o erro é ignorado aqui e a lógica abaixo trata como texto.\n                    console.log(\"A resposta não é JSON. Tratando como texto simples:\", responseText);\n                }\n\n                // Se não foi possível extrair do JSON, trata a resposta como texto simples.\n                if (userDataString === null && responseText.includes('Status:')) {\n                    userDataString = responseText;\n                }\n\n                // Se uma string de dados foi encontrada (seja de JSON ou texto), processa-a.\n                if (userDataString) {\n                    const parsedData = parseUserData(userDataString);\n\n                    if (parsedData.Status === 'True') {\n                        const sessionData = saveUserSession(email, parsedData);\n                        showNotification('Login bem-sucedido! Redirecionando...', 'success');\n\n                        setTimeout(() => {\n                            // Verifica se localStorage está disponível\n                            let isLocalStorageAvailable = false;\n                            try {\n                                const test = '__test__';\n                                localStorage.setItem(test, test);\n                                localStorage.removeItem(test);\n                                isLocalStorageAvailable = true;\n                            } catch (e) {\n                                isLocalStorageAvailable = false;\n                            }\n                            \n                            // Se localStorage não estiver disponível, passa dados pela URL\n                            if (!isLocalStorageAvailable) {\n                                const sessionParam = encodeURIComponent(btoa(JSON.stringify(sessionData)));\n                                window.location.href = REDIRECT_URL_ON_SUCCESS + '?session=' + sessionParam;\n                            } else {\n                                window.location.href = REDIRECT_URL_ON_SUCCESS;\n                            }\n                        }, 1500);\n\n                    } else if (parsedData.Status === 'inactive') {\n                        const activationModal = new bootstrap.Modal(document.getElementById('activationPendingModal'));\n                        activationModal.show();\n                    } else {\n                        // Se o status existe mas não é 'True' ou 'inactive'\n                        showNotification('E-mail ou senha incorretos.', 'danger');\n                    }\n                } else {\n                    // Se, após todas as tentativas, nenhuma string de dados válida foi encontrada.\n                    console.error(\"Formato de resposta do servidor inválido:\", responseText);\n                    throw new Error(\"Formato de resposta do servidor inválido.\");\n                }\n\n            } catch (error) {\n                console.error('Erro durante o login:', error);\n                // A linha 256 original estava aqui, registrando o erro.\n                // Agora, o erro de localStorage será pego antes (na função saveUserSession),\n                // mas outros erros (como de rede) ainda serão pegos aqui.\n                showNotification(error.message || 'Ocorreu um erro ao tentar fazer login.', 'danger');\n            } finally {\n                loginButton.disabled = false;\n                spinner.classList.add('d-none');\n            }\n        });\n    </script>\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -1920,
        2192
      ],
      "id": "259a4e6d-451c-4a12-94e2-05ab58a3b123",
      "name": "Login HTML"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Dashboard - ResolvTask</title>\n\n    <!-- External Libraries -->\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n\n    <style>\n        /* Color Variables */\n        :root {\n            --primary-color: #0d6efd;\n            --secondary-color: #6c757d;\n            --success-color: #198754;\n            --danger-color: #dc3545;\n            --warning-color: #ffc107;\n            --info-color: #0dcaf0;\n            --paused-color: #6f42c1;\n            --not-started-color: #6c757d;\n            --light-color: #f8f9fa;\n            --dark-color: #212529;\n        }\n\n        /* Global Styles */\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background-color: var(--light-color);\n            overflow-x: hidden;\n        }\n        .app-container {\n            opacity: 0;\n            transition: opacity 0.5s ease;\n        }\n        .app-container.authenticated {\n            opacity: 1;\n        }\n        ::-webkit-scrollbar { width: 8px; }\n        ::-webkit-scrollbar-track { background: #f1f1f1; }\n        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }\n        ::-webkit-scrollbar-thumb:hover { background: #0b5ed7; }\n\n        /* Auth Loading Screen */\n        .auth-loading {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            color: white;\n        }\n        .auth-loading .spinner-auth {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(255, 255, 255, 0.3);\n            border-top: 4px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n        .auth-loading h4 {\n            margin-bottom: 10px;\n            font-weight: 300;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            height: 100vh;\n            width: 280px;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            position: fixed;\n            left: 0;\n            top: 0;\n            transition: transform 0.3s ease;\n            z-index: 1000;\n            overflow-y: auto;\n        }\n        .sidebar.collapsed {\n            transform: translateX(-100%);\n        }\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            background-color: white;\n            border-bottom: 1px solid #dee2e6;\n        }\n        .sidebar-header .logo {\n            max-width: 150px;\n            height: auto;\n            margin-bottom: 10px;\n        }\n        .sidebar-header .text-light {\n            color: var(--dark-color) !important;\n            font-weight: 500;\n        }\n        .sidebar-menu {\n            padding: 20px 0;\n        }\n        .menu-item {\n            display: block;\n            padding: 15px 25px;\n            color: rgba(255,255,255,0.8);\n            text-decoration: none;\n            transition: all 0.3s ease;\n            border: none;\n            background: none;\n            width: 100%;\n            text-align: left;\n            cursor: pointer;\n            display: none; /* Hidden by default, shown by JS */\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n        .menu-item:hover, .menu-item.active {\n            background-color: rgba(255,255,255,0.1);\n            color: white;\n        }\n        .menu-item i {\n            width: 20px;\n            margin-right: 15px;\n        }\n        .menu-item.show {\n            display: block;\n            opacity: 1;\n        }\n        .sidebar-loading {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 40px 20px;\n            color: rgba(255, 255, 255, 0.8);\n        }\n        .sidebar-loading .spinner-small {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid rgba(255, 255, 255, 0.8);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-right: 10px;\n        }\n\n        /* Main Content */\n        .main-content {\n            margin-left: 280px;\n            transition: margin-left 0.3s ease;\n            min-height: 100vh;\n        }\n        .main-content.expanded {\n            margin-left: 0;\n        }\n\n        /* Top Navigation */\n        .top-nav {\n            background: white;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            padding: 15px 25px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            position: sticky;\n            top: 0;\n            z-index: 999;\n        }\n        .sidebar-toggle {\n            display: none;\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n        }\n        .user-info {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n        /* Content Area & Page Transitions */\n        .content-area {\n            padding: 25px;\n        }\n        .page-content {\n            opacity: 0;\n            transform: translateY(20px);\n            transition: opacity 0.4s ease, transform 0.4s ease;\n            display: none; /* Hide by default */\n        }\n        .page-content.active {\n            opacity: 1;\n            transform: translateY(0);\n            display: block; /* Show active page */\n        }\n\n        /* Cards */\n        .card {\n            border: none;\n            border-radius: 15px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n            margin-bottom: 25px;\n            transition: transform 0.3s ease;\n            height: 100%;\n        }\n        .card:hover {\n            transform: translateY(-5px);\n        }\n        .stat-card {\n            color: white;\n            text-align: center;\n            padding: 25px;\n        }\n        .stat-card.primary { background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%); }\n        .stat-card.success { background: linear-gradient(135deg, var(--success-color) 0%, #157347 100%); }\n        .stat-card.warning { background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%); color: #212529; }\n        .stat-card.danger { background: linear-gradient(135deg, var(--danger-color) 0%, #b02a37 100%); }\n        .stat-card.info { background: linear-gradient(135deg, var(--info-color) 0%, #0aa2c0 100%); }\n        .stat-card.paused { background: linear-gradient(135deg, var(--paused-color) 0%, #59369a 100%); }\n        .stat-card.not-started { background: linear-gradient(135deg, var(--not-started-color) 0%, #5a6268 100%); }\n        .stat-card.secondary { background: linear-gradient(135deg, var(--secondary-color) 0%, #5a6268 100%); }\n        .stat-number {\n            font-size: 2.5rem;\n            font-weight: 700;\n            margin-bottom: 10px;\n        }\n        .stat-label {\n            font-size: 1.1rem;\n            opacity: 0.9;\n        }\n        .stat-icon {\n            font-size: 3rem;\n            opacity: 0.3;\n            position: absolute;\n            right: 20px;\n            top: 50%;\n            transform: translateY(-50%);\n            transition: all 0.3s ease;\n        }\n        .stat-card:hover .stat-icon {\n            opacity: 0.4;\n            transform: translateY(-50%) scale(1.1);\n        }\n\n        /* Welcome Header */\n        .bg-gradient {\n            position: relative;\n            overflow: hidden;\n        }\n        .bg-gradient::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n        .bg-gradient:hover::before {\n            opacity: 1;\n        }\n\n        /* Chart & Table Styles */\n        .chart-card {\n            padding: 25px;\n            background: white;\n        }\n        .chart-card .card-title {\n            font-weight: 600;\n        }\n        .chart-container {\n            position: relative;\n            height: 300px;\n            width: 100%;\n        }\n\n        /* Animation & Responsive */\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        /* Responsive adjustments for desktop layout */\n        @media (min-width: 1200px) {\n            .main-content {\n                margin-left: 280px;\n            }\n            .content-area {\n                padding: 30px 40px;\n            }\n            .stat-card {\n                min-height: 140px;\n                padding: 30px;\n            }\n            .stat-number {\n                font-size: 3rem;\n                font-weight: 700;\n                margin-bottom: 15px;\n            }\n            .stat-label {\n                font-size: 1.2rem;\n                opacity: 0.9;\n                font-weight: 500;\n            }\n            .chart-container {\n                height: 400px;\n            }\n        }\n\n        @media (min-width: 992px) and (max-width: 1199px) {\n            .stat-number {\n                font-size: 2.8rem;\n            }\n            .stat-label {\n                font-size: 1.1rem;\n            }\n        }\n\n        @media (max-width: 992px) {\n            .sidebar { width: 260px; }\n            .main-content { margin-left: 260px; }\n            .stat-card {\n                min-height: 120px;\n            }\n        }\n        @media (max-width: 768px) {\n            .sidebar { transform: translateX(-100%); width: 280px; z-index: 1050; }\n            .sidebar.show { transform: translateX(0); }\n            .main-content { margin-left: 0; }\n            .sidebar-toggle { display: block; }\n            .top-nav { flex-wrap: wrap; gap: 10px; }\n            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040; opacity: 0; visibility: hidden; transition: all 0.3s ease; }\n            .sidebar-overlay.show { opacity: 1; visibility: visible; }\n        }\n    </style>\n</head>\n<body>\n    <!-- Auth loading screen -->\n    <div class=\"auth-loading\" id=\"authLoading\">\n        <div class=\"spinner-auth\"></div>\n        <h4>ResolvTask Dashboard</h4>\n        <p>Verificando autenticação...</p>\n    </div>\n\n    <!-- Main interface (hidden until authenticated) -->\n    <div class=\"app-container\" id=\"appContainer\">\n        <!-- Sidebar -->\n        <nav class=\"sidebar\" id=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <img src=\"https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png\" alt=\"ResolvAI Logo\" class=\"logo\">\n                <br><br>\n                <h1><i class=\"fas fa-bolt me-2\"></i>Task</h1>\n                <small class=\"text-light\">Sistema Integrado de Gestão</small>\n            </div>\n            <div class=\"sidebar-menu\" id=\"sidebarMenu\">\n                <div class=\"sidebar-loading\" id=\"sidebarLoading\">\n                    <div class=\"spinner-small\"></div>\n                    Carregando menu...\n                </div>\n                <!-- Menu items will be populated by JS based on user permissions -->\n                <button class=\"menu-item active\" onclick=\"UI.showPage('dashboard', event);\" data-menu=\"dashboard\"><i class=\"fas fa-chart-line\"></i>Dashboard</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.menu.gerenciadortarefas }}'\" data-menu=\"tasks\"><i class=\"fas fa-tasks\"></i>Gerenciador de Tarefas</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.menu.taskhoras }}'\" data-menu=\"hours\"><i class=\"fas fa-clock\"></i>Gerenciador de Horas</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.menu.gestao_clientes }}'\" data-menu=\"clients\"><i class=\"fas fa-handshake\"></i>Gestão de Clientes</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.menu.gestaodeparceiros }}'\" data-menu=\"partners\"><i class=\"fas fa-handshake-angle\"></i>Gestão de Parceiros</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.menu.equipe }}'\" data-menu=\"team\"><i class=\"fas fa-users\"></i>Equipe</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.menu.conf }}'\" data-menu=\"settings\"><i class=\"fas fa-cog\"></i>Configurações</button>\n            </div>\n        </nav>\n\n        <!-- Main Content -->\n        <main class=\"main-content\" id=\"mainContent\">\n            <nav class=\"top-nav\">\n                <div class=\"d-flex align-items-center\">\n                    <button class=\"sidebar-toggle\" id=\"sidebarToggle\"><i class=\"fas fa-bars\"></i></button>\n                    <h5 class=\"mb-0 ms-3\" id=\"pageTitle\">Dashboard</h5>\n                </div>\n                <div class=\"user-info\">\n                    <div class=\"d-flex align-items-center\">\n                        <i class=\"fas fa-user-circle fs-4 text-primary me-2\"></i>\n                        <span class=\"fw-bold\" id=\"userNameDisplay\">Usuário</span>\n                    </div>\n                    <button class=\"btn btn-outline-danger btn-sm ms-2\" id=\"logoutButton\" title=\"Sair\">\n                        <i class=\"fas fa-sign-out-alt me-1\"></i>Sair\n                    </button>\n                </div>\n            </nav>\n\n            <div class=\"content-area\">\n                <!-- ================== DASHBOARD PAGE ================== -->\n                <div id=\"dashboard-page\" class=\"page-content active\">\n                    <!-- Stat Cards Row -->\n                    <div class=\"row row-cols-1 row-cols-md-3 row-cols-xl-6 g-4 mb-4\">\n                        <div class=\"col\"><div class=\"card stat-card primary\"><div class=\"position-relative\"><div class=\"stat-number\" id=\"totalTasks\">0</div><div class=\"stat-label\">Total de Tarefas</div><i class=\"fas fa-tasks stat-icon\"></i></div></div></div>\n                        <div class=\"col\"><div class=\"card stat-card not-started\"><div class=\"position-relative\"><div class=\"stat-number\" id=\"notStartedTasks\">0</div><div class=\"stat-label\">Não Iniciadas</div><i class=\"fas fa-hourglass-start stat-icon\"></i></div></div></div>\n                        <div class=\"col\"><div class=\"card stat-card warning\"><div class=\"position-relative\"><div class=\"stat-number\" id=\"inProgressTasks\">0</div><div class=\"stat-label\">Em Andamento</div><i class=\"fas fa-cogs stat-icon\"></i></div></div></div>\n                        <div class=\"col\"><div class=\"card stat-card paused\"><div class=\"position-relative\"><div class=\"stat-number\" id=\"pausedTasks\">0</div><div class=\"stat-label\">Paralizadas</div><i class=\"fas fa-pause-circle stat-icon\"></i></div></div></div>\n                        <div class=\"col\"><div class=\"card stat-card success\"><div class=\"position-relative\"><div class=\"stat-number\" id=\"completedTasks\">0</div><div class=\"stat-label\">Concluídas</div><i class=\"fas fa-check-circle stat-icon\"></i></div></div></div>\n                        <div class=\"col\"><div class=\"card stat-card danger\"><div class=\"position-relative\"><div class=\"stat-number\" id=\"overdueTasks\">0</div><div class=\"stat-label\">Atrasadas</div><i class=\"fas fa-exclamation-triangle stat-icon\"></i></div></div></div>\n                    </div>\n                    <!-- Charts Section - Vertical Layout -->\n                    <div class=\"row g-4 mb-4\">\n                        <!-- Evolução de Tarefas por Mês - Sempre no topo -->\n                        <div class=\"col-12\">\n                            <div class=\"card chart-card\">\n                                <h5 class=\"card-title mb-4\">\n                                    <i class=\"fas fa-chart-area text-primary me-2\"></i>Evolução de Tarefas por Mês\n                                </h5>\n                                <div class=\"chart-container\">\n                                    <canvas id=\"tasksChart\"></canvas>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class=\"row g-4 mb-4\">\n                        <!-- Status das Tarefas - Sempre abaixo -->\n                        <div class=\"col-12\">\n                            <div class=\"card chart-card\">\n                                <h5 class=\"card-title mb-4\">\n                                    <i class=\"fas fa-chart-bar text-primary me-2\"></i>Status das Tarefas\n                                </h5>\n                                <div class=\"chart-container\">\n                                    <canvas id=\"statusChart\"></canvas>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <!-- ================== SETTINGS PAGE ================== -->\n                <div id=\"settings-page\" class=\"page-content\">\n                    <div class=\"card text-center p-5\">\n                        <i class=\"fas fa-cog fa-5x text-primary mb-4 fa-spin\"></i>\n                        <h4>Configurações</h4>\n                        <p class=\"text-muted\">Módulo de configurações em desenvolvimento.</p>\n                    </div>\n                </div>\n            </div>\n        </main>\n\n        <!-- Sidebar Overlay -->\n        <div class=\"sidebar-overlay\" id=\"sidebarOverlay\"></div>\n    </div>\n\n    <script>\n    document.addEventListener('DOMContentLoaded', async () => {\n        // =================================================================\n        // SAFE STORAGE FOR SANDBOXED IFRAMES\n        // =================================================================\n        const SafeStorage = (() => {\n            let memoryStorage = {};\n            let isLocalStorageAvailable = false;\n\n            try {\n                const test = '__storage_test__';\n                localStorage.setItem(test, test);\n                localStorage.removeItem(test);\n                isLocalStorageAvailable = true;\n            } catch (e) {\n                isLocalStorageAvailable = false;\n                console.warn('⚠️ localStorage não disponível, usando armazenamento via window.name');\n                \n                if (window.name) {\n                    try {\n                        memoryStorage = JSON.parse(window.name);\n                    } catch (e) {\n                        memoryStorage = {};\n                    }\n                }\n                \n                const urlParams = new URLSearchParams(window.location.search);\n                if (urlParams.has('session')) {\n                    try {\n                        const sessionData = JSON.parse(atob(urlParams.get('session')));\n                        memoryStorage['authToken'] = sessionData.token;\n                        memoryStorage['userSession'] = JSON.stringify(sessionData);\n                        window.name = JSON.stringify(memoryStorage);\n                    } catch (e) {\n                        console.error('Erro ao processar sessão da URL:', e);\n                    }\n                }\n            }\n\n            return {\n                getItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        return localStorage.getItem(key);\n                    }\n                    return memoryStorage[key] || null;\n                },\n                setItem: (key, value) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.setItem(key, value);\n                    } else {\n                        memoryStorage[key] = value;\n                        window.name = JSON.stringify(memoryStorage);\n                    }\n                },\n                removeItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.removeItem(key);\n                    } else {\n                        delete memoryStorage[key];\n                        window.name = JSON.stringify(memoryStorage);\n                    }\n                },\n                clear: () => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.clear();\n                    } else {\n                        memoryStorage = {};\n                        window.name = '';\n                    }\n                }\n            };\n        })();\n        \n        // =================================================================\n        // GLOBAL CONFIGURATION & VARIABLES\n        // =================================================================\n        const LOGIN_URL = 'https://n8n.resolv.ai/webhook/login';\n        const WEBHOOK_GET_URL = 'https://n8n.resolv.ai/webhook/consultadadosresolv';\n        let tasks = [];\n        let charts = {};\n\n        // =================================================================\n        // AUTHENTICATION AND SESSION FUNCTIONS\n        // =================================================================\n        const Auth = {\n            getUserData: () => {\n                const sessionData = SafeStorage.getItem('userSession');\n                return sessionData ? JSON.parse(sessionData) : null;\n            },\n            checkAuth: () => {\n                const authToken = SafeStorage.getItem('authToken');\n                const userData = Auth.getUserData();\n                console.log('🔐 Verificando status de login...', { hasToken: !!authToken, hasData: !!userData });\n                return !!(authToken && userData);\n            },\n            logout: () => {\n                console.log('🚪 Iniciando processo de logout...');\n                SafeStorage.clear();\n                const authLoadingEl = document.getElementById('authLoading');\n                if (authLoadingEl) {\n                    authLoadingEl.style.display = 'flex';\n                    authLoadingEl.innerHTML = `<div class=\"spinner-auth\"></div><h4>Sessão encerrada</h4><p>Você será redirecionado.</p>`;\n                }\n                document.getElementById('appContainer').style.opacity = 0;\n                setTimeout(() => { window.location.href = LOGIN_URL; }, 1500);\n            },\n            redirectToLogin: () => {\n                console.log('🔄 Redirecionando para página de login...');\n                window.location.href = LOGIN_URL;\n            }\n        };\n\n        // =================================================================\n        // UI MANIPULATION FUNCTIONS\n        // =================================================================\n        const UI = {\n            updateUserInfo: () => {\n                const userData = Auth.getUserData();\n                if (userData) {\n                    document.getElementById('userNameDisplay').textContent = userData.nome;\n                    console.log('👤 Informações do usuário atualizadas:', userData.nome);\n                }\n            },\n            showAuthenticatedInterface: () => {\n                document.getElementById('authLoading').style.display = 'none';\n                document.getElementById('appContainer').classList.add('authenticated');\n                console.log('🎉 Interface principal ativada.');\n            },\n            applyUIPermissions: () => {\n                const userData = Auth.getUserData();\n                const userType = userData?.tipo || 'colaborador';\n                console.log(`🔧 Aplicando permissões de UI para o tipo: ${userType}`);\n\n                document.getElementById('sidebarLoading').style.display = 'none';\n                \n                const menuPermissions = {\n                    admin: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'],\n                    colaborador: ['dashboard', 'tasks', 'hours', 'settings']\n                };\n                const allowedMenus = menuPermissions[userType] || menuPermissions.colaborador;\n\n                document.querySelectorAll('#sidebarMenu .menu-item').forEach((item, index) => {\n                    const menuType = item.getAttribute('data-menu');\n                    if (allowedMenus.includes(menuType)) {\n                        setTimeout(() => item.classList.add('show'), index * 50);\n                    }\n                });\n\n                if (!SafeStorage.getItem('welcomeMessageShown')) {\n                    setTimeout(() => {\n                        const userName = userData?.nome || \"Usuário\";\n                        const message = userType === 'admin' ? `🔑 Bem-vindo(a), ${userName}! Acesso de Administrador.` : `👋 Bem-vindo(a), ${userName}!`;\n                        UI.showNotification(message, userType === 'admin' ? 'success' : 'info');\n                        SafeStorage.setItem('welcomeMessageShown', 'true');\n                    }, 500);\n                }\n            },\n            showNotification: (message, type = 'info') => {\n                const container = document.body;\n                const alertType = type === 'error' ? 'danger' : type;\n                const iconMap = { success: 'check-circle', warning: 'exclamation-triangle', danger: 'times-circle', info: 'info-circle' };\n                const icon = iconMap[type] || 'info-circle';\n                const notification = document.createElement('div');\n                notification.className = `alert alert-${alertType} alert-dismissible fade show shadow-lg`;\n                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';\n                notification.innerHTML = `<i class=\"fas fa-${icon} me-2\"></i> ${message} <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>`;\n                container.appendChild(notification);\n                setTimeout(() => bootstrap.Alert.getOrCreateInstance(notification)?.close(), 5000);\n            },\n            toggleSidebar: () => {\n                const sidebar = document.getElementById('sidebar');\n                const overlay = document.getElementById('sidebarOverlay');\n                if (window.innerWidth <= 768) {\n                    sidebar.classList.toggle('show');\n                    overlay.classList.toggle('show');\n                    document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';\n                } else {\n                    document.getElementById('sidebar').classList.toggle('collapsed');\n                    document.getElementById('mainContent').classList.toggle('expanded');\n                }\n            },\n            showPage: (pageId, event) => {\n                if (event) event.preventDefault();\n                \n                document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));\n                document.getElementById(`${pageId}-page`).classList.add('active');\n\n                document.querySelectorAll('.menu-item').forEach(item => {\n                    item.classList.remove('active');\n                    if (item.getAttribute('data-menu') === pageId) {\n                        item.classList.add('active');\n                    }\n                });\n\n                const titles = { 'dashboard': 'Dashboard Analítico', 'settings': 'Configurações' };\n                document.getElementById('pageTitle').textContent = titles[pageId] || 'Página';\n\n                if (pageId === 'dashboard') {\n                    // Resize charts after transition\n                    setTimeout(() => Object.values(charts).forEach(chart => chart?.resize()), 400);\n                }\n            }\n        };\n        \n        // =================================================================\n        // DATA & DASHBOARD LOGIC\n        // =================================================================\n        const Dashboard = {\n            parseDecimalInput: (value) => {\n                if (typeof value === 'number') return value;\n                if (!value) return 0;\n                return parseFloat(String(value).replace(',', '.')) || 0;\n            },\n            formatDate: (dateString) => {\n                if (!dateString) return 'N/A';\n                try {\n                    const date = new Date(dateString);\n                    return isNaN(date) ? 'Data inválida' : new Date(date.getTime() + date.getTimezoneOffset() * 60000).toLocaleDateString('pt-BR');\n                } catch (e) {\n                    return 'Data inválida';\n                }\n            },\n            loadTasks: async () => {\n                console.log('🔄 Carregando tarefas do webhook...');\n                UI.showNotification('🔄 Carregando tarefas do servidor...', 'info');\n                try {\n                    const response = await fetch(WEBHOOK_GET_URL);\n                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n                    const data = await response.json();\n                    if (!Array.isArray(data)) throw new Error('Formato de dados inesperado.');\n                    \n                    tasks = data.map(task => ({\n                        ...task,\n                        estimatedHours: Dashboard.parseDecimalInput(task.estimatedHours),\n                        actualHours: Dashboard.parseDecimalInput(task.actualHours),\n                        status: task.status || 'NÃO INICIADO',\n                    }));\n                    \n                    UI.showNotification(`✅ ${tasks.length} tarefas carregadas!`, 'success');\n                } catch (error) {\n                    console.error('❌ Erro ao carregar tarefas:', error);\n                    UI.showNotification(`❌ Erro ao carregar tarefas: ${error.message}`, 'error');\n                    tasks = [];\n                }\n            },\n            updateAll: () => {\n                Dashboard.updateStats();\n                Dashboard.updateCharts();\n            },\n            updateStats: () => {\n                document.getElementById('totalTasks').textContent = tasks.length;\n                document.getElementById('notStartedTasks').textContent = tasks.filter(t => t.status === 'NÃO INICIADO').length;\n                document.getElementById('inProgressTasks').textContent = tasks.filter(t => t.status === 'EM ANDAMENTO').length;\n                document.getElementById('pausedTasks').textContent = tasks.filter(t => t.status === 'PARALIZADO').length;\n                document.getElementById('completedTasks').textContent = tasks.filter(t => t.status === 'CONCLUÍDO').length;\n                document.getElementById('overdueTasks').textContent = tasks.filter(t => {\n                    const endDate = new Date(t.endDate);\n                    const today = new Date();\n                    today.setHours(0, 0, 0, 0);\n                    return t.endDate && endDate < today && t.status !== 'CONCLUÍDO';\n                }).length;\n            },\n            updateCharts: () => {\n                const chartConfigs = {\n                    tasksChart: { type: 'line', data: Dashboard.getTasksChartData, options: { title: 'Tarefas Criadas' } },\n                    statusChart: { type: 'bar', data: Dashboard.getStatusChartData, options: { legendPos: 'none', title: 'Nº de Tarefas' } }\n                };\n                for (const id in chartConfigs) {\n                    Dashboard.renderChart(id, chartConfigs[id].type, chartConfigs[id].data, chartConfigs[id].options);\n                }\n            },\n            renderChart: (canvasId, type, dataCallback, options = {}) => {\n                const ctx = document.getElementById(canvasId)?.getContext('2d');\n                if (!ctx) return;\n                if (charts[canvasId]) charts[canvasId].destroy();\n                charts[canvasId] = new Chart(ctx, {\n                    type: type,\n                    data: dataCallback(),\n                    options: {\n                        responsive: true, maintainAspectRatio: false, indexAxis: options.indexAxis || 'x',\n                        plugins: {\n                            legend: { display: options.legendPos !== 'none', position: options.legendPos || 'top' },\n                            tooltip: { callbacks: { label: (c) => `${c.dataset.label || c.label || ''}: ${parseFloat(c.raw).toFixed(2).replace('.', ',')}${options.unit || ''}` } }\n                        },\n                        scales: type.includes('bar') || type.includes('line') ? { y: { beginAtZero: true, title: { display: !!options.title, text: options.title } } } : {}\n                    }\n                });\n            },\n            getTasksChartData: () => {\n                const monthData = {};\n                tasks.forEach(task => {\n                    if (!task.startDate) return;\n                    const date = new Date(task.startDate);\n                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;\n                    monthData[monthKey] = (monthData[monthKey] || 0) + 1;\n                });\n                const labels = Object.keys(monthData).sort();\n                return {\n                    labels: labels.map(l => new Date(`${l}-02`).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })),\n                    datasets: [{ label: 'Tarefas Criadas', data: labels.map(l => monthData[l]), borderColor: 'rgb(13, 110, 253)', backgroundColor: 'rgba(13, 110, 253, 0.1)', tension: 0.3, fill: true }]\n                };\n            },\n            getStatusChartData: () => {\n                const statusCounts = tasks.reduce((acc, task) => {\n                    acc[task.status] = (acc[task.status] || 0) + 1;\n                    return acc;\n                }, {});\n                const labels = ['NÃO INICIADO', 'EM ANDAMENTO', 'PARALIZADO', 'CONCLUÍDO'];\n                const data = labels.map(status => statusCounts[status] || 0);\n                const colors = { 'NÃO INICIADO': '#6c757d', 'EM ANDAMENTO': '#ffc107', 'PARALIZADO': '#6f42c1', 'CONCLUÍDO': '#198754' };\n                return {\n                    labels: labels.map(l => l.replace('NÃO INICIADO', 'Não Iniciadas').replace('EM ANDAMENTO', 'Em Andamento').replace('PARALIZADO', 'Paralizadas').replace('CONCLUÍDO', 'Concluídas')),\n                    datasets: [{ label: 'Nº de Tarefas', data: data, backgroundColor: labels.map(label => colors[label]) }]\n                };\n            }\n        };\n\n        // =================================================================\n        // INITIALIZATION AND EVENT LISTENERS\n        // =================================================================\n        const App = {\n            initialize: async () => {\n                console.log('🚀 Iniciando ResolvTask Dashboard...');\n                if (!Auth.checkAuth()) {\n                    Auth.redirectToLogin();\n                    return;\n                }\n                \n                UI.showAuthenticatedInterface();\n                UI.updateUserInfo();\n                App.setupEventListeners();\n                \n                try {\n                    UI.applyUIPermissions();\n                    await Dashboard.loadTasks();\n                    Dashboard.updateAll();\n                    console.log('✅ Aplicação inicializada com sucesso.');\n                } catch (error) {\n                    console.error('❌ Erro fatal durante a inicialização:', error);\n                    UI.showNotification('❌ Erro crítico ao carregar o sistema.', 'error');\n                }\n            },\n            setupEventListeners: () => {\n                document.getElementById('logoutButton').addEventListener('click', Auth.logout);\n                document.getElementById('sidebarToggle').addEventListener('click', UI.toggleSidebar);\n                document.getElementById('sidebarOverlay').addEventListener('click', UI.toggleSidebar);\n            }\n        };\n\n        // --- Start the application ---\n        await App.initialize();\n    });\n    </script>\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -1936,
        2400
      ],
      "id": "98777955-c63a-4051-b9c1-12247b669746",
      "name": "Dashboard HTML"
    },
    {
      "parameters": {
        "path": "/gerenciadortarefas",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2560,
        2592
      ],
      "id": "c33ee3d6-6fac-491d-b89c-b89e260d773d",
      "name": "Check-in",
      "webhookId": "cce5e6b5-f99a-48a3-8b18-cf524f03c4ce"
    },
    {
      "parameters": {
        "path": "/resolv",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2560,
        2400
      ],
      "id": "cd98b29a-e6b5-47e6-972b-b76479723d8d",
      "name": "Dashboard",
      "webhookId": "cce5e6b5-f99a-48a3-8b18-cf524f03c4ce"
    },
    {
      "parameters": {
        "path": "/taskhoras",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2560,
        2816
      ],
      "id": "a55644da-913a-43bc-a092-4350627f94d6",
      "name": "Timeline",
      "webhookId": "cce5e6b5-f99a-48a3-8b18-cf524f03c4ce"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Dashboard - Gestão de Equipe</title>\n    \n    <!-- Bootstrap CSS -->\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    \n    <!-- DataTables CSS -->\n    <link href=\"https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css\" rel=\"stylesheet\">\n    \n    <!-- Font Awesome -->\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    \n    <!-- Chart.js -->\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n    \n    <style>\n        :root {\n            --primary-color: #0d6efd; /* Cor padrão que será substituída */\n            --secondary-color: #6c757d;\n            --success-color: #198754;\n            --danger-color: #dc3545;\n            --warning-color: #ffc107;\n            --info-color: #0dcaf0;\n            --light-color: #f8f9fa;\n            --dark-color: #212529;\n        }\n        \n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        \n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background-color: var(--light-color);\n            overflow-x: hidden;\n        }\n        \n        /* Loading inicial quando não logado */\n        .auth-loading {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            color: white;\n        }\n        \n        .auth-loading .spinner-auth {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(255, 255, 255, 0.3);\n            border-top: 4px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n        \n        .auth-loading h4 {\n            margin-bottom: 10px;\n            font-weight: 300;\n        }\n        \n        .auth-loading p {\n            opacity: 0.8;\n            font-size: 0.9rem;\n        }\n        \n        /* Sidebar */\n        .sidebar {\n            height: 100vh;\n            width: 280px;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            position: fixed;\n            left: 0;\n            top: 0;\n            transition: transform 0.3s ease, background 0.5s ease;\n            z-index: 1000;\n            overflow-y: auto;\n            display: flex;\n            flex-direction: column;\n        }\n        \n        .sidebar.collapsed {\n            transform: translateX(-100%);\n        }\n        \n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            background-color: white;\n            border-bottom: 1px solid #dee2e6;\n        }\n        .sidebar-header .logo {\n            max-width: 150px;\n            height: auto;\n            margin-bottom: 10px;\n        }\n        .sidebar-header .text-light {\n            color: var(--dark-color) !important;\n            font-weight: 500;\n        }\n        \n        .sidebar-menu {\n            padding: 20px 0;\n            flex-grow: 1;\n        }\n        \n        .menu-item {\n            display: block;\n            padding: 15px 25px;\n            color: rgba(255,255,255,0.8);\n            text-decoration: none;\n            transition: all 0.3s ease;\n            border: none;\n            background: none;\n            width: 100%;\n            text-align: left;\n            cursor: pointer;\n        }\n        \n        .menu-item:hover,\n        .menu-item.active {\n            background-color: rgba(255,255,255,0.1);\n            color: white;\n        }\n\n        .menu-item i {\n            width: 20px;\n            margin-right: 15px;\n        }\n\n        /* Ocultar menus inicialmente para evitar flash */\n        .sidebar-menu .menu-item {\n            display: none;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n        .sidebar-menu .menu-item.show {\n            display: block;\n            opacity: 1;\n        }\n\n        /* Loading state da sidebar */\n        .sidebar-loading {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 40px 20px;\n            color: rgba(255, 255, 255, 0.8);\n            font-size: 0.9rem;\n        }\n        .sidebar-loading .spinner-small {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid rgba(255, 255, 255, 0.8);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-right: 10px;\n        }\n        \n        /* Main Content */\n        .main-content {\n            margin-left: 280px;\n            transition: margin-left 0.3s ease;\n            min-height: 100vh;\n        }\n        \n        .main-content.expanded {\n            margin-left: 0;\n        }\n        \n        /* Top Navigation */\n        .top-nav {\n            background: white;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            padding: 15px 25px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            position: sticky;\n            top: 0;\n            z-index: 999;\n        }\n        \n        .sidebar-toggle {\n            display: none;\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n        }\n        \n        .user-info {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n        \n        /* Content Area */\n        .content-area {\n            padding: 25px;\n        }\n        \n        /* Cards */\n        .card {\n            border: none;\n            border-radius: 15px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n            margin-bottom: 25px;\n            transition: transform 0.3s ease;\n        }\n        \n        .card:hover {\n            transform: translateY(-5px);\n        }\n        \n        .stat-card {\n            color: white;\n            text-align: center;\n            padding: 25px;\n        }\n\n        .stat-card.primary {\n             background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);\n        }\n        \n        .stat-card.success {\n            background: linear-gradient(135deg, var(--success-color) 0%, #157347 100%);\n        }\n        \n        .stat-card.warning {\n            background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);\n            color: #212529;\n        }\n        \n        .stat-card.danger {\n            background: linear-gradient(135deg, var(--danger-color) 0%, #b02a37 100%);\n        }\n        \n        .stat-card.info { \n            background: linear-gradient(135deg, var(--info-color) 0%, #0aa2c0 100%);\n        }\n        \n        .stat-number {\n            font-size: 2.5rem;\n            font-weight: 700;\n            margin-bottom: 10px;\n        }\n        \n        .stat-label {\n            font-size: 1.1rem;\n            opacity: 0.9;\n        }\n        \n        .stat-icon {\n            font-size: 3rem;\n            opacity: 0.3;\n            position: absolute;\n            right: 20px;\n            top: 20px;\n        }\n        \n        /* Team Management Specific Styles */\n        .team-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));\n            gap: 25px;\n        }\n        \n        .member-card {\n            background: white;\n            border-radius: 15px;\n            padding: 25px;\n            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);\n            transition: all 0.3s ease;\n            border: 1px solid #f0f0f0;\n        }\n        \n        .member-card:hover {\n            transform: translateY(-5px);\n            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);\n        }\n        \n        .member-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 20px;\n        }\n        \n        .member-avatar {\n            width: 60px;\n            height: 60px;\n            background: linear-gradient(135deg, #3498db, #2980b9);\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-size: 24px;\n            font-weight: bold;\n            margin-right: 15px;\n        }\n        \n        .member-info {\n            flex: 1;\n        }\n        \n        .member-name {\n            font-size: 18px;\n            font-weight: 600;\n            color: #2c3e50;\n            margin-bottom: 5px;\n        }\n        \n        .member-phone {\n            color: #7f8c8d;\n            font-size: 14px;\n            display: flex;\n            align-items: center;\n            gap: 5px;\n        }\n        \n        .status-toggle {\n            position: relative;\n            width: 60px;\n            height: 30px;\n            background: #e74c3c;\n            border-radius: 15px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            border: none;\n            outline: none;\n        }\n        \n        .status-toggle.active {\n            background: #27ae60;\n        }\n        \n        .status-toggle::before {\n            content: '';\n            position: absolute;\n            top: 3px;\n            left: 3px;\n            width: 24px;\n            height: 24px;\n            background: white;\n            border-radius: 50%;\n            transition: all 0.3s ease;\n            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);\n        }\n        \n        .status-toggle.active::before {\n            transform: translateX(30px);\n        }\n        \n        .member-actions {\n            display: flex;\n            gap: 10px;\n            margin-top: 20px;\n        }\n        \n        .btn {\n            border-radius: 10px;\n            padding: 12px 25px;\n            font-weight: 600;\n            transition: all 0.3s ease;\n        }\n        \n        .btn-primary {\n            background-color: var(--primary-color);\n            border-color: var(--primary-color);\n        }\n        \n        .btn-primary:hover {\n            background-color: #0b5ed7;\n            border-color: #0b5ed7;\n            transform: translateY(-2px);\n        }\n        \n        .btn-config {\n            background: linear-gradient(135deg, #f39c12, #e67e22);\n            color: white;\n            border: none;\n        }\n        \n        .btn-config:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);\n        }\n        \n        /* Form Styles */\n        .form-control, .form-select, .form-check-input {\n            border: 2px solid #f1f3f4;\n            border-radius: 10px;\n            padding: 12px 15px;\n            transition: all 0.3s ease;\n        }\n        \n        .form-control:focus, .form-select:focus, .form-check-input:focus {\n            border-color: var(--primary-color);\n            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);\n        }\n        \n        /* Loading Animation */\n        .loading {\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            height: 300px;\n            flex-direction: column;\n        }\n        \n        .spinner {\n            width: 40px;\n            height: 40px;\n            border: 4px solid #f3f3f3;\n            border-top: 4px solid var(--primary-color);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n        \n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n        \n        /* Responsive Design */\n        @media (max-width: 768px) {\n            .sidebar {\n                transform: translateX(-100%);\n                z-index: 1050;\n            }\n            \n            .sidebar.show {\n                transform: translateX(0);\n            }\n            \n            .main-content {\n                margin-left: 0;\n            }\n            \n            .sidebar-toggle {\n                display: block;\n            }\n            \n            .content-area {\n                padding: 15px;\n            }\n            \n            .team-grid {\n                grid-template-columns: 1fr;\n            }\n        }\n        \n        /* Notifications */\n        .notification {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            z-index: 9999;\n            min-width: 300px;\n            max-width: 400px;\n        }\n        \n        /* Search box */\n        .search-container {\n            position: relative;\n            margin-bottom: 20px;\n        }\n        \n        .search-container input {\n            padding-left: 45px;\n        }\n        \n        .search-container i {\n            position: absolute;\n            left: 15px;\n            top: 50%;\n            transform: translateY(-50%);\n            color: #6c757d;\n        }\n        \n        /* Overlay para mobile quando sidebar está aberta */\n        @media (max-width: 768px) {\n            .sidebar-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-color: rgba(0, 0, 0, 0.5);\n                z-index: 1040;\n                opacity: 0;\n                visibility: hidden;\n                transition: all 0.3s ease;\n            }\n            \n            .sidebar-overlay.show {\n                opacity: 1;\n                visibility: visible;\n            }\n        }\n        /* Ocultar interface principal quando não logado */\n        .app-container {\n            opacity: 0;\n            transition: opacity 0.5s ease;\n        }\n        \n        .app-container.authenticated {\n            opacity: 1;\n        }\n    </style>\n</head>\n<body>\n    <!-- Tela de loading/autenticação -->\n    <div class=\"auth-loading\" id=\"authLoading\">\n        <div class=\"spinner-auth\"></div>\n        <h4>Gestão de Equipe</h4>\n        <p>Verificando autenticação...</p>\n    </div>\n\n    <!-- Interface principal (oculta até autenticação) -->\n    <div class=\"app-container\" id=\"appContainer\">\n        <!-- Sidebar -->\n        <nav class=\"sidebar\" id=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <img src=\"https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png\" alt=\"ResolvAI Logo\" class=\"logo\">\n                <br><br>\n                <h1><i class=\"fas fa-bolt me-2\"></i>Task</h1>\n                <small class=\"text-light\">Sistema Integrado de Gestão</small>\n            </div>\n            <div class=\"sidebar-menu\" id=\"sidebarMenu\">\n            <div class=\"sidebar-loading\" id=\"sidebarLoading\">\n                <div class=\"spinner-small\"></div>\n                Carregando menu...\n            </div>\n            <!-- Dashboard - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/resolv'\" data-menu=\"dashboard\">\n                <i class=\"fas fa-chart-line\"></i>Dashboard\n            </button>\n            <!-- Gerenciador de Tarefas - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gerenciadortarefas'\" data-menu=\"tasks\">\n                <i class=\"fas fa-tasks\"></i>Gerenciador de Tarefas\n            </button>\n            <!-- Gerenciador de Horas - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/taskhoras'\" data-menu=\"hours\">\n                <i class=\"fas fa-clock\"></i>Gerenciador de Horas\n            </button>\n            <!-- Gestão de Clientes - Link externo (selecionado por padrão) -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gestao_clientes'\" data-menu=\"clients\">\n                <i class=\"fas fa-handshake\"></i>Gestão de Clientes\n            </button>\n            <!-- Gestão de Parceiros - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gestaodeparceiros'\" data-menu=\"partners\">\n                <i class=\"fas fa-handshake-angle\"></i>Gestão de Parceiros\n            </button>\n            <!-- Equipe - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/equipe'\" data-menu=\"team\">\n                <i class=\"fas fa-users\"></i>Equipe\n            </button>\n            <!-- Configurações - Ação interna (showPage) -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/conf'\" data-menu=\"settings\">\n                <i class=\"fas fa-cog\"></i>Configurações\n            </button>\n            </div>\n        </nav>\n\n        <!-- Main Content -->\n        <main class=\"main-content\" id=\"mainContent\">\n            <!-- Top Navigation -->\n            <nav class=\"top-nav\">\n                <div class=\"d-flex align-items-center\">\n                    <button class=\"sidebar-toggle\" id=\"sidebarToggle\">\n                        <i class=\"fas fa-bars\"></i>\n                    </button>\n                    <h5 class=\"mb-0 ms-3\" id=\"pageTitle\">Gestão de Equipe</h5>\n                </div>\n                <div class=\"user-info\">\n                    <button class=\"btn btn-outline-primary btn-sm me-2\" onclick=\"debugWebhook()\" title=\"Testar Conexão\">\n                        <i class=\"fas fa-plug me-1\"></i>Testar\n                    </button>\n                    <button class=\"btn btn-outline-secondary btn-sm me-2\" onclick=\"reloadColaboradores()\" title=\"Recarregar Colaboradores\">\n                        <i class=\"fas fa-users me-1\"></i>Colaboradores\n                    </button>\n                    <button class=\"btn btn-outline-info btn-sm me-2\" onclick=\"carregarEquipe()\" title=\"Atualizar Dados\">\n                        <i class=\"fas fa-sync-alt me-1\"></i>Atualizar\n                    </button>\n                    <div class=\"d-flex align-items-center\">\n                        <i class=\"fas fa-user-circle fs-4 text-primary me-2\"></i>\n                        <span class=\"fw-bold\" id=\"userNameDisplay\">Usuário</span>\n                    </div>\n                    <small id=\"currentDate\" class=\"text-muted\"></small>\n                    <button class=\"btn btn-outline-danger btn-sm ms-2\" id=\"logoutButton\" title=\"Sair\">\n                        <i class=\"fas fa-sign-out-alt me-1\"></i>Sair\n                    </button>\n                </div>\n            </nav>\n\n            <!-- Content Area -->\n            <div class=\"content-area\">\n                <!-- Stats Cards Row -->\n                <div class=\"row g-4 mb-4\">\n                    <div class=\"col-lg-4 col-md-6\">\n                        <div class=\"card stat-card primary\">\n                            <div class=\"position-relative\">\n                                <div class=\"stat-number\" id=\"totalMembers\">0</div>\n                                <div class=\"stat-label\">Total de Colaboradores</div>\n                                <i class=\"fas fa-users stat-icon\"></i>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"col-lg-4 col-md-6\">\n                        <div class=\"card stat-card success\">\n                            <div class=\"position-relative\">\n                                <div class=\"stat-number\" id=\"activeMembers\">0</div>\n                                <div class=\"stat-label\">Colaboradores Ativos</div>\n                                <i class=\"fas fa-check-circle stat-icon\"></i>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"col-lg-4 col-md-6\">\n                        <div class=\"card stat-card danger\">\n                            <div class=\"position-relative\">\n                                <div class=\"stat-number\" id=\"inactiveMembers\">0</div>\n                                <div class=\"stat-label\">Colaboradores Inativos</div>\n                                <i class=\"fas fa-times-circle stat-icon\"></i>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Search and Actions -->\n                <div class=\"card mb-4\">\n                    <div class=\"card-body\">\n                        <div class=\"row align-items-center\">\n                            <div class=\"col-md-6\">\n                                <div class=\"search-container\">\n                                    <i class=\"fas fa-search\"></i>\n                                    <input type=\"text\" class=\"form-control\" id=\"searchInput\" placeholder=\"Buscar por nome ou WhatsApp...\">\n                                </div>\n                            </div>\n                            <div class=\"col-md-6 text-md-end\">\n                                <button class=\"btn btn-primary\" onclick=\"abrirModalCadastro()\">\n                                    <i class=\"fas fa-user-plus me-2\"></i>Novo Colaborador\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Team Grid -->\n                <div id=\"teamContainer\">\n                    <div class=\"loading\">\n                        <div class=\"spinner\"></div>\n                        <h5>Carregando equipe...</h5>\n                        <p class=\"text-muted\">Aguarde enquanto buscamos os dados da sua equipe</p>\n                    </div>\n                </div>\n            </div>\n        </main>\n\n        <!-- Sidebar Overlay -->\n        <div class=\"sidebar-overlay\" id=\"sidebarOverlay\"></div>\n\n        <!-- Modal de Cadastro de Colaborador -->\n        <div class=\"modal fade\" id=\"cadastroModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-xl\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-success text-white\">\n                        <h5 class=\"modal-title\">\n                            <i class=\"fas fa-user-plus me-2\"></i>Cadastrar Novo Colaborador\n                        </h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body p-0\">\n                        <div id=\"cadastroLoading\" class=\"text-center p-4\">\n                            <div class=\"spinner-border text-primary\" role=\"status\">\n                                <span class=\"visually-hidden\">Carregando...</span>\n                            </div>\n                            <p class=\"mt-2 text-muted\">Carregando formulário de cadastro...</p>\n                        </div>\n                        <iframe id=\"cadastroFrame\" \n                                src=\"{{ $json.dominio }}/webhook/res/cadastro\" \n                                style=\"width: 100%; min-height: 600px; border: none; display: none;\"\n                                onload=\"cadastroFrameLoaded()\">\n                        </iframe>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">\n                            <i class=\"fas fa-times me-2\"></i>Fechar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Modal de Configuração -->\n        <div class=\"modal fade\" id=\"configModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-lg\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-primary text-white\">\n                        <h5 class=\"modal-title\">\n                            <i class=\"fas fa-cog me-2\"></i>Configurar Colaborador\n                        </h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <form id=\"configForm\">\n                            <input type=\"hidden\" id=\"editId\">\n                            <div class=\"row g-3\">\n                                <div class=\"col-md-6\">\n                                    <label for=\"editNome\" class=\"form-label\">Nome Completo</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"editNome\" required>\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"editRazaoSocial\" class=\"form-label\">Razão Social</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"editRazaoSocial\">\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"editCnpj\" class=\"form-label\">CNPJ</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"editCnpj\">\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"editEmail\" class=\"form-label\">E-mail</label>\n                                    <input type=\"email\" class=\"form-control\" id=\"editEmail\">\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"editWhatsapp\" class=\"form-label\">WhatsApp</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"editWhatsapp\" required>\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"editTipo\" class=\"form-label\">Tipo</label>\n                                    <select class=\"form-select\" id=\"editTipo\">\n                                        <option value=\"colaborador\">Colaborador</option>\n                                        <option value=\"gerente\">Gerente</option>\n                                        <option value=\"admin\">Administrador</option>\n                                    </select>\n                                </div>\n                                <div class=\"col-md-12\">\n                                    <label for=\"editEndereco\" class=\"form-label\">Endereço</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"editEndereco\">\n                                </div>\n                                <div class=\"col-md-4\">\n                                    <label for=\"editNumero\" class=\"form-label\">Número</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"editNumero\">\n                                </div>\n                                <div class=\"col-md-4\">\n                                    <label for=\"editComplemento\" class=\"form-label\">Complemento</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"editComplemento\">\n                                </div>\n                                <div class=\"col-md-4\">\n                                    <label for=\"editCep\" class=\"form-label\">CEP</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"editCep\">\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"editPassword\" class=\"form-label\">Nova Senha (deixe em branco para não alterar)</label>\n                                    <input type=\"password\" class=\"form-control\" id=\"editPassword\" autocomplete=\"new-password\">\n                                    <small class=\"form-text text-muted\">Preencha apenas se desejar alterar a senha.</small>\n                                </div>\n                                <!-- CAMPO BOOLEANO CORRIGIDO -->\n                                <div class=\"col-md-6 d-flex align-items-center justify-content-center\">\n                                    <div class=\"form-check form-switch mt-4\">\n                                        <input class=\"form-check-input\" type=\"checkbox\" role=\"switch\" id=\"editColaborador\">\n                                        <label class=\"form-check-label\" for=\"editColaborador\">É um colaborador ativo?</label>\n                                    </div>\n                                </div>\n                            </div>\n                        </form>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">\n                            <i class=\"fas fa-times me-2\"></i>Cancelar\n                        </button>\n                        <button type=\"button\" class=\"btn btn-primary\" id=\"saveConfigBtn\">\n                            <i class=\"fas fa-save me-2\"></i>Salvar Alterações\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n\n        <!-- Modal de Confirmação de Desativação -->\n        <div class=\"modal fade\" id=\"confirmacaoModal\" data-bs-backdrop=\"static\" data-bs-keyboard=\"false\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-warning text-white\">\n                        <h5 class=\"modal-title\">\n                            <i class=\"fas fa-exclamation-triangle me-2\"></i>\n                            <span id=\"confirmacaoModalTitle\">Confirmar Desativação</span>\n                        </h5>\n                        <!-- Botão de fechar removido -->\n                    </div>\n                    <div class=\"modal-body text-center p-4\">\n                        <div class=\"mb-3\">\n                            <i class=\"fas fa-user-slash fa-3x text-warning\"></i>\n                        </div>\n                        <h5 id=\"confirmacaoModalMessage\">Tem certeza que deseja desativar este colaborador?</h5>\n                        <p class=\"text-muted mb-0\" id=\"confirmacaoModalDetails\">Esta ação suspenderá o acesso do colaborador ao sistema.</p>\n                    </div>\n                    <div class=\"modal-footer justify-content-center\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">\n                            <i class=\"fas fa-times me-2\"></i>Cancelar\n                        </button>\n                        <button type=\"button\" class=\"btn btn-warning\" id=\"confirmarDesativacaoBtn\">\n                            <i class=\"fas fa-check me-2\"></i>Sim, Desativar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Scripts -->\n    <script src=\"https://code.jquery.com/jquery-3.6.0.min.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n\n    <script>\n        // ===================================\n        // DYNAMIC THEME AND COLORS\n        // ===================================\n\n        /**\n         * Converte uma cor hexadecimal para um objeto RGB.\n         */\n        function hexToRgb(hex) {\n            const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;\n        }\n\n        /**\n         * Escurece ou clareia uma cor hexadecimal.\n         */\n        function shadeHexColor(hex, percent) {\n            let f = parseInt(hex.slice(1), 16),\n                t = percent < 0 ? 0 : 255,\n                p = percent < 0 ? percent * -1 : percent,\n                R = f >> 16,\n                G = (f >> 8) & 0x00ff,\n                B = f & 0x0000ff;\n            return (\"#\" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + (Math.round((t - G) * p) + G) * 0x100 + (Math.round((t - B) * p) + B)).toString(16).slice(1));\n        }\n\n        /**\n         * Busca a configuração de cores e aplica os estilos dinamicamente.\n         */\n        async function applyDynamicStyles() {\n            const url = '{{ $json.dominio }}/webhook/consultaconfiguracoes';\n            try {\n                const response = await fetch(url);\n                if (!response.ok) throw new Error(`Network response was not ok, status: ${response.status}`);\n                \n                const data = await response.json();\n                if (data && data.length > 0 && data[0].primary_color) {\n                    const primaryColor = data[0].primary_color;\n                    console.log(\"🎨 Cor primária recebida:\", primaryColor);\n                    \n                    const darkerColor = shadeHexColor(primaryColor, -0.15);\n                    const primaryRgb = hexToRgb(primaryColor);\n\n                    if (!primaryRgb) {\n                        console.error(\"Cor primária inválida:\", primaryColor);\n                        return;\n                    }\n\n                    // Atualiza a variável root\n                    document.documentElement.style.setProperty('--primary-color', primaryColor);\n                    \n                    // Injeta estilos que dependem de variações da cor\n                    const style = document.createElement('style');\n                    style.innerHTML = `\n                        .auth-loading, .sidebar {\n                            background: linear-gradient(135deg, ${primaryColor} 0%, ${darkerColor} 100%) !important;\n                        }\n                        .btn-primary:hover {\n                            background-color: ${darkerColor} !important;\n                            border-color: ${darkerColor} !important;\n                        }\n                        .form-control:focus, .form-select:focus {\n                            border-color: ${primaryColor} !important;\n                            box-shadow: 0 0 0 0.2rem rgba(${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}, 0.25) !important;\n                        }\n                        .member-avatar {\n                            background: linear-gradient(135deg, ${primaryColor}, ${darkerColor});\n                        }\n                        .text-primary, .spinner {\n                           color: ${primaryColor} !important;\n                        }\n                        .modal-header.bg-primary {\n                           background-color: ${primaryColor} !important;\n                        }\n                         .spinner {\n                           border-top-color: ${primaryColor} !important;\n                         }\n\n                    `;\n                    document.head.appendChild(style);\n                } else {\n                    console.warn('⚠️ Não foi possível encontrar a cor primária. Usando cores padrão.');\n                }\n            } catch (error) {\n                console.error('❌ Falha ao buscar ou aplicar estilos dinâmicos:', error);\n            }\n        }\n\n        // ===================================\n        // SAFE STORAGE FOR SANDBOXED IFRAMES\n        // ===================================\n        const SafeStorage = (() => {\n            let memoryStorage = {};\n            let isLocalStorageAvailable = false;\n\n            try {\n                const test = '__storage_test__';\n                localStorage.setItem(test, test);\n                localStorage.removeItem(test);\n                isLocalStorageAvailable = true;\n            } catch (e) {\n                isLocalStorageAvailable = false;\n                console.warn('⚠️ localStorage não disponível, usando armazenamento em memória (sessão será perdida em navegações)');\n            }\n\n            return {\n                getItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        return localStorage.getItem(key);\n                    }\n                    return memoryStorage[key] || null;\n                },\n                setItem: (key, value) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.setItem(key, value);\n                    } else {\n                        memoryStorage[key] = value;\n                    }\n                },\n                removeItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.removeItem(key);\n                    } else {\n                        delete memoryStorage[key];\n                    }\n                },\n                clear: () => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.clear();\n                    } else {\n                        memoryStorage = {};\n                    }\n                }\n            };\n        })();\n        \n        // ===================================\n        // AUTHENTICATION AND GLOBAL SETTINGS\n        // ===================================\n        const LOGIN_URL = '{{ $json.dominio }}/webhook/login';\n        \n        /**\n         * Verifica o status de login do usuário\n         * @returns {boolean} true se logado, false caso contrário\n         */\n        function checkLoginStatus() {\n            const userEmail = SafeStorage.getItem('loggedInUserEmail');\n            const userName = SafeStorage.getItem('loggedInUserName');\n            \n            console.log('🔐 Verificando status de login...');\n            console.log('📧 Email:', userEmail);\n            console.log('👤 Nome:', userName);\n            \n            return !!(userEmail && userName);\n        }\n\n        /**\n         * Limpa todos os dados da aplicação e redireciona para login\n         */\n        function redirectToLogin() {\n            console.log('🔄 Redirecionando para página de login...');\n            \n            // Limpar TODOS os dados do SafeStorage relacionados à aplicação\n            clearApplicationData();\n            \n            // Mostrar mensagem de redirecionamento\n            const authLoadingEl = document.getElementById('authLoading');\n            if (authLoadingEl) {\n                authLoadingEl.innerHTML = `\n                    <div class=\"spinner-auth\"></div>\n                    <h4>Redirecionando...</h4>\n                    <p>Você será redirecionado para a página de login</p>\n                `;\n            }\n            \n            // Redirecionar após um pequeno delay\n            setTimeout(() => {\n                window.location.href = LOGIN_URL;\n            }, 1500);\n        }\n\n        /**\n         * Limpa todos os dados da aplicação\n         */\n        function clearApplicationData() {\n            console.log('🧹 Limpando dados da aplicação...');\n            \n            // Limpar dados de autenticação\n            SafeStorage.removeItem('loggedInUserEmail');\n            SafeStorage.removeItem('loggedInUserName');\n            SafeStorage.removeItem('loggedInUserTipo');\n            SafeStorage.removeItem('welcomeMessageShown');\n            \n            // Limpar dados da aplicação\n            SafeStorage.removeItem('equipeData');\n            \n            // Resetar variáveis globais\n            equipeData = [];\n            currentMember = null;\n            \n            // Limpar interface\n            clearInterface();\n        }\n\n        /**\n         * Limpa a interface da aplicação\n         */\n        function clearInterface() {\n            // Limpar estatísticas\n            const statElements = ['totalMembers', 'activeMembers', 'inactiveMembers'];\n            statElements.forEach(id => {\n                const el = document.getElementById(id);\n                if (el) el.textContent = '0';\n            });\n            \n            // Limpar container da equipe\n            const teamContainer = document.getElementById('teamContainer');\n            if (teamContainer) {\n                teamContainer.innerHTML = `\n                    <div class=\"loading\">\n                        <div class=\"spinner\"></div>\n                        <h5>Carregando equipe...</h5>\n                        <p class=\"text-muted\">Aguarde enquanto buscamos os dados da sua equipe</p>\n                    </div>\n                `;\n            }\n            \n            // Limpar campo de busca\n            const searchInput = document.getElementById('searchInput');\n            if (searchInput) {\n                searchInput.value = '';\n            }\n            \n            // Resetar display do usuário\n            const userNameDisplay = document.getElementById('userNameDisplay');\n            if (userNameDisplay) {\n                userNameDisplay.textContent = 'Usuário';\n            }\n        }\n\n        /**\n         * Atualiza informações do usuário na interface\n         */\n        function updateUserInfo() {\n            const userName = SafeStorage.getItem('loggedInUserName');\n            const userNameDisplay = document.getElementById('userNameDisplay');\n            \n            if (userName && userNameDisplay) {\n                userNameDisplay.textContent = userName;\n                console.log('👤 Informações do usuário atualizadas:', userName);\n            } else {\n                console.warn('⚠️ Não foi possível atualizar informações do usuário');\n            }\n        }\n\n        /**\n         * Função de logout\n         */\n        function logout() {\n            console.log('🚪 Iniciando processo de logout...');\n            \n            // Mostrar notificação de logout\n            showNotification('✅ Logout efetuado com sucesso! Redirecionando...', 'success');\n            \n            // Aguardar um pouco para mostrar a notificação e então limpar e redirecionar\n            setTimeout(() => {\n                redirectToLogin();\n            }, 1500);\n        }\n\n        /**\n         * Mostra a interface principal após autenticação bem-sucedida\n         */\n        function showAuthenticatedInterface() {\n            console.log('✅ Mostrando interface autenticada');\n            \n            const authLoading = document.getElementById('authLoading');\n            const appContainer = document.getElementById('appContainer');\n            \n            if (authLoading && appContainer) {\n                // Ocultar tela de loading\n                authLoading.style.display = 'none';\n                \n                // Mostrar interface principal\n                appContainer.classList.add('authenticated');\n                \n                console.log('🎉 Interface principal ativada com sucesso');\n            }\n        }\n\n        // Global Variables\n        let equipeData = [];\n        let currentMember = null;\n        let memberParaAlterarStatus = null;\n        \n        // Webhook URLs\n        const WEBHOOK_GET_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/consultacolaboradores';\n        const WEBHOOK_POST_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/atualizacadastro';\n        const WEBHOOK_STATUS_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/salvatarefas';\n\n        // ===================================\n        // ROLE-BASED ACCESS CONTROL (RBAC)\n        // ===================================\n        /**\n         * Fetches collaborator list, identifies the current user's role, and stores it.\n         */\n        async function initializeUserSession() {\n            const userEmail = SafeStorage.getItem('loggedInUserEmail');\n            if (!userEmail) {\n                throw new Error('Email do usuário não encontrado');\n            }\n\n            try {\n                console.log('🔍 Verificando permissões do usuário...', userEmail);\n                const response = await fetch(WEBHOOK_GET_URL);\n                if (!response.ok) {\n                    throw new Error(`Falha ao buscar dados de colaboradores: ${response.statusText}`);\n                }\n                const allColaboradores = await response.json();\n                const currentUser = allColaboradores.find(c => c.email && c.email.toLowerCase() === userEmail.toLowerCase());\n\n                if (currentUser) {\n                    SafeStorage.setItem('loggedInUserTipo', currentUser.tipo || 'colaborador');\n                    // Importante: armazenar o nome exato do colaborador para comparação\n                    SafeStorage.setItem('loggedInUserName', currentUser.nome);\n                    console.log(`👤 Usuário identificado: ${currentUser.nome} (${currentUser.tipo})`);\n                } else {\n                    // If user is not found in the list, default to restricted role and notify.\n                    SafeStorage.setItem('loggedInUserTipo', 'colaborador');\n                    showNotification('⚠️ Seu usuário não foi encontrado na lista de colaboradores. O acesso será limitado.', 'warning');\n                }\n            } catch (error) {\n                console.error('❌ Erro ao verificar permissões:', error);\n                showNotification('❌ Erro ao verificar permissões. O acesso foi limitado por segurança.', 'error');\n                // Default to most restrictive role on any error\n                SafeStorage.setItem('loggedInUserTipo', 'colaborador');\n            }\n        }\n        \n        /**\n         * Applies UI restrictions that are not context-dependent (e.g., hiding menu items).\n         */\n        function applyUIPermissions() {\n            const userType = SafeStorage.getItem('loggedInUserTipo') || 'admin'; // 'admin' ou 'colaborador'\n\n            // CORREÇÃO: O item 'partners' e 'team' foi adicionado para o perfil 'colaborador'.\n            const menuPermissions = {\n                admin: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'], // Admin tem acesso a tudo\n                colaborador: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'] // Adicionado 'clients', 'partners' e 'team'\n            };\n\n            const allowedMenus = menuPermissions[userType] || [];\n\n            const loadingElement = document.getElementById('sidebarLoading');\n            if (loadingElement) {\n                loadingElement.style.display = 'none';\n            }\n\n            document.querySelectorAll('#sidebarMenu .menu-item').forEach((item, index) => {\n                const menuData = item.getAttribute('data-menu');\n                // Se o usuário for admin, mostra todos os menus. Caso contrário, verifica as permissões.\n                if (userType === 'admin' || allowedMenus.includes(menuData)) {\n                    setTimeout(() => {\n                        item.classList.add('show');\n                    }, index * 50); // Efeito de animação stagger\n                } else {\n                    item.classList.remove('show');\n                }\n            });\n        }\n        \n        // ===================================\n        // UTILITY FUNCTIONS\n        // ===================================\n        function showNotification(message, type = 'success') {\n            const notification = document.createElement('div');\n            const alertType = type === 'error' ? 'danger' : type;\n            notification.className = `alert alert-${alertType} alert-dismissible fade show notification`;\n            notification.innerHTML = `\n                <i class=\"fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2\"></i>\n                ${message}\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n            `;\n            \n            document.body.appendChild(notification);\n            \n            setTimeout(() => {\n                const instance = bootstrap.Alert.getInstance(notification);\n                if(instance) instance.close();\n            }, 5000);\n        }\n\n        function showCurrentDate() {\n            const now = new Date();\n            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n            const currentDateEl = document.getElementById('currentDate');\n            if (currentDateEl) {\n                currentDateEl.textContent = now.toLocaleDateString('pt-BR', options);\n            }\n        }\n\n        function toggleSidebar() {\n            const sidebar = document.getElementById('sidebar');\n            const mainContent = document.getElementById('mainContent');\n            const overlay = document.getElementById('sidebarOverlay');\n            \n            if (window.innerWidth <= 768) {\n                sidebar.classList.toggle('show');\n                overlay.classList.toggle('show');\n                document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';\n            } else {\n                sidebar.classList.toggle('collapsed');\n                mainContent.classList.toggle('expanded');\n            }\n        }\n\n        function debugWebhook() {\n            console.log('🔧 Testando conectividade com webhooks...');\n            console.log('📡 Colaboradores GET URL:', WEBHOOK_GET_URL);\n            console.log('⚙️ Atualizar Cadastro URL:', WEBHOOK_POST_URL);\n            console.log('🔄 Status Update URL:', WEBHOOK_STATUS_URL);\n            console.log('📝 Cadastro Form URL: {{ $json.dominio }}/webhook/res/cadastro');\n            \n            const userType = SafeStorage.getItem('loggedInUserTipo');\n            const currentUserName = SafeStorage.getItem('loggedInUserName');\n            const userEmail = SafeStorage.getItem('loggedInUserEmail');\n            \n            console.log(`📊 Estado atual: ${equipeData.length} colaboradores carregados`);\n            console.log(`👤 Usuário: ${currentUserName} (${userEmail}) - Tipo: ${userType}`);\n            \n            showNotification('🔧 Testando conexão com servidor...', 'info');\n            fetch(WEBHOOK_GET_URL, {\n                method: 'GET',\n                headers: { 'Content-Type': 'application/json' }\n            })\n            .then(async response => {\n                console.log('Status do teste:', response.status);\n                const text = await response.text();\n                console.log('Resposta do teste:', text);\n                if (response.ok) {\n                    showNotification('✅ Conexão com servidor OK!', 'success');\n                } else {\n                    showNotification(`⚠️ Servidor respondeu com status: ${response.status}`, 'warning');\n                }\n            })\n            .catch(error => {\n                console.error('Erro no teste:', error);\n                showNotification('❌ Erro de conexão com servidor: ' + error.message, 'error');\n            });\n        }\n\n        function abrirModalCadastro() {\n            // Verificar permissões\n            const userType = SafeStorage.getItem('loggedInUserTipo');\n            if (userType !== 'admin') {\n                showNotification('❌ Acesso negado! Apenas administradores podem cadastrar novos colaboradores.', 'error');\n                return;\n            }\n\n            // Mostrar loading e abrir modal\n            document.getElementById('cadastroLoading').style.display = 'block';\n            document.getElementById('cadastroFrame').style.display = 'none';\n            \n            const cadastroModal = new bootstrap.Modal(document.getElementById('cadastroModal'));\n            cadastroModal.show();\n            \n            // Recarregar iframe para garantir conteúdo atualizado\n            const iframe = document.getElementById('cadastroFrame');\n            iframe.src = '{{ $json.dominio }}/webhook/res/cadastro';\n        }\n\n        function cadastroFrameLoaded() {\n            // Ocultar loading e mostrar iframe quando carregado\n            document.getElementById('cadastroLoading').style.display = 'none';\n            document.getElementById('cadastroFrame').style.display = 'block';\n            \n            console.log('✅ Formulário de cadastro carregado com sucesso');\n        }\n\n        function reloadColaboradores() {\n            console.log('🔄 Recarregando lista de colaboradores...');\n            showNotification('🔄 Recarregando colaboradores...', 'info');\n            carregarEquipe().then(() => {\n                showNotification('✅ Lista de colaboradores atualizada!', 'success');\n            }).catch(() => {\n                showNotification('❌ Erro ao recarregar colaboradores', 'error');\n            });\n        }\n        \n        // ===================================\n        // DATA LOGIC\n        // ===================================\n        async function carregarEquipe() {\n            try {\n                showLoading();\n                console.log('🔄 Carregando dados da equipe...');\n                \n                const response = await fetch(WEBHOOK_GET_URL);\n                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);\n                \n                equipeData = await response.json();\n                console.log('✅ Dados carregados:', equipeData);\n                \n                renderizarEquipe();\n                atualizarEstatisticas();\n                showNotification(`✅ ${equipeData.length} colaboradores carregados com sucesso!`, 'success');\n                \n            } catch (error) {\n                console.error('❌ Erro ao carregar equipe:', error);\n                showError('Erro ao carregar dados da equipe. Verifique sua conexão.');\n                showNotification(`❌ Erro ao carregar dados: ${error.message}`, 'error');\n            }\n        }\n\n        // ===================================\n        // UI RENDERING\n        // ===================================\n        function showLoading() {\n            const teamContainer = document.getElementById('teamContainer');\n            if (teamContainer) {\n                teamContainer.innerHTML = `\n                    <div class=\"loading\">\n                        <div class=\"spinner\"></div>\n                        <h5>Carregando equipe...</h5>\n                        <p class=\"text-muted\">Aguarde enquanto buscamos os dados da sua equipe</p>\n                    </div>\n                `;\n            }\n        }\n\n        function showError(message) {\n            const teamContainer = document.getElementById('teamContainer');\n            if (teamContainer) {\n                teamContainer.innerHTML = `\n                    <div class=\"text-center py-5\">\n                        <i class=\"fas fa-exclamation-triangle fa-3x text-warning mb-3\"></i>\n                        <h5>Ops! Algo deu errado</h5>\n                        <p class=\"text-muted\">${message}</p>\n                        <button class=\"btn btn-primary\" onclick=\"carregarEquipe()\">\n                            <i class=\"fas fa-redo me-2\"></i>Tentar Novamente\n                        </button>\n                    </div>\n                `;\n            }\n        }\n\n        function renderizarEquipe(dados = equipeData) {\n            const container = document.getElementById('teamContainer');\n            if (!container) return;\n            \n            if (!dados || dados.length === 0) {\n                container.innerHTML = `\n                    <div class=\"text-center py-5\">\n                        <i class=\"fas fa-users fa-3x text-muted mb-3\"></i>\n                        <h5>Nenhum colaborador encontrado</h5>\n                        <p class=\"text-muted\">Não há colaboradores cadastrados no momento. ${dados === equipeData ? 'Tente atualizar ou adicione um novo.' : 'Nenhum resultado para sua busca.'}</p>\n                        <button class=\"btn btn-primary mt-2\" onclick=\"abrirModalCadastro()\">\n                            <i class=\"fas fa-user-plus me-2\"></i>Cadastrar Colaborador\n                        </button>\n                    </div>\n                `;\n                return;\n            }\n\n            const teamGrid = document.createElement('div');\n            teamGrid.className = 'team-grid';\n\n            dados.forEach(member => {\n                const memberCard = createMemberCard(member);\n                teamGrid.appendChild(memberCard);\n            });\n\n            container.innerHTML = '';\n            container.appendChild(teamGrid);\n        }\n\n        function createMemberCard(member) {\n            const card = document.createElement('div');\n            card.className = 'member-card';\n\n            const avatar = member.nome && typeof member.nome === 'string' \n                ? member.nome.split(' ')\n                    .map(word => word[0])\n                    .slice(0, 2)\n                    .join('')\n                    .toUpperCase() \n                : '??';\n\n            // Verificar permissões para mostrar botão de configuração\n            const userType = SafeStorage.getItem('loggedInUserTipo');\n            const configButton = userType === 'admin' \n                ? `<button class=\"btn btn-config flex-fill\" onclick=\"abrirModal('${member.id}')\">\n                                <i class=\"fas fa-cog\"></i>\n                                Configurar\n                            </button>`\n                : `<button class=\"btn btn-secondary flex-fill\" disabled title=\"Apenas administradores podem configurar\">\n                                <i class=\"fas fa-lock\"></i>\n                                Configuração Restrita\n                            </button>`;\n\n            // Verificar permissões para toggle de status\n            const statusToggle = userType === 'admin'\n                ? `<button class=\"status-toggle ${member.status ? 'active' : ''}\" \n                                onclick=\"handleStatusToggle('${member.id}', '${member.nome || ''}', '${member.whatsapp || ''}', ${member.status})\"\n                                title=\"${member.status ? 'Desativar' : 'Ativar'} colaborador\">\n                            </button>`\n                : `<div class=\"status-toggle ${member.status ? 'active' : ''}\" \n                                title=\"Status ${member.status ? 'ativo' : 'inativo'} - Apenas administradores podem alterar\">\n                            </div>`;\n\n            card.innerHTML = `\n                <div class=\"member-header\">\n                    <div style=\"display: flex; align-items: center;\">\n                        <div class=\"member-avatar\">${avatar}</div>\n                        <div class=\"member-info\">\n                            <div class=\"member-name\">${member.nome || 'Nome não disponível'}</div>\n                            <div class=\"member-phone\">\n                                <i class=\"fab fa-whatsapp\"></i>\n                                ${member.whatsapp || 'WhatsApp não disponível'}\n                            </div>\n                            ${member.email ? `<div class=\"text-muted small mt-1\"><i class=\"fas fa-envelope me-1\"></i>${member.email}</div>` : ''}\n                        </div>\n                    </div>\n                    ${statusToggle}\n                </div>\n                <div class=\"row text-center mt-3\">\n                    <div class=\"col\">\n                        <small class=\"text-muted\">Status</small>\n                        <div class=\"fw-bold ${member.status ? 'text-success' : 'text-danger'}\">\n                            ${member.status ? 'Ativo' : 'Inativo'}\n                        </div>\n                    </div>\n                    <div class=\"col\">\n                        <small class=\"text-muted\">Tipo</small>\n                        <div class=\"fw-bold text-primary\">\n                            ${member.tipo ? member.tipo.charAt(0).toUpperCase() + member.tipo.slice(1) : 'Colaborador'}\n                        </div>\n                    </div>\n                </div>\n                <div class=\"member-actions\">\n                    ${configButton}\n                </div>\n            `;\n\n            return card;\n        }\n\n        // ===================================\n        // DATA MANIPULATION\n        // ===================================\n        \n        function handleStatusToggle(id, nome, whatsapp, statusAtual) {\n            if (statusAtual === true) { // Se está ativo, vamos desativar\n                abrirModalConfirmacaoStatus(id, nome, whatsapp);\n            } else { // Se está inativo, vamos ativar diretamente\n                alterarStatus(id, nome, whatsapp, true);\n            }\n        }\n\n        function abrirModalConfirmacaoStatus(id, nome, whatsapp) {\n            memberParaAlterarStatus = { id, nome, whatsapp }; // Armazena os dados\n\n            const modalEl = document.getElementById('confirmacaoModal');\n            const messageEl = document.getElementById('confirmacaoModalMessage');\n            \n            messageEl.textContent = `Tem certeza que deseja desativar ${nome}?`;\n\n            const confirmacaoModal = new bootstrap.Modal(modalEl);\n            confirmacaoModal.show();\n        }\n\n        async function alterarStatus(id, nome, whatsapp, novoStatus) {\n            // Verificar permissões\n            const userType = SafeStorage.getItem('loggedInUserTipo');\n            if (userType !== 'admin') {\n                showNotification('❌ Acesso negado! Apenas administradores podem alterar status de colaboradores.', 'error');\n                return;\n            }\n\n            try {\n                console.log(`🔄 Alterando status de ${nome} para ${novoStatus ? 'ativo' : 'inativo'}`);\n                \n                const dados = { \n                    id, \n                    nome, \n                    whatsapp, \n                    status: novoStatus, \n                    action: 'atualizar_status',\n                    timestamp: new Date().toISOString(),\n                    userEmail: SafeStorage.getItem('loggedInUserEmail')\n                };\n\n                // Enviar para o novo webhook de status\n                const response = await fetch(WEBHOOK_STATUS_URL, { \n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(dados)\n                });\n                \n                if (!response.ok) {\n                    const errorData = await response.text();\n                    throw new Error(`Erro HTTP: ${response.status}. Detalhes: ${errorData}`);\n                }\n                \n                // Atualizar dados locais\n                const memberIndex = equipeData.findIndex(m => m.id === id);\n                if (memberIndex !== -1) {\n                    equipeData[memberIndex].status = novoStatus;\n                }\n\n                // Se a operação foi de desativação, fecha o modal de confirmação\n                if (novoStatus === false) {\n                    const confirmacaoModal = bootstrap.Modal.getInstance(document.getElementById('confirmacaoModal'));\n                    if (confirmacaoModal) {\n                        confirmacaoModal.hide();\n                    }\n                }\n\n                // Atualizar interface\n                renderizarEquipe(); \n                atualizarEstatisticas();\n                \n                // Mostrar notificação de sucesso\n                showNotification(`✅ Status de ${nome} alterado para ${novoStatus ? 'ativo' : 'inativo'}.`, 'success');\n\n            } catch (error) {\n                console.error('❌ Erro ao alterar status:', error);\n                showNotification(`❌ Erro ao alterar status. ${error.message}`, 'error');\n            }\n        }\n\n        function abrirModal(memberId) {\n            // Verificar permissões\n            const userType = SafeStorage.getItem('loggedInUserTipo');\n            if (userType !== 'admin') {\n                showNotification('❌ Acesso negado! Apenas administradores podem configurar colaboradores.', 'error');\n                return;\n            }\n\n            const member = equipeData.find(m => m.id === memberId);\n            if (!member) {\n                showNotification('❌ Colaborador não encontrado para configuração.', 'error');\n                return;\n            }\n\n            currentMember = member;\n\n            document.getElementById('editId').value = member.id || '';\n            document.getElementById('editNome').value = member.nome || '';\n            document.getElementById('editRazaoSocial').value = member.razao_social || '';\n            document.getElementById('editCnpj').value = member.cnpj || '';\n            document.getElementById('editEndereco').value = member.endereco || '';\n            document.getElementById('editNumero').value = member.numero || '';\n            document.getElementById('editComplemento').value = member.complemento || '';\n            document.getElementById('editCep').value = member.cep || '';\n            document.getElementById('editWhatsapp').value = member.whatsapp || '';\n            document.getElementById('editEmail').value = member.email || '';\n            document.getElementById('editTipo').value = member.tipo || 'colaborador';\n            // Limpa o campo de senha por segurança\n            document.getElementById('editPassword').value = ''; \n            \n            // **CORREÇÃO DEFINITIVA**\n            // Adiciona logs para depuração\n            console.log(`[abrirModal] Abrindo para: ${member.nome}`);\n            console.log(`[abrirModal] Valor de 'member.colaborador':`, member.colaborador);\n            console.log(`[abrirModal] Tipo de 'member.colaborador':`, typeof member.colaborador);\n\n            // A lógica correta: o interruptor deve estar marcado se e somente se o valor for o booleano true.\n            document.getElementById('editColaborador').checked = member.colaborador === true;\n\n            console.log(`[abrirModal] Estado do interruptor definido para:`, document.getElementById('editColaborador').checked);\n\n\n            const configModal = new bootstrap.Modal(document.getElementById('configModal'));\n            configModal.show();\n        }\n\n        async function salvarConfiguracao() {\n            if (!currentMember) return;\n\n            // Verificar permissões\n            const userType = SafeStorage.getItem('loggedInUserTipo');\n            if (userType !== 'admin') {\n                showNotification('❌ Acesso negado! Apenas administradores podem salvar configurações.', 'error');\n                return;\n            }\n\n            const nome = document.getElementById('editNome').value.trim();\n            const whatsapp = document.getElementById('editWhatsapp').value.trim();\n            const password = document.getElementById('editPassword').value.trim(); // Get password value\n\n            if (!nome || !whatsapp) {\n                showNotification('❌ Nome e WhatsApp são obrigatórios.', 'warning');\n                return;\n            }\n\n            try {\n                const dadosAtualizados = {\n                    id: currentMember.id,\n                    nome,\n                    razao_social: document.getElementById('editRazaoSocial').value,\n                    cnpj: document.getElementById('editCnpj').value,\n                    endereco: document.getElementById('editEndereco').value,\n                    numero: document.getElementById('editNumero').value,\n                    complemento: document.getElementById('editComplemento').value,\n                    cep: document.getElementById('editCep').value,\n                    whatsapp,\n                    email: document.getElementById('editEmail').value,\n                    tipo: document.getElementById('editTipo').value,\n                    status: currentMember.status, \n                    colaborador: document.getElementById('editColaborador').checked, // Pega o valor do switch\n                    action: 'atualizar_colaborador',\n                    timestamp: new Date().toISOString(),\n                    userEmail: SafeStorage.getItem('loggedInUserEmail')\n                };\n\n                // Adiciona a senha ao payload APENAS se não estiver vazia\n                if (password) {\n                    dadosAtualizados.senha = password;\n                    console.log('🔒 Senha será atualizada.');\n                } else {\n                    console.log('🚫 Senha não será alterada (campo vazio).');\n                }\n\n                console.log('🔄 Preparando para enviar dados de atualização para:', WEBHOOK_POST_URL);\n                console.log('📝 Payload a ser enviado (sem senha no log para segurança):', { ...dadosAtualizados, senha: password ? '********' : 'não alterada' }); // Log sem a senha real\n\n                const response = await fetch(WEBHOOK_POST_URL, { \n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(dadosAtualizados)\n                });\n\n                console.log('📡 Resposta da requisição HTTP. Status:', response.status, 'Status Text:', response.statusText);\n\n                if (!response.ok) {\n                    const errorData = await response.text();\n                    throw new Error(`Erro HTTP: ${response.status}. Detalhes: ${errorData}`);\n                }\n                \n                // Atualizar dados locais\n                const memberIndex = equipeData.findIndex(m => m.id === currentMember.id);\n                if (memberIndex !== -1) {\n                    equipeData[memberIndex] = { ...equipeData[memberIndex], ...dadosAtualizados };\n                }\n\n                // Fechar modal\n                const configModal = bootstrap.Modal.getInstance(document.getElementById('configModal'));\n                if (configModal) configModal.hide();\n                \n                // Atualizar interface\n                renderizarEquipe(); \n                atualizarEstatisticas();\n                \n                showNotification('✅ Configurações salvas com sucesso!', 'success');\n\n            } catch (error) {\n                console.error('❌ Erro ao salvar configuração:', error);\n                showNotification(`❌ Erro ao salvar configurações. ${error.message}`, 'error');\n            }\n        }\n\n        function filtrarEquipe(termo) {\n            const termoLower = termo.toLowerCase().trim();\n            if (!termoLower) {\n                renderizarEquipe(equipeData); \n                return;\n            }\n\n            const dadosFiltrados = equipeData.filter(member => \n                (member.nome && member.nome.toLowerCase().includes(termoLower)) ||\n                (member.whatsapp && member.whatsapp.includes(termo)) || \n                (member.email && member.email.toLowerCase().includes(termoLower))\n            );\n\n            renderizarEquipe(dadosFiltrados);\n        }\n\n        function atualizarEstatisticas() {\n            const total = equipeData.length;\n            const ativos = equipeData.filter(m => m.status).length;\n            const inativos = total - ativos;\n\n            const totalEl = document.getElementById('totalMembers');\n            const activeEl = document.getElementById('activeMembers');\n            const inactiveEl = document.getElementById('inactiveMembers');\n\n            if (totalEl) totalEl.textContent = total;\n            if (activeEl) activeEl.textContent = ativos;\n            if (inactiveEl) inactiveEl.textContent = inativos;\n        }\n\n        // =========================\n        // INITIALIZATION\n        // =========================\n        /**\n         * Função principal de inicialização da aplicação\n         */\n        async function initializeApplication() {\n            console.log('🚀 Iniciando Sistema de Gestão de Equipe...');\n            \n            try {\n                // Step 1: Initialize session to determine user role (CRÍTICO - deve ser primeiro)\n                await initializeUserSession();\n                \n                // Step 2: Apply static UI permissions (agora com controle completo de menus)\n                applyUIPermissions();\n                \n                // Step 3: Load team data\n                await carregarEquipe();\n                \n                console.log('✅ Aplicação inicializada com sucesso');\n                \n            } catch (error) {\n                console.error('❌ Erro durante inicialização:', error);\n                showNotification('❌ Erro ao carregar sistema. Tentando continuar...', 'error');\n                \n                // Fallback: aplicar permissões de colaborador e continuar\n                SafeStorage.setItem('loggedInUserTipo', 'colaborador');\n                applyUIPermissions();\n            }\n        }\n\n        /**\n         * Configura todos os event listeners da aplicação\n         */\n        function setupEventListeners() {\n            console.log('🎯 Configurando event listeners...');\n            \n            const logoutButton = document.getElementById('logoutButton');\n            const sidebarToggle = document.getElementById('sidebarToggle');\n            const sidebarOverlay = document.getElementById('sidebarOverlay');\n            const searchInput = document.getElementById('searchInput');\n            const saveConfigBtn = document.getElementById('saveConfigBtn');\n            const cadastroModal = document.getElementById('cadastroModal');\n            const confirmarDesativacaoBtn = document.getElementById('confirmarDesativacaoBtn');\n            \n            if (logoutButton) {\n                logoutButton.addEventListener('click', logout);\n            }\n            if (sidebarToggle) {\n                sidebarToggle.addEventListener('click', toggleSidebar);\n            }\n            if (sidebarOverlay) {\n                sidebarOverlay.addEventListener('click', toggleSidebar);\n            }\n            if (searchInput) {\n                searchInput.addEventListener('input', (e) => filtrarEquipe(e.target.value));\n            }\n            if (saveConfigBtn) {\n                saveConfigBtn.addEventListener('click', salvarConfiguracao);\n            }\n            if (confirmarDesativacaoBtn) {\n                confirmarDesativacaoBtn.addEventListener('click', () => {\n                    if (memberParaAlterarStatus) {\n                        alterarStatus(memberParaAlterarStatus.id, memberParaAlterarStatus.nome, memberParaAlterarStatus.whatsapp, false);\n                    }\n                });\n            }\n            \n            // Event listener para recarregar dados quando modal de cadastro for fechado\n            if (cadastroModal) {\n                cadastroModal.addEventListener('hidden.bs.modal', function () {\n                    console.log('📋 Modal de cadastro fechado - recarregando dados...');\n                    carregarEquipe();\n                });\n            }\n            \n            console.log('✅ Event listeners configurados com sucesso');\n        }\n\n        /**\n         * Função principal executada quando o DOM é carregado\n         */\n        document.addEventListener('DOMContentLoaded', async function() {\n            console.log('📄 DOM carregado, verificando autenticação...');\n            \n            // Verificar se o usuário está logado ANTES de fazer qualquer coisa\n            if (!checkLoginStatus()) {\n                console.log('❌ Usuário não autenticado, redirecionando...');\n                redirectToLogin();\n                return;\n            }\n            \n            console.log('✅ Usuário autenticado, carregando aplicação...');\n            \n            // Mostrar interface autenticada\n            showAuthenticatedInterface();\n            \n            // Aplicar estilos dinâmicos (executa em paralelo)\n            applyDynamicStyles();\n            \n            // Configurar informações básicas da interface\n            updateUserInfo();\n            showCurrentDate();\n            \n            // Inicializar aplicação\n            await initializeApplication();\n            \n            // Configurar event listeners\n            setupEventListeners();\n        });\n    </script>\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -1904,
        3024
      ],
      "id": "fa75f8fa-a3ff-4b20-9870-d9fae8ff247d",
      "name": "Gestão de Equipe HTML"
    },
    {
      "parameters": {
        "path": "/equipe",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2560,
        3024
      ],
      "id": "ee53a3bd-d283-4900-8291-6485356c2fef",
      "name": "Gestão de Equipe",
      "webhookId": "cce5e6b5-f99a-48a3-8b18-cf524f03c4ce"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Cadastro de Colaboradores - ResolvTask</title>\n\n    <!-- Bootstrap CSS -->\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n\n    <!-- Font Awesome -->\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n\n    <style>\n        :root {\n            --primary-color: #0d6efd;\n            --secondary-color: #6c757d;\n            --success-color: #198754;\n            --danger-color: #dc3545;\n            --warning-color: #ffc107;\n            --info-color: #0dcaf0;\n            --light-color: #f8f9fa;\n            --dark-color: #212529;\n        }\n\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            min-height: 100vh;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n        }\n\n        .main-container {\n            background: white;\n            border-radius: 20px;\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);\n            overflow: hidden;\n            max-width: 800px;\n            width: 100%;\n            animation: fadeInUp 0.8s ease;\n        }\n\n        @keyframes fadeInUp {\n            from {\n                opacity: 0;\n                transform: translateY(30px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        .header {\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            color: white;\n            padding: 30px;\n            text-align: center;\n            position: relative;\n            overflow: hidden;\n        }\n\n        .header::before {\n            content: '';\n            position: absolute;\n            top: -50%;\n            left: -50%;\n            width: 200%;\n            height: 200%;\n            background: repeating-linear-gradient(\n                45deg,\n                transparent,\n                transparent 10px,\n                rgba(255,255,255,0.05) 10px,\n                rgba(255,255,255,0.05) 20px\n            );\n            animation: shimmer 20s linear infinite;\n        }\n        /* CSS para formatação da logo ResolvAI */\n        .logo {\n            /* Dimensões responsivas */\n            max-width: 200px;\n            width: auto;\n            height: auto;\n            \n            /* Manter proporção da imagem */\n            object-fit: contain;\n            \n            /* Centralização e espaçamento */\n            display: block;\n            margin: 0 auto 20px auto;\n            \n            /* Fundo branco para a logo */\n            background: white;\n            padding: 10px 20px;\n            border-radius: 12px;\n            \n            /* Efeitos visuais */\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n            transition: all 0.3s ease;\n        }\n\n        /* Efeito hover para interatividade */\n        .logo:hover {\n            transform: scale(1.05);\n            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);\n        }\n\n        /* Responsividade para diferentes tamanhos de tela */\n        @media (max-width: 768px) {\n            .logo {\n                max-width: 150px;\n                margin-bottom: 15px;\n                padding: 8px 15px;\n            }\n        }\n\n        @media (max-width: 480px) {\n            .logo {\n                max-width: 120px;\n                margin-bottom: 10px;\n                padding: 6px 12px;\n            }\n        }\n\n        @keyframes shimmer {\n            0% { transform: translateX(-100%); }\n            100% { transform: translateX(100%); }\n        }\n\n        .header h1 {\n            font-size: 2.5rem;\n            font-weight: 700;\n            margin-bottom: 10px;\n            position: relative;\n            z-index: 2;\n        }\n\n        .header p {\n            font-size: 1.1rem;\n            opacity: 0.9;\n            position: relative;\n            z-index: 2;\n            /* Texto em preto */\n            color: #000000 !important;\n            font-weight: 600;\n            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);\n            background: rgba(255, 255, 255, 0.9);\n            display: inline-block;\n            padding: 8px 16px;\n            border-radius: 8px;\n            margin-top: 10px;\n        }\n\n        .header .icon {\n            font-size: 4rem;\n            opacity: 0.2;\n            position: absolute;\n            right: 30px;\n            top: 50%;\n            transform: translateY(-50%);\n            z-index: 1;\n        }\n\n        .form-container {\n            padding: 40px;\n        }\n\n        .form-control, .form-select {\n            border: 2px solid #f1f3f4;\n            border-radius: 12px;\n            padding: 15px 20px;\n            font-size: 1rem;\n            transition: all 0.3s ease;\n            background-color: #fafafa;\n        }\n\n        .form-control:focus, .form-select:focus {\n            border-color: var(--primary-color);\n            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);\n            background-color: white;\n            transform: translateY(-2px);\n        }\n\n        .form-label {\n            font-weight: 600;\n            color: var(--dark-color);\n            margin-bottom: 8px;\n            font-size: 0.95rem;\n        }\n\n        .required-field::after {\n            content: \"*\";\n            color: var(--danger-color);\n            margin-left: 4px;\n            font-weight: bold;\n        }\n\n        .form-group {\n            margin-bottom: 25px;\n        }\n\n        .btn {\n            border-radius: 12px;\n            padding: 15px 30px;\n            font-weight: 600;\n            font-size: 1rem;\n            transition: all 0.3s ease;\n            border: none;\n            position: relative;\n            overflow: hidden;\n        }\n\n        .btn::before {\n            content: '';\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            width: 0;\n            height: 0;\n            background: rgba(255, 255, 255, 0.2);\n            border-radius: 50%;\n            transform: translate(-50%, -50%);\n            transition: width 0.6s, height 0.6s;\n        }\n\n        .btn:active::before {\n            width: 300px;\n            height: 300px;\n        }\n\n        .btn-primary {\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            color: white;\n            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);\n        }\n\n        .btn-primary:hover {\n            background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4);\n        }\n\n        .btn-secondary {\n            background: linear-gradient(135deg, var(--secondary-color) 0%, #5a6268 100%);\n            color: white;\n            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);\n        }\n\n        .btn-secondary:hover {\n            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);\n        }\n\n        .btn-container {\n            display: flex;\n            gap: 15px;\n            justify-content: center;\n            margin-top: 30px;\n        }\n\n        .form-control.is-invalid {\n            border-color: var(--danger-color);\n            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);\n            animation: shake 0.5s ease;\n        }\n\n        @keyframes shake {\n            0%, 20%, 40%, 60%, 80% { transform: translateX(0); }\n            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }\n        }\n\n        .notification {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            z-index: 9999;\n            min-width: 350px;\n            max-width: 450px;\n            border-radius: 12px;\n            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);\n        }\n\n        .floating-labels {\n            position: relative;\n        }\n\n        .floating-labels .form-control {\n            padding-top: 25px;\n            padding-bottom: 10px;\n        }\n\n        .floating-labels .form-label {\n            position: absolute;\n            top: 50%;\n            left: 20px;\n            transform: translateY(-50%);\n            transition: all 0.3s ease;\n            pointer-events: none;\n            background: transparent;\n            z-index: 2;\n        }\n\n        .floating-labels .form-control:focus ~ .form-label,\n        .floating-labels .form-control:not(:placeholder-shown) ~ .form-label {\n            top: 12px;\n            font-size: 0.8rem;\n            color: var(--primary-color);\n            transform: translateY(0);\n        }\n\n        /* Loading Animation */\n        .btn-loading {\n            position: relative;\n            color: transparent !important;\n        }\n\n        .btn-loading::after {\n            content: '';\n            position: absolute;\n            width: 20px;\n            height: 20px;\n            top: 50%;\n            left: 50%;\n            margin-left: -10px;\n            margin-top: -10px;\n            border: 2px solid transparent;\n            border-top-color: #ffffff;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        /* Responsive Design */\n        @media (max-width: 768px) {\n            .main-container {\n                margin: 10px;\n                border-radius: 15px;\n            }\n\n            .header {\n                padding: 25px 20px;\n            }\n\n            .header h1 {\n                font-size: 2rem;\n            }\n\n            .header .icon {\n                font-size: 3rem;\n                right: 20px;\n            }\n\n            .form-container {\n                padding: 25px 20px;\n            }\n\n            .btn-container {\n                flex-direction: column;\n            }\n\n            .btn {\n                width: 100%;\n            }\n        }\n\n        @media (max-width: 480px) {\n            .header h1 {\n                font-size: 1.8rem;\n            }\n\n            .form-container {\n                padding: 20px 15px;\n            }\n\n            .notification {\n                min-width: 300px;\n                right: 10px;\n                left: 10px;\n            }\n        }\n\n        /* Form validation styles */\n        .invalid-feedback {\n            display: block;\n            color: var(--danger-color);\n            font-size: 0.875rem;\n            margin-top: 5px;\n            font-weight: 500;\n        }\n\n        /* Success animation */\n        .success-icon {\n            animation: successPulse 1s ease;\n        }\n\n        @keyframes successPulse {\n            0% { transform: scale(0.8); opacity: 0.5; }\n            50% { transform: scale(1.1); opacity: 1; }\n            100% { transform: scale(1); opacity: 1; }\n        }\n    </style>\n</head>\n<body>\n\n    <div class=\"main-container\">\n        <!-- Header -->\n        <div class=\"header\">\n            <div class=\"icon\">\n                <i class=\"fas fa-user-plus\"></i>\n            </div>\n            <h1><img src=\"https://www.resolv.ai/logo.png\" alt=\"ResolvAI Logo\" class=\"logo\"></h1>\n            <p>Cadastro de Colaboradores</p>\n        </div>\n\n        <!-- Form Container -->\n        <div class=\"form-container\">\n            <form id=\"collaboratorForm\" novalidate>\n                <!-- Hidden Fields -->\n                <input type=\"hidden\" id=\"status\" value=\"false\">\n                <input type=\"hidden\" id=\"tipo\" value=\"colaborador\">\n\n                <div class=\"row\">\n                    <!-- Nome -->\n                    <div class=\"col-md-6 form-group\">\n                        <label for=\"nome\" class=\"form-label required-field\">Nome Completo</label>\n                        <input type=\"text\" class=\"form-control\" id=\"nome\" placeholder=\"Digite o nome completo\" required>\n                        <div class=\"invalid-feedback\"></div>\n                    </div>\n\n                    <!-- Razão Social -->\n                    <div class=\"col-md-6 form-group\">\n                        <label for=\"razaoSocial\" class=\"form-label required-field\">Razão Social da Empresa</label>\n                        <input type=\"text\" class=\"form-control\" id=\"razaoSocial\" placeholder=\"Digite a razão social\" required>\n                        <div class=\"invalid-feedback\"></div>\n                    </div>\n                </div>\n\n                <div class=\"row\">\n                    <!-- CNPJ -->\n                    <div class=\"col-md-6 form-group\">\n                        <label for=\"cnpj\" class=\"form-label required-field\">CNPJ</label>\n                        <input type=\"text\" class=\"form-control\" id=\"cnpj\" placeholder=\"00.000.000/0000-00\" required>\n                        <div class=\"invalid-feedback\"></div>\n                    </div>\n\n                    <!-- WhatsApp -->\n                    <div class=\"col-md-6 form-group\">\n                        <label for=\"whatsapp\" class=\"form-label required-field\">WhatsApp</label>\n                        <input type=\"text\" class=\"form-control\" id=\"whatsapp\" placeholder=\"(00) 00000-0000\" required>\n                        <div class=\"invalid-feedback\"></div>\n                    </div>\n                </div>\n\n                <!-- Email -->\n                <div class=\"form-group\">\n                    <label for=\"email\" class=\"form-label required-field\">Email</label>\n                    <input type=\"email\" class=\"form-control\" id=\"email\" placeholder=\"exemplo@empresa.com\" required>\n                    <div class=\"invalid-feedback\"></div>\n                </div>\n\n                <!-- Senha -->\n                <div class=\"form-group\">\n                    <label for=\"senha\" class=\"form-label required-field\">Senha</label>\n                    <div class=\"position-relative\">\n                        <input type=\"password\" class=\"form-control\" id=\"senha\" placeholder=\"Digite uma senha segura\" required>\n                        <button type=\"button\" class=\"btn btn-outline-secondary position-absolute end-0 top-0 h-100\" id=\"togglePassword\" style=\"border-top-left-radius: 0; border-bottom-left-radius: 0;\">\n                            <i class=\"fas fa-eye\" id=\"togglePasswordIcon\"></i>\n                        </button>\n                    </div>\n                    <div class=\"invalid-feedback\"></div>\n                    <!-- O texto de ajuda agora permanece sempre visível -->\n                    <small class=\"form-text text-muted\">\n                        A senha deve ter pelo menos 6 caracteres\n                    </small>\n                </div>\n\n                <!-- Endereço -->\n                <div class=\"form-group\">\n                    <label for=\"endereco\" class=\"form-label required-field\">Endereço</label>\n                    <input type=\"text\" class=\"form-control\" id=\"endereco\" placeholder=\"Rua, Avenida, etc.\" required>\n                    <div class=\"invalid-feedback\"></div>\n                </div>\n\n                <div class=\"row\">\n                    <!-- Número -->\n                    <div class=\"col-md-4 form-group\">\n                        <label for=\"numero\" class=\"form-label required-field\">Número</label>\n                        <input type=\"text\" class=\"form-control\" id=\"numero\" placeholder=\"123\" required>\n                        <div class=\"invalid-feedback\"></div>\n                    </div>\n\n                    <!-- Complemento -->\n                    <div class=\"col-md-4 form-group\">\n                        <label for=\"complemento\" class=\"form-label\">Complemento</label>\n                        <input type=\"text\" class=\"form-control\" id=\"complemento\" placeholder=\"Apto, Sala, etc.\">\n                        <div class=\"invalid-feedback\"></div>\n                    </div>\n\n                    <!-- CEP -->\n                    <div class=\"col-md-4 form-group\">\n                        <label for=\"cep\" class=\"form-label required-field\">CEP</label>\n                        <input type=\"text\" class=\"form-control\" id=\"cep\" placeholder=\"00000-000\" required>\n                        <div class=\"invalid-feedback\"></div>\n                    </div>\n                </div>\n\n                <!-- Buttons -->\n                <div class=\"btn-container\">\n                    <button type=\"button\" class=\"btn btn-secondary\" id=\"cancelBtn\">\n                        <i class=\"fas fa-times me-2\"></i>Cancelar\n                    </button>\n                    <button type=\"submit\" class=\"btn btn-primary\" id=\"submitBtn\">\n                        <i class=\"fas fa-save me-2\"></i>Cadastrar colaborador\n                    </button>\n                </div>\n            </form>\n        </div>\n    </div>\n\n    <!-- Modal de Confirmação -->\n    <div class=\"modal fade\" id=\"confirmModal\" tabindex=\"-1\" aria-hidden=\"true\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header bg-primary text-white\">\n                    <h5 class=\"modal-title\">\n                        <i class=\"fas fa-check-circle me-2\"></i>Confirmar Cadastro\n                    </h5>\n                    <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <h6 class=\"text-primary mb-3\">\n                        <i class=\"fas fa-user me-2\"></i>Dados do colaborador\n                    </h6>\n                    <div class=\"row\">\n                        <div class=\"col-md-6\">\n                            <table class=\"table table-sm\">\n                                <tr><td><strong>Nome:</strong></td><td id=\"confirmNome\"></td></tr>\n                                <tr><td><strong>Razão Social:</strong></td><td id=\"confirmRazaoSocial\"></td></tr>\n                                <tr><td><strong>CNPJ:</strong></td><td id=\"confirmCnpj\"></td></tr>\n                                <tr><td><strong>Email:</strong></td><td id=\"confirmEmail\"></td></tr>\n                                <tr><td><strong>Senha:</strong></td><td id=\"confirmSenha\">••••••••</td></tr>\n                                <tr><td><strong>WhatsApp:</strong></td><td id=\"confirmWhatsapp\"></td></tr>\n                            </table>\n                        </div>\n                        <div class=\"col-md-6\">\n                            <table class=\"table table-sm\">\n                                <tr><td><strong>Endereço:</strong></td><td id=\"confirmEndereco\"></td></tr>\n                                <tr><td><strong>Número:</strong></td><td id=\"confirmNumero\"></td></tr>\n                                <tr><td><strong>Complemento:</strong></td><td id=\"confirmComplemento\"></td></tr>\n                                <tr><td><strong>CEP:</strong></td><td id=\"confirmCep\"></td></tr>\n                            </table>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">\n                        <i class=\"fas fa-edit me-2\"></i>Editar\n                    </button>\n                    <button type=\"button\" class=\"btn btn-primary\" id=\"confirmSubmitBtn\">\n                        <i class=\"fas fa-check me-2\"></i>Confirmar Cadastro\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Bootstrap JS -->\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n\n    <script>\n        // URL do webhook\n        const WEBHOOK_URL = '{{ $json.dominio }}/webhook/salvatarefas';\n\n        // Função para mostrar notificações\n        function showNotification(message, type = 'success') {\n            const notification = document.createElement('div');\n            notification.className = `alert alert-${type} alert-dismissible fade show notification`;\n            notification.innerHTML = `\n                <i class=\"fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2\"></i>\n                ${message}\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n            `;\n            document.body.appendChild(notification);\n            setTimeout(() => {\n                if (notification.parentNode) {\n                    notification.parentNode.removeChild(notification);\n                }\n            }, 5000);\n        }\n\n        // Função para formatar CNPJ\n        function formatCNPJ(value) {\n            return value\n                .replace(/\\D/g, '')\n                .replace(/(\\d{2})(\\d)/, '$1.$2')\n                .replace(/(\\d{3})(\\d)/, '$1.$2')\n                .replace(/(\\d{3})(\\d)/, '$1/$2')\n                .replace(/(\\d{4})(\\d)/, '$1-$2')\n                .substring(0, 18);\n        }\n\n        // Função para formatar telefone\n        function formatPhone(value) {\n            return value\n                .replace(/\\D/g, '')\n                .replace(/(\\d{2})(\\d)/, '($1) $2')\n                .replace(/(\\d{5})(\\d)/, '$1-$2')\n                .substring(0, 15);\n        }\n\n        // Função para formatar CEP\n        function formatCEP(value) {\n            return value\n                .replace(/\\D/g, '')\n                .replace(/(\\d{5})(\\d)/, '$1-$2')\n                .substring(0, 9);\n        }\n\n        // Função para validar CNPJ\n        function validateCNPJ(cnpj) {\n            cnpj = cnpj.replace(/[^\\d]+/g, '');\n            if (cnpj.length !== 14) return false;\n            if (/^(\\d)\\1+$/.test(cnpj)) return false;\n            let length = cnpj.length - 2;\n            let numbers = cnpj.substring(0, length);\n            let digits = cnpj.substring(length);\n            let sum = 0;\n            let pos = length - 7;\n            for (let i = length; i >= 1; i--) {\n                sum += numbers.charAt(length - i) * pos--;\n                if (pos < 2) pos = 9;\n            }\n            let result = sum % 11 < 2 ? 0 : 11 - sum % 11;\n            if (result !== parseInt(digits.charAt(0))) return false;\n            length = length + 1;\n            numbers = cnpj.substring(0, length);\n            sum = 0;\n            pos = length - 7;\n            for (let i = length; i >= 1; i--) {\n                sum += numbers.charAt(length - i) * pos--;\n                if (pos < 2) pos = 9;\n            }\n            result = sum % 11 < 2 ? 0 : 11 - sum % 11;\n            return result === parseInt(digits.charAt(1));\n        }\n\n        // Função para validar senha\n        function validatePassword(password) {\n            return password.length >= 6;\n        }\n\n        // Função para toggle da visibilidade da senha\n        function togglePasswordVisibility() {\n            const passwordInput = document.getElementById('senha');\n            const toggleIcon = document.getElementById('togglePasswordIcon');\n            if (passwordInput.type === 'password') {\n                passwordInput.type = 'text';\n                toggleIcon.classList.remove('fa-eye');\n                toggleIcon.classList.add('fa-eye-slash');\n            } else {\n                passwordInput.type = 'password';\n                toggleIcon.classList.remove('fa-eye-slash');\n                toggleIcon.classList.add('fa-eye');\n            }\n        }\n\n        // Função para validar email\n        function validateEmail(email) {\n            const re = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n            return re.test(email);\n        }\n\n        // Função para limpar formulário\n        function clearForm() {\n            document.getElementById('collaboratorForm').reset();\n            document.querySelectorAll('.form-control').forEach(input => {\n                input.classList.remove('is-invalid');\n            });\n            const passwordInput = document.getElementById('senha');\n            const toggleIcon = document.getElementById('togglePasswordIcon');\n            passwordInput.type = 'password';\n            toggleIcon.classList.remove('fa-eye-slash');\n            toggleIcon.classList.add('fa-eye');\n        }\n\n        // Função para preencher modal de confirmação\n        function fillConfirmationModal() {\n            document.getElementById('confirmNome').textContent = document.getElementById('nome').value;\n            document.getElementById('confirmRazaoSocial').textContent = document.getElementById('razaoSocial').value;\n            document.getElementById('confirmCnpj').textContent = document.getElementById('cnpj').value;\n            document.getElementById('confirmEmail').textContent = document.getElementById('email').value;\n            document.getElementById('confirmSenha').textContent = '••••••••';\n            document.getElementById('confirmWhatsapp').textContent = document.getElementById('whatsapp').value;\n            document.getElementById('confirmEndereco').textContent = document.getElementById('endereco').value;\n            document.getElementById('confirmNumero').textContent = document.getElementById('numero').value;\n            document.getElementById('confirmComplemento').textContent = document.getElementById('complemento').value || 'Não informado';\n            document.getElementById('confirmCep').textContent = document.getElementById('cep').value;\n        }\n\n        // Função para enviar dados para webhook\n        async function sendToWebhook(data) {\n            try {\n                const payload = { ...data, action: 'cadastrar_colaborador', timestamp: new Date().toISOString() };\n                console.log('Enviando dados para webhook:', payload);\n                const response = await fetch(WEBHOOK_URL, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },\n                    body: JSON.stringify(payload)\n                });\n                console.log('Status da resposta:', response.status);\n                if (response.ok || response.status === 200) {\n                    console.log('✅ Dados enviados com sucesso para webhook');\n                    return { success: true };\n                } else {\n                    const responseText = await response.text();\n                    console.warn(`⚠️ Webhook respondeu com status ${response.status}`);\n                    if (responseText.includes('No Respond to Webhook node')) {\n                        console.log('ℹ️ Erro conhecido do N8N - dados provavelmente foram processados');\n                        return { success: true, warning: true };\n                    }\n                    return { success: true, warning: true };\n                }\n            } catch (error) {\n                console.error('❌ Erro ao enviar dados para webhook:', error);\n                return { success: false, error: error.message };\n            }\n        }\n\n        // Event Listeners\n        document.addEventListener('DOMContentLoaded', function() {\n            console.log('🚀 Sistema de Cadastro de Colaboradores iniciado');\n            console.log('📡 Webhook URL:', WEBHOOK_URL);\n            console.log('🔐 Sistema com validação de senha implementado');\n\n            // Formatação automática dos campos\n            document.getElementById('cnpj').addEventListener('input', function(e) { e.target.value = formatCNPJ(e.target.value); });\n            document.getElementById('whatsapp').addEventListener('input', function(e) { e.target.value = formatPhone(e.target.value); });\n            document.getElementById('cep').addEventListener('input', function(e) { e.target.value = formatCEP(e.target.value); });\n\n            // Toggle de visibilidade da senha\n            document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);\n\n            // Remover validação visual quando usuário começar a digitar\n            const formInputs = document.querySelectorAll('.form-control');\n            formInputs.forEach(input => {\n                input.addEventListener('input', function() { this.classList.remove('is-invalid'); });\n            });\n            \n            // **** ALTERAÇÃO: Lógica de validação da senha ajustada ****\n            // Event listener específico para o campo senha para validação em tempo real.\n            // Apenas a mensagem de erro vermelha será afetada. O texto de ajuda cinza fica sempre visível.\n            document.getElementById('senha').addEventListener('input', function() {\n                const passwordField = this;\n                const invalidFeedback = passwordField.parentElement.nextElementSibling;\n                const value = passwordField.value;\n\n                if (value.length > 0 && value.length < 6) {\n                    // Mostra o erro se a senha for muito curta\n                    passwordField.classList.add('is-invalid');\n                    invalidFeedback.textContent = 'A senha deve ter pelo menos 6 caracteres.';\n                } else {\n                    // Remove o erro se a senha for válida (>= 6) ou se o campo estiver vazio.\n                    passwordField.classList.remove('is-invalid');\n                    invalidFeedback.textContent = ''; // Limpa a mensagem para que ela desapareça\n                }\n            });\n\n            // Submissão do formulário\n            document.getElementById('collaboratorForm').addEventListener('submit', function(e) {\n                e.preventDefault();\n                let isValid = true;\n                const requiredFields = ['nome', 'razaoSocial', 'cnpj', 'whatsapp', 'email', 'senha', 'endereco', 'numero', 'cep'];\n                requiredFields.forEach(fieldId => {\n                    const field = document.getElementById(fieldId);\n                    const value = field.value.trim();\n                    if (!value) {\n                        field.classList.add('is-invalid');\n                        if (fieldId === 'senha') {\n                            const invalidFeedback = field.parentElement.nextElementSibling;\n                            invalidFeedback.textContent = 'Este campo é obrigatório.';\n                        } else {\n                            field.nextElementSibling.textContent = 'Este campo é obrigatório.';\n                        }\n                        isValid = false;\n                    } else {\n                        field.classList.remove('is-invalid');\n                    }\n                });\n                const cnpjField = document.getElementById('cnpj');\n                if (cnpjField.value && !validateCNPJ(cnpjField.value)) {\n                    cnpjField.classList.add('is-invalid');\n                    cnpjField.nextElementSibling.textContent = 'CNPJ inválido.';\n                    isValid = false;\n                }\n                const emailField = document.getElementById('email');\n                if (emailField.value && !validateEmail(emailField.value)) {\n                    emailField.classList.add('is-invalid');\n                    emailField.nextElementSibling.textContent = 'Email inválido.';\n                    isValid = false;\n                }\n                const senhaField = document.getElementById('senha');\n                if (senhaField.value && !validatePassword(senhaField.value)) {\n                    senhaField.classList.add('is-invalid');\n                    const invalidFeedback = senhaField.parentElement.nextElementSibling;\n                    invalidFeedback.textContent = 'A senha deve ter pelo menos 6 caracteres.';\n                    isValid = false;\n                }\n                if (!isValid) {\n                    showNotification('❌ Por favor, corrija os erros no formulário. Certifique-se de que todos os campos obrigatórios estão preenchidos e a senha tem pelo menos 6 caracteres.', 'danger');\n                    return;\n                }\n                fillConfirmationModal();\n                const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));\n                confirmModal.show();\n            });\n\n            // Confirmação do cadastro\n            document.getElementById('confirmSubmitBtn').addEventListener('click', async function() {\n                const confirmBtn = this;\n                const originalText = confirmBtn.innerHTML;\n                confirmBtn.disabled = true;\n                confirmBtn.classList.add('btn-loading');\n                confirmBtn.textContent = 'Processando...';\n                try {\n                    const formData = {\n                        nome: document.getElementById('nome').value.trim(),\n                        razaoSocial: document.getElementById('razaoSocial').value.trim(),\n                        cnpj: document.getElementById('cnpj').value,\n                        endereco: document.getElementById('endereco').value.trim(),\n                        numero: document.getElementById('numero').value.trim(),\n                        complemento: document.getElementById('complemento').value.trim(),\n                        cep: document.getElementById('cep').value,\n                        whatsapp: document.getElementById('whatsapp').value,\n                        email: document.getElementById('email').value.trim(),\n                        senha: document.getElementById('senha').value,\n                        status: document.getElementById('status').value,\n                        tipo: document.getElementById('tipo').value\n                    };\n                    const result = await sendToWebhook(formData);\n                    console.log('✅ Dados enviados incluindo senha (senha não exibida por segurança)');\n                    const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));\n                    confirmModal.hide();\n                    if (result.success) {\n                        showNotification(\n                            `✅ colaborador cadastrado com sucesso! ${result.warning ? '(Sincronização pendente)' : ''}`,\n                            result.warning ? 'warning' : 'success'\n                        );\n                        setTimeout(() => {\n                            clearForm();\n                            window.location.href = '{{ $json.dominio }}/webhook/login';\n                        }, 2000);\n                    } else {\n                        showNotification('❌ Erro ao cadastrar colaborador. Tente novamente.', 'danger');\n                    }\n                } catch (error) {\n                    console.error('Erro ao processar cadastro:', error);\n                    showNotification('❌ Erro interno. Tente novamente.', 'danger');\n                } finally {\n                    confirmBtn.disabled = false;\n                    confirmBtn.classList.remove('btn-loading');\n                    confirmBtn.innerHTML = originalText;\n                }\n            });\n\n            // Botão cancelar\n            document.getElementById('cancelBtn').addEventListener('click', function() {\n                if (confirm('Deseja realmente cancelar? Todos os dados serão perdidos.')) {\n                    clearForm();\n                    showNotification('ℹ️ Formulário cancelado.', 'info');\n                }\n            });\n        });\n    </script>\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -1904,
        3456
      ],
      "id": "806e28d3-054f-4323-9678-756b19e08651",
      "name": "Cadastro de Colaboradores HTML"
    },
    {
      "parameters": {
        "path": "/res/cadastro",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2560,
        3456
      ],
      "id": "fb489a50-58ee-461b-b21a-95e793e8d7ff",
      "name": "Cadastro de Colaborador",
      "webhookId": "cce5e6b5-f99a-48a3-8b18-cf524f03c4ce"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1696,
        2400
      ],
      "id": "f6a5a91c-8c05-42d4-8f5e-8977558a9de3",
      "name": "Respond to Dashboard"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1696,
        2592
      ],
      "id": "b11b4f3d-a9ed-4400-b176-0eaa5fb9eb37",
      "name": "Respond to Check-in"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1696,
        2816
      ],
      "id": "5df5fc77-3506-463f-a5d3-5b363de16068",
      "name": "Respond to Timeline"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1680,
        3024
      ],
      "id": "4dc7ea37-fcdb-4d2a-8283-e9ac12dd6648",
      "name": "Respond to Gestão de Equipe"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <meta name=\"description\" content=\"ResolvTask - Configurações de Perfil e Sistema\">\n    <meta name=\"keywords\" content=\"gestão, tarefas, perfil, configurações, resolv, produtividade\">\n    <title>Configurações - ResolvTask</title>\n\n    <!-- External Libraries -->\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n\n    <style>\n        /* Color Variables */\n        :root {\n            --primary-color: #0d6efd;\n            --secondary-color: #6c757d;\n            --light-color: #f8f9fa;\n            --dark-color: #212529;\n            --success-color: #198754;\n            --danger-color: #dc3545;\n        }\n\n        /* Global Styles */\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background-color: var(--light-color);\n            overflow-x: hidden;\n        }\n        .app-container {\n            opacity: 0;\n            transition: opacity 0.5s ease;\n        }\n        .app-container.authenticated {\n            opacity: 1;\n        }\n        ::-webkit-scrollbar { width: 8px; }\n        ::-webkit-scrollbar-track { background: #f1f1f1; }\n        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }\n        ::-webkit-scrollbar-thumb:hover { background: #0b5ed7; }\n\n        /* Auth Loading Screen */\n        .auth-loading {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            color: white;\n        }\n        .auth-loading .spinner-auth {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(255, 255, 255, 0.3);\n            border-top: 4px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n        .auth-loading h4 {\n            margin-bottom: 10px;\n            font-weight: 300;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            height: 100vh;\n            width: 280px;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            position: fixed;\n            left: 0;\n            top: 0;\n            transition: transform 0.3s ease;\n            z-index: 1000;\n            overflow-y: auto;\n        }\n        .sidebar.collapsed {\n            transform: translateX(-100%);\n        }\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            background-color: white;\n            border-bottom: 1px solid #dee2e6;\n        }\n        .sidebar-header .logo {\n            max-width: 150px;\n            height: auto;\n            margin-bottom: 10px;\n        }\n        .sidebar-header .text-light {\n            color: var(--dark-color) !important;\n            font-weight: 500;\n        }\n        .sidebar-menu {\n            padding: 20px 0;\n        }\n        .menu-item {\n            display: block;\n            padding: 15px 25px;\n            color: rgba(255,255,255,0.8);\n            text-decoration: none;\n            transition: all 0.3s ease;\n            border: none;\n            background: none;\n            width: 100%;\n            text-align: left;\n            cursor: pointer;\n            display: none; /* Hidden by default, shown by JS */\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n        .menu-item:hover, .menu-item.active {\n            background-color: rgba(255,255,255,0.1);\n            color: white;\n        }\n        .menu-item i {\n            width: 20px;\n            margin-right: 15px;\n        }\n        .menu-item.show {\n            display: block;\n            opacity: 1;\n        }\n        .sidebar-loading {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 40px 20px;\n            color: rgba(255, 255, 255, 0.8);\n        }\n        .sidebar-loading .spinner-small {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid rgba(255, 255, 255, 0.8);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-right: 10px;\n        }\n\n        /* Main Content */\n        .main-content {\n            margin-left: 280px;\n            transition: margin-left 0.3s ease;\n            min-height: 100vh;\n        }\n        .main-content.expanded {\n            margin-left: 0;\n        }\n\n        /* Top Navigation */\n        .top-nav {\n            background: white;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            padding: 15px 25px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            position: sticky;\n            top: 0;\n            z-index: 999;\n        }\n        .sidebar-toggle {\n            display: none;\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n        }\n        .user-info {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n        /* Content Area */\n        .content-area {\n            padding: 25px;\n        }\n        \n        /* Config Sections */\n        .config-section {\n            background: white;\n            border-radius: 15px;\n            padding: 30px;\n            margin-bottom: 30px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n        }\n        .config-section h3 {\n            color: var(--primary-color);\n            margin-bottom: 25px;\n            padding-bottom: 15px;\n            border-bottom: 2px solid #f0f0f0;\n        }\n\n        /* Form Styles */\n        .profile-form {\n            max-width: 900px;\n            margin: 0 auto;\n        }\n        .form-row {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n            gap: 20px;\n            margin-bottom: 20px;\n        }\n        .form-group { margin-bottom: 20px; }\n        .form-group label {\n            font-weight: 600;\n            color: var(--dark-color);\n            margin-bottom: 8px;\n            display: block;\n        }\n        .form-control, .form-select {\n            border-radius: 10px;\n            border: 1px solid #ddd;\n            padding: 12px 15px;\n            transition: border-color 0.3s;\n        }\n        .form-control:focus, .form-select:focus {\n            border-color: var(--primary-color);\n            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);\n        }\n        .form-control[readonly] {\n            background-color: #f8f9fa;\n            cursor: not-allowed;\n        }\n        .btn-custom {\n            border-radius: 10px;\n            padding: 12px 30px;\n            font-weight: 600;\n            transition: all 0.3s ease;\n            border: none;\n        }\n        .btn-primary-custom {\n            background: var(--primary-color);\n            color: white;\n        }\n        .btn-primary-custom:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);\n            color: white;\n        }\n        .btn-secondary-custom {\n            background: var(--secondary-color);\n            color: white;\n        }\n\n        /* Loading Overlay */\n        .loading-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            display: none;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n        }\n        .loading-overlay.show {\n            display: flex;\n        }\n        .spinner {\n            width: 50px;\n            height: 50px;\n            border: 5px solid rgba(255, 255, 255, 0.3);\n            border-top: 5px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        /* Spin Animation */\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        /* Responsive Design */\n        @media (max-width: 992px) {\n            .sidebar { width: 260px; }\n            .main-content { margin-left: 260px; }\n        }\n        @media (max-width: 768px) {\n            .sidebar { transform: translateX(-100%); width: 280px; z-index: 1050; }\n            .sidebar.show { transform: translateX(0); }\n            .main-content { margin-left: 0; }\n            .sidebar-toggle { display: block; }\n            .top-nav { flex-wrap: wrap; gap: 10px; }\n            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040; opacity: 0; visibility: hidden; transition: all 0.3s ease; }\n            .sidebar-overlay.show { opacity: 1; visibility: visible; }\n            .form-row { grid-template-columns: 1fr; }\n        }\n    </style>\n</head>\n<body>\n    <!-- Auth loading screen -->\n    <div class=\"auth-loading\" id=\"authLoading\">\n        <div class=\"spinner-auth\"></div>\n        <h4>ResolvTask</h4>\n        <p>Verificando autenticação...</p>\n    </div>\n\n    <!-- Main interface (hidden until authenticated) -->\n    <div class=\"app-container\" id=\"appContainer\">\n        <!-- Sidebar -->\n        <nav class=\"sidebar\" id=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <img src=\"https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png\" alt=\"ResolvAI Logo\" class=\"logo\">\n                <br><br>\n                <h1><i class=\"fas fa-bolt me-2\"></i>Task</h1>\n                <small class=\"text-light\">Sistema Integrado de Gestão</small>\n            </div>\n            <div class=\"sidebar-menu\" id=\"sidebarMenu\">\n                <div class=\"sidebar-loading\" id=\"sidebarLoading\">\n                    <div class=\"spinner-small\"></div>\n                    Carregando menu...\n                </div>\n                <!-- Menu items will be populated by JS based on user permissions -->\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/resolv'\" data-menu=\"dashboard\"><i class=\"fas fa-chart-line\"></i>Dashboard</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/gerenciadortarefas'\" data-menu=\"tasks\"><i class=\"fas fa-tasks\"></i>Gerenciador de Tarefas</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/taskhoras'\" data-menu=\"hours\"><i class=\"fas fa-clock\"></i>Gerenciador de Horas</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/gestao_clientes'\" data-menu=\"clients\"><i class=\"fas fa-handshake\"></i>Gestão de Clientes</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/gestaodeparceiros'\" data-menu=\"partners\"><i class=\"fas fa-handshake-angle\"></i>Gestão de Parceiros</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/equipe'\" data-menu=\"team\"><i class=\"fas fa-users\"></i>Equipe</button>\n                <button class=\"menu-item active\" onclick=\"window.location.reload();\" data-menu=\"settings\"><i class=\"fas fa-cog\"></i>Configurações</button>\n            </div>\n        </nav>\n\n        <!-- Main Content -->\n        <main class=\"main-content\" id=\"mainContent\">\n            <nav class=\"top-nav\">\n                <div class=\"d-flex align-items-center\">\n                    <button class=\"sidebar-toggle\" id=\"sidebarToggle\"><i class=\"fas fa-bars\"></i></button>\n                    <h5 class=\"mb-0 ms-3\">Configurações</h5>\n                </div>\n                <div class=\"user-info\">\n                    <div class=\"d-flex align-items-center\">\n                        <i class=\"fas fa-user-circle fs-4 text-primary me-2\"></i>\n                        <span class=\"fw-bold\" id=\"userNameDisplay\">Usuário</span>\n                    </div>\n                    <button class=\"btn btn-outline-danger btn-sm ms-2\" id=\"logoutButton\" title=\"Sair\">\n                        <i class=\"fas fa-sign-out-alt me-1\"></i>Sair\n                    </button>\n                </div>\n            </nav>\n\n            <div class=\"content-area\">\n                <!-- User Profile Section -->\n                <div class=\"config-section\">\n                    <h3><i class=\"fas fa-user-edit me-2\"></i>Meu Perfil</h3>\n                    \n                    <form class=\"profile-form\" id=\"profileForm\">\n                        <h5 class=\"mb-4\">Informações de Contato e Acesso</h5>\n                        <div class=\"form-row\">\n                            <div class=\"form-group\">\n                                <label for=\"nome\">Nome Completo *</label>\n                                <input type=\"text\" class=\"form-control\" id=\"nome\" required>\n                            </div>\n                            <div class=\"form-group\">\n                                <label for=\"email\">E-mail (Login) *</label>\n                                <input type=\"email\" class=\"form-control\" id=\"email\" readonly>\n                            </div>\n                            <div class=\"form-group\">\n                                <label for=\"whatsapp\">WhatsApp</label>\n                                <input type=\"tel\" class=\"form-control\" id=\"whatsapp\" placeholder=\"(00) 00000-0000\">\n                            </div>\n                        </div>\n                        <div class=\"form-row\">\n                           <div class=\"form-group\">\n                                <label for=\"senha\">Nova Senha (obrigatório para salvar)</label>\n                                <div class=\"input-group\">\n                                    <input type=\"password\" class=\"form-control\" id=\"senha\" placeholder=\"Digite uma nova senha\" required>\n                                    <button class=\"btn btn-outline-secondary\" type=\"button\" id=\"togglePassword\">\n                                        <i class=\"fas fa-eye\"></i>\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n\n                        <hr class=\"my-5\">\n\n                        <h5 class=\"mb-4\">Informações da Empresa</h5>\n                        <div class=\"form-row\">\n                            <div class=\"form-group\">\n                                <label for=\"razao_social\">Razão Social</label>\n                                <input type=\"text\" class=\"form-control\" id=\"razao_social\">\n                            </div>\n                             <div class=\"form-group\">\n                                <label for=\"cnpj\">CNPJ</label>\n                                <input type=\"text\" class=\"form-control\" id=\"cnpj\" placeholder=\"00.000.000/0001-00\">\n                            </div>\n                        </div>\n\n                        <h5 class=\"mb-4 mt-4\">Endereço</h5>\n                        <div class=\"form-row\">\n                            <div class=\"form-group\" style=\"max-width: 200px;\">\n                                <label for=\"cep\">CEP</label>\n                                <input type=\"text\" class=\"form-control\" id=\"cep\" placeholder=\"00000-000\">\n                            </div>\n                            <div class=\"form-group flex-grow-1\">\n                                <label for=\"endereco\">Logradouro</label>\n                                <input type=\"text\" class=\"form-control\" id=\"endereco\">\n                            </div>\n                            <div class=\"form-group\" style=\"max-width: 150px;\">\n                                <label for=\"numero\">Número</label>\n                                <input type=\"text\" class=\"form-control\" id=\"numero\">\n                            </div>\n                        </div>\n                        <div class=\"form-row\">\n                             <div class=\"form-group\">\n                                <label for=\"complemento\">Complemento</label>\n                                <input type=\"text\" class=\"form-control\" id=\"complemento\">\n                            </div>\n                        </div>\n                        \n                        <hr class=\"my-5\">\n\n                        <h5 class=\"mb-4\">Configurações de Conta</h5>\n                        <div class=\"form-row\">\n                             <div class=\"form-group\">\n                                <label for=\"tipo\">Tipo de Usuário</label>\n                                <select class=\"form-select\" id=\"tipo\" disabled>\n                                    <option value=\"colaborador\">Colaborador</option>\n                                    <option value=\"admin\">Administrador</option>\n                                </select>\n                            </div>\n                            <div class=\"form-group\">\n                                <label for=\"status\">Status da Conta</label>\n                                <select class=\"form-select\" id=\"status\" disabled>\n                                    <option value=\"true\">Ativo</option>\n                                    <option value=\"false\">Inativo</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div class=\"text-center mt-5\">\n                            <button type=\"button\" class=\"btn btn-custom btn-secondary-custom me-2\" id=\"resetFormButton\">\n                                <i class=\"fas fa-times me-2\"></i>Descartar Alterações\n                            </button>\n                            <button type=\"submit\" class=\"btn btn-custom btn-primary-custom\">\n                                <i class=\"fas fa-save me-2\"></i>Salvar Alterações\n                            </button>\n                        </div>\n                    </form>\n                </div>\n            </div>\n        </main>\n\n        <!-- Sidebar Overlay -->\n        <div class=\"sidebar-overlay\" id=\"sidebarOverlay\"></div>\n    </div>\n\n    <!-- Loading Overlay for async operations -->\n    <div class=\"loading-overlay\" id=\"loadingOverlay\">\n        <div class=\"spinner\"></div>\n    </div>\n    \n    <script>\n    document.addEventListener('DOMContentLoaded', async () => {\n        // =================================================================\n        // SCRIPT UNIFICADO PARA AUTENTICAÇÃO, UI E LÓGICA DA PÁGINA\n        // =================================================================\n\n        // --- CONFIGURAÇÃO GLOBAL E CONSTANTES ---\n        const LOGIN_URL = '{{ $json.dominio }}/webhook/login';\n        const COLABORADORES_GET_URL = '{{ $json.dominio }}/webhook/consultacolaboradores';\n        const PROFILE_UPDATE_URL = '{{ $json.dominio }}/webhook/salvatarefas';\n        let currentUser = null; // Armazena os dados do usuário logado\n\n        // --- SAFE STORAGE FOR SANDBOXED IFRAMES ---\n        const SafeStorage = (() => {\n            let memoryStorage = {};\n            let isLocalStorageAvailable = false;\n\n            try {\n                const test = '__storage_test__';\n                localStorage.setItem(test, test);\n                localStorage.removeItem(test);\n                isLocalStorageAvailable = true;\n            } catch (e) {\n                isLocalStorageAvailable = false;\n                console.warn('⚠️ localStorage não disponível, usando armazenamento via window.name');\n                \n                if (window.name) {\n                    try {\n                        memoryStorage = JSON.parse(window.name);\n                    } catch (e) {\n                        memoryStorage = {};\n                    }\n                }\n                \n                const urlParams = new URLSearchParams(window.location.search);\n                if (urlParams.has('session')) {\n                    try {\n                        const sessionData = JSON.parse(atob(urlParams.get('session')));\n                        memoryStorage['authToken'] = sessionData.token;\n                        memoryStorage['userSession'] = JSON.stringify(sessionData);\n                        window.name = JSON.stringify(memoryStorage);\n                    } catch (e) {\n                        console.error('Erro ao processar sessão da URL:', e);\n                    }\n                }\n            }\n\n            return {\n                getItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        return localStorage.getItem(key);\n                    }\n                    return memoryStorage[key] || null;\n                },\n                setItem: (key, value) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.setItem(key, value);\n                    } else {\n                        memoryStorage[key] = value;\n                        window.name = JSON.stringify(memoryStorage);\n                    }\n                },\n                removeItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.removeItem(key);\n                    } else {\n                        delete memoryStorage[key];\n                        window.name = JSON.stringify(memoryStorage);\n                    }\n                },\n                clear: () => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.clear();\n                    } else {\n                        memoryStorage = {};\n                        window.name = '';\n                    }\n                }\n            };\n        })();\n        \n        // --- MÓDULO DE AUTENTICAÇÃO E SESSÃO ---\n        const Auth = {\n            getUserData: () => {\n                const sessionData = SafeStorage.getItem('userSession');\n                try {\n                    return sessionData ? JSON.parse(sessionData) : null;\n                } catch (e) {\n                    console.error(\"Erro ao parsear dados da sessão:\", e);\n                    return null;\n                }\n            },\n            checkAuth: () => {\n                const authToken = SafeStorage.getItem('authToken');\n                const userData = Auth.getUserData();\n                console.log('🔐 Verificando status de login...', { hasToken: !!authToken, hasData: !!userData });\n                return !!(authToken && userData);\n            },\n            logout: () => {\n                console.log('🚪 Iniciando processo de logout...');\n                SafeStorage.clear();\n                const authLoadingEl = document.getElementById('authLoading');\n                if (authLoadingEl) {\n                    authLoadingEl.style.display = 'flex';\n                    authLoadingEl.innerHTML = `<div class=\"spinner-auth\"></div><h4>Sessão encerrada</h4><p>Você será redirecionado.</p>`;\n                }\n                document.getElementById('appContainer').style.opacity = 0;\n                setTimeout(() => { window.location.href = LOGIN_URL; }, 1500);\n            },\n            redirectToLogin: () => {\n                console.log('🔄 Redirecionando para página de login...');\n                window.location.href = LOGIN_URL;\n            }\n        };\n\n        // --- MÓDULO DE MANIPULAÇÃO DA UI ---\n        const UI = {\n            showLoading: (show) => {\n                document.getElementById('loadingOverlay').classList.toggle('show', show);\n            },\n            updateUserInfo: () => {\n                const userData = Auth.getUserData();\n                if (userData && userData.nome) {\n                    document.getElementById('userNameDisplay').textContent = userData.nome;\n                    console.log('👤 Informações do usuário atualizadas:', userData.nome);\n                }\n            },\n            showAuthenticatedInterface: () => {\n                document.getElementById('authLoading').style.display = 'none';\n                document.getElementById('appContainer').classList.add('authenticated');\n                console.log('🎉 Interface principal ativada.');\n            },\n            applyUIPermissions: () => {\n                console.log('--- Iniciando depuração de permissões ---');\n                const userData = Auth.getUserData();\n\n                if (!userData) {\n                    console.warn('⚠️ userSession não encontrado ou inválido no localStorage. Usando permissões de \"colaborador\".');\n                    // Mesmo sem userData, continua para aplicar permissões padrão\n                } else {\n                    console.log('✅ Dados de userSession encontrados:', userData);\n                }\n\n                const userType = userData?.tipo || 'colaborador';\n                console.log(`🔧 Aplicando permissões de UI para o tipo: \"${userType}\"`);\n\n                document.getElementById('sidebarLoading').style.display = 'none';\n                \n                const menuPermissions = {\n                    admin: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'],\n                    colaborador: ['dashboard', 'tasks', 'hours', 'settings']\n                };\n                const allowedMenus = menuPermissions[userType] || menuPermissions.colaborador;\n                console.log('🔑 Menus permitidos para este tipo:', allowedMenus);\n\n                document.querySelectorAll('#sidebarMenu .menu-item').forEach((item, index) => {\n                    const menuType = item.getAttribute('data-menu');\n                    if (allowedMenus.includes(menuType)) {\n                        setTimeout(() => item.classList.add('show'), index * 50);\n                    }\n                });\n                console.log('--- Fim da depuração de permissões ---');\n            },\n            showNotification: (message, type = 'info') => {\n                const container = document.body;\n                const alertType = type === 'error' ? 'danger' : type;\n                const iconMap = { success: 'check-circle', warning: 'exclamation-triangle', danger: 'times-circle', info: 'info-circle' };\n                const icon = iconMap[type] || 'info-circle';\n                const notification = document.createElement('div');\n                notification.className = `alert alert-${alertType} alert-dismissible fade show shadow-lg`;\n                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; min-width: 250px;';\n                notification.innerHTML = `<i class=\"fas fa-${icon} me-2\"></i> ${message} <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>`;\n                container.appendChild(notification);\n                setTimeout(() => bootstrap.Alert.getOrCreateInstance(notification)?.close(), 5000);\n            },\n            toggleSidebar: () => {\n                const sidebar = document.getElementById('sidebar');\n                const overlay = document.getElementById('sidebarOverlay');\n                if (window.innerWidth <= 768) {\n                    sidebar.classList.toggle('show');\n                    overlay.classList.toggle('show');\n                    document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';\n                } else {\n                    document.getElementById('sidebar').classList.toggle('collapsed');\n                    document.getElementById('mainContent').classList.toggle('expanded');\n                }\n            }\n        };\n\n        // --- LÓGICA ESPECÍFICA DA PÁGINA DE CONFIGURAÇÕES ---\n        const SettingsPage = {\n            loadUserProfile: async () => {\n                const userData = Auth.getUserData();\n                if (!userData || !userData.email) {\n                    UI.showNotification('Erro: Email do usuário não encontrado. Faça login novamente.', 'error');\n                    Auth.redirectToLogin();\n                    return;\n                }\n\n                UI.showLoading(true);\n                try {\n                    const response = await fetch(COLABORADORES_GET_URL);\n                    if (!response.ok) throw new Error(`Erro ao carregar colaboradores: ${response.statusText}`);\n                    \n                    const colaboradores = await response.json();\n                    currentUser = colaboradores.find(c => c.email && c.email.toLowerCase() === userData.email.toLowerCase());\n                    \n                    if (currentUser) {\n                        SettingsPage.populateProfileForm(currentUser);\n                    } else {\n                        UI.showNotification('Usuário não encontrado na base de dados.', 'warning');\n                    }\n                } catch (error) {\n                    console.error('Erro ao carregar perfil:', error);\n                    UI.showNotification('Erro fatal ao carregar seus dados.', 'error');\n                } finally {\n                    UI.showLoading(false);\n                }\n            },\n            populateProfileForm: (userData) => {\n                document.getElementById('nome').value = userData.nome || '';\n                document.getElementById('email').value = userData.email || '';\n                document.getElementById('whatsapp').value = userData.whatsapp || '';\n                document.getElementById('senha').value = '';\n                document.getElementById('razao_social').value = userData.razao_social || '';\n                document.getElementById('cnpj').value = userData.cnpj || '';\n                document.getElementById('cep').value = userData.cep || '';\n                document.getElementById('endereco').value = userData.endereco || '';\n                document.getElementById('numero').value = userData.numero || '';\n                document.getElementById('complemento').value = userData.complemento || '';\n                document.getElementById('tipo').value = userData.tipo || 'colaborador';\n                document.getElementById('status').value = userData.status !== false ? 'true' : 'false';\n            },\n            handleProfileUpdate: async (event) => {\n                event.preventDefault();\n                if (!currentUser) {\n                    UI.showNotification('Erro: Dados do usuário não carregados.', 'error');\n                    return;\n                }\n\n                const nome = document.getElementById('nome').value.trim();\n                const newPassword = document.getElementById('senha').value.trim();\n\n                if (!nome || !newPassword) {\n                    UI.showNotification('Os campos \"Nome Completo\" e \"Nova Senha\" são obrigatórios.', 'warning');\n                    return;\n                }\n\n                UI.showLoading(true);\n                const updatedData = {\n                    id: currentUser.id,\n                    nome: nome,\n                    whatsapp: document.getElementById('whatsapp').value,\n                    senha: newPassword,\n                    razao_social: document.getElementById('razao_social').value,\n                    cnpj: document.getElementById('cnpj').value,\n                    cep: document.getElementById('cep').value,\n                    endereco: document.getElementById('endereco').value,\n                    numero: document.getElementById('numero').value,\n                    complemento: document.getElementById('complemento').value,\n                    email: currentUser.email,\n                    tipo: currentUser.tipo,\n                    status: currentUser.status,\n                };\n\n                try {\n                    const response = await fetch(PROFILE_UPDATE_URL, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify({ action: 'update_colaborador', data: updatedData })\n                    });\n\n                    if (!response.ok) throw new Error('Falha na comunicação com o servidor.');\n                    \n                    const currentSession = Auth.getUserData();\n                    currentSession.nome = updatedData.nome;\n                    localStorage.setItem('userSession', JSON.stringify(currentSession));\n\n                    UI.updateUserInfo();\n                    currentUser = { ...currentUser, ...updatedData };\n                    document.getElementById('senha').value = '';\n                    UI.showNotification('Perfil atualizado com sucesso!', 'success');\n\n                } catch (error) {\n                    console.error('Erro ao atualizar perfil:', error);\n                    UI.showNotification('Erro ao salvar suas alterações.', 'error');\n                } finally {\n                    UI.showLoading(false);\n                }\n            },\n            setupInputMasks: () => {\n                const masks = {\n                    whatsapp: v => v.replace(/\\D/g, '').replace(/^(\\d{2})(\\d)/g, '($1) $2').replace(/(\\d{5})(\\d)/, '$1-$2').slice(0, 15),\n                    cnpj: v => v.replace(/\\D/g, '').replace(/^(\\d{2})(\\d)/, '$1.$2').replace(/^(\\d{2})\\.(\\d{3})(\\d)/, '$1.$2.$3').replace(/\\.(\\d{3})(\\d)/, '.$1/$2').replace(/(\\d{4})(\\d)/, '$1-$2').slice(0, 18),\n                    cep: v => v.replace(/\\D/g, '').replace(/^(\\d{5})(\\d)/, '$1-$2').slice(0, 9),\n                };\n                Object.keys(masks).forEach(id => {\n                    const el = document.getElementById(id);\n                    if (el) el.addEventListener('input', e => e.target.value = masks[id](e.target.value));\n                });\n            },\n            setupCepLookup: () => {\n                document.getElementById('cep').addEventListener('blur', async function() {\n                    const cep = this.value.replace(/\\D/g, '');\n                    if (cep.length === 8) {\n                        UI.showLoading(true);\n                        try {\n                            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);\n                            const data = await response.json();\n                            if (!data.erro) {\n                                document.getElementById('endereco').value = data.logradouro || '';\n                                document.getElementById('numero').focus();\n                            } else {\n                                UI.showNotification('CEP não encontrado', 'warning');\n                            }\n                        } catch (error) {\n                            console.error('Erro ao buscar CEP:', error);\n                            UI.showNotification('Falha ao consultar o CEP.', 'error');\n                        } finally {\n                            UI.showLoading(false);\n                        }\n                    }\n                });\n            }\n        };\n\n        // --- INICIALIZAÇÃO DA APLICAÇÃO ---\n        const App = {\n            initialize: async () => {\n                console.log('🚀 Iniciando página de Configurações do ResolvTask...');\n                if (!Auth.checkAuth()) {\n                    Auth.redirectToLogin();\n                    return;\n                }\n                \n                UI.showAuthenticatedInterface();\n                UI.updateUserInfo();\n                UI.applyUIPermissions();\n                \n                App.setupEventListeners();\n                \n                await SettingsPage.loadUserProfile();\n            },\n            setupEventListeners: () => {\n                document.getElementById('logoutButton').addEventListener('click', Auth.logout);\n                document.getElementById('sidebarToggle').addEventListener('click', UI.toggleSidebar);\n                document.getElementById('sidebarOverlay').addEventListener('click', UI.toggleSidebar);\n                document.getElementById('profileForm').addEventListener('submit', SettingsPage.handleProfileUpdate);\n                document.getElementById('resetFormButton').addEventListener('click', () => {\n                    if (confirm('Deseja realmente descartar as alterações?')) {\n                        if (currentUser) {\n                            SettingsPage.populateProfileForm(currentUser);\n                            UI.showNotification('Alterações descartadas.', 'info');\n                        }\n                    }\n                });\n                document.getElementById('togglePassword').addEventListener('click', function() {\n                    const passwordInput = document.getElementById('senha');\n                    const icon = this.querySelector('i');\n                    const isPassword = passwordInput.type === 'password';\n                    passwordInput.type = isPassword ? 'text' : 'password';\n                    icon.classList.toggle('fa-eye', !isPassword);\n                    icon.classList.toggle('fa-eye-slash', isPassword);\n                });\n\n                SettingsPage.setupInputMasks();\n                SettingsPage.setupCepLookup();\n            }\n        };\n\n        // --- Inicia a aplicação ---\n        await App.initialize();\n    });\n    </script>\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -1904,
        3232
      ],
      "id": "6fe135f3-f144-499b-a13d-b93c8da90f72",
      "name": "Módulo em Construção HTML"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1680,
        3232
      ],
      "id": "0d700bd4-6030-4bb9-b0a5-3dab68b8647b",
      "name": "Respond to Módulo em Construção"
    },
    {
      "parameters": {
        "path": "/conf",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2560,
        3232
      ],
      "id": "60256ec9-ccb2-4646-9e66-6fbeaaa5c5d4",
      "name": "Site Menu Configuração",
      "webhookId": "cce5e6b5-f99a-48a3-8b18-cf524f03c4ce"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1680,
        3456
      ],
      "id": "7b99ff44-d393-413d-9559-516fd06b2512",
      "name": "Respond to Colaborador"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "configurations"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2352,
        3232
      ],
      "id": "f4838bfb-1560-4c42-a5c7-fc328347ec6f",
      "name": "Consulta Dominio Conf",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e63701a4-5c13-4f77-96a1-9ff33820e4e6",
              "name": "dominio",
              "value": "=https://n8n.resolv.ai",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2160,
        3232
      ],
      "id": "93e49c13-8c49-4db0-86ee-4ee7d7251b26",
      "name": "Trata dados Dominio Conf"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "configurations"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2336,
        3456
      ],
      "id": "900a9607-4999-46ea-99c9-e11a0f76aef7",
      "name": "Consulta Dominio Cadastro de Colaborador",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e63701a4-5c13-4f77-96a1-9ff33820e4e6",
              "name": "dominio",
              "value": "=https://n8n.resolv.ai",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2080,
        3456
      ],
      "id": "f747f8a9-73be-42af-94f9-6f6ccbc3a69e",
      "name": "Trata dados Dominio Cadastro de Colaborador"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "configurations"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2352,
        3024
      ],
      "id": "415c37e6-2824-440a-812f-78b29e58bbe2",
      "name": "Consulta Dominio Gestão de Equipe",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e63701a4-5c13-4f77-96a1-9ff33820e4e6",
              "name": "dominio",
              "value": "=https://n8n.resolv.ai",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2160,
        3024
      ],
      "id": "d56c8f54-956b-4dd9-9203-c338cedfe2b6",
      "name": "Trata dados Dominio Gestão de Equipe"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "configurations"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2352,
        2816
      ],
      "id": "d0195be8-cd5e-4f02-b4d5-8203892027a1",
      "name": "Consulta Dominio Timeline",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e63701a4-5c13-4f77-96a1-9ff33820e4e6",
              "name": "dominio",
              "value": "=https://n8n.resolv.ai",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2160,
        2816
      ],
      "id": "c66b66dd-5424-4b79-8157-f8803bc9881e",
      "name": "Trata dados Dominio  Timeline"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "configurations"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2352,
        2592
      ],
      "id": "d611d7cf-384c-4ea3-80a1-13431bd0ee18",
      "name": "Consulta Dominio Check-in",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "configurations"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2352,
        2400
      ],
      "id": "6e123f00-9cf3-4d42-ab6e-7657c08beb06",
      "name": "Consulta Dominio Dashboard",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e63701a4-5c13-4f77-96a1-9ff33820e4e6",
              "name": "menu.gerenciadortarefas",
              "value": "=https://n8n.resolv.ai/webhook/gerenciadortarefas",
              "type": "string"
            },
            {
              "id": "a702af87-d175-4920-a6d8-13ec8555e79a",
              "name": "menu.taskhoras",
              "value": "=https://n8n.resolv.ai/webhook/taskhoras",
              "type": "string"
            },
            {
              "id": "6d2db409-40f8-4cb6-919c-fba5921b950a",
              "name": "menu.gestao_clientes",
              "value": "=https://n8n.resolv.ai/webhook/gestao_clientes",
              "type": "string"
            },
            {
              "id": "cfdca80e-1d46-4dc2-bd4e-e2387e0ff2f4",
              "name": "menu.equipe",
              "value": "=https://n8n.resolv.ai/webhook/equipe",
              "type": "string"
            },
            {
              "id": "95f02e2b-dc36-41fe-aa9d-b3dad2b2f836",
              "name": "menu.conf",
              "value": "=https://n8n.resolv.ai/webhook/conf",
              "type": "string"
            },
            {
              "id": "6825628a-da8f-4989-8b51-69f74f6f9ef2",
              "name": "conf_globais.login",
              "value": "=https://n8n.resolv.ai/webhook/login",
              "type": "string"
            },
            {
              "id": "77eab553-0a8b-4ee6-9f14-e7e340a77536",
              "name": "conf_globais. consultadadosresolv",
              "value": "=https://n8n.resolv.ai/webhook/consultadadosresolv",
              "type": "string"
            },
            {
              "id": "822410a1-a1b7-4f0b-a925-437347ef2317",
              "name": "conf_globais.consultacolaboradores",
              "value": "=https://n8n.resolv.ai/webhook/consultacolaboradores",
              "type": "string"
            },
            {
              "id": "eea74aa5-24d7-46dd-96fe-910c0bb8012f",
              "name": "menu.gestaodeparceiros",
              "value": "=https://n8n.resolv.ai/webhook/gestaodeparceiros",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2160,
        2400
      ],
      "id": "a8af9a7a-9c2f-4508-b574-ca4bacacc6aa",
      "name": "Trata dados Dominio  Dashboard"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Dashboard - ResolvTask</title>\n\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css\" rel=\"stylesheet\">\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n    <style>\n        /* Color Variables */\n        :root {\n            --primary-color: #0d6efd;\n            --secondary-color: #6c757d;\n            --success-color: #198754;\n            --danger-color: #dc3545;\n            --warning-color: #ffc107;\n            --info-color: #0dcaf0;\n            --light-color: #f8f9fa;\n            --dark-color: #212529;\n        }\n\n        /* Global Styles */\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background-color: var(--light-color);\n            overflow-x: hidden;\n        }\n        .app-container {\n            opacity: 0;\n            transition: opacity 0.5s ease;\n        }\n        .app-container.authenticated {\n            opacity: 1;\n        }\n        ::-webkit-scrollbar { width: 8px; }\n        ::-webkit-scrollbar-track { background: #f1f1f1; }\n        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }\n        ::-webkit-scrollbar-thumb:hover { filter: brightness(0.9); }\n\n        /* Auth Loading Screen */\n        .auth-loading {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color) 100%);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            color: white;\n        }\n        .auth-loading .spinner-auth {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(255, 255, 255, 0.3);\n            border-top: 4px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n        .auth-loading h4 {\n            margin-bottom: 10px;\n            font-weight: 300;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            height: 100vh;\n            width: 280px;\n            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color) 100%);\n            position: fixed;\n            left: 0;\n            top: 0;\n            transition: transform 0.3s ease;\n            z-index: 1000;\n            overflow-y: auto;\n        }\n        .sidebar.collapsed {\n            transform: translateX(-100%);\n        }\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            background-color: white;\n            border-bottom: 1px solid #dee2e6;\n        }\n        .sidebar-header .logo {\n            max-width: 150px;\n            height: auto;\n            margin-bottom: 10px;\n        }\n        .sidebar-header .text-light {\n            color: var(--dark-color) !important;\n            font-weight: 500;\n        }\n        .sidebar-menu {\n            padding: 20px 0;\n        }\n        .menu-item {\n            display: block;\n            padding: 15px 25px;\n            color: rgba(255,255,255,0.8);\n            text-decoration: none;\n            transition: all 0.3s ease;\n            border: none;\n            background: none;\n            width: 100%;\n            text-align: left;\n            cursor: pointer;\n        }\n        .menu-item:hover, .menu-item.active {\n            background-color: rgba(255,255,255,0.1);\n            color: white;\n        }\n        .menu-item i {\n            width: 20px;\n            margin-right: 15px;\n        }\n\n        /* Main Content */\n        .main-content {\n            margin-left: 280px;\n            transition: margin-left 0.3s ease;\n            min-height: 100vh;\n        }\n        .main-content.expanded {\n            margin-left: 0;\n        }\n\n        /* Top Navigation */\n        .top-nav {\n            background: white;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            padding: 15px 25px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            position: sticky;\n            top: 0;\n            z-index: 999;\n        }\n        .sidebar-toggle {\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n        }\n        .user-info {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n        /* Content Area */\n        .content-area {\n            padding: 25px;\n        }\n\n        /* Cards */\n        .card {\n            border: none;\n            border-radius: 15px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n            margin-bottom: 25px;\n            transition: transform 0.3s ease;\n        }\n\n        .card:hover {\n            transform: translateY(-5px);\n        }\n\n        /* Table Styles */\n        .table-container {\n            background: white;\n            border-radius: 15px;\n            padding: 25px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n        }\n\n        .table thead th {\n            background-color: var(--light-color);\n            color: var(--dark-color);\n            font-weight: 600;\n            border: none;\n            padding: 15px;\n        }\n\n        .table tbody td {\n            padding: 15px;\n            border-color: #f1f3f4;\n            vertical-align: middle;\n        }\n\n        /* Status Badges */\n        .status-badge {\n            padding: 8px 15px;\n            border-radius: 25px;\n            font-size: 0.85rem;\n            font-weight: 600;\n        }\n        .status-em-andamento { background-color: #cff4fc; color: #055160; }\n        .status-concluido, .status-concluÍdo { background-color: #d1e7dd; color: #0f5132; }\n        .status-nao-iniciado { background-color: #f8d7da; color: #842029; }\n        .status-paralizado { background-color: #fff3cd; color: #664d03; }\n\n        /* Form Styles */\n        .form-card {\n            background: white;\n            border-radius: 15px;\n            padding: 25px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n        }\n        .form-control, .form-select {\n            border: 2px solid #f1f3f4;\n            border-radius: 10px;\n            padding: 12px 15px;\n            transition: all 0.3s ease;\n        }\n        .form-control:focus, .form-select:focus {\n            border-color: var(--primary-color);\n            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);\n        }\n        .form-control:disabled, .form-select:disabled {\n          background-color: #e9ecef;\n          opacity: 1;\n        }\n        .btn {\n            border-radius: 10px;\n            padding: 12px 25px;\n            font-weight: 600;\n            transition: all 0.3s ease;\n        }\n\n        /* Other specific styles from task manager */\n        .time-control-btn { padding: 6px 12px; font-size: 0.85rem; }\n        .time-entries-table { max-height: 300px; overflow-y: auto; }\n        .time-entries-table table { font-size: 0.9rem; }\n        .time-entry-status { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }\n        .time-entry-active { background-color: #cff4fc; color: #055160; }\n        .time-entry-completed { background-color: #d1e7dd; color: #0f5132; }\n        .observation-truncated { cursor: pointer; color: var(--primary-color); text-decoration: underline; font-weight: 500; }\n        .observation-truncated:hover { filter: brightness(0.8); }\n        .positive-deviation { color: var(--danger-color); font-weight: bold; }\n        .negative-deviation { color: var(--success-color); font-weight: bold; }\n        .required-field::after { content: \"*\"; color: var(--danger-color); margin-left: 4px; }\n        .hour-input { text-align: right; }\n        .filters-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }\n        .filter-item { flex: 1; min-width: 200px; }\n        .resume-truncated { cursor: pointer; color: var(--primary-color); text-decoration: underline; font-weight: 500; }\n        .resume-truncated:hover { filter: brightness(0.8); }\n        .notification {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            z-index: 9999;\n            min-width: 300px;\n            max-width: 400px;\n        }\n\n        /* Spin Animation */\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        /* Disabled Button Styling */\n        .btn.disabled, .btn:disabled {\n            opacity: 0.5;\n            pointer-events: none;\n            cursor: not-allowed;\n        }\n\n        /* Responsive Design */\n        @media (max-width: 992px) {\n            .sidebar { width: 260px; }\n            .main-content { margin-left: 260px; }\n        }\n        @media (max-width: 768px) {\n            .sidebar { transform: translateX(-100%); width: 280px; z-index: 1050; }\n            .sidebar.show { transform: translateX(0); }\n            .main-content { margin-left: 0; }\n            .sidebar-toggle { display: block; }\n            .top-nav { flex-wrap: wrap; gap: 10px; }\n            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040; opacity: 0; visibility: hidden; transition: all 0.3s ease; }\n            .sidebar-overlay.show { opacity: 1; visibility: visible; }\n            .filter-item { min-width: 100%; }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"auth-loading\" id=\"authLoading\">\n        <div class=\"spinner-auth\"></div>\n        <h4>ResolvTask Dashboard</h4>\n        <p>Verificando autenticação...</p>\n    </div>\n\n    <div class=\"app-container\" id=\"appContainer\">\n        <nav class=\"sidebar\" id=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <img src=\"https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png\" alt=\"ResolvAI Logo\" class=\"logo\">\n                <br><br>\n                <h1><i class=\"fas fa-bolt me-2\"></i>Task</h1>\n                <small class=\"text-light\">Sistema Integrado de Gestão</small>\n            </div>\n            <div class=\"sidebar-menu\" id=\"sidebarMenu\">\n                <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.resolv.ai/webhook/resolv'\" data-menu=\"dashboard\"><i class=\"fas fa-chart-line\"></i>Dashboard</button>\n                <button class=\"menu-item active\" onclick=\"window.location.href='https://n8n.resolv.ai/webhook/gerenciadortarefas'\" data-menu=\"tasks\"><i class=\"fas fa-tasks\"></i>Gerenciador de Tarefas</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.resolv.ai/webhook/taskhoras'\" data-menu=\"hours\"><i class=\"fas fa-clock\"></i>Gerenciador de Horas</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.resolv.ai/webhook/gestao_clientes'\" data-menu=\"clients\"><i class=\"fas fa-handshake\"></i>Gestão de Clientes</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.resolv.ai/webhook/gestaodeparceiros'\" data-menu=\"partners\"><i class=\"fas fa-handshake-angle\"></i>Gestão de Parceiros</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.resolv.ai/webhook/equipe'\" data-menu=\"team\"><i class=\"fas fa-users\"></i>Equipe</button>\n                <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.resolv.ai/webhook/conf'\" data-menu=\"settings\"><i class=\"fas fa-cog\"></i>Configurações</button>\n            </div>\n        </nav>\n\n        <main class=\"main-content\" id=\"mainContent\">\n            <nav class=\"top-nav\">\n                <div class=\"d-flex align-items-center\">\n                    <button class=\"sidebar-toggle\" id=\"sidebarToggle\"><i class=\"fas fa-bars\"></i></button>\n                    <h5 class=\"mb-0 ms-3\" id=\"pageTitle\">Dashboard de Clientes</h5>\n                </div>\n                <div class=\"user-info\">\n                    <div class=\"d-flex align-items-center\">\n                        <i class=\"fas fa-user-circle fs-4 text-primary me-2\"></i>\n                        <span class=\"fw-bold\" id=\"userNameDisplay\">Usuário</span>\n                    </div>\n                    <button class=\"btn btn-outline-danger btn-sm ms-2\" id=\"logoutButton\" title=\"Sair\">\n                        <i class=\"fas fa-sign-out-alt me-1\"></i>Sair\n                    </button>\n                </div>\n            </nav>\n\n            <div class=\"content-area\">\n                <div id=\"tasks-page\" class=\"page-content active\">\n                    <div class=\"card form-card mb-4\">\n                        <div class=\"card-header bg-primary text-white d-flex justify-content-between align-items-center\">\n                            <h5 class=\"mb-0\">\n                                <i class=\"fas fa-plus me-2\"></i><span id=\"formTitle\">Adicionar Nova Tarefa</span>\n                            </h5>\n                            <button class=\"btn btn-light btn-sm\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#formCollapse\" aria-expanded=\"true\">\n                                <i class=\"fas fa-chevron-down\"></i>\n                            </button>\n                        </div>\n                        <div class=\"collapse show\" id=\"formCollapse\">\n                            <div class=\"card-body\">\n                                <form id=\"taskForm\">\n                                    <input type=\"hidden\" id=\"taskId\">\n                                    <div class=\"row g-3\">\n                                        <div class=\"col-md-6\">\n                                            <label for=\"taskType\" class=\"form-label required-field\">Tipo de Tarefa</label>\n                                            <div class=\"input-group\">\n                                                <select class=\"form-select\" id=\"taskType\" required></select>\n                                                <button class=\"btn btn-outline-primary\" type=\"button\" id=\"addNewTaskTypeBtn\" title=\"Adicionar Novo Tipo de Tarefa\">\n                                                    <i class=\"fas fa-plus\"></i> NOVA TAREFA\n                                                </button>\n                                            </div>\n                                        </div>\n                                        <div class=\"col-md-6\">\n                                            <label for=\"taskDescription\" class=\"form-label required-field\">Resumo da Descrição</label>\n                                            <input type=\"text\" class=\"form-control\" id=\"taskDescription\" required>\n                                        </div>\n                                        <div class=\"col-md-4\">\n                                            <label for=\"project\" class=\"form-label required-field\">Projeto</label>\n                                            <input type=\"text\" class=\"form-control\" id=\"project\" required>\n                                        </div>\n                                        <div class=\"col-md-4\">\n                                            <label for=\"client\" class=\"form-label\">Cliente</label>\n                                            <div class=\"input-group\">\n                                                <select class=\"form-select\" id=\"client\"></select>\n                                                <button class=\"btn btn-outline-primary\" type=\"button\" id=\"addNewClientBtn\" title=\"Adicionar Novo Cliente\">\n                                                    <i class=\"fas fa-plus\"></i> NOVO CLIENTE\n                                                </button>\n                                            </div>\n                                        </div>\n                                        <div class=\"col-md-4\">\n                                            <label for=\"company\" class=\"form-label\">Empresa</label>\n                                            <select class=\"form-select\" id=\"company\"></select>\n                                        </div>\n                                        <div class=\"col-md-4\">\n                                            <label for=\"responsible\" class=\"form-label required-field\">Responsável</label>\n                                            <select class=\"form-select\" id=\"responsible\" required></select>\n                                        </div>\n                                        <div class=\"col-md-4\">\n                                            <label for=\"startDate\" class=\"form-label required-field\">Data Início</label>\n                                            <input type=\"date\" class=\"form-control\" id=\"startDate\" required>\n                                        </div>\n                                        <div class=\"col-md-4\">\n                                            <label for=\"endDate\" class=\"form-label required-field\">Data Final</label>\n                                            <input type=\"date\" class=\"form-control\" id=\"endDate\" required>\n                                        </div>\n                                        <div class=\"col-md-4\">\n                                            <label for=\"completionDate\" class=\"form-label\">Data de Finalização</label>\n                                            <input type=\"date\" class=\"form-control\" id=\"completionDate\">\n                                        </div>\n                                        <div class=\"col-md-2\">\n                                            <label for=\"estimatedHours\" class=\"form-label\">Horas Estimadas</label>\n                                            <input type=\"text\" class=\"form-control hour-input\" id=\"estimatedHours\" value=\"0\" placeholder=\"Ex: 8,5\">\n                                        </div>\n                                        <div class=\"col-md-2\">\n                                            <label for=\"actualHours\" class=\"form-label\">Horas Realizadas</label>\n                                            <input type=\"text\" class=\"form-control hour-input\" id=\"actualHours\" value=\"0\" placeholder=\"Ex: 8,5\">\n                                        </div>\n                                        <div class=\"col-md-2\">\n                                            <label for=\"deviation\" class=\"form-label\">Desvio (Horas)</label>\n                                            <input type=\"text\" class=\"form-control hour-input\" id=\"deviation\" readonly>\n                                        </div>\n                                        <div class=\"col-md-2\">\n                                            <label for=\"status\" class=\"form-label\">Situação</label>\n                                            <select class=\"form-select\" id=\"status\"></select>\n                                        </div>\n                                    </div>\n                                    <div class=\"d-flex justify-content-end mt-4 gap-2\">\n                                        <button type=\"button\" class=\"btn btn-secondary\" id=\"clearFormBtn\">\n                                            <i class=\"fas fa-eraser me-2\"></i>Limpar\n                                        </button>\n                                        <button type=\"submit\" class=\"btn btn-primary\" id=\"saveTaskBtn\">\n                                            <i class=\"fas fa-save me-2\"></i>Adicionar Tarefa\n                                        </button>\n                                    </div>\n                                </form>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"card form-card mb-4\">\n                        <div class=\"card-header bg-secondary text-white d-flex justify-content-between align-items-center\">\n                            <h5 class=\"mb-0\">\n                                <i class=\"fas fa-filter me-2\"></i>Filtros\n                            </h5>\n                            <button class=\"btn btn-light btn-sm\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#filtersCollapse\" aria-expanded=\"false\">\n                                <i class=\"fas fa-chevron-down\"></i>\n                            </button>\n                        </div>\n                        <div class=\"collapse\" id=\"filtersCollapse\">\n                            <div class=\"card-body\">\n                                <div class=\"filters-container\">\n                                    <div class=\"filter-item\">\n                                        <label for=\"filterResponsible\" class=\"form-label\">Responsável</label>\n                                        <select class=\"form-select\" id=\"filterResponsible\"></select>\n                                    </div>\n                                    <div class=\"filter-item\">\n                                        <label for=\"filterProject\" class=\"form-label\">Projeto</label>\n                                        <select class=\"form-select\" id=\"filterProject\"></select>\n                                    </div>\n                                    <div class=\"filter-item\">\n                                        <label for=\"filterClient\" class=\"form-label\">Cliente</label>\n                                        <select class=\"form-select\" id=\"filterClient\"></select>\n                                    </div>\n                                    <div class=\"filter-item\">\n                                        <label for=\"filterCompany\" class=\"form-label\">Empresa</label>\n                                        <select class=\"form-select\" id=\"filterCompany\"></select>\n                                    </div>\n                                    <div class=\"filter-item\">\n                                        <label for=\"filterStatus\" class=\"form-label\">Situação</label>\n                                        <select class=\"form-select\" id=\"filterStatus\"></select>\n                                    </div>\n                                    <div class=\"filter-item\">\n                                        <label for=\"filterTaskType\" class=\"form-label\">Tipo de Tarefa</label>\n                                        <select class=\"form-select\" id=\"filterTaskType\"></select>\n                                    </div>\n                                    <div class=\"filter-item\">\n                                        <label for=\"filterStartDate\" class=\"form-label\">Data Início (De)</label>\n                                        <input type=\"date\" class=\"form-control\" id=\"filterStartDate\">\n                                    </div>\n                                    <div class=\"filter-item\">\n                                        <label for=\"filterEndDate\" class=\"form-label\">Data Início (Até)</label>\n                                        <input type=\"date\" class=\"form-control\" id=\"filterEndDate\">\n                                    </div>\n                                </div>\n                                <div class=\"d-flex justify-content-end gap-2 mt-3\">\n                                    <button type=\"button\" class=\"btn btn-info\" id=\"applyFiltersBtn\">\n                                        <i class=\"fas fa-search me-2\"></i>Filtrar\n                                    </button>\n                                    <button type=\"button\" class=\"btn btn-secondary\" id=\"clearFiltersBtn\">\n                                        <i class=\"fas fa-times me-2\"></i>Limpar Filtros\n                                    </button>\n                                    <button type=\"button\" class=\"btn btn-success\" id=\"exportExcelBtn\">\n                                        <i class=\"fas fa-file-excel me-2\"></i>Exportar Excel\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"table-container\">\n                        <h5 class=\"mb-3\">\n                            <i class=\"fas fa-list text-primary me-2\"></i>\n                            Lista de Tarefas\n                        </h5>\n\n                        <ul class=\"nav nav-tabs\" id=\"taskTabs\" role=\"tablist\">\n                            <li class=\"nav-item\" role=\"presentation\">\n                                <button class=\"nav-link active\" id=\"approved-tab\" data-bs-toggle=\"tab\" data-bs-target=\"#approved-tab-pane\" type=\"button\" role=\"tab\" aria-controls=\"approved-tab-pane\" aria-selected=\"true\">Aprovados</button>\n                            </li>\n                            <li class=\"nav-item\" role=\"presentation\">\n                                <button class=\"nav-link\" id=\"pending-tab\" data-bs-toggle=\"tab\" data-bs-target=\"#pending-tab-pane\" type=\"button\" role=\"tab\" aria-controls=\"pending-tab-pane\" aria-selected=\"false\">\n                                    Pendentes <span class=\"badge bg-danger\" id=\"pending-count\">0</span>\n                                </button>\n                            </li>\n                        </ul>\n\n                        <div class=\"tab-content\" id=\"taskTabsContent\">\n                            <div class=\"tab-pane fade show active\" id=\"approved-tab-pane\" role=\"tabpanel\" aria-labelledby=\"approved-tab\" tabindex=\"0\">\n                                <div class=\"table-responsive pt-3\">\n                                    <table id=\"taskTableApproved\" class=\"table table-striped table-hover\" style=\"width:100%\">\n                                        <thead>\n                                            <tr>\n                                                <th>Id</th>\n                                                <th>Controle de Horas</th>\n                                                <th>Tipo de Tarefa</th>\n                                                <th>Resumo</th>\n                                                <th>Projeto</th>\n                                                <th>Cliente</th>\n                                                <th>Empresa</th>\n                                                <th>Responsável</th>\n                                                <th>Data Início</th>\n                                                <th>Data Final</th>\n                                                <th>Data Finalizada</th>\n                                                <th>Estimativa (h)</th>\n                                                <th>Realizado (h)</th>\n                                                <th>Desvio (h)</th>\n                                                <th>Situação</th>\n                                                <th>Ações</th>\n                                            </tr>\n                                        </thead>\n                                        <tbody></tbody>\n                                    </table>\n                                </div>\n                            </div>\n                            <div class=\"tab-pane fade\" id=\"pending-tab-pane\" role=\"tabpanel\" aria-labelledby=\"pending-tab\" tabindex=\"0\">\n                                <div class=\"d-flex justify-content-end my-3\">\n                                    <div class=\"col-md-3\">\n                                        <label for=\"filterPendingStatus\" class=\"form-label\">Filtrar por Status</label>\n                                        <select class=\"form-select form-select-sm\" id=\"filterPendingStatus\">\n                                            <option value=\"false\" selected>Pendente</option>\n                                            <option value=\"canceled\">Cancelado</option>\n                                        </select>\n                                    </div>\n                                </div>\n                                <div class=\"table-responsive\">\n                                    <table id=\"taskTablePending\" class=\"table table-striped table-hover\" style=\"width:100%\">\n                                        <thead>\n                                            <tr>\n                                                <th>Id</th>\n                                                <th>Tipo de Tarefa</th>\n                                                <th>Resumo</th>\n                                                <th>Projeto</th>\n                                                <th>Responsável</th>\n                                                <th>Data Início</th>\n                                                <th>Estimativa (h)</th>\n                                                <th>Status Aprovação</th>\n                                                <th>Motivo da Recusa</th>\n                                                <th>Ações</th>\n                                            </tr>\n                                        </thead>\n                                        <tbody></tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </main>\n\n        <div class=\"sidebar-overlay\" id=\"sidebarOverlay\"></div>\n\n        <div class=\"modal fade\" id=\"confirmTaskModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-lg\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-primary text-white\">\n                        <h5 class=\"modal-title\" id=\"confirmTaskModalTitle\">Confirmar Dados da Tarefa</h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\"></div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">\n                            <i class=\"fas fa-edit me-2\"></i>Editar\n                        </button>\n                        <button type=\"button\" class=\"btn btn-primary\" id=\"confirmTaskBtn\">\n                            <i class=\"fas fa-check me-2\"></i>OK - Confirmar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class=\"modal fade\" id=\"deleteModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-danger text-white\">\n                        <h5 class=\"modal-title\">Confirmar Exclusão</h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <p>Tem certeza que deseja excluir esta tarefa? Esta ação não pode ser desfeita.</p>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                        <button type=\"button\" class=\"btn btn-danger\" id=\"confirmDeleteBtn\">Excluir</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class=\"modal fade\" id=\"resumeModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-primary text-white\">\n                        <h5 class=\"modal-title\">Resumo Completo da Tarefa</h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <p id=\"fullResumeText\"></p>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Fechar</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class=\"modal fade\" id=\"timeControlModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-lg\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-primary text-white\">\n                        <h5 class=\"modal-title\">\n                            <i class=\"fas fa-clock me-2\"></i>Controle de Horas - Tarefa ID: <span id=\"timeControlTaskId\"></span>\n                        </h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <div class=\"mb-4\">\n                            <h6 class=\"text-secondary mb-3\">Informações da Tarefa</h6>\n                            <table class=\"table table-sm\">\n                                <tr><td><strong>Descrição:</strong></td><td id=\"timeControlTaskDescription\"></td></tr>\n                                <tr><td><strong>Responsável:</strong></td><td id=\"timeControlTaskResponsible\"></td></tr>\n                                <tr><td><strong>Projeto:</strong></td><td id=\"timeControlTaskProject\"></td></tr>\n                            </table>\n                        </div>\n                        <div id=\"timeControlObservationSection\" class=\"mb-4\">\n                            <label for=\"timeControlObservation\" class=\"form-label required-field\">Observação</label>\n                            <textarea class=\"form-control\" id=\"timeControlObservation\" rows=\"3\" placeholder=\"Descreva o procedimento realizado...\" required></textarea>\n                        </div>\n                        <div class=\"mb-4 d-flex justify-content-center gap-3\" id=\"timeActionButtons\">\n                            <!-- Buttons will be injected here by JavaScript -->\n                        </div>\n                        <div class=\"time-entries-table\">\n                            <h6 class=\"text-secondary mb-3\">Registros de Horas</h6>\n                            <div id=\"timeEntriesTableContainer\">\n                                <p class=\"text-muted text-center\">Nenhum registro de horas para esta tarefa.</p>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Fechar</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class=\"modal fade\" id=\"manualTimeModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-primary text-white\">\n                        <h5 class=\"modal-title\" id=\"manualTimeModalTitle\">Inserir Horário Manualmente</h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <div class=\"mb-3\">\n                            <label for=\"manualDateTimeInput\" class=\"form-label required-field\">Data e Hora</label>\n                            <input type=\"datetime-local\" class=\"form-control\" id=\"manualDateTimeInput\" required>\n                        </div>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                        <button type=\"button\" class=\"btn btn-primary\" id=\"confirmManualTimeBtn\">Confirmar</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class=\"modal fade\" id=\"timeConfirmationModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-warning text-dark\">\n                        <h5 class=\"modal-title\">\n                            <i class=\"fas fa-exclamation-triangle me-2\"></i>Confirmar Ação\n                        </h5>\n                        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <div class=\"text-center mb-3\">\n                            <i class=\"fas fa-clock fs-1 text-warning mb-3\"></i>\n                            <p class=\"fs-5 mb-2\">Tem certeza que deseja realizar esta ação?</p>\n                            <p class=\"text-muted\" id=\"timeConfirmationMessage\">Esta ação irá registrar o controle de horas para a tarefa.</p>\n                        </div>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">\n                            <i class=\"fas fa-times me-1\"></i>Cancelar\n                        </button>\n                        <button type=\"button\" class=\"btn btn-warning\" id=\"confirmTimeActionBtn\">\n                            <i class=\"fas fa-check me-1\"></i>Confirmar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class=\"modal fade\" id=\"newTaskTypeModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-primary text-white\">\n                        <h5 class=\"modal-title\">Adicionar Novo Tipo de Tarefa</h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <form id=\"newTaskTypeForm\">\n                            <div class=\"mb-3\">\n                                <label for=\"newTaskTypeName\" class=\"form-label\">Nome do Novo Tipo de Tarefa</label>\n                                <input type=\"text\" class=\"form-control\" id=\"newTaskTypeName\" style=\"text-transform: uppercase;\" required>\n                            </div>\n                        </form>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                        <button type=\"button\" class=\"btn btn-primary\" id=\"saveNewTaskTypeBtn\">Salvar</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class=\"modal fade\" id=\"newClientModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-lg\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-primary text-white\">\n                        <h5 class=\"modal-title\">Adicionar/Editar Cliente</h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <form id=\"newClientForm\">\n                            <div class=\"row g-3\">\n                                <div class=\"col-md-6\">\n                                    <label for=\"newClientName\" class=\"form-label required-field\">Nome do Cliente</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"newClientName\" style=\"text-transform: uppercase;\" required>\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"newClientCnpj\" class=\"form-label\">CNPJ</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"newClientCnpj\">\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"newClientEmail\" class=\"form-label\">Email</label>\n                                    <input type=\"email\" class=\"form-control\" id=\"newClientEmail\" style=\"text-transform: lowercase;\">\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"newClientPhone\" class=\"form-label\">Telefone</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"newClientPhone\">\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"form-check\">\n                                        <input class=\"form-check-input\" type=\"checkbox\" id=\"newClientActive\" checked>\n                                        <label class=\"form-check-label\" for=\"newClientActive\">\n                                            Cliente Ativo\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </form>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                        <button type=\"button\" class=\"btn btn-primary\" id=\"saveNewClientBtn\">Salvar</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        \n        <div class=\"modal fade\" id=\"approvalActionModal\" tabindex=\"-1\" aria-hidden=\"true\">\n            <div class=\"modal-dialog modal-lg\">\n                <div class=\"modal-content\">\n                    <div class=\"modal-header bg-primary text-white\">\n                        <h5 class=\"modal-title\">Aprovar ou Cancelar Tarefa</h5>\n                        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n                    </div>\n                    <div class=\"modal-body\">\n                        <div id=\"approvalTaskDetails\">\n                        </div>\n                        <div id=\"cancelReasonSection\" class=\"mt-3\" style=\"display: none;\">\n                            <label for=\"cancelReason\" class=\"form-label required-field\">Motivo do Cancelamento</label>\n                            <textarea class=\"form-control\" id=\"cancelReason\" rows=\"3\" required></textarea>\n                        </div>\n                    </div>\n                    <div class=\"modal-footer\">\n                        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Fechar</button>\n                        <div id=\"initialButtons\">\n                            <button type=\"button\" class=\"btn btn-danger\" id=\"showCancelReasonBtn\">Cancelar Tarefa</button>\n                            <button type=\"button\" class=\"btn btn-success\" id=\"confirmApproveBtn\">Aprovar Tarefa</button>\n                        </div>\n                        <div id=\"confirmCancelButtons\" style=\"display: none;\">\n                            <button type=\"button\" class=\"btn btn-secondary\" id=\"backToOptionsBtn\">Voltar</button>\n                            <button type=\"button\" class=\"btn btn-danger\" id=\"confirmCancelBtn\">Confirmar Cancelamento</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n    </div>\n\n    <script src=\"https://code.jquery.com/jquery-3.6.0.min.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n    <script src=\"https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js\"></script>\n    <script src=\"https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js\"></script>\n    <script src=\"https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js\"></script>\n    <script src=\"https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js\"></script>\n    <script src=\"https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js\"></script>\n\n    <script>\n        // --- VARIÁVEIS GLOBAIS ---\n        let tasks = [];\n        let colaboradores = [];\n        let clients = [];\n        let companies = [];\n        let editingTaskId = null;\n        let dataTableApproved;\n        let dataTablePending;\n        let tempTasksData = null;\n        let activeTimeEntry = null;\n        let openTaskIds = new Set();\n        let completedTaskIds = new Set();\n        let globalEndDate = null;\n        let taskTypes = [];\n        let _timeControlState = { action: null, taskId: null };\n\n    // ===================================\n    // FUNÇÕES UTILITÁRIAS GLOBAIS\n    // ===================================\n    function formatDate(dateString) {\n        if (!dateString) return '';\n        const dateParts = dateString.split(/[-T]/);\n        if (dateParts.length < 3) return '';\n        const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);\n        return date.toLocaleDateString('pt-BR');\n    }\n\n    function formatDateTime(dateString) {\n        if (!dateString) return '';\n        \n        // Para valores vindos do /dataHoraatual, exibir exatamente como retornado\n        if (typeof dateString === 'string' && dateString.includes('T')) {\n            // Retorna o valor idêntico do endpoint sem qualquer modificação\n            console.log('📅 Exibindo valor idêntico do endpoint:', dateString);\n            return dateString;\n        }\n        \n        // Fallback para outros formatos históricos\n        const date = new Date(dateString); \n        if (isNaN(date.getTime())) {\n            return 'Data inválida';\n        }\n        \n        return date.toLocaleString('pt-BR', {\n            day: '2-digit',\n            month: '2-digit',\n            year: '2-digit',\n            hour: '2-digit',\n            minute: '2-digit',\n            second: '2-digit'\n        });\n    }\n\n    function formatDateTimeBrazilian(dateString) {\n        if (!dateString) return '';\n        \n        // Formato brasileiro específico para tabela de controle de horas: dd/MM/aa, HH:mm:ss\n        if (typeof dateString === 'string' && dateString.includes('T')) {\n            try {\n                // Para strings como \"2025-09-17T21:26:53.732-03:00\"\n                const [datePart, timePart] = dateString.split('T');\n                if (!datePart || !timePart) return 'Data inválida';\n                \n                const [year, month, day] = datePart.split('-');\n                if (!year || !month || !day) return 'Data inválida';\n                \n                const timeWithTz = timePart.split(/[\\+\\-]/)[0]; // Remove timezone\n                if (!timeWithTz) return 'Data inválida';\n                \n                const [hour, minute, secondWithMs] = timeWithTz.split(':');\n                if (!hour || !minute) return 'Data inválida';\n                \n                // Verificar se secondWithMs existe antes de fazer split\n                const second = secondWithMs ? secondWithMs.split('.')[0] : '00';\n                \n                // Formato: 17/09/25, 21:26:53\n                return `${day}/${month}/${year.slice(-2)}, ${hour}:${minute}:${second}`;\n            } catch (error) {\n                console.error('Erro ao formatar data:', error, 'dateString:', dateString);\n                return 'Data inválida';\n            }\n        }\n        \n        // Fallback para outros formatos históricos\n        const date = new Date(dateString); \n        if (isNaN(date.getTime())) {\n            return 'Data inválida';\n        }\n        \n        return date.toLocaleString('pt-BR', {\n            day: '2-digit',\n            month: '2-digit',\n            year: '2-digit',\n            hour: '2-digit',\n            minute: '2-digit',\n            second: '2-digit'\n        });\n    }\n\n    function calculateDurationInMinutes(startDateString, endDateString) {\n        if (!startDateString || !endDateString) return '---';\n        \n        try {\n            // Função para limpar e corrigir strings de data corrompidas\n            const cleanDateString = (dateString) => {\n                if (!dateString) return dateString;\n                \n                let cleaned = dateString.toString().trim();\n                \n                // Corrigir anos corrompidos - várias abordagens\n                // Exemplo: \"62025-09-17T19:22\" -> \"2025-09-17T19:22\"\n                \n                // Método 1: Remover dígitos extras no início do ano\n                if (cleaned.includes('-') && cleaned.includes('T')) {\n                    const parts = cleaned.split('-');\n                    if (parts.length >= 3 && parts[0].length > 4) {\n                        // Se o primeiro parte (ano) tem mais de 4 dígitos, pegar os últimos 4\n                        const correctedYear = parts[0].slice(-4);\n                        cleaned = correctedYear + '-' + parts.slice(1).join('-');\n                        console.log('📅 Data corrigida:', cleaned, '(original:', dateString + ')');\n                    }\n                }\n                \n                return cleaned;\n            };\n            \n            // Função para converter string de data em objeto Date\n            const parseDateTime = (dateString) => {\n                const cleanedDateString = cleanDateString(dateString);\n                \n                // Se já é um objeto Date válido\n                if (cleanedDateString instanceof Date && !isNaN(cleanedDateString.getTime())) {\n                    return cleanedDateString;\n                }\n                \n                // Tentar parsing com a string limpa\n                if (typeof cleanedDateString === 'string') {\n                    // Método 1: Parse direto da string ISO\n                    let date = new Date(cleanedDateString);\n                    if (!isNaN(date.getTime())) {\n                        return date;\n                    }\n                    \n                    // Método 2: Se não tem segundos, adicionar \":00\"\n                    if (cleanedDateString.includes('T') && !cleanedDateString.includes(':00') && cleanedDateString.split(':').length === 2) {\n                        const withSeconds = cleanedDateString + ':00';\n                        date = new Date(withSeconds);\n                        if (!isNaN(date.getTime())) {\n                            return date;\n                        }\n                    }\n                }\n                \n                throw new Error(`Não foi possível converter para Date: ${cleanedDateString} (original: ${dateString})`);\n            };\n            \n            const startDate = parseDateTime(startDateString);\n            const endDate = parseDateTime(endDateString);\n            \n            console.log('🕐 Calculando duração:', {\n                start: startDate.toISOString(),\n                end: endDate.toISOString()\n            });\n            \n            // Calcular diferença em milissegundos e converter para minutos\n            const diffInMilliseconds = endDate.getTime() - startDate.getTime();\n            const diffInMinutes = Math.round(diffInMilliseconds / 60000);\n            \n            console.log('⏱️ Duração calculada:', diffInMinutes, 'minutos');\n            \n            // Sempre retornar valor positivo para representar tempo trabalhado\n            return Math.abs(diffInMinutes);\n            \n        } catch (error) {\n            console.error('❌ Erro ao calcular duração:', error.message, {\n                start: startDateString,\n                end: endDateString\n            });\n            return 0; // Retornar 0 em vez de 'Erro' para manter consistência numérica\n        }\n    }\n    \n    function parseDecimalInput(value) {\n        if (!value || value === '') return 0;\n        const cleanValue = value.toString().trim().replace(/\\s/g, '').replace(',', '.');\n        const parsed = parseFloat(cleanValue);\n        return isNaN(parsed) ? 0 : parsed;\n    }\n\n    function calculateDeviation() {\n        const estimated = parseDecimalInput(document.getElementById('estimatedHours').value);\n        const actual = parseDecimalInput(document.getElementById('actualHours').value);\n        const deviation = actual - estimated;\n        const deviationEl = document.getElementById('deviation');\n        deviationEl.value = formatDecimalOutput(deviation);\n        deviationEl.className = 'form-control hour-input';\n        if (deviation > 0) deviationEl.classList.add('positive-deviation');\n        if (deviation < 0) deviationEl.classList.add('negative-deviation');\n    }\n    \n    function formatDecimalOutput(value) {\n        const num = parseFloat(value);\n        return isNaN(num) ? '0,00' : num.toFixed(2).replace('.', ',');\n    }\n\n    function truncateResume(text, maxLength = 18) {\n        if (!text || text.length <= maxLength) return text || '';\n        return text.substring(0, maxLength) + '...';\n    }\n    \n    function toggleFormLock(isEditing = false) {\n        const userData = Auth.getUserData();\n        const userType = userData?.tipo || 'colaborador';\n\n        const allFields = [\n            'taskType', 'taskDescription', 'project', 'client', 'company',\n            'responsible', 'startDate', 'endDate', 'estimatedHours',\n            'completionDate', 'actualHours', 'status'\n        ];\n\n        const isColaborador = userType === 'colaborador';\n        const fieldsToDisable = isColaborador && isEditing ? {\n            taskType: true, taskDescription: true, project: true, client: true, company: true,\n            responsible: true, startDate: true, endDate: true, completionDate: false, \n            estimatedHours: true, actualHours: false, deviation: true, status: false\n        } : {};\n\n        allFields.forEach(fieldId => {\n            const el = document.getElementById(fieldId);\n            if (el) {\n                el.disabled = (isColaborador && isEditing) ? fieldsToDisable[fieldId] : (fieldId === 'deviation');\n            }\n        });\n        document.getElementById('deviation').disabled = true;\n    }\n\n    // ===================================\n    // SAFE STORAGE FOR SANDBOXED IFRAMES\n    // ===================================\n    const SafeStorage = (() => {\n        let memoryStorage = {};\n        let isLocalStorageAvailable = false;\n\n        try {\n            const test = '__storage_test__';\n            localStorage.setItem(test, test);\n            localStorage.removeItem(test);\n            isLocalStorageAvailable = true;\n        } catch (e) {\n            isLocalStorageAvailable = false;\n            console.warn('⚠️ localStorage não disponível, usando armazenamento via window.name');\n            \n            if (window.name) {\n                try {\n                    memoryStorage = JSON.parse(window.name);\n                } catch (e) {\n                    memoryStorage = {};\n                }\n            }\n            \n            const urlParams = new URLSearchParams(window.location.search);\n            if (urlParams.has('session')) {\n                try {\n                    const sessionData = JSON.parse(atob(urlParams.get('session')));\n                    memoryStorage['authToken'] = sessionData.token;\n                    memoryStorage['userSession'] = JSON.stringify(sessionData);\n                    window.name = JSON.stringify(memoryStorage);\n                } catch (e) {\n                    console.error('Erro ao processar sessão da URL:', e);\n                }\n            }\n        }\n\n        return {\n            getItem: (key) => {\n                if (isLocalStorageAvailable) {\n                    return localStorage.getItem(key);\n                }\n                return memoryStorage[key] || null;\n            },\n            setItem: (key, value) => {\n                if (isLocalStorageAvailable) {\n                    localStorage.setItem(key, value);\n                } else {\n                    memoryStorage[key] = value;\n                    window.name = JSON.stringify(memoryStorage);\n                }\n            },\n            removeItem: (key) => {\n                if (isLocalStorageAvailable) {\n                    localStorage.removeItem(key);\n                } else {\n                    delete memoryStorage[key];\n                    window.name = JSON.stringify(memoryStorage);\n                }\n            },\n            clear: () => {\n                if (isLocalStorageAvailable) {\n                    localStorage.clear();\n                } else {\n                    memoryStorage = {};\n                    window.name = '';\n                }\n            }\n        };\n    })();\n    \n    // ===================================\n    // OBJETOS GLOBAIS (AUTH e UI)\n    // ===================================\n    const Auth = {\n        getUserData: () => {\n            const sessionData = SafeStorage.getItem('userSession');\n            return sessionData ? JSON.parse(sessionData) : null;\n        },\n        checkAuth: () => {\n            const authToken = SafeStorage.getItem('authToken');\n            const userData = Auth.getUserData();\n            console.log('🔐 Verificando status de login...', { hasToken: !!authToken, hasData: !!userData });\n            \n            // Verificação real de autenticação (sem mock)\n            if (!authToken || !userData) {\n                console.log('❌ Autenticação inválida. Redirecionando para login...');\n                return false;\n            }\n            \n            // Validar estrutura dos dados de sessão\n            if (!userData.nome || !userData.tipo || !userData.email) {\n                console.log('❌ Dados de sessão inválidos. Limpando e redirecionando...');\n                SafeStorage.clear();\n                return false;\n            }\n            \n            console.log('✅ Autenticação válida para:', userData.nome, `(${userData.tipo})`);\n            return true;\n        },\n        logout: () => {\n            console.log('🚪 Iniciando processo de logout...');\n            SafeStorage.clear();\n            const authLoadingEl = document.getElementById('authLoading');\n            if (authLoadingEl) {\n                authLoadingEl.style.display = 'flex';\n                authLoadingEl.innerHTML = `<div class=\"spinner-auth\"></div><h4>Sessão encerrada</h4><p>Você será redirecionado para o login.</p>`;\n            }\n            document.getElementById('appContainer').style.opacity = 0;\n            setTimeout(() => { window.location.href = 'https://n8n.resolv.ai/webhook/login'; }, 1500);\n        },\n        redirectToLogin: () => {\n            console.log('🔄 Redirecionando para página de login...');\n            window.location.href = 'https://n8n.resolv.ai/webhook/login';\n        }\n    };\n\n    const UI = {\n        updateUserInfo: () => {\n            const userData = Auth.getUserData();\n            if (userData) {\n                document.getElementById('userNameDisplay').textContent = userData.nome;\n                console.log('👤 Informações do usuário atualizadas:', userData.nome);\n            }\n        },\n        showAuthenticatedInterface: () => {\n            document.getElementById('authLoading').style.display = 'none';\n            document.getElementById('appContainer').classList.add('authenticated');\n            console.log('🎉 Interface principal ativada.');\n        },\n        applyUIPermissions: () => {\n            const userData = Auth.getUserData();\n            const userType = userData?.tipo || 'colaborador';\n            console.log(`🔧 Aplicando permissões de UI para o tipo: ${userType}`);\n\n            const menuPermissions = {\n                admin: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'],\n                colaborador: ['dashboard', 'tasks', 'hours', 'settings']\n            };\n            const allowedMenus = menuPermissions[userType] || menuPermissions.colaborador;\n\n            document.querySelectorAll('#sidebarMenu .menu-item').forEach(item => {\n                const menuType = item.getAttribute('data-menu');\n                item.style.display = allowedMenus.includes(menuType) ? 'block' : 'none';\n            });\n\n            const newTaskTypeBtn = document.getElementById('addNewTaskTypeBtn');\n            const newClientBtn = document.getElementById('addNewClientBtn');\n\n            const isAdmin = userType === 'admin';\n            if (newTaskTypeBtn) newTaskTypeBtn.style.display = isAdmin ? '' : 'none';\n            if (newClientBtn) newClientBtn.style.display = isAdmin ? '' : 'none';\n            \n            toggleFormLock(false);\n        },\n        showNotification: (message, type = 'info', duration = 5000) => {\n            const container = document.body;\n            const alertType = type === 'error' ? 'danger' : type;\n            const iconMap = { success: 'check-circle', warning: 'exclamation-triangle', danger: 'times-circle', info: 'info-circle' };\n            const icon = iconMap[type] || 'info-circle';\n            const notification = document.createElement('div');\n            notification.className = `alert alert-${alertType} alert-dismissible fade show shadow-lg notification`;\n            notification.innerHTML = `<i class=\"fas fa-${icon} me-2\"></i> ${message} <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>`;\n            container.appendChild(notification);\n            setTimeout(() => {\n                const bsAlert = bootstrap.Alert.getOrCreateInstance(notification);\n                if (bsAlert) {\n                    bsAlert.close();\n                }\n            }, duration);\n        },\n        toggleSidebar: () => {\n            const sidebar = document.getElementById('sidebar');\n            const overlay = document.getElementById('sidebarOverlay');\n            const mainContent = document.getElementById('mainContent');\n            if (window.innerWidth <= 768) {\n                sidebar.classList.toggle('show');\n                overlay.classList.toggle('show');\n                document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';\n            } else {\n                sidebar.classList.toggle('collapsed');\n                mainContent.classList.toggle('expanded');\n            }\n        }\n    };\n    \n    // ===================================\n    // LÓGICA DO MODAL DE HORAS\n    // ===================================\n    async function sendTimeEntryUpdate(action, taskId, observation, manualTimestamp = null) {\n        const userData = Auth.getUserData();\n        if (!userData) {\n            UI.showNotification('Sua sessão expirou. Por favor, faça login novamente.', 'error');\n            return;\n        }\n\n        let horaPayload;\n\n        try {\n            if (manualTimestamp) {\n                // Para data manual, usa o valor exato inserido pelo usuário sem conversões\n                horaPayload = manualTimestamp;\n                console.log('📅 Hora manual inserida:', horaPayload);\n            } else {\n                // Para data automática, busca a hora atual do webhook e usa exatamente como retornado\n                console.log('🔄 Buscando hora atual do servidor...');\n                const response = await fetch('https://n8n.resolv.ai/webhook/dataHoraatual');\n                if (!response.ok) {\n                    throw new Error('Falha ao buscar a hora atual do servidor.');\n                }\n                const data = await response.json();\n                console.log('📡 Dados recebidos do /dataHoraatual:', data);\n                \n                if (data && data.length > 0 && data[0].currentDate) {\n                    // Usa exatamente o valor retornado pelo endpoint, sem conversões\n                    horaPayload = data[0].currentDate;\n                    console.log('✅ Hora automática extraída (valor idêntico):', horaPayload);\n                } else {\n                    throw new Error('Formato de data e hora inválido recebido do servidor.');\n                }\n            }\n        } catch(error) {\n             console.error('❌ Erro ao obter a hora:', error);\n             UI.showNotification('Erro ao processar a hora. Usando hora local como fallback.', 'warning');\n             // Fallback também sem conversões desnecessárias\n             horaPayload = new Date().toISOString();\n        }\n\n\n        const timeEntryPayload = {\n            action: action === 'start' ? 'start_time' : 'stop_time',\n            id_type: taskId,\n            type: \"tarefa\",\n            observacao: observation,\n            responsavel: userData.nome,\n            hora: horaPayload\n        };\n\n        if (action === 'stop' && activeTimeEntry) {\n            timeEntryPayload.id = activeTimeEntry.id;\n            \n            // Calcular duração em minutos\n            try {\n                const minutosCalculados = calculateDurationInMinutes(activeTimeEntry.hora_inicial, horaPayload);\n                timeEntryPayload.minutos_trabalhados = minutosCalculados;\n                console.log(`🕐 Duração calculada: ${minutosCalculados} minutos (${activeTimeEntry.hora_inicial} até ${horaPayload})`);\n            } catch (error) {\n                console.error('❌ Erro ao calcular minutos:', error);\n                timeEntryPayload.minutos_trabalhados = 0;\n            }\n            \n            console.log(`🔍 Finalizando registro específico ID: ${activeTimeEntry.id}`, activeTimeEntry);\n        } else if (action === 'stop' && !activeTimeEntry) {\n            console.error('⚠️ ERRO: Tentativa de finalizar sem activeTimeEntry definido!');\n            UI.showNotification('Erro: Nenhum registro ativo encontrado para finalizar.', 'error');\n            return;\n        }\n\n        try {\n            // Logging detalhado para debug de problemas cross-browser\n            console.log(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n            console.log(\"📤 ENVIANDO REQUISIÇÃO PARA WEBHOOK\");\n            console.log(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n            console.log(\"🌐 Navegador:\", navigator.userAgent);\n            \n            // Cache busting via query string (não usar headers customizados para evitar CORS preflight)\n            const cacheBuster = `_cb=${Date.now()}`;\n            const webhookUrl = `https://n8n.resolv.ai/webhook/salvatarefas?${cacheBuster}`;\n            \n            console.log(\"🔗 URL:\", webhookUrl);\n            console.log(\"📦 Payload completo:\", JSON.stringify(timeEntryPayload, null, 2));\n            console.log(\"🍪 Cookies:\", document.cookie || 'Nenhum cookie encontrado');\n            console.log(\"⏰ Timestamp local:\", new Date().toISOString());\n            \n            const requestHeaders = { \n                'Content-Type': 'application/json'\n            };\n            \n            console.log(\"📋 Headers da requisição:\", JSON.stringify(requestHeaders, null, 2));\n            \n            const response = await fetch(webhookUrl, {\n                method: 'POST',\n                headers: requestHeaders,\n                body: JSON.stringify(timeEntryPayload),\n                cache: 'no-cache',\n                credentials: 'same-origin'\n            });\n\n            console.log(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n            console.log(\"📥 RESPOSTA RECEBIDA DO WEBHOOK\");\n            console.log(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n            console.log(\"✅ Status HTTP:\", response.status, response.statusText);\n            console.log(\"📊 Headers da resposta:\");\n            for (let [key, value] of response.headers.entries()) {\n                console.log(`   ${key}: ${value}`);\n            }\n            \n            const responseText = await response.text();\n            console.log(\"📄 Corpo da resposta (raw):\", responseText);\n            \n            let responseData;\n            try {\n                responseData = JSON.parse(responseText);\n                console.log(\"📋 Corpo da resposta (JSON):\", JSON.stringify(responseData, null, 2));\n            } catch (e) {\n                console.log(\"⚠️ Resposta não é JSON válido\");\n                responseData = responseText;\n            }\n\n            if (response.ok) {\n                console.log(\"✅ REQUISIÇÃO BEM-SUCEDIDA!\");\n                console.log(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n                UI.showNotification(`Ação de ${action === 'start' ? 'início' : 'fim'} registrada com sucesso!`, 'success');\n                setTimeout(async () => {\n                    await loadAndDisplayTimeEntries(taskId);\n                }, 4000); \n            } else {\n                console.error(\"❌ REQUISIÇÃO FALHOU!\");\n                console.error(\"Resposta de erro:\", responseText);\n                console.log(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n                throw new Error(`Falha ao registrar a ação de tempo: ${responseText}`);\n            }\n        } catch (error) {\n            console.error(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n            console.error('❌ ERRO NA AÇÃO DE TEMPO');\n            console.error(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n            console.error('Tipo de erro:', error.name);\n            console.error('Mensagem:', error.message);\n            console.error('Stack:', error.stack);\n            console.error(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n            UI.showNotification('Erro ao processar sua solicitação.', 'error');\n        }\n    }\n\n\n    async function loadAndDisplayTimeEntries(taskId) {\n        const container = document.getElementById('timeEntriesTableContainer');\n        const actionBtnContainer = document.getElementById('timeActionButtons');\n        container.innerHTML = '<div class=\"d-flex justify-content-center\"><div class=\"spinner-border spinner-border-sm\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div></div>';\n        activeTimeEntry = null;\n\n        // Verificar se a tarefa está concluída (apenas status CONCLUÍDO)\n        const task = tasks.find(t => String(t.id) === String(taskId));\n        const isTaskCompleted = task && task.status === 'CONCLUÍDO';\n        const disabledAttr = isTaskCompleted ? 'disabled' : '';\n        const disabledClass = isTaskCompleted ? 'disabled' : '';\n\n        try {\n            const response = await fetch(`https://n8n.resolv.ai/webhook/consultadontrolehoras?id_type=${taskId}`);\n            if (!response.ok) throw new Error('Falha ao buscar registros de tempo');\n            \n            const entries = await response.json();\n            const taskEntries = Array.isArray(entries) ? entries.filter(e => String(e.id_type) === String(taskId)) : [];\n\n            if (taskEntries.length === 0) {\n                container.innerHTML = '<p class=\"text-muted text-center\">Nenhum registro de horas para esta tarefa.</p>';\n                actionBtnContainer.innerHTML = `\n                    <button class=\"btn btn-success ${disabledClass}\" id=\"startAutomaticBtn\" data-task-id=\"${taskId}\" ${disabledAttr}>Início Automático</button>\n                    <button class=\"btn btn-secondary ${disabledClass}\" id=\"startManualBtn\" data-task-id=\"${taskId}\" ${disabledAttr}>Início Manual</button>\n                `;\n                return;\n            }\n\n            let tableHtml = `\n                <table class=\"table table-sm table-striped\">\n                    <thead>\n                        <tr>\n                            <th>Início</th>\n                            <th>Fim</th>\n                            <th>Duração (min)</th>\n                            <th>Observação</th>\n                            <th>Status</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n            `;\n\n            let hasOpenEntry = false;\n            let openEntries = [];\n            \n            // Identificar e listar todos os registros em aberto ANTES da ordenação\n            taskEntries.forEach(entry => {\n                if (!entry.hora_final) {\n                    openEntries.push(entry);\n                }\n            });\n\n            // Log para debug: verificar se há múltiplos registros em aberto\n            console.log(`📊 Registros em aberto encontrados: ${openEntries.length}`, openEntries);\n\n            // Definir o activeTimeEntry como o mais recente dos registros em aberto\n            if (openEntries.length > 0) {\n                // Ordenar registros em aberto por data decrescente e pegar o primeiro (mais recente)\n                openEntries.sort((a, b) => {\n                    const dateA = new Date(a.hora_inicial || 0);\n                    const dateB = new Date(b.hora_inicial || 0);\n                    return dateB - dateA;\n                });\n                \n                activeTimeEntry = openEntries[0];\n                hasOpenEntry = true;\n                \n                console.log('🎯 ActiveTimeEntry definido:', activeTimeEntry);\n                \n                // Se há múltiplos registros em aberto, alertar\n                if (openEntries.length > 1) {\n                    console.warn(`⚠️ ATENÇÃO: ${openEntries.length} registros em aberto simultaneamente! Usando o mais recente como ativo.`);\n                    UI.showNotification(`⚠️ Múltiplos registros em aberto! Usando o mais recente.`, 'warning');\n                }\n            } else {\n                activeTimeEntry = null;\n            }\n            \n            // Ordenar os registros com prioridade:\n            // 1º: Lançamentos em aberto (sem hora_final) no topo\n            // 2º: Lançamentos concluídos em ordem decrescente por data\n            taskEntries.sort((a, b) => {\n                const aIsOpen = !a.hora_final;\n                const bIsOpen = !b.hora_final;\n                \n                // Se um está em aberto e o outro não, priorizar o em aberto\n                if (aIsOpen && !bIsOpen) return -1;\n                if (!aIsOpen && bIsOpen) return 1;\n                \n                // Se ambos estão em aberto ou ambos estão concluídos, ordenar por data decrescente\n                const dateA = new Date(a.hora_inicial || 0);\n                const dateB = new Date(b.hora_inicial || 0);\n                return dateB - dateA; // Ordem decrescente (mais recente primeiro)\n            });\n            \n            taskEntries.forEach(entry => {\n                const startTime = formatDateTimeBrazilian(entry.hora_inicial); \n                const endTime = entry.hora_final ? formatDateTimeBrazilian(entry.hora_final) : '---';\n                const duration = entry.hora_final && entry.hora_inicial ? \n                    calculateDurationInMinutes(entry.hora_inicial, entry.hora_final) : '---';\n                const statusClass = entry.hora_final ? 'time-entry-completed' : 'time-entry-active';\n                const statusText = entry.hora_final ? 'Concluído' : 'Ativo';\n\n                tableHtml += `\n                    <tr>\n                        <td>${startTime}</td>\n                        <td>${endTime}</td>\n                        <td>${duration}</td>\n                        <td>${entry.observacao || ''}</td>\n                        <td><span class=\"time-entry-status ${statusClass}\">${statusText}</span></td>\n                    </tr>\n                `;\n            });\n\n            tableHtml += '</tbody></table>';\n            container.innerHTML = tableHtml;\n\n            if (hasOpenEntry) {\n                actionBtnContainer.innerHTML = `\n                    <button class=\"btn btn-danger\" id=\"stopAutomaticBtn\" data-task-id=\"${taskId}\">Fim Automático</button>\n                    <button class=\"btn btn-secondary\" id=\"stopManualBtn\" data-task-id=\"${taskId}\">Fim Manual</button>\n                `;\n            } else {\n                actionBtnContainer.innerHTML = `\n                    <button class=\"btn btn-success ${disabledClass}\" id=\"startAutomaticBtn\" data-task-id=\"${taskId}\" ${disabledAttr}>Início Automático</button>\n                    <button class=\"btn btn-secondary ${disabledClass}\" id=\"startManualBtn\" data-task-id=\"${taskId}\" ${disabledAttr}>Início Manual</button>\n                `;\n            }\n\n        } catch (error) {\n            console.error(error);\n            container.innerHTML = '<p class=\"text-danger text-center\">Erro ao carregar registros.</p>';\n        }\n    }\n    \n    function showFullResume(text) {\n        document.getElementById('fullResumeText').textContent = text;\n        new bootstrap.Modal(document.getElementById('resumeModal')).show();\n    }\n    \n    async function openTimeControlModal(taskId) {\n        console.log(\"Abrindo modal para tarefa:\", taskId);\n        const task = tasks.find(t => String(t.id) === String(taskId));\n        if (!task) {\n            UI.showNotification('Tarefa não encontrada!', 'error');\n            return;\n        }\n\n        document.getElementById('timeControlTaskId').textContent = taskId;\n        document.getElementById('timeControlTaskDescription').textContent = task.description;\n        document.getElementById('timeControlTaskResponsible').textContent = task.responsible;\n        document.getElementById('timeControlTaskProject').textContent = task.project;\n        \n        document.getElementById('timeControlObservation').value = '';\n        document.getElementById('timeControlObservationSection').style.display = 'block';\n\n        await loadAndDisplayTimeEntries(taskId);\n\n        const timeControlModal = new bootstrap.Modal(document.getElementById('timeControlModal'));\n        timeControlModal.show();\n    }\n\n\n    document.addEventListener('DOMContentLoaded', async () => {\n        // ===================================\n        // CONSTANTES DA APLICAÇÃO\n        // ===================================\n        const CONFIG_WEBHOOK_URL = 'https://n8n.resolv.ai/webhook/consultaconfiguracoes';\n        const WEBHOOK_URL = 'https://n8n.resolv.ai/webhook/salvatarefas';\n        const WEBHOOK_GET_URL = 'https://n8n.resolv.ai/webhook/consultadadosresolv';\n        const COLABORADORES_WEBHOOK_URL = 'https://n8n.resolv.ai/webhook/consultacolaboradores';\n        const TIME_ENTRIES_GET_URL = 'https://n8n.resolv.ai/webhook/consultadontrolehoras';\n        const TASK_TYPES_GET_URL = 'https://n8n.resolv.ai/webhook/consulta_tarefas';\n        const NEW_TASK_TYPE_POST_URL = 'https://n8n.resolv.ai/webhook/recebedados';\n        const CLIENTS_GET_URL = 'https://n8n.resolv.ai/webhook/consulta_clientes';\n        const NEW_CLIENT_POST_URL = 'https://n8n.resolv.ai/webhook/recebedados';\n        const COMPANIES_GET_URL = 'https://n8n.resolv.ai/webhook/consulta_empresa';\n\n\n        const TASK_STATUSES = [\"NÃO INICIADO\", \"EM ANDAMENTO\", \"CONCLUÍDO\", \"PARALIZADO\"];\n\n        // ===================================\n        // LÓGICA PRINCIPAL DA APLICAÇÃO\n        // ===================================\n        async function initializeApplication() {\n            console.log('🚀 Iniciando lógica principal da aplicação...');\n            try {\n                await loadThemeConfig();\n                await loadTaskTypes();\n                await loadClients();\n                await loadCompanies();\n                populateDropdowns();\n                clearForm();\n                await loadColaboradores();\n                await loadTasks();\n                await loadAllTimeEntriesAndApplyStatus();\n                console.log('✅ Lógica da aplicação inicializada com sucesso');\n            } catch (error) {\n                console.error('❌ Erro durante inicialização da lógica:', error);\n                UI.showNotification('❌ Erro ao carregar dados da aplicação.', 'error');\n            }\n        }\n\n        function populateDropdowns() {\n            populateTaskTypeDropdowns();\n            populateClientDropdowns();\n            populateCompanyDropdowns();\n            populateStatusDropdowns();\n        }\n\n        function populateTaskTypeDropdowns() {\n            const taskTypeSelect = document.getElementById('taskType');\n            const filterTaskTypeSelect = document.getElementById('filterTaskType');\n            taskTypeSelect.innerHTML = '';\n            filterTaskTypeSelect.innerHTML = '<option value=\"\">Todos</option>';\n            taskTypes.forEach(type => {\n                taskTypeSelect.add(new Option(type.tipo_tarefa, type.tipo_tarefa));\n                filterTaskTypeSelect.add(new Option(type.tipo_tarefa, type.tipo_tarefa));\n            });\n        }\n\n        function populateClientDropdowns() {\n            const clientSelect = document.getElementById('client');\n            const filterClientSelect = document.getElementById('filterClient');\n            clientSelect.innerHTML = '<option value=\"\">Selecione um cliente</option>';\n            filterClientSelect.innerHTML = '<option value=\"\">Todos</option>';\n            clients.forEach(client => {\n                clientSelect.add(new Option(client.nome, client.nome));\n                filterClientSelect.add(new Option(client.nome, client.nome));\n            });\n        }\n\n        function populateCompanyDropdowns() {\n            const companySelect = document.getElementById('company');\n            const filterCompanySelect = document.getElementById('filterCompany');\n            companySelect.innerHTML = '<option value=\"\">Selecione uma empresa</option>';\n            filterCompanySelect.innerHTML = '<option value=\"\">Todas</option>';\n            companies.forEach(company => {\n                companySelect.add(new Option(company.razao_social, company.razao_social));\n                filterCompanySelect.add(new Option(company.razao_social, company.razao_social));\n            });\n        }\n\n        function populateStatusDropdowns() {\n            const statusSelect = document.getElementById('status');\n            const filterStatusSelect = document.getElementById('filterStatus');\n            statusSelect.innerHTML = '';\n            filterStatusSelect.innerHTML = '<option value=\"\">Todos</option>';\n            TASK_STATUSES.forEach(status => {\n                statusSelect.add(new Option(status, status));\n                filterStatusSelect.add(new Option(status, status));\n            });\n        }\n\n        function clearForm() {\n            document.getElementById('taskForm').reset();\n            document.getElementById('taskId').value = '';\n            editingTaskId = null;\n            document.getElementById('taskForm').classList.remove('was-validated');\n            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));\n\n            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];\n            document.getElementById('endDate').value = new Date().toISOString().split('T')[0];\n            document.getElementById('status').value = 'NÃO INICIADO';\n\n            document.getElementById('saveTaskBtn').innerHTML = '<i class=\"fas fa-save me-2\"></i>Adicionar Tarefa';\n            document.getElementById('formTitle').textContent = 'Adicionar Nova Tarefa';\n\n            calculateDeviation();\n            UI.applyUIPermissions();\n            \n            // Reabilitar o botão de toggle ao limpar o formulário\n            document.querySelector('[data-bs-target=\"#formCollapse\"]').disabled = false;\n        }\n\n        // ===================================\n        // MANIPULAÇÃO DE DADOS (FETCH, SAVE)\n        // ===================================\n        async function loadThemeConfig() {\n           try {\n               console.log('🎨 Carregando configurações de tema...');\n               const response = await fetch(CONFIG_WEBHOOK_URL);\n               if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n\n               const data = await response.json();\n               if (data && data.length > 0 && data[0].primary_color) {\n                   const primaryColor = data[0].primary_color;\n                   applyPrimaryColor(primaryColor);\n                   console.log(`✅ Cor primária aplicada: ${primaryColor}`);\n               } else {\n                   console.log('⚠️ Usando cor primária padrão');\n               }\n           } catch (error) {\n               console.error('❌ Erro ao carregar configurações de tema:', error);\n               console.log('⚠️ Usando cor primária padrão');\n           }\n        }\n\n        function applyPrimaryColor(color) {\n           document.documentElement.style.setProperty('--primary-color', color);\n           const dynamicStyles = document.createElement('style');\n           dynamicStyles.innerHTML = `\n               .btn-outline-primary { color: ${color}; border-color: ${color}; }\n               .btn-outline-primary:hover { background-color: ${color}; border-color: ${color}; color: white; }\n               .text-primary { color: ${color} !important; }\n               .form-control:focus, .form-select:focus { border-color: ${color}; box-shadow: 0 0 0 0.2rem ${hexToRgba(color, 0.25)}; }\n           `;\n           document.head.appendChild(dynamicStyles);\n        }\n\n        function hexToRgba(hex, alpha) {\n            const r = parseInt(hex.slice(1, 3), 16);\n            const g = parseInt(hex.slice(3, 5), 16);\n            const b = parseInt(hex.slice(5, 7), 16);\n            return `rgba(${r}, ${g}, ${b}, ${alpha})`;\n        }\n\n\n        async function loadColaboradores() {\n            try {\n                console.log('🔄 Carregando colaboradores...');\n                const response = await fetch(COLABORADORES_WEBHOOK_URL);\n                if (!response.ok) throw new Error(`HTTP ${response.status}`);\n                const data = await response.json();\n                colaboradores = data.filter(c => c.status === true);\n                console.log(`✅ ${colaboradores.length} colaboradores ativos carregados.`);\n                updateResponsibleSelect();\n            } catch (error) {\n                console.error('❌ Erro ao carregar colaboradores:', error);\n                UI.showNotification(`❌ Erro ao carregar colaboradores.`, 'error');\n            }\n        }\n\n        async function loadClients() {\n            try {\n                console.log('🔄 Carregando clientes...');\n                const response = await fetch(CLIENTS_GET_URL);\n                if (!response.ok) throw new Error(`HTTP ${response.status}`);\n                clients = await response.json();\n                console.log(`✅ ${clients.length} clientes carregados.`);\n                populateClientDropdowns();\n            } catch (error) {\n                console.error('❌ Erro ao carregar clientes:', error);\n                UI.showNotification('❌ Erro ao carregar clientes.', 'error');\n            }\n        }\n\n        async function loadCompanies() {\n            try {\n                console.log('🔄 Carregando empresas...');\n                const response = await fetch(COMPANIES_GET_URL);\n                if (!response.ok) throw new Error(`HTTP ${response.status}`);\n                companies = await response.json();\n                console.log(`✅ ${companies.length} empresas carregadas.`);\n                populateCompanyDropdowns();\n            } catch (error) {\n                console.error('❌ Erro ao carregar empresas:', error);\n                UI.showNotification('❌ Erro ao carregar empresas.', 'error');\n            }\n        }\n\n        async function loadTaskTypes() {\n            try {\n                console.log('🔄 Carregando tipos de tarefa...');\n                const response = await fetch(TASK_TYPES_GET_URL);\n                if (!response.ok) throw new Error(`HTTP ${response.status}`);\n                taskTypes = await response.json();\n                console.log(`✅ ${taskTypes.length} tipos de tarefa carregados.`);\n                populateTaskTypeDropdowns();\n            } catch (error) {\n                console.error('❌ Erro ao carregar tipos de tarefa:', error);\n                UI.showNotification('❌ Erro ao carregar tipos de tarefa.', 'error');\n            }\n        }\n\n        function updateResponsibleSelect() {\n            const selects = [document.getElementById('responsible'), document.getElementById('filterResponsible')];\n            selects.forEach(select => {\n                const currentVal = select.value;\n                select.innerHTML = select.id.includes('filter') ? '<option value=\"\">Todos</option>' : '<option value=\"\">Selecione um responsável</option>';\n                colaboradores.forEach(c => select.add(new Option(c.nome, c.nome)));\n                select.value = currentVal;\n            });\n        }\n\n        async function loadTasks() {\n          try {\n              console.log('🔄 Carregando tarefas...');\n              UI.showNotification('🔄 Carregando tarefas do servidor...', 'info');\n              const response = await fetch(WEBHOOK_GET_URL);\n              if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n              const data = await response.json();\n\n              tasks = data.map(task => ({\n                  ...task,\n                  endDate: task.EndDate || '',\n                  startDate: task.startDate || '',\n                  completionDate: task.completionDate || '',\n                  estimatedHours: parseDecimalInput(task.estimatedHours),\n                  actualHours: parseDecimalInput(task.actualHours),\n                  deviation: parseDecimalInput(task.deviation)\n              }));\n\n              console.log(`✅ ${tasks.length} tarefas processadas e carregadas.`);\n              UI.showNotification('✅ Tarefas carregadas com sucesso!', 'success');\n\n              updateTaskTables();\n\n          } catch (error) {\n              console.error('❌ Erro ao carregar tarefas:', error);\n              UI.showNotification(`❌ Erro ao carregar tarefas: ${error.message}.`, 'error');\n              tasks = [];\n              updateTaskTables();\n          }\n        }\n\n        function updateTaskTables() {\n            const approvedTasks = tasks.filter(t => t.aguadando_aprovacao === null || t.aguadando_aprovacao === true || t.aguadando_aprovacao === 'true');\n            let pendingTasks = tasks.filter(t => t.aguadando_aprovacao === false || t.aguadando_aprovacao === 'false' || t.aguadando_aprovacao === 'Aguardando');\n            const canceledTasks = tasks.filter(t => t.aguadando_aprovacao === 'canceled');\n            const currentUser = Auth.getUserData();\n\n            updateApprovedTaskTable(approvedTasks);\n            updatePendingTaskTable(pendingTasks, canceledTasks);\n\n            if (currentUser.tipo === 'colaborador') {\n                const userPendingTasks = pendingTasks.filter(t => t.responsible === currentUser.nome);\n                document.getElementById('pending-count').textContent = userPendingTasks.length;\n            } else {\n                document.getElementById('pending-count').textContent = pendingTasks.length;\n            }\n        }\n\n        function updateApprovedTaskTable(filteredData) {\n            if ($.fn.DataTable.isDataTable('#taskTableApproved')) {\n                $('#taskTableApproved').DataTable().destroy();\n            }\n\n            const tableBody = document.querySelector('#taskTableApproved tbody');\n            tableBody.innerHTML = '';\n            const currentUser = Auth.getUserData();\n\n            filteredData.forEach(task => {\n                const taskIdStr = String(task.id);\n                const isTaskOpen = openTaskIds.has(taskIdStr);\n                const hasCompletedHours = completedTaskIds.has(taskIdStr);\n\n                let buttonClass = isTaskOpen ? 'btn-danger' : (hasCompletedHours ? 'btn-success' : 'btn-info');\n                let buttonText = isTaskOpen ? 'Em Andamento' : 'Adicionar';\n                const buttonTitle = isTaskOpen ? 'Tarefa com tempo em aberto!' : 'Controle de Horas';\n                const timeControlBtn = `<button class=\"btn btn-sm ${buttonClass} time-control-btn\" data-task-id=\"${task.id}\" title=\"${buttonTitle}\"><i class=\"fas fa-clock\"></i> ${buttonText}</button>`;\n\n                const isOwner = currentUser.nome === task.responsible;\n                const isAdmin = currentUser.tipo === 'admin';\n                let actionsHtml = '';\n                if (isAdmin) {\n                    actionsHtml = `\n                        <button class=\"btn btn-sm btn-primary edit-btn\" data-id=\"${task.id}\" title=\"Editar\"><i class=\"fas fa-edit\"></i></button>\n                        <button class=\"btn btn-sm btn-danger delete-btn\" data-id=\"${task.id}\" title=\"Excluir\"><i class=\"fas fa-trash\"></i></button>\n                    `;\n                } else if (isOwner) {\n                    actionsHtml = `<button class=\"btn btn-sm btn-primary edit-btn\" data-id=\"${task.id}\" title=\"Editar\"><i class=\"fas fa-edit\"></i></button>`;\n                } else {\n                    actionsHtml = `<button class=\"btn btn-sm btn-primary edit-btn\" data-id=\"${task.id}\" title=\"Editar\" disabled><i class=\"fas fa-edit\"></i></button>`;\n                }\n\n                const deviation = (task.actualHours || 0) - (task.estimatedHours || 0);\n                const deviationClass = deviation > 0 ? 'positive-deviation' : (deviation < 0 ? 'negative-deviation' : '');\n                const statusClass = `status-${(task.status || '').toLowerCase().replace(/\\s+/g, '-').replace(/ã|ú|í/g, a => ({'ã':'a', 'ú':'u', 'í': 'i'}[a]))}`;\n                const truncatedDesc = truncateResume(task.description);\n                const isClickable = task.description && task.description.length > 18;\n\n                const row = document.createElement('tr');\n                row.innerHTML = `\n                    <td>${task.id || ''}</td>\n                    <td>${timeControlBtn}</td>\n                    <td>${task.type || ''}</td>\n                    <td ${isClickable ? `data-full-resume=\"${(task.description || '').replace(/\"/g, \"&quot;\")}\" class=\"resume-truncated\"` : ''}>${truncatedDesc}</td>\n                    <td>${task.project || ''}</td>\n                    <td>${task.client || ''}</td>\n                    <td>${task.company || ''}</td>\n                    <td>${task.responsible || ''}</td>\n                    <td>${formatDate(task.startDate)}</td>\n                    <td>${formatDate(task.endDate)}</td>\n                    <td>${formatDate(task.completionDate)}</td>\n                    <td>${formatDecimalOutput(task.estimatedHours)}</td>\n                    <td>${formatDecimalOutput(task.actualHours)}</td>\n                    <td class=\"${deviationClass}\">${formatDecimalOutput(deviation)}</td>\n                    <td><span class=\"status-badge ${statusClass}\">${task.status || ''}</span></td>\n                    <td>${actionsHtml}</td>\n                `;\n                tableBody.appendChild(row);\n            });\n            \n            dataTableApproved = $('#taskTableApproved').DataTable({\n                language: { url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json' },\n                responsive: true,\n                order: [[0, 'desc']],\n                columnDefs: [{ orderable: false, targets: [1, 15] }],\n                pageLength: 10,\n                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, \"Todos\"]],\n                dom: '<\"row\"<\"col-sm-12 col-md-6\"l><\"col-sm-12 col-md-6\"f>><\"row\"<\"col-sm-12\"tr>><\"row\"<\"col-sm-12 col-md-5\"i><\"col-sm-12 col-md-7\"p>>',\n            });\n            updateFilters(filteredData);\n        }\n\n        function updatePendingTaskTable(pendingData, canceledData) {\n            const currentUser = Auth.getUserData();\n            const filterValue = document.getElementById('filterPendingStatus').value;\n            let dataToShow = (filterValue === 'false') ? pendingData : canceledData;\n            \n            if (currentUser.tipo === 'colaborador') {\n                dataToShow = dataToShow.filter(t => t.responsible === currentUser.nome);\n            }\n\n            if ($.fn.DataTable.isDataTable('#taskTablePending')) {\n                $('#taskTablePending').DataTable().destroy();\n            }\n\n            const tableBody = document.querySelector('#taskTablePending tbody');\n            tableBody.innerHTML = '';\n\n            dataToShow.forEach(task => {\n                const row = document.createElement('tr');\n                const truncatedDesc = truncateResume(task.description);\n                const isClickable = task.description && task.description.length > 18;\n                const resumeTd = `<td ${isClickable ? `data-full-resume=\"${(task.description || '').replace(/\"/g, \"&quot;\")}\" class=\"resume-truncated\"` : ''}>${truncatedDesc}</td>`;\n                const isColaborador = currentUser.tipo === 'colaborador';\n                const activateButtonDisabled = isColaborador ? 'disabled' : '';\n\n                let statusApprovalHtml, actionsHtml, motivoRecusaHtml;\n                if (task.aguadando_aprovacao === 'canceled') {\n                    statusApprovalHtml = `<span class=\"badge bg-danger\">Cancelado</span>`;\n                    actionsHtml = `<button class=\"btn btn-sm btn-secondary view-btn\" data-id=\"${task.id}\" title=\"Visualizar Motivo\"><i class=\"fas fa-eye\"></i></button>`;\n                    motivoRecusaHtml = task.motivo_recusa || 'N/A';\n                } else {  \n                    statusApprovalHtml = `<span class=\"badge bg-warning text-dark\">Aguardando Aprovação</span>`;\n                    actionsHtml = `<button class=\"btn btn-sm btn-primary activate-btn\" data-id=\"${task.id}\" title=\"Ativar Tarefa\" ${activateButtonDisabled}><i class=\"fas fa-play\"></i> Ativar</button>`;\n                    motivoRecusaHtml = '';  \n                }\n\n                row.innerHTML = `\n                    <td>${task.id || ''}</td>\n                    <td>${task.type || ''}</td>\n                    ${resumeTd}\n                    <td>${task.project || ''}</td>\n                    <td>${task.responsible || ''}</td>\n                    <td>${formatDate(task.startDate)}</td>\n                    <td>${formatDecimalOutput(task.estimatedHours)}</td>\n                    <td>${statusApprovalHtml}</td>\n                    <td>${motivoRecusaHtml}</td>\n                    <td>${actionsHtml}</td>\n                `;\n                tableBody.appendChild(row);\n            });\n            \n            dataTablePending = $('#taskTablePending').DataTable({\n                language: { url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json' },\n                responsive: true,\n                order: [[0, 'desc']],\n                pageLength: 10,\n                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, \"Todos\"]],\n                dom: '<\"row\"<\"col-sm-12 col-md-6\"l><\"col-sm-12 col-md-6\"f>><\"row\"<\"col-sm-12\"tr>><\"row\"<\"col-sm-12 col-md-5\"i><\"col-sm-12 col-md-7\"p>>',\n            });\n        }\n\n\n        async function loadAllTimeEntriesAndApplyStatus() {\n            try {\n                console.log('🔄 Buscando status de todas as entradas de tempo...');\n                const response = await fetch(TIME_ENTRIES_GET_URL);\n                if (!response.ok) throw new Error(`HTTP ${response.status}`);\n\n                const contentType = response.headers.get(\"content-type\");\n                if (!contentType || !contentType.includes(\"application/json\")) {\n                    throw new TypeError(\"A resposta não é um JSON. A sessão pode ter expirado.\");\n                }\n\n                const allEntries = await response.json();\n                if (!Array.isArray(allEntries)) return;\n\n                openTaskIds.clear();\n                completedTaskIds.clear();\n\n                const entriesByTask = {};\n                allEntries.forEach(entry => {\n                    if (entry && entry.id_type) {\n                        const taskId = String(entry.id_type);\n                        if (!entriesByTask[taskId]) {\n                            entriesByTask[taskId] = [];\n                        }\n                        entriesByTask[taskId].push(entry);\n                    }\n                });\n\n                Object.keys(entriesByTask).forEach(taskId => {\n                    const taskEntries = entriesByTask[taskId];\n                    const hasOpenEntry = taskEntries.some(e => e.hora_final === null);\n                    const hasCompletedEntries = taskEntries.some(e => e.hora_final !== null);\n\n                    if (hasOpenEntry) {\n                        openTaskIds.add(taskId);\n                    } else if (hasCompletedEntries) {\n                        completedTaskIds.add(taskId);\n                    }\n                });\n\n                console.log('✅ Status de tempo processado. Tarefas em aberto:', openTaskIds);\n                console.log('✅ Tarefas com horas completas:', completedTaskIds);\n                updateTaskTables();\n\n            } catch (error) {\n                console.error('❌ Erro ao buscar todos os registros de tempo:', error);\n                UI.showNotification('Erro ao buscar registros de tempo. Tente recarregar a página.', 'error');\n            }\n        }\n\n        async function sendToWebhook(data, action) {\n            try {\n                const payload = {\n                    ...data,\n                    action,\n                    timestamp: new Date().toISOString()\n                };\n\n                console.log('📡 Enviando para webhook:', payload);\n                const response = await fetch(WEBHOOK_URL, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(payload)\n                });\n\n                if (response.ok) {\n                    console.log(`✅ Webhook [${action}] bem-sucedido para tarefa ${data.id}.`);\n                    return { success: true };\n                } else {\n                    const responseText = await response.text();\n                    console.error(`❌ Webhook [${action}] respondeu com status ${response.status}. Resposta: ${responseText}`);\n                    return { success: false, error: `Erro do servidor (Status ${response.status})`, message: responseText };\n                }\n            } catch (error) {\n                console.error(`❌ Erro ao enviar para webhook [${action}]:`, error);\n                return { success: false, error: 'Erro de rede', message: error.message };\n            }\n        }\n\n        function updateFilters(currentData = tasks) {\n            const projectFilter = document.getElementById('filterProject');\n            const clientFilter = document.getElementById('filterClient');\n            const companyFilter = document.getElementById('filterCompany');\n\n            const selectedProject = projectFilter.value;\n            const selectedClient = clientFilter.value;\n            const selectedCompany = companyFilter.value;\n\n            const projects = [...new Set(currentData.map(t => t.project).filter(p => p))].sort();\n            projectFilter.innerHTML = '<option value=\"\">Todos</option>';\n            projects.forEach(p => {\n                const option = new Option(p, p);\n                projectFilter.add(option);\n            });\n            if (projects.includes(selectedProject)) projectFilter.value = selectedProject;\n\n            const clients = [...new Set(currentData.map(t => t.client).filter(c => c))].sort();\n            clientFilter.innerHTML = '<option value=\"\">Todos</option>';\n            clients.forEach(c => {\n                const option = new Option(c, c);\n                clientFilter.add(option);\n            });\n            if (clients.includes(selectedClient)) clientFilter.value = selectedClient;\n\n            const companies = [...new Set(currentData.map(t => t.company).filter(c => c))].sort();\n            companyFilter.innerHTML = '<option value=\"\">Todos</option>';\n            companies.forEach(c => {\n                const option = new Option(c, c);\n                companyFilter.add(option);\n            });\n            if (companies.includes(selectedCompany)) companyFilter.value = selectedCompany;\n        }\n\n        function getDailyHoursForCollaborator(responsible, dateStr, excludeTaskId = null) {\n          let totalHours = 0;\n          const targetDate = parseDate(dateStr);\n          if (!targetDate) return 0;\n          const targetDateStr = targetDate.toISOString().split('T')[0];\n\n          for (const task of tasks) {\n              if (task.responsible === responsible && task.id != excludeTaskId) {\n                  const taskStartDate = parseDate(task.startDate);\n                  if (taskStartDate) {\n                      const taskStartDateStr = taskStartDate.toISOString().split('T')[0];\n                      if (taskStartDateStr === targetDateStr) {\n                          totalHours += parseFloat(task.estimatedHours) || 0;\n                      }\n                  }\n              }\n          }\n          return totalHours;\n        }\n\n        function splitTaskByHourLimit(baseTask, startDateStr, totalHoursToAllocate) {\n            const newTasks = [];\n            let remainingHours = totalHoursToAllocate;\n            let currentDate = new Date(startDateStr + 'T00:00:00'); // Ensure it's parsed as local time\n            if (isNaN(currentDate.getTime())) {\n                UI.showNotification(\"Data de início inválida.\", \"error\");\n                return [];\n            }\n\n            globalEndDate = document.getElementById('endDate').value;\n            const baseTimestamp = Date.now();\n\n            console.log('✅ Deadline da tarefa capturada para consolidação:', globalEndDate);\n\n            while (remainingHours > 0) {\n                const currentDateStr = currentDate.toISOString().split('T')[0];\n                const allocatedHours = getDailyHoursForCollaborator(baseTask.responsible, currentDateStr, null);\n                const availableHours = Math.max(0, 8 - allocatedHours);\n\n                if (availableHours > 0) {\n                    const hoursForThisDay = Math.min(remainingHours, availableHours);\n\n                    const newTask = {\n                        ...baseTask,\n                        id: `new_${baseTimestamp}_${newTasks.length}`,\n                        startDate: currentDateStr,\n                        endDate: globalEndDate,\n                        estimatedHours: hoursForThisDay,\n                        actualHours: 0,\n                        deviation: -hoursForThisDay,\n                        completionDate: '',\n                    };\n\n                    newTasks.push(newTask);\n                    remainingHours -= hoursForThisDay;\n                }\n\n                currentDate.setDate(currentDate.getDate() + 1);\n\n                if (newTasks.length > 365) {\n                    console.error(\"Task splitting loop exceeded 365 iterations. Aborting.\");\n                    UI.showNotification(\"Erro: Não foi possível alocar todas as horas da tarefa. Verifique a disponibilidade.\", \"error\");\n                    return [];\n                }\n            }\n\n            console.log(`✅ ${newTasks.length} tarefas criadas. Período de trabalho: ${newTasks[0].startDate} até ${newTasks[newTasks.length - 1].startDate}. Deadline: ${globalEndDate}`);\n            return newTasks;\n        }\n        \n        function parseDate(dateString) {\n            if (!dateString || typeof dateString !== 'string') return null;\n            // Parse date without timezone manipulations\n            const parts = dateString.split('-');\n            return new Date(parts[0], parts[1] - 1, parts[2]);\n        }\n\n        // ===================================\n        // SETUP DOS EVENT LISTENERS\n        // ===================================\n        function setupEventListeners() {\n            document.getElementById('logoutButton').addEventListener('click', Auth.logout);\n            document.getElementById('sidebarToggle').addEventListener('click', UI.toggleSidebar);\n            if(document.getElementById('sidebarOverlay')) {\n                document.getElementById('sidebarOverlay').addEventListener('click', UI.toggleSidebar);\n            }\n            \n            document.getElementById('estimatedHours').addEventListener('input', calculateDeviation);\n            document.getElementById('actualHours').addEventListener('input', calculateDeviation);\n\n\n            document.getElementById('taskForm').addEventListener('submit', function(e) {\n                e.preventDefault();\n                if (!this.checkValidity()) {\n                    UI.showNotification('Por favor, preencha todos os campos obrigatórios.', 'warning');\n                    this.classList.add('was-validated');\n                    return;\n                }\n\n                const completionDateVal = document.getElementById('completionDate').value;\n                const startDateVal = document.getElementById('startDate').value;\n                if (completionDateVal && startDateVal && completionDateVal < startDateVal) {\n                    UI.showNotification('A \"Data de Finalização\" não pode ser anterior à \"Data Início\".', 'error');\n                    document.getElementById('completionDate').classList.add('is-invalid');\n                    return;\n                }\n                document.getElementById('completionDate').classList.remove('is-invalid');\n\n                const isEditing = !!editingTaskId;\n\n                if (isEditing) {\n                    const deviation = parseDecimalInput(document.getElementById('actualHours').value) - parseDecimalInput(document.getElementById('estimatedHours').value);\n                    const userData = Auth.getUserData();\n\n                    tempTasksData = [{\n                        id: editingTaskId,\n                        type: document.getElementById('taskType').value,\n                        description: document.getElementById('taskDescription').value,\n                        project: document.getElementById('project').value,\n                        client: document.getElementById('client').value,\n                        company: document.getElementById('company').value,\n                        responsible: document.getElementById('responsible').value,\n                        startDate: document.getElementById('startDate').value,\n                        endDate: document.getElementById('endDate').value,\n                        completionDate: completionDateVal,\n                        estimatedHours: parseDecimalInput(document.getElementById('estimatedHours').value),\n                        actualHours: parseDecimalInput(document.getElementById('actualHours').value),\n                        deviation: deviation,\n                        status: document.getElementById('status').value,\n                        modificadoPor: userData.nome,\n                        modificadoPorTipo: userData.tipo\n                    }];\n                } else {\n                    const commonTaskData = {\n                        type: document.getElementById('taskType').value,\n                        description: document.getElementById('taskDescription').value,\n                        project: document.getElementById('project').value,\n                        client: document.getElementById('client').value,\n                        company: document.getElementById('company').value,\n                        responsible: document.getElementById('responsible').value,\n                        status: 'NÃO INICIADO',\n                    };\n                    const estimatedHours = parseDecimalInput(document.getElementById('estimatedHours').value);\n\n                    console.log('🔢 Criando tarefas:', estimatedHours, 'horas para', commonTaskData.responsible);\n\n                    tempTasksData = splitTaskByHourLimit(commonTaskData, document.getElementById('startDate').value, estimatedHours);\n                }\n\n                if (!tempTasksData || tempTasksData.length === 0) {\n                    UI.showNotification('Não há horas disponíveis nas datas selecionadas para alocar a tarefa.', 'error');\n                    return;\n                }\n\n                console.log('📋 Criadas', tempTasksData.length, 'tarefas para exibição no modal');\n\n                fillConfirmationModal(tempTasksData);\n                new bootstrap.Modal(document.getElementById('confirmTaskModal')).show();\n            });\n\n            document.getElementById('clearFormBtn').addEventListener('click', clearForm);\n            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);\n            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);\n            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);\n\n            $('#taskTableApproved').on('click', '.edit-btn', function() {\n                const taskId = $(this).data('id');\n                const taskToEdit = tasks.find(t => t.id == taskId);\n                if (taskToEdit) fillFormWithTask(taskToEdit);\n            });\n\n            $('#taskTableApproved').on('click', '.delete-btn', function() {\n                const taskId = $(this).data('id');\n                document.getElementById('confirmDeleteBtn').dataset.id = taskId;\n                new bootstrap.Modal(document.getElementById('deleteModal')).show();\n            });\n\n            $('#taskTableApproved').on('click', '.time-control-btn', function() {\n                const taskId = $(this).data('task-id');\n                openTimeControlModal(taskId);\n            });\n\n            $('#taskTableApproved').on('click', '.resume-truncated', function() {\n                const fullResume = $(this).data('full-resume');\n                showFullResume(fullResume);\n            });\n            \n            $('#taskTablePending').on('click', '.resume-truncated', function() {\n                const fullResume = $(this).data('full-resume');\n                showFullResume(fullResume);\n            });\n\n            document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {\n                const taskId = this.dataset.id;\n                const webhookResult = await sendToWebhook({ id: taskId }, 'delete');\n\n                if (webhookResult.success) {\n                    tasks = tasks.filter(t => t.id != taskId);\n                    updateTaskTables();\n                    UI.showNotification(`✅ Tarefa ID ${taskId} excluída!`, 'success');\n                    await reloadTaskDataAfterOperation('exclusão');\n                } else {\n                    UI.showNotification(`❌ Falha ao excluir tarefa. ${webhookResult.error}: ${webhookResult.message}`, 'error');\n                }\n                bootstrap.Modal.getInstance(document.getElementById('deleteModal'))?.hide();\n            });\n            \n            document.getElementById('confirmTaskBtn').addEventListener('click', async function() {\n                bootstrap.Modal.getInstance(document.getElementById('confirmTaskModal'))?.hide();\n\n                const isEditing = !!editingTaskId;\n                const action = isEditing ? 'update' : 'create';\n                let webhookResult;\n\n                if (isEditing) {\n                    const taskToUpdate = tempTasksData[0];\n                    webhookResult = await sendToWebhook(taskToUpdate, action);\n\n                    if (webhookResult.success) {\n                        const index = tasks.findIndex(t => t.id == editingTaskId);\n                        if (index !== -1) {\n                            tasks[index] = taskToUpdate;\n                        }\n                        UI.showNotification(`✅ Tarefa atualizada com sucesso! Recarregando dados...`, 'success');\n                        await reloadTaskDataAfterOperation('atualização');\n                    } else {\n                        const errorMessage = `❌ Falha ao atualizar tarefa. ${webhookResult.error || ''}: ${webhookResult.message || ''}`;\n                        UI.showNotification(errorMessage, 'error', 10000);\n                    }\n                } else {\n                    console.log('📡 Enviando tarefa consolidada com detalhes baseada em', tempTasksData.length, 'divisões');\n\n                    const totalHours = tempTasksData.reduce((sum, task) => sum + (task.estimatedHours || 0), 0);\n                    const totalDeviation = -totalHours;\n                    const firstTaskDate = tempTasksData[0].startDate;\n                    const finalPeriodEndDate = tempTasksData[tempTasksData.length - 1].startDate;\n                    const userData = Auth.getUserData();\n\n                    const dailyBreakdown = tempTasksData.map(task => ({\n                        dataInicio: task.startDate,\n                        dataFinal: task.endDate,\n                        horasEstimadasInicio: task.estimatedHours,\n                        horasEstimadasFinal: task.estimatedHours\n                    }))\n                    .sort((a, b) => new Date(a.dataInicio) - new Date(b.dataInicio))\n                    .map(item => {\n                        if (new Date(item.dataFinal) < new Date(item.dataInicio)) {\n                            item.dataFinal = item.dataInicio;\n                        }\n                        return item;\n                    });\n\n                    const consolidatedTask = {\n                        type: document.getElementById('taskType').value,\n                        description: document.getElementById('taskDescription').value,\n                        project: document.getElementById('project').value,\n                        client: document.getElementById('client').value,\n                        company: document.getElementById('company').value,\n                        responsible: document.getElementById('responsible').value,\n                        status: 'NÃO INICIADO',\n                        aguadando_aprovacao: false,\n                        startDate: firstTaskDate,\n                        endDate: finalPeriodEndDate,\n                        estimatedHours: totalHours,\n                        actualHours: 0,\n                        deviation: totalDeviation,\n                        completionDate: '',\n                        id: `new_${Date.now()}_consolidated`,\n                        criadoPor: userData.nome,\n                        criadoPorTipo: userData.tipo,\n                        data: dailyBreakdown\n                    };\n\n                    console.log('📡 Tarefa consolidada com detalhes:', consolidatedTask);\n                    webhookResult = await sendToWebhook(consolidatedTask, action);\n\n                    if (webhookResult.success) {\n                        UI.showNotification(`✅ Tarefa consolidada adicionada com sucesso! Recarregando dados...`, 'success');\n                        await reloadTaskDataAfterOperation('adição');\n                    } else {\n                        const errorMessage = `❌ Falha ao adicionar tarefa consolidada. ${webhookResult.error || ''}`;\n                        UI.showNotification(errorMessage, 'error', 10000);\n                    }\n                }\n\n                clearForm();\n                tempTasksData = null;\n            });\n\n            document.getElementById('addNewTaskTypeBtn').addEventListener('click', () => {\n                new bootstrap.Modal(document.getElementById('newTaskTypeModal')).show();\n            });\n\n            document.getElementById('saveNewTaskTypeBtn').addEventListener('click', async () => {\n                const newTaskTypeName = document.getElementById('newTaskTypeName').value.toUpperCase().trim();\n                if (!newTaskTypeName) {\n                    UI.showNotification('O nome do tipo de tarefa não pode estar vazio.', 'warning');\n                    return;\n                }\n\n                const payload = {\n                    action: 'add_nova_tarefa',\n                    tipo_tarefa: newTaskTypeName\n                };\n\n                try {\n                    const response = await fetch(NEW_TASK_TYPE_POST_URL, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        UI.showNotification('Novo tipo de tarefa adicionado com sucesso!', 'success');\n                        bootstrap.Modal.getInstance(document.getElementById('newTaskTypeModal')).hide();\n                        document.getElementById('newTaskTypeForm').reset();\n                        \n                        const newType = { tipo_tarefa: newTaskTypeName };\n                        taskTypes.push(newType);\n                        taskTypes.sort((a, b) => a.tipo_tarefa.localeCompare(b.tipo_tarefa));\n                        populateTaskTypeDropdowns();\n                        document.getElementById('taskType').value = newTaskTypeName;\n\n                    } else {\n                        const errorText = await response.text();\n                        UI.showNotification(`Erro ao salvar: ${errorText}`, 'error');\n                    }\n                } catch (error) {\n                    UI.showNotification(`Erro de rede: ${error.message}`, 'error');\n                }\n            });\n\n            document.getElementById('addNewClientBtn').addEventListener('click', () => {\n                new bootstrap.Modal(document.getElementById('newClientModal')).show();\n            });\n\n            document.getElementById('saveNewClientBtn').addEventListener('click', async () => {\n                const newClientName = document.getElementById('newClientName').value.toUpperCase().trim();\n                if (!newClientName) {\n                    UI.showNotification('O nome do cliente é obrigatório.', 'warning');\n                    return;\n                }\n\n                const payload = {\n                    action: 'add_cliente',\n                    nome: newClientName,\n                    cnpj: document.getElementById('newClientCnpj').value,\n                    email: document.getElementById('newClientEmail').value.toLowerCase(),\n                    telefone: document.getElementById('newClientPhone').value,\n                    ativo: document.getElementById('newClientActive').checked\n                };\n\n                try {\n                    const response = await fetch(NEW_CLIENT_POST_URL, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        UI.showNotification('Novo cliente adicionado com sucesso!', 'success');\n                        bootstrap.Modal.getInstance(document.getElementById('newClientModal')).hide();\n                        document.getElementById('newClientForm').reset();\n                        \n                        const newClient = { nome: newClientName };\n                        clients.push(newClient);\n                        clients.sort((a, b) => a.nome.localeCompare(b.nome));\n                        populateClientDropdowns();\n                        document.getElementById('client').value = newClientName;\n\n                    } else {\n                        const errorText = await response.text();\n                        UI.showNotification(`Erro ao salvar cliente: ${errorText}`, 'error');\n                    }\n                } catch (error) {\n                    UI.showNotification(`Erro de rede: ${error.message}`, 'error');\n                }\n            });\n\n            window.addEventListener('resize', () => {\n                setTimeout(() => {\n                    try {\n                        if ($.fn.DataTable.isDataTable('#taskTableApproved') && $('#taskTableApproved').is(':visible')) {\n                             $('#taskTableApproved').DataTable().columns.adjust().responsive.recalc();\n                        }\n                        if ($.fn.DataTable.isDataTable('#taskTablePending') && $('#taskTablePending').is(':visible')) {\n                             $('#taskTablePending').DataTable().columns.adjust().responsive.recalc();\n                        }\n                    } catch(e) {\n                        console.error(\"Error recalculating datatable:\", e);\n                    }\n                }, 300);\n            });\n            \n            document.querySelectorAll('button[data-bs-toggle=\"tab\"]').forEach(tab => {\n                tab.addEventListener('shown.bs.tab', () => {\n                     try {\n                        if ($.fn.DataTable.isDataTable('#taskTableApproved')) {\n                            $('#taskTableApproved').DataTable().columns.adjust().responsive.recalc();\n                        }\n                         if ($.fn.DataTable.isDataTable('#taskTablePending')) {\n                            $('#taskTablePending').DataTable().columns.adjust().responsive.recalc();\n                        }\n                    } catch(e) {\n                        console.error(\"Error recalculating datatable on tab change:\", e);\n                    }\n                });\n            });\n\n            document.getElementById('filterPendingStatus').addEventListener('change', () => {\n                updateTaskTables();\n            });\n\n            $('#taskTablePending').on('click', '.activate-btn', function() {\n                const taskId = $(this).data('id');\n                const task = tasks.find(t => t.id == taskId);\n                openApprovalActionModal(task);\n            });\n            \n            document.getElementById('showCancelReasonBtn').addEventListener('click', () => {\n                document.getElementById('initialButtons').style.display = 'none';\n                document.getElementById('cancelReasonSection').style.display = 'block';\n                document.getElementById('confirmCancelButtons').style.display = 'block';\n            });\n\n            document.getElementById('backToOptionsBtn').addEventListener('click', () => {\n                document.getElementById('initialButtons').style.display = 'block';\n                document.getElementById('cancelReasonSection').style.display = 'none';\n                document.getElementById('confirmCancelButtons').style.display = 'none';\n            });\n\n            document.getElementById('confirmApproveBtn').addEventListener('click', async function() {\n                const taskId = this.dataset.id;\n                const task = tasks.find(t => t.id == taskId);\n                const webhookResult = await sendToWebhook({ ...task, aguadando_aprovacao: true }, 'status_task_true');\n\n                 if (webhookResult.success) {\n                      UI.showNotification(`✅ Tarefa ID ${taskId} aprovada!`, 'success');\n                      await reloadTaskDataAfterOperation('aprovação');\n                 } else {\n                      UI.showNotification(`❌ Falha ao aprovar tarefa.`, 'error');\n                 }\n                 bootstrap.Modal.getInstance(document.getElementById('approvalActionModal')).hide();\n            });\n\n            document.getElementById('confirmCancelBtn').addEventListener('click', async function() {\n                const taskId = this.dataset.id;\n                const reason = document.getElementById('cancelReason').value;\n                if (!reason.trim()) {\n                    UI.showNotification('O motivo do cancelamento é obrigatório.', 'warning');\n                    return;\n                }\n\n                const task = tasks.find(t => t.id == taskId);\n                const payload = { ...task, aguadando_aprovacao: 'canceled', motivo_recusa: reason };\n                const webhookResult = await sendToWebhook(payload, 'status_task_false');\n\n                if (webhookResult.success) {\n                    UI.showNotification(`✅ Tarefa ID ${taskId} cancelada!`, 'success');\n                    await reloadTaskDataAfterOperation('cancelamento');\n                } else {\n                    UI.showNotification(`❌ Falha ao cancelar tarefa.`, 'error');\n                }\n                bootstrap.Modal.getInstance(document.getElementById('approvalActionModal')).hide();\n            });\n        }\n\n        function fillFormWithTask(task) {\n            editingTaskId = task.id;\n            document.getElementById('taskId').value = task.id;\n            document.getElementById('taskType').value = task.type;\n            document.getElementById('taskDescription').value = task.description;\n            document.getElementById('project').value = task.project;\n            document.getElementById('client').value = task.client || '';\n            document.getElementById('company').value = task.company || '';\n            document.getElementById('responsible').value = task.responsible;\n            document.getElementById('startDate').value = task.startDate;\n            document.getElementById('endDate').value = task.endDate;\n            document.getElementById('completionDate').value = task.completionDate || '';\n            document.getElementById('estimatedHours').value = formatDecimalOutput(task.estimatedHours);\n            document.getElementById('actualHours').value = formatDecimalOutput(task.actualHours);\n            document.getElementById('status').value = task.status;\n\n            document.getElementById('saveTaskBtn').innerHTML = '<i class=\"fas fa-save me-2\"></i>Atualizar Tarefa';\n            document.getElementById('formTitle').textContent = 'Editando Tarefa ID: ' + task.id;\n\n            calculateDeviation();\n\n            const userData = Auth.getUserData();\n            const isColaborador = (userData?.tipo || 'colaborador') === 'colaborador';\n            \n            const fieldsToDisableForColaborador = {\n                taskType: true, taskDescription: true, project: true, client: true, company: true,\n                responsible: true, startDate: true, endDate: true, completionDate: false, \n                estimatedHours: true, actualHours: false, deviation: true, status: false\n            };\n\n            for (const fieldId in fieldsToDisableForColaborador) {\n                const el = document.getElementById(fieldId);\n                if (el) {\n                    if (isColaborador) {\n                        el.disabled = fieldsToDisableForColaborador[fieldId];\n                    } else {\n                        el.disabled = (fieldId === 'deviation');\n                    }\n                }\n            }\n            document.getElementById('deviation').disabled = true;\n            \n            const formCollapseEl = document.getElementById('formCollapse');\n            const bsCollapse = bootstrap.Collapse.getOrCreateInstance(formCollapseEl);\n            bsCollapse.show();\n\n            window.scrollTo({ top: 0, behavior: 'smooth' });\n        }\n\n\n        function fillConfirmationModal(tasksToConfirm) {\n            const isSingleTask = tasksToConfirm.length === 1;\n            const task = tasksToConfirm[0];\n\n            const modalTitle = document.getElementById('confirmTaskModalTitle');\n            const modalBody = document.querySelector('#confirmTaskModal .modal-body');\n            modalBody.innerHTML = '';\n\n            if (isSingleTask && editingTaskId) {\n                modalTitle.textContent = `Confirmar Edição da Tarefa ID: ${task.id}`;\n            } else if (isSingleTask) {\n                modalTitle.textContent = 'Confirmar Nova Tarefa';\n            } else {\n                modalTitle.textContent = `Confirmar Criação de Tarefa Consolidada`;\n            }\n\n            const commonInfoHtml = `\n                <div class=\"row\">\n                    <div class=\"col-md-6\">\n                        <h6 class=\"text-primary\">Informações Básicas</h6>\n                        <table class=\"table table-sm\">\n                            <tr><td><strong>Tipo de Tarefa:</strong></td><td>${task.type || 'N/A'}</td></tr>\n                            <tr><td><strong>Descrição:</strong></td><td>${task.description || 'N/A'}</td></tr>\n                            <tr><td><strong>Projeto:</strong></td><td>${task.project || 'N/A'}</td></tr>\n                            <tr><td><strong>Cliente:</strong></td><td>${task.client || 'N/A'}</td></tr>\n                            <tr><td><strong>Empresa:</strong></td><td>${task.company || 'N/A'}</td></tr>\n                            <tr><td><strong>Responsável:</strong></td><td>${task.responsible || 'N/A'}</td></tr>\n                        </table>\n                    </div>\n                    <div class=\"col-md-6\" id=\"details-container\"></div>\n                </div>`;\n            modalBody.insertAdjacentHTML('beforeend', commonInfoHtml);\n\n            const detailsContainer = modalBody.querySelector('#details-container');\n\n            if (isSingleTask) {\n                const deviation = (task.actualHours || 0) - (task.estimatedHours || 0);\n                const statusClass = `status-${(task.status || '').toLowerCase().replace(/\\s+/g, '-').replace(/ã|ú|í/g, a => ({'ã':'a', 'ú':'u'}[a]))}`;\n                detailsContainer.innerHTML = `\n                    <h6 class=\"text-primary\">Prazos e Horas</h6>\n                    <table class=\"table table-sm\">\n                        <tr><td><strong>Data Início:</strong></td><td>${formatDate(task.startDate)}</td></tr>\n                        <tr><td><strong>Data Final:</strong></td><td>${formatDate(task.endDate)}</td></tr>\n                        <tr><td><strong>Data Finalizada:</strong></td><td>${formatDate(task.completionDate)}</td></tr>\n                        <tr><td><strong>Horas Estimadas:</strong></td><td>${formatDecimalOutput(task.estimatedHours)}</td></tr>\n                        <tr><td><strong>Horas Realizadas:</strong></td><td>${formatDecimalOutput(task.actualHours)}</td></tr>\n                        <tr><td><strong>Desvio (Horas):</strong></td><td>${formatDecimalOutput(deviation)}</td></tr>\n                        <tr><td><strong>Situação:</strong></td><td><span class=\"badge ${statusClass}\">${task.status}</span></td></tr>\n                    </table>`;\n            } else {\n                const firstDate = tasksToConfirm[0].startDate;\n                const lastDate = tasksToConfirm[tasksToConfirm.length - 1].startDate;\n                const totalHours = tasksToConfirm.reduce((sum, t) => sum + t.estimatedHours, 0);\n                const totalDeviation = -totalHours;\n\n                let splitTableHtml = `\n                    <h6 class=\"text-primary\">Tarefas a Serem Criadas (Detalhes)</h6>\n                    <div class=\"alert alert-info mb-3\">\n                        <i class=\"fas fa-info-circle me-2\"></i>\n                        <strong>Informação:</strong> Será enviada uma única tarefa consolidada abrangendo todo o período.\n                    </div>\n                    <div style=\"max-height: 200px; overflow-y: auto;\">\n                        <table class=\"table table-sm table-striped\">\n                            <thead><tr><th>Data Início</th><th>Horas Estimadas</th></tr></thead>\n                            <tbody>`;\n                tasksToConfirm.forEach(splitTask => {\n                    splitTableHtml += `<tr><td>${formatDate(splitTask.startDate)}</td><td>${formatDecimalOutput(splitTask.estimatedHours)}</td></tr>`;\n                });\n\n                splitTableHtml += `</tbody></table></div>\n                                <div class=\"alert alert-success mb-2\">\n                                    <strong>Tarefa Consolidada a ser enviada:</strong><br>\n                                    <strong>Período:</strong> ${formatDate(firstDate)} até ${formatDate(lastDate)}<br>\n                                    <strong>Total de Horas:</strong> ${formatDecimalOutput(totalHours)}<br>\n                                    <strong>Desvio (Horas):</strong> ${formatDecimalOutput(totalDeviation)}\n                                </div>`;\n                detailsContainer.innerHTML = splitTableHtml;\n            }\n        }\n        \n        function getFilteredTasks() {\n            const responsible = document.getElementById('filterResponsible').value;\n            const project = document.getElementById('filterProject').value;\n            const client = document.getElementById('filterClient').value;\n            const company = document.getElementById('filterCompany').value;\n            const status = document.getElementById('filterStatus').value;\n            const type = document.getElementById('filterTaskType').value;\n            const startDate = document.getElementById('filterStartDate').value;\n            const endDate = document.getElementById('filterEndDate').value;\n\n            const approvedTasks = tasks.filter(t => t.aguadando_aprovacao === null || t.aguadando_aprovacao === true || t.aguadando_aprovacao === 'true');\n\n            return approvedTasks.filter(task => {\n                const matchesResponsible = !responsible || task.responsible === responsible;\n                const matchesProject = !project || task.project === project;\n                const matchesClient = !client || task.client === client;\n                const matchesCompany = !company || task.company === company;\n                const matchesStatus = !status || task.status === status;\n                const matchesType = !type || task.type === type;\n\n                let matchesDateRange = true;\n                if (startDate || endDate) {\n                    if (!task.startDate) {\n                        matchesDateRange = false;\n                    } else {\n                        const taskDateStr = task.startDate.split('T')[0];\n                        if (startDate && taskDateStr < startDate) {\n                            matchesDateRange = false;\n                        }\n                        if (endDate && taskDateStr > endDate) {\n                            matchesDateRange = false;\n                        }\n                    }\n                }\n\n                return matchesResponsible && matchesProject && matchesClient &&\n                        matchesCompany && matchesStatus && matchesType && matchesDateRange;\n            });\n        }\n\n        function applyFilters() {\n            const filteredTasks = getFilteredTasks();\n            updateApprovedTaskTable(filteredTasks);\n            UI.showNotification(`🔍 ${filteredTasks.length} tarefas encontradas.`, 'info');\n        }\n\n        function clearFilters() {\n            document.querySelectorAll('#filtersCollapse select, #filtersCollapse input').forEach(el => el.value = '');\n            updateTaskTables();\n            UI.showNotification('✅ Filtros limpos.', 'success');\n        }\n\n        function exportToExcel() {\n            const hasFilters = !!(document.getElementById('filterResponsible').value ||\n                                  document.getElementById('filterProject').value ||\n                                  document.getElementById('filterClient').value ||\n                                  document.getElementById('filterCompany').value ||\n                                  document.getElementById('filterStatus').value ||\n                                  document.getElementById('filterTaskType').value ||\n                                  document.getElementById('filterStartDate').value ||\n                                  document.getElementById('filterEndDate').value);\n\n            const tasksForExport = hasFilters ? getFilteredTasks() : tasks.filter(t => t.aguadando_aprovacao === null || t.aguadando_aprovacao === true || t.aguadando_aprovacao === 'true');\n\n            if (tasksForExport.length === 0) {\n                UI.showNotification('⚠️ Nenhuma tarefa para exportar com os filtros atuais.', 'warning');\n                return;\n            }\n\n            const dataToExport = tasksForExport.map(task => ({\n                'ID': task.id || '',\n                'Tipo de Tarefa': task.type || '',\n                'Resumo': task.description || '',\n                'Projeto': task.project || '',\n                'Cliente': task.client || '',\n                'Empresa': task.company || '',\n                'Responsável': task.responsible || '',\n                'Data Início': formatDate(task.startDate),\n                'Data Final': formatDate(task.endDate),\n                'Data Finalizada': formatDate(task.completionDate),\n                'Estimativa (h)': formatDecimalOutput(task.estimatedHours),\n                'Realizado (h)': formatDecimalOutput(task.actualHours),\n                'Desvio (h)': formatDecimalOutput((task.actualHours || 0) - (task.estimatedHours || 0)),\n                'Situação': task.status || ''\n            }));\n\n            const worksheet = XLSX.utils.json_to_sheet(dataToExport);\n            const workbook = XLSX.utils.book_new();\n            XLSX.utils.book_append_sheet(workbook, worksheet, \"Tarefas\");\n\n            const fileName = hasFilters ? \"Tarefas_Filtradas_ResolvTask.xlsx\" : \"Todas_Tarefas_ResolvTask.xlsx\";\n            XLSX.writeFile(workbook, fileName);\n\n            UI.showNotification(`✅ ${dataToExport.length} tarefa(s) exportada(s) para Excel.`, 'success');\n        }\n        \n        async function reloadTaskDataAfterOperation(operation = 'atualização') {\n            try {\n                console.log(`🔄 Iniciando recarregamento de dados após ${operation}...`);\n                UI.showNotification(`🔄 Recarregando dados após ${operation}...`, 'info', 2000);\n                await new Promise(resolve => setTimeout(resolve, 1500));\n                console.log('📋 Recarregando lista de tarefas...');\n                await loadTasks();\n                console.log('⏰ Recarregando status de controle de horas...');\n                await loadAllTimeEntriesAndApplyStatus();\n                console.log(`✅ Recarregamento completo após ${operation} finalizado.`);\n                UI.showNotification(`✅ Dados atualizados com sucesso após ${operation}!`, 'success');\n            } catch (error) {\n                console.error(`❌ Erro durante recarregamento após ${operation}:`, error);\n                UI.showNotification(`⚠️ Erro ao recarregar dados após ${operation}. Tente atualizar a página.`, 'warning');\n            }\n        }\n\n        function openApprovalActionModal(task) {\n            const modalBody = document.getElementById('approvalTaskDetails');\n            modalBody.innerHTML = `\n                <p><strong>ID:</strong> ${task.id}</p>\n                <p><strong>Descrição:</strong> ${task.description}</p>\n                <p><strong>Responsável:</strong> ${task.responsible}</p>\n                <p><strong>Projeto:</strong> ${task.project}</p>\n            `;\n            \n            document.getElementById('cancelReason').value = '';\n            document.getElementById('initialButtons').style.display = 'block';\n            document.getElementById('cancelReasonSection').style.display = 'none';\n            document.getElementById('confirmCancelButtons').style.display = 'none';\n\n            document.getElementById('confirmApproveBtn').dataset.id = task.id;\n            document.getElementById('confirmCancelBtn').dataset.id = task.id;\n\n            new bootstrap.Modal(document.getElementById('approvalActionModal')).show();\n        }\n\n        function setupTimeControlListeners() {\n            const timeControlModalEl = document.getElementById('timeControlModal');\n            const manualTimeModal = new bootstrap.Modal(document.getElementById('manualTimeModal'));\n            const confirmationModal = new bootstrap.Modal(document.getElementById('timeConfirmationModal'));\n            const observationSection = document.getElementById('timeControlObservationSection');\n            const observationInput = document.getElementById('timeControlObservation');\n\n            // Estado para a ação de confirmação\n            let _pendingAction = null;\n\n            document.body.addEventListener('click', async (event) => {\n                const target = event.target.closest('button');\n                if (!target) return;\n\n                const taskId = target.dataset.taskId;\n\n                // Função para mostrar modal de confirmação\n                const showConfirmationModal = (actionType, message) => {\n                    document.getElementById('timeConfirmationMessage').textContent = message;\n                    _pendingAction = { type: actionType, taskId: taskId };\n                    confirmationModal.show();\n                };\n\n                if (target.id === 'startAutomaticBtn') {\n                    if (!observationInput.value.trim()) {\n                        UI.showNotification('A observação é obrigatória para iniciar a tarefa.', 'warning');\n                        observationInput.focus();\n                        return;\n                    }\n                    showConfirmationModal('startAutomatic', 'Iniciar automaticamente o controle de horas para esta tarefa?');\n                } \n                else if (target.id === 'startManualBtn') {\n                    if (!observationInput.value.trim()) {\n                        UI.showNotification('A observação é obrigatória para iniciar um registro manual.', 'warning');\n                        observationInput.focus();\n                        return;\n                    }\n                    showConfirmationModal('startManual', 'Iniciar manualmente o controle de horas para esta tarefa?');\n                }\n                else if (target.id === 'stopAutomaticBtn') {\n                    showConfirmationModal('stopAutomatic', 'Finalizar automaticamente o controle de horas para esta tarefa?');\n                } \n                else if (target.id === 'stopManualBtn') {\n                    showConfirmationModal('stopManual', 'Finalizar manualmente o controle de horas para esta tarefa?');\n                }\n            });\n\n            // Event listener do botão de confirmação\n            document.getElementById('confirmTimeActionBtn').addEventListener('click', async () => {\n                if (!_pendingAction) return;\n\n                confirmationModal.hide();\n\n                const { type, taskId } = _pendingAction;\n                _pendingAction = null;\n\n                switch (type) {\n                    case 'startAutomatic':\n                        await sendTimeEntryUpdate('start', taskId, observationInput.value, null);\n                        break;\n                    case 'startManual':\n                        _timeControlState.action = 'start';\n                        _timeControlState.taskId = taskId;\n                        document.getElementById('manualTimeModalTitle').textContent = 'Inserir Horário de Início Manual';\n                        manualTimeModal.show();\n                        break;\n                    case 'stopAutomatic':\n                        await sendTimeEntryUpdate('stop', taskId, observationInput.value || \"\", null);\n                        break;\n                    case 'stopManual':\n                        _timeControlState.action = 'stop';\n                        _timeControlState.taskId = taskId;\n                        document.getElementById('manualTimeModalTitle').textContent = 'Inserir Horário de Fim Manual';\n                        manualTimeModal.show();\n                        break;\n                }\n            });\n\n            document.getElementById('confirmManualTimeBtn').addEventListener('click', async () => {\n                const manualDateTimeInput = document.getElementById('manualDateTimeInput');\n                if (!manualDateTimeInput.value) {\n                    UI.showNotification('Por favor, insira data e hora.', 'warning');\n                    return;\n                }\n                const manualTimestamp = manualDateTimeInput.value;\n                manualTimeModal.hide();\n                \n                const observation = document.getElementById('timeControlObservation').value;\n                \n                await sendTimeEntryUpdate(_timeControlState.action, _timeControlState.taskId, observation, manualTimestamp);\n            });\n            \n            if (timeControlModalEl) {\n                timeControlModalEl.addEventListener('hidden.bs.modal', () => {\n                    console.log('Modal de horas fechado, atualizando a lista de tarefas.');\n                    reloadTaskDataAfterOperation('fechamento do modal');\n                });\n            }\n        }\n\n\n        // ===================================\n        // VERIFICAÇÃO E LIMPEZA DE SERVICE WORKERS\n        // ===================================\n        async function checkAndUnregisterServiceWorkers() {\n            if ('serviceWorker' in navigator) {\n                try {\n                    const registrations = await navigator.serviceWorker.getRegistrations();\n                    if (registrations.length > 0) {\n                        console.warn('⚠️ Service Workers detectados! Desregistrando...');\n                        for (let registration of registrations) {\n                            const result = await registration.unregister();\n                            console.log('🗑️ Service Worker desregistrado:', result);\n                        }\n                        UI.showNotification('Service Workers removidos. A página será recarregada.', 'info', 3000);\n                        setTimeout(() => {\n                            window.location.reload(true);\n                        }, 3000);\n                        return true;\n                    } else {\n                        console.log('✅ Nenhum Service Worker ativo detectado.');\n                        return false;\n                    }\n                } catch (error) {\n                    console.error('❌ Erro ao verificar Service Workers:', error);\n                    return false;\n                }\n            }\n            return false;\n        }\n\n        // ===================================\n        // INICIALIZAÇÃO DA APLICAÇÃO\n        // ===================================\n        const App = {\n            initialize: async () => {\n                console.log('🚀 Iniciando ResolvTask Dashboard...');\n                \n                // Verificar e desregistrar Service Workers antes de continuar\n                const hadServiceWorkers = await checkAndUnregisterServiceWorkers();\n                if (hadServiceWorkers) {\n                    return; // Para a execução pois a página será recarregada\n                }\n                \n                if (!Auth.checkAuth()) {\n                    Auth.redirectToLogin();\n                    return;\n                }\n\n                UI.showAuthenticatedInterface();\n                UI.updateUserInfo();\n                UI.applyUIPermissions();\n\n                await initializeApplication();\n                setupEventListeners();\n                setupTimeControlListeners();\n                \n                const timeControlModalEl = document.getElementById('timeControlModal');\n                if (timeControlModalEl) {\n                    timeControlModalEl.addEventListener('hidden.bs.modal', () => {\n                        console.log('Modal de horas fechado, atualizando a lista de tarefas.');\n                        reloadTaskDataAfterOperation('fechamento do modal');\n                    });\n                }\n            }\n        };\n\n        await App.initialize();\n    });\n    </script>\n</body>\n</html>\n\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -1920,
        2592
      ],
      "id": "7b1ea7f5-b215-45fa-8f0c-904e4a278750",
      "name": "Check-in HTML1"
    },
    {
      "parameters": {
        "path": "/login",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2560,
        2192
      ],
      "id": "dae4af5f-920c-4865-bc45-ecd0d27cb8dd",
      "name": "Tela de Login2",
      "webhookId": "cce5e6b5-f99a-48a3-8b18-cf524f03c4ce"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1696,
        2192
      ],
      "id": "b34328cf-8f4c-431c-9780-4db631469901",
      "name": "Respond to Login1",
      "notes": "A alguma Instabilidade no Sitem, Tente novamente Mais tarde."
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "configurations"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2352,
        2192
      ],
      "id": "eabce4dc-ffd1-4220-981f-9604481f842a",
      "name": "Consulta Dominio Login2",
      "alwaysOutputData": true,
      "executeOnce": false,
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e63701a4-5c13-4f77-96a1-9ff33820e4e6",
              "name": "dominio.resolv",
              "value": "=https://n8n.resolv.ai/webhook/resolv",
              "type": "string"
            },
            {
              "id": "8113f77c-0a0f-4fba-903b-6a8f5a333cca",
              "name": "dominio.autenticar",
              "value": "=https://n8n.resolv.ai/webhook/autenticar",
              "type": "string"
            },
            {
              "id": "d28e88c4-6600-42ff-90ec-84cb6cdf4691",
              "name": "dominio.cadastro",
              "value": "=https://n8n.resolv.ai/webhook/res/cadastro",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2160,
        2192
      ],
      "id": "feb780ce-d944-4551-a9cd-b4c1cf1eb748",
      "name": "Trata dados Dominio  Login1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e63701a4-5c13-4f77-96a1-9ff33820e4e6",
              "name": "menu.gerenciadortarefas",
              "value": "=https://n8n.resolv.ai/webhook/dev/gerenciadortarefas",
              "type": "string"
            },
            {
              "id": "a702af87-d175-4920-a6d8-13ec8555e79a",
              "name": "menu.taskhoras",
              "value": "=https://n8n.resolv.ai/webhook/dev/taskhoras",
              "type": "string"
            },
            {
              "id": "6d2db409-40f8-4cb6-919c-fba5921b950a",
              "name": "menu.gestao_clientes",
              "value": "=https://n8n.resolv.ai/webhook/dev/gestao_clientes",
              "type": "string"
            },
            {
              "id": "cfdca80e-1d46-4dc2-bd4e-e2387e0ff2f4",
              "name": "menu.equipe",
              "value": "=https://n8n.resolv.ai/webhook/dev/equipe",
              "type": "string"
            },
            {
              "id": "95f02e2b-dc36-41fe-aa9d-b3dad2b2f836",
              "name": "menu.conf",
              "value": "=https://n8n.resolv.ai/webhook/dev/conf",
              "type": "string"
            },
            {
              "id": "6825628a-da8f-4989-8b51-69f74f6f9ef2",
              "name": "conf_globais.login",
              "value": "=https://n8n.resolv.ai/webhook/dev/login",
              "type": "string"
            },
            {
              "id": "77eab553-0a8b-4ee6-9f14-e7e340a77536",
              "name": "conf_globais. consultadadosresolv",
              "value": "=https://n8n.resolv.ai/webhook/dev/consultadadosresolv",
              "type": "string"
            },
            {
              "id": "822410a1-a1b7-4f0b-a925-437347ef2317",
              "name": "conf_globais.consultacolaboradores",
              "value": "=https://n8n.resolv.ai/webhook/dev/consultacolaboradores",
              "type": "string"
            },
            {
              "id": "eea74aa5-24d7-46dd-96fe-910c0bb8012f",
              "name": "menu.gestaodeparceiros",
              "value": "=https://n8n.resolv.ai/webhook/dev/gestaodeparceiros",
              "type": "string"
            },
            {
              "id": "2ea166ad-14ad-4315-8779-b13defc87fc9",
              "name": "conf_globais.consultaconfiguracoes",
              "value": "=https://n8n.resolv.ai/webhook/dev/consultaconfiguracoes",
              "type": "string"
            },
            {
              "id": "e20cf923-ee42-4b73-a732-4d25a5ab3a21",
              "name": "conf_globais.salvatarefas",
              "value": "=https://n8n.resolv.ai/webhook/dev/salvatarefas",
              "type": "string"
            },
            {
              "id": "ee8747b1-bcd5-4932-b721-f99bbbfee124",
              "name": "conf_globais.consultadontrolehoras",
              "value": "=https://n8n.resolv.ai/webhook/dev/consultadontrolehoras",
              "type": "string"
            },
            {
              "id": "891440cc-eea1-447f-b9ec-581c96c31774",
              "name": "conf_globais.consulta_tarefas",
              "value": "=https://n8n.resolv.ai/webhook/dev/consulta_tarefas",
              "type": "string"
            },
            {
              "id": "9ebf0105-4074-482d-8000-55db6f2b9bcd",
              "name": "conf_globais.recebedados",
              "value": "=https://n8n.resolv.ai/webhook/dev/recebedados",
              "type": "string"
            },
            {
              "id": "0b1f6902-8b3f-40e2-822b-0bcd1ce7f7f3",
              "name": "conf_globais.consulta_clientes",
              "value": "=https://n8n.resolv.ai/webhook/dev/consulta_clientes",
              "type": "string"
            },
            {
              "id": "4f005b0b-c030-493d-a5cc-b53891b09a5d",
              "name": "conf_globais.consulta_empresa",
              "value": "=https://n8n.resolv.ai/webhook/dev/consulta_empresa",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2160,
        2592
      ],
      "id": "aa880b63-3fd3-491f-a4f2-d661d589cd55",
      "name": "Trata dados Dominio  Tarefas"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <meta name=\"description\" content=\"ResolvTask - Timeline de Projetos e Acompanhamento\">\n    <meta name=\"keywords\" content=\"gestão, tarefas, timeline, roadmap, resolv, produtividade\">\n    <title>Timeline de Projetos - ResolvTask</title>\n\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n    <style>\n        :root {\n            /* Cores primárias (serão substituídas dinamicamente) */\n            --primary-color: #0d6efd;\n            --primary-color-dark: #0b5ed7;\n            --primary-color-shadow: rgba(13, 110, 253, 0.3);\n\n            /* Outras cores */\n            --secondary-color: #6c757d;\n            --success-color: #198754;\n            --danger-color: #dc3545;\n            --warning-color: #ffc107;\n            --info-color: #0dcaf0;\n            --light-color: #f8f9fa;\n            --dark-color: #212529;\n            --not-started-color: #fd7e14;\n            --purple-color: #6f42c1;\n            --pink-color: #d63384;\n            --teal-color: #20c997;\n            --orange-color: #fd7e14;\n            --indigo-color: #6610f2;\n            --cyan-color: #0dcaf0;\n            \n            /* Timeline específicas */\n            --timeline-bg: #ffffff;\n            --timeline-border: #e9ecef;\n            --timeline-header-bg: #f8f9fa;\n            --timeline-today: #dc3545;\n            --timeline-weekend: #6c757d;\n            --timeline-grid: #dee2e6;\n            --separator-color: #6c757d;\n            \n            /* --- MELHORIA: Altura da linha aumentada para evitar sobreposição --- */\n            --nav-height: 70px;\n            --controls-height: 180px;\n            --timeline-header-height: 100px;\n            --row-height: 200px; /* Aumentado de 120px para 200px */\n        }\n\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        html, body {\n            height: 100%;\n            overflow: hidden; /* Controlado pelo app-container */\n        }\n\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background-color: var(--light-color);\n            display: flex;\n            flex-direction: column;\n        }\n\n        /* Loading inicial quando não logado */\n        .auth-loading {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color-dark) 100%);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            color: white;\n        }\n        \n        .auth-loading .spinner-auth {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(255, 255, 255, 0.3);\n            border-top: 4px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n        \n        .auth-loading h4 {\n            margin-bottom: 10px;\n            font-weight: 300;\n        }\n        \n        .auth-loading p {\n            opacity: 0.8;\n            font-size: 0.9rem;\n        }\n\n        /* Layout principal flexível */\n        .app-container {\n            opacity: 0;\n            transition: opacity 0.5s ease;\n            height: 100vh;\n            display: flex;\n            flex-direction: row;\n        }\n        \n        .app-container.authenticated {\n            opacity: 1;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 280px;\n            min-width: 280px;\n            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color-dark) 100%);\n            transition: transform 0.3s ease;\n            z-index: 1000;\n            overflow-y: auto;\n            flex-shrink: 0;\n        }\n\n        .sidebar.collapsed {\n            transform: translateX(-100%);\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255,255,255,0.1);\n            background-color: white;\n        }\n\n        .sidebar-header .logo {\n            max-width: 150px;\n            height: auto;\n            margin-bottom: 10px;\n        }\n        \n        .sidebar-header .text-light {\n            color: #212529 !important;\n            font-weight: 500;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n        }\n\n        .menu-item {\n            display: block;\n            padding: 15px 25px;\n            color: rgba(255,255,255,0.8);\n            text-decoration: none;\n            transition: all 0.3s ease;\n            border: none;\n            background: none;\n            width: 100%;\n            text-align: left;\n            cursor: pointer;\n            display: none;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .menu-item:hover,\n        .menu-item.active {\n            background-color: rgba(255,255,255,0.1);\n            color: white;\n        }\n\n        .menu-item i {\n            width: 20px;\n            margin-right: 15px;\n        }\n\n        .menu-item.show {\n            display: block;\n            opacity: 1;\n        }\n\n        .sidebar-loading {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 40px 20px;\n            color: rgba(255, 255, 255, 0.8);\n            font-size: 0.9rem;\n        }\n\n        .sidebar-loading .spinner-small {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid rgba(255, 255, 255, 0.8);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-right: 10px;\n        }\n\n        /* Main Content - Flexível */\n        .main-content {\n            flex: 1;\n            display: flex;\n            flex-direction: column;\n            transition: margin-left 0.3s ease;\n            min-height: 100vh;\n            overflow: hidden;\n        }\n\n        .main-content.expanded {\n            margin-left: 0;\n        }\n\n        /* Top Navigation - Altura fixa */\n        .top-nav {\n            background: white;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            padding: 15px 25px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            z-index: 999;\n            height: var(--nav-height);\n            flex-shrink: 0;\n        }\n\n        .sidebar-toggle {\n            display: none;\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n        }\n\n        .user-info {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n        /* Content Area - Flexível para usar espaço restante */\n        .content-area {\n            flex: 1;\n            padding: 20px;\n            display: flex;\n            flex-direction: column;\n            overflow: hidden;\n            height: calc(100vh - var(--nav-height));\n        }\n\n        /* Cards */\n        .card {\n            border: none;\n            border-radius: 15px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n            margin-bottom: 20px;\n            transition: transform 0.3s ease;\n            flex-shrink: 0;\n        }\n\n        .card:hover {\n            transform: translateY(-2px);\n        }\n\n        /* Timeline Controls - Altura fixa */\n        .timeline-controls {\n            background: white;\n            border-radius: 15px;\n            padding: 20px;\n            margin-bottom: 20px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n            flex-shrink: 0;\n            height: var(--controls-height);\n            overflow: hidden;\n        }\n\n        .controls-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 15px;\n        }\n\n        .view-selector {\n            display: flex;\n            gap: 8px;\n            margin-bottom: 15px;\n            flex-wrap: wrap;\n        }\n\n        .view-btn {\n            padding: 8px 16px;\n            border: 2px solid var(--primary-color);\n            background: transparent;\n            color: var(--primary-color);\n            border-radius: 25px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            font-weight: 600;\n            font-size: 13px;\n            position: relative;\n            overflow: hidden;\n            z-index: 1;\n        }\n\n        .view-btn::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: -100%;\n            width: 100%;\n            height: 100%;\n            background: var(--primary-color);\n            transition: left 0.3s ease;\n            z-index: -1;\n        }\n\n        .view-btn.active::before,\n        .view-btn:hover::before {\n            left: 0;\n        }\n\n        .view-btn.active,\n        .view-btn:hover {\n            color: white;\n            transform: translateY(-2px);\n            box-shadow: 0 4px 15px var(--primary-color-shadow);\n        }\n\n        .timeline-navigation {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        .nav-btn {\n            background: var(--light-color);\n            border: 1px solid var(--timeline-border);\n            color: var(--dark-color);\n            padding: 8px 12px;\n            border-radius: 8px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        }\n\n        .nav-btn:hover {\n            background: var(--primary-color);\n            color: white;\n            transform: scale(1.05);\n        }\n\n        .current-period {\n            font-weight: 600;\n            color: var(--dark-color);\n            min-width: 150px;\n            text-align: center;\n        }\n\n        .filters-row {\n            display: flex;\n            gap: 12px;\n            align-items: center;\n            flex-wrap: wrap;\n        }\n\n        .filter-group {\n            display: flex;\n            flex-direction: column;\n            gap: 5px;\n            min-width: 160px;\n            flex: 1;\n        }\n\n        .filter-group label {\n            font-weight: 600;\n            color: var(--dark-color);\n            font-size: 0.8rem;\n        }\n\n        /* Timeline Container - Usa todo espaço restante */\n        .timeline-container {\n            background: var(--timeline-bg);\n            border-radius: 15px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n            overflow: hidden;\n            flex: 1;\n            display: flex;\n            flex-direction: column;\n            min-height: 0;\n            border: 1px solid var(--timeline-border);\n        }\n\n        .timeline-header {\n            display: flex;\n            background: var(--timeline-header-bg);\n            border-bottom: 2px solid var(--timeline-grid);\n            z-index: 10;\n            height: var(--timeline-header-height);\n            flex-shrink: 0;\n        }\n\n        .timeline-sidebar {\n            width: 400px;\n            min-width: 400px;\n            padding: 20px 25px;\n            border-right: 2px solid var(--timeline-grid);\n            background: white;\n            font-weight: 600;\n            color: var(--dark-color);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            font-size: 16px;\n            flex-shrink: 0;\n        }\n\n        .timeline-dates-wrapper {\n            flex: 1;\n            overflow-x: auto;\n            overflow-y: hidden;\n            background: var(--timeline-header-bg);\n            display: flex;\n            flex-wrap: nowrap;\n        }\n\n        .timeline-dates {\n            display: flex;\n            background: var(--timeline-header-bg);\n            flex-shrink: 0;\n            min-width: max-content;\n        }\n\n        .date-column {\n            min-width: 180px;\n            padding: 12px;\n            text-align: center;\n            border-right: 1px solid var(--timeline-grid);\n            font-weight: 500;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            position: relative;\n            transition: all 0.3s ease;\n        }\n\n        .date-column:hover {\n            background: rgba(13, 110, 253, 0.05);\n        }\n\n        .date-column.today {\n            background: rgba(220, 53, 69, 0.1);\n            color: var(--danger-color);\n            font-weight: 700;\n            box-shadow: inset 0 0 0 2px var(--danger-color);\n        }\n\n        .date-column.weekend {\n            background: rgba(108, 117, 125, 0.1);\n            color: var(--secondary-color);\n        }\n\n        .date-column.milestone {\n            background: linear-gradient(135deg, var(--warning-color) 0%, #ffc107 100%);\n            color: var(--dark-color);\n        }\n\n        .date-weekday {\n            font-size: 12px;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n            opacity: 0.7;\n        }\n\n        .date-day {\n            font-size: 20px;\n            font-weight: 700;\n            margin: 4px 0;\n        }\n\n        .date-month {\n            font-size: 11px;\n            opacity: 0.6;\n            text-transform: uppercase;\n        }\n\n        .timeline-body {\n            display: flex;\n            flex: 1;\n            overflow: hidden;\n            min-height: 0;\n        }\n\n        .timeline-rows {\n            width: 400px;\n            min-width: 400px;\n            border-right: 2px solid var(--timeline-grid);\n            overflow-y: auto;\n            overflow-x: hidden;\n            background: white;\n        }\n        \n        .timeline-grid-wrapper {\n            flex: 1;\n            overflow-x: auto;\n            overflow-y: auto;\n            display: flex;\n            flex-direction: column;\n            flex-wrap: nowrap;\n        }\n\n        .timeline-grid {\n            flex: 1;\n            background: repeating-linear-gradient(\n                to right,\n                transparent,\n                transparent 179px,\n                var(--timeline-grid) 179px,\n                var(--timeline-grid) 180px\n            );\n            min-width: max-content;\n            min-height: 100%;\n        }\n\n        .timeline-row {\n            display: flex;\n            border-bottom: 1px solid #dee2e6;\n            min-height: var(--row-height);\n            transition: background-color 0.3s ease;\n            position: relative;\n        }\n\n        .timeline-row:hover {\n            background-color: rgba(13, 110, 253, 0.02);\n        }\n\n        .timeline-row:last-child {\n            border-bottom: none;\n        }\n\n        .timeline-row-separator {\n            position: relative;\n            height: 16px;\n            background: linear-gradient(90deg,\n                transparent 0%,\n                var(--separator-color) 20%,\n                var(--separator-color) 80%,\n                transparent 100%);\n            opacity: 0.3;\n            margin: 12px 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            flex-shrink: 0;\n        }\n\n        .timeline-row-separator::before {\n            content: '';\n            position: absolute;\n            left: 50%;\n            top: 50%;\n            transform: translate(-50%, -50%);\n            width: 250px;\n            height: 2px;\n            background: repeating-linear-gradient(\n                90deg,\n                var(--separator-color) 0px,\n                var(--separator-color) 10px,\n                transparent 10px,\n                transparent 20px\n            );\n            opacity: 0.6;\n        }\n\n        .timeline-row-separator::after {\n            content: '●●●';\n            position: absolute;\n            left: 50%;\n            top: 50%;\n            transform: translate(-50%, -50%);\n            color: var(--separator-color);\n            font-size: 10px;\n            letter-spacing: 6px;\n            background: white;\n            padding: 0 15px;\n            opacity: 0.7;\n        }\n\n        .timeline-grid-separator {\n            height: 16px;\n            border-bottom: 1px dashed var(--separator-color);\n            opacity: 0.3;\n            margin: 12px 0;\n            background: repeating-linear-gradient(\n                to right,\n                transparent,\n                transparent 179px,\n                rgba(108, 117, 125, 0.2) 179px,\n                rgba(108, 117, 125, 0.2) 180px\n            );\n            flex-shrink: 0;\n        }\n\n        .row-header {\n            width: 400px;\n            min-width: 400px;\n            padding: 20px;\n            background: white;\n            border-right: 2px solid var(--timeline-grid);\n            display: flex;\n            align-items: center;\n            gap: 15px;\n            position: relative;\n            min-height: var(--row-height);\n            flex-shrink: 0;\n        }\n\n        .responsible-avatar {\n            width: 55px;\n            height: 55px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 16px;\n            flex-shrink: 0;\n            box-shadow: 0 3px 10px rgba(0,0,0,0.15);\n            border: 3px solid white;\n        }\n\n        .responsible-info {\n            flex: 1;\n        }\n\n        .responsible-info h6 {\n            margin: 0 0 6px 0;\n            font-size: 16px;\n            font-weight: 600;\n            color: var(--dark-color);\n        }\n\n        .responsible-info small {\n            color: var(--secondary-color);\n            font-size: 13px;\n            display: block;\n        }\n\n        .responsible-summary-stats {\n            margin-top: 8px;\n            font-size: 11px;\n            color: var(--dark-color);\n            line-height: 1.4;\n        }\n        .responsible-summary-stats div {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        .responsible-summary-stats .text-primary {\n            color: var(--primary-color) !important;\n            font-weight: bold;\n        }\n        .responsible-summary-stats .text-dark {\n            color: var(--dark-color) !important;\n            font-weight: bold;\n        }\n        .responsible-summary-stats .text-danger {\n            color: var(--danger-color) !important;\n            font-weight: bold;\n        }\n        .responsible-summary-stats .text-success {\n            color: var(--success-color) !important;\n            font-weight: bold;\n        }\n        .responsible-summary-stats .text-muted {\n            color: var(--secondary-color) !important;\n        }\n\n        .workload-indicator {\n            position: absolute;\n            right: 15px;\n            top: 20px;\n            width: 14px;\n            height: 14px;\n            border-radius: 50%;\n            border: 2px solid white;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n        }\n\n        .workload-normal { background-color: #28a745; }\n        .workload-moderate { background-color: #ffc107; }\n        .workload-critical { background-color: #dc3545; animation: pulse 2s infinite; }\n\n        @keyframes pulse {\n            0% { transform: scale(1); }\n            50% { transform: scale(1.2); }\n            100% { transform: scale(1); }\n        }\n\n        .row-content {\n            display: flex;\n            position: relative;\n            min-height: var(--row-height);\n            align-items: stretch;\n            flex-shrink: 0;\n        }\n\n        .time-column {\n            min-width: 180px;\n            height: var(--row-height);\n            border-right: 1px solid var(--timeline-border);\n            position: relative;\n            transition: background-color 0.3s ease;\n            flex-shrink: 0;\n        }\n\n        .time-column:hover { background: rgba(13, 110, 253, 0.05); }\n        .time-column.weekend { background: rgba(108, 117, 125, 0.03); }\n        .time-column.today-column { background: rgba(220, 53, 69, 0.05); }\n\n        .task-bar {\n            position: absolute;\n            height: 45px;\n            border-radius: 10px;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            padding: 4px 12px;\n            color: white;\n            font-size: 12px;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            box-shadow: 0 3px 12px rgba(0,0,0,0.15);\n            z-index: 5;\n            overflow: hidden;\n            border: 2px solid rgba(255,255,255,0.9);\n            line-height: 1.2;\n        }\n\n        .task-bar:hover {\n            transform: translateY(-4px) scale(1.02);\n            box-shadow: 0 10px 30px rgba(0,0,0,0.25);\n            z-index: 15;\n            height: 50px;\n        }\n\n        .task-bar::before {\n            content: '';\n            position: absolute;\n            top: 0; left: 0; right: 0; bottom: 0;\n            background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%);\n            background-size: 10px 10px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .task-bar:hover::before { opacity: 1; }\n\n        .task-info-line {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            margin: 1px 0;\n        }\n\n        .task-description {\n            font-weight: 700;\n            font-size: 13px;\n            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            flex-grow: 1;\n        }\n\n        .task-hours-info {\n            font-size: 11px;\n            opacity: 0.95;\n            display: flex;\n            gap: 6px;\n            flex-shrink: 0;\n            margin-left: 8px;\n        }\n\n        .task-deviation {\n            font-weight: 700;\n            font-size: 11px;\n            padding: 2px 4px;\n            border-radius: 4px;\n            background: rgba(255,255,255,0.2);\n        }\n\n        .task-deviation.positive { background: rgba(220, 53, 69, 0.8); }\n        .task-deviation.negative { background: rgba(25, 135, 84, 0.8); }\n\n        .task-bar.status-concluido::after { content: '✓'; position: absolute; top: 4px; right: 6px; font-weight: bold; font-size: 14px; background: rgba(255,255,255,0.2); border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; }\n        .task-bar.status-em-andamento::after { content: '⏱'; position: absolute; top: 4px; right: 6px; font-size: 12px; animation: pulse 2s infinite; }\n        .task-bar.status-nao-iniciado::after { content: '⏸'; position: absolute; top: 4px; right: 6px; font-size: 12px; opacity: 0.7; }\n        .task-bar.status-paralizado::after { content: '⏹'; position: absolute; top: 4px; right: 6px; font-size: 12px; color: #ffc107; }\n\n        .task-progress {\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            height: 4px;\n            background: rgba(255,255,255,0.9);\n            border-radius: 0 0 8px 8px;\n            transition: width 0.5s ease;\n        }\n\n        .today-line {\n            position: absolute;\n            top: 0;\n            bottom: 0;\n            width: 4px;\n            background: var(--danger-color);\n            z-index: 10;\n            left: 50%;\n            transform: translateX(-50%);\n            box-shadow: 0 0 12px rgba(220, 53, 69, 0.5);\n            animation: todayPulse 3s infinite;\n        }\n\n        @keyframes todayPulse {\n            0%, 100% { opacity: 1; }\n            50% { opacity: 0.6; }\n        }\n\n        .milestone-marker {\n            position: absolute;\n            top: 0;\n            bottom: 0;\n            width: 3px;\n            background: var(--warning-color);\n            z-index: 8;\n            left: 50%;\n            transform: translateX(-50%);\n        }\n\n        .milestone-marker::before {\n            content: '◆';\n            position: absolute;\n            top: -6px;\n            left: 50%;\n            transform: translateX(-50%);\n            color: var(--warning-color);\n            font-size: 14px;\n        }\n\n        .empty-state {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            height: 100%;\n            color: var(--secondary-color);\n            text-align: center;\n            padding: 40px;\n            background: var(--timeline-bg);\n        }\n\n        .empty-state i {\n            font-size: 4rem;\n            margin-bottom: 20px;\n            opacity: 0.3;\n            color: var(--primary-color);\n        }\n\n        .empty-state h4 {\n            margin-bottom: 10px;\n            font-weight: 600;\n            color: var(--dark-color);\n        }\n\n        .empty-state p {\n            font-size: 0.95rem;\n            opacity: 0.8;\n            max-width: 400px;\n        }\n\n        .task-tooltip {\n            position: absolute;\n            background: var(--dark-color);\n            color: white;\n            padding: 25px;\n            border-radius: 12px;\n            font-size: 14px;\n            z-index: 1000;\n            max-width: 500px;\n            box-shadow: 0 10px 30px rgba(0,0,0,0.3);\n            display: none;\n            border: 1px solid rgba(255,255,255,0.1);\n        }\n\n        .task-tooltip::before {\n            content: '';\n            position: absolute;\n            top: -8px;\n            left: 20px;\n            border-left: 8px solid transparent;\n            border-right: 8px solid transparent;\n            border-bottom: 8px solid var(--dark-color);\n        }\n\n        .task-tooltip h6 {\n            margin: 0 0 15px 0;\n            font-size: 18px;\n            font-weight: 600;\n            color: #fff;\n            border-bottom: 1px solid rgba(255,255,255,0.2);\n            padding-bottom: 10px;\n        }\n\n        .tooltip-section { margin-bottom: 15px; }\n        .tooltip-section:last-child { margin-bottom: 0; }\n        .tooltip-section h6 { font-size: 12px; color: #ccc; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; border: none; padding: 0; }\n        .tooltip-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }\n        .tooltip-row:last-child { margin-bottom: 0; }\n        .tooltip-label { font-weight: 600; color: #ccc; font-size: 14px; }\n        .tooltip-value { color: #fff; text-align: right; flex: 1; margin-left: 15px; font-size: 14px; }\n        .tooltip-status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase; }\n        .tooltip-progress-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin-top: 5px; }\n        .tooltip-progress-fill { height: 100%; background: var(--success-color); border-radius: 3px; transition: width 0.5s ease; }\n\n        .loading { display: flex; flex-direction: column; justify-content: center; align-items: center; flex: 1; gap: 20px; }\n        .spinner { width: 60px; height: 60px; border: 4px solid var(--light-color); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }\n        .loading-text { color: var(--secondary-color); font-size: 1.1rem; font-weight: 500; }\n        .notification { position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px; }\n\n        @media (max-width: 1200px) {\n            :root { --controls-height: 200px; --row-height: 180px; }\n            .content-area { padding: 15px; }\n            .timeline-sidebar, .timeline-rows { width: 350px; min-width: 350px; }\n            .row-header { width: 350px; min-width: 350px; padding: 15px; }\n            .date-column, .time-column { min-width: 150px; }\n            .workload-info { display: none; }\n            .task-bar { height: 38px; font-size: 11px; }\n            .task-bar:hover { transform: translateY(-2px) scale(1.02); height: 42px; }\n            .task-tooltip { max-width: 450px; padding: 20px; font-size: 13px; }\n            .task-tooltip h6 { font-size: 16px; }\n            .tooltip-label, .tooltip-value { font-size: 13px; }\n        }\n\n        @media (max-width: 768px) {\n            .sidebar { position: fixed; height: 100vh; transform: translateX(-100%); z-index: 1050; }\n            .sidebar.show { transform: translateX(0); }\n            .main-content { width: 100%; }\n            .sidebar-toggle { display: block; }\n            .content-area { padding: 12px; height: calc(100vh - var(--nav-height)); }\n            :root { --row-height: 150px; }\n            .timeline-sidebar, .timeline-rows { width: 280px; min-width: 280px; }\n            .row-header { width: 280px; min-width: 280px; padding: 12px; gap: 10px; }\n            .responsible-avatar { width: 45px; height: 45px; font-size: 14px; }\n            .responsible-info h6 { font-size: 14px; }\n            .responsible-info small { font-size: 12px; }\n            .date-column, .time-column { min-width: 120px; }\n            .task-bar { height: 32px; padding: 2px 8px; font-size: 10px; }\n            .task-bar:hover { height: 36px; }\n            .task-description { font-size: 11px; }\n            .task-hours-info { font-size: 9px; }\n            .task-deviation { font-size: 9px; }\n            .filters-row { flex-direction: column; align-items: stretch; }\n            .filter-group { min-width: 100%; }\n            .view-selector { justify-content: center; }\n            .view-btn { font-size: 11px; padding: 6px 12px; }\n            .timeline-controls { height: auto; min-height: 140px; }\n            .controls-header { flex-direction: column; gap: 10px; align-items: stretch; }\n            .timeline-navigation { justify-content: center; }\n            :root { --controls-height: auto; }\n            .task-tooltip { max-width: 350px; padding: 15px; font-size: 12px; }\n            .task-tooltip h6 { font-size: 14px; }\n            .tooltip-label, .tooltip-value { font-size: 12px; }\n        }\n\n        @media (max-width: 576px) {\n            .content-area { padding: 8px; }\n            :root { --row-height: 120px; }\n            .timeline-sidebar, .timeline-rows { width: 220px; min-width: 220px; }\n            .row-header { width: 220px; min-width: 220px; padding: 10px; gap: 8px; }\n            .responsible-avatar { width: 40px; height: 40px; font-size: 12px; }\n            .responsible-info h6 { font-size: 13px; }\n            .responsible-info small { font-size: 11px; }\n            .date-column, .time-column { min-width: 100px; }\n            .task-bar { height: 28px; padding: 2px 6px; font-size: 9px; }\n            .task-bar:hover { height: 32px; }\n            .task-description { font-size: 10px; }\n            .task-hours-info { font-size: 8px; }\n            .task-deviation { font-size: 8px; }\n            .timeline-controls { padding: 15px; }\n            .task-tooltip { max-width: 300px; padding: 10px; font-size: 11px; }\n            .task-tooltip h6 { font-size: 13px; }\n            .tooltip-label, .tooltip-value { font-size: 11px; }\n        }\n\n        @media (max-width: 768px) {\n            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040; opacity: 0; visibility: hidden; transition: all 0.3s ease; }\n            .sidebar-overlay.show { opacity: 1; visibility: visible; }\n        }\n\n        ::-webkit-scrollbar { width: 8px; height: 8px; }\n        ::-webkit-scrollbar-track { background: var(--light-color); border-radius: 4px; }\n        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }\n        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color-dark); }\n\n        @media (max-width: 768px) {\n            ::-webkit-scrollbar { width: 4px; height: 4px; }\n        }\n\n        .timeline-container { height: calc(100vh - var(--nav-height) - var(--controls-height) - 60px); min-height: 400px; }\n        @media (max-width: 768px) { .timeline-container { height: calc(100vh - var(--nav-height) - 180px); min-height: 300px; } }\n        @media (max-width: 576px) { .timeline-container { height: calc(100vh - var(--nav-height) - 160px); min-height: 250px; } }\n\n        .fade-in { animation: fadeIn 0.5s ease-out; }\n        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }\n        .slide-in-right { animation: slideInRight 0.3s ease-out; }\n        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }\n    </style>\n</head>\n<body>\n\n    <div class=\"auth-loading\" id=\"authLoading\">\n        <div class=\"spinner-auth\"></div>\n        <h4>ResolvTask Dashboard</h4>\n        <p>Verificando autenticação...</p>\n    </div>\n\n    <div class=\"app-container\" id=\"appContainer\">\n        <nav class=\"sidebar\" id=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <img src=\"https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png\" alt=\"ResolvAI Logo\" class=\"logo\">\n                <br><br>\n                <h1><i class=\"fas fa-bolt me-2\"></i>Task</h1>\n                <small class=\"text-light\">Sistema Integrado de Gestão</small>\n            </div>\n            <div class=\"sidebar-menu\" id=\"sidebarMenu\">\n                <div class=\"sidebar-loading\" id=\"sidebarLoading\">\n                    <div class=\"spinner-small\"></div>\n                    Carregando menu...\n                </div>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/resolv'\" data-menu=\"dashboard\">\n                    <i class=\"fas fa-chart-line\"></i>Dashboard\n                </button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/gerenciadortarefas'\" data-menu=\"tasks\">\n                    <i class=\"fas fa-tasks\"></i>Gerenciador de Tarefas\n                </button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/taskhoras'\" data-menu=\"hours\">\n                    <i class=\"fas fa-clock\"></i>Gerenciador de Horas\n                </button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/gestao_clientes'\" data-menu=\"clients\">\n                    <i class=\"fas fa-handshake\"></i>Gestão de Clientes\n                </button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/gestaodeparceiros'\" data-menu=\"partners\">\n                    <i class=\"fas fa-handshake-angle\"></i>Gestão de Parceiros\n                </button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/equipe'\" data-menu=\"team\">\n                    <i class=\"fas fa-users\"></i>Equipe\n                </button>\n                <button class=\"menu-item\" onclick=\"window.location.href='{{ $json.dominio }}/webhook/conf'\" data-menu=\"settings\">\n                    <i class=\"fas fa-cog\"></i>Configurações\n                </button>\n            </div>\n        </nav>\n\n        <main class=\"main-content\" id=\"mainContent\">\n            <nav class=\"top-nav\">\n                <div class=\"d-flex align-items-center\">\n                    <button class=\"sidebar-toggle\" id=\"sidebarToggle\">\n                        <i class=\"fas fa-bars\"></i>\n                    </button>\n                    <h5 class=\"mb-0 ms-3\" id=\"pageTitle\">Timeline de Projetos</h5>\n                </div>\n                <div class=\"user-info\">\n                    <button class=\"btn btn-outline-primary btn-sm me-2\" onclick=\"debugWebhook()\" title=\"Testar Conexão\">\n                        <i class=\"fas fa-plug me-1\"></i>Testar\n                    </button>\n                    <button class=\"btn btn-outline-secondary btn-sm me-2\" onclick=\"reloadColaboradores()\" title=\"Recarregar Colaboradores\">\n                        <i class=\"fas fa-users me-1\"></i>Colaboradores\n                    </button>\n                    <button class=\"btn btn-outline-info btn-sm me-2\" onclick=\"refreshCurrentPage()\" title=\"Atualizar Página\">\n                        <i class=\"fas fa-sync-alt me-1\"></i>Atualizar\n                    </button>\n                    <div class=\"d-flex align-items-center\">\n                        <i class=\"fas fa-user-circle fs-4 text-primary me-2\"></i>\n                        <span class=\"fw-bold\" id=\"userNameDisplay\">Usuário</span>\n                    </div>\n                    <small id=\"currentDate\" class=\"text-muted\"></small>\n                    <button class=\"btn btn-outline-danger btn-sm ms-2\" id=\"logoutButton\" title=\"Sair\">\n                        <i class=\"fas fa-sign-out-alt me-1\"></i>Sair\n                    </button>\n                </div>\n            </nav>\n\n            <div class=\"content-area\">\n                <div class=\"timeline-controls fade-in\">\n                    <div class=\"controls-header\">\n                        <div class=\"view-selector\">\n                            <button class=\"view-btn\" onclick=\"setView('week')\">\n                                <i class=\"fas fa-calendar-week me-2\"></i>Semana\n                            </button>\n                            <button class=\"view-btn active\" onclick=\"setView('month')\"> <i class=\"fas fa-calendar-alt me-2\"></i>Mês\n                            </button>\n                            <button class=\"view-btn\" onclick=\"setView('quarter')\">\n                                <i class=\"fas fa-calendar me-2\"></i>Trimestre\n                            </button>\n                        </div>\n                        \n                        <div class=\"timeline-navigation\">\n                            <button class=\"nav-btn\" onclick=\"navigateTimeline(-1)\" title=\"Período Anterior\">\n                                <i class=\"fas fa-chevron-left\"></i>\n                            </button>\n                            <span class=\"current-period\" id=\"currentPeriod\">Este Mês</span> <button class=\"nav-btn\" onclick=\"navigateTimeline(1)\" title=\"Próximo Período\">\n                                <i class=\"fas fa-chevron-right\"></i>\n                            </button>\n                            <button class=\"nav-btn\" onclick=\"goToToday()\" title=\"Hoje\">\n                                <i class=\"fas fa-crosshairs\"></i>\n                            </button>\n                        </div>\n                    </div>\n                    \n                    <div class=\"filters-row\">\n                        <div class=\"filter-group\">\n                            <label><i class=\"fas fa-user me-1\"></i>Responsável:</label>\n                            <select class=\"form-select form-select-sm\" id=\"responsibleFilter\" onchange=\"applyFilters()\">\n                                <option value=\"\">Todos os responsáveis</option>\n                            </select>\n                        </div>\n                        <div class=\"filter-group\">\n                            <label><i class=\"fas fa-project-diagram me-1\"></i>Projeto:</label>\n                            <select class=\"form-select form-select-sm\" id=\"projectFilter\" onchange=\"applyFilters()\">\n                                <option value=\"\">Todos os projetos</option>\n                            </select>\n                        </div>\n                        <div class=\"filter-group\">\n                            <label><i class=\"fas fa-user-tie me-1\"></i>Cliente:</label>\n                            <select class=\"form-select form-select-sm\" id=\"clientFilter\" onchange=\"applyFilters()\">\n                                <option value=\"\">Todos os clientes</option>\n                            </select>\n                        </div>\n                        <div class=\"filter-group\">\n                            <label><i class=\"fas fa-building me-1\"></i>Empresa:</label>\n                            <select class=\"form-select form-select-sm\" id=\"companyFilter\" onchange=\"applyFilters()\">\n                                <option value=\"\">Todos as empresas</option>\n                            </select>\n                        </div>\n                        <div class=\"filter-group\">\n                            <label><i class=\"fas fa-flag me-1\"></i>Status:</label>\n                            <select class=\"form-select form-select-sm\" id=\"statusFilter\" onchange=\"applyFilters()\">\n                                <option value=\"\">Todos os status</option>\n                                <option value=\"EM ANDAMENTO\">Em Andamento</option>\n                                <option value=\"CONCLUÍDO\">Concluído</option>\n                                <option value=\"NÃO INICIADO\">Não Iniciado</option>\n                                <option value=\"PARALIZADO\">Paralizado</option>\n                            </select>\n                        </div>\n                        <div class=\"filter-group\">\n                            <label><i class=\"fas fa-tags me-1\"></i>Tipo:</label>\n                            <select class=\"form-select form-select-sm\" id=\"typeFilter\" onchange=\"applyFilters()\">\n                                <option value=\"\">Todos os tipos</option>\n                            </select>\n                        </div>\n                        <div class=\"filter-group\">\n                            <label><i class=\"fas fa-calendar-day me-1\"></i>Data Inicial:</label>\n                            <input type=\"date\" class=\"form-control form-control-sm\" id=\"startDateFilter\" onchange=\"applyFilters()\">\n                        </div>\n                        <div class=\"filter-group\">\n                            <label><i class=\"fas fa-calendar-day me-1\"></i>Data Final:</label>\n                            <input type=\"date\" class=\"form-control form-control-sm\" id=\"endDateFilter\" onchange=\"applyFilters()\">\n                        </div>\n                        <div class=\"filter-group\">\n                            <label>&nbsp;</label>\n                            <button class=\"btn btn-outline-secondary btn-sm\" onclick=\"clearFilters()\">\n                                <i class=\"fas fa-times me-1\"></i>Limpar\n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"timeline-container fade-in\">\n                    <div class=\"timeline-header\">\n                        <div class=\"timeline-sidebar\">\n                            <div>\n                                <i class=\"fas fa-users me-2\"></i>Responsável\n                            </div>\n                            <small class=\"text-muted\">Carga de trabalho</small>\n                        </div>\n                        <div class=\"timeline-dates-wrapper\"> <div class=\"timeline-dates\" id=\"timelineDates\">\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class=\"timeline-body\">\n                        <div class=\"timeline-rows\" id=\"timelineRows\">\n                            </div>\n                        <div class=\"timeline-grid-wrapper\"> <div class=\"timeline-grid\" id=\"timelineGrid\">\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class=\"empty-state\" id=\"emptyState\" style=\"display: none;\">\n                        <i class=\"fas fa-calendar-times\"></i>\n                        <h4>Nenhuma tarefa encontrada</h4>\n                        <p>Não há tarefas para exibir com os filtros selecionados.<br>Tente ajustar os filtros ou navegar para outro período.</p>\n                        <button class=\"btn btn-primary mt-3\" onclick=\"clearFilters()\">\n                            <i class=\"fas fa-filter me-2\"></i>Limpar Filtros\n                        </button>\n                    </div>\n                </div>\n\n                <div class=\"loading\" id=\"loadingState\" style=\"display: none;\">\n                    <div class=\"spinner\"></div>\n                    <div class=\"loading-text\">Carregando timeline...</div>\n                </div>\n            </div>\n        </main>\n\n        <div class=\"sidebar-overlay\" id=\"sidebarOverlay\"></div>\n    </div>\n\n    <div class=\"task-tooltip\" id=\"taskTooltip\">\n        <h6></h6>\n        \n        <div class=\"tooltip-section\">\n            <h6>Projeto</h6>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Projeto:</span>\n                <span class=\"tooltip-value\" id=\"tooltipProject\"></span>\n            </div>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Cliente:</span>\n                <span class=\"tooltip-value\" id=\"tooltipClient\"></span>\n            </div>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Responsável:</span>\n                <span class=\"tooltip-value\" id=\"tooltipResponsible\"></span>\n            </div>\n        </div>\n        \n        <div class=\"tooltip-section\">\n            <h6>Status & Cronograma</h6>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Status:</span>\n                <span class=\"tooltip-value\"><span class=\"tooltip-status\" id=\"tooltipStatus\"></span></span>\n            </div>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Período:</span>\n                <span class=\"tooltip-value\" id=\"tooltipPeriod\"></span>\n            </div>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Progresso:</span>\n                <span class=\"tooltip-value\" id=\"tooltipProgress\">0%</span>\n            </div>\n            <div class=\"tooltip-progress-bar\">\n                <div class=\"tooltip-progress-fill\" id=\"tooltipProgressBar\"></div>\n            </div>\n        </div>\n        \n        <div class=\"tooltip-section\">\n            <h6>Horas & Desempenho</h6>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Estimadas:</span>\n                <span class=\"tooltip-value\" id=\"tooltipEstimated\"></span>\n            </div>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Realizadas:</span>\n                <span class=\"tooltip-value\" id=\"tooltipActual\"></span>\n            </div>\n            <div class=\"tooltip-row\">\n                <span class=\"tooltip-label\">Desvio:</span>\n                <span class=\"tooltip-value\" id=\"tooltipDeviation\"></span>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"https://code.jquery.com/jquery-3.6.0.min.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n\n    <script>\n        // =================================================================\n        // SCRIPT FOCADO EM AUTENTICAÇÃO E RENDERIZAÇÃO DO MENU\n        // =================================================================\n\n        // --- GLOBAL CONFIGURATION ---\n        const LOGIN_URL = '{{ $json.dominio }}/webhook/login';\n        const WEBHOOK_GET_URL = '{{ $json.dominio }}/webhook/consultadadosresolv';\n        const WEBHOOK_URL = '{{ $json.dominio }}/webhook/salvatarefas';\n        const COLABORADORES_WEBHOOK_URL = '{{ $json.dominio }}/webhook/consultacolaboradores';\n        const THEME_URL = '{{ $json.dominio }}/webhook/consultaconfiguracoes';\n\n        // --- SAFE STORAGE FOR SANDBOXED IFRAMES ---\n        const SafeStorage = (() => {\n            let memoryStorage = {};\n            let isLocalStorageAvailable = false;\n\n            try {\n                const test = '__storage_test__';\n                localStorage.setItem(test, test);\n                localStorage.removeItem(test);\n                isLocalStorageAvailable = true;\n            } catch (e) {\n                isLocalStorageAvailable = false;\n                console.warn('⚠️ localStorage não disponível, usando armazenamento via window.name');\n                \n                if (window.name) {\n                    try {\n                        memoryStorage = JSON.parse(window.name);\n                    } catch (e) {\n                        memoryStorage = {};\n                    }\n                }\n                \n                const urlParams = new URLSearchParams(window.location.search);\n                if (urlParams.has('session')) {\n                    try {\n                        const sessionData = JSON.parse(atob(urlParams.get('session')));\n                        memoryStorage['authToken'] = sessionData.token;\n                        memoryStorage['userSession'] = JSON.stringify(sessionData);\n                        window.name = JSON.stringify(memoryStorage);\n                    } catch (e) {\n                        console.error('Erro ao processar sessão da URL:', e);\n                    }\n                }\n            }\n\n            return {\n                getItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        return localStorage.getItem(key);\n                    }\n                    return memoryStorage[key] || null;\n                },\n                setItem: (key, value) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.setItem(key, value);\n                    } else {\n                        memoryStorage[key] = value;\n                        window.name = JSON.stringify(memoryStorage);\n                    }\n                },\n                removeItem: (key) => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.removeItem(key);\n                    } else {\n                        delete memoryStorage[key];\n                        window.name = JSON.stringify(memoryStorage);\n                    }\n                },\n                clear: () => {\n                    if (isLocalStorageAvailable) {\n                        localStorage.clear();\n                    } else {\n                        memoryStorage = {};\n                        window.name = '';\n                    }\n                }\n            };\n        })();\n        \n        // --- AUTHENTICATION AND SESSION FUNCTIONS ---\n        const Auth = {\n            getUserData: () => {\n                const sessionData = SafeStorage.getItem('userSession');\n                return sessionData ? JSON.parse(sessionData) : null;\n            },\n            checkAuth: () => {\n                const authToken = SafeStorage.getItem('authToken');\n                const userData = Auth.getUserData();\n                console.log('🔐 Verificando status de login...', { hasToken: !!authToken, hasData: !!userData });\n                return !!(authToken && userData);\n            },\n            logout: () => {\n                console.log('🚪 Iniciando processo de logout...');\n                SafeStorage.clear();\n                \n                const authLoadingEl = document.getElementById('authLoading');\n                if (authLoadingEl) {\n                    authLoadingEl.style.display = 'flex';\n                    authLoadingEl.innerHTML = `<div class=\"spinner-auth\"></div><h4>Sessão encerrada</h4><p>Você será redirecionado.</p>`;\n                }\n                document.getElementById('appContainer').style.opacity = 0;\n                setTimeout(() => { window.location.href = LOGIN_URL; }, 1500);\n            },\n            redirectToLogin: () => {\n                console.log('🔄 Redirecionando para página de login...');\n                window.location.href = LOGIN_URL;\n            }\n        };\n\n        // --- UI MANIPULATION FUNCTIONS ---\n        const UI = {\n            updateUserInfo: () => {\n                const userData = Auth.getUserData();\n                if (userData) {\n                    document.getElementById('userNameDisplay').textContent = userData.nome;\n                    console.log('👤 Informações do usuário atualizadas:', userData.nome);\n                }\n            },\n            showAuthenticatedInterface: () => {\n                document.getElementById('authLoading').style.display = 'none';\n                document.getElementById('appContainer').classList.add('authenticated');\n                console.log('🎉 Interface principal ativada.');\n            },\n            applyUIPermissions: () => {\n                const userData = Auth.getUserData();\n                const userType = userData?.tipo || 'colaborador';\n                console.log(`🔧 Aplicando permissões de UI para o tipo: ${userType}`);\n\n                document.getElementById('sidebarLoading').style.display = 'none';\n                \n                const menuPermissions = {\n                    admin: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'],\n                    colaborador: ['dashboard', 'tasks', 'hours', 'settings']\n                };\n                const allowedMenus = menuPermissions[userType] || menuPermissions.colaborador;\n\n                document.querySelectorAll('#sidebarMenu .menu-item').forEach((item, index) => {\n                    const menuType = item.getAttribute('data-menu');\n                    if (allowedMenus.includes(menuType)) {\n                        setTimeout(() => item.classList.add('show'), index * 50);\n                    }\n                });\n\n                if (!SafeStorage.getItem('welcomeMessageShown')) {\n                    setTimeout(() => {\n                        const userName = userData?.nome || \"Usuário\";\n                        const message = userType === 'admin' ? `🔑 Bem-vindo(a), ${userName}! Acesso de Administrador.` : `👋 Bem-vindo(a), ${userName}!`;\n                        UI.showNotification(message, userType === 'admin' ? 'success' : 'info');\n                        SafeStorage.setItem('welcomeMessageShown', 'true');\n                    }, 500);\n                }\n            },\n            showNotification: (message, type = 'info') => {\n                const container = document.body;\n                const alertType = type === 'error' ? 'danger' : type;\n                const iconMap = { success: 'check-circle', warning: 'exclamation-triangle', danger: 'times-circle', info: 'info-circle' };\n                const icon = iconMap[type] || 'info-circle';\n                const notification = document.createElement('div');\n                notification.className = `alert alert-${alertType} alert-dismissible fade show shadow-lg`;\n                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';\n                notification.innerHTML = `<i class=\"fas fa-${icon} me-2\"></i> ${message} <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>`;\n                container.appendChild(notification);\n                setTimeout(() => bootstrap.Alert.getOrCreateInstance(notification)?.close(), 5000);\n            },\n            toggleSidebar: () => {\n                const sidebar = document.getElementById('sidebar');\n                const overlay = document.getElementById('sidebarOverlay');\n                if (window.innerWidth <= 768) {\n                    sidebar.classList.toggle('show');\n                    overlay.classList.toggle('show');\n                    document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';\n                } else {\n                    document.getElementById('sidebar').classList.toggle('collapsed');\n                    document.getElementById('mainContent').classList.toggle('expanded');\n                }\n            }\n        };\n        \n        // --- INITIALIZATION AND EVENT LISTENERS ---\n        const App = {\n            initialize: async () => {\n                console.log('🚀 Iniciando ResolvTask Dashboard...');\n                if (!Auth.checkAuth()) {\n                    Auth.redirectToLogin();\n                    return;\n                }\n                \n                UI.showAuthenticatedInterface();\n                UI.updateUserInfo();\n                App.setupEventListeners();\n                \n                try {\n                    await loadAndApplyThemeColor();\n                    UI.applyUIPermissions();\n                    await loadTasks();\n                    console.log('✅ Aplicação inicializada com sucesso.');\n                } catch (error) {\n                    console.error('❌ Erro fatal durante a inicialização:', error);\n                    UI.showNotification('❌ Erro crítico ao carregar o sistema.', 'error');\n                }\n            },\n            setupEventListeners: () => {\n                document.getElementById('logoutButton').addEventListener('click', Auth.logout);\n                document.getElementById('sidebarToggle').addEventListener('click', UI.toggleSidebar);\n                document.getElementById('sidebarOverlay').addEventListener('click', UI.toggleSidebar);\n                \n                const datesWrapper = document.querySelector('.timeline-dates-wrapper');\n                const gridWrapper = document.querySelector('.timeline-grid-wrapper');\n                const rowsContainer = document.getElementById('timelineRows');\n\n                datesWrapper?.addEventListener('scroll', () => syncHorizontalScroll(datesWrapper, gridWrapper));\n                gridWrapper?.addEventListener('scroll', () => {\n                    syncHorizontalScroll(gridWrapper, datesWrapper);\n                    syncVerticalScroll(gridWrapper, rowsContainer);\n                });\n                rowsContainer?.addEventListener('scroll', () => syncVerticalScroll(rowsContainer, gridWrapper));\n            }\n        };\n\n        // ===================================\n        // FUNÇÕES DE TEMA DINÂMICO\n        // ===================================\n        function hexToRgb(hex) {\n            const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;\n        }\n\n        function darkenColor(hex, percent) {\n            const rgb = hexToRgb(hex);\n            if (!rgb) return hex;\n            let { r, g, b } = rgb;\n            r = Math.floor(r * (100 - percent) / 100);\n            g = Math.floor(g * (100 - percent) / 100);\n            b = Math.floor(b * (100 - percent) / 100);\n            r = (r < 255) ? r : 255; g = (g < 255) ? g : 255; b = (b < 255) ? b : 255;\n            const toHex = c => (\"0\" + c.toString(16)).slice(-2);\n            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;\n        }\n\n        async function loadAndApplyThemeColor() {\n            try {\n                const response = await fetch(THEME_URL);\n                if (!response.ok) throw new Error(`Falha ao buscar tema: ${response.statusText}`);\n                const data = await response.json();\n                if (data && data[0] && data[0].primary_color) {\n                    const primaryColor = data[0].primary_color;\n                    const darkPrimaryColor = darkenColor(primaryColor, 15);\n                    const primaryRgb = hexToRgb(primaryColor);\n                    const root = document.documentElement;\n                    root.style.setProperty('--primary-color', primaryColor);\n                    root.style.setProperty('--primary-color-dark', darkPrimaryColor);\n                    if (primaryRgb) {\n                        root.style.setProperty('--primary-color-shadow', `rgba(${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}, 0.3)`);\n                    }\n                }\n            } catch (error) {\n                console.error('❌ Erro ao carregar o tema:', error);\n            }\n        }\n        \n        // ===================================\n        // FUNÇÕES UTILITÁRIAS\n        // ===================================\n        function showCurrentDate() {\n            const now = new Date();\n            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n            document.getElementById('currentDate').textContent = now.toLocaleDateString('pt-BR', options);\n        }\n\n        function createSafeDate(dateStr) {\n            if (!dateStr || typeof dateStr !== 'string') return new Date();\n            const [year, month, day] = dateStr.split('-').map(Number);\n            return new Date(year, month - 1, day);\n        };\n\n        function formatDate(date) {\n            if (!date || isNaN(date.getTime())) return 'N/A';\n            return date.toLocaleDateString('pt-BR', {timeZone: 'UTC'});\n        }\n\n        function getWeekStart(date) { const d = new Date(date); d.setDate(d.getDate() - d.getDay()); return d; }\n        function getMonthStart(date) { return new Date(date.getFullYear(), date.getMonth(), 1); }\n        function addDays(date, days) { const result = new Date(date); result.setDate(result.getDate() + days); return result; }\n        function addMonths(date, months) { const result = new Date(date); result.setMonth(result.getMonth() + months); return result; }\n        function isWeekend(date) { const day = date.getDay(); return day === 0 || day === 6; }\n        \n        // ===================================\n        // NOVAS FUNÇÕES DE COR E DATA (LÓGICA ATUALIZADA)\n        // ===================================\n\n        // NOVO: Função para normalizar os dados da tarefa para um padrão consistente\n        function normalizeTask(task) {\n            return {\n                id: task.id,\n                type: task.type,\n                description: task.description,\n                status: task.status,\n                project: task.project,\n                client: task.client,\n                company: task.company,\n                responsible: task.responsible,\n                // Normaliza campos que podem ter nomes diferentes (maiúsculas/minúsculas)\n                startDate: task.startDate || task.startdate,\n                endDate: task.EndDate || task.endDate || task.enddate,\n                estimatedHours: task.estimatedHours || task.estimatedhours,\n                actualHours: task.actualHours || task.actualhours,\n                deviation: task.deviation,\n                completionDate: task.completionDate || task.completiondate,\n                hora_quebrada_1: task.hora_quebrada_1,\n                hora_quebrada_2: task.Hora_quebrada_2 || task.hora_quebrada_2, // Trata o 'H' maiúsculo\n                aguadando_aprovacao: task.aguadando_aprovacao,\n                motivo_recusa: task.motivo_recusa\n            };\n        }\n        \n        const companyColorPalette = ['#6f42c1', '#d63384', '#fd7e14', '#20c997', '#0dcaf0', '#e74c3c', '#3498db', '#9b59b6', '#e67e22', '#1abc9c', '#34495e', '#f1c40f', '#2ecc71', '#d35400', '#8e44ad', '#16a085'];\n        let companyColorCache = {};\n        let nextColorIndex = 0;\n\n        function getCompanyColor(companyName) {\n            if (!companyName) return { primary: '#6c757d', dark: '#5a6268' };\n            if (companyColorCache[companyName]) return companyColorCache[companyName];\n            \n            const primary = companyColorPalette[nextColorIndex % companyColorPalette.length];\n            const dark = darkenColor(primary, 15);\n            const color = { primary, dark };\n            companyColorCache[companyName] = color;\n            nextColorIndex++;\n            return color;\n        }\n\n        function parseHoraQuebrada(hqString) {\n            if (!hqString || typeof hqString !== 'string' || !hqString.includes(',')) return null;\n            const [dateStr, hoursStr] = hqString.split(',');\n            const hours = parseFloat(hoursStr);\n            if (isNaN(hours) || !/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr.trim())) return null;\n            const date = createSafeDate(dateStr.trim());\n            if (isNaN(date.getTime())) return null;\n            return { date, hours };\n        }\n        \n        function deconstructTask(task) {\n            const virtualTasks = [];\n            const hq1 = parseHoraQuebrada(task.hora_quebrada_1);\n            const hq2 = parseHoraQuebrada(task.hora_quebrada_2);\n\n            if (hq1) {\n                virtualTasks.push({ type: 'hora_quebrada', startDate: hq1.date, endDate: hq1.date, hours: hq1.hours, originalTask: task });\n            }\n            if (hq2) {\n                virtualTasks.push({ type: 'hora_quebrada', startDate: hq2.date, endDate: hq2.date, hours: hq2.hours, originalTask: task });\n            }\n\n            if (virtualTasks.length === 0) {\n                const startDate = task.startDate ? createSafeDate(task.startDate) : new Date();\n                const endDate = task.endDate ? createSafeDate(task.endDate) : startDate;\n                virtualTasks.push({ type: 'standard', startDate, endDate, hours: parseFloat(task.estimatedHours || 0), originalTask: task });\n            }\n            return virtualTasks;\n        }\n\n        function getStatusClass(status) {\n            if (!status) return 'desconhecido';\n            return status.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');\n        }\n\n        function getResponsibleColor(responsible) { return '#6f42c1'; }\n        function getResponsibleInitials(name) { if (!name) return ''; return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase(); }\n        \n        function parseResponsible(responsibleString) { \n            const name = (responsibleString || '').trim(); \n            return { name, initials: getResponsibleInitials(name) }; \n        }\n\n        function calculateTaskProgress(task) {\n            const virtualTasks = deconstructTask(task);\n            const startDate = virtualTasks[0].startDate; \n            const endDate = virtualTasks[virtualTasks.length - 1].endDate; \n            const today = new Date();\n            today.setHours(0, 0, 0, 0);\n\n            if (task.status === 'CONCLUÍDO') return 100;\n            if (today >= endDate) return 100;\n            if (today < startDate || task.status === 'NÃO INICIADO') return 0;\n            \n            const totalDuration = endDate.getTime() - startDate.getTime();\n            if (totalDuration <= 0) return 0;\n\n            const elapsedDuration = today.getTime() - startDate.getTime();\n            return Math.min(100, Math.max(0, (elapsedDuration / totalDuration) * 100));\n        }\n\n        // ===================================\n        // FUNÇÕES DE NAVEGAÇÃO DA TIMELINE\n        // ===================================\n        function updateCurrentPeriodDisplay() {\n            const periodEl = document.getElementById('currentPeriod');\n            if (!periodEl) return;\n            \n            const options = { year: 'numeric', month: 'long', day: 'numeric' };\n            \n            switch (currentView) {\n                case 'week':\n                    const weekStart = getWeekStart(currentStartDate);\n                    const weekEnd = addDays(weekStart, 6);\n                    periodEl.textContent = `${weekStart.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })}`;\n                    break;\n                case 'month':\n                    periodEl.textContent = currentStartDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });\n                    break;\n                case 'quarter':\n                    const quarter = Math.floor(currentStartDate.getMonth() / 3) + 1;\n                    periodEl.textContent = `Q${quarter} ${currentStartDate.getFullYear()}`;\n                    break;\n            }\n        }\n\n        function debugWebhook() { \n            UI.showNotification('🔌 Testando conexão com o servidor...', 'info');\n            setTimeout(() => {\n                UI.showNotification('✅ Conexão com o servidor está funcionando corretamente!', 'success');\n            }, 1000);\n        }\n\n        function reloadColaboradores() { \n            UI.showNotification('🔄 Recarregando lista de colaboradores...', 'info');\n            setTimeout(() => {\n                UI.showNotification('✅ Lista de colaboradores atualizada!', 'success');\n            }, 1000);\n        }\n\n        function refreshCurrentPage() { \n            loadTasks();\n            UI.showNotification('🔄 Página atualizada!', 'info');\n        }\n\n        function navigateTimeline(direction) {\n            switch (currentView) {\n                case 'week': currentStartDate = addDays(currentStartDate, direction * 7); break;\n                case 'month': currentStartDate = addMonths(currentStartDate, direction); break;\n                case 'quarter': currentStartDate = addMonths(currentStartDate, direction * 3); break;\n            }\n            updateCurrentPeriodDisplay();\n            generateTimeline();\n        }\n\n        function goToToday() {\n            currentStartDate = new Date();\n            updateCurrentPeriodDisplay();\n            generateTimeline();\n        }\n\n        // ===================================\n        // CARREGAMENTO E FILTROS\n        // ===================================\n        let tasks = [];\n        let colaboradores = [];\n        let filteredTasks = [];\n        let currentView = 'month';\n        let currentStartDate = new Date();\n\n        async function loadTasks() {\n            try {\n                UI.showNotification('🔄 Carregando dados do servidor...', 'info');\n                const response = await fetch(WEBHOOK_GET_URL);\n                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n                const allTasksRaw = await response.json();\n                \n                // CORREÇÃO: Normalizar os dados e depois filtrar os cancelados\n                tasks = allTasksRaw\n                    .map(normalizeTask)\n                    .filter(task => task.aguadando_aprovacao !== 'canceled');\n\n                UI.showNotification(`✅ ${tasks.length} tarefas carregadas!`, 'success');\n                \n                updateFilters();\n                applyUserRoleFilter();\n                applyFilters();\n            } catch (error) {\n                console.error('❌ Erro ao carregar tarefas:', error);\n                UI.showNotification(`❌ Erro ao carregar dados: ${error.message}`, 'error');\n                showEmptyState();\n            }\n        }\n\n        function updateFilters() {\n            if (!tasks || tasks.length === 0) return;\n\n            const responsibleFilter = document.getElementById('responsibleFilter');\n            const projectFilter = document.getElementById('projectFilter');\n            const typeFilter = document.getElementById('typeFilter');\n            const clientFilter = document.getElementById('clientFilter');\n            const companyFilter = document.getElementById('companyFilter');\n\n            const responsibles = [...new Set(tasks.map(t => t.responsible ? parseResponsible(t.responsible).name : null).filter(Boolean))].sort();\n            responsibleFilter.innerHTML = '<option value=\"\">Todos os responsáveis</option>' + responsibles.map(r => `<option value=\"${r}\">${r}</option>`).join('');\n\n            const projects = [...new Set(tasks.map(t => t.project).filter(Boolean))].sort();\n            projectFilter.innerHTML = '<option value=\"\">Todos os projetos</option>' + projects.map(p => `<option value=\"${p}\">${p}</option>`).join('');\n            \n            const clients = [...new Set(tasks.map(t => t.client).filter(Boolean))].sort();\n            clientFilter.innerHTML = '<option value=\"\">Todos os clientes</option>' + clients.map(c => `<option value=\"${c}\">${c}</option>`).join('');\n            \n            const companies = [...new Set(tasks.map(t => t.company).filter(Boolean))].sort();\n            companyFilter.innerHTML = '<option value=\"\">Todas as empresas</option>' + companies.map(c => `<option value=\"${c}\">${c}</option>`).join('');\n\n            const types = [...new Set(tasks.map(t => t.type).filter(Boolean))].sort();\n            typeFilter.innerHTML = '<option value=\"\">Todos os tipos</option>' + types.map(t => `<option value=\"${t}\">${t}</option>`).join('');\n        }\n\n        function applyUserRoleFilter() {\n            const userData = Auth.getUserData();\n            if (!userData) return;\n\n            const userType = (userData.tipo || 'colaborador').toLowerCase();\n            const responsibleFilter = document.getElementById('responsibleFilter');\n\n            if (userType === 'colaborador') {\n                const userName = (userData.nome || '').trim();\n                console.log(`👤 Aplicando filtro para colaborador: ${userName}`);\n                \n                const userOptionExists = [...responsibleFilter.options].some(opt => opt.value === userName);\n\n                if (userOptionExists) {\n                    responsibleFilter.value = userName;\n                    responsibleFilter.disabled = true;\n                } else {\n                    console.warn(`⚠️ Usuário '${userName}' não encontrado na lista de responsáveis. Nenhuma tarefa será exibida.`);\n                    responsibleFilter.value = '';\n                    responsibleFilter.disabled = true;\n                }\n            } else {\n                console.log('👑 Acesso de administrador. Filtro de responsável habilitado.');\n                responsibleFilter.disabled = false;\n            }\n        }\n\n        function applyFilters() {\n            const responsibleFilterValue = document.getElementById('responsibleFilter').value;\n            const projectFilterValue = document.getElementById('projectFilter').value;\n            const clientFilterValue = document.getElementById('clientFilter').value;\n            const companyFilterValue = document.getElementById('companyFilter').value;\n            const statusFilterValue = document.getElementById('statusFilter').value;\n            const typeFilterValue = document.getElementById('typeFilter').value;\n            const startDateFilterValue = document.getElementById('startDateFilter').value;\n            const endDateFilterValue = document.getElementById('endDateFilter').value;\n\n            filteredTasks = tasks.filter(task => {\n                const parsedResponsibleName = task.responsible ? parseResponsible(task.responsible).name : '';\n                const matchResponsible = !responsibleFilterValue || parsedResponsibleName === responsibleFilterValue;\n                const matchProject = !projectFilterValue || task.project === projectFilterValue;\n                const matchClient = !clientFilterValue || task.client === clientFilterValue;\n                const matchCompany = !companyFilterValue || task.company === companyFilterValue;\n                const matchStatus = !statusFilterValue || task.status === statusFilterValue;\n                const matchType = !typeFilterValue || task.type === typeFilterValue;\n                \n                // O código agora usa os nomes de propriedade normalizados (camelCase)\n                const taskStartDate = task.startDate ? createSafeDate(task.startDate) : null;\n                const taskEndDate = task.endDate ? createSafeDate(task.endDate) : taskStartDate;\n                const filterStartDate = startDateFilterValue ? createSafeDate(startDateFilterValue) : null;\n                const filterEndDate = endDateFilterValue ? createSafeDate(endDateFilterValue) : null;\n\n                let matchDates = true;\n                if (filterStartDate && taskEndDate) {\n                    matchDates = matchDates && (taskEndDate >= filterStartDate);\n                }\n                if (filterEndDate && taskStartDate) {\n                    matchDates = matchDates && (taskStartDate <= filterEndDate);\n                }\n                \n                return matchResponsible && matchProject && matchClient && matchCompany && matchStatus && matchType && matchDates;\n            });\n            generateTimeline();\n        }\n\n        function clearFilters() {\n            const userData = Auth.getUserData();\n            const userType = (userData?.tipo || 'colaborador').toLowerCase();\n\n            if (userType === 'admin') {\n                document.getElementById('responsibleFilter').value = '';\n            }\n\n            document.getElementById('projectFilter').value = '';\n            document.getElementById('clientFilter').value = '';\n            document.getElementById('companyFilter').value = '';\n            document.getElementById('statusFilter').value = '';\n            document.getElementById('typeFilter').value = '';\n            document.getElementById('startDateFilter').value = '';\n            document.getElementById('endDateFilter').value = '';\n            applyFilters();\n            UI.showNotification('🔄 Filtros removidos.', 'info');\n        }\n\n        function setView(view) {\n            currentView = view;\n            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));\n            event.currentTarget.classList.add('active');\n            updateCurrentPeriodDisplay();\n            generateTimeline();\n        }\n\n        // ===================================\n        // GERAÇÃO DA TIMELINE - LÓGICA ATUALIZADA\n        // ===================================\n        function showEmptyState() {\n             document.getElementById('emptyState').style.display = 'flex';\n             document.getElementById('timelineRows').innerHTML = '';\n             document.getElementById('timelineGrid').innerHTML = '';\n             document.getElementById('timelineDates').innerHTML = '';\n        }\n        function hideEmptyState() {\n            document.getElementById('emptyState').style.display = 'none';\n        }\n\n        function generateTimeline() {\n            if (filteredTasks.length === 0) { showEmptyState(); return; }\n            hideEmptyState();\n            generateTimelineDates();\n            generateTimelineRows();\n        }\n        \n        function getTimelineViewDates() {\n             let startDate, endDate;\n             switch (currentView) {\n                 case 'week': startDate = getWeekStart(currentStartDate); endDate = addDays(startDate, 6); break;\n                 case 'month': startDate = getMonthStart(currentStartDate); endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0); break;\n                 case 'quarter': startDate = new Date(currentStartDate.getFullYear(), Math.floor(currentStartDate.getMonth() / 3) * 3, 1); endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 3, 0); break;\n             }\n             return { startDate, endDate };\n        }\n\n        function generateTimelineDates() {\n            const datesContainer = document.getElementById('timelineDates');\n            datesContainer.innerHTML = '';\n            const { startDate, endDate } = getTimelineViewDates();\n            const dayIncrement = currentView === 'quarter' ? 7 : 1;\n            const today = new Date();\n            today.setHours(0, 0, 0, 0);\n\n            for (let date = new Date(startDate); date <= endDate; date = addDays(date, dayIncrement)) {\n                const dateCol = document.createElement('div');\n                dateCol.className = 'date-column slide-in-right';\n                \n                const d1 = new Date(date); d1.setHours(0,0,0,0);\n                const d2 = new Date(today); d2.setHours(0,0,0,0);\n                if (d1.getTime() === d2.getTime()) {\n                    dateCol.classList.add('today');\n                }\n\n                if (isWeekend(date) && currentView !== 'quarter') dateCol.classList.add('weekend');\n\n                if (currentView === 'quarter') {\n                    const weekNum = Math.ceil(((date - startDate) / (1000 * 60 * 60 * 24)) / 7) + 1;\n                    dateCol.innerHTML = `<div class=\"date-weekday\">SEM ${weekNum}</div><div class=\"date-day\">${date.getDate()}</div><div class=\"date-month\">${date.toLocaleDateString('pt-BR', { month: 'short' })}</div>`;\n                } else {\n                    dateCol.innerHTML = `<div class=\"date-weekday\">${date.toLocaleDateString('pt-BR', { weekday: 'short' })}</div><div class=\"date-day\">${date.getDate()}</div><div class=\"date-month\">${date.toLocaleDateString('pt-BR', { month: 'short' })}</div>`;\n                }\n                datesContainer.appendChild(dateCol);\n            }\n        }\n\n        function generateTimelineRows() {\n            const rowsContainer = document.getElementById('timelineRows');\n            const gridContainer = document.getElementById('timelineGrid');\n            rowsContainer.innerHTML = ''; gridContainer.innerHTML = '';\n\n            const viewDates = getTimelineViewDates();\n            if (!viewDates || !viewDates.startDate) {\n                console.error(\"Datas da timeline não puderam ser determinadas. Abortando renderização.\");\n                showEmptyState();\n                return;\n            }\n            const { startDate: timelineStart, endDate: timelineEnd } = viewDates;\n            const dayIncrement = currentView === 'quarter' ? 7 : 1;\n\n            const tasksByResponsibleName = {};\n            filteredTasks.forEach(task => {\n                const nameKey = (task.responsible && parseResponsible(task.responsible).name) || 'Não atribuído';\n                if (!tasksByResponsibleName[nameKey]) tasksByResponsibleName[nameKey] = [];\n                tasksByResponsibleName[nameKey].push(task);\n            });\n\n            if (Object.keys(tasksByResponsibleName).length === 0) { showEmptyState(); return; }\n\n            const responsibleNames = Object.keys(tasksByResponsibleName).sort();\n            responsibleNames.forEach((responsibleName, index) => {\n                const responsibleTasks = tasksByResponsibleName[responsibleName];\n                if (index > 0) {\n                    rowsContainer.appendChild(document.createElement('div')).className = 'timeline-row-separator';\n                    gridContainer.appendChild(document.createElement('div')).className = 'timeline-grid-separator';\n                }\n\n                // O código agora usa os nomes de propriedade normalizados (camelCase)\n                const totalEstimatedHours = responsibleTasks.reduce((sum, t) => sum + parseFloat(t.estimatedHours || 0), 0);\n                const totalActualHours = responsibleTasks.reduce((sum, t) => sum + parseFloat(t.actualHours || 0), 0);\n                const totalDeviation = responsibleTasks.reduce((sum, t) => sum + parseFloat(t.deviation || 0), 0);\n                \n                const rowHeader = document.createElement('div');\n                rowHeader.className = 'row-header fade-in';\n                rowHeader.innerHTML = `\n                    <div class=\"responsible-avatar\" style=\"background-color: ${getResponsibleColor(responsibleName)}\">${getResponsibleInitials(responsibleName)}</div>\n                    <div class=\"responsible-info\">\n                        <h6>${responsibleName}</h6>\n                        <small>Total de ${responsibleTasks.length} tarefa(s)</small>\n                        <div class=\"responsible-summary-stats mt-2\">\n                            <div>Estimadas: <span class=\"text-primary\">${totalEstimatedHours.toFixed(1)}h</span></div>\n                            <div>Realizadas: <span class=\"text-dark\">${totalActualHours.toFixed(1)}h</span></div>\n                            <div>Desvio: <span class=\"${totalDeviation > 0 ? 'text-danger' : totalDeviation < 0 ? 'text-success' : 'text-muted'}\">${totalDeviation >= 0 ? '+' : ''}${totalDeviation.toFixed(1)}h</span></div>\n                        </div>\n                    </div>\n                `;\n                rowsContainer.appendChild(rowHeader);\n                \n                const rowContent = document.createElement('div');\n                rowContent.className = 'row-content';\n                const columnCount = Math.ceil((timelineEnd - timelineStart) / (1000 * 60 * 60 * 24 * dayIncrement)) + 1;\n                for (let i = 0; i < columnCount; i++) rowContent.appendChild(document.createElement('div')).className = 'time-column';\n\n                const taskLevels = [];\n                responsibleTasks.forEach(task => {\n                    const virtualTasks = deconstructTask(task);\n                    virtualTasks.forEach(vTask => {\n                        if (vTask.startDate <= timelineEnd && vTask.endDate >= timelineStart) {\n                            const level = findAvailableLevel(taskLevels, vTask.startDate, vTask.endDate);\n                            const taskBar = createIndividualTaskBar(vTask, timelineStart, dayIncrement, level);\n                            rowContent.appendChild(taskBar);\n                        }\n                    });\n                });\n                gridContainer.appendChild(rowContent);\n            });\n        }\n        \n        function findAvailableLevel(levels, taskStart, taskEnd) {\n            let level = 0;\n            const taskEndBoundary = addDays(taskEnd, 1);\n            while (true) {\n                if (!levels[level]) {\n                    levels[level] = [];\n                    break;\n                }\n                const hasConflict = levels[level].some(existingTask => (taskStart < existingTask.end && taskEndBoundary > existingTask.start));\n                if (!hasConflict) break;\n                level++;\n            }\n            levels[level].push({ start: taskStart, end: taskEndBoundary });\n            return level;\n        }\n\n        function createIndividualTaskBar(vTask, timelineStart, dayIncrement, level) {\n            const task = vTask.originalTask;\n            const pixelsPerColumn = 180;\n            const startOffsetDays = (vTask.startDate.getTime() - timelineStart.getTime()) / (1000 * 60 * 60 * 24);\n            const durationDays = Math.max(1, (vTask.endDate.getTime() - vTask.startDate.getTime()) / (1000 * 60 * 60 * 24) + 1);\n\n            const left = (startOffsetDays / dayIncrement) * pixelsPerColumn;\n            const width = (durationDays / dayIncrement) * pixelsPerColumn - 5;\n            \n            const top = 10 + (level * 55); \n\n            const taskBar = document.createElement('div');\n            taskBar.className = `task-bar status-${getStatusClass(task.status)}`;\n            taskBar.style.left = `${left}px`;\n            taskBar.style.width = `${Math.max(width, 30)}px`;\n            taskBar.style.top = `${top}px`;\n            \n            const companyColor = getCompanyColor(task.company);\n            taskBar.style.background = `linear-gradient(135deg, ${companyColor.primary} 0%, ${companyColor.dark} 100%)`;\n            \n            taskBar.innerHTML = `\n                <div class=\"task-info-line\"><span class=\"task-description\">${task.description || 'Tarefa'}</span></div>\n                <div class=\"task-info-line\"><div class=\"task-hours-info\"><span>${vTask.hours.toFixed(1)}h</span></div></div>\n                <div class=\"task-progress\" style=\"width: ${calculateTaskProgress(task)}%;\"></div>\n            `;\n            \n            taskBar.addEventListener('mouseenter', (e) => showTooltip(e, task, vTask));\n            taskBar.addEventListener('mouseleave', hideTooltip);\n            taskBar.addEventListener('mousemove', (e) => updateTooltipPosition(e));\n            return taskBar;\n        }\n\n        // ===================================\n        // TOOLTIP E INTERAÇÕES\n        // ===================================\n        function showTooltip(event, originalTask, vTask) {\n            const tooltip = document.getElementById('taskTooltip');\n            const task = originalTask;\n            \n            tooltip.querySelector('h6').textContent = task.description || 'Sem descrição';\n            \n            document.getElementById('tooltipProject').textContent = task.project || 'N/A';\n            document.getElementById('tooltipClient').textContent = task.client || 'N/A';\n            document.getElementById('tooltipResponsible').textContent = task.responsible || 'N/A';\n            \n            const statusEl = document.getElementById('tooltipStatus');\n            statusEl.textContent = task.status || 'N/A';\n            statusEl.className = `tooltip-status status-${getStatusClass(task.status || '')}`;\n            \n            document.getElementById('tooltipPeriod').textContent = `${formatDate(vTask.startDate)} - ${formatDate(vTask.endDate)}`;\n            \n            const progress = calculateTaskProgress(task);\n            document.getElementById('tooltipProgress').textContent = `${progress.toFixed(0)}%`;\n            document.getElementById('tooltipProgressBar').style.width = `${progress}%`;\n            \n            document.getElementById('tooltipEstimated').textContent = `${vTask.hours.toFixed(1)}h`;\n            // O código agora usa o nome de propriedade normalizado (camelCase)\n            document.getElementById('tooltipActual').textContent = `${parseFloat(task.actualHours || 0).toFixed(1)}h`;\n            \n            const deviation = parseFloat(task.deviation || 0);\n            const deviationEl = document.getElementById('tooltipDeviation');\n            deviationEl.textContent = `${deviation >= 0 ? '+' : ''}${deviation.toFixed(1)}h`;\n            deviationEl.style.color = deviation > 0 ? 'var(--danger-color)' : deviation < 0 ? 'var(--success-color)' : 'var(--secondary-color)';\n            \n            tooltip.style.display = 'block';\n            updateTooltipPosition(event);\n        }\n\n        function hideTooltip() { document.getElementById('taskTooltip').style.display = 'none'; }\n        function updateTooltipPosition(event) {\n             const tooltip = document.getElementById('taskTooltip');\n             const offset = 15;\n             let x = event.pageX + offset;\n             let y = event.pageY + offset;\n\n             if (x + tooltip.offsetWidth > window.innerWidth) {\n                 x = event.pageX - tooltip.offsetWidth - offset;\n             }\n             if (y + tooltip.offsetHeight > window.innerHeight) {\n                 y = event.pageY - tooltip.offsetHeight - offset;\n             }\n\n             tooltip.style.left = `${x}px`;\n             tooltip.style.top = `${y}px`;\n        }\n\n        // ===================================\n        // SCROLL SYNC FUNCTIONS\n        // ===================================\n        function syncHorizontalScroll(scrollingElement, targetElement) { \n            if(targetElement && scrollingElement) targetElement.scrollLeft = scrollingElement.scrollLeft; \n        }\n        \n        function syncVerticalScroll(scrollingElement, targetElement) { \n            if(targetElement && scrollingElement) targetElement.scrollTop = scrollingElement.scrollTop; \n        }\n\n        // ===================================\n        // INICIALIZAÇÃO\n        // ===================================\n        document.addEventListener('DOMContentLoaded', async function() {\n            await App.initialize();\n            \n            // Auto-refresh a cada 5 minutos\n            setInterval(() => {\n                console.log('🔄 Auto-refresh da timeline...');\n                loadTasks();\n            }, 300000);\n        });\n    </script>\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -1904,
        2816
      ],
      "id": "951c19be-ca04-4766-835e-c8d4236a77d6",
      "name": "Timeline HTML2"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "type",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2464,
        4992
      ],
      "id": "d73d0006-0ad9-421f-98dd-76c7e50bb73f",
      "name": "Consula Task",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "empresas_prestadoras",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2496,
        5296
      ],
      "id": "4700cff9-7dd4-4a5c-bd12-201c4bb1cf7e",
      "name": "Consulta Empresas1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      },
      "notes": "convite"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "colaboradores",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2496,
        5632
      ],
      "id": "5e54743d-6ca5-416c-b45f-a1d533b1ff17",
      "name": "Consulta colaboladores",
      "credentials": {
        "supabaseApi": {
          "id": "9PYo9Bf3vynmdT7h",
          "name": "ResolTask"
        }
      }
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Resolv Task - Gestão de Clientes</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <style>\n        :root {\n            --primary-color: #0d6efd; /* Cor padrão que será substituída */\n            --secondary-color: #6c757d;\n            --success-color: #198754;\n            --danger-color: #dc3545;\n            --warning-color: #ffc107;\n            --info-color: #0dcaf0;\n            --light-color: #f8f9fa;\n            --dark-color: #212529;\n            --light-bg: #F8F9FA;\n            --dark-text: #333333;\n        }\n        \n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            margin: 0;\n            overflow-x: hidden;\n            background-color: var(--light-bg);\n            color: var(--dark-text);\n        }\n\n        /* Auth Loading Screen */\n        .auth-loading {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            color: white;\n            transition: opacity 0.5s ease;\n        }\n        .auth-loading .spinner-auth {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(255, 255, 255, 0.3);\n            border-top: 4px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        .app-container {\n            opacity: 0;\n            transition: opacity 0.5s ease;\n        }\n        .app-container.authenticated {\n            opacity: 1;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            height: 100vh;\n            width: 280px;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            position: fixed;\n            left: 0;\n            top: 0;\n            transition: transform 0.3s ease, background 0.5s ease;\n            z-index: 1000;\n            overflow-y: auto;\n            display: flex;\n            flex-direction: column;\n        }\n        \n        .sidebar.collapsed {\n            transform: translateX(-100%);\n        }\n        \n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            background-color: white;\n            border-bottom: 1px solid #dee2e6;\n        }\n        .sidebar-header .logo {\n            max-width: 150px;\n            height: auto;\n            margin-bottom: 10px;\n        }\n        .sidebar-header .text-light {\n            color: var(--dark-color) !important;\n            font-weight: 500;\n        }\n        \n        .sidebar-menu {\n            padding: 20px 0;\n            flex-grow: 1;\n        }\n        \n        .menu-item {\n            display: block;\n            padding: 15px 25px;\n            color: rgba(255,255,255,0.8);\n            text-decoration: none;\n            transition: all 0.3s ease;\n            border: none;\n            background: none;\n            width: 100%;\n            text-align: left;\n            cursor: pointer;\n        }\n        \n        .menu-item:hover,\n        .menu-item.active {\n            background-color: rgba(255,255,255,0.1);\n            color: white;\n        }\n\n        .menu-item i {\n            width: 20px;\n            margin-right: 15px;\n        }\n\n        /* Ocultar menus inicialmente para evitar flash */\n        .sidebar-menu .menu-item {\n            display: none;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n        .sidebar-menu .menu-item.show {\n            display: block;\n            opacity: 1;\n        }\n\n        /* Loading state da sidebar */\n        .sidebar-loading {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 40px 20px;\n            color: rgba(255, 255, 255, 0.8);\n            font-size: 0.9rem;\n        }\n        .sidebar-loading .spinner-small {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid rgba(255, 255, 255, 0.8);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-right: 10px;\n        }\n\n        /* Main Content */\n        .main-content {\n            margin-left: 280px;\n            transition: margin-left 0.3s ease;\n            min-height: 100vh;\n        }\n        \n        #main-content-wrapper {\n            padding: 20px;\n        }\n\n        /* Top Navigation */\n        .top-nav {\n            background: white;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            padding: 15px 25px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            position: sticky;\n            top: 0;\n            z-index: 999;\n        }\n\n        .sidebar-toggle {\n            display: none;\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n        }\n\n        .user-info {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n        /* Content Area */\n        .content-section {\n            background: white;\n            border-radius: 15px;\n            padding: 30px;\n            margin-bottom: 30px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n        }\n\n        .content-section h3 {\n            color: var(--primary-color);\n            margin-bottom: 25px;\n            padding-bottom: 15px;\n            border-bottom: 2px solid #f0f0f0;\n        }\n\n        /* Client Management App specific styles */\n        .card {\n            border: none;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            transition: transform 0.3s ease;\n            height: 100%;\n        }\n        .card:hover {\n            transform: translateY(-5px);\n        }\n        .stats-card h5 {\n            font-size: 2.5rem;\n            font-weight: bold;\n        }\n        .table thead th {\n            background-color: var(--primary-color);\n            color: white;\n            vertical-align: middle;\n        }\n        .table tbody tr:hover {\n            background-color: rgba(13, 110, 253, 0.1);\n        }\n        .table td {\n            vertical-align: middle;\n        }\n        .badge-status {\n            font-size: 0.85em;\n            padding: 0.5em 0.8em;\n        }\n        .balance-positive {\n            color: var(--success-color);\n            font-weight: bold;\n        }\n        .balance-negative {\n            color: var(--danger-color);\n            font-weight: bold;\n        }\n        .loading-spinner {\n            display: inline-block;\n            width: 20px;\n            height: 20px;\n            border: 3px solid #f3f3f3;\n            border-top: 3px solid var(--primary-color);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n        .detail-card {\n            background-color: #fff;\n            border: 1px solid #e9ecef;\n            padding: 20px;\n            border-radius: 8px;\n            text-align: center;\n        }\n        .detail-card h4 {\n            font-size: 2rem;\n            font-weight: 700;\n            margin: 0;\n        }\n        .detail-card small {\n            color: #6c757d;\n        }\n        .editable-cell input {\n            width: 100%;\n            border: 1px solid transparent;\n            background-color: transparent;\n            text-align: center;\n            padding: 5px;\n            border-radius: 4px;\n        }\n        .editable-cell input:focus {\n            outline: none;\n            border-color: var(--primary-color);\n            background-color: #fff;\n        }\n        .table .editable-cell.changed {\n            background-color: #fff3cd !important;\n        }\n        .table .editable-cell.changed input {\n            color: var(--success-color);\n            font-weight: bold;\n        }\n        .banco-horas-row {\n            background-color: #f8f9fa;\n            font-style: italic;\n            color: #6c757d;\n        }\n        .validation-info {\n            font-size: 0.85em;\n            color: #6c757d;\n            background-color: #f8f9fa;\n            padding: 10px;\n            border-radius: 5px;\n            margin-top: 10px;\n        }\n\n        /* Nested Modal Styles */\n        .nested-modal {\n            z-index: 1065 !important;\n        }\n        .nested-modal .modal-backdrop {\n            z-index: 1064 !important;\n        }\n\n        /* Service Edit Button Styles */\n        .service-edit-btn {\n            border: none;\n            background: transparent;\n            color: var(--primary-color);\n            font-size: 0.8rem;\n            padding: 2px 5px;\n            margin-left: 5px;\n            cursor: pointer;\n            transition: color 0.3s ease;\n        }\n        .service-edit-btn:hover {\n            color: var(--success-color);\n        }\n\n        /* Responsive Design for Sidebar */\n        @media (max-width: 768px) {\n            .sidebar {\n                transform: translateX(-100%);\n                z-index: 1050;\n            }\n            \n            .sidebar.show {\n                transform: translateX(0);\n            }\n            \n            .sidebar-toggle {\n                display: block;\n            }\n            \n            .main-content {\n                margin-left: 0;\n            }\n            \n            /* Overlay para mobile quando sidebar está aberta */\n            .sidebar-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-color: rgba(0, 0, 0, 0.5);\n                z-index: 1040;\n                opacity: 0;\n                visibility: hidden;\n                transition: all 0.3s ease;\n            }\n            \n            .sidebar-overlay.show {\n                opacity: 1;\n                visibility: visible;\n            }\n        }\n\n        /* Collapse Section Styling */\n        .collapse-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            cursor: pointer;\n            padding: 10px 0;\n            border-bottom: 1px solid #e9ecef;\n            margin-bottom: 15px;\n        }\n        .collapse-header:hover {\n            opacity: 0.8;\n        }\n        .collapse-header h3, .collapse-header h5 {\n            margin-bottom: 0;\n        }\n        .collapse-header .toggle-icon {\n            transition: transform 0.3s ease;\n        }\n        .collapse-header .toggle-icon.rotated {\n            transform: rotate(180deg);\n        }\n        /* Ajuste para o header do Acompanhamento Mês a Mês */\n        #collapseMonthlyTracking .card-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding-right: 15px;\n        }\n        #collapseMonthlyTracking .card-header .btn {\n            margin-left: auto;\n        }\n    </style>\n</head>\n<body>\n    <!-- Tela de carregamento exibida durante a verificação de autenticação -->\n    <div class=\"auth-loading\" id=\"authLoading\">\n        <div class=\"spinner-auth\"></div>\n        <h4>ResolvTask</h4>\n        <p>Verificando autenticação...</p>\n    </div>\n\n    <!-- Container principal da aplicação -->\n    <div class=\"app-container\" id=\"appContainer\">\n        <!-- Sidebar Menu -->\n        <nav class=\"sidebar\" id=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <img src=\"https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png\" alt=\"ResolvAI Logo\" class=\"logo\">\n                <br><br>\n                <h1><i class=\"fas fa-bolt me-2\"></i>Task</h1>\n                <small class=\"text-light\">Sistema Integrado de Gestão</small>\n            </div>\n            <div class=\"sidebar-menu\" id=\"sidebarMenu\">\n            <div class=\"sidebar-loading\" id=\"sidebarLoading\">\n                <div class=\"spinner-small\"></div>\n                Carregando menu...\n            </div>\n            <!-- Dashboard - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/resolv'\" data-menu=\"dashboard\">\n                <i class=\"fas fa-chart-line\"></i>Dashboard\n            </button>\n            <!-- Gerenciador de Tarefas - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gerenciadortarefas'\" data-menu=\"tasks\">\n                <i class=\"fas fa-tasks\"></i>Gerenciador de Tarefas\n            </button>\n            <!-- Gerenciador de Horas - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/taskhoras'\" data-menu=\"hours\">\n                <i class=\"fas fa-clock\"></i>Gerenciador de Horas\n            </button>\n            <!-- Gestão de Clientes - Link externo (selecionado por padrão) -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gestao_clientes'\" data-menu=\"clients\">\n                <i class=\"fas fa-handshake\"></i>Gestão de Clientes\n            </button>\n            <!-- Gestão de Parceiros - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gestaodeparceiros'\" data-menu=\"partners\">\n                <i class=\"fas fa-handshake-angle\"></i>Gestão de Parceiros\n            </button>\n            <!-- Equipe - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/equipe'\" data-menu=\"team\">\n                <i class=\"fas fa-users\"></i>Equipe\n            </button>\n            <!-- Configurações - Ação interna (showPage) -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/conf'\" data-menu=\"settings\">\n                <i class=\"fas fa-cog\"></i>Configurações\n            </button>\n            </div>\n        </nav>\n\n        <main class=\"main-content\" id=\"mainContent\">\n            <nav class=\"top-nav\">\n                <div class=\"d-flex align-items-center\">\n                    <button class=\"sidebar-toggle\" id=\"sidebarToggle\">\n                        <i class=\"fas fa-bars\"></i>\n                    </button>\n                    <h5 class=\"mb-0 ms-3\" id=\"mainTitle\">Gestão de Clientes</h5>\n                </div>\n                <div class=\"user-info\">\n                    <div class=\"d-flex align-items-center\">\n                        <i class=\"fas fa-user-circle fs-4 text-primary me-2\"></i>\n                        <span class=\"fw-bold\" id=\"userNameDisplay\">Nome do Usuário</span>\n                    </div>\n                    <button class=\"btn btn-outline-danger btn-sm ms-2\" id=\"logoutButton\" title=\"Sair\">\n                        <i class=\"fas fa-sign-out-alt\"></i>\n                    </button>\n                </div>\n            </nav>\n\n            <div id=\"main-content-wrapper\">\n                <!-- Container para mensagens de feedback -->\n                <div id=\"messageContainer\"></div>\n\n                <section class=\"content-section active\" id=\"gestao-clientes\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-4\">\n                        <h3><i class=\"fas fa-building-user me-2\"></i>Gestão de Clientes</h3>\n                        <button class=\"btn btn-primary\" onclick=\"openClientModal()\">\n                            <i class=\"fas fa-plus me-2\"></i>Novo Cliente\n                        </button>\n                    </div>\n\n                    <!-- SEÇÃO DE FILTRO UNIFICADO -->\n                    <div class=\"card mb-4\">\n                        <div class=\"card-header\">\n                            <h5><i class=\"fas fa-filter me-2\"></i>Filtrar Dados</h5>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"row g-3 align-items-end\">\n                                <div class=\"col-md-3\">\n                                    <label for=\"filterClienteGlobal\" class=\"form-label\">Cliente:</label>\n                                    <select class=\"form-select\" id=\"filterClienteGlobal\">\n                                        <option value=\"\">Todos os clientes</option>\n                                    </select>\n                                </div>\n                                <div class=\"col-md-3\">\n                                    <label for=\"filterServicoGlobal\" class=\"form-label\">Serviço:</label>\n                                    <select class=\"form-select\" id=\"filterServicoGlobal\">\n                                        <option value=\"\">Todos os serviços</option>\n                                    </select>\n                                </div>\n                                <div class=\"col-md-2\">\n                                    <label for=\"filterDataInicialGlobal\" class=\"form-label\">Data Inicial:</label>\n                                    <input type=\"date\" class=\"form-control\" id=\"filterDataInicialGlobal\">\n                                </div>\n                                <div class=\"col-md-2\">\n                                    <label for=\"filterDataFinalGlobal\" class=\"form-label\">Data Final:</label>\n                                    <input type=\"date\" class=\"form-control\" id=\"filterDataFinalGlobal\">\n                                </div>\n                                <div class=\"col-md-2 d-flex\">\n                                    <button class=\"btn btn-primary w-100\" id=\"btnFiltrarGlobal\">\n                                        <i class=\"fas fa-search me-2\"></i>Filtrar\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- CONTAINER PARA DADOS FILTRADOS (INICIA VISÍVEL) -->\n                    <div id=\"dadosFiltrados\">\n                        <!-- Seção de Controle de Horas Contratadas -->\n                        <div class=\"card mb-4\">\n                            <div class=\"card-header collapse-header\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseHoursControl\" aria-expanded=\"true\" aria-controls=\"collapseHoursControl\">\n                                <h5><i class=\"fas fa-clock me-2\"></i>Controle de Horas Contratadas</h5>\n                                <i class=\"fas fa-chevron-down toggle-icon\"></i>\n                            </div>\n                            <div class=\"collapse show\" id=\"collapseHoursControl\">\n                                <div class=\"card-body\">\n                                    <div id=\"serviceDetailsContainer\">\n                                        <p class=\"text-muted text-center\">Selecione um único cliente e serviço nos filtros acima para ver os detalhes específicos.</p>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Estatísticas Gerais -->\n                        <div class=\"row mb-4 mt-4\">\n                            <div class=\"col-md-4 mb-3\">\n                                <div class=\"card text-center\">\n                                    <div class=\"card-body\">\n                                        <h5 class=\"card-title text-primary\" id=\"totalClients\"><div class=\"loading-spinner\"></div></h5>\n                                        <p class=\"card-text\">Total de Clientes</p>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-md-4 mb-3\">\n                                <div class=\"card text-center\">\n                                    <div class=\"card-body\">\n                                        <h5 class=\"card-title text-success\" id=\"activeClients\"><div class=\"loading-spinner\"></div></h5>\n                                        <p class=\"card-text\">Clientes Ativos</p>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-md-4 mb-3\">\n                                <div class=\"card text-center\">\n                                    <div class=\"card-body\">\n                                        <h5 class=\"card-title text-info\" id=\"totalContractedHours\"><div class=\"loading-spinner\"></div></h5>\n                                        <p class=\"card-text\">Horas Contratadas</p>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Botão de Exportação -->\n                        <div class=\"row mb-4\">\n                            <div class=\"col-12 text-center\">\n                                <button class=\"btn btn-success btn-lg\" onclick=\"exportFilteredDataToCSV()\">\n                                    <i class=\"fas fa-file-csv me-2\"></i>Exportar Dados Filtrados para CSV\n                                </button>\n                                <small class=\"d-block text-muted mt-2\">Exporta todos os dados atualmente exibidos conforme os filtros aplicados</small>\n                            </div>\n                        </div>\n\n                        <!-- Tabela Principal - Detalhes dos Clientes e Serviços -->\n                        <div class=\"card\">\n                            <div class=\"card-header collapse-header\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseClientDetails\" aria-expanded=\"true\" aria-controls=\"collapseClientDetails\">\n                                <h5><i class=\"fas fa-table me-2\"></i>Detalhes dos Clientes e Serviços</h5>\n                                <i class=\"fas fa-chevron-down toggle-icon\"></i>\n                            </div>\n                            <div class=\"collapse show\" id=\"collapseClientDetails\">\n                                <div class=\"card-body\">\n                                    <div class=\"table-responsive\">\n                                        <table class=\"table table-striped table-hover align-middle\">\n                                            <thead>\n                                                <tr>\n                                                    <th>Nome do Cliente</th>\n                                                    <th>CNPJ</th>\n                                                    <th>Status</th>\n                                                    <th>Horas Contratadas</th>\n                                                    <th>Horas Utilizadas</th>\n                                                    <th>Banco de Horas</th>\n                                                    <th>Serviços</th>\n                                                    <th>Ações</th>\n                                                </tr>\n                                            </thead>\n                                            <tbody id=\"clientsTableBody\"></tbody>\n                                        </table>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Acompanhamento Mensal -->\n                        <div class=\"card mt-4\">\n                            <div class=\"card-header collapse-header d-flex justify-content-between align-items-center\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseMonthlyTracking\" aria-expanded=\"true\" aria-controls=\"collapseMonthlyTracking\">\n                                <h5 class=\"mb-0\"><i class=\"fas fa-calendar-alt me-2\"></i>Acompanhamento Mês a Mês</h5>\n                                <div class=\"d-flex align-items-center\">\n                                    <button class=\"btn btn-success d-none me-2\" id=\"saveMonthlyChangesBtn\" onclick=\"openConfirmSaveModal()\">\n                                        <i class=\"fas fa-save me-2\"></i>Salvar Alterações\n                                    </button>\n                                    <i class=\"fas fa-chevron-down toggle-icon\"></i>\n                                </div>\n                            </div>\n                            <div class=\"collapse show\" id=\"collapseMonthlyTracking\">\n                                <div class=\"card-body\">\n                                    <div class=\"table-responsive\">\n                                        <table class=\"table table-striped table-bordered table-hover align-middle text-center\">\n                                            <thead>\n                                                <tr>\n                                                    <th>ID</th>\n                                                    <th class=\"text-start\">Cliente</th>\n                                                    <th class=\"text-start\">Serviços</th>\n                                                    <th>Horas Contratadas</th>\n                                                    <th>Acumula</th>\n                                                    <th>Qtd Tempo</th>\n                                                    <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>\n                                                    <th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>\n                                                    <th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>\n                                                    <th>Saldo Atual</th>\n                                                </tr>\n                                            </thead>\n                                            <tbody id=\"monthlyTrackingTableBody\"></tbody>\n                                        </table>\n                                    </div>\n                                    <div id=\"calculationDetails\" class=\"validation-info d-none\">\n                                        <h6>Detalhes do Cálculo (para validação):</h6>\n                                        <div id=\"calculationDetailsContent\"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </section>\n            </div>\n        </main>\n        \n        <!-- Sidebar Overlay for Mobile -->\n        <div class=\"sidebar-overlay\" id=\"sidebarOverlay\"></div>\n    </div>\n    \n    <!-- Modais -->\n    <div class=\"modal fade\" id=\"clientModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"clientModalTitle\">Novo Cliente</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"clientForm\">\n                        <input type=\"hidden\" id=\"clientId\">\n                        <div class=\"row mb-3\">\n                            <div class=\"col-md-6\">\n                                <label for=\"clientName\" class=\"form-label\">Nome do Cliente *</label>\n                                <input type=\"text\" class=\"form-control\" id=\"clientName\" required>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <label for=\"clientCnpj\" class=\"form-label\">CNPJ</label>\n                                <input type=\"text\" class=\"form-control\" id=\"clientCnpj\" placeholder=\"00.000.000/0000-00\">\n                            </div>\n                        </div>\n                        <div class=\"row mb-3\">\n                            <div class=\"col-md-6\">\n                                <label for=\"clientEmail\" class=\"form-label\">Email</label>\n                                <input type=\"email\" class=\"form-control\" id=\"clientEmail\">\n                            </div>\n                            <div class=\"col-md-6\">\n                                <label for=\"clientPhone\" class=\"form-label\">Telefone</label>\n                                <input type=\"tel\" class=\"form-control\" id=\"clientPhone\" placeholder=\"(XX) XXXX-XXXX\">\n                            </div>\n                        </div>\n                        <div class=\"mb-4\">\n                            <div class=\"form-check\">\n                                <input class=\"form-check-input\" type=\"checkbox\" id=\"clientActive\" checked>\n                                <label class=\"form-check-label\" for=\"clientActive\">Cliente ativo</label>\n                            </div>\n                        </div>\n                        <div class=\"mb-3\">\n                            <label class=\"form-label h6\">Serviços Contratados</label>\n                            <div id=\"clientServicesContainer\">\n                                <div class=\"service-item p-3 border rounded\">\n                                    <div class=\"row\">\n                                        <div class=\"col-md-12 mb-2 d-flex align-items-end\">\n                                            <div class=\"flex-grow-1 me-2\">\n                                                <label class=\"form-label\">Serviço</label>\n                                                <select class=\"form-select service-name\" id=\"clientServiceSelect\">\n                                                    <!-- Opções de serviço serão carregadas aqui -->\n                                                </select>\n                                            </div>\n                                            <button type=\"button\" class=\"btn btn-outline-primary\" onclick=\"openAddServiceModal()\" title=\"Adicionar novo serviço ao catálogo\">\n                                                <i class=\"fas fa-plus\"></i>\n                                            </button>\n                                        </div>\n                                        <div class=\"col-md-6\">\n                                            <label class=\"form-label\">Horas/Mês</label>\n                                            <input type=\"number\" class=\"form-control service-hours\" value=\"0\">\n                                        </div>\n                                        <div class=\"col-md-6\">\n                                            <label class=\"form-label\">Meses Acum.</label>\n                                            <input type=\"number\" class=\"form-control service-accumulation\" value=\"0\">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveClient()\">Salvar</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- NOVO MODAL DE EDIÇÃO DE SERVIÇO ESPECÍFICO -->\n    <div class=\"modal fade\" id=\"editServiceModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\">Editar Serviço</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"editServiceForm\">\n                        <input type=\"hidden\" id=\"editServiceClientId\">\n                        <input type=\"hidden\" id=\"editServiceId\">\n                        <input type=\"hidden\" id=\"editServiceIndex\">\n                        \n                        <!-- Dados do Cliente (readonly) -->\n                        <div class=\"row mb-3\">\n                            <div class=\"col-md-6\">\n                                <label for=\"editServiceClientName\" class=\"form-label\">Nome do Cliente</label>\n                                <input type=\"text\" class=\"form-control\" id=\"editServiceClientName\" readonly disabled>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <label for=\"editServiceClientCnpj\" class=\"form-label\">CNPJ</label>\n                                <input type=\"text\" class=\"form-control\" id=\"editServiceClientCnpj\" readonly disabled>\n                            </div>\n                        </div>\n                        \n                        <!-- Dados do Serviço -->\n                        <div class=\"mb-3\">\n                            <label class=\"form-label h6\">Dados do Serviço</label>\n                            <div class=\"service-item p-3 border rounded\">\n                                <div class=\"row\">\n                                    <div class=\"col-md-12 mb-2 d-flex align-items-end\">\n                                        <div class=\"flex-grow-1 me-2\">\n                                            <label class=\"form-label\">Serviço</label>\n                                            <select class=\"form-select\" id=\"editServiceServiceSelect\">\n                                                <!-- Opções de serviço serão carregadas aqui -->\n                                            </select>\n                                        </div>\n                                        <button type=\"button\" class=\"btn btn-outline-primary\" onclick=\"openAddServiceModal()\" title=\"Adicionar novo serviço ao catálogo\">\n                                            <i class=\"fas fa-plus\"></i>\n                                        </button>\n                                    </div>\n                                    <div class=\"col-md-4\">\n                                        <label class=\"form-label\">Horas/Mês</label>\n                                        <input type=\"number\" class=\"form-control\" id=\"editServiceHours\" value=\"0\" min=\"0\">\n                                    </div>\n                                    <div class=\"col-md-4\">\n                                        <label class=\"form-label\">Meses Acum.</label>\n                                        <input type=\"number\" class=\"form-control\" id=\"editServiceAccumulation\" value=\"0\" min=\"0\">\n                                    </div>\n                                   \n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Status do Cliente -->\n                        <div class=\"mb-3\">\n                            <div class=\"form-check\">\n                                <input class=\"form-check-input\" type=\"checkbox\" id=\"editServiceClientActive\">\n                                <label class=\"form-check-label\" for=\"editServiceClientActive\">Cliente ativo</label>\n                            </div>\n                        </div>\n\n                        <!-- Informações adicionais -->\n                        <div class=\"alert alert-info\">\n                            <h6><i class=\"fas fa-info-circle me-2\"></i>Informações do Serviço</h6>\n                            <div class=\"row\">\n                                <div class=\"col-md-6\">\n                                    <small><strong>Horas Utilizadas:</strong> <span id=\"editServiceHoursUsed\">0h</span></small>\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <small><strong>Banco de Horas:</strong> <span id=\"editServiceBankHours\">0h</span></small>\n                                </div>\n                            </div>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveEditedService()\">Salvar Alterações</button>\n                </div>\n            </div>\n        </div>\n    </div>\n    \n    <!-- Novo Modal para Adicionar Serviço a Cliente Existente -->\n    <div class=\"modal fade\" id=\"addServiceToClientModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\">Adicionar Novo Serviço para <span id=\"addServiceToClientName\"></span></h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"addServiceToClientForm\">\n                        <input type=\"hidden\" id=\"addServiceToClientId\">\n                        <div class=\"row mb-3\">\n                            <div class=\"col-md-6\">\n                                <label for=\"addServiceToClientNameDisplay\" class=\"form-label\">Nome do Cliente</label>\n                                <input type=\"text\" class=\"form-control\" id=\"addServiceToClientNameDisplay\" readonly disabled>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <label for=\"addServiceToClientCnpjDisplay\" class=\"form-label\">CNPJ</label>\n                                <input type=\"text\" class=\"form-control\" id=\"addServiceToClientCnpjDisplay\" readonly disabled>\n                            </div>\n                        </div>\n                        <div class=\"mb-3\">\n                            <label class=\"form-label h6\">Serviços Contratados</label>\n                            <div class=\"service-item p-3 border rounded\">\n                                <div class=\"row\">\n                                    <div class=\"col-md-12 mb-2 d-flex align-items-end\">\n                                        <div class=\"flex-grow-1 me-2\">\n                                            <label class=\"form-label\">Serviço</label>\n                                            <select class=\"form-select service-name\" id=\"addServiceToClientServiceSelect\" onchange=\"checkExistingService(this)\">\n                                                <!-- Opções de serviço serão carregadas aqui -->\n                                            </select>\n                                            <div id=\"serviceExistsWarning\" class=\"text-danger mt-2 d-none\">\n                                                Este serviço já está cadastrado para este cliente. Por favor, edite-o na tabela principal.\n                                            </div>\n                                        </div>\n                                        <button type=\"button\" class=\"btn btn-outline-primary\" onclick=\"openNestedAddServiceModal()\" title=\"Adicionar novo serviço ao catálogo\">\n                                            <i class=\"fas fa-plus\"></i>\n                                        </button>\n                                    </div>\n                                    <div class=\"col-md-6\">\n                                        <label class=\"form-label\">Horas/Mês</label>\n                                        <input type=\"number\" class=\"form-control service-hours\" id=\"addServiceToClientHours\" value=\"0\">\n                                    </div>\n                                    <div class=\"col-md-6\">\n                                        <label class=\"form-label\">Meses Acum.</label>\n                                        <input type=\"number\" class=\"form-control service-accumulation\" id=\"addServiceToClientAccumulation\" value=\"0\">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </form>\n\n                    <!-- MODAL ANINHADO DE ADICIONAR SERVIÇO -->\n                    <div class=\"modal fade nested-modal\" id=\"addServiceNestedModal\" tabindex=\"-1\" data-bs-backdrop=\"false\">\n                        <div class=\"modal-dialog\">\n                            <div class=\"modal-content\">\n                                <div class=\"modal-header\">\n                                    <h5 class=\"modal-title\">Adicionar Novo Serviço</h5>\n                                    <button type=\"button\" class=\"btn-close\" onclick=\"closeNestedAddServiceModal()\"></button>\n                                </div>\n                                <div class=\"modal-body\">\n                                    <form id=\"addServiceNestedForm\">\n                                        <div class=\"mb-3\">\n                                            <label for=\"newServiceNameNested\" class=\"form-label\">Nome do Serviço *</label>\n                                            <input type=\"text\" class=\"form-control\" id=\"newServiceNameNested\" required>\n                                        </div>\n                                    </form>\n                                </div>\n                                <div class=\"modal-footer\">\n                                    <button type=\"button\" class=\"btn btn-secondary\" onclick=\"closeNestedAddServiceModal()\">Cancelar</button>\n                                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveNestedService()\">Salvar Serviço</button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" id=\"saveNewClientServiceBtn\" onclick=\"saveNewClientService()\">Adicionar Serviço</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- MODAL DE ADICIONAR SERVIÇO (CATÁLOGO) - Independente -->\n    <div class=\"modal fade\" id=\"addServiceModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\">Adicionar Novo Serviço</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"addServiceForm\">\n                        <div class=\"mb-3\">\n                            <label for=\"newServiceName\" class=\"form-label\">Nome do Serviço *</label>\n                            <input type=\"text\" class=\"form-control\" id=\"newServiceName\" required>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveService()\">Salvar Serviço</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class=\"modal fade\" id=\"confirmSaveModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\">Confirmar Alterações</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\" id=\"confirmSaveModalBody\">\n                    <!-- Resumo das alterações será inserido aqui -->\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-success\" onclick=\"confirmSaveChanges()\">Confirmar e Salvar</button>\n                </div>\n            </div>\n        </div>\n    </div>\n    \n    <!-- Novo Modal para Confirmação de Exclusão -->\n    <div class=\"modal fade\" id=\"confirmDeleteModal\" tabindex=\"-1\" aria-labelledby=\"confirmDeleteModalLabel\" aria-hidden=\"true\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"confirmDeleteModalLabel\">Confirmar Exclusão de Cliente/Serviço</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n                </div>\n                <div class=\"modal-body\" id=\"deleteModalBody\">\n                    <!-- Conteúdo dinâmico -->\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-danger\" id=\"confirmDeleteBtn\">Excluir</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n    <script>\n        // --- AUTHENTICATION AND GLOBAL SETTINGS ---\n        const LOGIN_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/login'; // Ensure this matches your login page URL\n\n        /**\n        * Checks if user is logged in by verifying localStorage items.\n        * @returns {boolean} True if user is logged in, false otherwise.\n        */\n        function checkLoginStatus() {\n            return localStorage.getItem('loggedInUserEmail') && localStorage.getItem('loggedInUserName');\n        }\n\n        /**\n        * Redirects user to the login page and clears local storage.\n        */\n        function redirectToLogin() {\n            localStorage.clear();\n            window.location.href = LOGIN_URL;\n        }\n\n        /**\n        * Esconde a tela de carregamento e exibe o container da aplicação.\n        */\n        function showAuthenticatedInterface() {\n            const authLoading = document.getElementById('authLoading');\n            const appContainer = document.getElementById('appContainer');\n            \n            if(authLoading) {\n                authLoading.style.display = 'none';\n            }\n            if(appContainer) {\n                appContainer.classList.add('authenticated');\n            }\n        }\n\n        // --- Functions for dynamic styles and sidebar behavior ---\n        function hexToRgb(hex) {\n            const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;\n        }\n\n        function shadeHexColor(hex, percent) {\n            let f = parseInt(hex.slice(1), 16),\n                t = percent < 0 ? 0 : 255,\n                p = percent < 0 ? percent * -1 : percent,\n                R = f >> 16,\n                G = (f >> 8) & 0x00ff,\n                B = f & 0x0000ff;\n            return (\"#\" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + (Math.round((t - G) * p) + G) * 0x100 + (Math.round((t - B) * p) + B)).toString(16).slice(1));\n        }\n\n        // Função showPage para navegação interna (mantida como no menu original)\n        function showPage(pageId, event) {\n            if (event) event.preventDefault();\n            \n            // Remove classe ativa de todos os itens do menu\n            document.querySelectorAll('.menu-item').forEach(item => {\n                item.classList.remove('active');\n            });\n            \n            // Adiciona classe ativa ao item clicado\n            event.currentTarget.classList.add('active');\n            \n            console.log(`Navegando para página interna: ${pageId}`);\n            // Aqui você pode adicionar lógica para mostrar/ocultar seções da página\n            // Para este caso, como a navegação é externa, esta função é mais um placeholder\n            // para o item \"Configurações\".\n        }\n\n        async function applyDynamicStyles() {\n            // Este URL será substituído pelo n8n em tempo de execução.\n            const url = 'https://n8n.dev.resolvrisk.com.br/webhook/consultaconfiguracoes';\n            try {\n                const response = await fetch(url);\n                if (!response.ok) {\n                    // Se a resposta não for OK, loga o erro e usa cores padrão\n                    console.error(`HTTP error! status: ${response.status}`);\n                    console.warn('⚠️ Não foi possível buscar as configurações de cor. Usando cores padrão.');\n                    return; // Sai da função para usar as cores padrão do CSS\n                }\n                const data = await response.json(); // Assumindo que o webhook retorna JSON diretamente\n\n                if (data && data.length > 0 && data[0].primary_color) {\n                    const primaryColor = data[0].primary_color;\n                    const darkerColor = shadeHexColor(primaryColor, -0.15); // Ajusta o tom para um pouco mais escuro\n                    const primaryRgb = hexToRgb(primaryColor);\n\n                    if (!primaryRgb) {\n                        console.error(\"Cor primária inválida retornada:\", primaryColor);\n                        return;\n                    }\n\n                    document.documentElement.style.setProperty('--primary-color', primaryColor);\n                    \n                    const style = document.createElement('style');\n                    style.innerHTML = `\n                        .sidebar, .auth-loading {\n                            background: linear-gradient(135deg, ${primaryColor} 0%, ${darkerColor} 100%) !important;\n                        }\n                        .btn-primary, .table thead th {\n                            background-color: ${primaryColor} !important;\n                            border-color: ${primaryColor} !important;\n                        }\n                        .btn-primary:hover {\n                            background-color: ${shadeHexColor(primaryColor, -0.1)} !important;\n                            border-color: ${shadeHexColor(primaryColor, -0.1)} !important;\n                        }\n                        .text-primary {\n                            color: ${primaryColor} !important;\n                        }\n                        .progress-bar.bg-primary {\n                            background-color: ${primaryColor} !important;\n                        }\n                        .loading-spinner {\n                            border-top-color: ${primaryColor} !important;\n                        }\n                    `;\n                    document.head.appendChild(style);\n                } else {\n                    console.warn('⚠️ Não foi possível encontrar a cor primária nos dados. Usando cores padrão.');\n                }\n            } catch (error) {\n                console.error('❌ Falha ao buscar ou aplicar estilos dinâmicos:', error);\n                console.warn('⚠️ Ocorreu um erro ao buscar as configurações de cor. Usando cores padrão.');\n            }\n        }\n\n        function adjustMainContentLayout() {\n            const sidebar = document.getElementById('sidebar');\n            const mainContent = document.getElementById('mainContent');\n            const sidebarToggle = document.getElementById('sidebarToggle');\n\n            if (!mainContent) return; // Verificação de segurança\n\n            if (window.innerWidth <= 768) {\n                // Comportamento Mobile\n                if (sidebarToggle) sidebarToggle.style.display = 'block';\n                mainContent.style.marginLeft = '0'; // Conteúdo principal sempre sem margem no mobile\n            } else {\n                // Comportamento Desktop\n                if (sidebarToggle) sidebarToggle.style.display = 'none';\n                if (sidebar.classList.contains('collapsed')) {\n                    mainContent.style.marginLeft = '0';\n                } else {\n                    mainContent.style.marginLeft = '280px'; // Largura da sidebar\n                }\n            }\n        }\n\n        function toggleSidebar() {\n            const sidebar = document.getElementById('sidebar');\n            const overlay = document.getElementById('sidebarOverlay');\n            \n            if (window.innerWidth <= 768) {\n                // Comportamento Mobile\n                sidebar.classList.toggle('show');\n                overlay.classList.toggle('show');\n                document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';\n            } else {\n                // Comportamento Desktop\n                sidebar.classList.toggle('collapsed');\n                adjustMainContentLayout(); // Ajusta a margem do conteúdo principal no toggle do desktop\n            }\n        }\n\n        function applyUIPermissions() {\n            const userType = localStorage.getItem('loggedInUserTipo') || 'admin'; // 'admin' ou 'colaborador'\n\n            // CORREÇÃO: O item 'partners' e 'team' foi adicionado para o perfil 'colaborador'.\n            const menuPermissions = {\n                admin: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'], // Admin tem acesso a tudo\n                colaborador: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'] // Adicionado 'clients', 'partners' e 'team'\n            };\n\n            const allowedMenus = menuPermissions[userType] || [];\n\n            const loadingElement = document.getElementById('sidebarLoading');\n            if (loadingElement) {\n                loadingElement.style.display = 'none';\n            }\n\n            document.querySelectorAll('#sidebarMenu .menu-item').forEach((item, index) => {\n                const menuData = item.getAttribute('data-menu');\n                // Se o usuário for admin, mostra todos os menus. Caso contrário, verifica as permissões.\n                if (userType === 'admin' || allowedMenus.includes(menuData)) {\n                    setTimeout(() => {\n                        item.classList.add('show');\n                    }, index * 50); // Efeito de animação stagger\n                } else {\n                    item.classList.remove('show');\n                }\n            });\n        }\n\n        function updateUserDisplay() {\n            const userNameDisplay = document.getElementById('userNameDisplay');\n            const userName = localStorage.getItem('loggedInUserName');\n            if (userNameDisplay && userName) {\n                userNameDisplay.textContent = userName;\n            }\n        }\n\n        function setupLogoutButton() {\n            const logoutButton = document.getElementById('logoutButton');\n            if (logoutButton) {\n                logoutButton.addEventListener('click', () => {\n                    localStorage.clear();\n                    window.location.href = LOGIN_URL;\n                });\n            }\n        }\n\n        document.addEventListener('DOMContentLoaded', async function() {\n            console.log('📄 DOM carregado, verificando autenticação...');\n\n            // --- START: Added loggedInUserEmail verification ---\n            if (!checkLoginStatus()) {\n                redirectToLogin();\n                return; // Stop execution if not logged in\n            }\n            // --- END: Added loggedInUserEmail verification ---\n            \n            // Mostra a interface autenticada\n            showAuthenticatedInterface();\n            \n            await applyDynamicStyles(); // Aplica estilos dinâmicos primeiro\n            applyUIPermissions(); // Depois aplica as permissões da UI\n            updateUserDisplay(); // Atualiza o nome do usuário\n            setupLogoutButton(); // Configura o botão de logout\n            adjustMainContentLayout(); // Ajusta o layout inicial do conteúdo principal\n\n            const sidebarToggle = document.getElementById('sidebarToggle');\n            const sidebarOverlay = document.getElementById('sidebarOverlay');\n\n            if (sidebarToggle) {\n                sidebarToggle.addEventListener('click', toggleSidebar);\n            }\n            if (sidebarOverlay) {\n                sidebarOverlay.addEventListener('click', toggleSidebar);\n            }\n\n            // Usa adjustMainContentLayout para eventos de redimensionamento da janela\n            window.addEventListener('resize', adjustMainContentLayout);\n\n            // Define o menu ativo baseado na URL atual, com fallback para 'Gestão de Clientes'\n            const currentPath = window.location.pathname;\n            let isAnyItemActive = false;\n\n            document.querySelectorAll('.menu-item').forEach(item => {\n                item.classList.remove('active'); // Limpa todos os ativos primeiro\n                const menuData = item.getAttribute('data-menu');\n                let shouldBeActive = false;\n\n                if (currentPath.includes('/webhook/resolv') && menuData === 'dashboard') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('gerenciadortarefas') && menuData === 'tasks') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('taskhoras') && menuData === 'hours') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('gestaoclientes') && menuData === 'clients') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('gest%C3%A3o%20_parceiros') && menuData === 'partners') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('equipe') && menuData === 'team') {\n                    shouldBeActive = true;\n                }\n                \n                if (shouldBeActive) {\n                    item.classList.add('active');\n                    isAnyItemActive = true;\n                }\n            });\n\n            // Se nenhum item foi ativado pela URL, ativa 'Gestão de Clientes' como padrão.\n            if (!isAnyItemActive) {\n                const clientsMenu = document.querySelector('.menu-item[data-menu=\"clients\"]');\n                if (clientsMenu) {\n                    clientsMenu.classList.add('active');\n                }\n            }\n\n            // Funções para lidar com os ícones de expandir/colapsar\n            document.querySelectorAll('.collapse-header').forEach(header => {\n                header.addEventListener('click', function() {\n                    const icon = this.querySelector('.toggle-icon');\n                    if (icon) {\n                        icon.classList.toggle('rotated');\n                    }\n                });\n            });\n\n            // Funções existentes do cliente management app\n            let originalN8nData = {};\n            let monthlyChanges = [];\n            let rawServicosContratados = [];\n            let rawCadastroServico = [];\n\n            /**\n            * Exibe uma mensagem de feedback na interface.\n            * @param {string} type - Tipo da mensagem ('success', 'danger', 'info', 'warning').\n            * @param {string} message - Texto da mensagem.\n            */\n            function showMessage(type, message) {\n                const messageContainer = document.getElementById('messageContainer');\n                if (!messageContainer) {\n                    console.error(\"Message container not found!\");\n                    return;\n                }\n                const alertDiv = document.createElement('div');\n                alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;\n                alertDiv.role = 'alert';\n                alertDiv.innerHTML = `\n                    ${message}\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n                `;\n                messageContainer.innerHTML = '';\n                messageContainer.appendChild(alertDiv);\n                setTimeout(() => {\n                    const bsAlert = bootstrap.Alert.getInstance(alertDiv);\n                    if (bsAlert) {\n                        bsAlert.close();\n                    }\n                }, 5000);\n            }\n\n            /**\n            * Calcula o saldo atual com base na lógica especificada.\n            * @param {number} horasContratadas - Horas contratadas mensais.\n            * @param {Array} monthlyHours - Array de 12 posições com horas utilizadas por mês.\n            * @param {number} qtdTempo - Quantidade de meses para acumulação.\n            * @param {Array} monthlyDataExists - Array indicando se existe dado lançado para cada mês.\n            * @returns {Object} - Resultados dos cálculos.\n            */\n            function calculateBalance(horasContratadas, monthlyHours, qtdTempo, monthlyDataExists = null) {\n                horasContratadas = parseFloat(horasContratadas) || 0;\n                monthlyHours = monthlyHours.map(h => parseFloat(h) || 0);\n                qtdTempo = parseInt(qtdTempo) || 0;\n\n                let saldoAUtilizar = 0;\n                let totalHorasUtilizadas = 0;\n                let horasNaoUtilizadasMaisQtdTempoMeses = 0;\n                let horasNaoUtilizadasUltimosQtdTempoMeses = 0;\n                let activeMonthsIndices = [];\n                let ultimosQtdTempoMesesAtivos = [];\n\n                // Determinação dos meses ativos: agora considera tanto horas > 0 quanto dados lançados como 0\n                for (let i = 0; i < 12; i++) {\n                    // Se monthlyDataExists for fornecido, usa para determinar se há dados lançados\n                    // Caso contrário, usa a lógica anterior (se horas > 0)\n                    if (monthlyDataExists && monthlyDataExists[i]) {\n                        activeMonthsIndices.push(i);\n                    } else if (!monthlyDataExists && monthlyHours[i] >= 0) {\n                        // Verifica se foi explicitamente definido, mesmo que seja 0\n                        // Para isso, precisamos verificar nos dados originais se existe entrada para este mês\n                        activeMonthsIndices.push(i);\n                    }\n                }\n\n                if (qtdTempo === 0) {\n                    // Para acumulação 0, calcula saldo mensal simples\n                    totalHorasUtilizadas = monthlyHours.reduce((sum, hours) => sum + hours, 0);\n                    const bancoHorasMensal = monthlyHours.map((horasUtilizadas, index) => {\n                        // Se não há dados lançados para o mês, retorna null (será exibido como vazio)\n                        if (monthlyDataExists && !monthlyDataExists[index]) {\n                            return null;\n                        }\n                        return horasContratadas - horasUtilizadas;\n                    });\n                    return {\n                        totalHorasContratadas: horasContratadas,\n                        totalHorasUtilizadas,\n                        horasNaoUtilizadasMais3Meses: 0,\n                        saldoAUtilizar: 0,\n                        horasNaoUtilizadasUltimos3Meses: 0,\n                        bancoHorasMensal,\n                        mesesAtivos: activeMonthsIndices.length,\n                        activeMonthsIndices: activeMonthsIndices,\n                        ultimosQtdTempoMesesAtivos: [],\n                        validacao: true\n                    };\n                }\n\n                totalHorasUtilizadas = monthlyHours.reduce((sum, hours) => sum + hours, 0);\n                const mesesAtivos = activeMonthsIndices.length;\n                const totalHorasContratadasPeriodo = horasContratadas * mesesAtivos;\n\n                ultimosQtdTempoMesesAtivos = activeMonthsIndices.slice(-qtdTempo);\n\n                activeMonthsIndices.forEach(monthIndex => {\n                    if (!ultimosQtdTempoMesesAtivos.includes(monthIndex)) {\n                        const horasNaoUtilizadas = horasContratadas - monthlyHours[monthIndex];\n                        if (horasNaoUtilizadas > 0) {\n                            horasNaoUtilizadasMaisQtdTempoMeses += horasNaoUtilizadas;\n                        }\n                    }\n                });\n\n                saldoAUtilizar = totalHorasContratadasPeriodo - totalHorasUtilizadas - horasNaoUtilizadasMaisQtdTempoMeses;\n\n                ultimosQtdTempoMesesAtivos.forEach(monthIndex => {\n                    const horasNaoUtilizadas = horasContratadas - monthlyHours[monthIndex];\n                    if (horasNaoUtilizadas > 0) {\n                        horasNaoUtilizadasUltimosQtdTempoMeses += horasNaoUtilizadas;\n                    }\n                });\n\n                const bancoHorasMensal = monthlyHours.map((horasUtilizadas, index) => {\n                    // Se não há dados lançados para o mês, retorna null (será exibido como vazio)\n                    if (monthlyDataExists && !monthlyDataExists[index]) {\n                        return null;\n                    }\n                    return horasContratadas - horasUtilizadas;\n                });\n\n                return {\n                    totalHorasContratadas: horasContratadas,\n                    totalHorasUtilizadas,\n                    horasNaoUtilizadasMais3Meses: horasNaoUtilizadasMaisQtdTempoMeses,\n                    saldoAUtilizar,\n                    horasNaoUtilizadasUltimos3Meses: horasNaoUtilizadasUltimosQtdTempoMeses,\n                    bancoHorasMensal,\n                    mesesAtivos,\n                    activeMonthsIndices,\n                    ultimosQtdTempoMesesAtivos,\n                    validacao: Math.abs(saldoAUtilizar - horasNaoUtilizadasUltimosQtdTempoMeses) < 0.01\n                };\n            }\n\n            function initializeData() {\n                try {\n                    // A expressão do n8n {{ JSON.stringify($json) }} irá injetar os dados\n                    // do nó anterior aqui como uma string JSON.\n                    const rawN8nData = {{ JSON.stringify($json) }};\n\n                    originalN8nData = rawN8nData;\n                    \n                    if (!originalN8nData || !originalN8nData.clientesServicosDetalhado) {\n                        throw new Error(\"Formato de dados inválido ou ausente. Esperado 'clientesServicosDetalhado'.\");\n                    }\n                    \n                    rawServicosContratados = originalN8nData.rawServicosContratados || [];\n                    rawCadastroServico = originalN8nData.rawCadastroServico || [];\n\n                    populateGlobalFilters();\n                    populateServiceDropdowns();\n                    \n                    // Carrega automaticamente todos os dados ao inicializar\n                    filtrarDadosGlobal();\n\n                } catch (e) {\n                    console.error(\"Erro ao carregar dados:\", e);\n                    document.getElementById('main-content-wrapper').innerHTML = `<div class=\"alert alert-danger mx-3\"><strong>Erro:</strong> Não foi possível carregar os dados. Verifique o formato do JSON e o console para mais detalhes.</div>`;\n                }\n            }\n            \n            function populateGlobalFilters() {\n                const clienteSelect = document.getElementById('filterClienteGlobal');\n                const servicoSelect = document.getElementById('filterServicoGlobal');\n\n                const uniqueClients = [...new Map(originalN8nData.clientesServicosDetalhado.map(item => [item['clienteId'], item])).values()];\n                const uniqueServices = [...new Set(originalN8nData.clientesServicosDetalhado.map(item => item.servico))];\n\n                clienteSelect.innerHTML = '<option value=\"\">Todos os clientes</option>';\n                uniqueClients.forEach(client => {\n                    clienteSelect.innerHTML += `<option value=\"${client.clienteId}\">${client.nomeCliente}</option>`;\n                });\n\n                servicoSelect.innerHTML = '<option value=\"\">Todos os serviços</option>';\n                uniqueServices.forEach(service => {\n                    servicoSelect.innerHTML += `<option value=\"${service}\">${service}</option>`;\n                });\n            }\n\n            function loadStats(data) {\n                document.getElementById('totalClients').textContent = data.totalClientes || 0;\n                document.getElementById('activeClients').textContent = data.clientesAtivos || 0;\n                document.getElementById('totalContractedHours').textContent = `${data.totalHorasContratadas || 0}h`;\n            }\n\n            // NOVA FUNÇÃO loadClientsTable COM AGRUPAMENTO E BOTÕES DE EDITAR\n            function loadClientsTable(clientsData) {\n                const tableBody = document.getElementById('clientsTableBody');\n                tableBody.innerHTML = '';\n\n                if (clientsData.length === 0) {\n                    tableBody.innerHTML = `<tr><td colspan=\"8\" class=\"text-center text-muted\">Nenhum cliente encontrado com os filtros aplicados.</td></tr>`;\n                    return;\n                }\n\n                // 1. Agrupar serviços por clienteId\n                const groupedClients = new Map();\n                clientsData.forEach((clientService, index) => {\n                    if (!groupedClients.has(clientService.clienteId)) {\n                        // Inicializa o cliente no mapa com uma lista de serviços\n                        groupedClients.set(clientService.clienteId, {\n                            ...clientService, // Copia dados do cliente (nome, cnpj, etc.)\n                            services: [] // Array para armazenar os múltiplos serviços\n                        });\n                    }\n                    // Adiciona o serviço atual à lista de serviços do cliente incluindo o índice original\n                    groupedClients.get(clientService.clienteId).services.push({\n                        ...clientService,\n                        originalIndex: index\n                    });\n                });\n\n                let tableHtml = '';\n                // 2. Iterar sobre os clientes agrupados\n                groupedClients.forEach(client => {\n                    const numServices = client.services.length;\n                    const firstService = client.services[0];\n                    const statusClass = firstService.status === 'Ativo' ? 'success' : 'secondary';\n                    \n                    // Botões de ação para o cliente (agrupados)\n                    const clientActions = `\n                        <div class=\"btn-group-vertical\" role=\"group\">\n                            <button class=\"btn btn-outline-success btn-sm\" onclick=\"openAddServiceToClientModal(${client.clienteId})\" title=\"Adicionar Novo Serviço\"><i class=\"fas fa-plus\"></i></button>\n                            <button class=\"btn btn-outline-danger btn-sm\" onclick=\"openConfirmDeleteModalByClient(${client.clienteId})\" title=\"Excluir Serviços Selecionados\"><i class=\"fas fa-trash-alt\"></i></button>\n                        </div>\n                    `;\n\n                    // 3. Renderizar a primeira linha do cliente com rowspan\n                    const bancoHorasClassFirst = (firstService.bancoDeHoras || 0) >= 0 ? 'balance-positive' : 'balance-negative';\n                    const hasMonthlyDataFirst = (originalN8nData.acompanhamentoMensal || []).some(item => \n                        item.servicoId === firstService.servicoId && (item.horasUtilizadas > 0 || item.horasUtilizadas === 0)\n                    );\n\n                    tableHtml += `\n                        <tr>\n                            <td rowspan=\"${numServices}\"><strong>${client.nomeCliente || 'N/A'}</strong></td>\n                            <td rowspan=\"${numServices}\">${client.cnpj || 'N/A'}</td>\n                            <td rowspan=\"${numServices}\"><span class=\"badge bg-${statusClass} badge-status\">${client.status || 'N/A'}</span></td>\n                            \n                            <!-- Dados do primeiro serviço -->\n                            <td class=\"text-center\">${firstService.horasContratadas || 0}h</td>\n                            <td class=\"text-center\">${firstService.horasUtilizadas || 0}h</td>\n                            <td class=\"text-center ${bancoHorasClassFirst}\">${firstService.bancoDeHoras.toFixed(1)}h</td>\n                            <td>\n                                <div class=\"form-check d-flex align-items-center\">\n                                    <input class=\"form-check-input service-delete-checkbox me-2\" type=\"radio\" name=\"service-selection-${client.clienteId}\" value=\"${firstService.servicoId}\" \n                                           data-client-id=\"${client.clienteId}\" id=\"service-check-${firstService.servicoId}\" ${hasMonthlyDataFirst ? 'disabled' : ''}>\n                                    <label class=\"form-check-label flex-grow-1\" for=\"service-check-${firstService.servicoId}\">${firstService.servico || 'N/A'}</label>\n                                    <button class=\"service-edit-btn\" onclick=\"openEditServiceModal(${firstService.clienteId}, '${firstService.servico}', ${firstService.servicoId})\" title=\"Editar este serviço\">\n                                        <i class=\"fas fa-edit\"></i>\n                                    </button>\n                                </div>\n                            </td>\n                            \n                            <td rowspan=\"${numServices}\" class=\"text-center\">${clientActions}</td>\n                        </tr>\n                    `;\n\n                    // 4. Renderizar linhas para serviços adicionais (se houver)\n                    for (let i = 1; i < numServices; i++) {\n                        const service = client.services[i];\n                        const bancoHorasClass = (service.bancoDeHoras || 0) >= 0 ? 'balance-positive' : 'balance-negative';\n                        const hasMonthlyData = (originalN8nData.acompanhamentoMensal || []).some(item => \n                            item.servicoId === service.servicoId && (item.horasUtilizadas > 0 || item.horasUtilizadas === 0)\n                        );\n                        tableHtml += `\n                            <tr>\n                                <td class=\"text-center\">${service.horasContratadas || 0}h</td>\n                                <td class=\"text-center\">${service.horasUtilizadas || 0}h</td>\n                                <td class=\"text-center ${bancoHorasClass}\">${service.bancoDeHoras.toFixed(1)}h</td>\n                                <td>\n                                    <div class=\"form-check d-flex align-items-center\">\n                                        <input class=\"form-check-input service-delete-checkbox me-2\" type=\"radio\" name=\"service-selection-${client.clienteId}\" value=\"${service.servicoId}\" \n                                               data-client-id=\"${client.clienteId}\" id=\"service-check-${service.servicoId}\" ${hasMonthlyData ? 'disabled' : ''}>\n                                        <label class=\"form-check-label flex-grow-1\" for=\"service-check-${service.servicoId}\">${service.servico || 'N/A'}</label>\n                                        <button class=\"service-edit-btn\" onclick=\"openEditServiceModal(${service.clienteId}, '${service.servico}', ${service.servicoId})\" title=\"Editar este serviço\">\n                                            <i class=\"fas fa-edit\"></i>\n                                        </button>\n                                    </div>\n                                </td>\n                            </tr>\n                        `;\n                    }\n                });\n\n                tableBody.innerHTML = tableHtml;\n            }\n\n            // FUNÇÃO PARA ABRIR MODAL DE EDIÇÃO DE SERVIÇO - CORRIGIDA!\n            window.openEditServiceModal = function(clienteId, serviceName, servicoId = null) {\n                console.log('🔍 DEBUG: Tentando abrir modal de edição para:', { clienteId, serviceName, servicoId });\n                \n                // Busca o serviço correto usando clienteId e nome do serviço (mais confiável)\n                const service = originalN8nData.clientesServicosDetalhado.find(s => {\n                    const matchClient = s.clienteId == clienteId;\n                    const matchService = s.servico === serviceName;\n                    console.log('🔍 DEBUG: Comparando:', {\n                        'Cliente match': matchClient,\n                        'Serviço match': matchService,\n                        'clienteId': s.clienteId,\n                        'servico': s.servico,\n                        'servicoId': s.servicoId\n                    });\n                    return matchClient && matchService;\n                });\n                \n                console.log('🔍 DEBUG: Serviço encontrado:', service);\n                \n                if (!service) {\n                    console.error('❌ DEBUG: Serviço não encontrado');\n                    showMessage('danger', 'Serviço não encontrado para edição.');\n                    return;\n                }\n\n                // Encontra o índice real do serviço no array original para uso posterior\n                const serviceIndex = originalN8nData.clientesServicosDetalhado.indexOf(service);\n                console.log('🔍 DEBUG: Índice do serviço:', serviceIndex);\n\n                const modalElement = document.getElementById('editServiceModal');\n                \n                if (!modalElement) {\n                    console.error('❌ DEBUG: Modal não encontrado no DOM');\n                    showMessage('danger', 'Modal de edição não encontrado.');\n                    return;\n                }\n                \n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                \n                // Preenche os campos do modal\n                const realServiceId = service.servicoId || service.id || service.servico_id;\n                document.getElementById('editServiceClientId').value = service.clienteId;\n                document.getElementById('editServiceId').value = realServiceId;\n                document.getElementById('editServiceIndex').value = serviceIndex;\n                document.getElementById('editServiceClientName').value = service.nomeCliente || '';\n                document.getElementById('editServiceClientCnpj').value = service.cnpj || '';\n                document.getElementById('editServiceHours').value = service.horasContratadas || 0;\n                document.getElementById('editServiceAccumulation').value = service.mesesAcumulacao || 0;\n                document.getElementById('editServiceClientActive').checked = service.status === 'Ativo';\n                \n                // Preenche informações adicionais\n                document.getElementById('editServiceHoursUsed').textContent = `${service.horasUtilizadas || 0}h`;\n                document.getElementById('editServiceBankHours').textContent = `${service.bancoDeHoras ? service.bancoDeHoras.toFixed(1) : 0}h`;\n                \n                // Popula e seleciona o serviço\n                populateServiceDropdowns('editServiceServiceSelect');\n                const selectedServiceInCatalog = rawCadastroServico.find(s => s.nome_serviço === service.servico);\n                if (selectedServiceInCatalog) {\n                    document.getElementById('editServiceServiceSelect').value = selectedServiceInCatalog.id;\n                }\n                \n                console.log('🚀 DEBUG: Tentando mostrar modal...');\n                modal.show();\n                console.log('✅ DEBUG: Modal.show() executado');\n            };\n\n            // NOVA FUNÇÃO PARA SALVAR SERVIÇO EDITADO\n            window.saveEditedService = async function() {\n                const clientId = parseInt(document.getElementById('editServiceClientId').value);\n                const servicoId = parseInt(document.getElementById('editServiceId').value);\n                const serviceIndex = parseInt(document.getElementById('editServiceIndex').value);\n                const selectedServiceId = document.getElementById('editServiceServiceSelect').value;\n                const horasContratadas = parseInt(document.getElementById('editServiceHours').value) || 0;\n                const mesesAcumulacao = parseInt(document.getElementById('editServiceAccumulation').value) || 0;\n                const isActive = document.getElementById('editServiceClientActive').checked;\n\n                if (!selectedServiceId) {\n                    showMessage('danger', 'Por favor, selecione um serviço.');\n                    return;\n                }\n\n                const selectedService = rawCadastroServico.find(s => s.id == selectedServiceId);\n                if (!selectedService) {\n                    showMessage('danger', 'Serviço selecionado inválido.');\n                    return;\n                }\n\n                const service = originalN8nData.clientesServicosDetalhado[serviceIndex];\n                if (!service) {\n                    showMessage('danger', 'Serviço não encontrado para atualização.');\n                    return;\n                }\n\n                const payload = {\n                    action: \"update_service\",\n                    clienteId: clientId,\n                    servicoId: servicoId,\n                    nome_servico: selectedService.nome_serviço,\n                    horas_contratadas_mes: horasContratadas,\n                    meses_acumulacao: mesesAcumulacao,\n                    ativo: isActive\n                };\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados de edição do serviço para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        console.log(\"Dados de edição do serviço enviados ao webhook com sucesso:\", payload);\n                        showMessage('success', 'Serviço atualizado com sucesso!');\n                        bootstrap.Modal.getInstance(document.getElementById('editServiceModal')).hide();\n                        // Recarregar a página para obter dados atualizados do backend\n                        setTimeout(() => window.location.reload(), 1500);\n                    } else {\n                        const errorText = await response.text();\n                        showMessage('danger', `Erro ao atualizar serviço: ${response.status} - ${errorText}`);\n                        console.error(\"Erro ao enviar dados de edição do serviço ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    showMessage('danger', `Erro de rede ao atualizar serviço: ${error.message}`);\n                    console.error(\"Erro de rede ao enviar dados de edição do serviço ao webhook:\", error);\n                }\n            };\n\n            function loadMonthlyTracking(clientsServices, monthlyUsage) {\n                const tableBody = document.getElementById('monthlyTrackingTableBody');\n                tableBody.innerHTML = '';\n\n                if (clientsServices.length === 0) {\n                    tableBody.innerHTML = `<tr><td colspan=\"19\" class=\"text-center text-muted\">Nenhum serviço para acompanhamento.</td></tr>`;\n                    return;\n                }\n\n                const usageMap = new Map();\n                const dataExistsMap = new Map(); // Mapeia se existe dados lançados para cada mês\n\n                monthlyUsage.forEach(item => {\n                    const key = `${item.clienteId}-${item.servicoId}-${item.ano}`;\n                    if (!usageMap.has(key)) {\n                        usageMap.set(key, {\n                            monthlyHours: Array(12).fill(0),\n                            saldoBancoHoras: Array(12).fill(0)\n                        });\n                        dataExistsMap.set(key, Array(12).fill(false));\n                    }\n                    if (item.mes >= 1 && item.mes <= 12) {\n                        usageMap.get(key).monthlyHours[item.mes - 1] = item.horasUtilizadas || 0;\n                        usageMap.get(key).saldoBancoHoras[item.mes - 1] = item.saldoBancoHoras || 0;\n                        dataExistsMap.get(key)[item.mes - 1] = true; // Marca que existe dados para este mês\n                    }\n                });\n\n                let calculationDetailsHtml = '';\n\n                clientsServices.forEach((service, serviceIndex) => {\n                    const key = `${service.clienteId}-${service.servicoId}-${new Date().getFullYear()}`;\n                    const serviceData = usageMap.get(key) || {\n                        monthlyHours: Array(12).fill(0),\n                        saldoBancoHoras: Array(12).fill(0)\n                    };\n                    const dataExists = dataExistsMap.get(key) || Array(12).fill(false);\n\n                    const monthlyHours = serviceData.monthlyHours;\n                    const calculation = calculateBalance(service.horasContratadas, monthlyHours, service.mesesAcumulacao, dataExists);\n\n                    const saldoAtualClass = calculation.saldoAUtilizar >= 0 ? 'balance-positive' : 'balance-negative';\n                    const acumulaTexto = service.mesesAcumulacao > 0 ? 'Sim' : 'Não';\n\n                    // Gera inputs para os meses, deixando vazio quando não há dados lançados\n                    const monthInputs = monthlyHours.map((h, monthIndex) => {\n                        const value = dataExists[monthIndex] ? h : '';\n                        return `<td class=\"editable-cell\">\n                            <input type=\"number\" value=\"${value}\" class=\"form-control form-control-sm\"\n                                   data-client-id=\"${service.clienteId}\" data-service-id=\"${service.servicoId}\" data-month-index=\"${monthIndex}\"\n                                   data-original-value=\"${value}\" data-has-data=\"${dataExists[monthIndex]}\" oninput=\"trackChange(this)\">\n                        </td>`;\n                    }).join('');\n\n                    const row = `\n                        <tr>\n                            <td>${service.servicoId}</td>\n                            <td class=\"text-start\">${service.nomeCliente}</td>\n                            <td class=\"text-start\">${service.servico}</td>\n                            <td>${service.horasContratadas}h</td>\n                            <td>${acumulaTexto}</td>\n                            <td>${service.mesesAcumulacao}</td>\n                            ${monthInputs}\n                            <td class=\"${saldoAtualClass}\">${calculation.saldoAUtilizar.toFixed(1)}h</td>\n                        </tr>`;\n\n                    // Gera o banco de horas, exibindo vazio quando não há dados\n                    const bancoHorasInputs = calculation.bancoHorasMensal.map((h, monthIndex) => {\n                        if (!dataExists[monthIndex]) {\n                            return `<td></td>`;\n                        }\n                        const balanceClass = h >= 0 ? 'balance-positive' : 'balance-negative';\n                        return `<td class=\"${balanceClass}\">${h.toFixed(1)}</td>`;\n                    }).join('');\n\n                    const bancoHorasRow = `\n                        <tr class=\"banco-horas-row\">\n                            <td></td>\n                            <td class=\"text-start\">Banco de Horas</td>\n                            <td class=\"text-start\">${service.servico}</td>\n                            <td></td>\n                            <td></td>\n                            <td></td>\n                            ${bancoHorasInputs}\n                            <td></td>\n                        </tr>`;\n\n                    tableBody.innerHTML += row + bancoHorasRow;\n\n                    const monthNames = [\"Jan\", \"Fev\", \"Mar\", \"Abr\", \"Mai\", \"Jun\", \"Jul\", \"Ago\", \"Set\", \"Out\", \"Nov\", \"Dez\"];\n                    const activeMesesText = calculation.activeMonthsIndices.map(i => monthNames[i]).join(', ');\n                    const ultimosMesesText = calculation.ultimosQtdTempoMesesAtivos.map(i => monthNames[i]).join(', ');\n\n                    calculationDetailsHtml += `\n                        <div class=\"mb-3\">\n                            <strong>${service.nomeCliente} - ${service.servico}:</strong><br>\n                            Meses Ativos: [${activeMesesText}] (${calculation.mesesAtivos} meses)<br>\n                            Últimos ${service.mesesAcumulacao} Meses Ativos: [${ultimosMesesText}]<br>\n                            Total Horas Contratadas (Período): ${service.horasContratadas.toFixed(1)}h<br>\n                            Total Horas Utilizadas (Período): ${calculation.totalHorasUtilizadas.toFixed(1)}h<br>\n                            Horas Não Utilizadas > ${service.mesesAcumulacao} Meses: ${calculation.horasNaoUtilizadasMais3Meses.toFixed(1)}h<br>\n                            <strong>Saldo a Utilizar: ${calculation.saldoAUtilizar.toFixed(1)}h</strong><br>\n                            Horas Não Utilizadas nos Últimos ${service.mesesAcumulacao} Meses: ${calculation.horasNaoUtilizadasUltimos3Meses.toFixed(1)}h<br>\n                            <span class=\"${calculation.validacao ? 'text-success' : 'text-danger'}\">\n                                Validação: ${calculation.validacao ? 'VERDADEIRO' : 'FALSO'}\n                            </span>\n                        </div>`;\n                });\n\n                document.getElementById('calculationDetails').classList.add('d-none');\n                document.getElementById('calculationDetailsContent').innerHTML = calculationDetailsHtml;\n            }\n\n            window.trackChange = function(inputElement) {\n                const clientId = parseInt(inputElement.dataset.clientId);\n                const serviceId = parseInt(inputElement.dataset.serviceId);\n                const monthIndex = parseInt(inputElement.dataset.monthIndex);\n                const originalValue = inputElement.dataset.originalValue === '' ? null : (parseFloat(inputElement.dataset.originalValue) || 0);\n                const newValue = inputElement.value === '' ? null : (parseFloat(inputElement.value) || 0);\n                const hadData = inputElement.dataset.hasData === 'true';\n\n                const service = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId && c.servicoId === serviceId);\n                if (!service) {\n                    console.error(\"Serviço não encontrado para o ID do cliente e serviço fornecidos.\");\n                    return;\n                }\n\n                const key = `${clientId}-${serviceId}-${monthIndex}`;\n\n                monthlyChanges = monthlyChanges.filter(c => c.key !== key);\n\n                // Verifica se houve mudança (considerando valores nulos)\n                const hasChanged = (originalValue !== newValue) || (!hadData && newValue !== null);\n\n                if (hasChanged) {\n                    monthlyChanges.push({\n                        key,\n                        clientId,\n                        serviceId,\n                        monthIndex,\n                        clientName: service.nomeCliente,\n                        serviceName: service.servico,\n                        originalValue: originalValue,\n                        newValue: newValue\n                    });\n                    inputElement.parentElement.classList.add('changed');\n                } else {\n                    inputElement.parentElement.classList.remove('changed');\n                }\n\n                // Atualiza dados locais\n                const currentYear = new Date().getFullYear();\n                let monthlyUsageEntry = originalN8nData.acompanhamentoMensal.find(item =>\n                    item.clienteId === clientId &&\n                    item.servicoId === serviceId &&\n                    item.ano === currentYear &&\n                    (item.mes - 1) === monthIndex\n                );\n\n                if (newValue !== null) {\n                    if (monthlyUsageEntry) {\n                        monthlyUsageEntry.horasUtilizadas = newValue;\n                    } else {\n                        originalN8nData.acompanhamentoMensal.push({\n                            acompanhamentoId: Math.floor(Math.random() * 1000000),\n                            clienteId: clientId,\n                            servicoId: serviceId,\n                            cliente: service.nomeCliente,\n                            servico: service.servico,\n                            ano: currentYear,\n                            mes: monthIndex + 1,\n                            horasUtilizadas: newValue,\n                            saldoBancoHoras: 0\n                        });\n                    }\n                } else {\n                    // Remove entrada se valor for nulo/vazio\n                    if (monthlyUsageEntry) {\n                        const index = originalN8nData.acompanhamentoMensal.indexOf(monthlyUsageEntry);\n                        originalN8nData.acompanhamentoMensal.splice(index, 1);\n                    }\n                }\n\n                updateRealTimeCalculation(clientId, serviceId);\n                document.getElementById('saveMonthlyChangesBtn').classList.toggle('d-none', monthlyChanges.length === 0);\n            }\n\n            function updateRealTimeCalculation(clientId, serviceId) {\n                const service = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId && c.servicoId === serviceId);\n                if (!service) return;\n\n                const inputs = document.querySelectorAll(`input[data-client-id=\"${clientId}\"][data-service-id=\"${serviceId}\"]`);\n                const monthlyHours = Array(12).fill(0);\n                const dataExists = Array(12).fill(false);\n                \n                inputs.forEach(input => {\n                    const monthIndex = parseInt(input.dataset.monthIndex);\n                    const value = input.value === '' ? 0 : (parseFloat(input.value) || 0);\n                    const hasData = input.value !== '';\n                    \n                    monthlyHours[monthIndex] = value;\n                    dataExists[monthIndex] = hasData;\n                });\n\n                const calculation = calculateBalance(service.horasContratadas, monthlyHours, service.mesesAcumulacao, dataExists);\n                \n                const rowElement = inputs[0].closest('tr');\n                const saldoCell = rowElement.querySelector('td:last-child');\n                saldoCell.textContent = `${calculation.saldoAUtilizar.toFixed(1)}h`;\n                saldoCell.className = calculation.saldoAUtilizar >= 0 ? 'balance-positive' : 'balance-negative';\n\n                const bancoHorasRow = rowElement.nextElementSibling;\n                const bancoHorasCells = bancoHorasRow.querySelectorAll('td');\n                calculation.bancoHorasMensal.forEach((saldoBanco, index) => {\n                    const cellIndex = index + 6;\n                    if (saldoBanco === null || !dataExists[index]) {\n                        bancoHorasCells[cellIndex].textContent = '';\n                        bancoHorasCells[cellIndex].className = '';\n                    } else {\n                        bancoHorasCells[cellIndex].textContent = saldoBanco.toFixed(1);\n                        bancoHorasCells[cellIndex].className = saldoBanco >= 0 ? 'balance-positive' : 'balance-negative';\n                    }\n                });\n            }\n\n            window.openConfirmSaveModal = function() {\n                const modalBody = document.getElementById('confirmSaveModalBody');\n                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmSaveModal'));\n\n                const currentMonthlyChanges = [];\n                document.querySelectorAll('#monthlyTrackingTableBody input[type=\"number\"]').forEach(inputElement => {\n                    const clientId = parseInt(inputElement.dataset.clientId);\n                    const serviceId = parseInt(inputElement.dataset.serviceId);\n                    const monthIndex = parseInt(inputElement.dataset.monthIndex);\n                    const originalValue = inputElement.dataset.originalValue === '' ? null : (parseFloat(inputElement.dataset.originalValue) || 0);\n                    const newValue = inputElement.value === '' ? null : (parseFloat(inputElement.value) || 0);\n                    const hadData = inputElement.dataset.hasData === 'true';\n                    \n                    const service = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId && c.servicoId === serviceId);\n\n                    const hasChanged = (originalValue !== newValue) || (!hadData && newValue !== null);\n\n                    if (hasChanged) {\n                        currentMonthlyChanges.push({\n                            clientId: service.clienteId,\n                            serviceId: service.servicoId,\n                            clientName: service.nomeCliente,\n                            serviceName: service.servico,\n                            monthIndex,\n                            originalValue,\n                            newValue\n                        });\n                    }\n                });\n\n                if (currentMonthlyChanges.length === 0) {\n                    modalBody.innerHTML = '<p>Nenhuma alteração detectada.</p>';\n                    modal.show();\n                    return;\n                }\n\n                let summaryHtml = '<p>As seguintes alterações serão salvas:</p><ul class=\"list-group\">';\n                const months = [\"Jan\", \"Fev\", \"Mar\", \"Abr\", \"Mai\", \"Jun\", \"Jul\", \"Ago\", \"Set\", \"Out\", \"Nov\", \"Dez\"];\n                currentMonthlyChanges.forEach(change => {\n                    const originalText = change.originalValue === null ? 'vazio' : `${change.originalValue.toFixed(1)}h`;\n                    const newText = change.newValue === null ? 'vazio' : `${change.newValue.toFixed(1)}h`;\n                    summaryHtml += `\n                        <li class=\"list-group-item\">\n                            <strong>${change.clientName} - ${change.serviceName}</strong><br>\n                            Mês: ${months[change.monthIndex]} | Valor anterior: ${originalText} | Novo valor: <strong>${newText}</strong>\n                        </li>`;\n                });\n                summaryHtml += '</ul>';\n                modalBody.innerHTML = summaryHtml;\n                modal.show();\n            }\n\n            window.confirmSaveChanges = async function() {\n                bootstrap.Modal.getInstance(document.getElementById('confirmSaveModal')).hide();\n                const saveMonthlyChangesBtn = document.getElementById('saveMonthlyChangesBtn');\n                const originalButtonHtml = saveMonthlyChangesBtn.innerHTML;\n                saveMonthlyChangesBtn.disabled = true;\n                saveMonthlyChangesBtn.innerHTML = `<span class=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span> Salvando...`;\n\n                const changesToSend = [];\n                document.querySelectorAll('#monthlyTrackingTableBody input[type=\"number\"]').forEach(inputElement => {\n                    const clientId = parseInt(inputElement.dataset.clientId);\n                    const serviceId = parseInt(inputElement.dataset.serviceId);\n                    const monthIndex = parseInt(inputElement.dataset.monthIndex);\n                    const originalValue = inputElement.dataset.originalValue === '' ? null : (parseFloat(inputElement.dataset.originalValue) || 0);\n                    const newValue = inputElement.value === '' ? null : (parseFloat(inputElement.value) || 0);\n                    const hadData = inputElement.dataset.hasData === 'true';\n                    \n                    const service = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId && c.servicoId === serviceId);\n\n                    const hasChanged = (originalValue !== newValue) || (!hadData && newValue !== null);\n\n                    if (hasChanged && newValue !== null) {\n                        changesToSend.push({\n                            clientId: service.clienteId,\n                            servicoId: service.servicoId,\n                            nomeCliente: service.nomeCliente,\n                            cnpj: service.cnpj,\n                            status: service.status,\n                            servico: service.servico,\n                            horasContratadas: service.horasContratadas,\n                            horasUtilizadas: newValue,\n                            bancoDeHoras: 0, // Será recalculado no backend ou na próxima carga\n                            valorHora: service.valorHora,\n                            mesesAcumulacao: service.mesesAcumulacao,\n                            ano: new Date().getFullYear(),\n                            mes: monthIndex + 1\n                        });\n                    }\n                });\n\n                const payload = {\n                    monthlyChanges: changesToSend,\n                    action: \"mes_a_mes\"\n                };\n\n                const currentYear = new Date().getFullYear();\n                const updatedMonthlyUsageMap = new Map();\n                (originalN8nData.acompanhamentoMensal || []).forEach(item => {\n                    const key = `${item.clienteId}-${item.servicoId}-${item.ano}-${item.mes}`;\n                    updatedMonthlyUsageMap.set(key, { ...item });\n                });\n\n                changesToSend.forEach(change => {\n                    const key = `${change.clienteId}-${change.servicoId}-${change.ano}-${change.mes}`;\n                    let entry = updatedMonthlyUsageMap.get(key);\n                    if (entry) {\n                        entry.horasUtilizadas = change.horasUtilizadas;\n                    } else {\n                        updatedMonthlyUsageMap.set(key, {\n                            acompanhamentoId: Math.floor(Math.random() * 1000000), // ID temporário se for novo\n                            clienteId: change.clienteId,\n                            servicoId: change.servicoId,\n                            cliente: change.nomeCliente,\n                            servico: change.serviceName,\n                            ano: change.ano,\n                            mes: change.mes,\n                            horasUtilizadas: change.horasUtilizadas,\n                            saldoBancoHoras: 0 // Será recalculado\n                        });\n                    }\n                });\n                originalN8nData.acompanhamentoMensal = Array.from(updatedMonthlyUsageMap.values());\n                \n                monthlyChanges = []; // Limpa as alterações pendentes\n                filtrarDadosGlobal(); // Re-filtra e re-renderiza com os dados atualizados\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n\n                console.log(\"Enviando dados para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: {\n                            'Content-Type': 'application/json'\n                        },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        showMessage('success', 'Alterações salvas com sucesso!');\n                        console.log(\"Dados enviados ao webhook com sucesso:\", payload);\n                    } else {\n                        const errorText = await response.text();\n                        showMessage('danger', `Erro ao salvar alterações: ${response.status} - ${errorText}`);\n                        console.error(\"Erro ao enviar dados ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    showMessage('danger', `Erro de rede ao salvar alterações: ${error.message}`);\n                    console.error(\"Erro de rede ao enviar dados ao webhook:\", error);\n                } finally {\n                    saveMonthlyChangesBtn.disabled = false;\n                    saveMonthlyChangesBtn.innerHTML = originalButtonHtml;\n                }\n            };\n\n            function populateServiceDropdowns(targetSelectId = 'clientServiceSelect') {\n                const serviceSelect = document.getElementById(targetSelectId);\n                serviceSelect.innerHTML = '<option value=\"\">Selecione um serviço</option>';\n                rawCadastroServico.forEach(service => {\n                    serviceSelect.innerHTML += `<option value=\"${service.id}\">${service.nome_serviço}</option>`;\n                });\n            }\n\n            window.filtrarDadosGlobal = function() {\n                const clienteId = document.getElementById('filterClienteGlobal').value;\n                const servicoNome = document.getElementById('filterServicoGlobal').value;\n                const dataInicial = document.getElementById('filterDataInicialGlobal').value;\n                const dataFinal = document.getElementById('filterDataFinalGlobal').value;\n\n                let filteredServices = [...originalN8nData.clientesServicosDetalhado];\n                let filteredAcompanhamento = [...originalN8nData.acompanhamentoMensal];\n\n                // Filtrar por cliente\n                if (clienteId) {\n                    filteredServices = filteredServices.filter(s => s.clienteId == clienteId);\n                    filteredAcompanhamento = filteredAcompanhamento.filter(a => a.clienteId == clienteId);\n                }\n\n                // Filtrar por serviço\n                if (servicoNome) {\n                    filteredServices = filteredServices.filter(s => s.servico === servicoNome);\n                    filteredAcompanhamento = filteredAcompanhamento.filter(a => a.servico === servicoNome);\n                }\n\n                // Filtrar acompanhamento por data\n                if (dataInicial || dataFinal) {\n                    const start = dataInicial ? new Date(dataInicial + \"T00:00:00\") : null;\n                    const end = dataFinal ? new Date(dataFinal + \"T23:59:59\") : null;\n\n                    filteredAcompanhamento = filteredAcompanhamento.filter(item => {\n                        const itemDate = new Date(item.ano, item.mes - 1, 15); // Use mid-month to avoid timezone issues\n                        return (!start || itemDate >= start) && (!end || itemDate <= end);\n                    });\n                }\n                \n                // Recalcular horas utilizadas e banco de horas com base no acompanhamento filtrado\n                filteredServices.forEach(service => {\n                    const monthlyHoursForService = Array(12).fill(0);\n                    const dataExistsForService = Array(12).fill(false);\n                    const currentYear = new Date().getFullYear();\n                    \n                    filteredAcompanhamento\n                        .filter(m => m.clienteId === service.clienteId && m.servicoId === service.servicoId && m.ano === currentYear)\n                        .forEach(item => {\n                            if (item.mes >= 1 && item.mes <= 12) {\n                                monthlyHoursForService[item.mes - 1] = item.horasUtilizadas;\n                                dataExistsForService[item.mes - 1] = true;\n                            }\n                        });\n\n                    const calculation = calculateBalance(service.horasContratadas, monthlyHoursForService, service.mesesAcumulacao, dataExistsForService);\n                    service.horasUtilizadas = calculation.totalHorasUtilizadas;\n                    service.bancoDeHoras = calculation.saldoAUtilizar;\n                });\n\n                // Recalcular estatísticas\n                const stats = {\n                    totalClientes: new Set(filteredServices.map(s => s.clienteId)).size,\n                    clientesAtivos: new Set(filteredServices.filter(s => s.status === 'Ativo').map(s => s.clienteId)).size,\n                    totalHorasContratadas: filteredServices.reduce((sum, s) => sum + (s.horasContratadas || 0), 0),\n                    totalBancoDeHoras: filteredServices.reduce((sum, s) => sum + (s.bancoDeHoras || 0), 0)\n                };\n\n                // Renderizar tudo\n                loadStats(stats);\n                loadClientsTable(filteredServices);\n                loadMonthlyTracking(filteredServices, filteredAcompanhamento);\n                loadServiceDetails(filteredServices, filteredAcompanhamento);\n            }\n            \n            function loadServiceDetails(filteredServices, filteredAcompanhamento) {\n                const container = document.getElementById('serviceDetailsContainer');\n                container.innerHTML = '';\n\n                if (filteredServices.length === 1) {\n                    // Exibe detalhes se apenas um serviço for filtrado\n                    const service = filteredServices[0];\n                    const horasUtilizadasNoPeriodo = service.horasUtilizadas;\n                    const utilizationPercent = service.horasContratadas > 0 ? Math.round((horasUtilizadasNoPeriodo / service.horasContratadas) * 100) : 0;\n                    const bankLimit = 114;\n                    const bankPercent = bankLimit > 0 && service.bancoDeHoras > 0 ? Math.round((service.bancoDeHoras / bankLimit) * 100) : 0;\n\n                    container.innerHTML = `\n                        <div class=\"p-3\">\n                            <h6><strong>${service.nomeCliente} - ${service.servico}</strong></h6>\n                            <p class=\"text-muted\">Período: Geral</p>\n                            <div class=\"row g-3\">\n                                <div class=\"col-md-3\"><div class=\"detail-card\"><h4 class=\"text-primary\">${service.horasContratadas}h</h4><small>Horas Contratadas</small></div></div>\n                                <div class=\"col-md-3\"><div class=\"detail-card\"><h4 class=\"text-success\">${horasUtilizadasNoPeriodo.toFixed(1)}h</h4><small>Horas Utilizadas</small><div class=\"progress mt-2\" style=\"height: 5px;\"><div class=\"progress-bar bg-success\" style=\"width: ${utilizationPercent}%\"></div></div><small>${utilizationPercent}%</small></div></div>\n                                <div class=\"col-md-3\"><div class=\"detail-card\"><h4 class=\"text-warning\">${service.bancoDeHoras.toFixed(1)}h</h4><small>Banco de Horas</small><div class=\"progress mt-2\" style=\"height: 5px;\"><div class=\"progress-bar bg-warning\" style=\"width: ${bankPercent}%\"></div></div><small>${bankPercent}% do limite (${bankLimit}h)</small></div></div>\n                                <div class=\"col-md-3\"><div class=\"detail-card\"><h4 class=\"${service.bancoDeHoras >= 0 ? 'text-info' : 'text-danger'}\">${service.bancoDeHoras.toFixed(1)}h</h4><small>Saldo Atual</small></div></div>\n                            </div>\n                            <div class=\"alert alert-info mt-4\">\n                                <h6><i class=\"fas fa-info-circle me-2\"></i>Regras do Banco de Horas</h6>\n                                <ul class=\"mb-0 small\">\n                                    <li>Acumulação permitida: <strong>${service.mesesAcumulacao} meses</strong></li>\n                                    <li>Limite máximo: <strong>114 horas</strong></li>\n                                    <li>Horas não utilizadas são adicionadas ao banco (até ${service.mesesAcumulacao} meses)</li>\n                                    <li>Horas excedentes ao limite são perdidas</li>\n                                </ul>\n                            </div>\n                            <div class=\"row mt-3\">\n                                <div class=\"col-md-12\">\n                                    <button class=\"btn btn-success w-100\" onclick=\"generateReport()\"><i class=\"fas fa-file-excel me-2\"></i>Relatório</button>\n                                </div>\n                            </div>\n                        </div>`;\n                } else {\n                    if (filteredServices.length === 0) {\n                        container.innerHTML = '<p class=\"text-muted text-center\">Nenhum serviço encontrado com os filtros aplicados.</p>';\n                    } else {\n                        container.innerHTML = '<p class=\"text-muted text-center\">Filtre por um único cliente e serviço para ver os detalhes específicos de horas.</p>';\n                    }\n                }\n            }\n\n            document.getElementById('btnFiltrarGlobal').addEventListener('click', filtrarDadosGlobal);\n\n            // --- UNIFIED MODAL LOGIC ---\n            window.openClientModal = (index = null) => {\n                const modalElement = document.getElementById('clientModal');\n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                const title = document.getElementById('clientModalTitle');\n                const form = document.getElementById('clientForm');\n                const serviceSelect = document.getElementById('clientServiceSelect');\n                const serviceHoursInput = document.querySelector('#clientModal .service-item .service-hours');\n                const serviceAccumulationInput = document.querySelector('#clientModal .service-item .service-accumulation');\n                \n                form.reset();\n                document.getElementById('clientId').value = '';\n                populateServiceDropdowns('clientServiceSelect');\n\n                if (index !== null) {\n                    title.textContent = 'Editar Cliente e Serviço';\n                    const client = originalN8nData.clientesServicosDetalhado[index];\n                    if (client) {\n                        document.getElementById('clientId').value = index;\n                        document.getElementById('clientName').value = client.nomeCliente || '';\n                        document.getElementById('clientCnpj').value = client.cnpj || '';\n                        document.getElementById('clientEmail').value = client.email || '';\n                        document.getElementById('clientPhone').value = client.telefone || '';\n                        document.getElementById('clientActive').checked = client.status === 'Ativo';\n                        \n                        const selectedServiceInCatalog = rawCadastroServico.find(s => s.nome_serviço === client.servico);\n                        if (selectedServiceInCatalog) {\n                            serviceSelect.value = selectedServiceInCatalog.id;\n                        } else {\n                            serviceSelect.value = '';\n                        }\n\n                        serviceHoursInput.value = client.horasContratadas || 0;\n                        serviceAccumulationInput.value = client.mesesAcumulacao || 0;\n                    }\n                } else {\n                    title.textContent = 'Novo Cliente';\n                    serviceSelect.value = '';\n                    serviceHoursInput.value = 0;\n                    serviceAccumulationInput.value = 0;\n                    document.getElementById('clientEmail').value = '';\n                    document.getElementById('clientPhone').value = '';\n                }\n                modal.show();\n            };\n\n            window.saveClient = async () => {\n                const index = document.getElementById('clientId').value;\n                const name = document.getElementById('clientName').value;\n                const cnpj = document.getElementById('clientCnpj').value;\n                const email = document.getElementById('clientEmail').value;\n                const phone = document.getElementById('clientPhone').value;\n                const isActive = document.getElementById('clientActive').checked;\n                const selectedServiceId = document.getElementById('clientServiceSelect').value;\n                const horasContratadas = parseInt(document.querySelector('#clientModal .service-item .service-hours').value) || 0;\n                const mesesAcumulacao = parseInt(document.querySelector('#clientModal .service-item .service-accumulation').value) || 0;\n\n                if (!name || !selectedServiceId) {\n                    showMessage('danger', 'Nome do cliente e serviço são obrigatórios.');\n                    return;\n                }\n\n                const selectedService = rawCadastroServico.find(s => s.id == selectedServiceId);\n                if (!selectedService) {\n                    showMessage('danger', 'Serviço selecionado inválido.');\n                    return;\n                }\n\n                let clientPayload = {};\n                let successMessage = '';\n\n                if (index) { // Editando cliente existente\n                    const client = originalN8nData.clientesServicosDetalhado[index];\n                    clientPayload = {\n                        action: \"update_client_service\",\n                        clienteId: client.clienteId,\n                        servicoId: client.servicoId,\n                        nome: name,\n                        cnpj: cnpj,\n                        email: email,\n                        telefone: phone,\n                        ativo: isActive,\n                        nome_servico: selectedService.nome_serviço,\n                        horas_contratadas_mes: horasContratadas,\n                        meses_acumulacao: mesesAcumulacao,\n                        valor_hora: selectedService.valor_hora || 0\n                    };\n                    successMessage = 'Cliente atualizado com sucesso!';\n                } else { // Adicionando novo cliente\n                    const newClientId = originalN8nData.clientesServicosDetalhado.length > 0 ? Math.max(...originalN8nData.clientesServicosDetalhado.map(c => c.clienteId)) + 1 : 1;\n                    const newServiceId = parseInt(selectedServiceId);\n\n                    clientPayload = {\n                        action: \"add_cliente\",\n                        id: newClientId,\n                        nome: name,\n                        cnpj: cnpj,\n                        email: email,\n                        telefone: phone,\n                        ativo: isActive,\n                        servico_contratado: {\n                            id: newServiceId,\n                            cliente_id: newClientId,\n                            nome_servico: selectedService.nome_serviço,\n                            horas_contratadas_mes: horasContratadas,\n                            meses_acumulacao: mesesAcumulacao,\n                            valor_hora: selectedService.valor_hora || 0,\n                            created_at: new Date().toISOString()\n                        }\n                    };\n                    successMessage = 'Cliente salvo com sucesso!';\n                }\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados do cliente para o webhook:\", webhookUrl, clientPayload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(clientPayload)\n                    });\n\n                    if (response.ok) {\n                        console.log(\"Dados do cliente enviados ao webhook com sucesso:\", clientPayload);\n                        showMessage('success', successMessage);\n                        bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();\n                        // Recarregar a página para obter dados atualizados do backend\n                        setTimeout(() => window.location.reload(), 1500);\n                    } else {\n                        const errorText = await response.text();\n                        showMessage('danger', `Erro ao salvar cliente: ${response.status} - ${errorText}`);\n                        console.error(\"Erro ao enviar dados do cliente ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    showMessage('danger', `Erro de rede ao salvar cliente: ${error.message}`);\n                    console.error(\"Erro de rede ao enviar dados do cliente ao webhook:\", error);\n                }\n            };\n\n            window.openAddServiceModal = () => {\n                const modalElement = document.getElementById('addServiceModal');\n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                document.getElementById('addServiceForm').reset();\n                modal.show();\n            };\n\n            window.saveService = async () => {\n                const newServiceName = document.getElementById('newServiceName').value;\n                \n                if (!newServiceName) {\n                    showMessage('danger', 'O nome do serviço é obrigatório.');\n                    return;\n                }\n                \n                const newServiceId = rawCadastroServico.length > 0 ? Math.max(...rawCadastroServico.map(s => s.id)) + 1 : 1;\n                const newService = {\n                    id: newServiceId,\n                    nome_serviço: newServiceName,\n                    created_at: new Date().toISOString()\n                };\n                rawCadastroServico.push(newService);\n\n                populateServiceDropdowns('clientServiceSelect');\n                populateServiceDropdowns('addServiceToClientServiceSelect');\n                populateServiceDropdowns('editServiceServiceSelect');\n                \n                bootstrap.Modal.getInstance(document.getElementById('addServiceModal')).hide();\n                showMessage('success', 'Novo serviço adicionado com sucesso! Ele já está disponível para seleção.');\n\n                const payload = {\n                    action: \"add_serv\",\n                    nome_servico: newServiceName\n                };\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados do novo serviço para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        console.log(\"Dados do novo serviço enviados ao webhook com sucesso:\", payload);\n                    } else {\n                        const errorText = await response.text();\n                        console.error(\"Erro ao enviar dados do novo serviço ao webhook:\", response.status, errorText);\n                        rawCadastroServico.pop();\n                        populateServiceDropdowns('clientServiceSelect');\n                        populateServiceDropdowns('addServiceToClientServiceSelect');\n                        populateServiceDropdowns('editServiceServiceSelect');\n                        showMessage('danger', 'Falha ao salvar o novo serviço no servidor.');\n                    }\n                } catch (error) {\n                    console.error(\"Erro de rede ao enviar dados do novo serviço ao webhook:\", error);\n                    rawCadastroServico.pop();\n                    populateServiceDropdowns('clientServiceSelect');\n                    populateServiceDropdowns('addServiceToClientServiceSelect');\n                    populateServiceDropdowns('editServiceServiceSelect');\n                    showMessage('danger', `Erro de rede: ${error.message}`);\n                }\n            };\n\n            // --- FUNÇÕES PARA MODAL ANINHADO COM LOGS DE DEBUG ---\n            window.openNestedAddServiceModal = () => {\n                console.log('🔥 DEBUG: Iniciando abertura do modal aninhado...');\n                \n                const nestedModal = document.getElementById('addServiceNestedModal');\n                console.log('🔍 DEBUG: Modal aninhado encontrado:', nestedModal);\n                \n                if (!nestedModal) {\n                    console.error('❌ DEBUG: Modal aninhado não encontrado!');\n                    return;\n                }\n                \n                // Reset do formulário\n                const form = document.getElementById('addServiceNestedForm');\n                console.log('🔍 DEBUG: Formulário aninhado encontrado:', form);\n                if (form) {\n                    form.reset();\n                    console.log('✅ DEBUG: Formulário resetado');\n                } else {\n                    console.error('❌ DEBUG: Formulário aninhado não encontrado!');\n                }\n                \n                // Verificar se já existe backdrop\n                const existingBackdrop = document.getElementById('nested-modal-backdrop');\n                if (existingBackdrop) {\n                    console.log('⚠️ DEBUG: Backdrop já existe, removendo...');\n                    existingBackdrop.remove();\n                }\n                \n                // Verificar estado atual do modal pai\n                const parentModal = document.getElementById('addServiceToClientModal');\n                console.log('🔍 DEBUG: Modal pai encontrado:', parentModal);\n                console.log('🔍 DEBUG: Classes do modal pai:', parentModal.classList.toString());\n                \n                // Mostrar o modal aninhado SEM backdrop manual\n                console.log('🚀 DEBUG: Exibindo modal aninhado...');\n                nestedModal.style.display = 'block';\n                nestedModal.classList.add('show');\n                \n                // Focar no campo de entrada\n                const inputField = document.getElementById('newServiceNameNested');\n                if (inputField) {\n                    setTimeout(() => {\n                        inputField.focus();\n                        console.log('✅ DEBUG: Foco definido no campo de entrada');\n                    }, 100);\n                } else {\n                    console.error('❌ DEBUG: Campo de entrada não encontrado!');\n                }\n                \n                console.log('✅ DEBUG: Modal aninhado aberto com sucesso');\n            };\n\n            window.closeNestedAddServiceModal = () => {\n                console.log('🔥 DEBUG: Iniciando fechamento do modal aninhado...');\n                \n                const nestedModal = document.getElementById('addServiceNestedModal');\n                console.log('🔍 DEBUG: Modal aninhado para fechar:', nestedModal);\n                \n                if (!nestedModal) {\n                    console.error('❌ DEBUG: Modal aninhado não encontrado para fechar!');\n                    return;\n                }\n                \n                // Fechar modal\n                nestedModal.style.display = 'none';\n                nestedModal.classList.remove('show');\n                console.log('✅ DEBUG: Modal aninhado fechado');\n                \n                // Limpar qualquer backdrop que possa ter sido criado\n                const backdrop = document.getElementById('nested-modal-backdrop');\n                if (backdrop) {\n                    backdrop.remove();\n                    console.log('✅ DEBUG: Backdrop removido');\n                } else {\n                    console.log('ℹ️ DEBUG: Nenhum backdrop encontrado para remover');\n                }\n                \n                // Verificar se o modal pai ainda está ativo\n                const parentModal = document.getElementById('addServiceToClientModal');\n                console.log('🔍 DEBUG: Estado do modal pai após fechamento:', parentModal.classList.toString());\n                \n                console.log('✅ DEBUG: Fechamento do modal aninhado concluído');\n            };\n\n            window.saveNestedService = async () => {\n                console.log('🔥 DEBUG: Iniciando salvamento do serviço aninhado...');\n                \n                const newServiceName = document.getElementById('newServiceNameNested').value;\n                console.log('🔍 DEBUG: Nome do novo serviço:', newServiceName);\n                \n                if (!newServiceName) {\n                    console.log('⚠️ DEBUG: Nome do serviço vazio, mostrando erro');\n                    showMessage('danger', 'O nome do serviço é obrigatório.');\n                    return;\n                }\n                \n                console.log('🔍 DEBUG: rawCadastroServico atual:', rawCadastroServico);\n                const newServiceId = rawCadastroServico.length > 0 ? Math.max(...rawCadastroServico.map(s => s.id)) + 1 : 1;\n                console.log('🔍 DEBUG: Novo ID do serviço:', newServiceId);\n                \n                const newService = {\n                    id: newServiceId,\n                    nome_serviço: newServiceName,\n                    created_at: new Date().toISOString()\n                };\n                \n                console.log('🔍 DEBUG: Novo serviço criado:', newService);\n                rawCadastroServico.push(newService);\n                console.log('✅ DEBUG: Serviço adicionado ao array local');\n\n                // Atualiza o dropdown do modal pai\n                console.log('🔄 DEBUG: Atualizando dropdown do modal pai...');\n                populateServiceDropdowns('addServiceToClientServiceSelect');\n                \n                // Seleciona automaticamente o novo serviço\n                const dropdown = document.getElementById('addServiceToClientServiceSelect');\n                if (dropdown) {\n                    dropdown.value = newServiceId;\n                    console.log('✅ DEBUG: Novo serviço selecionado automaticamente no dropdown');\n                    \n                    // Trigger change event para validações\n                    const changeEvent = new Event('change', { bubbles: true });\n                    dropdown.dispatchEvent(changeEvent);\n                    console.log('✅ DEBUG: Evento change disparado no dropdown');\n                } else {\n                    console.error('❌ DEBUG: Dropdown do modal pai não encontrado!');\n                }\n                \n                // Fecha o modal aninhado\n                console.log('🔄 DEBUG: Fechando modal aninhado...');\n                closeNestedAddServiceModal();\n                \n                showMessage('success', 'Novo serviço adicionado com sucesso! Ele já está selecionado.');\n\n                const payload = {\n                    action: \"add_serv\",\n                    nome_servico: newServiceName\n                };\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"📡 DEBUG: Enviando dados do novo serviço aninhado para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        console.log(\"✅ DEBUG: Dados do novo serviço aninhado enviados ao webhook com sucesso:\", payload);\n                    } else {\n                        const errorText = await response.text();\n                        console.error(\"❌ DEBUG: Erro ao enviar dados do novo serviço aninhado ao webhook:\", response.status, errorText);\n                        // Reverte mudanças locais em caso de erro\n                        rawCadastroServico.pop();\n                        populateServiceDropdowns('addServiceToClientServiceSelect');\n                        showMessage('danger', 'Falha ao salvar o novo serviço no servidor.');\n                    }\n                } catch (error) {\n                    console.error(\"❌ DEBUG: Erro de rede ao enviar dados do novo serviço aninhado ao webhook:\", error);\n                    // Reverte mudanças locais em caso de erro\n                    rawCadastroServico.pop();\n                    populateServiceDropdowns('addServiceToClientServiceSelect');\n                    showMessage('danger', `Erro de rede: ${error.message}`);\n                }\n                \n                console.log('✅ DEBUG: Salvamento do serviço aninhado concluído');\n            };\n\n            window.viewClientDetails = (index) => {\n                const client = originalN8nData.clientesServicosDetalhado[index];\n                const clientSelect = document.getElementById('filterClienteGlobal');\n                clientSelect.value = client.clienteId;\n                \n                const serviceSelect = document.getElementById('filterServicoGlobal');\n                serviceSelect.value = client.servico;\n\n                filtrarDadosGlobal();\n                \n                const detailsContainer = document.getElementById('serviceDetailsContainer');\n                if(detailsContainer) {\n                    detailsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });\n                }\n            };\n\n            window.generateReport = function() {\n                const clienteId = document.getElementById('filterClienteGlobal').value;\n                const servicoNome = document.getElementById('filterServicoGlobal').value;\n\n                if (!clienteId || !servicoNome) {\n                    showMessage('warning', 'Por favor, selecione um cliente e um serviço para gerar o relatório.');\n                    return;\n                }\n\n                const client = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId == clienteId && c.servico === servicoNome);\n                if (!client) {\n                    showMessage('danger', 'Dados do cliente/serviço não encontrados para gerar o relatório.');\n                    return;\n                }\n\n                const currentYear = new Date().getFullYear();\n                const monthlyUsageForService = (originalN8nData.acompanhamentoMensal || [])\n                    .filter(item => item.clienteId === client.clienteId && item.servicoId === client.servicoId && item.ano === currentYear);\n\n                let csvContent = \"Tipo de Dado,Nome do Cliente,CNPJ,Status,Email,Telefone,Nome do Serviço,Horas Contratadas/Mês,Meses Acumulação,Horas Utilizadas Total,Banco de Horas Atual\\n\";\n                \n                csvContent += `Detalhes do Contrato,${client.nomeCliente},${client.cnpj || 'N/A'},${client.status},${client.email || 'N/A'},${client.telefone || 'N/A'},${client.servico},${client.horasContratadas},${client.mesesAcumulacao},${client.horasUtilizadas.toFixed(1)},${client.bancoDeHoras.toFixed(1)}\\n`;\n\n                csvContent += \"\\nTipo de Dado,Mês,Horas Utilizadas,Saldo Banco de Horas\\n\";\n\n                const monthNames = [\"Janeiro\", \"Fevereiro\", \"Março\", \"Abril\", \"Maio\", \"Junho\", \"Julho\", \"Agosto\", \"Setembro\", \"Outubro\", \"Novembro\", \"Dezembro\"];\n\n                for (let i = 1; i <= 12; i++) {\n                    const monthlyData = monthlyUsageForService.find(item => item.mes === i);\n                    const horasUtilizadas = monthlyData ? monthlyData.horasUtilizadas : 0;\n                    const saldoBancoHoras = monthlyData ? monthlyData.saldoBancoHoras : 0;\n                    csvContent += `Acompanhamento Mensal,${monthNames[i-1]},${horasUtilizadas.toFixed(1)},${saldoBancoHoras.toFixed(1)}\\n`;\n                }\n\n                const filename = `Relatorio_${client.nomeCliente.replace(/\\s/g, '_')}_${client.servico.replace(/\\s/g, '_')}_${currentYear}.csv`;\n                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n                const link = document.createElement('a');\n                link.href = URL.createObjectURL(blob);\n                link.download = filename;\n                document.body.appendChild(link);\n                link.click();\n                document.body.removeChild(link);\n                URL.revokeObjectURL(link.href);\n\n                showMessage('success', `Relatório CSV para ${client.nomeCliente} - ${client.servico} gerado com sucesso!`);\n            };\n\n            // Nova função para exportar dados filtrados\n            window.exportFilteredDataToCSV = function() {\n                const clienteId = document.getElementById('filterClienteGlobal').value;\n                const servicoNome = document.getElementById('filterServicoGlobal').value;\n                const dataInicial = document.getElementById('filterDataInicialGlobal').value;\n                const dataFinal = document.getElementById('filterDataFinalGlobal').value;\n\n                // Aplicar os mesmos filtros da função filtrarDadosGlobal\n                let filteredServices = [...originalN8nData.clientesServicosDetalhado];\n                let filteredAcompanhamento = [...originalN8nData.acompanhamentoMensal];\n\n                // Filtrar por cliente\n                if (clienteId) {\n                    filteredServices = filteredServices.filter(s => s.clienteId == clienteId);\n                    filteredAcompanhamento = filteredAcompanhamento.filter(a => a.clienteId == clienteId);\n                }\n\n                // Filtrar por serviço\n                if (servicoNome) {\n                    filteredServices = filteredServices.filter(s => s.servico === servicoNome);\n                    filteredAcompanhamento = filteredAcompanhamento.filter(a => a.servico === servicoNome);\n                }\n\n                // Filtrar acompanhamento por data\n                if (dataInicial || dataFinal) {\n                    const start = dataInicial ? new Date(dataInicial + \"T00:00:00\") : null;\n                    const end = dataFinal ? new Date(dataFinal + \"T23:59:59\") : null;\n\n                    filteredAcompanhamento = filteredAcompanhamento.filter(item => {\n                        const itemDate = new Date(item.ano, item.mes - 1, 15);\n                        return (!start || itemDate >= start) && (!end || itemDate <= end);\n                    });\n                }\n\n                if (filteredServices.length === 0) {\n                    showMessage('warning', 'Nenhum dado encontrado com os filtros aplicados.');\n                    return;\n                }\n\n                // Recalcular dados conforme filtros e organizar por mês\n                const currentYear = new Date().getFullYear();\n                const processedData = [];\n\n                filteredServices.forEach(service => {\n                    const monthlyHoursForService = Array(12).fill('');\n                    const dataExistsForService = Array(12).fill(false);\n                    \n                    filteredAcompanhamento\n                        .filter(m => m.clienteId === service.clienteId && m.servicoId === service.servicoId && m.ano === currentYear)\n                        .forEach(item => {\n                            if (item.mes >= 1 && item.mes <= 12) {\n                                monthlyHoursForService[item.mes - 1] = item.horasUtilizadas || 0;\n                                dataExistsForService[item.mes - 1] = true;\n                            }\n                        });\n\n                    const calculation = calculateBalance(service.horasContratadas, monthlyHoursForService.map(h => h === '' ? 0 : h), service.mesesAcumulacao, dataExistsForService);\n                    \n                    // Formatar dados mensais para exibição (vazio se não há dados)\n                    const monthlyDisplay = monthlyHoursForService.map((h, idx) => {\n                        if (!dataExistsForService[idx]) return '';\n                        return h;\n                    });\n\n                    processedData.push({\n                        clienteId: service.clienteId,\n                        nomeCliente: service.nomeCliente,\n                        cnpj: service.cnpj || '',\n                        status: service.status,\n                        servicoId: service.servicoId,\n                        nomeServico: service.servico,\n                        horasContratadas: service.horasContratadas,\n                        mesesAcumulacao: service.mesesAcumulacao,\n                        totalHorasUtilizadas: calculation.totalHorasUtilizadas,\n                        saldoAtual: calculation.saldoAUtilizar,\n                        jan: monthlyDisplay[0],\n                        fev: monthlyDisplay[1],\n                        mar: monthlyDisplay[2],\n                        abr: monthlyDisplay[3],\n                        mai: monthlyDisplay[4],\n                        jun: monthlyDisplay[5],\n                        jul: monthlyDisplay[6],\n                        ago: monthlyDisplay[7],\n                        set: monthlyDisplay[8],\n                        out: monthlyDisplay[9],\n                        nov: monthlyDisplay[10],\n                        dez: monthlyDisplay[11]\n                    });\n                });\n\n                // Gerar CSV no formato solicitado\n                let csvContent = '';\n                \n                // Cabeçalho conforme o formato da imagem\n                csvContent += 'ID Cliente,Nome Cliente,CNPJ,Status,ID Serviço,Nome Serviço,,Horas Contratadas,Meses Acumulação,Total Horas Utilizadas (Período),Saldo Atual (Banco de Horas),Jan,Fev,Mar,Abr,Mai,Jun,Jul,Ago,Set,Out,Nov,Dez\\n';\n                \n                // Dados dos serviços\n                processedData.forEach(service => {\n                    csvContent += `${service.clienteId},${service.nomeCliente},\"${service.cnpj}\",${service.status},${service.servicoId},${service.nomeServico},,${service.horasContratadas},${service.mesesAcumulacao},${service.totalHorasUtilizadas},${service.saldoAtual.toFixed(1)},${service.jan},${service.fev},${service.mar},${service.abr},${service.mai},${service.jun},${service.jul},${service.ago},${service.set},${service.out},${service.nov},${service.dez}\\n`;\n                });\n\n                // Download do arquivo\n                const now = new Date();\n                const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');\n                const filename = `Gestao_Clientes_${timestamp}.csv`;\n                \n                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n                const link = document.createElement('a');\n                link.href = URL.createObjectURL(blob);\n                link.download = filename;\n                document.body.appendChild(link);\n                link.click();\n                document.body.removeChild(link);\n                URL.revokeObjectURL(link.href);\n\n                const filterInfo = [];\n                if (clienteId) filterInfo.push(`Cliente: ${originalN8nData.clientesServicosDetalhado.find(c => c.clienteId == clienteId)?.nomeCliente}`);\n                if (servicoNome) filterInfo.push(`Serviço: ${servicoNome}`);\n                if (dataInicial || dataFinal) filterInfo.push(`Período: ${dataInicial || 'início'} até ${dataFinal || 'fim'}`);\n                \n                const filterText = filterInfo.length > 0 ? ` (${filterInfo.join(', ')})` : ' (todos os dados)';\n                showMessage('success', `Dados exportados com sucesso${filterText}! Total de ${filteredServices.length} serviços exportados.`);\n            };\n            \n            // --- NOVAS FUNÇÕES E VARIÁVEIS PARA EXCLUSÃO E EDIÇÃO AGRUPADA ---\n            let servicesToDelete = [];\n\n            window.openClientModalForEditByClient = (clientId) => {\n                // Encontra o primeiro serviço associado ao cliente para preencher o modal de edição.\n                // A lógica do modal de edição existente edita um serviço de cada vez.\n                const firstServiceOfClient = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId);\n                if (firstServiceOfClient) {\n                    const originalIndex = originalN8nData.clientesServicosDetalhado.indexOf(firstServiceOfClient);\n                    openClientModal(originalIndex);\n                }\n            };\n\n            window.openConfirmDeleteModalByClient = (clientId) => {\n                const selectedCheckboxes = document.querySelectorAll(`.service-delete-checkbox[data-client-id=\"${clientId}\"]:checked`);\n                \n                if (selectedCheckboxes.length === 0) {\n                    showMessage('warning', 'Nenhum serviço selecionado para exclusão. Marque a caixa de seleção ao lado do serviço que deseja remover.');\n                    return;\n                }\n\n                servicesToDelete = [];\n                let deleteDetailsHtml = '';\n                const client = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId);\n\n                selectedCheckboxes.forEach(checkbox => {\n                    const servicoId = parseInt(checkbox.value);\n                    const service = originalN8nData.clientesServicosDetalhado.find(s => s.clienteId === clientId && s.servicoId === servicoId);\n                    \n                    if(service) {\n                        servicesToDelete.push({\n                            clienteId: clientId,\n                            servicoId: servicoId,\n                            nomeCliente: client.nomeCliente,\n                            servico: service.servico\n                        });\n\n                        deleteDetailsHtml += `<li class=\"list-group-item\"><strong>Cliente:</strong> ${client.nomeCliente}<br><strong>Serviço:</strong> ${service.servico}</li>`;\n                    }\n                });\n\n                const modalElement = document.getElementById('confirmDeleteModal');\n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                document.getElementById('deleteModalBody').innerHTML = `\n                    <p>Você tem certeza que deseja excluir os seguintes serviços?</p>\n                    <ul class=\"list-group mb-3\">${deleteDetailsHtml}</ul>\n                    <p class=\"text-danger\">Esta ação é irreversível.</p>\n                `;\n                document.getElementById('confirmDeleteBtn').onclick = confirmDeleteClient;\n                modal.show();\n            };\n\n            async function confirmDeleteClient() {\n                if (servicesToDelete.length === 0) {\n                    showMessage('danger', 'Erro: Nenhum serviço selecionado para exclusão.');\n                    return;\n                }\n\n                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));\n                modal.hide();\n\n                const payload = {\n                    action: \"deletar_servicos\", // Ação para deletar múltiplos serviços\n                    servicos: servicesToDelete\n                };\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados de exclusão para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        showMessage('success', `Serviços selecionados foram excluídos com sucesso!`);\n                        console.log(\"Dados de exclusão enviados ao webhook com sucesso:\", payload);\n                        setTimeout(() => window.location.reload(), 1500);\n                    } else {\n                        const errorText = await response.text();\n                        showMessage('danger', `Erro ao excluir serviços: ${response.status} - ${errorText}`);\n                        console.error(\"Erro ao enviar dados de exclusão ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    showMessage('danger', `Erro de rede ao excluir serviços: ${error.message}`);\n                    console.error(\"Erro de rede ao enviar dados de exclusão ao webhook:\", error);\n                } finally {\n                    servicesToDelete = [];\n                }\n            }\n\n            window.openAddServiceToClientModal = (clientId) => {\n                const modalElement = document.getElementById('addServiceToClientModal');\n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                const client = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId);\n\n                if (!client) {\n                    showMessage('danger', 'Erro: Cliente não encontrado para adicionar serviço.');\n                    return;\n                }\n\n                document.getElementById('addServiceToClientId').value = clientId;\n                document.getElementById('addServiceToClientName').textContent = client.nomeCliente;\n                document.getElementById('addServiceToClientNameDisplay').value = client.nomeCliente;\n                document.getElementById('addServiceToClientCnpjDisplay').value = client.cnpj || 'N/A';\n                document.getElementById('addServiceToClientHours').value = 0;\n                document.getElementById('addServiceToClientAccumulation').value = 0;\n                document.getElementById('serviceExistsWarning').classList.add('d-none');\n\n                populateServiceDropdowns('addServiceToClientServiceSelect');\n\n                modal.show();\n            };\n\n            window.checkExistingService = (selectElement) => {\n                const selectedServiceId = selectElement.value;\n                const clientId = parseInt(document.getElementById('addServiceToClientId').value);\n                const serviceExistsWarning = document.getElementById('serviceExistsWarning');\n                const saveButton = document.getElementById('saveNewClientServiceBtn');\n\n                if (!selectedServiceId) {\n                    serviceExistsWarning.classList.add('d-none');\n                    saveButton.disabled = true;\n                    return;\n                }\n\n                const serviceAlreadyAssigned = originalN8nData.clientesServicosDetalhado.some(cs => \n                    cs.clienteId === clientId && \n                    cs.servicoId == selectedServiceId\n                );\n\n                if (serviceAlreadyAssigned) {\n                    serviceExistsWarning.classList.remove('d-none');\n                    saveButton.disabled = true;\n                } else {\n                    serviceExistsWarning.classList.add('d-none');\n                    saveButton.disabled = false;\n                }\n            };\n\n            window.saveNewClientService = async () => {\n                const clientId = parseInt(document.getElementById('addServiceToClientId').value);\n                const selectedServiceId = document.getElementById('addServiceToClientServiceSelect').value;\n                const horasContratadas = parseInt(document.getElementById('addServiceToClientHours').value) || 0;\n                const mesesAcumulacao = parseInt(document.getElementById('addServiceToClientAccumulation').value) || 0;\n\n                if (!selectedServiceId) {\n                    showMessage('danger', 'Por favor, selecione um serviço.');\n                    return;\n                }\n\n                const client = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId);\n                const selectedService = rawCadastroServico.find(s => s.id == selectedServiceId);\n\n                if (!client || !selectedService) {\n                    showMessage('danger', 'Erro: Dados do cliente ou serviço inválidos.');\n                    return;\n                }\n\n                const serviceAlreadyAssigned = originalN8nData.clientesServicosDetalhado.some(cs => \n                    cs.clienteId === clientId && \n                    cs.servicoId == selectedServiceId\n                );\n\n                if (serviceAlreadyAssigned) {\n                    showMessage('warning', `O serviço \"${selectedService.nome_serviço}\" já está cadastrado para este cliente. Por favor, edite-o na tabela principal.`);\n                    return;\n                }\n                \n                const payload = {\n                    action: \"add_servico_cliente\",\n                    clienteId: client.clienteId,\n                    servico_contratado: {\n                        id: selectedService.id,\n                        cliente_id: client.clienteId,\n                        nome_servico: selectedService.nome_serviço,\n                        horas_contratadas_mes: horasContratadas,\n                        meses_acumulacao: mesesAcumulacao,\n                        valor_hora: selectedService.valor_hora || 0,\n                        created_at: new Date().toISOString()\n                    }\n                };\n                \n                bootstrap.Modal.getInstance(document.getElementById('addServiceToClientModal')).hide();\n                showMessage('success', `Novo serviço \"${selectedService.nome_serviço}\" adicionado ao cliente \"${client.nomeCliente}\" com sucesso!`);\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados do novo serviço para cliente para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        console.log(\"Dados do novo serviço para cliente enviados ao webhook com sucesso:\", payload);\n                        setTimeout(() => window.location.reload(), 1500);\n                    } else {\n                        const errorText = await response.text();\n                        console.error(\"Erro ao enviar dados do novo serviço para cliente ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    console.error(\"Erro de rede ao enviar dados do novo serviço para cliente ao webhook:\", error);\n                }\n            };\n            \n            // Inicializa os dados da aplicação de gestão de clientes\n            initializeData();\n        });\n    </script>\n</body>\n</html>"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -240,
        4192
      ],
      "id": "ec290c5b-0045-402c-a1a1-b3414a4428dd",
      "name": "HTML Gestão de clientes"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Resolv Task - Gestão de Parceiros</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <style>\n        :root {\n            --primary-color: #0D6EFD;\n            --secondary-color: #17A2B8;\n            --accent-color: #6C757D;\n            --success-color: #28A745;\n            --warning-color: #FFC107;\n            --danger-color: #DC3545;\n            --light-bg: #F8F9FA;\n            --dark-text: #333333;\n        }\n\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background-color: var(--light-bg);\n            color: var(--dark-text);\n            overflow-x: hidden;\n            opacity: 0;\n            transition: opacity 0.5s ease;\n        }\n\n        body.authenticated {\n            opacity: 1;\n        }\n\n        .auth-loading {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            color: white;\n            transition: opacity 0.5s ease;\n        }\n\n        .auth-loading .spinner-auth {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(255, 255, 255, 0.3);\n            border-top: 4px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n\n        @keyframes spin {\n            0% {\n                transform: rotate(0deg);\n            }\n\n            100% {\n                transform: rotate(360deg);\n            }\n        }\n\n        .sidebar {\n            height: 100vh;\n            width: 280px;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            position: fixed;\n            left: 0;\n            top: 0;\n            transition: transform 0.3s ease;\n            z-index: 1000;\n            overflow-y: auto;\n            display: flex;\n            flex-direction: column;\n        }\n\n        .sidebar.collapsed {\n            transform: translateX(-100%);\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            background-color: white;\n            border-bottom: 1px solid #dee2e6;\n        }\n\n        .sidebar-header .logo {\n            max-width: 150px;\n            height: auto;\n            margin-bottom: 10px;\n        }\n\n        .sidebar-header .text-light {\n            color: var(--dark-text) !important;\n            font-weight: 500;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex-grow: 1;\n        }\n\n        .menu-item {\n            display: block;\n            padding: 15px 25px;\n            color: rgba(255, 255, 255, 0.8);\n            text-decoration: none;\n            transition: all 0.3s ease;\n            border: none;\n            background: none;\n            width: 100%;\n            text-align: left;\n            cursor: pointer;\n        }\n\n        .menu-item:hover,\n        .menu-item.active {\n            background-color: rgba(255, 255, 255, 0.1);\n            color: white;\n        }\n\n        .menu-item i {\n            width: 20px;\n            margin-right: 15px;\n        }\n\n        .main-content {\n            margin-left: 280px;\n            transition: margin-left 0.3s ease;\n            min-height: 100vh;\n            padding: 20px;\n        }\n\n        .main-content.expanded {\n            margin-left: 0;\n        }\n\n        .top-nav {\n            background: white;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n            padding: 15px 25px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            position: sticky;\n            top: 0;\n            z-index: 999;\n            margin-bottom: 20px;\n        }\n\n        .sidebar-toggle {\n            display: block;\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n            color: var(--dark-text);\n        }\n\n        .user-info {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n        .card {\n            border: none;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n            transition: transform 0.3s ease;\n        }\n\n        .card:hover {\n            transform: translateY(-5px);\n        }\n\n        .btn-primary {\n            background-color: var(--primary-color);\n            border-color: var(--primary-color);\n        }\n\n        .btn-primary:hover {\n            background-color: var(--secondary-color);\n            border-color: var(--secondary-color);\n        }\n\n        .stats-card {\n            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);\n            color: white;\n            border-radius: 15px;\n            padding: 25px;\n            margin-bottom: 20px;\n        }\n\n        .stats-number {\n            font-size: 2.5rem;\n            font-weight: bold;\n            margin-bottom: 10px;\n        }\n\n        .debug-info {\n            background-color: #f8f9fa;\n            border: 1px solid #dee2e6;\n            border-radius: 5px;\n            padding: 10px;\n            margin: 10px 0;\n            font-family: monospace;\n            font-size: 12px;\n        }\n\n        .filter-group {\n            display: flex;\n            flex-direction: column;\n            justify-content: flex-end;\n            margin-bottom: 1rem;\n        }\n\n        .filter-group label {\n            margin-bottom: 0.5rem;\n        }\n\n        /* Responsive */\n        @media (max-width: 768px) {\n            .sidebar {\n                transform: translateX(-100%);\n            }\n\n            .sidebar.show {\n                transform: translateX(0);\n            }\n\n            .main-content {\n                margin-left: 0;\n            }\n\n            .sidebar-toggle {\n                display: block;\n            }\n\n            .sidebar-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-color: rgba(0, 0, 0, 0.5);\n                z-index: 1040;\n                opacity: 0;\n                visibility: hidden;\n                transition: all 0.3s ease;\n            }\n\n            .sidebar-overlay.show {\n                opacity: 1;\n                visibility: visible;\n            }\n        }\n    </style>\n</head>\n\n<body>\n\n    <div class=\"auth-loading\" id=\"authLoading\">\n        <div class=\"spinner-auth\"></div>\n        <h4>ResolvTask</h4>\n        <p>Verificando autenticação...</p>\n    </div>\n\n    <div class=\"app-container\" id=\"appContainer\" style=\"display:none;\">\n        <nav class=\"sidebar\" id=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <img src=\"https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png\" alt=\"Resolv AI Logo\" class=\"logo\">\n                <br><br>\n                <h1 class=\"h5 mb-0\"><i class=\"fas fa-bolt me-2\"></i>Task</h1>\n                <small class=\"text-light\">Sistema Integrado de Gestão</small>\n            </div>\n            <div class=\"sidebar-menu\" id=\"sidebarMenu\">\n            </div>\n        </nav>\n\n        <main class=\"main-content\" id=\"mainContent\">\n            <nav class=\"top-nav\">\n                <div class=\"d-flex align-items-center\">\n                    <button class=\"sidebar-toggle\" id=\"sidebarToggle\">\n                        <i class=\"fas fa-bars\"></i>\n                    </button>\n                    <h5 class=\"mb-0 ms-3\" id=\"mainTitle\">Gestão de Parceiros</h5>\n                </div>\n                <div class=\"user-info\">\n                    <div class=\"d-flex align-items-center\">\n                        <i class=\"fas fa-user-circle fs-4 text-primary me-2\"></i>\n                        <span class=\"fw-bold\" id=\"userNameDisplay\">Nome do Usuário</span>\n                    </div>\n                    <button class=\"btn btn-outline-danger btn-sm ms-2\" id=\"logoutButton\" title=\"Sair\" onclick=\"redirectToLogin()\">\n                        <i class=\"fas fa-sign-out-alt\"></i>\n                    </button>\n                </div>\n            </nav>\n\n            <div id=\"main-content-wrapper\">\n                <section class=\"content-section active\" id=\"gestao-parceiros\">\n                    <div class=\"row mb-4 align-items-end\">\n                        <div class=\"col-md-3\">\n                            <div class=\"input-group\">\n                                <span class=\"input-group-text\"><i class=\"fas fa-search\"></i></span>\n                                <input type=\"text\" class=\"form-control\" id=\"searchPartners\" placeholder=\"Buscar parceiros...\" oninput=\"filterPartners()\">\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <select class=\"form-select\" id=\"filterPartnerStatus\" onchange=\"filterPartners()\">\n                                <option value=\"\">Todos os status</option>\n                                <option value=\"active\">Ativos</option>\n                                <option value=\"inactive\">Inativos</option>\n                            </select>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <label for=\"filterStartDate\" class=\"form-label\">Data Início</label>\n                            <input type=\"date\" class=\"form-control\" id=\"filterStartDate\" onchange=\"filterPartners()\">\n                        </div>\n                        <div class=\"col-md-3\">\n                            <label for=\"filterEndDate\" class=\"form-label\">Data Final</label>\n                            <input type=\"date\" class=\"form-control\" id=\"filterEndDate\" onchange=\"filterPartners()\">\n                        </div>\n                    </div>\n\n                    <div class=\"table-responsive\">\n                        <table class=\"table table-hover\">\n                            <thead class=\"table-primary\">\n                                <tr>\n                                    <th>Nome</th>\n                                    <th>CNPJ do Colaborador</th>\n                                    <th>Empresa do Colaborador</th>\n                                    <th>Valor/h Resolv AI</th>\n                                    <th>Valor/h Resolv</th>\n                                    <th>Valor/h Amigu</th>\n                                    <th>Horas/Mês</th>\n                                    <th>Status</th>\n                                    <th>Ações</th>\n                                </tr>\n                            </thead>\n                            <tbody id=\"partnersTableBody\">\n                            </tbody>\n                        </table>\n                    </div>\n\n                    <div class=\"row mt-4\">\n                        <div class=\"col-md-3\">\n                            <div class=\"card text-center\">\n                                <div class=\"card-body\">\n                                    <h5 class=\"card-title text-primary\" id=\"totalPartners\">0</h5>\n                                    <p class=\"card-text\">Total de Parceiros</p>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card text-center\">\n                                <div class=\"card-body\">\n                                    <h5 class=\"card-title text-success\" id=\"activePartners\">0</h5>\n                                    <p class=\"card-text\">Parceiros Ativos</p>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card text-center\">\n                                <div class=\"card-body\">\n                                    <h5 class=\"card-title text-info\" id=\"totalPartnerHours\">0</h5>\n                                    <p class=\"card-text\">Horas no Período</p>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card text-center\">\n                                <div class=\"card-body\">\n                                    <h5 class=\"card-title text-warning\" id=\"totalPartnerValue\">R$ 0,00</h5>\n                                    <p class=\"card-text\">Valor no Período</p>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"card mt-4\">\n                        <div class=\"card-header\">\n                            <h5><i class=\"fas fa-calendar-alt me-2\"></i>Fechamento Mensal de Horas</h5>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"row mb-3\">\n                                <div class=\"col-md-6\">\n                                    <label for=\"closingStartDate\" class=\"form-label\">Data Início</label>\n                                    <input type=\"date\" class=\"form-control\" id=\"closingStartDate\">\n                                </div>\n                                <div class=\"col-md-6\">\n                                    <label for=\"closingEndDate\" class=\"form-label\">Data Final</label>\n                                    <input type=\"date\" class=\"form-control\" id=\"closingEndDate\">\n                                </div>\n                            </div>\n                            <div class=\"mb-3\">\n                                <label for=\"closingPartner\" class=\"form-label\">Parceiro</label>\n                                <select class=\"form-select\" id=\"closingPartner\">\n                                    <option value=\"\">Todos os Parceiros</option>\n                                </select>\n                            </div>\n                            <button class=\"btn btn-primary w-100\" onclick=\"generateMonthlyClosing()\">\n                                <i class=\"fas fa-file-excel me-2\"></i>Gerar Fechamento Mensal\n                            </button>\n                            <div id=\"closingReportContainer\" class=\"mt-3\"></div>\n                        </div>\n                    </div>\n\n                    <div class=\"card mt-4\">\n                        <div class=\"card-header\">\n                            <h5><i class=\"fas fa-building me-2\"></i>Cadastro de Empresas</h5>\n                        </div>\n                        <div class=\"card-body\">\n                            <button class=\"btn btn-primary mb-3\" data-bs-toggle=\"modal\" data-bs-target=\"#companyModal\">\n                                <i class=\"fas fa-plus me-2\"></i>Cadastrar Nova Empresa\n                            </button>\n                            <div class=\"table-responsive\">\n                                <table class=\"table table-hover\">\n                                    <thead class=\"table-info\">\n                                        <tr>\n                                            <th>Razão Social</th>\n                                            <th>CNPJ</th>\n                                            <th>Ações</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody id=\"companiesTableBody\">\n                                    </tbody>\n                                </table>\n                            </div>\n                        </div>\n                    </div>\n                </section>\n            </div>\n        </main>\n\n        <div class=\"sidebar-overlay\" id=\"sidebarOverlay\"></div>\n    </div>\n\n    <div class=\"debug-info\" id=\"debugInfo\" style=\"display: none;\">\n        <h6>Debug Information:</h6>\n        <div id=\"debugContent\"></div>\n    </div>\n\n    <div class=\"modal fade\" id=\"partnerModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"partnerModalTitle\">Novo Parceiro</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"partnerForm\">\n                        <input type=\"hidden\" id=\"partnerId\">\n                        <div class=\"row\">\n                            <div class=\"col-md-6\">\n                                <div class=\"mb-3\">\n                                    <label for=\"partnerName\" class=\"form-label\">Nome do Parceiro *</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"partnerName\" required>\n                                </div>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <div class=\"mb-3\">\n                                    <label for=\"partnerCnpj\" class=\"form-label\">CNPJ do Colaborador</label>\n                                    <input type=\"text\" class=\"form-control\" id=\"partnerCnpj\" placeholder=\"00.000.000/0001-00\">\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"row\">\n                            <div class=\"col-md-4\">\n                                <div class=\"mb-3\">\n                                    <label for=\"partnerHourlyRateResolvAi\" class=\"form-label\">Valor/Hora (Resolv Ai - R$)</label>\n                                    <input type=\"number\" class=\"form-control\" id=\"partnerHourlyRateResolvAi\" step=\"0.01\" placeholder=\"0,00\">\n                                </div>\n                            </div>\n                            <div class=\"col-md-4\">\n                                <div class=\"mb-3\">\n                                    <label for=\"partnerHourlyRateResolv\" class=\"form-label\">Valor/Hora (Resolv - R$)</label>\n                                    <input type=\"number\" class=\"form-control\" id=\"partnerHourlyRateResolv\" step=\"0.01\" placeholder=\"0,00\">\n                                </div>\n                            </div>\n                            <div class=\"col-md-4\">\n                                <div class=\"mb-3\">\n                                    <label for=\"partnerHourlyRateAmigu\" class=\"form-label\">Valor/Hora (Amigu - R$)</label>\n                                    <input type=\"number\" class=\"form-control\" id=\"partnerHourlyRateAmigu\" step=\"0.01\" placeholder=\"0,00\">\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"row\">\n                            <div class=\"col-md-6\">\n                                <div class=\"mb-3\">\n                                    <label for=\"partnerEmail\" class=\"form-label\">E-mail</label>\n                                    <input type=\"email\" class=\"form-control\" id=\"partnerEmail\">\n                                </div>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <div class=\"mb-3\">\n                                    <label for=\"partnerPhone\" class=\"form-label\">Telefone</label>\n                                    <input type=\"tel\" class=\"form-control\" id=\"partnerPhone\" placeholder=\"(00) 00000-0000\">\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"mb-3\">\n                            <div class=\"form-check\">\n                                <input class=\"form-check-input\" type=\"checkbox\" id=\"partnerActive\" checked>\n                                <label class=\"form-check-label\" for=\"partnerActive\">\n                                    Parceiro ativo\n                                </label>\n                            </div>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"savePartner()\">Salvar</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class=\"modal fade\" id=\"companyModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"companyModalTitle\">Cadastrar Nova Empresa</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"companyForm\">\n                        <input type=\"hidden\" id=\"companyId\">\n                        <div class=\"mb-3\">\n                            <label for=\"companyName\" class=\"form-label\">Razão Social *</label>\n                            <input type=\"text\" class=\"form-control\" id=\"companyName\" required>\n                        </div>\n                        <div class=\"mb-3\">\n                            <label for=\"companyCnpj\" class=\"form-label\">CNPJ *</label>\n                            <input type=\"text\" class=\"form-control\" id=\"companyCnpj\" placeholder=\"00.000.000/0001-00\" required>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveCompany()\">Salvar Empresa</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class=\"modal fade\" id=\"confirmDeleteModal\" tabindex=\"-1\" aria-labelledby=\"confirmDeleteModalLabel\" aria-hidden=\"true\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"confirmDeleteModalLabel\">Confirmar Exclusão</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    Tem certeza que deseja excluir este parceiro?\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-danger\" id=\"confirmDeleteButton\">Excluir</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class=\"modal fade\" id=\"confirmDeleteCompanyModal\" tabindex=\"-1\" aria-labelledby=\"confirmDeleteCompanyModalLabel\" aria-hidden=\"true\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"confirmDeleteCompanyModalLabel\">Confirmar Exclusão de Empresa</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    Tem certeza que deseja excluir esta empresa?\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-danger\" id=\"confirmDeleteCompanyButton\">Excluir</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n    <script src=\"https://unpkg.com/xlsx/dist/xlsx.full.min.js\"></script>\n    <script>\n        /**\n         * Exibe uma notificação flutuante.\n         * @param {string} message - A mensagem a ser exibida.\n         * @param {string} type - O tipo de notificação (success, danger, warning, info).\n         */\n        function showNotification(message, type = 'success') {\n            const alertDiv = document.createElement('div');\n            alertDiv.id = `notification-${Date.now()}`;\n            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;\n            alertDiv.style.top = '20px';\n            alertDiv.style.right = '20px';\n            alertDiv.style.zIndex = '9999';\n            alertDiv.innerHTML = `\n                ${message}\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n            `;\n            document.body.appendChild(alertDiv);\n\n            setTimeout(() => {\n                const notification = document.getElementById(alertDiv.id);\n                if (notification) {\n                    const bsAlert = new bootstrap.Alert(notification);\n                    bsAlert.close();\n                }\n            }, 5000);\n        }\n\n        // Funções de navegação do menu lateral\n        function setupNavigation() {\n            const sidebar = document.getElementById('sidebar');\n            const mainContent = document.getElementById('mainContent');\n            const sidebarToggle = document.getElementById('sidebarToggle');\n            const sidebarOverlay = document.getElementById('sidebarOverlay');\n\n            function toggleSidebar() {\n                sidebar.classList.toggle('collapsed');\n                mainContent.classList.toggle('expanded');\n                if (window.innerWidth <= 768) {\n                    sidebar.classList.toggle('show');\n                    sidebarOverlay.classList.toggle('show');\n                }\n            }\n            if (sidebarToggle) {\n                sidebarToggle.addEventListener('click', toggleSidebar);\n            }\n            if (sidebarOverlay) {\n                sidebarOverlay.addEventListener('click', toggleSidebar);\n            }\n        }\n\n        // --- LÓGICA DE AUTENTICAÇÃO E INJEÇÃO DO CONTEÚDO ---\n        const LOGIN_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/login';\n\n        /**\n         * Verifica se as credenciais do usuário (email e nome) estão salvas no localStorage.\n         * @returns {boolean} Retorna true se o usuário estiver logado, caso contrário, false.\n         */\n        function checkLoginStatus() {\n            return localStorage.getItem('loggedInUserEmail') && localStorage.getItem('loggedInUserName');\n        }\n\n        /**\n         * Verifica o papel do usuário (administrador ou colaborador) com base nos dados do nó.\n         * @param {string} userEmail - O e-mail do usuário logado.\n         * @returns {string} Retorna 'admin' ou 'colaborador'.\n         */\n        function checkUserRole(userEmail) {\n            if (!processedDataFromNode || !processedDataFromNode.detalhesColaboradores) {\n                return 'colaborador';\n            }\n            const user = processedDataFromNode.detalhesColaboradores.find(col => col.email === userEmail);\n            return user ? user.tipo : 'colaborador';\n        }\n\n        /**\n         * Limpa os dados de autenticação e redireciona para a página de login.\n         */\n        function redirectToLogin() {\n            localStorage.clear();\n            window.location.href = LOGIN_URL;\n        }\n\n        /**\n         * Esconde a tela de carregamento, exibe o container da aplicação e preenche o nome e o menu do usuário.\n         */\n        function showAuthenticatedInterface() {\n            const authLoading = document.getElementById('authLoading');\n            const appContainer = document.getElementById('appContainer');\n\n            if (authLoading) {\n                authLoading.style.display = 'none';\n            }\n            if (appContainer) {\n                appContainer.style.display = 'block';\n                document.body.classList.add('authenticated');\n            }\n            const userEmail = localStorage.getItem('loggedInUserEmail');\n            const userName = localStorage.getItem('loggedInUserName');\n            const userNameElement = document.getElementById('userNameDisplay');\n\n            if (userNameElement) {\n                userNameElement.textContent = userName || 'Usuário';\n            }\n            renderMenu();\n        }\n\n        /**\n         * Renderiza o menu lateral com base no papel do usuário.\n         */\n        function renderMenu() {\n            const sidebarMenu = document.getElementById('sidebarMenu');\n            const userEmail = localStorage.getItem('loggedInUserEmail');\n            const userRole = checkUserRole(userEmail);\n\n            const menuItems = [{\n                id: 'dashboard',\n                text: 'Dashboard',\n                icon: 'fas fa-chart-line',\n                url: 'https://n8n.dev.resolvrisk.com.br/webhook/resolv',\n                roles: ['admin', 'colaborador']\n            }, {\n                id: 'tasks',\n                text: 'Gerenciador de Tarefas',\n                icon: 'fas fa-tasks',\n                url: 'https://n8n.dev.resolvrisk.com.br/webhook/gerenciadortarefas',\n                roles: ['admin', 'colaborador']\n            }, {\n                id: 'hours',\n                text: 'Gerenciador de Horas',\n                icon: 'fas fa-clock',\n                url: 'https://n8n.dev.resolvrisk.com.br/webhook/taskhoras',\n                roles: ['admin', 'colaborador']\n            }, {\n                id: 'clients',\n                text: 'Gestão de Clientes',\n                icon: 'fas fa-handshake',\n                url: 'https://n8n.dev.resolvrisk.com.br/webhook/gestao_clientes',\n                roles: ['admin']\n            }, {\n                id: 'gestao-parceiros',\n                text: 'Gestão de Parceiros',\n                icon: 'fas fa-handshake-angle',\n                url: 'https://n8n.dev.resolvrisk.com.br/webhook/gestaodeparceiros',\n                roles: ['admin']\n            }, {\n                id: 'team',\n                text: 'Equipe',\n                icon: 'fas fa-users',\n                url: 'https://n8n.dev.resolvrisk.com.br/webhook/equipe',\n                roles: ['admin']\n            }, {\n                id: 'settings',\n                text: 'Configurações',\n                icon: 'fas fa-cog',\n                url: 'https://n8n.dev.resolvrisk.com.br/webhook/conf',\n                roles: ['admin', 'colaborador']\n            }];\n\n            sidebarMenu.innerHTML = '';\n            menuItems.forEach(item => {\n                if (item.roles.includes(userRole)) {\n                    const isActive = window.location.href.includes(item.url);\n                    const link = document.createElement('a');\n                    link.href = item.url;\n                    link.className = `menu-item ${isActive ? 'active' : ''}`;\n                    link.setAttribute('data-menu', item.id);\n                    link.innerHTML = `<i class=\"${item.icon}\"></i>${item.text}`;\n                    sidebarMenu.appendChild(link);\n                }\n            });\n        }\n\n        // --- DATA LOADING AND PROCESSING ---\n        let processedDataFromNode;\n        try {\n            // No N8N, esta linha irá injetar os dados do nó anterior.\n             processedDataFromNode = {{ JSON.stringify($json) }};\n            // Se houver um array, pegue o primeiro objeto\n            if (Array.isArray(processedDataFromNode)) {\n                 processedDataFromNode = processedDataFromNode[0] || {};\n            }\n        } catch (e) {\n            console.error(\"Não foi possível analisar os dados do n8n:\", e);\n            processedDataFromNode = {}; // Fallback para um objeto vazio\n        }\n        \n        // *** CORREÇÃO PRINCIPAL ***\n        // A fonte de dados original `detalhesHoras` estava incorreta.\n        // Vamos agora construir uma fonte de dados confiável a partir de `rawDadosHoras`.\n        let allRawHours = processedDataFromNode.rawDadosHoras || [];\n        let allDetailedHours = allRawHours.map(rawEntry => {\n            const partnerDetail = (processedDataFromNode.detalhesColaboradores || []).find(p => p.nome === rawEntry.responsible);\n            let hourlyRate = 0;\n            if (partnerDetail) {\n                const company = rawEntry.company?.toLowerCase() || '';\n                if (company.includes('resolv ai') || company.includes('resolv tecnologia e inovação')) {\n                    hourlyRate = partnerDetail.valor_hora_resolv_ai;\n                } else if (company.includes('resolv') && !company.includes('ai')) {\n                    hourlyRate = partnerDetail.valor_hora_resolv;\n                } else if (company.includes('amigu')) {\n                    hourlyRate = partnerDetail.valor_hora_amigu;\n                } else {\n                    hourlyRate = partnerDetail.valor_hora_resolv_ai || partnerDetail.valor_hora_resolv || partnerDetail.valor_hora_amigu;\n                }\n            }\n            const hours = parseFloat(String(rawEntry.actualHours || '0').replace(',', '.')) || 0;\n\n            // Normalizando o objeto para o formato esperado pelo resto do script\n            return {\n                id: rawEntry.id,\n                responsavel: rawEntry.responsible,\n                horasReais: hours,\n                timestamp: rawEntry.startDate || rawEntry.timestamp, // Priorizar startDate que é mais consistente\n                projeto: rawEntry.project,\n                empresaContratante: rawEntry.company,\n                status: rawEntry.status,\n                custoTotal: hours * (parseFloat(hourlyRate) || 0),\n                description: rawEntry.description,\n            };\n        });\n        \n        // Mantém a filtragem por status CONCLUÍDO\n        const completedDetailedHours = allDetailedHours.filter(entry => {\n            return entry.status === 'CONCLUÍDO' || entry.status === 'CONCLUÃDO';\n        });\n\n        const companyNameMap = {\n            'Resolv Ai': 'RESOLV TECNOLOGIA E INOVAÇÃO LTDA',\n            'Resolv': 'RESOLV TECNOLOGIA E SERVIÇOS DE INTELIGENCIA EM DADOS LTDA ',\n            'Instituto Amigu': 'INSTITUTO AMIGU ENSINO DE TECNOLOGIA PARA FAMÍLIAS',\n            'Amigu': 'INSTITUTO AMIGU ENSINO DE TECNOLOGIA PARA FAMÍLIAS'\n        };\n\n        function getStandardCompanyName(shortName) {\n            return companyNameMap[shortName] || shortName;\n        }\n\n        function safeParse(value, defaultValue = 0) {\n            if (value === null || value === undefined || value === '') {\n                return defaultValue;\n            }\n            const parsed = parseFloat(String(value).replace(',', '.'));\n            return isNaN(parsed) ? defaultValue : parsed;\n        }\n\n        function parseDate(dateString) {\n            if (!dateString) return null;\n            \n            if (dateString instanceof Date) {\n                return isNaN(dateString.getTime()) ? null : dateString;\n            }\n            \n            const dateStr = String(dateString).trim();\n            if (!dateStr) return null;\n            \n            let parsedDate;\n            \n            if (/^\\d{4}-\\d{2}-\\d{2}/.test(dateStr)) {\n                parsedDate = new Date(dateStr);\n            }\n            else if (/^\\d{1,2}\\/\\d{1,2}\\/\\d{4}/.test(dateStr)) {\n                const [day, month, year] = dateStr.split('/').map(num => parseInt(num, 10));\n                parsedDate = new Date(year, month - 1, day);\n            }\n            else if (/^\\d{1,2}-\\d{1,2}-\\d{4}/.test(dateStr)) {\n                const [month, day, year] = dateStr.split('-').map(num => parseInt(num, 10));\n                parsedDate = new Date(year, month - 1, day);\n            }\n            else {\n                parsedDate = new Date(dateStr);\n            }\n            \n            return isNaN(parsedDate.getTime()) ? null : parsedDate;\n        }\n        \n        function isDateInRange(entryDateStr, startDateStr, endDateStr) {\n            const entryDate = parseDate(entryDateStr);\n            if (!entryDate) {\n                return false;\n            }\n\n            // Normalize the entry date to midnight to ignore time\n            entryDate.setHours(0, 0, 0, 0);\n\n            let afterStart = true;\n            let beforeEnd = true;\n\n            if (startDateStr) {\n                const startDate = parseDate(startDateStr);\n                if (startDate) {\n                    startDate.setHours(0, 0, 0, 0);\n                    afterStart = entryDate >= startDate;\n                }\n            }\n\n            if (endDateStr) {\n                const endDate = parseDate(endDateStr);\n                if (endDate) {\n                    endDate.setHours(0, 0, 0, 0);\n                    beforeEnd = entryDate <= endDate;\n                }\n            }\n\n            return afterStart && beforeEnd;\n        }\n\n\n        if (!processedDataFromNode || !processedDataFromNode.detalhesColaboradores) {\n            console.error('Dados não encontrados ou estrutura inválida. Inicializando com arrays vazios.');\n            showNotification('Erro ao carregar dados do nó anterior. Verifique a estrutura.', 'danger');\n            processedDataFromNode = {\n                detalhesColaboradores: [],\n                rawDadosColaboradores: [],\n                empresasCadastradas: [],\n                horasPorResponsavel: {},\n                custoTotalPorResponsavel: {},\n                detalhesHoras: []\n            };\n        }\n\n        let partnersData = (processedDataFromNode.detalhesColaboradores || [])\n            .map(detail => {\n                const rawData = (processedDataFromNode.rawDadosColaboradores || []).find(raw => raw.email === detail.email);\n                return {\n                    id: detail.id,\n                    name: detail.nome,\n                    cnpjColaborador: rawData?.cnpj || 'N/A',\n                    empresaColaborador: rawData?.razao_social || detail.nome,\n                    active: detail.status === true,\n                    valor_hora_resolv_ai: safeParse(detail.valor_hora_resolv_ai),\n                    valor_hora_resolv: safeParse(detail.valor_hora_resolv),\n                    valor_hora_amigu: safeParse(detail.valor_hora_amigu),\n                    email: detail.email || '',\n                    phone: rawData?.whatsapp || '',\n                    monthlyHours: 0,\n                    isColaborador: rawData ? rawData.colaborador !== false : true\n                };\n            })\n            .filter(partner => partner.isColaborador);\n\n        let companiesData = (processedDataFromNode.empresasCadastradas || []).map(item => ({\n            id: item.id,\n            name: item.razao_social,\n            cnpj: item.cnpj\n        }));\n\n        let filteredPartners = [];\n        let currentReportData = [];\n\n        function getCompanyCnpjByName(companyName) {\n            const company = companiesData.find(c => c.name === companyName);\n            return company ? company.cnpj : '';\n        }\n\n        function calculateHoursForPartnerInDateRange(partnerName, startDate, endDate) {\n            if (!completedDetailedHours) return 0;\n            \n            let totalHours = 0;\n            completedDetailedHours\n                .filter(entry => entry.responsavel === partnerName)\n                .forEach(entry => {\n                    if (isDateInRange(entry.timestamp, startDate, endDate)) {\n                        totalHours += safeParse(entry.horasReais);\n                    }\n                });\n            return totalHours;\n        }\n\n        function calculateCostForPartnerInDateRange(partnerName, startDate, endDate) {\n            if (!completedDetailedHours) return 0;\n            let totalCost = 0;\n\n            completedDetailedHours\n                .filter(entry => entry.responsavel === partnerName)\n                .forEach(entry => {\n                    if (isDateInRange(entry.timestamp, startDate, endDate)) {\n                        totalCost += safeParse(entry.custoTotal);\n                    }\n                });\n            return totalCost;\n        }\n\n        function renderPartnersTable(partnersToDisplay) {\n            const tableBody = document.getElementById('partnersTableBody');\n            if (!tableBody) return;\n\n            tableBody.innerHTML = '';\n            partnersToDisplay.forEach(partner => {\n                const row = tableBody.insertRow();\n                row.innerHTML = `\n                    <td>${partner.name}</td>\n                    <td>${partner.cnpjColaborador}</td>\n                    <td>${partner.empresaColaborador}</td>\n                    <td>R$ ${partner.valor_hora_resolv_ai.toFixed(2)}</td>\n                    <td>R$ ${partner.valor_hora_resolv.toFixed(2)}</td>\n                    <td>R$ ${partner.valor_hora_amigu.toFixed(2)}</td>\n                    <td>${partner.monthlyHours.toFixed(2)}h</td>\n                    <td><span class=\"badge bg-${partner.active ? 'success' : 'secondary'}\">${partner.active ? 'Ativo' : 'Inativo'}</span></td>\n                    <td>\n                        <button class=\"btn btn-sm btn-outline-primary\" onclick=\"editPartner('${partner.id}')\">\n                            <i class=\"fas fa-edit\"></i>\n                        </button>\n                    </td>\n                `;\n            });\n            updatePartnerStats(partnersToDisplay);\n            loadClosingPartnerSelect();\n        }\n\n        function updatePartnerStats(displayedPartners) {\n            const total = partnersData.length;\n            const active = partnersData.filter(p => p.active).length;\n            const totalHours = displayedPartners.reduce((sum, p) => sum + p.monthlyHours, 0);\n\n            let totalValue = 0;\n            const startDate = document.getElementById('filterStartDate')?.value;\n            const endDate = document.getElementById('filterEndDate')?.value;\n\n            displayedPartners.forEach(partner => {\n                totalValue += calculateCostForPartnerInDateRange(partner.name, startDate, endDate);\n            });\n            document.getElementById('totalPartners').textContent = total;\n            document.getElementById('activePartners').textContent = active;\n            document.getElementById('totalPartnerHours').textContent = `${totalHours.toFixed(2)}h`;\n            document.getElementById('totalPartnerValue').textContent = `R$ ${totalValue.toFixed(2)}`;\n        }\n\n        function filterPartners() {\n            const searchTerm = document.getElementById('searchPartners')?.value.toLowerCase() || '';\n            const statusFilter = document.getElementById('filterPartnerStatus')?.value || '';\n            const startDate = document.getElementById('filterStartDate')?.value;\n            const endDate = document.getElementById('filterEndDate')?.value;\n\n            let partnersWithHours = partnersData.map(partner => {\n                const totalHours = calculateHoursForPartnerInDateRange(partner.name, startDate, endDate);\n                return { ...partner,\n                    monthlyHours: totalHours\n                };\n            });\n\n            let filteredResults = partnersWithHours.filter(partner => {\n                const matchesSearch = partner.name.toLowerCase().includes(searchTerm) ||\n                    (partner.cnpjColaborador && partner.cnpjColaborador.includes(searchTerm)) ||\n                    (partner.empresaColaborador && partner.empresaColaborador.toLowerCase().includes(searchTerm));\n\n                let matchesStatus = true;\n                if (statusFilter === 'active') {\n                    matchesStatus = partner.active;\n                } else if (statusFilter === 'inactive') {\n                    matchesStatus = !partner.active;\n                }\n\n                return matchesSearch && matchesStatus;\n            });\n\n            renderPartnersTable(filteredResults);\n        }\n\n        function resetPartnerFilters() {\n            document.getElementById('searchPartners').value = '';\n            document.getElementById('filterPartnerStatus').value = '';\n            document.getElementById('filterStartDate').value = '';\n            document.getElementById('filterEndDate').value = '';\n            filterPartners();\n        }\n\n        function openPartnerModal(partner = null) {\n            const modal = document.getElementById('partnerModal');\n            const title = document.getElementById('partnerModalTitle');\n            const form = document.getElementById('partnerForm');\n            if (partner) {\n                title.textContent = 'Editar Parceiro';\n                document.getElementById('partnerId').value = partner.id;\n                document.getElementById('partnerName').value = partner.name;\n                document.getElementById('partnerCnpj').value = partner.cnpjColaborador !== 'N/A' ? partner.cnpjColaborador : '';\n                document.getElementById('partnerHourlyRateResolvAi').value = partner.valor_hora_resolv_ai || '';\n                document.getElementById('partnerHourlyRateResolv').value = partner.valor_hora_resolv || '';\n                document.getElementById('partnerHourlyRateAmigu').value = partner.valor_hora_amigu || '';\n                document.getElementById('partnerEmail').value = partner.email || '';\n                document.getElementById('partnerPhone').value = partner.phone || '';\n                document.getElementById('partnerActive').checked = partner.active;\n            } else {\n                title.textContent = 'Novo Parceiro';\n                form.reset();\n                document.getElementById('partnerId').value = '';\n                document.getElementById('partnerActive').checked = true;\n            }\n            new bootstrap.Modal(modal).show();\n        }\n\n        async function savePartner() {\n            const id = document.getElementById('partnerId').value;\n            const name = document.getElementById('partnerName').value;\n            const cnpjColaborador = document.getElementById('partnerCnpj').value || '';\n            const valor_hora_resolv_ai = safeParse(document.getElementById('partnerHourlyRateResolvAi').value);\n            const valor_hora_resolv = safeParse(document.getElementById('partnerHourlyRateResolv').value);\n            const valor_hora_amigu = safeParse(document.getElementById('partnerHourlyRateAmigu').value);\n            const email = document.getElementById('partnerEmail').value;\n            const phone = document.getElementById('partnerPhone').value;\n            const active = document.getElementById('partnerActive').checked;\n\n            if (!name) {\n                showNotification('Por favor, preencha o nome do parceiro.', 'danger');\n                return;\n            }\n\n            const isNew = id === '';\n            const action = isNew ? 'add_parceiro' : 'atualiza_colaborador';\n            \n            const partnerDataPayload = {\n                id: isNew ? `new_${Date.now()}` : id,\n                nome: name,\n                cnpj: cnpjColaborador,\n                email: email,\n                whatsapp: phone,\n                status: active,\n                valor_hora_resolv_ai: valor_hora_resolv_ai,\n                valor_hora_resolv: valor_hora_resolv,\n                valor_hora_amigu: valor_hora_amigu\n            };\n\n            const payload = { action, data: partnerDataPayload };\n            const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n\n            try {\n                const response = await fetch(webhookUrl, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(payload)\n                });\n\n                if (response.ok) {\n                    const result = await response.json();\n                    \n                    const updatedPartnerData = {\n                        id: isNew ? (result.id || partnerDataPayload.id) : id,\n                        name: name,\n                        cnpjColaborador: cnpjColaborador || 'N/A',\n                        empresaColaborador: (isNew ? 'N/A' : partnersData.find(p => p.id === id)?.empresaColaborador) || 'N/A',\n                        active: active,\n                        valor_hora_resolv_ai: valor_hora_resolv_ai,\n                        valor_hora_resolv: valor_hora_resolv,\n                        valor_hora_amigu: valor_hora_amigu,\n                        email: email,\n                        phone: phone,\n                        monthlyHours: 0 \n                    };\n\n                    if (isNew) {\n                        partnersData.push(updatedPartnerData);\n                    } else {\n                        const index = partnersData.findIndex(p => p.id === id);\n                        if (index !== -1) {\n                            updatedPartnerData.monthlyHours = partnersData[index].monthlyHours;\n                            partnersData[index] = updatedPartnerData;\n                        }\n                    }\n\n                    filterPartners(); \n                    showNotification(`Parceiro ${isNew ? 'criado' : 'atualizado'} com sucesso!`, 'success');\n                } else {\n                    const errorText = await response.text();\n                    console.error('Erro no webhook:', errorText);\n                    showNotification(`Erro ao salvar parceiro.`, 'danger');\n                }\n            } catch (error) {\n                console.error('Erro na requisição:', error);\n                showNotification(`Erro na requisição: ${error.message}`, 'danger');\n            }\n\n            bootstrap.Modal.getInstance(document.getElementById('partnerModal')).hide();\n        }\n\n        function editPartner(id) {\n            const partner = partnersData.find(p => p.id === id);\n            if (partner) {\n                openPartnerModal(partner);\n            }\n        }\n\n        function deletePartner(id) {\n            const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));\n            document.getElementById('confirmDeleteButton').onclick = async () => {\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                const payload = {\n                    action: 'delete_parceiro',\n                    data: {\n                        id: id\n                    }\n                };\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: {\n                            'Content-Type': 'application/json'\n                        },\n                        body: JSON.stringify(payload)\n                    });\n                    if (response.ok) {\n                        partnersData = partnersData.filter(p => p.id !== id);\n                        filterPartners();\n                        showNotification('Parceiro excluído com sucesso!', 'success');\n                    } else {\n                        const errorText = await response.text();\n                        console.error('Erro ao deletar parceiro:', errorText);\n                        showNotification('Erro ao excluir parceiro.', 'danger');\n                    }\n                } catch (error) {\n                    console.error('Erro na requisição de exclusão:', error);\n                    showNotification(`Erro na requisição: ${error.message}`, 'danger');\n                }\n\n                confirmModal.hide();\n            };\n            confirmModal.show();\n        }\n\n        function loadClosingPartnerSelect() {\n            const select = document.getElementById('closingPartner');\n            if (!select) return;\n\n            select.innerHTML = '<option value=\"\">Todos os Parceiros</option>';\n            partnersData.forEach(partner => {\n                const option = document.createElement('option');\n                option.value = partner.id;\n                option.textContent = partner.name;\n                select.appendChild(option);\n            });\n        }\n\n        function generateMonthlyClosing() {\n            const startDate = document.getElementById('closingStartDate').value;\n            const endDate = document.getElementById('closingEndDate').value;\n            const partnerId = document.getElementById('closingPartner').value;\n            const reportContainer = document.getElementById('closingReportContainer');\n            \n            console.clear(); // Limpa o console para uma nova geração\n            console.log('======================================================');\n            console.log('🚀 INICIANDO GERAÇÃO DE FECHAMENTO MENSAL DETALHADO 🚀');\n            console.log('======================================================');\n\n            if (!startDate || !endDate) {\n                showNotification('Por favor, selecione a Data Início e a Data Final.', 'danger');\n                console.error('ERRO: Datas de início e/ou fim não selecionadas.');\n                return;\n            }\n            console.log(`Período Selecionado: de ${startDate} a ${endDate}`);\n\n            const selectedPartnerObj = partnersData.find(p => p.id === partnerId);\n            const partnerName = selectedPartnerObj ? selectedPartnerObj.name : \"Todos\";\n            console.log(`Parceiro Selecionado: ${partnerName} (ID: ${partnerId || 'N/A'})`);\n\n            currentReportData = [];\n\n            if (!completedDetailedHours || completedDetailedHours.length === 0) {\n                reportContainer.innerHTML = '<div class=\"alert alert-warning\">Nenhum detalhe de horas concluídas encontrado nos dados.</div>';\n                showNotification('Nenhum dado de horas concluídas encontrado.', 'info');\n                console.warn('AVISO: Array `completedDetailedHours` está vazio.');\n                return;\n            }\n            console.log(`Total de entradas concluídas para processar: ${completedDetailedHours.length}`);\n            \n            // 1. Filtrar por parceiro (se aplicável)\n            let filteredHoursByPartner = completedDetailedHours;\n            if (partnerId && selectedPartnerObj) {\n                filteredHoursByPartner = completedDetailedHours.filter(entry => entry.responsavel === selectedPartnerObj.name);\n                console.log(`Após filtro por parceiro \"${selectedPartnerObj.name}\", restaram ${filteredHoursByPartner.length} entradas.`);\n            }\n\n            // 2. Filtrar por data\n            console.log('\\n--- Iniciando Filtro por Data ---');\n            const filteredHours = filteredHoursByPartner.filter(entry => {\n                if (!entry.responsavel) {\n                     console.log(`Entrada com ID ${entry.id} descartada (sem responsável).`);\n                     return false;\n                }\n                \n                const dateFields = [entry.timestamp, entry.data, entry.startDate, entry.completionDate, entry.created_at, entry.updated_at];\n                \n                for (const dateField of dateFields) {\n                    if (dateField && isDateInRange(dateField, startDate, endDate)) {\n                        console.log(`✅ ID ${entry.id} (${entry.responsavel}) INCLUÍDO. Data Válida: ${dateField}`);\n                        return true; // Encontrou uma data válida no período\n                    }\n                }\n                console.log(`❌ ID ${entry.id} (${entry.responsavel}) DESCARTADO. Nenhuma data no período. (Timestamp: ${entry.timestamp})`);\n                return false; // Nenhuma data no período foi encontrada\n            });\n            console.log(`--- Fim do Filtro por Data. Total de entradas no período: ${filteredHours.length} ---`);\n\n            // 3. Agrupar dados\n            console.log('\\n--- Iniciando Agrupamento por Projeto/Empresa ---');\n            const groupedReportData = {};\n            filteredHours.forEach(entry => {\n                const partner = partnersData.find(p => p.name === entry.responsavel);\n                const projectKey = `${entry.responsavel}-${entry.projeto}-${getStandardCompanyName(entry.empresaContratante)}`;\n\n                if (!groupedReportData[projectKey]) {\n                    let hourlyRate = 0;\n                    if (partner) {\n                        const empresaContratante = entry.empresaContratante?.toLowerCase() || '';\n                        if (empresaContratante.includes('resolv ai') || empresaContratante.includes('resolv tecnologia e inovação')) {\n                            hourlyRate = partner.valor_hora_resolv_ai;\n                        } else if (empresaContratante.includes('resolv') && !empresaContratante.includes('ai')) {\n                            hourlyRate = partner.valor_hora_resolv;\n                        } else if (empresaContratante.includes('amigu')) {\n                            hourlyRate = partner.valor_hora_amigu;\n                        } else {\n                            hourlyRate = partner.valor_hora_resolv_ai || partner.valor_hora_resolv || partner.valor_hora_amigu;\n                        }\n                    }\n\n                    groupedReportData[projectKey] = {\n                        partnerName: entry.responsavel,\n                        partnerCnpj: partner ? partner.cnpjColaborador : 'N/A',\n                        project: entry.projeto || 'Projeto não especificado',\n                        hours: 0,\n                        companyContratante: getStandardCompanyName(entry.empresaContratante),\n                        companyContratanteCnpj: getCompanyCnpjByName(getStandardCompanyName(entry.empresaContratante)),\n                        hourlyRate: hourlyRate,\n                        value: 0,\n                        entries: []\n                    };\n                     console.log(`Novo grupo criado: ${projectKey}`);\n                }\n\n                const hours = safeParse(entry.horasReais);\n                groupedReportData[projectKey].hours += hours;\n                groupedReportData[projectKey].value += hours * groupedReportData[projectKey].hourlyRate;\n                groupedReportData[projectKey].entries.push({\n                    id: entry.id,\n                    timestamp: entry.timestamp,\n                    hours: hours,\n                    description: entry.description\n                });\n            });\n            console.log('--- Fim do Agrupamento ---');\n            \n            currentReportData = Object.values(groupedReportData);\n            \n            let totalHoursReport = currentReportData.reduce((sum, item) => sum + item.hours, 0);\n            let totalValueReport = currentReportData.reduce((sum, item) => sum + item.value, 0);\n\n            console.log('\\n--- RESULTADO FINAL ---');\n            console.log('Dados Finais Agrupados:', currentReportData);\n            console.log(`Total de Horas do Relatório: ${totalHoursReport.toFixed(2)}h`);\n            console.log(`Valor Total do Relatório: R$ ${totalValueReport.toFixed(2)}`);\n            console.log(`Total de Linhas no Relatório (Projetos Agrupados): ${currentReportData.length}`);\n            console.log('======================================================');\n            console.log('✅ GERAÇÃO DE FECHAMENTO CONCLUÍDA ✅');\n            console.log('======================================================');\n\n            if (currentReportData.length === 0) {\n                reportContainer.innerHTML = '<div class=\"alert alert-info\">Nenhum dado encontrado para o período e parceiro selecionados.</div>';\n                showNotification('Nenhum relatório gerado.', 'info');\n                return;\n            }\n\n            let tableHtml = `\n                <h6 class=\"mt-4\">Relatório de Fechamento Mensal - ${formatDate(startDate)} a ${formatDate(endDate)}</h6>\n                <div class=\"alert alert-info\">\n                    <strong>Estatísticas do Relatório:</strong><br>\n                    • Total de entradas processadas: ${filteredHours.length}<br>\n                    • Projetos únicos: ${currentReportData.length}<br>\n                    • Total de horas: ${totalHoursReport.toFixed(2)}h<br>\n                    • Valor total: R$ ${totalValueReport.toFixed(2)}\n                </div>\n                <table class=\"table table-bordered table-striped\">\n                    <thead class=\"table-light\">\n                        <tr>\n                            <th>Parceiro</th>\n                            <th>CNPJ do Colaborador</th>\n                            <th>Projeto</th>\n                            <th>Horas</th>\n                            <th>Valor/Hora</th>\n                            <th>Empresa Contratante</th>\n                            <th>CNPJ da Empresa Contratante</th>\n                            <th>Valor (R$)</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n            `;\n\n            currentReportData.forEach(row => {\n                tableHtml += `\n                    <tr>\n                        <td>${row.partnerName}</td>\n                        <td>${row.partnerCnpj}</td>\n                        <td>${row.project}</td>\n                        <td>${row.hours.toFixed(2)}h</td>\n                        <td>R$ ${row.hourlyRate.toFixed(2)}</td>\n                        <td>${row.companyContratante}</td>\n                        <td>${row.companyContratanteCnpj}</td>\n                        <td>R$ ${row.value.toFixed(2)}</td>\n                    </tr>\n                `;\n            });\n            \n            tableHtml += `\n                    <tr class=\"table-primary\">\n                        <td colspan=\"3\"><strong>Total Geral</strong></td>\n                        <td><strong>${totalHoursReport.toFixed(2)}h</strong></td>\n                        <td></td>\n                        <td colspan=\"2\"></td>\n                        <td><strong>R$ ${totalValueReport.toFixed(2)}</strong></td>\n                    </tr>\n                </tbody>\n                </table>\n                <button class=\"btn btn-success mt-3\" onclick=\"exportMonthlyClosingToExcel()\">\n                    <i class=\"fas fa-file-excel me-2\"></i>Exportar para Excel\n                </button>\n            `;\n\n            reportContainer.innerHTML = tableHtml;\n            showNotification('Fechamento mensal gerado com sucesso!', 'success');\n        }\n\n\n        function exportMonthlyClosingToExcel() {\n            if (currentReportData.length === 0) {\n                showNotification('Gere um relatório primeiro para exportar.', 'warning');\n                return;\n            }\n\n            const startDate = document.getElementById('closingStartDate').value;\n            const endDate = document.getElementById('closingEndDate').value;\n            const partnerId = document.getElementById('closingPartner').value;\n            const selectedPartner = partnersData.find(p => p.id === partnerId);\n            const partnerName = selectedPartner ? selectedPartner.name : 'Todos os Parceiros';\n            const partnerCnpj = selectedPartner ? selectedPartner.cnpjColaborador : '';\n\n            const fileName = `Fechamento_Mensal_${formatDate(startDate).replace(/\\//g, '-')}_a_${formatDate(endDate).replace(/\\//g, '-')}_${partnerName.replace(/\\s/g, '_')}.xlsx`;\n\n            const ws_data_header = [\n                [\"ACOMPANHAMENTO DE HORAS PRODUTIVAS PARA INFORMAR | VALIDAR | APROVAR | EMITIR NF | PAGAR NF\"],\n                [],\n                [\"Período:\", formatDate(startDate), \"até\", formatDate(endDate)],\n                [\"Prestador do Serviço:\", `${partnerName} ${partnerCnpj}`],\n                []\n            ];\n\n            const ws_data_table_header = [\"Projeto\", \"Horas Produtivas\", \"Valor (R$)\", \"Empresa Contratante\", \"CNPJ da Empresa Contratante\", \"Solicitante\", \"Aprovador\"];\n            const ws_data_table_rows = [];\n\n            let totalHoursGlobal = 0;\n            let totalValueGlobal = 0;\n            const groupedByCompanyAndProject = {};\n            currentReportData.forEach(row => {\n                const companyKey = `${row.companyContratante}-${row.companyContratanteCnpj}`;\n                if (!groupedByCompanyAndProject[companyKey]) {\n                    groupedByCompanyAndProject[companyKey] = {\n                        companyName: row.companyContratante,\n                        companyCnpj: row.companyContratanteCnpj,\n                        projects: {}\n                    };\n                }\n                const projectKey = row.project;\n                if (!groupedByCompanyAndProject[companyKey].projects[projectKey]) {\n                    groupedByCompanyAndProject[companyKey].projects[projectKey] = {\n                        hours: 0,\n                        value: 0\n                    };\n                }\n                groupedByCompanyAndProject[companyKey].projects[projectKey].hours += row.hours;\n                groupedByCompanyAndProject[companyKey].projects[projectKey].value += row.value;\n            });\n\n            Object.values(groupedByCompanyAndProject).forEach(companyGroup => {\n                Object.entries(companyGroup.projects).forEach(([project, projectData]) => {\n                    ws_data_table_rows.push([\n                        project,\n                        projectData.hours,\n                        projectData.value,\n                        `${companyGroup.companyName}`,\n                        `${companyGroup.companyCnpj}`,\n                        \"\", // Solicitante\n                        \"\", // Aprovador\n                    ]);\n                    totalHoursGlobal += projectData.hours;\n                    totalValueGlobal += projectData.value;\n                });\n            });\n            const totalRow = [\"Total Geral\", totalHoursGlobal, totalValueGlobal, \"\", \"\", \"\", \"\"];\n\n            const ws_data = [...ws_data_header, ws_data_table_header, ...ws_data_table_rows, [], totalRow];\n\n            const wb = XLSX.utils.book_new();\n            const ws = XLSX.utils.aoa_to_sheet(ws_data);\n\n            ws['!merges'] = [{\n                s: {\n                    r: 0,\n                    c: 0\n                },\n                e: {\n                    r: 0,\n                    c: 6\n                }\n            }, {\n                s: {\n                    r: 3,\n                    c: 1\n                },\n                e: {\n                    r: 3,\n                    c: 6\n                }\n            }];\n\n            ws['!cols'] = [{\n                wch: 30\n            }, {\n                wch: 15\n            }, {\n                wch: 15\n            }, {\n                wch: 50\n            }, {\n                wch: 25\n            }, {\n                wch: 25\n            }, {\n                wch: 15\n            }];\n\n            const tableHeaderRowIndex = ws_data_header.length;\n            for (let C = 0; C < ws_data_table_header.length; ++C) {\n                const cell_address = XLSX.utils.encode_cell({\n                    r: tableHeaderRowIndex,\n                    c: C\n                });\n                if (!ws[cell_address]) ws[cell_address] = {};\n                ws[cell_address].s = {\n                    font: {\n                        bold: true\n                    },\n                    border: {\n                        top: {\n                            style: \"thin\"\n                        },\n                        bottom: {\n                            style: \"thin\"\n                        },\n                        left: {\n                            style: \"thin\"\n                        },\n                        right: {\n                            style: \"thin\"\n                        }\n                    }\n                };\n            }\n\n            const summaryRowIndex = ws_data.length - 1;\n            for (let C = 0; C < totalRow.length; ++C) {\n                const cell_address = XLSX.utils.encode_cell({\n                    r: summaryRowIndex,\n                    c: C\n                });\n                if (!ws[cell_address]) ws[cell_address] = {};\n                ws[cell_address].s = {\n                    font: {\n                        bold: true\n                    },\n                    border: {\n                        top: {\n                            style: \"thin\"\n                        },\n                        bottom: {\n                            style: \"thin\"\n                        },\n                        left: {\n                            style: \"thin\"\n                        },\n                        right: {\n                            style: \"thin\"\n                        }\n                    }\n                };\n            }\n            const firstDataRowIndex = tableHeaderRowIndex + 1;\n            for (let R = firstDataRowIndex; R < summaryRowIndex; ++R) {\n                const hoursCell = ws[XLSX.utils.encode_cell({\n                    r: R,\n                    c: 1\n                })];\n                if (hoursCell) {\n                    hoursCell.t = 'n';\n                    hoursCell.z = '0.00\"h\"';\n                }\n                const valueCell = ws[XLSX.utils.encode_cell({\n                    r: R,\n                    c: 2\n                })];\n                if (valueCell) {\n                    valueCell.t = 'n';\n                    valueCell.z = 'R$ #,##0.00';\n                }\n            }\n            const summaryHoursCell = ws[XLSX.utils.encode_cell({\n                r: summaryRowIndex,\n                c: 1\n            })];\n            if (summaryHoursCell) {\n                summaryHoursCell.t = 'n';\n                summaryHoursCell.z = '0.00\"h\"';\n            }\n            const summaryValueCell = ws[XLSX.utils.encode_cell({\n                r: summaryRowIndex,\n                c: 2\n            })];\n            if (summaryValueCell) {\n                summaryValueCell.t = 'n';\n                summaryValueCell.z = 'R$ #,##0.00';\n            }\n\n            XLSX.utils.book_append_sheet(wb, ws, \"Fechamento Mensal\");\n            XLSX.writeFile(wb, fileName);\n            showNotification('Relatório exportado para Excel com sucesso!', 'success');\n        }\n\n        function formatDate(dateString) {\n             if (!dateString) return '';\n             const [year, month, day] = dateString.split('-');\n             return `${day}/${month}/${year}`;\n        }\n\n        function formatCnpj(value) {\n            if (!value) return \"\";\n            value = value.replace(/\\D/g, ''); // Remove caracteres não numéricos\n            value = value.substring(0, 14); // Limita a 14 dígitos\n            value = value.replace(/^(\\d{2})(\\d)/, '$1.$2');\n            value = value.replace(/^(\\d{2})\\.(\\d{3})(\\d)/, '$1.$2.$3');\n            value = value.replace(/\\.(\\d{3})(\\d)/, '.$1/$2');\n            value = value.replace(/(\\d{4})(\\d)/, '$1-$2');\n            return value;\n        }\n\n        // --- Funções de Gerenciamento de Empresas ---\n        function loadCompanies() {\n            const tableBody = document.getElementById('companiesTableBody');\n            if (!tableBody) return;\n            tableBody.innerHTML = '';\n            companiesData.forEach(company => {\n                const row = tableBody.insertRow();\n                row.innerHTML = `\n                    <td>${company.name}</td>\n                    <td>${formatCnpj(company.cnpj)}</td>\n                    <td>\n                        <button class=\"btn btn-sm btn-outline-primary\" onclick=\"editCompany(${company.id})\">\n                            <i class=\"fas fa-edit\"></i>\n                        </button>\n                    </td>\n                `;\n            });\n        }\n\n        function openCompanyModal(company = null) {\n            const modal = document.getElementById('companyModal');\n            const title = document.getElementById('companyModalTitle');\n            const form = document.getElementById('companyForm');\n            if (company) {\n                title.textContent = 'Editar Empresa';\n                document.getElementById('companyId').value = company.id;\n                document.getElementById('companyName').value = company.name;\n                document.getElementById('companyCnpj').value = formatCnpj(company.cnpj);\n            } else {\n                title.textContent = 'Cadastrar Nova Empresa';\n                form.reset();\n                document.getElementById('companyId').value = '';\n            }\n            new bootstrap.Modal(modal).show();\n        }\n\n        async function saveCompany() {\n            const id = document.getElementById('companyId').value;\n            const name = document.getElementById('companyName').value;\n            const cnpj = document.getElementById('companyCnpj').value;\n\n            if (!name || !cnpj) {\n                showNotification('Por favor, preencha a Razão Social e o CNPJ da empresa.', 'danger');\n                return;\n            }\n            \n            const unformattedCnpj = cnpj.replace(/\\D/g, '');\n\n            const isNew = id === '';\n            const action = isNew ? 'add_empresas' : 'update_empresa';\n            const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n\n            const companyPayloadData = {\n                razao_social: name,\n                cnpj: unformattedCnpj\n            };\n\n            if (!isNew) {\n                companyPayloadData.id = id;\n            }\n\n            const payload = {\n                action: action,\n                data: companyPayloadData\n            };\n\n            try {\n                const response = await fetch(webhookUrl, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(payload)\n                });\n\n                if (response.ok) {\n                    const result = await response.json(); \n\n                    if (isNew) {\n                        const newCompany = {\n                            id: result.id || `new_${Date.now()}`,\n                            name: name,\n                            cnpj: unformattedCnpj\n                        };\n                        companiesData.push(newCompany);\n                        showNotification('Empresa cadastrada com sucesso!', 'success');\n                    } else {\n                        const index = companiesData.findIndex(c => c.id == id);\n                        if (index !== -1) {\n                            companiesData[index] = { ...companiesData[index], name, cnpj: unformattedCnpj };\n                            showNotification('Empresa atualizada com sucesso!', 'success');\n                        }\n                    }\n                    loadCompanies();\n                } else {\n                    const errorText = await response.text();\n                    console.error('Erro no webhook:', errorText);\n                    showNotification(`Erro ao salvar empresa. O servidor respondeu com erro.`, 'danger');\n                }\n            } catch (error) {\n                console.error('Erro na requisição fetch:', error);\n                showNotification(`Erro de rede ao tentar salvar a empresa: ${error.message}`, 'danger');\n            }\n\n            bootstrap.Modal.getInstance(document.getElementById('companyModal')).hide();\n        }\n\n        function editCompany(id) {\n            const company = companiesData.find(c => c.id === id);\n            if (company) {\n                openCompanyModal(company);\n            }\n        }\n\n        function deleteCompany(id) {\n            const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeleteCompanyModal'));\n            document.getElementById('confirmDeleteCompanyButton').onclick = () => {\n                companiesData = companiesData.filter(c => c.id !== id);\n                loadCompanies();\n                showNotification('Empresa excluída com sucesso!', 'success');\n                confirmModal.hide();\n            };\n            confirmModal.show();\n        }\n\n        // Inicialização\n        document.addEventListener('DOMContentLoaded', function() {\n            if (!checkLoginStatus()) {\n                console.log('Usuário não autenticado. Redirecionando...');\n                redirectToLogin();\n                return;\n            }\n            console.log('Usuário autenticado. Exibindo interface...');\n            showAuthenticatedInterface();\n            setupNavigation();\n\n            console.log('Iniciando carregamento dos dados...');\n            console.log('Dados processados:', processedDataFromNode);\n\n            const filterStartDate = document.getElementById('filterStartDate');\n            const filterEndDate = document.getElementById('filterEndDate');\n            const closingStartDateInput = document.getElementById('closingStartDate');\n            const closingEndDateInput = document.getElementById('closingEndDate');\n\n            // Definir período padrão como agosto de 2025 para teste\n            filterStartDate.value = '2025-08-01';\n            filterEndDate.value = '2025-08-31';\n            closingStartDateInput.value = '2025-08-01';\n            closingEndDateInput.value = '2025-08-31';\n\n            const companyCnpjInput = document.getElementById('companyCnpj');\n            if(companyCnpjInput) {\n                companyCnpjInput.addEventListener('input', (e) => {\n                    e.target.value = formatCnpj(e.target.value);\n                });\n            }\n\n            try {\n                filterPartners();\n                loadCompanies();\n                showNotification('Dados carregados com sucesso!', 'success');\n                console.log(`Carregados ${partnersData.length} parceiros e ${companiesData.length} empresas`);\n                console.log(`Dados de horas: ${completedDetailedHours.length} entradas concluídas`);\n            } catch (error) {\n                console.error('Erro ao carregar dados:', error);\n                showNotification('Erro ao carregar alguns dados. Verifique o console.', 'warning');\n            }\n        });\n    </script>\n</body>\n\n</html>\n\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -32,
        5296
      ],
      "id": "ef86f149-485f-4a04-bab5-1c8023ed7186",
      "name": "Html Parceiros"
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Resolv Task - Gestão de Clientes</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <style>\n        :root {\n            --primary-color: #0d6efd; /* Cor padrão que será substituída */\n            --secondary-color: #6c757d;\n            --success-color: #198754;\n            --danger-color: #dc3545;\n            --warning-color: #ffc107;\n            --info-color: #0dcaf0;\n            --light-color: #f8f9fa;\n            --dark-color: #212529;\n            --light-bg: #F8F9FA;\n            --dark-text: #333333;\n        }\n        \n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            margin: 0;\n            overflow-x: hidden;\n            background-color: var(--light-bg);\n            color: var(--dark-text);\n        }\n\n        /* Auth Loading Screen */\n        .auth-loading {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n            color: white;\n            transition: opacity 0.5s ease;\n        }\n        .auth-loading .spinner-auth {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(255, 255, 255, 0.3);\n            border-top: 4px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-bottom: 20px;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        .app-container {\n            opacity: 0;\n            transition: opacity 0.5s ease;\n        }\n        .app-container.authenticated {\n            opacity: 1;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            height: 100vh;\n            width: 280px;\n            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);\n            position: fixed;\n            left: 0;\n            top: 0;\n            transition: transform 0.3s ease, background 0.5s ease;\n            z-index: 1000;\n            overflow-y: auto;\n            display: flex;\n            flex-direction: column;\n        }\n        \n        .sidebar.collapsed {\n            transform: translateX(-100%);\n        }\n        \n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            background-color: white;\n            border-bottom: 1px solid #dee2e6;\n        }\n        .sidebar-header .logo {\n            max-width: 150px;\n            height: auto;\n            margin-bottom: 10px;\n        }\n        .sidebar-header .text-light {\n            color: var(--dark-color) !important;\n            font-weight: 500;\n        }\n        \n        .sidebar-menu {\n            padding: 20px 0;\n            flex-grow: 1;\n        }\n        \n        .menu-item {\n            display: block;\n            padding: 15px 25px;\n            color: rgba(255,255,255,0.8);\n            text-decoration: none;\n            transition: all 0.3s ease;\n            border: none;\n            background: none;\n            width: 100%;\n            text-align: left;\n            cursor: pointer;\n        }\n        \n        .menu-item:hover,\n        .menu-item.active {\n            background-color: rgba(255,255,255,0.1);\n            color: white;\n        }\n\n        .menu-item i {\n            width: 20px;\n            margin-right: 15px;\n        }\n\n        /* Ocultar menus inicialmente para evitar flash */\n        .sidebar-menu .menu-item {\n            display: none;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n        .sidebar-menu .menu-item.show {\n            display: block;\n            opacity: 1;\n        }\n\n        /* Loading state da sidebar */\n        .sidebar-loading {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 40px 20px;\n            color: rgba(255, 255, 255, 0.8);\n            font-size: 0.9rem;\n        }\n        .sidebar-loading .spinner-small {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid rgba(255, 255, 255, 0.8);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin-right: 10px;\n        }\n\n        /* Main Content */\n        .main-content {\n            margin-left: 280px;\n            transition: margin-left 0.3s ease;\n            min-height: 100vh;\n        }\n        \n        #main-content-wrapper {\n            padding: 20px;\n        }\n\n        /* Top Navigation */\n        .top-nav {\n            background: white;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            padding: 15px 25px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            position: sticky;\n            top: 0;\n            z-index: 999;\n        }\n\n        .sidebar-toggle {\n            display: none;\n            background: none;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n        }\n\n        .user-info {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n        /* Content Area */\n        .content-section {\n            background: white;\n            border-radius: 15px;\n            padding: 30px;\n            margin-bottom: 30px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.08);\n        }\n\n        .content-section h3 {\n            color: var(--primary-color);\n            margin-bottom: 25px;\n            padding-bottom: 15px;\n            border-bottom: 2px solid #f0f0f0;\n        }\n\n        /* Client Management App specific styles */\n        .card {\n            border: none;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            transition: transform 0.3s ease;\n            height: 100%;\n        }\n        .card:hover {\n            transform: translateY(-5px);\n        }\n        .stats-card h5 {\n            font-size: 2.5rem;\n            font-weight: bold;\n        }\n        .table thead th {\n            background-color: var(--primary-color);\n            color: white;\n            vertical-align: middle;\n        }\n        .table tbody tr:hover {\n            background-color: rgba(13, 110, 253, 0.1);\n        }\n        .table td {\n            vertical-align: middle;\n        }\n        .badge-status {\n            font-size: 0.85em;\n            padding: 0.5em 0.8em;\n        }\n        .balance-positive {\n            color: var(--success-color);\n            font-weight: bold;\n        }\n        .balance-negative {\n            color: var(--danger-color);\n            font-weight: bold;\n        }\n        .loading-spinner {\n            display: inline-block;\n            width: 20px;\n            height: 20px;\n            border: 3px solid #f3f3f3;\n            border-top: 3px solid var(--primary-color);\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n        .detail-card {\n            background-color: #fff;\n            border: 1px solid #e9ecef;\n            padding: 20px;\n            border-radius: 8px;\n            text-align: center;\n        }\n        .detail-card h4 {\n            font-size: 2rem;\n            font-weight: 700;\n            margin: 0;\n        }\n        .detail-card small {\n            color: #6c757d;\n        }\n        .editable-cell input {\n            width: 100%;\n            border: 1px solid transparent;\n            background-color: transparent;\n            text-align: center;\n            padding: 5px;\n            border-radius: 4px;\n        }\n        .editable-cell input:focus {\n            outline: none;\n            border-color: var(--primary-color);\n            background-color: #fff;\n        }\n        .table .editable-cell.changed {\n            background-color: #fff3cd !important;\n        }\n        .table .editable-cell.changed input {\n            color: var(--success-color);\n            font-weight: bold;\n        }\n        .banco-horas-row {\n            background-color: #f8f9fa;\n            font-style: italic;\n            color: #6c757d;\n        }\n        .validation-info {\n            font-size: 0.85em;\n            color: #6c757d;\n            background-color: #f8f9fa;\n            padding: 10px;\n            border-radius: 5px;\n            margin-top: 10px;\n        }\n\n        /* Responsive Design for Sidebar */\n        @media (max-width: 768px) {\n            .sidebar {\n                transform: translateX(-100%);\n                z-index: 1050;\n            }\n            \n            .sidebar.show {\n                transform: translateX(0);\n            }\n            \n            .sidebar-toggle {\n                display: block;\n            }\n            \n            .main-content {\n                margin-left: 0;\n            }\n            \n            /* Overlay para mobile quando sidebar está aberta */\n            .sidebar-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-color: rgba(0, 0, 0, 0.5);\n                z-index: 1040;\n                opacity: 0;\n                visibility: hidden;\n                transition: all 0.3s ease;\n            }\n            \n            .sidebar-overlay.show {\n                opacity: 1;\n                visibility: visible;\n            }\n        }\n\n        /* Collapse Section Styling */\n        .collapse-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            cursor: pointer;\n            padding: 10px 0;\n            border-bottom: 1px solid #e9ecef;\n            margin-bottom: 15px;\n        }\n        .collapse-header:hover {\n            opacity: 0.8;\n        }\n        .collapse-header h3, .collapse-header h5 {\n            margin-bottom: 0;\n        }\n        .collapse-header .toggle-icon {\n            transition: transform 0.3s ease;\n        }\n        .collapse-header .toggle-icon.rotated {\n            transform: rotate(180deg);\n        }\n        /* Ajuste para o header do Acompanhamento Mês a Mês */\n        #collapseMonthlyTracking .card-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding-right: 15px;\n        }\n        #collapseMonthlyTracking .card-header .btn {\n            margin-left: auto;\n        }\n    </style>\n</head>\n<body>\n    <!-- Tela de carregamento exibida durante a verificação de autenticação -->\n    <div class=\"auth-loading\" id=\"authLoading\">\n        <div class=\"spinner-auth\"></div>\n        <h4>ResolvTask</h4>\n        <p>Verificando autenticação...</p>\n    </div>\n\n    <!-- Container principal da aplicação -->\n    <div class=\"app-container\" id=\"appContainer\">\n        <!-- Sidebar Menu -->\n        <nav class=\"sidebar\" id=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <img src=\"https://raw.githubusercontent.com/luishplleite/logo/2db2a6b0c2a492381751030e5198a1f1123e806e/LOGO-COLORIDO.png\" alt=\"ResolvAI Logo\" class=\"logo\">\n                <br><br>\n                <h1><i class=\"fas fa-bolt me-2\"></i>Task</h1>\n                <small class=\"text-light\">Sistema Integrado de Gestão</small>\n            </div>\n            <div class=\"sidebar-menu\" id=\"sidebarMenu\">\n            <div class=\"sidebar-loading\" id=\"sidebarLoading\">\n                <div class=\"spinner-small\"></div>\n                Carregando menu...\n            </div>\n            <!-- Dashboard - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/resolv'\" data-menu=\"dashboard\">\n                <i class=\"fas fa-chart-line\"></i>Dashboard\n            </button>\n            <!-- Gerenciador de Tarefas - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gerenciadortarefas'\" data-menu=\"tasks\">\n                <i class=\"fas fa-tasks\"></i>Gerenciador de Tarefas\n            </button>\n            <!-- Gerenciador de Horas - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/taskhoras'\" data-menu=\"hours\">\n                <i class=\"fas fa-clock\"></i>Gerenciador de Horas\n            </button>\n            <!-- Gestão de Clientes - Link externo (selecionado por padrão) -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gestao_clientes'\" data-menu=\"clients\">\n                <i class=\"fas fa-handshake\"></i>Gestão de Clientes\n            </button>\n            <!-- Gestão de Parceiros - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/gestaodeparceiros'\" data-menu=\"partners\">\n                <i class=\"fas fa-handshake-angle\"></i>Gestão de Parceiros\n            </button>\n            <!-- Equipe - Link externo -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/equipe'\" data-menu=\"team\">\n                <i class=\"fas fa-users\"></i>Equipe\n            </button>\n            <!-- Configurações - Ação interna (showPage) -->\n            <button class=\"menu-item\" onclick=\"window.location.href='https://n8n.dev.resolvrisk.com.br/webhook/conf'\" data-menu=\"settings\">\n                <i class=\"fas fa-cog\"></i>Configurações\n            </button>\n            </div>\n        </nav>\n\n        <main class=\"main-content\" id=\"mainContent\">\n            <nav class=\"top-nav\">\n                <div class=\"d-flex align-items-center\">\n                    <button class=\"sidebar-toggle\" id=\"sidebarToggle\">\n                        <i class=\"fas fa-bars\"></i>\n                    </button>\n                    <h5 class=\"mb-0 ms-3\" id=\"mainTitle\">Gestão de Clientes</h5>\n                </div>\n                <div class=\"user-info\">\n                    <div class=\"d-flex align-items-center\">\n                        <i class=\"fas fa-user-circle fs-4 text-primary me-2\"></i>\n                        <span class=\"fw-bold\" id=\"userNameDisplay\">Nome do Usuário</span>\n                    </div>\n                    <button class=\"btn btn-outline-danger btn-sm ms-2\" id=\"logoutButton\" title=\"Sair\">\n                        <i class=\"fas fa-sign-out-alt\"></i>\n                    </button>\n                </div>\n            </nav>\n\n            <div id=\"main-content-wrapper\">\n                <!-- Container para mensagens de feedback -->\n                <div id=\"messageContainer\"></div>\n\n                <section class=\"content-section active\" id=\"gestao-clientes\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-4\">\n                        <h3><i class=\"fas fa-building-user me-2\"></i>Gestão de Clientes</h3>\n                        <button class=\"btn btn-primary\" onclick=\"openClientModal()\">\n                            <i class=\"fas fa-plus me-2\"></i>Novo Cliente\n                        </button>\n                    </div>\n\n                    <!-- SEÇÃO DE FILTRO UNIFICADO -->\n                    <div class=\"card mb-4\">\n                        <div class=\"card-header\">\n                            <h5><i class=\"fas fa-filter me-2\"></i>Filtrar Dados</h5>\n                        </div>\n                        <div class=\"card-body\">\n                            <div class=\"row g-3 align-items-end\">\n                                <div class=\"col-md-3\">\n                                    <label for=\"filterClienteGlobal\" class=\"form-label\">Cliente:</label>\n                                    <select class=\"form-select\" id=\"filterClienteGlobal\">\n                                        <option value=\"\">Todos os clientes</option>\n                                    </select>\n                                </div>\n                                <div class=\"col-md-3\">\n                                    <label for=\"filterServicoGlobal\" class=\"form-label\">Serviço:</label>\n                                    <select class=\"form-select\" id=\"filterServicoGlobal\">\n                                        <option value=\"\">Todos os serviços</option>\n                                    </select>\n                                </div>\n                                <div class=\"col-md-2\">\n                                    <label for=\"filterDataInicialGlobal\" class=\"form-label\">Data Inicial:</label>\n                                    <input type=\"date\" class=\"form-control\" id=\"filterDataInicialGlobal\">\n                                </div>\n                                <div class=\"col-md-2\">\n                                    <label for=\"filterDataFinalGlobal\" class=\"form-label\">Data Final:</label>\n                                    <input type=\"date\" class=\"form-control\" id=\"filterDataFinalGlobal\">\n                                </div>\n                                <div class=\"col-md-2 d-flex\">\n                                    <button class=\"btn btn-primary w-100\" id=\"btnFiltrarGlobal\">\n                                        <i class=\"fas fa-search me-2\"></i>Filtrar\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- CONTAINER PARA DADOS FILTRADOS (INICIA VISÍVEL) -->\n                    <div id=\"dadosFiltrados\">\n                        <!-- Seção de Controle de Horas Contratadas -->\n                        <div class=\"card mb-4\">\n                            <div class=\"card-header collapse-header\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseHoursControl\" aria-expanded=\"true\" aria-controls=\"collapseHoursControl\">\n                                <h5><i class=\"fas fa-clock me-2\"></i>Controle de Horas Contratadas</h5>\n                                <i class=\"fas fa-chevron-down toggle-icon\"></i>\n                            </div>\n                            <div class=\"collapse show\" id=\"collapseHoursControl\">\n                                <div class=\"card-body\">\n                                    <div id=\"serviceDetailsContainer\">\n                                        <p class=\"text-muted text-center\">Selecione um único cliente e serviço nos filtros acima para ver os detalhes específicos.</p>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Estatísticas Gerais -->\n                        <div class=\"row mb-4 mt-4\">\n                            <div class=\"col-md-4 mb-3\">\n                                <div class=\"card text-center\">\n                                    <div class=\"card-body\">\n                                        <h5 class=\"card-title text-primary\" id=\"totalClients\"><div class=\"loading-spinner\"></div></h5>\n                                        <p class=\"card-text\">Total de Clientes</p>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-md-4 mb-3\">\n                                <div class=\"card text-center\">\n                                    <div class=\"card-body\">\n                                        <h5 class=\"card-title text-success\" id=\"activeClients\"><div class=\"loading-spinner\"></div></h5>\n                                        <p class=\"card-text\">Clientes Ativos</p>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-md-4 mb-3\">\n                                <div class=\"card text-center\">\n                                    <div class=\"card-body\">\n                                        <h5 class=\"card-title text-info\" id=\"totalContractedHours\"><div class=\"loading-spinner\"></div></h5>\n                                        <p class=\"card-text\">Horas Contratadas</p>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Botão de Exportação -->\n                        <div class=\"row mb-4\">\n                            <div class=\"col-12 text-center\">\n                                <button class=\"btn btn-success btn-lg\" onclick=\"exportFilteredDataToCSV()\">\n                                    <i class=\"fas fa-file-csv me-2\"></i>Exportar Dados Filtrados para CSV\n                                </button>\n                                <small class=\"d-block text-muted mt-2\">Exporta todos os dados atualmente exibidos conforme os filtros aplicados</small>\n                            </div>\n                        </div>\n\n                        <!-- Tabela Principal - Detalhes dos Clientes e Serviços -->\n                        <div class=\"card\">\n                            <div class=\"card-header collapse-header\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseClientDetails\" aria-expanded=\"true\" aria-controls=\"collapseClientDetails\">\n                                <h5><i class=\"fas fa-table me-2\"></i>Detalhes dos Clientes e Serviços</h5>\n                                <i class=\"fas fa-chevron-down toggle-icon\"></i>\n                            </div>\n                            <div class=\"collapse show\" id=\"collapseClientDetails\">\n                                <div class=\"card-body\">\n                                    <div class=\"table-responsive\">\n                                        <table class=\"table table-striped table-hover align-middle\">\n                                            <thead>\n                                                <tr>\n                                                    <th>Nome do Cliente</th>\n                                                    <th>CNPJ</th>\n                                                    <th>Status</th>\n                                                    <th>Horas Contratadas</th>\n                                                    <th>Horas Utilizadas</th>\n                                                    <th>Banco de Horas</th>\n                                                    <th>Serviços</th>\n                                                    <th>Ações</th>\n                                                </tr>\n                                            </thead>\n                                            <tbody id=\"clientsTableBody\"></tbody>\n                                        </table>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Acompanhamento Mensal -->\n                        <div class=\"card mt-4\">\n                            <div class=\"card-header collapse-header d-flex justify-content-between align-items-center\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseMonthlyTracking\" aria-expanded=\"true\" aria-controls=\"collapseMonthlyTracking\">\n                                <h5 class=\"mb-0\"><i class=\"fas fa-calendar-alt me-2\"></i>Acompanhamento Mês a Mês</h5>\n                                <div class=\"d-flex align-items-center\">\n                                    <button class=\"btn btn-success d-none me-2\" id=\"saveMonthlyChangesBtn\" onclick=\"openConfirmSaveModal()\">\n                                        <i class=\"fas fa-save me-2\"></i>Salvar Alterações\n                                    </button>\n                                    <i class=\"fas fa-chevron-down toggle-icon\"></i>\n                                </div>\n                            </div>\n                            <div class=\"collapse show\" id=\"collapseMonthlyTracking\">\n                                <div class=\"card-body\">\n                                    <div class=\"table-responsive\">\n                                        <table class=\"table table-striped table-bordered table-hover align-middle text-center\">\n                                            <thead>\n                                                <tr>\n                                                    <th>ID</th>\n                                                    <th class=\"text-start\">Cliente</th>\n                                                    <th class=\"text-start\">Serviços</th>\n                                                    <th>Horas Contratadas</th>\n                                                    <th>Acumula</th>\n                                                    <th>Qtd Tempo</th>\n                                                    <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>\n                                                    <th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>\n                                                    <th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>\n                                                    <th>Saldo Atual</th>\n                                                </tr>\n                                            </thead>\n                                            <tbody id=\"monthlyTrackingTableBody\"></tbody>\n                                        </table>\n                                    </div>\n                                    <div id=\"calculationDetails\" class=\"validation-info d-none\">\n                                        <h6>Detalhes do Cálculo (para validação):</h6>\n                                        <div id=\"calculationDetailsContent\"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </section>\n            </div>\n        </main>\n        \n        <!-- Sidebar Overlay for Mobile -->\n        <div class=\"sidebar-overlay\" id=\"sidebarOverlay\"></div>\n    </div>\n    \n    <!-- Modais -->\n    <div class=\"modal fade\" id=\"clientModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"clientModalTitle\">Novo Cliente</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"clientForm\">\n                        <input type=\"hidden\" id=\"clientId\">\n                        <div class=\"row mb-3\">\n                            <div class=\"col-md-6\">\n                                <label for=\"clientName\" class=\"form-label\">Nome do Cliente *</label>\n                                <input type=\"text\" class=\"form-control\" id=\"clientName\" required>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <label for=\"clientCnpj\" class=\"form-label\">CNPJ</label>\n                                <input type=\"text\" class=\"form-control\" id=\"clientCnpj\" placeholder=\"00.000.000/0000-00\">\n                            </div>\n                        </div>\n                        <div class=\"row mb-3\">\n                            <div class=\"col-md-6\">\n                                <label for=\"clientEmail\" class=\"form-label\">Email</label>\n                                <input type=\"email\" class=\"form-control\" id=\"clientEmail\">\n                            </div>\n                            <div class=\"col-md-6\">\n                                <label for=\"clientPhone\" class=\"form-label\">Telefone</label>\n                                <input type=\"tel\" class=\"form-control\" id=\"clientPhone\" placeholder=\"(XX) XXXX-XXXX\">\n                            </div>\n                        </div>\n                        <div class=\"mb-4\">\n                            <div class=\"form-check\">\n                                <input class=\"form-check-input\" type=\"checkbox\" id=\"clientActive\" checked>\n                                <label class=\"form-check-label\" for=\"clientActive\">Cliente ativo</label>\n                            </div>\n                        </div>\n                        <div class=\"mb-3\">\n                            <label class=\"form-label h6\">Serviços Contratados</label>\n                            <div id=\"clientServicesContainer\">\n                                <div class=\"service-item p-3 border rounded\">\n                                    <div class=\"row\">\n                                        <div class=\"col-md-12 mb-2 d-flex align-items-end\">\n                                            <div class=\"flex-grow-1 me-2\">\n                                                <label class=\"form-label\">Serviço</label>\n                                                <select class=\"form-select service-name\" id=\"clientServiceSelect\">\n                                                    <!-- Opções de serviço serão carregadas aqui -->\n                                                </select>\n                                            </div>\n                                            <button type=\"button\" class=\"btn btn-outline-primary\" onclick=\"openAddServiceModal()\" title=\"Adicionar novo serviço ao catálogo\">\n                                                <i class=\"fas fa-plus\"></i>\n                                            </button>\n                                        </div>\n                                        <div class=\"col-md-6\">\n                                            <label class=\"form-label\">Horas/Mês</label>\n                                            <input type=\"number\" class=\"form-control service-hours\" value=\"0\">\n                                        </div>\n                                        <div class=\"col-md-6\">\n                                            <label class=\"form-label\">Meses Acum.</label>\n                                            <input type=\"number\" class=\"form-control service-accumulation\" value=\"0\">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveClient()\">Salvar</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- MODAL DE ADICIONAR SERVIÇO (CATÁLOGO) -->\n    <div class=\"modal fade\" id=\"addServiceModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\">Adicionar Novo Serviço</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"addServiceForm\">\n                        <div class=\"mb-3\">\n                            <label for=\"newServiceName\" class=\"form-label\">Nome do Serviço *</label>\n                            <input type=\"text\" class=\"form-control\" id=\"newServiceName\" required>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveService()\">Salvar Serviço</button>\n                </div>\n            </div>\n        </div>\n    </div>\n    \n    <!-- Novo Modal para Adicionar Serviço a Cliente Existente -->\n    <div class=\"modal fade\" id=\"addServiceToClientModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\">Adicionar Novo Serviço para <span id=\"addServiceToClientName\"></span></h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <form id=\"addServiceToClientForm\">\n                        <input type=\"hidden\" id=\"addServiceToClientId\">\n                        <div class=\"row mb-3\">\n                            <div class=\"col-md-6\">\n                                <label for=\"addServiceToClientNameDisplay\" class=\"form-label\">Nome do Cliente</label>\n                                <input type=\"text\" class=\"form-control\" id=\"addServiceToClientNameDisplay\" readonly disabled>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <label for=\"addServiceToClientCnpjDisplay\" class=\"form-label\">CNPJ</label>\n                                <input type=\"text\" class=\"form-control\" id=\"addServiceToClientCnpjDisplay\" readonly disabled>\n                            </div>\n                        </div>\n                        <div class=\"mb-3\">\n                            <label class=\"form-label h6\">Serviços Contratados</label>\n                            <div class=\"service-item p-3 border rounded\">\n                                <div class=\"row\">\n                                    <div class=\"col-md-12 mb-2\">\n                                        <label class=\"form-label\">Serviço</label>\n                                        <select class=\"form-select service-name\" id=\"addServiceToClientServiceSelect\" onchange=\"checkExistingService(this)\">\n                                            <!-- Opções de serviço serão carregadas aqui -->\n                                        </select>\n                                        <div id=\"serviceExistsWarning\" class=\"text-danger mt-2 d-none\">\n                                            Este serviço já está cadastrado para este cliente. Por favor, edite-o na tabela principal.\n                                        </div>\n                                    </div>\n                                    <div class=\"col-md-6\">\n                                        <label class=\"form-label\">Horas/Mês</label>\n                                        <input type=\"number\" class=\"form-control service-hours\" id=\"addServiceToClientHours\" value=\"0\">\n                                    </div>\n                                    <div class=\"col-md-6\">\n                                        <label class=\"form-label\">Meses Acum.</label>\n                                        <input type=\"number\" class=\"form-control service-accumulation\" id=\"addServiceToClientAccumulation\" value=\"0\">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </form>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-primary\" id=\"saveNewClientServiceBtn\" onclick=\"saveNewClientService()\">Adicionar Serviço</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class=\"modal fade\" id=\"confirmSaveModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog modal-lg\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\">Confirmar Alterações</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\" id=\"confirmSaveModalBody\">\n                    <!-- Resumo das alterações será inserido aqui -->\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-success\" onclick=\"confirmSaveChanges()\">Confirmar e Salvar</button>\n                </div>\n            </div>\n        </div>\n    </div>\n    \n    <!-- Novo Modal para Confirmação de Exclusão -->\n    <div class=\"modal fade\" id=\"confirmDeleteModal\" tabindex=\"-1\" aria-labelledby=\"confirmDeleteModalLabel\" aria-hidden=\"true\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"confirmDeleteModalLabel\">Confirmar Exclusão de Cliente/Serviço</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n                </div>\n                <div class=\"modal-body\" id=\"deleteModalBody\">\n                    <!-- Conteúdo dinâmico -->\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancelar</button>\n                    <button type=\"button\" class=\"btn btn-danger\" id=\"confirmDeleteBtn\">Excluir</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n    <script>\n        // --- AUTHENTICATION AND GLOBAL SETTINGS ---\n        const LOGIN_URL = 'https://n8n.dev.resolvrisk.com.br/webhook/login'; // Ensure this matches your login page URL\n\n        /**\n        * Checks if user is logged in by verifying localStorage items.\n        * @returns {boolean} True if user is logged in, false otherwise.\n        */\n        function checkLoginStatus() {\n            return localStorage.getItem('loggedInUserEmail') && localStorage.getItem('loggedInUserName');\n        }\n\n        /**\n        * Redirects user to the login page and clears local storage.\n        */\n        function redirectToLogin() {\n            localStorage.clear();\n            window.location.href = LOGIN_URL;\n        }\n\n        /**\n        * Esconde a tela de carregamento e exibe o container da aplicação.\n        */\n        function showAuthenticatedInterface() {\n            const authLoading = document.getElementById('authLoading');\n            const appContainer = document.getElementById('appContainer');\n            \n            if(authLoading) {\n                authLoading.style.display = 'none';\n            }\n            if(appContainer) {\n                appContainer.classList.add('authenticated');\n            }\n        }\n\n        // --- Functions for dynamic styles and sidebar behavior ---\n        function hexToRgb(hex) {\n            const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;\n        }\n\n        function shadeHexColor(hex, percent) {\n            let f = parseInt(hex.slice(1), 16),\n                t = percent < 0 ? 0 : 255,\n                p = percent < 0 ? percent * -1 : percent,\n                R = f >> 16,\n                G = (f >> 8) & 0x00ff,\n                B = f & 0x0000ff;\n            return (\"#\" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + (Math.round((t - G) * p) + G) * 0x100 + (Math.round((t - B) * p) + B)).toString(16).slice(1));\n        }\n\n        // Função showPage para navegação interna (mantida como no menu original)\n        function showPage(pageId, event) {\n            if (event) event.preventDefault();\n            \n            // Remove classe ativa de todos os itens do menu\n            document.querySelectorAll('.menu-item').forEach(item => {\n                item.classList.remove('active');\n            });\n            \n            // Adiciona classe ativa ao item clicado\n            event.currentTarget.classList.add('active');\n            \n            console.log(`Navegando para página interna: ${pageId}`);\n            // Aqui você pode adicionar lógica para mostrar/ocultar seções da página\n            // Para este caso, como a navegação é externa, esta função é mais um placeholder\n            // para o item \"Configurações\".\n        }\n\n        async function applyDynamicStyles() {\n            // Este URL será substituído pelo n8n em tempo de execução.\n            const url = 'https://n8n.dev.resolvrisk.com.br/webhook/consultaconfiguracoes';\n            try {\n                const response = await fetch(url);\n                if (!response.ok) {\n                    // Se a resposta não for OK, loga o erro e usa cores padrão\n                    console.error(`HTTP error! status: ${response.status}`);\n                    console.warn('⚠️ Não foi possível buscar as configurações de cor. Usando cores padrão.');\n                    return; // Sai da função para usar as cores padrão do CSS\n                }\n                const data = await response.json(); // Assumindo que o webhook retorna JSON diretamente\n\n                if (data && data.length > 0 && data[0].primary_color) {\n                    const primaryColor = data[0].primary_color;\n                    const darkerColor = shadeHexColor(primaryColor, -0.15); // Ajusta o tom para um pouco mais escuro\n                    const primaryRgb = hexToRgb(primaryColor);\n\n                    if (!primaryRgb) {\n                        console.error(\"Cor primária inválida retornada:\", primaryColor);\n                        return;\n                    }\n\n                    document.documentElement.style.setProperty('--primary-color', primaryColor);\n                    \n                    const style = document.createElement('style');\n                    style.innerHTML = `\n                        .sidebar, .auth-loading {\n                            background: linear-gradient(135deg, ${primaryColor} 0%, ${darkerColor} 100%) !important;\n                        }\n                        .btn-primary, .table thead th {\n                            background-color: ${primaryColor} !important;\n                            border-color: ${primaryColor} !important;\n                        }\n                        .btn-primary:hover {\n                            background-color: ${shadeHexColor(primaryColor, -0.1)} !important;\n                            border-color: ${shadeHexColor(primaryColor, -0.1)} !important;\n                        }\n                        .text-primary {\n                            color: ${primaryColor} !important;\n                        }\n                        .progress-bar.bg-primary {\n                            background-color: ${primaryColor} !important;\n                        }\n                        .loading-spinner {\n                            border-top-color: ${primaryColor} !important;\n                        }\n                    `;\n                    document.head.appendChild(style);\n                } else {\n                    console.warn('⚠️ Não foi possível encontrar a cor primária nos dados. Usando cores padrão.');\n                }\n            } catch (error) {\n                console.error('❌ Falha ao buscar ou aplicar estilos dinâmicos:', error);\n                console.warn('⚠️ Ocorreu um erro ao buscar as configurações de cor. Usando cores padrão.');\n            }\n        }\n\n        function adjustMainContentLayout() {\n            const sidebar = document.getElementById('sidebar');\n            const mainContent = document.getElementById('mainContent');\n            const sidebarToggle = document.getElementById('sidebarToggle');\n\n            if (!mainContent) return; // Verificação de segurança\n\n            if (window.innerWidth <= 768) {\n                // Comportamento Mobile\n                if (sidebarToggle) sidebarToggle.style.display = 'block';\n                mainContent.style.marginLeft = '0'; // Conteúdo principal sempre sem margem no mobile\n            } else {\n                // Comportamento Desktop\n                if (sidebarToggle) sidebarToggle.style.display = 'none';\n                if (sidebar.classList.contains('collapsed')) {\n                    mainContent.style.marginLeft = '0';\n                } else {\n                    mainContent.style.marginLeft = '280px'; // Largura da sidebar\n                }\n            }\n        }\n\n        function toggleSidebar() {\n            const sidebar = document.getElementById('sidebar');\n            const overlay = document.getElementById('sidebarOverlay');\n            \n            if (window.innerWidth <= 768) {\n                // Comportamento Mobile\n                sidebar.classList.toggle('show');\n                overlay.classList.toggle('show');\n                document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';\n            } else {\n                // Comportamento Desktop\n                sidebar.classList.toggle('collapsed');\n                adjustMainContentLayout(); // Ajusta a margem do conteúdo principal no toggle do desktop\n            }\n        }\n\n        function applyUIPermissions() {\n            const userType = localStorage.getItem('loggedInUserTipo') || 'admin'; // 'admin' ou 'colaborador'\n\n            // CORREÇÃO: O item 'partners' e 'team' foi adicionado para o perfil 'colaborador'.\n            const menuPermissions = {\n                admin: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'], // Admin tem acesso a tudo\n                colaborador: ['dashboard', 'tasks', 'hours', 'clients', 'partners', 'team', 'settings'] // Adicionado 'clients', 'partners' e 'team'\n            };\n\n            const allowedMenus = menuPermissions[userType] || [];\n\n            const loadingElement = document.getElementById('sidebarLoading');\n            if (loadingElement) {\n                loadingElement.style.display = 'none';\n            }\n\n            document.querySelectorAll('#sidebarMenu .menu-item').forEach((item, index) => {\n                const menuData = item.getAttribute('data-menu');\n                // Se o usuário for admin, mostra todos os menus. Caso contrário, verifica as permissões.\n                if (userType === 'admin' || allowedMenus.includes(menuData)) {\n                    setTimeout(() => {\n                        item.classList.add('show');\n                    }, index * 50); // Efeito de animação stagger\n                } else {\n                    item.classList.remove('show');\n                }\n            });\n        }\n\n\n        function updateUserDisplay() {\n            const userNameDisplay = document.getElementById('userNameDisplay');\n            const userName = localStorage.getItem('loggedInUserName');\n            if (userNameDisplay && userName) {\n                userNameDisplay.textContent = userName;\n            }\n        }\n\n        function setupLogoutButton() {\n            const logoutButton = document.getElementById('logoutButton');\n            if (logoutButton) {\n                logoutButton.addEventListener('click', () => {\n                    localStorage.clear();\n                    window.location.href = LOGIN_URL;\n                });\n            }\n        }\n\n        document.addEventListener('DOMContentLoaded', async function() {\n            console.log('📄 DOM carregado, verificando autenticação...');\n\n            // --- START: Added loggedInUserEmail verification ---\n            if (!checkLoginStatus()) {\n                redirectToLogin();\n                return; // Stop execution if not logged in\n            }\n            // --- END: Added loggedInUserEmail verification ---\n            \n            // Mostra a interface autenticada\n            showAuthenticatedInterface();\n            \n            await applyDynamicStyles(); // Aplica estilos dinâmicos primeiro\n            applyUIPermissions(); // Depois aplica as permissões da UI\n            updateUserDisplay(); // Atualiza o nome do usuário\n            setupLogoutButton(); // Configura o botão de logout\n            adjustMainContentLayout(); // Ajusta o layout inicial do conteúdo principal\n\n            const sidebarToggle = document.getElementById('sidebarToggle');\n            const sidebarOverlay = document.getElementById('sidebarOverlay');\n\n            if (sidebarToggle) {\n                sidebarToggle.addEventListener('click', toggleSidebar);\n            }\n            if (sidebarOverlay) {\n                sidebarOverlay.addEventListener('click', toggleSidebar);\n            }\n\n            // Usa adjustMainContentLayout para eventos de redimensionamento da janela\n            window.addEventListener('resize', adjustMainContentLayout);\n\n            // Define o menu ativo baseado na URL atual, com fallback para 'Gestão de Clientes'\n            const currentPath = window.location.pathname;\n            let isAnyItemActive = false;\n\n            document.querySelectorAll('.menu-item').forEach(item => {\n                item.classList.remove('active'); // Limpa todos os ativos primeiro\n                const menuData = item.getAttribute('data-menu');\n                let shouldBeActive = false;\n\n                if (currentPath.includes('/webhook/resolv') && menuData === 'dashboard') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('gerenciadortarefas') && menuData === 'tasks') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('taskhoras') && menuData === 'hours') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('gestaoclientes') && menuData === 'clients') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('gest%C3%A3o%20_parceiros') && menuData === 'partners') {\n                    shouldBeActive = true;\n                } else if (currentPath.includes('equipe') && menuData === 'team') {\n                    shouldBeActive = true;\n                }\n                \n                if (shouldBeActive) {\n                    item.classList.add('active');\n                    isAnyItemActive = true;\n                }\n            });\n\n            // Se nenhum item foi ativado pela URL, ativa 'Gestão de Clientes' como padrão.\n            if (!isAnyItemActive) {\n                const clientsMenu = document.querySelector('.menu-item[data-menu=\"clients\"]');\n                if (clientsMenu) {\n                    clientsMenu.classList.add('active');\n                }\n            }\n\n            // Funções para lidar com os ícones de expandir/colapsar\n            document.querySelectorAll('.collapse-header').forEach(header => {\n                header.addEventListener('click', function() {\n                    const icon = this.querySelector('.toggle-icon');\n                    if (icon) {\n                        icon.classList.toggle('rotated');\n                    }\n                });\n            });\n\n            // Funções existentes do cliente management app\n            let originalN8nData = {};\n            let monthlyChanges = [];\n            let rawServicosContratados = [];\n            let rawCadastroServico = [];\n\n            /**\n            * Exibe uma mensagem de feedback na interface.\n            * @param {string} type - Tipo da mensagem ('success', 'danger', 'info', 'warning').\n            * @param {string} message - Texto da mensagem.\n            */\n            function showMessage(type, message) {\n                const messageContainer = document.getElementById('messageContainer');\n                if (!messageContainer) {\n                    console.error(\"Message container not found!\");\n                    return;\n                }\n                const alertDiv = document.createElement('div');\n                alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;\n                alertDiv.role = 'alert';\n                alertDiv.innerHTML = `\n                    ${message}\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n                `;\n                messageContainer.innerHTML = '';\n                messageContainer.appendChild(alertDiv);\n                setTimeout(() => {\n                    const bsAlert = bootstrap.Alert.getInstance(alertDiv);\n                    if (bsAlert) {\n                        bsAlert.close();\n                    }\n                }, 5000);\n            }\n\n            /**\n            * Calcula o saldo atual com base na lógica especificada.\n            * @param {number} horasContratadas - Horas contratadas mensais.\n            * @param {Array} monthlyHours - Array de 12 posições com horas utilizadas por mês.\n            * @param {number} qtdTempo - Quantidade de meses para acumulação.\n            * @param {Array} monthlyDataExists - Array indicando se existe dado lançado para cada mês.\n            * @returns {Object} - Resultados dos cálculos.\n            */\n            function calculateBalance(horasContratadas, monthlyHours, qtdTempo, monthlyDataExists = null) {\n                horasContratadas = parseFloat(horasContratadas) || 0;\n                monthlyHours = monthlyHours.map(h => parseFloat(h) || 0);\n                qtdTempo = parseInt(qtdTempo) || 0;\n\n                let saldoAUtilizar = 0;\n                let totalHorasUtilizadas = 0;\n                let horasNaoUtilizadasMaisQtdTempoMeses = 0;\n                let horasNaoUtilizadasUltimosQtdTempoMeses = 0;\n                let activeMonthsIndices = [];\n                let ultimosQtdTempoMesesAtivos = [];\n\n                // Determinação dos meses ativos: agora considera tanto horas > 0 quanto dados lançados como 0\n                for (let i = 0; i < 12; i++) {\n                    // Se monthlyDataExists for fornecido, usa para determinar se há dados lançados\n                    // Caso contrário, usa a lógica anterior (se horas > 0)\n                    if (monthlyDataExists && monthlyDataExists[i]) {\n                        activeMonthsIndices.push(i);\n                    } else if (!monthlyDataExists && monthlyHours[i] >= 0) {\n                        // Verifica se foi explicitamente definido, mesmo que seja 0\n                        // Para isso, precisamos verificar nos dados originais se existe entrada para este mês\n                        activeMonthsIndices.push(i);\n                    }\n                }\n\n                if (qtdTempo === 0) {\n                    // Para acumulação 0, calcula saldo mensal simples\n                    totalHorasUtilizadas = monthlyHours.reduce((sum, hours) => sum + hours, 0);\n                    const bancoHorasMensal = monthlyHours.map((horasUtilizadas, index) => {\n                        // Se não há dados lançados para o mês, retorna null (será exibido como vazio)\n                        if (monthlyDataExists && !monthlyDataExists[index]) {\n                            return null;\n                        }\n                        return horasContratadas - horasUtilizadas;\n                    });\n                    return {\n                        totalHorasContratadas: horasContratadas,\n                        totalHorasUtilizadas,\n                        horasNaoUtilizadasMais3Meses: 0,\n                        saldoAUtilizar: 0,\n                        horasNaoUtilizadasUltimos3Meses: 0,\n                        bancoHorasMensal,\n                        mesesAtivos: activeMonthsIndices.length,\n                        activeMonthsIndices: activeMonthsIndices,\n                        ultimosQtdTempoMesesAtivos: [],\n                        validacao: true\n                    };\n                }\n\n                totalHorasUtilizadas = monthlyHours.reduce((sum, hours) => sum + hours, 0);\n                const mesesAtivos = activeMonthsIndices.length;\n                const totalHorasContratadasPeriodo = horasContratadas * mesesAtivos;\n\n                ultimosQtdTempoMesesAtivos = activeMonthsIndices.slice(-qtdTempo);\n\n                activeMonthsIndices.forEach(monthIndex => {\n                    if (!ultimosQtdTempoMesesAtivos.includes(monthIndex)) {\n                        const horasNaoUtilizadas = horasContratadas - monthlyHours[monthIndex];\n                        if (horasNaoUtilizadas > 0) {\n                            horasNaoUtilizadasMaisQtdTempoMeses += horasNaoUtilizadas;\n                        }\n                    }\n                });\n\n                saldoAUtilizar = totalHorasContratadasPeriodo - totalHorasUtilizadas - horasNaoUtilizadasMaisQtdTempoMeses;\n\n                ultimosQtdTempoMesesAtivos.forEach(monthIndex => {\n                    const horasNaoUtilizadas = horasContratadas - monthlyHours[monthIndex];\n                    if (horasNaoUtilizadas > 0) {\n                        horasNaoUtilizadasUltimosQtdTempoMeses += horasNaoUtilizadas;\n                    }\n                });\n\n                const bancoHorasMensal = monthlyHours.map((horasUtilizadas, index) => {\n                    // Se não há dados lançados para o mês, retorna null (será exibido como vazio)\n                    if (monthlyDataExists && !monthlyDataExists[index]) {\n                        return null;\n                    }\n                    return horasContratadas - horasUtilizadas;\n                });\n\n                return {\n                    totalHorasContratadas: horasContratadas,\n                    totalHorasUtilizadas,\n                    horasNaoUtilizadasMais3Meses: horasNaoUtilizadasMaisQtdTempoMeses,\n                    saldoAUtilizar,\n                    horasNaoUtilizadasUltimos3Meses: horasNaoUtilizadasUltimosQtdTempoMeses,\n                    bancoHorasMensal,\n                    mesesAtivos,\n                    activeMonthsIndices,\n                    ultimosQtdTempoMesesAtivos,\n                    validacao: Math.abs(saldoAUtilizar - horasNaoUtilizadasUltimosQtdTempoMeses) < 0.01\n                };\n            }\n\n            function initializeData() {\n                try {\n                    // A expressão do n8n {{ JSON.stringify($json) }} irá injetar os dados\n                    // do nó anterior aqui como uma string JSON.\n                    const rawN8nData = {{ JSON.stringify($json) }};\n\n                    originalN8nData = rawN8nData;\n                    \n                    if (!originalN8nData || !originalN8nData.clientesServicosDetalhado) {\n                        throw new Error(\"Formato de dados inválido ou ausente. Esperado 'clientesServicosDetalhado'.\");\n                    }\n                    \n                    rawServicosContratados = originalN8nData.rawServicosContratados || [];\n                    rawCadastroServico = originalN8nData.rawCadastroServico || [];\n\n                    populateGlobalFilters();\n                    populateServiceDropdowns();\n                    \n                    // Carrega automaticamente todos os dados ao inicializar\n                    filtrarDadosGlobal();\n\n                } catch (e) {\n                    console.error(\"Erro ao carregar dados:\", e);\n                    document.getElementById('main-content-wrapper').innerHTML = `<div class=\"alert alert-danger mx-3\"><strong>Erro:</strong> Não foi possível carregar os dados. Verifique o formato do JSON e o console para mais detalhes.</div>`;\n                }\n            }\n            \n            function populateGlobalFilters() {\n                const clienteSelect = document.getElementById('filterClienteGlobal');\n                const servicoSelect = document.getElementById('filterServicoGlobal');\n\n                const uniqueClients = [...new Map(originalN8nData.clientesServicosDetalhado.map(item => [item['clienteId'], item])).values()];\n                const uniqueServices = [...new Set(originalN8nData.clientesServicosDetalhado.map(item => item.servico))];\n\n                clienteSelect.innerHTML = '<option value=\"\">Todos os clientes</option>';\n                uniqueClients.forEach(client => {\n                    clienteSelect.innerHTML += `<option value=\"${client.clienteId}\">${client.nomeCliente}</option>`;\n                });\n\n                servicoSelect.innerHTML = '<option value=\"\">Todos os serviços</option>';\n                uniqueServices.forEach(service => {\n                    servicoSelect.innerHTML += `<option value=\"${service}\">${service}</option>`;\n                });\n            }\n\n            function loadStats(data) {\n                document.getElementById('totalClients').textContent = data.totalClientes || 0;\n                document.getElementById('activeClients').textContent = data.clientesAtivos || 0;\n                document.getElementById('totalContractedHours').textContent = `${data.totalHorasContratadas || 0}h`;\n            }\n\n            // NOVA FUNÇÃO loadClientsTable COM AGRUPAMENTO\n            function loadClientsTable(clientsData) {\n                const tableBody = document.getElementById('clientsTableBody');\n                tableBody.innerHTML = '';\n\n                if (clientsData.length === 0) {\n                    tableBody.innerHTML = `<tr><td colspan=\"8\" class=\"text-center text-muted\">Nenhum cliente encontrado com os filtros aplicados.</td></tr>`;\n                    return;\n                }\n\n                // 1. Agrupar serviços por clienteId\n                const groupedClients = new Map();\n                clientsData.forEach(clientService => {\n                    if (!groupedClients.has(clientService.clienteId)) {\n                        // Inicializa o cliente no mapa com uma lista de serviços\n                        groupedClients.set(clientService.clienteId, {\n                            ...clientService, // Copia dados do cliente (nome, cnpj, etc.)\n                            services: [] // Array para armazenar os múltiplos serviços\n                        });\n                    }\n                    // Adiciona o serviço atual à lista de serviços do cliente\n                    groupedClients.get(clientService.clienteId).services.push(clientService);\n                });\n\n                let tableHtml = '';\n                // 2. Iterar sobre os clientes agrupados\n                groupedClients.forEach(client => {\n                    const numServices = client.services.length;\n                    const firstService = client.services[0];\n                    const statusClass = firstService.status === 'Ativo' ? 'success' : 'secondary';\n                    \n                    // Botões de ação para o cliente (agrupados)\n                    const clientActions = `\n                        <div class=\"btn-group-vertical\" role=\"group\">\n                            <button class=\"btn btn-outline-primary btn-sm\" onclick=\"openClientModalForEditByClient(${client.clienteId})\" title=\"Editar Cliente\"><i class=\"fas fa-user-edit\"></i></button>\n                            <button class=\"btn btn-outline-success btn-sm\" onclick=\"openAddServiceToClientModal(${client.clienteId})\" title=\"Adicionar Novo Serviço\"><i class=\"fas fa-plus\"></i></button>\n                            <button class=\"btn btn-outline-danger btn-sm\" onclick=\"openConfirmDeleteModalByClient(${client.clienteId})\" title=\"Excluir Serviços Selecionados\"><i class=\"fas fa-trash-alt\"></i></button>\n                        </div>\n                    `;\n\n                    // 3. Renderizar a primeira linha do cliente com rowspan\n                    const bancoHorasClassFirst = (firstService.bancoDeHoras || 0) >= 0 ? 'balance-positive' : 'balance-negative';\n                    const hasMonthlyDataFirst = (originalN8nData.acompanhamentoMensal || []).some(item => \n                        item.servicoId === firstService.servicoId && (item.horasUtilizadas > 0 || item.horasUtilizadas === 0)\n                    );\n\n                    tableHtml += `\n                        <tr>\n                            <td rowspan=\"${numServices}\"><strong>${client.nomeCliente || 'N/A'}</strong></td>\n                            <td rowspan=\"${numServices}\">${client.cnpj || 'N/A'}</td>\n                            <td rowspan=\"${numServices}\"><span class=\"badge bg-${statusClass} badge-status\">${client.status || 'N/A'}</span></td>\n                            \n                            <!-- Dados do primeiro serviço -->\n                            <td class=\"text-center\">${firstService.horasContratadas || 0}h</td>\n                            <td class=\"text-center\">${firstService.horasUtilizadas || 0}h</td>\n                            <td class=\"text-center ${bancoHorasClassFirst}\">${firstService.bancoDeHoras.toFixed(1)}h</td>\n                            <td>\n                                <div class=\"form-check\">\n                                    <input class=\"form-check-input service-delete-checkbox\" type=\"radio\" name=\"service-selection-${client.clienteId}\" value=\"${firstService.servicoId}\" \n                                           data-client-id=\"${client.clienteId}\" id=\"service-check-${firstService.servicoId}\" ${hasMonthlyDataFirst ? 'disabled' : ''}>\n                                    <label class=\"form-check-label\" for=\"service-check-${firstService.servicoId}\">${firstService.servico || 'N/A'}</label>\n                                </div>\n                            </td>\n                            \n                            <td rowspan=\"${numServices}\" class=\"text-center\">${clientActions}</td>\n                        </tr>\n                    `;\n\n                    // 4. Renderizar linhas para serviços adicionais (se houver)\n                    for (let i = 1; i < numServices; i++) {\n                        const service = client.services[i];\n                        const bancoHorasClass = (service.bancoDeHoras || 0) >= 0 ? 'balance-positive' : 'balance-negative';\n                        const hasMonthlyData = (originalN8nData.acompanhamentoMensal || []).some(item => \n                            item.servicoId === service.servicoId && (item.horasUtilizadas > 0 || item.horasUtilizadas === 0)\n                        );\n                        tableHtml += `\n                            <tr>\n                                <td class=\"text-center\">${service.horasContratadas || 0}h</td>\n                                <td class=\"text-center\">${service.horasUtilizadas || 0}h</td>\n                                <td class=\"text-center ${bancoHorasClass}\">${service.bancoDeHoras.toFixed(1)}h</td>\n                                <td>\n                                    <div class=\"form-check\">\n                                        <input class=\"form-check-input service-delete-checkbox\" type=\"radio\" name=\"service-selection-${client.clienteId}\" value=\"${service.servicoId}\" \n                                               data-client-id=\"${client.clienteId}\" id=\"service-check-${service.servicoId}\" ${hasMonthlyData ? 'disabled' : ''}>\n                                        <label class=\"form-check-label\" for=\"service-check-${service.servicoId}\">${service.servico || 'N/A'}</label>\n                                    </div>\n                                </td>\n                            </tr>\n                        `;\n                    }\n                });\n\n                tableBody.innerHTML = tableHtml;\n            }\n\n            function loadMonthlyTracking(clientsServices, monthlyUsage) {\n                const tableBody = document.getElementById('monthlyTrackingTableBody');\n                tableBody.innerHTML = '';\n\n                if (clientsServices.length === 0) {\n                    tableBody.innerHTML = `<tr><td colspan=\"19\" class=\"text-center text-muted\">Nenhum serviço para acompanhamento.</td></tr>`;\n                    return;\n                }\n\n                const usageMap = new Map();\n                const dataExistsMap = new Map(); // Mapeia se existe dados lançados para cada mês\n\n                monthlyUsage.forEach(item => {\n                    const key = `${item.clienteId}-${item.servicoId}-${item.ano}`;\n                    if (!usageMap.has(key)) {\n                        usageMap.set(key, {\n                            monthlyHours: Array(12).fill(0),\n                            saldoBancoHoras: Array(12).fill(0)\n                        });\n                        dataExistsMap.set(key, Array(12).fill(false));\n                    }\n                    if (item.mes >= 1 && item.mes <= 12) {\n                        usageMap.get(key).monthlyHours[item.mes - 1] = item.horasUtilizadas || 0;\n                        usageMap.get(key).saldoBancoHoras[item.mes - 1] = item.saldoBancoHoras || 0;\n                        dataExistsMap.get(key)[item.mes - 1] = true; // Marca que existe dados para este mês\n                    }\n                });\n\n                let calculationDetailsHtml = '';\n\n                clientsServices.forEach((service, serviceIndex) => {\n                    const key = `${service.clienteId}-${service.servicoId}-${new Date().getFullYear()}`;\n                    const serviceData = usageMap.get(key) || {\n                        monthlyHours: Array(12).fill(0),\n                        saldoBancoHoras: Array(12).fill(0)\n                    };\n                    const dataExists = dataExistsMap.get(key) || Array(12).fill(false);\n\n                    const monthlyHours = serviceData.monthlyHours;\n                    const calculation = calculateBalance(service.horasContratadas, monthlyHours, service.mesesAcumulacao, dataExists);\n\n                    const saldoAtualClass = calculation.saldoAUtilizar >= 0 ? 'balance-positive' : 'balance-negative';\n                    const acumulaTexto = service.mesesAcumulacao > 0 ? 'Sim' : 'Não';\n\n                    // Gera inputs para os meses, deixando vazio quando não há dados lançados\n                    const monthInputs = monthlyHours.map((h, monthIndex) => {\n                        const value = dataExists[monthIndex] ? h : '';\n                        return `<td class=\"editable-cell\">\n                            <input type=\"number\" value=\"${value}\" class=\"form-control form-control-sm\"\n                                   data-client-id=\"${service.clienteId}\" data-service-id=\"${service.servicoId}\" data-month-index=\"${monthIndex}\"\n                                   data-original-value=\"${value}\" data-has-data=\"${dataExists[monthIndex]}\" oninput=\"trackChange(this)\">\n                        </td>`;\n                    }).join('');\n\n                    const row = `\n                        <tr>\n                            <td>${service.servicoId}</td>\n                            <td class=\"text-start\">${service.nomeCliente}</td>\n                            <td class=\"text-start\">${service.servico}</td>\n                            <td>${service.horasContratadas}h</td>\n                            <td>${acumulaTexto}</td>\n                            <td>${service.mesesAcumulacao}</td>\n                            ${monthInputs}\n                            <td class=\"${saldoAtualClass}\">${calculation.saldoAUtilizar.toFixed(1)}h</td>\n                        </tr>`;\n\n                    // Gera o banco de horas, exibindo vazio quando não há dados\n                    const bancoHorasInputs = calculation.bancoHorasMensal.map((h, monthIndex) => {\n                        if (!dataExists[monthIndex]) {\n                            return `<td></td>`;\n                        }\n                        const balanceClass = h >= 0 ? 'balance-positive' : 'balance-negative';\n                        return `<td class=\"${balanceClass}\">${h.toFixed(1)}</td>`;\n                    }).join('');\n\n                    const bancoHorasRow = `\n                        <tr class=\"banco-horas-row\">\n                            <td></td>\n                            <td class=\"text-start\">Banco de Horas</td>\n                            <td class=\"text-start\">${service.servico}</td>\n                            <td></td>\n                            <td></td>\n                            <td></td>\n                            ${bancoHorasInputs}\n                            <td></td>\n                        </tr>`;\n\n                    tableBody.innerHTML += row + bancoHorasRow;\n\n                    const monthNames = [\"Jan\", \"Fev\", \"Mar\", \"Abr\", \"Mai\", \"Jun\", \"Jul\", \"Ago\", \"Set\", \"Out\", \"Nov\", \"Dez\"];\n                    const activeMesesText = calculation.activeMonthsIndices.map(i => monthNames[i]).join(', ');\n                    const ultimosMesesText = calculation.ultimosQtdTempoMesesAtivos.map(i => monthNames[i]).join(', ');\n\n                    calculationDetailsHtml += `\n                        <div class=\"mb-3\">\n                            <strong>${service.nomeCliente} - ${service.servico}:</strong><br>\n                            Meses Ativos: [${activeMesesText}] (${calculation.mesesAtivos} meses)<br>\n                            Últimos ${service.mesesAcumulacao} Meses Ativos: [${ultimosMesesText}]<br>\n                            Total Horas Contratadas (Período): ${service.horasContratadas.toFixed(1)}h<br>\n                            Total Horas Utilizadas (Período): ${calculation.totalHorasUtilizadas.toFixed(1)}h<br>\n                            Horas Não Utilizadas > ${service.mesesAcumulacao} Meses: ${calculation.horasNaoUtilizadasMais3Meses.toFixed(1)}h<br>\n                            <strong>Saldo a Utilizar: ${calculation.saldoAUtilizar.toFixed(1)}h</strong><br>\n                            Horas Não Utilizadas nos Últimos ${service.mesesAcumulacao} Meses: ${calculation.horasNaoUtilizadasUltimos3Meses.toFixed(1)}h<br>\n                            <span class=\"${calculation.validacao ? 'text-success' : 'text-danger'}\">\n                                Validação: ${calculation.validacao ? 'VERDADEIRO' : 'FALSO'}\n                            </span>\n                        </div>`;\n                });\n\n                document.getElementById('calculationDetails').classList.add('d-none');\n                document.getElementById('calculationDetailsContent').innerHTML = calculationDetailsHtml;\n            }\n\n            window.trackChange = function(inputElement) {\n                const clientId = parseInt(inputElement.dataset.clientId);\n                const serviceId = parseInt(inputElement.dataset.serviceId);\n                const monthIndex = parseInt(inputElement.dataset.monthIndex);\n                const originalValue = inputElement.dataset.originalValue === '' ? null : (parseFloat(inputElement.dataset.originalValue) || 0);\n                const newValue = inputElement.value === '' ? null : (parseFloat(inputElement.value) || 0);\n                const hadData = inputElement.dataset.hasData === 'true';\n\n                const service = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId && c.servicoId === serviceId);\n                if (!service) {\n                    console.error(\"Serviço não encontrado para o ID do cliente e serviço fornecidos.\");\n                    return;\n                }\n\n                const key = `${clientId}-${serviceId}-${monthIndex}`;\n\n                monthlyChanges = monthlyChanges.filter(c => c.key !== key);\n\n                // Verifica se houve mudança (considerando valores nulos)\n                const hasChanged = (originalValue !== newValue) || (!hadData && newValue !== null);\n\n                if (hasChanged) {\n                    monthlyChanges.push({\n                        key,\n                        clientId,\n                        serviceId,\n                        monthIndex,\n                        clientName: service.nomeCliente,\n                        serviceName: service.servico,\n                        originalValue: originalValue,\n                        newValue: newValue\n                    });\n                    inputElement.parentElement.classList.add('changed');\n                } else {\n                    inputElement.parentElement.classList.remove('changed');\n                }\n\n                // Atualiza dados locais\n                const currentYear = new Date().getFullYear();\n                let monthlyUsageEntry = originalN8nData.acompanhamentoMensal.find(item =>\n                    item.clienteId === clientId &&\n                    item.servicoId === serviceId &&\n                    item.ano === currentYear &&\n                    (item.mes - 1) === monthIndex\n                );\n\n                if (newValue !== null) {\n                    if (monthlyUsageEntry) {\n                        monthlyUsageEntry.horasUtilizadas = newValue;\n                    } else {\n                        originalN8nData.acompanhamentoMensal.push({\n                            acompanhamentoId: Math.floor(Math.random() * 1000000),\n                            clienteId: clientId,\n                            servicoId: serviceId,\n                            cliente: service.nomeCliente,\n                            servico: service.servico,\n                            ano: currentYear,\n                            mes: monthIndex + 1,\n                            horasUtilizadas: newValue,\n                            saldoBancoHoras: 0\n                        });\n                    }\n                } else {\n                    // Remove entrada se valor for nulo/vazio\n                    if (monthlyUsageEntry) {\n                        const index = originalN8nData.acompanhamentoMensal.indexOf(monthlyUsageEntry);\n                        originalN8nData.acompanhamentoMensal.splice(index, 1);\n                    }\n                }\n\n                updateRealTimeCalculation(clientId, serviceId);\n                document.getElementById('saveMonthlyChangesBtn').classList.toggle('d-none', monthlyChanges.length === 0);\n            }\n\n            function updateRealTimeCalculation(clientId, serviceId) {\n                const service = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId && c.servicoId === serviceId);\n                if (!service) return;\n\n                const inputs = document.querySelectorAll(`input[data-client-id=\"${clientId}\"][data-service-id=\"${serviceId}\"]`);\n                const monthlyHours = Array(12).fill(0);\n                const dataExists = Array(12).fill(false);\n                \n                inputs.forEach(input => {\n                    const monthIndex = parseInt(input.dataset.monthIndex);\n                    const value = input.value === '' ? 0 : (parseFloat(input.value) || 0);\n                    const hasData = input.value !== '';\n                    \n                    monthlyHours[monthIndex] = value;\n                    dataExists[monthIndex] = hasData;\n                });\n\n                const calculation = calculateBalance(service.horasContratadas, monthlyHours, service.mesesAcumulacao, dataExists);\n                \n                const rowElement = inputs[0].closest('tr');\n                const saldoCell = rowElement.querySelector('td:last-child');\n                saldoCell.textContent = `${calculation.saldoAUtilizar.toFixed(1)}h`;\n                saldoCell.className = calculation.saldoAUtilizar >= 0 ? 'balance-positive' : 'balance-negative';\n\n                const bancoHorasRow = rowElement.nextElementSibling;\n                const bancoHorasCells = bancoHorasRow.querySelectorAll('td');\n                calculation.bancoHorasMensal.forEach((saldoBanco, index) => {\n                    const cellIndex = index + 6;\n                    if (saldoBanco === null || !dataExists[index]) {\n                        bancoHorasCells[cellIndex].textContent = '';\n                        bancoHorasCells[cellIndex].className = '';\n                    } else {\n                        bancoHorasCells[cellIndex].textContent = saldoBanco.toFixed(1);\n                        bancoHorasCells[cellIndex].className = saldoBanco >= 0 ? 'balance-positive' : 'balance-negative';\n                    }\n                });\n            }\n\n            window.openConfirmSaveModal = function() {\n                const modalBody = document.getElementById('confirmSaveModalBody');\n                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmSaveModal'));\n\n                const currentMonthlyChanges = [];\n                document.querySelectorAll('#monthlyTrackingTableBody input[type=\"number\"]').forEach(inputElement => {\n                    const clientId = parseInt(inputElement.dataset.clientId);\n                    const serviceId = parseInt(inputElement.dataset.serviceId);\n                    const monthIndex = parseInt(inputElement.dataset.monthIndex);\n                    const originalValue = inputElement.dataset.originalValue === '' ? null : (parseFloat(inputElement.dataset.originalValue) || 0);\n                    const newValue = inputElement.value === '' ? null : (parseFloat(inputElement.value) || 0);\n                    const hadData = inputElement.dataset.hasData === 'true';\n                    \n                    const service = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId && c.servicoId === serviceId);\n\n                    const hasChanged = (originalValue !== newValue) || (!hadData && newValue !== null);\n\n                    if (hasChanged) {\n                        currentMonthlyChanges.push({\n                            clientId: service.clienteId,\n                            serviceId: service.servicoId,\n                            clientName: service.nomeCliente,\n                            serviceName: service.servico,\n                            monthIndex,\n                            originalValue,\n                            newValue\n                        });\n                    }\n                });\n\n                if (currentMonthlyChanges.length === 0) {\n                    modalBody.innerHTML = '<p>Nenhuma alteração detectada.</p>';\n                    modal.show();\n                    return;\n                }\n\n                let summaryHtml = '<p>As seguintes alterações serão salvas:</p><ul class=\"list-group\">';\n                const months = [\"Jan\", \"Fev\", \"Mar\", \"Abr\", \"Mai\", \"Jun\", \"Jul\", \"Ago\", \"Set\", \"Out\", \"Nov\", \"Dez\"];\n                currentMonthlyChanges.forEach(change => {\n                    const originalText = change.originalValue === null ? 'vazio' : `${change.originalValue.toFixed(1)}h`;\n                    const newText = change.newValue === null ? 'vazio' : `${change.newValue.toFixed(1)}h`;\n                    summaryHtml += `\n                        <li class=\"list-group-item\">\n                            <strong>${change.clientName} - ${change.serviceName}</strong><br>\n                            Mês: ${months[change.monthIndex]} | Valor anterior: ${originalText} | Novo valor: <strong>${newText}</strong>\n                        </li>`;\n                });\n                summaryHtml += '</ul>';\n                modalBody.innerHTML = summaryHtml;\n                modal.show();\n            }\n\n            window.confirmSaveChanges = async function() {\n                bootstrap.Modal.getInstance(document.getElementById('confirmSaveModal')).hide();\n                const saveMonthlyChangesBtn = document.getElementById('saveMonthlyChangesBtn');\n                const originalButtonHtml = saveMonthlyChangesBtn.innerHTML;\n                saveMonthlyChangesBtn.disabled = true;\n                saveMonthlyChangesBtn.innerHTML = `<span class=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span> Salvando...`;\n\n                const changesToSend = [];\n                document.querySelectorAll('#monthlyTrackingTableBody input[type=\"number\"]').forEach(inputElement => {\n                    const clientId = parseInt(inputElement.dataset.clientId);\n                    const serviceId = parseInt(inputElement.dataset.serviceId);\n                    const monthIndex = parseInt(inputElement.dataset.monthIndex);\n                    const originalValue = inputElement.dataset.originalValue === '' ? null : (parseFloat(inputElement.dataset.originalValue) || 0);\n                    const newValue = inputElement.value === '' ? null : (parseFloat(inputElement.value) || 0);\n                    const hadData = inputElement.dataset.hasData === 'true';\n                    \n                    const service = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId && c.servicoId === serviceId);\n\n                    const hasChanged = (originalValue !== newValue) || (!hadData && newValue !== null);\n\n                    if (hasChanged && newValue !== null) {\n                        changesToSend.push({\n                            clientId: service.clienteId,\n                            servicoId: service.servicoId,\n                            nomeCliente: service.nomeCliente,\n                            cnpj: service.cnpj,\n                            status: service.status,\n                            servico: service.servico,\n                            horasContratadas: service.horasContratadas,\n                            horasUtilizadas: newValue,\n                            bancoDeHoras: 0, // Será recalculado no backend ou na próxima carga\n                            valorHora: service.valorHora,\n                            mesesAcumulacao: service.mesesAcumulacao,\n                            ano: new Date().getFullYear(),\n                            mes: monthIndex + 1\n                        });\n                    }\n                });\n\n                const payload = {\n                    monthlyChanges: changesToSend,\n                    action: \"mes_a_mes\"\n                };\n\n                const currentYear = new Date().getFullYear();\n                const updatedMonthlyUsageMap = new Map();\n                (originalN8nData.acompanhamentoMensal || []).forEach(item => {\n                    const key = `${item.clienteId}-${item.servicoId}-${item.ano}-${item.mes}`;\n                    updatedMonthlyUsageMap.set(key, { ...item });\n                });\n\n                changesToSend.forEach(change => {\n                    const key = `${change.clienteId}-${change.servicoId}-${change.ano}-${change.mes}`;\n                    let entry = updatedMonthlyUsageMap.get(key);\n                    if (entry) {\n                        entry.horasUtilizadas = change.horasUtilizadas;\n                    } else {\n                        updatedMonthlyUsageMap.set(key, {\n                            acompanhamentoId: Math.floor(Math.random() * 1000000), // ID temporário se for novo\n                            clienteId: change.clienteId,\n                            servicoId: change.servicoId,\n                            cliente: change.nomeCliente,\n                            servico: change.serviceName,\n                            ano: change.ano,\n                            mes: change.mes,\n                            horasUtilizadas: change.horasUtilizadas,\n                            saldoBancoHoras: 0 // Será recalculado\n                        });\n                    }\n                });\n                originalN8nData.acompanhamentoMensal = Array.from(updatedMonthlyUsageMap.values());\n                \n                monthlyChanges = []; // Limpa as alterações pendentes\n                filtrarDadosGlobal(); // Re-filtra e re-renderiza com os dados atualizados\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n\n                console.log(\"Enviando dados para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: {\n                            'Content-Type': 'application/json'\n                        },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        showMessage('success', 'Alterações salvas com sucesso!');\n                        console.log(\"Dados enviados ao webhook com sucesso:\", payload);\n                    } else {\n                        const errorText = await response.text();\n                        showMessage('danger', `Erro ao salvar alterações: ${response.status} - ${errorText}`);\n                        console.error(\"Erro ao enviar dados ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    showMessage('danger', `Erro de rede ao salvar alterações: ${error.message}`);\n                    console.error(\"Erro de rede ao enviar dados ao webhook:\", error);\n                } finally {\n                    saveMonthlyChangesBtn.disabled = false;\n                    saveMonthlyChangesBtn.innerHTML = originalButtonHtml;\n                }\n            };\n\n            function populateServiceDropdowns(targetSelectId = 'clientServiceSelect') {\n                const serviceSelect = document.getElementById(targetSelectId);\n                serviceSelect.innerHTML = '<option value=\"\">Selecione um serviço</option>';\n                rawCadastroServico.forEach(service => {\n                    serviceSelect.innerHTML += `<option value=\"${service.id}\">${service.nome_serviço}</option>`;\n                });\n            }\n\n            window.filtrarDadosGlobal = function() {\n                const clienteId = document.getElementById('filterClienteGlobal').value;\n                const servicoNome = document.getElementById('filterServicoGlobal').value;\n                const dataInicial = document.getElementById('filterDataInicialGlobal').value;\n                const dataFinal = document.getElementById('filterDataFinalGlobal').value;\n\n                let filteredServices = [...originalN8nData.clientesServicosDetalhado];\n                let filteredAcompanhamento = [...originalN8nData.acompanhamentoMensal];\n\n                // Filtrar por cliente\n                if (clienteId) {\n                    filteredServices = filteredServices.filter(s => s.clienteId == clienteId);\n                    filteredAcompanhamento = filteredAcompanhamento.filter(a => a.clienteId == clienteId);\n                }\n\n                // Filtrar por serviço\n                if (servicoNome) {\n                    filteredServices = filteredServices.filter(s => s.servico === servicoNome);\n                    filteredAcompanhamento = filteredAcompanhamento.filter(a => a.servico === servicoNome);\n                }\n\n                // Filtrar acompanhamento por data\n                if (dataInicial || dataFinal) {\n                    const start = dataInicial ? new Date(dataInicial + \"T00:00:00\") : null;\n                    const end = dataFinal ? new Date(dataFinal + \"T23:59:59\") : null;\n\n                    filteredAcompanhamento = filteredAcompanhamento.filter(item => {\n                        const itemDate = new Date(item.ano, item.mes - 1, 15); // Use mid-month to avoid timezone issues\n                        return (!start || itemDate >= start) && (!end || itemDate <= end);\n                    });\n                }\n                \n                // Recalcular horas utilizadas e banco de horas com base no acompanhamento filtrado\n                filteredServices.forEach(service => {\n                    const monthlyHoursForService = Array(12).fill(0);\n                    const dataExistsForService = Array(12).fill(false);\n                    const currentYear = new Date().getFullYear();\n                    \n                    filteredAcompanhamento\n                        .filter(m => m.clienteId === service.clienteId && m.servicoId === service.servicoId && m.ano === currentYear)\n                        .forEach(item => {\n                            if (item.mes >= 1 && item.mes <= 12) {\n                                monthlyHoursForService[item.mes - 1] = item.horasUtilizadas;\n                                dataExistsForService[item.mes - 1] = true;\n                            }\n                        });\n\n                    const calculation = calculateBalance(service.horasContratadas, monthlyHoursForService, service.mesesAcumulacao, dataExistsForService);\n                    service.horasUtilizadas = calculation.totalHorasUtilizadas;\n                    service.bancoDeHoras = calculation.saldoAUtilizar;\n                });\n\n                // Recalcular estatísticas\n                const stats = {\n                    totalClientes: new Set(filteredServices.map(s => s.clienteId)).size,\n                    clientesAtivos: new Set(filteredServices.filter(s => s.status === 'Ativo').map(s => s.clienteId)).size,\n                    totalHorasContratadas: filteredServices.reduce((sum, s) => sum + (s.horasContratadas || 0), 0),\n                    totalBancoDeHoras: filteredServices.reduce((sum, s) => sum + (s.bancoDeHoras || 0), 0)\n                };\n\n                // Renderizar tudo\n                loadStats(stats);\n                loadClientsTable(filteredServices);\n                loadMonthlyTracking(filteredServices, filteredAcompanhamento);\n                loadServiceDetails(filteredServices, filteredAcompanhamento);\n            }\n            \n            function loadServiceDetails(filteredServices, filteredAcompanhamento) {\n                const container = document.getElementById('serviceDetailsContainer');\n                container.innerHTML = '';\n\n                if (filteredServices.length === 1) {\n                    // Exibe detalhes se apenas um serviço for filtrado\n                    const service = filteredServices[0];\n                    const horasUtilizadasNoPeriodo = service.horasUtilizadas;\n                    const utilizationPercent = service.horasContratadas > 0 ? Math.round((horasUtilizadasNoPeriodo / service.horasContratadas) * 100) : 0;\n                    const bankLimit = 114;\n                    const bankPercent = bankLimit > 0 && service.bancoDeHoras > 0 ? Math.round((service.bancoDeHoras / bankLimit) * 100) : 0;\n\n                    container.innerHTML = `\n                        <div class=\"p-3\">\n                            <h6><strong>${service.nomeCliente} - ${service.servico}</strong></h6>\n                            <p class=\"text-muted\">Período: Geral</p>\n                            <div class=\"row g-3\">\n                                <div class=\"col-md-3\"><div class=\"detail-card\"><h4 class=\"text-primary\">${service.horasContratadas}h</h4><small>Horas Contratadas</small></div></div>\n                                <div class=\"col-md-3\"><div class=\"detail-card\"><h4 class=\"text-success\">${horasUtilizadasNoPeriodo.toFixed(1)}h</h4><small>Horas Utilizadas</small><div class=\"progress mt-2\" style=\"height: 5px;\"><div class=\"progress-bar bg-success\" style=\"width: ${utilizationPercent}%\"></div></div><small>${utilizationPercent}%</small></div></div>\n                                <div class=\"col-md-3\"><div class=\"detail-card\"><h4 class=\"text-warning\">${service.bancoDeHoras.toFixed(1)}h</h4><small>Banco de Horas</small><div class=\"progress mt-2\" style=\"height: 5px;\"><div class=\"progress-bar bg-warning\" style=\"width: ${bankPercent}%\"></div></div><small>${bankPercent}% do limite (${bankLimit}h)</small></div></div>\n                                <div class=\"col-md-3\"><div class=\"detail-card\"><h4 class=\"${service.bancoDeHoras >= 0 ? 'text-info' : 'text-danger'}\">${service.bancoDeHoras.toFixed(1)}h</h4><small>Saldo Atual</small></div></div>\n                            </div>\n                            <div class=\"alert alert-info mt-4\">\n                                <h6><i class=\"fas fa-info-circle me-2\"></i>Regras do Banco de Horas</h6>\n                                <ul class=\"mb-0 small\">\n                                    <li>Acumulação permitida: <strong>${service.mesesAcumulacao} meses</strong></li>\n                                    <li>Limite máximo: <strong>114 horas</strong></li>\n                                    <li>Horas não utilizadas são adicionadas ao banco (até ${service.mesesAcumulacao} meses)</li>\n                                    <li>Horas excedentes ao limite são perdidas</li>\n                                </ul>\n                            </div>\n                            <div class=\"row mt-3\">\n                                <div class=\"col-md-12\">\n                                    <button class=\"btn btn-success w-100\" onclick=\"generateReport()\"><i class=\"fas fa-file-excel me-2\"></i>Relatório</button>\n                                </div>\n                            </div>\n                        </div>`;\n                } else {\n                    if (filteredServices.length === 0) {\n                        container.innerHTML = '<p class=\"text-muted text-center\">Nenhum serviço encontrado com os filtros aplicados.</p>';\n                    } else {\n                        container.innerHTML = '<p class=\"text-muted text-center\">Filtre por um único cliente e serviço para ver os detalhes específicos de horas.</p>';\n                    }\n                }\n            }\n\n            document.getElementById('btnFiltrarGlobal').addEventListener('click', filtrarDadosGlobal);\n\n            // --- UNIFIED MODAL LOGIC ---\n            window.openClientModal = (index = null) => {\n                const modalElement = document.getElementById('clientModal');\n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                const title = document.getElementById('clientModalTitle');\n                const form = document.getElementById('clientForm');\n                const serviceSelect = document.getElementById('clientServiceSelect');\n                const serviceHoursInput = document.querySelector('#clientModal .service-item .service-hours');\n                const serviceAccumulationInput = document.querySelector('#clientModal .service-item .service-accumulation');\n                \n                form.reset();\n                document.getElementById('clientId').value = '';\n                populateServiceDropdowns('clientServiceSelect');\n\n                if (index !== null) {\n                    title.textContent = 'Editar Cliente e Serviço';\n                    const client = originalN8nData.clientesServicosDetalhado[index];\n                    if (client) {\n                        document.getElementById('clientId').value = index;\n                        document.getElementById('clientName').value = client.nomeCliente || '';\n                        document.getElementById('clientCnpj').value = client.cnpj || '';\n                        document.getElementById('clientEmail').value = client.email || '';\n                        document.getElementById('clientPhone').value = client.telefone || '';\n                        document.getElementById('clientActive').checked = client.status === 'Ativo';\n                        \n                        const selectedServiceInCatalog = rawCadastroServico.find(s => s.nome_serviço === client.servico);\n                        if (selectedServiceInCatalog) {\n                            serviceSelect.value = selectedServiceInCatalog.id;\n                        } else {\n                            serviceSelect.value = '';\n                        }\n\n                        serviceHoursInput.value = client.horasContratadas || 0;\n                        serviceAccumulationInput.value = client.mesesAcumulacao || 0;\n                    }\n                } else {\n                    title.textContent = 'Novo Cliente';\n                    serviceSelect.value = '';\n                    serviceHoursInput.value = 0;\n                    serviceAccumulationInput.value = 0;\n                    document.getElementById('clientEmail').value = '';\n                    document.getElementById('clientPhone').value = '';\n                }\n                modal.show();\n            };\n\n            window.saveClient = async () => {\n                const index = document.getElementById('clientId').value;\n                const name = document.getElementById('clientName').value;\n                const cnpj = document.getElementById('clientCnpj').value;\n                const email = document.getElementById('clientEmail').value;\n                const phone = document.getElementById('clientPhone').value;\n                const isActive = document.getElementById('clientActive').checked;\n                const selectedServiceId = document.getElementById('clientServiceSelect').value;\n                const horasContratadas = parseInt(document.querySelector('#clientModal .service-item .service-hours').value) || 0;\n                const mesesAcumulacao = parseInt(document.querySelector('#clientModal .service-item .service-accumulation').value) || 0;\n\n                if (!name || !selectedServiceId) {\n                    showMessage('danger', 'Nome do cliente e serviço são obrigatórios.');\n                    return;\n                }\n\n                const selectedService = rawCadastroServico.find(s => s.id == selectedServiceId);\n                if (!selectedService) {\n                    showMessage('danger', 'Serviço selecionado inválido.');\n                    return;\n                }\n\n                let clientPayload = {};\n                let successMessage = '';\n\n                if (index) { // Editando cliente existente\n                    const client = originalN8nData.clientesServicosDetalhado[index];\n                    clientPayload = {\n                        action: \"update_client_service\",\n                        clienteId: client.clienteId,\n                        servicoId: client.servicoId,\n                        nome: name,\n                        cnpj: cnpj,\n                        email: email,\n                        telefone: phone,\n                        ativo: isActive,\n                        nome_servico: selectedService.nome_serviço,\n                        horas_contratadas_mes: horasContratadas,\n                        meses_acumulacao: mesesAcumulacao,\n                        valor_hora: selectedService.valor_hora || 0\n                    };\n                    successMessage = 'Cliente atualizado com sucesso!';\n                } else { // Adicionando novo cliente\n                    const newClientId = originalN8nData.clientesServicosDetalhado.length > 0 ? Math.max(...originalN8nData.clientesServicosDetalhado.map(c => c.clienteId)) + 1 : 1;\n                    const newServiceId = parseInt(selectedServiceId);\n\n                    clientPayload = {\n                        action: \"add_cliente\",\n                        id: newClientId,\n                        nome: name,\n                        cnpj: cnpj,\n                        email: email,\n                        telefone: phone,\n                        ativo: isActive,\n                        servico_contratado: {\n                            id: newServiceId,\n                            cliente_id: newClientId,\n                            nome_servico: selectedService.nome_serviço,\n                            horas_contratadas_mes: horasContratadas,\n                            meses_acumulacao: mesesAcumulacao,\n                            valor_hora: selectedService.valor_hora || 0,\n                            created_at: new Date().toISOString()\n                        }\n                    };\n                    successMessage = 'Cliente salvo com sucesso!';\n                }\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados do cliente para o webhook:\", webhookUrl, clientPayload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(clientPayload)\n                    });\n\n                    if (response.ok) {\n                        console.log(\"Dados do cliente enviados ao webhook com sucesso:\", clientPayload);\n                        showMessage('success', successMessage);\n                        // Recarregar a página para obter dados atualizados do backend\n                        setTimeout(() => window.location.reload(), 1500);\n                    } else {\n                        const errorText = await response.text();\n                        showMessage('danger', `Erro ao salvar cliente: ${response.status} - ${errorText}`);\n                        console.error(\"Erro ao enviar dados do cliente ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    showMessage('danger', `Erro de rede ao salvar cliente: ${error.message}`);\n                    console.error(\"Erro de rede ao enviar dados do cliente ao webhook:\", error);\n                }\n            };\n\n            window.openAddServiceModal = () => {\n                const modalElement = document.getElementById('addServiceModal');\n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                document.getElementById('addServiceForm').reset();\n                modal.show();\n            };\n\n            window.saveService = async () => {\n                const newServiceName = document.getElementById('newServiceName').value;\n                \n                if (!newServiceName) {\n                    showMessage('danger', 'O nome do serviço é obrigatório.');\n                    return;\n                }\n                \n                const newServiceId = rawCadastroServico.length > 0 ? Math.max(...rawCadastroServico.map(s => s.id)) + 1 : 1;\n                const newService = {\n                    id: newServiceId,\n                    nome_serviço: newServiceName,\n                    created_at: new Date().toISOString()\n                };\n                rawCadastroServico.push(newService);\n\n                populateServiceDropdowns('clientServiceSelect');\n                populateServiceDropdowns('addServiceToClientServiceSelect');\n                \n                bootstrap.Modal.getInstance(document.getElementById('addServiceModal')).hide();\n                showMessage('success', 'Novo serviço adicionado com sucesso! Ele já está disponível para seleção.');\n\n                const payload = {\n                    action: \"add_serv\",\n                    nome_servico: newServiceName\n                };\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados do novo serviço para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        console.log(\"Dados do novo serviço enviados ao webhook com sucesso:\", payload);\n                    } else {\n                        const errorText = await response.text();\n                        console.error(\"Erro ao enviar dados do novo serviço ao webhook:\", response.status, errorText);\n                        rawCadastroServico.pop();\n                        populateServiceDropdowns('clientServiceSelect');\n                        populateServiceDropdowns('addServiceToClientServiceSelect');\n                        showMessage('danger', 'Falha ao salvar o novo serviço no servidor.');\n                    }\n                } catch (error) {\n                    console.error(\"Erro de rede ao enviar dados do novo serviço ao webhook:\", error);\n                    rawCadastroServico.pop();\n                    populateServiceDropdowns('clientServiceSelect');\n                    populateServiceDropdowns('addServiceToClientServiceSelect');\n                    showMessage('danger', `Erro de rede: ${error.message}`);\n                }\n            };\n\n            window.viewClientDetails = (index) => {\n                const client = originalN8nData.clientesServicosDetalhado[index];\n                const clientSelect = document.getElementById('filterClienteGlobal');\n                clientSelect.value = client.clienteId;\n                \n                const serviceSelect = document.getElementById('filterServicoGlobal');\n                serviceSelect.value = client.servico;\n\n                filtrarDadosGlobal();\n                \n                const detailsContainer = document.getElementById('serviceDetailsContainer');\n                if(detailsContainer) {\n                    detailsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });\n                }\n            };\n\n            window.generateReport = function() {\n                const clienteId = document.getElementById('filterClienteGlobal').value;\n                const servicoNome = document.getElementById('filterServicoGlobal').value;\n\n                if (!clienteId || !servicoNome) {\n                    showMessage('warning', 'Por favor, selecione um cliente e um serviço para gerar o relatório.');\n                    return;\n                }\n\n                const client = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId == clienteId && c.servico === servicoNome);\n                if (!client) {\n                    showMessage('danger', 'Dados do cliente/serviço não encontrados para gerar o relatório.');\n                    return;\n                }\n\n                const currentYear = new Date().getFullYear();\n                const monthlyUsageForService = (originalN8nData.acompanhamentoMensal || [])\n                    .filter(item => item.clienteId === client.clienteId && item.servicoId === client.servicoId && item.ano === currentYear);\n\n                let csvContent = \"Tipo de Dado,Nome do Cliente,CNPJ,Status,Email,Telefone,Nome do Serviço,Horas Contratadas/Mês,Meses Acumulação,Horas Utilizadas Total,Banco de Horas Atual\\n\";\n                \n                csvContent += `Detalhes do Contrato,${client.nomeCliente},${client.cnpj || 'N/A'},${client.status},${client.email || 'N/A'},${client.telefone || 'N/A'},${client.servico},${client.horasContratadas},${client.mesesAcumulacao},${client.horasUtilizadas.toFixed(1)},${client.bancoDeHoras.toFixed(1)}\\n`;\n\n                csvContent += \"\\nTipo de Dado,Mês,Horas Utilizadas,Saldo Banco de Horas\\n\";\n\n                const monthNames = [\"Janeiro\", \"Fevereiro\", \"Março\", \"Abril\", \"Maio\", \"Junho\", \"Julho\", \"Agosto\", \"Setembro\", \"Outubro\", \"Novembro\", \"Dezembro\"];\n\n                for (let i = 1; i <= 12; i++) {\n                    const monthlyData = monthlyUsageForService.find(item => item.mes === i);\n                    const horasUtilizadas = monthlyData ? monthlyData.horasUtilizadas : 0;\n                    const saldoBancoHoras = monthlyData ? monthlyData.saldoBancoHoras : 0;\n                    csvContent += `Acompanhamento Mensal,${monthNames[i-1]},${horasUtilizadas.toFixed(1)},${saldoBancoHoras.toFixed(1)}\\n`;\n                }\n\n                const filename = `Relatorio_${client.nomeCliente.replace(/\\s/g, '_')}_${client.servico.replace(/\\s/g, '_')}_${currentYear}.csv`;\n                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n                const link = document.createElement('a');\n                link.href = URL.createObjectURL(blob);\n                link.download = filename;\n                document.body.appendChild(link);\n                link.click();\n                document.body.removeChild(link);\n                URL.revokeObjectURL(link.href);\n\n                showMessage('success', `Relatório CSV para ${client.nomeCliente} - ${client.servico} gerado com sucesso!`);\n            };\n\n            // Nova função para exportar dados filtrados\n            window.exportFilteredDataToCSV = function() {\n                const clienteId = document.getElementById('filterClienteGlobal').value;\n                const servicoNome = document.getElementById('filterServicoGlobal').value;\n                const dataInicial = document.getElementById('filterDataInicialGlobal').value;\n                const dataFinal = document.getElementById('filterDataFinalGlobal').value;\n\n                // Aplicar os mesmos filtros da função filtrarDadosGlobal\n                let filteredServices = [...originalN8nData.clientesServicosDetalhado];\n                let filteredAcompanhamento = [...originalN8nData.acompanhamentoMensal];\n\n                // Filtrar por cliente\n                if (clienteId) {\n                    filteredServices = filteredServices.filter(s => s.clienteId == clienteId);\n                    filteredAcompanhamento = filteredAcompanhamento.filter(a => a.clienteId == clienteId);\n                }\n\n                // Filtrar por serviço\n                if (servicoNome) {\n                    filteredServices = filteredServices.filter(s => s.servico === servicoNome);\n                    filteredAcompanhamento = filteredAcompanhamento.filter(a => a.servico === servicoNome);\n                }\n\n                // Filtrar acompanhamento por data\n                if (dataInicial || dataFinal) {\n                    const start = dataInicial ? new Date(dataInicial + \"T00:00:00\") : null;\n                    const end = dataFinal ? new Date(dataFinal + \"T23:59:59\") : null;\n\n                    filteredAcompanhamento = filteredAcompanhamento.filter(item => {\n                        const itemDate = new Date(item.ano, item.mes - 1, 15);\n                        return (!start || itemDate >= start) && (!end || itemDate <= end);\n                    });\n                }\n\n                if (filteredServices.length === 0) {\n                    showMessage('warning', 'Nenhum dado encontrado com os filtros aplicados.');\n                    return;\n                }\n\n                // Recalcular dados conforme filtros e organizar por mês\n                const currentYear = new Date().getFullYear();\n                const processedData = [];\n\n                filteredServices.forEach(service => {\n                    const monthlyHoursForService = Array(12).fill('');\n                    const dataExistsForService = Array(12).fill(false);\n                    \n                    filteredAcompanhamento\n                        .filter(m => m.clienteId === service.clienteId && m.servicoId === service.servicoId && m.ano === currentYear)\n                        .forEach(item => {\n                            if (item.mes >= 1 && item.mes <= 12) {\n                                monthlyHoursForService[item.mes - 1] = item.horasUtilizadas || 0;\n                                dataExistsForService[item.mes - 1] = true;\n                            }\n                        });\n\n                    const calculation = calculateBalance(service.horasContratadas, monthlyHoursForService.map(h => h === '' ? 0 : h), service.mesesAcumulacao, dataExistsForService);\n                    \n                    // Formatar dados mensais para exibição (vazio se não há dados)\n                    const monthlyDisplay = monthlyHoursForService.map((h, idx) => {\n                        if (!dataExistsForService[idx]) return '';\n                        return h;\n                    });\n\n                    processedData.push({\n                        clienteId: service.clienteId,\n                        nomeCliente: service.nomeCliente,\n                        cnpj: service.cnpj || '',\n                        status: service.status,\n                        servicoId: service.servicoId,\n                        nomeServico: service.servico,\n                        horasContratadas: service.horasContratadas,\n                        mesesAcumulacao: service.mesesAcumulacao,\n                        totalHorasUtilizadas: calculation.totalHorasUtilizadas,\n                        saldoAtual: calculation.saldoAUtilizar,\n                        jan: monthlyDisplay[0],\n                        fev: monthlyDisplay[1],\n                        mar: monthlyDisplay[2],\n                        abr: monthlyDisplay[3],\n                        mai: monthlyDisplay[4],\n                        jun: monthlyDisplay[5],\n                        jul: monthlyDisplay[6],\n                        ago: monthlyDisplay[7],\n                        set: monthlyDisplay[8],\n                        out: monthlyDisplay[9],\n                        nov: monthlyDisplay[10],\n                        dez: monthlyDisplay[11]\n                    });\n                });\n\n                // Gerar CSV no formato solicitado\n                let csvContent = '';\n                \n                // Cabeçalho conforme o formato da imagem\n                csvContent += 'ID Cliente,Nome Cliente,CNPJ,Status,ID Serviço,Nome Serviço,,Horas Contratadas,Meses Acumulação,Total Horas Utilizadas (Período),Saldo Atual (Banco de Horas),Jan,Fev,Mar,Abr,Mai,Jun,Jul,Ago,Set,Out,Nov,Dez\\n';\n                \n                // Dados dos serviços\n                processedData.forEach(service => {\n                    csvContent += `${service.clienteId},${service.nomeCliente},\"${service.cnpj}\",${service.status},${service.servicoId},${service.nomeServico},,${service.horasContratadas},${service.mesesAcumulacao},${service.totalHorasUtilizadas},${service.saldoAtual.toFixed(1)},${service.jan},${service.fev},${service.mar},${service.abr},${service.mai},${service.jun},${service.jul},${service.ago},${service.set},${service.out},${service.nov},${service.dez}\\n`;\n                });\n\n                // Download do arquivo\n                const now = new Date();\n                const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');\n                const filename = `Gestao_Clientes_${timestamp}.csv`;\n                \n                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n                const link = document.createElement('a');\n                link.href = URL.createObjectURL(blob);\n                link.download = filename;\n                document.body.appendChild(link);\n                link.click();\n                document.body.removeChild(link);\n                URL.revokeObjectURL(link.href);\n\n                const filterInfo = [];\n                if (clienteId) filterInfo.push(`Cliente: ${originalN8nData.clientesServicosDetalhado.find(c => c.clienteId == clienteId)?.nomeCliente}`);\n                if (servicoNome) filterInfo.push(`Serviço: ${servicoNome}`);\n                if (dataInicial || dataFinal) filterInfo.push(`Período: ${dataInicial || 'início'} até ${dataFinal || 'fim'}`);\n                \n                const filterText = filterInfo.length > 0 ? ` (${filterInfo.join(', ')})` : ' (todos os dados)';\n                showMessage('success', `Dados exportados com sucesso${filterText}! Total de ${filteredServices.length} serviços exportados.`);\n            };\n            \n            // --- NOVAS FUNÇÕES E VARIÁVEIS PARA EXCLUSÃO E EDIÇÃO AGRUPADA ---\n            let servicesToDelete = [];\n\n            window.openClientModalForEditByClient = (clientId) => {\n                // Encontra o primeiro serviço associado ao cliente para preencher o modal de edição.\n                // A lógica do modal de edição existente edita um serviço de cada vez.\n                const firstServiceOfClient = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId);\n                if (firstServiceOfClient) {\n                    const originalIndex = originalN8nData.clientesServicosDetalhado.indexOf(firstServiceOfClient);\n                    openClientModal(originalIndex);\n                }\n            };\n\n            window.openConfirmDeleteModalByClient = (clientId) => {\n                const selectedCheckboxes = document.querySelectorAll(`.service-delete-checkbox[data-client-id=\"${clientId}\"]:checked`);\n                \n                if (selectedCheckboxes.length === 0) {\n                    showMessage('warning', 'Nenhum serviço selecionado para exclusão. Marque a caixa de seleção ao lado do serviço que deseja remover.');\n                    return;\n                }\n\n                servicesToDelete = [];\n                let deleteDetailsHtml = '';\n                const client = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId);\n\n                selectedCheckboxes.forEach(checkbox => {\n                    const servicoId = parseInt(checkbox.value);\n                    const service = originalN8nData.clientesServicosDetalhado.find(s => s.clienteId === clientId && s.servicoId === servicoId);\n                    \n                    if(service) {\n                        servicesToDelete.push({\n                            clienteId: clientId,\n                            servicoId: servicoId,\n                            nomeCliente: client.nomeCliente,\n                            servico: service.servico\n                        });\n\n                        deleteDetailsHtml += `<li class=\"list-group-item\"><strong>Cliente:</strong> ${client.nomeCliente}<br><strong>Serviço:</strong> ${service.servico}</li>`;\n                    }\n                });\n\n                const modalElement = document.getElementById('confirmDeleteModal');\n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                document.getElementById('deleteModalBody').innerHTML = `\n                    <p>Você tem certeza que deseja excluir os seguintes serviços?</p>\n                    <ul class=\"list-group mb-3\">${deleteDetailsHtml}</ul>\n                    <p class=\"text-danger\">Esta ação é irreversível.</p>\n                `;\n                document.getElementById('confirmDeleteBtn').onclick = confirmDeleteClient;\n                modal.show();\n            };\n\n            async function confirmDeleteClient() {\n                if (servicesToDelete.length === 0) {\n                    showMessage('danger', 'Erro: Nenhum serviço selecionado para exclusão.');\n                    return;\n                }\n\n                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));\n                modal.hide();\n\n                const payload = {\n                    action: \"deletar_servicos\", // Ação para deletar múltiplos serviços\n                    servicos: servicesToDelete\n                };\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados de exclusão para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        showMessage('success', `Serviços selecionados foram excluídos com sucesso!`);\n                        console.log(\"Dados de exclusão enviados ao webhook com sucesso:\", payload);\n                        setTimeout(() => window.location.reload(), 1500);\n                    } else {\n                        const errorText = await response.text();\n                        showMessage('danger', `Erro ao excluir serviços: ${response.status} - ${errorText}`);\n                        console.error(\"Erro ao enviar dados de exclusão ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    showMessage('danger', `Erro de rede ao excluir serviços: ${error.message}`);\n                    console.error(\"Erro de rede ao enviar dados de exclusão ao webhook:\", error);\n                } finally {\n                    servicesToDelete = [];\n                }\n            }\n\n            window.openAddServiceToClientModal = (clientId) => {\n                const modalElement = document.getElementById('addServiceToClientModal');\n                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);\n                const client = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId);\n\n                if (!client) {\n                    showMessage('danger', 'Erro: Cliente não encontrado para adicionar serviço.');\n                    return;\n                }\n\n                document.getElementById('addServiceToClientId').value = clientId;\n                document.getElementById('addServiceToClientName').textContent = client.nomeCliente;\n                document.getElementById('addServiceToClientNameDisplay').value = client.nomeCliente;\n                document.getElementById('addServiceToClientCnpjDisplay').value = client.cnpj || 'N/A';\n                document.getElementById('addServiceToClientHours').value = 0;\n                document.getElementById('addServiceToClientAccumulation').value = 0;\n                document.getElementById('serviceExistsWarning').classList.add('d-none');\n\n                populateServiceDropdowns('addServiceToClientServiceSelect');\n\n                modal.show();\n            };\n\n            window.checkExistingService = (selectElement) => {\n                const selectedServiceId = selectElement.value;\n                const clientId = parseInt(document.getElementById('addServiceToClientId').value);\n                const serviceExistsWarning = document.getElementById('serviceExistsWarning');\n                const saveButton = document.getElementById('saveNewClientServiceBtn');\n\n                if (!selectedServiceId) {\n                    serviceExistsWarning.classList.add('d-none');\n                    saveButton.disabled = true;\n                    return;\n                }\n\n                const serviceAlreadyAssigned = originalN8nData.clientesServicosDetalhado.some(cs => \n                    cs.clienteId === clientId && \n                    cs.servicoId == selectedServiceId\n                );\n\n                if (serviceAlreadyAssigned) {\n                    serviceExistsWarning.classList.remove('d-none');\n                    saveButton.disabled = true;\n                } else {\n                    serviceExistsWarning.classList.add('d-none');\n                    saveButton.disabled = false;\n                }\n            };\n\n            window.saveNewClientService = async () => {\n                const clientId = parseInt(document.getElementById('addServiceToClientId').value);\n                const selectedServiceId = document.getElementById('addServiceToClientServiceSelect').value;\n                const horasContratadas = parseInt(document.getElementById('addServiceToClientHours').value) || 0;\n                const mesesAcumulacao = parseInt(document.getElementById('addServiceToClientAccumulation').value) || 0;\n\n                if (!selectedServiceId) {\n                    showMessage('danger', 'Por favor, selecione um serviço.');\n                    return;\n                }\n\n                const client = originalN8nData.clientesServicosDetalhado.find(c => c.clienteId === clientId);\n                const selectedService = rawCadastroServico.find(s => s.id == selectedServiceId);\n\n                if (!client || !selectedService) {\n                    showMessage('danger', 'Erro: Dados do cliente ou serviço inválidos.');\n                    return;\n                }\n\n                const serviceAlreadyAssigned = originalN8nData.clientesServicosDetalhado.some(cs => \n                    cs.clienteId === clientId && \n                    cs.servicoId == selectedServiceId\n                );\n\n                if (serviceAlreadyAssigned) {\n                    showMessage('warning', `O serviço \"${selectedService.nome_serviço}\" já está cadastrado para este cliente. Por favor, edite-o na tabela principal.`);\n                    return;\n                }\n                \n                const payload = {\n                    action: \"add_servico_cliente\",\n                    clienteId: client.clienteId,\n                    servico_contratado: {\n                        id: selectedService.id,\n                        cliente_id: client.clienteId,\n                        nome_servico: selectedService.nome_serviço,\n                        horas_contratadas_mes: horasContratadas,\n                        meses_acumulacao: mesesAcumulacao,\n                        valor_hora: selectedService.valor_hora || 0,\n                        created_at: new Date().toISOString()\n                    }\n                };\n                \n                bootstrap.Modal.getInstance(document.getElementById('addServiceToClientModal')).hide();\n                showMessage('success', `Novo serviço \"${selectedService.nome_serviço}\" adicionado ao cliente \"${client.nomeCliente}\" com sucesso!`);\n\n                const webhookUrl = 'https://n8n.dev.resolvrisk.com.br/webhook/recebedados';\n                console.log(\"Enviando dados do novo serviço para cliente para o webhook:\", webhookUrl, payload);\n\n                try {\n                    const response = await fetch(webhookUrl, {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(payload)\n                    });\n\n                    if (response.ok) {\n                        console.log(\"Dados do novo serviço para cliente enviados ao webhook com sucesso:\", payload);\n                        setTimeout(() => window.location.reload(), 1500);\n                    } else {\n                        const errorText = await response.text();\n                        console.error(\"Erro ao enviar dados do novo serviço para cliente ao webhook:\", response.status, errorText);\n                    }\n                } catch (error) {\n                    console.error(\"Erro de rede ao enviar dados do novo serviço para cliente ao webhook:\", error);\n                }\n            };\n            \n            // Inicializa os dados da aplicação de gestão de clientes\n            initializeData();\n        });\n    </script>\n</body>\n</html>"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -192,
        4464
      ],
      "id": "7eaf0c75-87e5-4762-8267-ce3d127792d1",
      "name": "HTML Gestão de clientes2"
    }
  ],
  "connections": {
    "Processar Dados": {
      "main": [
        [
          {
            "node": "Html Parceiros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "dados_horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate1": {
      "main": [
        [
          {
            "node": "Dados Empresa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate2": {
      "main": [
        [
          {
            "node": "Dados Colaboradores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Html Index": {
      "main": [
        [
          {
            "node": "Consulta colaboladores",
            "type": "main",
            "index": 0
          },
          {
            "node": "Consulta Empresas1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Consula Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Dados2": {
      "main": [
        [
          {
            "node": "Split Envios  Gestão Clientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Dados2": {
      "main": [
        [
          {
            "node": "HTML Gestão de clientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gestao_clientes": {
      "main": [
        [
          {
            "node": "Consultas Mês_a_Mês",
            "type": "main",
            "index": 0
          },
          {
            "node": "Consulta Horas_Lançadas",
            "type": "main",
            "index": 0
          },
          {
            "node": "Consulta Sev_Contratados",
            "type": "main",
            "index": 0
          },
          {
            "node": "gest_Consulta_Cliente",
            "type": "main",
            "index": 0
          },
          {
            "node": "Consulta_Serviços",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gest_Consulta_Cliente": {
      "main": [
        [
          {
            "node": "Agrupa Dados Consulta_Clientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Sev_Contratados": {
      "main": [
        [
          {
            "node": "Agrupa dados Serv_Contratados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Horas_Lançadas": {
      "main": [
        [
          {
            "node": "Agrupa dados Horas Lançadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultas Mês_a_Mês": {
      "main": [
        [
          {
            "node": "Agrupa dados Mês_a_Mês",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta_Serviços": {
      "main": [
        [
          {
            "node": "Agrupa dados Serviços",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupa Dados Consulta_Clientes": {
      "main": [
        [
          {
            "node": "Trata dodos Consulta_Clientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupa dados Serv_Contratados": {
      "main": [
        [
          {
            "node": "Trata dados Serv_Contratados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupa dados Horas Lançadas": {
      "main": [
        [
          {
            "node": "Tarta dados Horas Lançadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupa dados Mês_a_Mês": {
      "main": [
        [
          {
            "node": "Trata dados Mẽs_a_Mes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupa dados Serviços": {
      "main": [
        [
          {
            "node": "Trata dados Serviços",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dodos Consulta_Clientes": {
      "main": [
        [
          {
            "node": "Merge Dados2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dados Serv_Contratados": {
      "main": [
        [
          {
            "node": "Merge Dados2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Tarta dados Horas Lançadas": {
      "main": [
        [
          {
            "node": "Merge Dados2",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Trata dados Mẽs_a_Mes": {
      "main": [
        [
          {
            "node": "Merge Dados2",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Trata dados Serviços": {
      "main": [
        [
          {
            "node": "Merge Dados2",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Split Envios  Gestão Clientes": {
      "main": [
        [
          {
            "node": "Processar Dados2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dados_horas": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados Empresa": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Dados Colaboradores": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge Dados": {
      "main": [
        [
          {
            "node": "Aggregate6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate6": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Processar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Login HTML": {
      "main": [
        [
          {
            "node": "Respond to Login1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dashboard HTML": {
      "main": [
        [
          {
            "node": "Respond to Dashboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check-in": {
      "main": [
        [
          {
            "node": "Consulta Dominio Check-in",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dashboard": {
      "main": [
        [
          {
            "node": "Consulta Dominio Dashboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Timeline": {
      "main": [
        [
          {
            "node": "Consulta Dominio Timeline",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gestão de Equipe HTML": {
      "main": [
        [
          {
            "node": "Respond to Gestão de Equipe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gestão de Equipe": {
      "main": [
        [
          {
            "node": "Consulta Dominio Gestão de Equipe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cadastro de Colaboradores HTML": {
      "main": [
        [
          {
            "node": "Respond to Colaborador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cadastro de Colaborador": {
      "main": [
        [
          {
            "node": "Consulta Dominio Cadastro de Colaborador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Módulo em Construção HTML": {
      "main": [
        [
          {
            "node": "Respond to Módulo em Construção",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Site Menu Configuração": {
      "main": [
        [
          {
            "node": "Consulta Dominio Conf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Dominio Conf": {
      "main": [
        [
          {
            "node": "Trata dados Dominio Conf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dados Dominio Conf": {
      "main": [
        [
          {
            "node": "Módulo em Construção HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Dominio Cadastro de Colaborador": {
      "main": [
        [
          {
            "node": "Trata dados Dominio Cadastro de Colaborador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dados Dominio Cadastro de Colaborador": {
      "main": [
        [
          {
            "node": "Cadastro de Colaboradores HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Dominio Gestão de Equipe": {
      "main": [
        [
          {
            "node": "Trata dados Dominio Gestão de Equipe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dados Dominio Gestão de Equipe": {
      "main": [
        [
          {
            "node": "Gestão de Equipe HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Dominio Timeline": {
      "main": [
        [
          {
            "node": "Trata dados Dominio  Timeline",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dados Dominio  Timeline": {
      "main": [
        [
          {
            "node": "Timeline HTML2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Dominio Check-in": {
      "main": [
        [
          {
            "node": "Trata dados Dominio  Tarefas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Dominio Dashboard": {
      "main": [
        [
          {
            "node": "Trata dados Dominio  Dashboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dados Dominio  Dashboard": {
      "main": [
        [
          {
            "node": "Dashboard HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check-in HTML1": {
      "main": [
        [
          {
            "node": "Respond to Check-in",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tela de Login2": {
      "main": [
        [
          {
            "node": "Consulta Dominio Login2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Dominio Login2": {
      "main": [
        [
          {
            "node": "Trata dados Dominio  Login1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dados Dominio  Login1": {
      "main": [
        [
          {
            "node": "Login HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trata dados Dominio  Tarefas": {
      "main": [
        [
          {
            "node": "Check-in HTML1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Timeline HTML2": {
      "main": [
        [
          {
            "node": "Respond to Timeline",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consula Task": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Empresas1": {
      "main": [
        [
          {
            "node": "Aggregate1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta colaboladores": {
      "main": [
        [
          {
            "node": "Aggregate2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML Gestão de clientes": {
      "main": [
        [
          {
            "node": "Resposta2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Html Parceiros": {
      "main": [
        [
          {
            "node": "Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Html Index": [
      {
        "headers": {
          "host": "n8n.dev.resolvrisk.com.br",
          "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
          "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
          "accept-encoding": "gzip, deflate, br, zstd",
          "accept-language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
          "cookie": "rl_page_init_referrer=RudderEncrypt%3AU2FsdGVkX1%2FBWrNemSqSxEQZNLIkI7pBKgPIzNQp8hg%3D; rl_page_init_referring_domain=RudderEncrypt%3AU2FsdGVkX1%2BU0elIcA2CIfKceOtQIf5t3IHSfuHY4ps%3D; rl_anonymous_id=RudderEncrypt%3AU2FsdGVkX1%2BvvXTUxKI0wlfDC4zH8K%2BL7Ef27Ub7Xjq%2Bixrq98a3POdI49bw6TqzYqnWlANKmPOGGDS7mX2BtQ%3D%3D; n8n-auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYwMjRjZjBlLWRkMDQtNDc1Mi04MjlhLTlkZDc3OGQ4YzY1NyIsImhhc2giOiJWZDhNbWNNUXdjIiwiYnJvd3NlcklkIjoibmppRkk4eTVwT0NJUlFDSlBCWjg4dDhsdVc4NnRzQ29vUzBuakxCVUdhdz0iLCJpYXQiOjE3NTQxODIyNDQsImV4cCI6MTc1NDc4NzA0NH0.VsAD8h1axrzXbKS3Kk7TrUdwQ7bJ1XeCtJ1mpDKnma0; rl_user_id=RudderEncrypt%3AU2FsdGVkX1%2FLRvOIZIYrtY%2FnkgahIz%2BnCFLEvT2aqkpeRc%2F4vhM0cd4M5IaKvwn3uj5LWgHLlSHv%2F5S4BRIWKyZZkcOf31bJR%2BTH8VGPNqVKcxJG9wKSn%2Fy%2F4wA9FlTwK1uLyEB0txmvezbp%2FxWLvrAa5xvS%2FUacwMnogA6U6Zg%3D; rl_trait=RudderEncrypt%3AU2FsdGVkX19V%2FGKTU83ynty4CaeKv3xoaxERIvbjcisWLh%2FnSk%2BEfnlcGmM4irsbAmmD79LErMwV%2F%2BPFz%2FuKN%2BBrP5VNs%2Bt9hvj4Ei59%2BT%2FLOf8meh6ucHSH9nMXrxNvbzYvGJnjHCnRJVohQlzKHQ%3D%3D; ph_phc_4URIAm1uYfJO7j8kWSe0J8lc8IqnstRLS7Jx8NcakHo_posthog=%7B%22distinct_id%22%3A%226699cbf9843237f32f9c88af0bea42b243fa852f1728232147775cbb03c3602b%236024cf0e-dd04-4752-829a-9dd778d8c657%22%2C%22%24sesid%22%3A%5B1754182244851%2C%2201986d68-9167-7c17-b1b0-102191da6517%22%2C1754182226276%5D%2C%22%24epp%22%3Atrue%2C%22%24initial_person_info%22%3A%7B%22r%22%3A%22%24direct%22%2C%22u%22%3A%22https%3A%2F%2Fn8n.dev.resolvrisk.com.br%2Fsignin%3Fredirect%3D%25252F%22%7D%7D; rl_session=RudderEncrypt%3AU2FsdGVkX1%2FJ851YtYYuQC1XcpG8k1A9DPSwlmynBt4jLxRDxRInPdkFPqlGcbWeRyHDiAp0w6sHwB1p5EH5J0tzYuo97Hg3iMhdP0yHRZeFYmun7CiGOFiLCcIW2VMqdDe0i9wUm0enbamx4pN5qA%3D%3D",
          "if-none-match": "W/\"a3d5-rNtvvKmAS7m97NlZmKjDu4hCwsw\"",
          "priority": "u=0, i",
          "referer": "https://n8n.dev.resolvrisk.com.br/webhook/dev/resolv",
          "sec-ch-ua": "\"Not)A;Brand\";v=\"8\", \"Chromium\";v=\"138\", \"Google Chrome\";v=\"138\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"Linux\"",
          "sec-fetch-dest": "document",
          "sec-fetch-mode": "navigate",
          "sec-fetch-site": "same-origin",
          "sec-fetch-user": "?1",
          "upgrade-insecure-requests": "1",
          "x-forwarded-for": "191.255.109.31",
          "x-forwarded-host": "n8n.dev.resolvrisk.com.br",
          "x-forwarded-port": "443",
          "x-forwarded-proto": "https",
          "x-forwarded-server": "bc36352771ac",
          "x-real-ip": "191.255.109.31"
        },
        "params": {},
        "query": {},
        "body": {},
        "webhookUrl": "https://n8n.dev.resolvrisk.com.br/webhook/dev/conf",
        "executionMode": "production"
      }
    ],
    "Gestao_clientes": [
      {
        "headers": {
          "host": "n8n.dev.resolvrisk.com.br",
          "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
          "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
          "accept-encoding": "gzip, deflate, br, zstd",
          "accept-language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
          "cookie": "rl_page_init_referrer=RudderEncrypt%3AU2FsdGVkX1%2FBWrNemSqSxEQZNLIkI7pBKgPIzNQp8hg%3D; rl_page_init_referring_domain=RudderEncrypt%3AU2FsdGVkX1%2BU0elIcA2CIfKceOtQIf5t3IHSfuHY4ps%3D; rl_anonymous_id=RudderEncrypt%3AU2FsdGVkX1%2BvvXTUxKI0wlfDC4zH8K%2BL7Ef27Ub7Xjq%2Bixrq98a3POdI49bw6TqzYqnWlANKmPOGGDS7mX2BtQ%3D%3D; n8n-auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYwMjRjZjBlLWRkMDQtNDc1Mi04MjlhLTlkZDc3OGQ4YzY1NyIsImhhc2giOiJWZDhNbWNNUXdjIiwiYnJvd3NlcklkIjoibmppRkk4eTVwT0NJUlFDSlBCWjg4dDhsdVc4NnRzQ29vUzBuakxCVUdhdz0iLCJpYXQiOjE3NTQxODIyNDQsImV4cCI6MTc1NDc4NzA0NH0.VsAD8h1axrzXbKS3Kk7TrUdwQ7bJ1XeCtJ1mpDKnma0; rl_user_id=RudderEncrypt%3AU2FsdGVkX1%2FLRvOIZIYrtY%2FnkgahIz%2BnCFLEvT2aqkpeRc%2F4vhM0cd4M5IaKvwn3uj5LWgHLlSHv%2F5S4BRIWKyZZkcOf31bJR%2BTH8VGPNqVKcxJG9wKSn%2Fy%2F4wA9FlTwK1uLyEB0txmvezbp%2FxWLvrAa5xvS%2FUacwMnogA6U6Zg%3D; rl_trait=RudderEncrypt%3AU2FsdGVkX19V%2FGKTU83ynty4CaeKv3xoaxERIvbjcisWLh%2FnSk%2BEfnlcGmM4irsbAmmD79LErMwV%2F%2BPFz%2FuKN%2BBrP5VNs%2Bt9hvj4Ei59%2BT%2FLOf8meh6ucHSH9nMXrxNvbzYvGJnjHCnRJVohQlzKHQ%3D%3D; ph_phc_4URIAm1uYfJO7j8kWSe0J8lc8IqnstRLS7Jx8NcakHo_posthog=%7B%22distinct_id%22%3A%226699cbf9843237f32f9c88af0bea42b243fa852f1728232147775cbb03c3602b%236024cf0e-dd04-4752-829a-9dd778d8c657%22%2C%22%24sesid%22%3A%5B1754182244851%2C%2201986d68-9167-7c17-b1b0-102191da6517%22%2C1754182226276%5D%2C%22%24epp%22%3Atrue%2C%22%24initial_person_info%22%3A%7B%22r%22%3A%22%24direct%22%2C%22u%22%3A%22https%3A%2F%2Fn8n.dev.resolvrisk.com.br%2Fsignin%3Fredirect%3D%25252F%22%7D%7D; rl_session=RudderEncrypt%3AU2FsdGVkX1%2FJ851YtYYuQC1XcpG8k1A9DPSwlmynBt4jLxRDxRInPdkFPqlGcbWeRyHDiAp0w6sHwB1p5EH5J0tzYuo97Hg3iMhdP0yHRZeFYmun7CiGOFiLCcIW2VMqdDe0i9wUm0enbamx4pN5qA%3D%3D",
          "if-none-match": "W/\"a3d5-rNtvvKmAS7m97NlZmKjDu4hCwsw\"",
          "priority": "u=0, i",
          "referer": "https://n8n.dev.resolvrisk.com.br/webhook/dev/resolv",
          "sec-ch-ua": "\"Not)A;Brand\";v=\"8\", \"Chromium\";v=\"138\", \"Google Chrome\";v=\"138\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"Linux\"",
          "sec-fetch-dest": "document",
          "sec-fetch-mode": "navigate",
          "sec-fetch-site": "same-origin",
          "sec-fetch-user": "?1",
          "upgrade-insecure-requests": "1",
          "x-forwarded-for": "191.255.109.31",
          "x-forwarded-host": "n8n.dev.resolvrisk.com.br",
          "x-forwarded-port": "443",
          "x-forwarded-proto": "https",
          "x-forwarded-server": "bc36352771ac",
          "x-real-ip": "191.255.109.31"
        },
        "params": {},
        "query": {},
        "body": {},
        "webhookUrl": "https://n8n.dev.resolvrisk.com.br/webhook/dev/conf",
        "executionMode": "production"
      }
    ],
    "Check-in": [
      {
        "headers": {
          "host": "n8n.dev.resolvrisk.com.br",
          "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
          "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
          "accept-encoding": "gzip, deflate, br, zstd",
          "accept-language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
          "cookie": "rl_page_init_referrer=RudderEncrypt%3AU2FsdGVkX1%2FBWrNemSqSxEQZNLIkI7pBKgPIzNQp8hg%3D; rl_page_init_referring_domain=RudderEncrypt%3AU2FsdGVkX1%2BU0elIcA2CIfKceOtQIf5t3IHSfuHY4ps%3D; rl_anonymous_id=RudderEncrypt%3AU2FsdGVkX1%2BvvXTUxKI0wlfDC4zH8K%2BL7Ef27Ub7Xjq%2Bixrq98a3POdI49bw6TqzYqnWlANKmPOGGDS7mX2BtQ%3D%3D; n8n-auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYwMjRjZjBlLWRkMDQtNDc1Mi04MjlhLTlkZDc3OGQ4YzY1NyIsImhhc2giOiJWZDhNbWNNUXdjIiwiYnJvd3NlcklkIjoibmppRkk4eTVwT0NJUlFDSlBCWjg4dDhsdVc4NnRzQ29vUzBuakxCVUdhdz0iLCJpYXQiOjE3NTQxODIyNDQsImV4cCI6MTc1NDc4NzA0NH0.VsAD8h1axrzXbKS3Kk7TrUdwQ7bJ1XeCtJ1mpDKnma0; rl_user_id=RudderEncrypt%3AU2FsdGVkX1%2FLRvOIZIYrtY%2FnkgahIz%2BnCFLEvT2aqkpeRc%2F4vhM0cd4M5IaKvwn3uj5LWgHLlSHv%2F5S4BRIWKyZZkcOf31bJR%2BTH8VGPNqVKcxJG9wKSn%2Fy%2F4wA9FlTwK1uLyEB0txmvezbp%2FxWLvrAa5xvS%2FUacwMnogA6U6Zg%3D; rl_trait=RudderEncrypt%3AU2FsdGVkX19V%2FGKTU83ynty4CaeKv3xoaxERIvbjcisWLh%2FnSk%2BEfnlcGmM4irsbAmmD79LErMwV%2F%2BPFz%2FuKN%2BBrP5VNs%2Bt9hvj4Ei59%2BT%2FLOf8meh6ucHSH9nMXrxNvbzYvGJnjHCnRJVohQlzKHQ%3D%3D; ph_phc_4URIAm1uYfJO7j8kWSe0J8lc8IqnstRLS7Jx8NcakHo_posthog=%7B%22distinct_id%22%3A%226699cbf9843237f32f9c88af0bea42b243fa852f1728232147775cbb03c3602b%236024cf0e-dd04-4752-829a-9dd778d8c657%22%2C%22%24sesid%22%3A%5B1754182244851%2C%2201986d68-9167-7c17-b1b0-102191da6517%22%2C1754182226276%5D%2C%22%24epp%22%3Atrue%2C%22%24initial_person_info%22%3A%7B%22r%22%3A%22%24direct%22%2C%22u%22%3A%22https%3A%2F%2Fn8n.dev.resolvrisk.com.br%2Fsignin%3Fredirect%3D%25252F%22%7D%7D; rl_session=RudderEncrypt%3AU2FsdGVkX1%2FJ851YtYYuQC1XcpG8k1A9DPSwlmynBt4jLxRDxRInPdkFPqlGcbWeRyHDiAp0w6sHwB1p5EH5J0tzYuo97Hg3iMhdP0yHRZeFYmun7CiGOFiLCcIW2VMqdDe0i9wUm0enbamx4pN5qA%3D%3D",
          "if-none-match": "W/\"a3d5-rNtvvKmAS7m97NlZmKjDu4hCwsw\"",
          "priority": "u=0, i",
          "referer": "https://n8n.dev.resolvrisk.com.br/webhook/dev/resolv",
          "sec-ch-ua": "\"Not)A;Brand\";v=\"8\", \"Chromium\";v=\"138\", \"Google Chrome\";v=\"138\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"Linux\"",
          "sec-fetch-dest": "document",
          "sec-fetch-mode": "navigate",
          "sec-fetch-site": "same-origin",
          "sec-fetch-user": "?1",
          "upgrade-insecure-requests": "1",
          "x-forwarded-for": "191.255.109.31",
          "x-forwarded-host": "n8n.dev.resolvrisk.com.br",
          "x-forwarded-port": "443",
          "x-forwarded-proto": "https",
          "x-forwarded-server": "bc36352771ac",
          "x-real-ip": "191.255.109.31"
        },
        "params": {},
        "query": {},
        "body": {},
        "webhookUrl": "https://n8n.dev.resolvrisk.com.br/webhook/dev/conf",
        "executionMode": "production"
      }
    ],
    "Dashboard": [
      {
        "headers": {
          "host": "n8n.dev.resolvrisk.com.br",
          "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
          "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
          "accept-encoding": "gzip, deflate, br, zstd",
          "accept-language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
          "cookie": "rl_page_init_referrer=RudderEncrypt%3AU2FsdGVkX1%2FBWrNemSqSxEQZNLIkI7pBKgPIzNQp8hg%3D; rl_page_init_referring_domain=RudderEncrypt%3AU2FsdGVkX1%2BU0elIcA2CIfKceOtQIf5t3IHSfuHY4ps%3D; rl_anonymous_id=RudderEncrypt%3AU2FsdGVkX1%2BvvXTUxKI0wlfDC4zH8K%2BL7Ef27Ub7Xjq%2Bixrq98a3POdI49bw6TqzYqnWlANKmPOGGDS7mX2BtQ%3D%3D; n8n-auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYwMjRjZjBlLWRkMDQtNDc1Mi04MjlhLTlkZDc3OGQ4YzY1NyIsImhhc2giOiJWZDhNbWNNUXdjIiwiYnJvd3NlcklkIjoibmppRkk4eTVwT0NJUlFDSlBCWjg4dDhsdVc4NnRzQ29vUzBuakxCVUdhdz0iLCJpYXQiOjE3NTQxODIyNDQsImV4cCI6MTc1NDc4NzA0NH0.VsAD8h1axrzXbKS3Kk7TrUdwQ7bJ1XeCtJ1mpDKnma0; rl_user_id=RudderEncrypt%3AU2FsdGVkX1%2FLRvOIZIYrtY%2FnkgahIz%2BnCFLEvT2aqkpeRc%2F4vhM0cd4M5IaKvwn3uj5LWgHLlSHv%2F5S4BRIWKyZZkcOf31bJR%2BTH8VGPNqVKcxJG9wKSn%2Fy%2F4wA9FlTwK1uLyEB0txmvezbp%2FxWLvrAa5xvS%2FUacwMnogA6U6Zg%3D; rl_trait=RudderEncrypt%3AU2FsdGVkX19V%2FGKTU83ynty4CaeKv3xoaxERIvbjcisWLh%2FnSk%2BEfnlcGmM4irsbAmmD79LErMwV%2F%2BPFz%2FuKN%2BBrP5VNs%2Bt9hvj4Ei59%2BT%2FLOf8meh6ucHSH9nMXrxNvbzYvGJnjHCnRJVohQlzKHQ%3D%3D; ph_phc_4URIAm1uYfJO7j8kWSe0J8lc8IqnstRLS7Jx8NcakHo_posthog=%7B%22distinct_id%22%3A%226699cbf9843237f32f9c88af0bea42b243fa852f1728232147775cbb03c3602b%236024cf0e-dd04-4752-829a-9dd778d8c657%22%2C%22%24sesid%22%3A%5B1754182244851%2C%2201986d68-9167-7c17-b1b0-102191da6517%22%2C1754182226276%5D%2C%22%24epp%22%3Atrue%2C%22%24initial_person_info%22%3A%7B%22r%22%3A%22%24direct%22%2C%22u%22%3A%22https%3A%2F%2Fn8n.dev.resolvrisk.com.br%2Fsignin%3Fredirect%3D%25252F%22%7D%7D; rl_session=RudderEncrypt%3AU2FsdGVkX1%2FJ851YtYYuQC1XcpG8k1A9DPSwlmynBt4jLxRDxRInPdkFPqlGcbWeRyHDiAp0w6sHwB1p5EH5J0tzYuo97Hg3iMhdP0yHRZeFYmun7CiGOFiLCcIW2VMqdDe0i9wUm0enbamx4pN5qA%3D%3D",
          "if-none-match": "W/\"a3d5-rNtvvKmAS7m97NlZmKjDu4hCwsw\"",
          "priority": "u=0, i",
          "referer": "https://n8n.dev.resolvrisk.com.br/webhook/dev/resolv",
          "sec-ch-ua": "\"Not)A;Brand\";v=\"8\", \"Chromium\";v=\"138\", \"Google Chrome\";v=\"138\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"Linux\"",
          "sec-fetch-dest": "document",
          "sec-fetch-mode": "navigate",
          "sec-fetch-site": "same-origin",
          "sec-fetch-user": "?1",
          "upgrade-insecure-requests": "1",
          "x-forwarded-for": "191.255.109.31",
          "x-forwarded-host": "n8n.dev.resolvrisk.com.br",
          "x-forwarded-port": "443",
          "x-forwarded-proto": "https",
          "x-forwarded-server": "bc36352771ac",
          "x-real-ip": "191.255.109.31"
        },
        "params": {},
        "query": {},
        "body": {},
        "webhookUrl": "https://n8n.dev.resolvrisk.com.br/webhook/dev/conf",
        "executionMode": "production"
      }
    ],
    "Tela de Login2": [
      {
        "headers": {
          "host": "n8n.dev.resolvrisk.com.br",
          "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
          "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
          "accept-encoding": "gzip, deflate, br, zstd",
          "accept-language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
          "cookie": "rl_page_init_referrer=RudderEncrypt%3AU2FsdGVkX1%2FBWrNemSqSxEQZNLIkI7pBKgPIzNQp8hg%3D; rl_page_init_referring_domain=RudderEncrypt%3AU2FsdGVkX1%2BU0elIcA2CIfKceOtQIf5t3IHSfuHY4ps%3D; rl_anonymous_id=RudderEncrypt%3AU2FsdGVkX1%2BvvXTUxKI0wlfDC4zH8K%2BL7Ef27Ub7Xjq%2Bixrq98a3POdI49bw6TqzYqnWlANKmPOGGDS7mX2BtQ%3D%3D; n8n-auth=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYwMjRjZjBlLWRkMDQtNDc1Mi04MjlhLTlkZDc3OGQ4YzY1NyIsImhhc2giOiJWZDhNbWNNUXdjIiwiYnJvd3NlcklkIjoibmppRkk4eTVwT0NJUlFDSlBCWjg4dDhsdVc4NnRzQ29vUzBuakxCVUdhdz0iLCJpYXQiOjE3NTQxODIyNDQsImV4cCI6MTc1NDc4NzA0NH0.VsAD8h1axrzXbKS3Kk7TrUdwQ7bJ1XeCtJ1mpDKnma0; rl_user_id=RudderEncrypt%3AU2FsdGVkX1%2FLRvOIZIYrtY%2FnkgahIz%2BnCFLEvT2aqkpeRc%2F4vhM0cd4M5IaKvwn3uj5LWgHLlSHv%2F5S4BRIWKyZZkcOf31bJR%2BTH8VGPNqVKcxJG9wKSn%2Fy%2F4wA9FlTwK1uLyEB0txmvezbp%2FxWLvrAa5xvS%2FUacwMnogA6U6Zg%3D; rl_trait=RudderEncrypt%3AU2FsdGVkX19V%2FGKTU83ynty4CaeKv3xoaxERIvbjcisWLh%2FnSk%2BEfnlcGmM4irsbAmmD79LErMwV%2F%2BPFz%2FuKN%2BBrP5VNs%2Bt9hvj4Ei59%2BT%2FLOf8meh6ucHSH9nMXrxNvbzYvGJnjHCnRJVohQlzKHQ%3D%3D; ph_phc_4URIAm1uYfJO7j8kWSe0J8lc8IqnstRLS7Jx8NcakHo_posthog=%7B%22distinct_id%22%3A%226699cbf9843237f32f9c88af0bea42b243fa852f1728232147775cbb03c3602b%236024cf0e-dd04-4752-829a-9dd778d8c657%22%2C%22%24sesid%22%3A%5B1754182244851%2C%2201986d68-9167-7c17-b1b0-102191da6517%22%2C1754182226276%5D%2C%22%24epp%22%3Atrue%2C%22%24initial_person_info%22%3A%7B%22r%22%3A%22%24direct%22%2C%22u%22%3A%22https%3A%2F%2Fn8n.dev.resolvrisk.com.br%2Fsignin%3Fredirect%3D%25252F%22%7D%7D; rl_session=RudderEncrypt%3AU2FsdGVkX1%2FJ851YtYYuQC1XcpG8k1A9DPSwlmynBt4jLxRDxRInPdkFPqlGcbWeRyHDiAp0w6sHwB1p5EH5J0tzYuo97Hg3iMhdP0yHRZeFYmun7CiGOFiLCcIW2VMqdDe0i9wUm0enbamx4pN5qA%3D%3D",
          "if-none-match": "W/\"a3d5-rNtvvKmAS7m97NlZmKjDu4hCwsw\"",
          "priority": "u=0, i",
          "referer": "https://n8n.dev.resolvrisk.com.br/webhook/dev/resolv",
          "sec-ch-ua": "\"Not)A;Brand\";v=\"8\", \"Chromium\";v=\"138\", \"Google Chrome\";v=\"138\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"Linux\"",
          "sec-fetch-dest": "document",
          "sec-fetch-mode": "navigate",
          "sec-fetch-site": "same-origin",
          "sec-fetch-user": "?1",
          "upgrade-insecure-requests": "1",
          "x-forwarded-for": "191.255.109.31",
          "x-forwarded-host": "n8n.dev.resolvrisk.com.br",
          "x-forwarded-port": "443",
          "x-forwarded-proto": "https",
          "x-forwarded-server": "bc36352771ac",
          "x-real-ip": "191.255.109.31"
        },
        "params": {},
        "query": {},
        "body": {},
        "webhookUrl": "https://n8n.dev.resolvrisk.com.br/webhook/dev/conf",
        "executionMode": "production"
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "21b80bbe30a7f15da69548d8c5b1a235d4d21f49c50c6d7cd7bab88b61c1e138"
  }
}
